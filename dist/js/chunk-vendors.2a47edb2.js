(self["webpackChunkmatrix_chat_spa"]=self["webpackChunkmatrix_chat_spa"]||[]).push([[504],{34:function(e,t,r){"use strict";var n=r(4901);e.exports=function(e){return"object"==typeof e?null!==e:n(e)}},81:function(e,t,r){"use strict";var n=r(9565),i=r(9306),o=r(8551),s=r(6823),a=r(851),c=TypeError;e.exports=function(e,t){var r=arguments.length<2?a(e):t;if(i(r))return o(n(r,e));throw new c(s(e)+" is not iterable")}},116:function(e,t,r){"use strict";var n=r(6518),i=r(2652),o=r(9306),s=r(8551),a=r(1767);n({target:"Iterator",proto:!0,real:!0},{find:function(e){s(this),o(e);var t=a(this),r=0;return i(t,(function(t,n){if(e(t,r++))return n(t)}),{IS_RECORD:!0,INTERRUPTED:!0}).result}})},144:function(e){"use strict";e.exports=JSON.parse('{"0":"O","1":"l","֭":"֖","֮":"֘","֨":"֙","֤":"֚","᪴":"ۛ","⃛":"ۛ","ؙ":"̓","ࣳ":"̓","̓":"̓","̕":"̓","ُ":"̓","ٝ":"̔","֜":"́","֝":"́","ؘ":"́","݇":"́","́":"́","॔":"́","َ":"́","̀":"̀","॓":"̀","̌":"̆","꙼":"̆","٘":"̆","ٚ":"̆","ͮ":"̆","ۨ":"̆̇","̐":"̆̇","ँ":"̆̇","ঁ":"̆̇","ઁ":"̆̇","ଁ":"̆̇","ఀ":"̆̇","ಁ":"̆̇","ഁ":"̆̇","𑒿":"̆̇","᳐":"̂","̑":"̂","ٛ":"̂","߮":"̂","꛰":"̂","֯":"̊","۟":"̊","៓":"̊","゚":"̊","ْ":"̊","ஂ":"̊","ံ":"̊","ំ":"̊","𑌀":"̊","ํ":"̊","ໍ":"̊","ͦ":"̊","ⷪ":"̊","࣫":"̈","߳":"̈","ً":"̋","ࣰ":"̋","͂":"̃","ٓ":"̃","ׄ":"̇","۬":"̇","݀":"̇","࣪":"̇","݁":"̇","͘":"̇","ֹ":"̇","ֺ":"̇","ׂ":"̇","ׁ":"̇","߭":"̇","ं":"̇","ਂ":"̇","ં":"̇","்":"̇","̷":"̸","᪷":"̨","̢":"̨","ͅ":"̨","᳒":"̄","̅":"̄","ٙ":"̄","߫":"̄","꛱":"̄","᳚":"̎","ٗ":"̒","͗":"͐","ࣿ":"͐","ࣸ":"͐","ऀ":"͒","᳭":"̖","᳜":"̩","ٖ":"̩","᳕":"̫","͇":"̳","ࣹ":"͔","ࣺ":"͕","゛":"ﾞ","゜":"ﾟ","̶":"̵","〬":"̉","ׅ":"̣","࣭":"̣","᳝":"̣","ִ":"̣","ٜ":"̣","़":"̣","়":"̣","਼":"̣","઼":"̣","଼":"̣","𑇊":"̣","𑓃":"̣","𐨺":"̣","࣮":"̤","᳞":"̤","༷":"̥","〭":"̥","̧":"̦","̡":"̦","̹":"̦","᳙":"̭","᳘":"̮","॒":"̱","̠":"̱","ࣱ":"ٌ","ࣨ":"ٌ","ࣥ":"ٌ","ﱞ":"ﹲّ","ࣲ":"ٍ","ﱟ":"ﹴّ","ﳲ":"ﹷّ","ﱠ":"ﹶّ","ﳳ":"ﹹّ","ﱡ":"ﹸّ","ؚ":"ِ","̗":"ِ","ﳴ":"ﹻّ","ﱢ":"ﹺّ","ﱣ":"ﹼٰ","ٟ":"ٕ","̍":"ٰ","݂":"ܼ","ਃ":"ঃ","ః":"ঃ","ಃ":"ঃ","ഃ":"ঃ","ඃ":"ঃ","း":"ঃ","𑓁":"ঃ","់":"่","່":"่","້":"้","໊":"๊","໋":"๋","꙯":"⃩","\\u2028":" ","\\u2029":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" "," ":" ","ߺ":"_","﹍":"_","﹎":"_","﹏":"_","‐":"-","‑":"-","‒":"-","–":"-","﹘":"-","۔":"-","⁃":"-","˗":"-","−":"-","➖":"-","Ⲻ":"-","⨩":"-̓","⸚":"-̈","﬩":"-̇","∸":"-̇","⨪":"-̣","꓾":"-.","～":"〜","؍":",","٫":",","‚":",","¸":",","ꓹ":",","⸲":"،","٬":"،",";":";","⸵":"؛","ः":":","ઃ":":","：":":","։":":","܃":":","܄":":","᛬":":","︰":":","᠃":":","᠉":":","⁚":":","׃":":","˸":":","꞉":":","∶":":","ː":":","ꓽ":":","⩴":"::=","⧴":":→","！":"!","ǃ":"!","ⵑ":"!","‼":"!!","⁉":"!?","ʔ":"?","Ɂ":"?","ॽ":"?","Ꭾ":"?","ꛫ":"?","⁈":"?!","⁇":"??","⸮":"؟","𝅭":".","․":".","܁":".","܂":".","꘎":".","𐩐":".","٠":".","۰":".","ꓸ":".","ꓻ":".,","‥":"..","ꓺ":"..","…":"...","꛴":"꛳꛳","・":"·","･":"·","᛫":"·","·":"·","⸱":"·","𐄁":"·","•":"·","‧":"·","∙":"·","⋅":"·","ꞏ":"·","ᐧ":"·","⋯":"···","ⵈ":"···","ᑄ":"·<","⋗":"·>","ᐷ":"·>","ᑀ":"·>","ᔯ":"·4","ᑾ":"·b","ᒀ":"·ḃ","ᑺ":"·d","ᒘ":"·J","ᒶ":"·L","ᑶ":"·P","ᑗ":"·U","ᐺ":"·V","ᐼ":"·Ʌ","ᒮ":"·Γ","ᐎ":"·Δ","ᑙ":"·Ո","ᐌ":"·ᐁ","ᐐ":"·ᐄ","ᐒ":"·ᐅ","ᐔ":"·ᐆ","ᐗ":"·ᐊ","ᐙ":"·ᐋ","ᐾ":"·ᐲ","ᑂ":"·ᐴ","ᑆ":"·ᐹ","ᑛ":"·ᑏ","ᑔ":"·ᑐ","ᑝ":"·ᑐ","ᑟ":"·ᑑ","ᑡ":"·ᑕ","ᑣ":"·ᑖ","ᑴ":"·ᑫ","ᑸ":"·ᑮ","ᑼ":"·ᑰ","ᒒ":"·ᒉ","ᒔ":"·ᒋ","ᒖ":"·ᒌ","ᒚ":"·ᒎ","ᒜ":"·ᒐ","ᒞ":"·ᒑ","ᒬ":"·ᒣ","ᒰ":"·ᒦ","ᒲ":"·ᒧ","ᒴ":"·ᒨ","ᒸ":"·ᒫ","ᓉ":"·ᓀ","ᣆ":"·ᓂ","ᣈ":"·ᓃ","ᣊ":"·ᓄ","ᣌ":"·ᓅ","ᓋ":"·ᓇ","ᓍ":"·ᓈ","ᓜ":"·ᓓ","ᓞ":"·ᓕ","ᓠ":"·ᓖ","ᓢ":"·ᓗ","ᓤ":"·ᓘ","ᓦ":"·ᓚ","ᓨ":"·ᓛ","ᓶ":"·ᓭ","ᓸ":"·ᓯ","ᓺ":"·ᓰ","ᓼ":"·ᓱ","ᓾ":"·ᓲ","ᔀ":"·ᓴ","ᔂ":"·ᓵ","ᔗ":"·ᔐ","ᔙ":"·ᔑ","ᔛ":"·ᔒ","ᔝ":"·ᔓ","ᔟ":"·ᔔ","ᔡ":"·ᔕ","ᔣ":"·ᔖ","ᔱ":"·ᔨ","ᔳ":"·ᔩ","ᔵ":"·ᔪ","ᔷ":"·ᔫ","ᔹ":"·ᔭ","ᔻ":"·ᔮ","ᣎ":"·ᕃ","ᣏ":"·ᕆ","ᣐ":"·ᕇ","ᣑ":"·ᕈ","ᣒ":"·ᕉ","ᣓ":"·ᕋ","ᕎ":"·ᕌ","ᕛ":"·ᕚ","ᕨ":"·ᕧ","ᢳ":"·ᢱ","ᢶ":"·ᢴ","ᢹ":"·ᢸ","ᣂ":"·ᣀ","꠰":"।","॥":"।।","᰼":"᰻᰻","။":"၊၊","᪩":"᪨᪨","᪫":"᪪᪨","᭟":"᭞᭞","𐩗":"𐩖𐩖","𑑌":"𑑋𑑋","𑙂":"𑙁𑙁","𑱂":"𑱁𑱁","᱿":"᱾᱾","՝":"\'","＇":"\'","‘":"\'","’":"\'","‛":"\'","′":"\'","‵":"\'","՚":"\'","׳":"\'","`":"\'","`":"\'","｀":"\'","´":"\'","΄":"\'","´":"\'","᾽":"\'","᾿":"\'","῾":"\'","ʹ":"\'","ʹ":"\'","ˈ":"\'","ˊ":"\'","ˋ":"\'","˴":"\'","ʻ":"\'","ʽ":"\'","ʼ":"\'","ʾ":"\'","ꞌ":"\'","י":"\'","ߴ":"\'","ߵ":"\'","ᑊ":"\'","ᛌ":"\'","𖽑":"\'","𖽒":"\'","᳓":"\'\'","\\"":"\'\'","＂":"\'\'","“":"\'\'","”":"\'\'","‟":"\'\'","″":"\'\'","‶":"\'\'","〃":"\'\'","״":"\'\'","˝":"\'\'","ʺ":"\'\'","˶":"\'\'","ˮ":"\'\'","ײ":"\'\'","‴":"\'\'\'","‷":"\'\'\'","⁗":"\'\'\'\'","Ɓ":"\'B","Ɗ":"\'D","ŉ":"\'n","Ƥ":"\'P","Ƭ":"\'T","Ƴ":"\'Y","［":"(","❨":"(","❲":"(","〔":"(","﴾":"(","⸨":"((","㈠":"(ー)","⑵":"(2)","⒇":"(2O)","⑶":"(3)","⑷":"(4)","⑸":"(5)","⑹":"(6)","⑺":"(7)","⑻":"(8)","⑼":"(9)","⒜":"(a)","🄐":"(A)","⒝":"(b)","🄑":"(B)","⒞":"(c)","🄒":"(C)","⒟":"(d)","🄓":"(D)","⒠":"(e)","🄔":"(E)","⒡":"(f)","🄕":"(F)","⒢":"(g)","🄖":"(G)","⒣":"(h)","🄗":"(H)","⒤":"(i)","⒥":"(j)","🄙":"(J)","⒦":"(k)","🄚":"(K)","⑴":"(l)","🄘":"(l)","⒧":"(l)","🄛":"(L)","⑿":"(l2)","⒀":"(l3)","⒁":"(l4)","⒂":"(l5)","⒃":"(l6)","⒄":"(l7)","⒅":"(l8)","⒆":"(l9)","⑾":"(ll)","⑽":"(lO)","🄜":"(M)","⒩":"(n)","🄝":"(N)","⒪":"(o)","🄞":"(O)","⒫":"(p)","🄟":"(P)","⒬":"(q)","🄠":"(Q)","⒭":"(r)","🄡":"(R)","⒨":"(rn)","⒮":"(s)","🄢":"(S)","🄪":"(S)","⒯":"(t)","🄣":"(T)","⒰":"(u)","🄤":"(U)","⒱":"(v)","🄥":"(V)","⒲":"(w)","🄦":"(W)","⒳":"(x)","🄧":"(X)","⒴":"(y)","🄨":"(Y)","⒵":"(z)","🄩":"(Z)","㈀":"(ᄀ)","㈎":"(가)","㈁":"(ᄂ)","㈏":"(나)","㈂":"(ᄃ)","㈐":"(다)","㈃":"(ᄅ)","㈑":"(라)","㈄":"(ᄆ)","㈒":"(마)","㈅":"(ᄇ)","㈓":"(바)","㈆":"(ᄉ)","㈔":"(사)","㈇":"(ᄋ)","㈕":"(아)","㈝":"(오전)","㈞":"(오후)","㈈":"(ᄌ)","㈖":"(자)","㈜":"(주)","㈉":"(ᄎ)","㈗":"(차)","㈊":"(ᄏ)","㈘":"(카)","㈋":"(ᄐ)","㈙":"(타)","㈌":"(ᄑ)","㈚":"(파)","㈍":"(ᄒ)","㈛":"(하)","㈦":"(七)","㈢":"(三)","🉁":"(三)","㈨":"(九)","㈡":"(二)","🉂":"(二)","㈤":"(五)","㈹":"(代)","㈽":"(企)","㉁":"(休)","㈧":"(八)","㈥":"(六)","㈸":"(労)","🉇":"(勝)","㈩":"(十)","㈿":"(協)","㈴":"(名)","㈺":"(呼)","㈣":"(四)","㈯":"(土)","㈻":"(学)","🉃":"(安)","🉅":"(打)","🉈":"(敗)","㈰":"(日)","㈪":"(月)","㈲":"(有)","㈭":"(木)","🉀":"(本)","㈱":"(株)","㈬":"(水)","㈫":"(火)","🉄":"(点)","㈵":"(特)","🉆":"(盗)","㈼":"(監)","㈳":"(社)","㈷":"(祝)","㉀":"(祭)","㉂":"(自)","㉃":"(至)","㈶":"(財)","㈾":"(資)","㈮":"(金)","］":")","❩":")","❳":")","〕":")","﴿":")","⸩":"))","❴":"{","𝄔":"{","❵":"}","〚":"⟦","〛":"⟧","⟨":"❬","〈":"❬","〈":"❬","㇛":"❬","く":"❬","𡿨":"❬","⟩":"❭","〉":"❭","〉":"❭","＾":"︿","⸿":"¶","⁎":"*","٭":"*","∗":"*","𐌟":"*","᜵":"/","⁁":"/","∕":"/","⁄":"/","╱":"/","⟋":"/","⧸":"/","𝈺":"/","㇓":"/","〳":"/","Ⳇ":"/","ノ":"/","丿":"/","⼃":"/","⧶":"/̄","⫽":"//","⫻":"///","＼":"\\\\","﹨":"\\\\","∖":"\\\\","⟍":"\\\\","⧵":"\\\\","⧹":"\\\\","𝈏":"\\\\","𝈻":"\\\\","㇔":"\\\\","丶":"\\\\","⼂":"\\\\","⳹":"\\\\\\\\","⑊":"\\\\\\\\","⟈":"\\\\ᑕ","ꝸ":"&","૰":"॰","𑂻":"॰","𑇇":"॰","⚬":"॰","𑇛":"꣼","៙":"๏","៕":"๚","៚":"๛","༌":"་","༎":"།།","˄":"^","ˆ":"^","꙾":"ˇ","˘":"ˇ","‾":"ˉ","﹉":"ˉ","﹊":"ˉ","﹋":"ˉ","﹌":"ˉ","¯":"ˉ","￣":"ˉ","▔":"ˉ","ъ":"ˉb","ꙑ":"ˉbi","͵":"ˏ","˻":"˪","꜖":"˪","꜔":"˫","。":"˳","⸰":"°","˚":"°","∘":"°","○":"°","◦":"°","⍜":"°̲","⍤":"°̈","℃":"°C","℉":"°F","௵":"௳","༛":"༚༚","༟":"༚༝","࿎":"༝༚","༞":"༝༝","Ⓒ":"©","Ⓡ":"®","Ⓟ":"℗","𝈛":"⅄","⯬":"↞","⯭":"↟","⯮":"↠","⯯":"↡","↵":"↲","⥥":"⇃⇂","⥯":"⇃ᛚ","𝛛":"∂","𝜕":"∂","𝝏":"∂","𝞉":"∂","𝟃":"∂","𞣌":"∂","𞣍":"∂̵","ð":"∂̵","⌀":"∅","𝛁":"∇","𝛻":"∇","𝜵":"∇","𝝯":"∇","𝞩":"∇","𑢨":"∇","⍢":"∇̈","⍫":"∇̴","█":"∎","■":"∎","⨿":"∐","᛭":"+","➕":"+","𐊛":"+","⨣":"+̂","⨢":"+̊","⨤":"+̃","∔":"+̇","⨥":"+̣","⨦":"+̰","⨧":"+₂","➗":"÷","‹":"<","❮":"<","˂":"<","𝈶":"<","ᐸ":"<","ᚲ":"<","⋖":"<·","Ⲵ":"<·","ᑅ":"<·","≪":"<<","⋘":"<<<","᐀":"=","⹀":"=","゠":"=","꓿":"=","≚":"=̆","≙":"=̂","≗":"=̊","≐":"=̇","≑":"=̣̇","⩮":"=⃰","⩵":"==","⩶":"===","≞":"=ͫ","›":">","❯":">","˃":">","𝈷":">","ᐳ":">","𖼿":">","ᑁ":">·","⪥":"><","≫":">>","⨠":">>","⋙":">>>","⁓":"~","˜":"~","῀":"~","∼":"~","⍨":"~̈","⸞":"~̇","⩪":"~̇","⸟":"~̣","𞣈":"∠","⋀":"∧","∯":"∮∮","∰":"∮∮∮","⸫":"∴","⸪":"∵","⸬":"∷","𑇞":"≈","♎":"≏","🝞":"≏","≣":"≡","⨃":"⊍","⨄":"⊎","𝈸":"⊏","𝈹":"⊐","⨅":"⊓","⨆":"⊔","⨂":"⊗","⍟":"⊛","🝱":"⊠","🝕":"⊡","◁":"⊲","▷":"⊳","⍣":"⋆̈","︴":"⌇","◠":"⌒","⨽":"⌙","⌥":"⌤","⧇":"⌻","◎":"⌾","⦾":"⌾","⧅":"⍂","⦰":"⍉","⏃":"⍋","⏂":"⍎","⏁":"⍕","⏆":"⍭","☸":"⎈","︵":"⏜","︶":"⏝","︷":"⏞","︸":"⏟","︹":"⏠","︺":"⏡","▱":"⏥","⏼":"⏻","︱":"│","｜":"│","┃":"│","┏":"┌","┣":"├","▐":"▌","▗":"▖","▝":"▘","☐":"□","￭":"▪","▸":"▶","►":"▶","⳩":"☧","🜊":"☩","🌒":"☽","🌙":"☽","⏾":"☾","🌘":"☾","⧙":"⦚","🜺":"⧟","⨾":"⨟","𐆠":"⳨","♩":"𝅘𝅥","♪":"𝅘𝅥𝅮","⓪":"🄍","↺":"🄎","˙":"ॱ","ൎ":"ॱ","－":"ー","—":"ー","―":"ー","─":"ー","━":"ー","㇐":"ー","ꟷ":"ー","ᅳ":"ー","ㅡ":"ー","一":"ー","⼀":"ー","ᆖ":"ーー","ힹ":"ーᅡ","ힺ":"ーᅥ","ힻ":"ーᅥ丨","ힼ":"ーᅩ","ᆕ":"ーᅮ","ᅴ":"ー丨","ㅢ":"ー丨","ᆗ":"ー丨ᅮ","🄏":"$⃠","₤":"£","〒":"₸","〶":"₸","᭜":"᭐","꧆":"꧐","𑓑":"১","೧":"౧","ၥ":"၁","①":"➀","⑩":"➉","⏨":"₁₀","𝟐":"2","𝟚":"2","𝟤":"2","𝟮":"2","𝟸":"2","🯲":"2","Ꝛ":"2","Ƨ":"2","Ϩ":"2","Ꙅ":"2","ᒿ":"2","ꛯ":"2","ꧏ":"٢","۲":"٢","૨":"२","𑓒":"২","೨":"౨","②":"➁","ƻ":"2̵","🄃":"2,","⒉":"2.","㏵":"22日","㍮":"22点","㏶":"23日","㍯":"23点","㏷":"24日","㍰":"24点","㏸":"25日","㏹":"26日","㏺":"27日","㏻":"28日","㏼":"29日","㏴":"2l日","㍭":"2l点","⒛":"2O.","㏳":"2O日","㍬":"2O点","෩":"෨ා","෯":"෨ී","㏡":"2日","㋁":"2月","㍚":"2点","𝈆":"3","𝟑":"3","𝟛":"3","𝟥":"3","𝟯":"3","𝟹":"3","🯳":"3","Ɜ":"3","Ȝ":"3","Ʒ":"3","Ꝫ":"3","Ⳍ":"3","З":"3","Ӡ":"3","𖼻":"3","𑣊":"3","۳":"٣","𞣉":"٣","૩":"३","③":"➂","Ҙ":"3̦","🄄":"3,","⒊":"3.","㏾":"3l日","㏽":"3O日","㏢":"3日","㋂":"3月","㍛":"3点","𝟒":"4","𝟜":"4","𝟦":"4","𝟰":"4","𝟺":"4","🯴":"4","Ꮞ":"4","𑢯":"4","۴":"٤","૪":"४","④":"➃","🄅":"4,","⒋":"4.","ᔰ":"4·","㏣":"4日","㋃":"4月","㍜":"4点","𝟓":"5","𝟝":"5","𝟧":"5","𝟱":"5","𝟻":"5","🯵":"5","Ƽ":"5","𑢻":"5","⑤":"➄","🄆":"5,","⒌":"5.","㏤":"5日","㋄":"5月","㍝":"5点","𝟔":"6","𝟞":"6","𝟨":"6","𝟲":"6","𝟼":"6","🯶":"6","Ⳓ":"6","б":"6","Ꮾ":"6","𑣕":"6","۶":"٦","𑓖":"৬","⑥":"➅","🄇":"6,","⒍":"6.","㏥":"6日","㋅":"6月","㍞":"6点","𝈒":"7","𝟕":"7","𝟟":"7","𝟩":"7","𝟳":"7","𝟽":"7","🯷":"7","𐓒":"7","𑣆":"7","⑦":"➆","🄈":"7,","⒎":"7.","㏦":"7日","㋆":"7月","㍟":"7点","ଃ":"8","৪":"8","੪":"8","𞣋":"8","𝟖":"8","𝟠":"8","𝟪":"8","𝟴":"8","𝟾":"8","🯸":"8","ȣ":"8","Ȣ":"8","𐌚":"8","૮":"८","⑧":"➇","🄉":"8,","⒏":"8.","㏧":"8日","㋇":"8月","㍠":"8点","੧":"9","୨":"9","৭":"9","൭":"9","𝟗":"9","𝟡":"9","𝟫":"9","𝟵":"9","𝟿":"9","🯹":"9","Ꝯ":"9","Ⳋ":"9","𑣌":"9","𑢬":"9","𑣖":"9","१":"٩","𑣤":"٩","۹":"٩","೯":"౯","⑨":"➈","🄊":"9,","⒐":"9.","㏨":"9日","㋈":"9月","㍡":"9点","⍺":"a","ａ":"a","𝐚":"a","𝑎":"a","𝒂":"a","𝒶":"a","𝓪":"a","𝔞":"a","𝕒":"a","𝖆":"a","𝖺":"a","𝗮":"a","𝘢":"a","𝙖":"a","𝚊":"a","ɑ":"a","α":"a","𝛂":"a","𝛼":"a","𝜶":"a","𝝰":"a","𝞪":"a","а":"a","ⷶ":"ͣ","Ａ":"A","𝐀":"A","𝐴":"A","𝑨":"A","𝒜":"A","𝓐":"A","𝔄":"A","𝔸":"A","𝕬":"A","𝖠":"A","𝗔":"A","𝘈":"A","𝘼":"A","𝙰":"A","Α":"A","𝚨":"A","𝛢":"A","𝜜":"A","𝝖":"A","𝞐":"A","А":"A","Ꭺ":"A","ᗅ":"A","ꓮ":"A","𖽀":"A","𐊠":"A","⍶":"a̲","ǎ":"ă","Ǎ":"Ă","ȧ":"å","Ȧ":"Å","ẚ":"ả","℀":"a/c","℁":"a/s","ꜳ":"aa","Ꜳ":"AA","æ":"ae","ӕ":"ae","Æ":"AE","Ӕ":"AE","ꜵ":"ao","Ꜵ":"AO","🜇":"AR","ꜷ":"au","Ꜷ":"AU","ꜹ":"av","ꜻ":"av","Ꜹ":"AV","Ꜻ":"AV","ꜽ":"ay","Ꜽ":"AY","ꭺ":"ᴀ","∀":"Ɐ","𝈗":"Ɐ","ᗄ":"Ɐ","ꓯ":"Ɐ","𐐟":"Ɒ","𝐛":"b","𝑏":"b","𝒃":"b","𝒷":"b","𝓫":"b","𝔟":"b","𝕓":"b","𝖇":"b","𝖻":"b","𝗯":"b","𝘣":"b","𝙗":"b","𝚋":"b","Ƅ":"b","Ь":"b","Ꮟ":"b","ᑲ":"b","ᖯ":"b","Ｂ":"B","ℬ":"B","𝐁":"B","𝐵":"B","𝑩":"B","𝓑":"B","𝔅":"B","𝔹":"B","𝕭":"B","𝖡":"B","𝗕":"B","𝘉":"B","𝘽":"B","𝙱":"B","Ꞵ":"B","Β":"B","𝚩":"B","𝛣":"B","𝜝":"B","𝝗":"B","𝞑":"B","В":"B","Ᏼ":"B","ᗷ":"B","ꓐ":"B","𐊂":"B","𐊡":"B","𐌁":"B","ɓ":"b̔","ᑳ":"ḃ","ƃ":"b̄","Ƃ":"b̄","Б":"b̄","ƀ":"b̵","ҍ":"b̵","Ҍ":"b̵","ѣ":"b̵","Ѣ":"b̵","ᑿ":"b·","ᒁ":"ḃ·","ᒈ":"b\'","Ы":"bl","в":"ʙ","ᏼ":"ʙ","ｃ":"c","ⅽ":"c","𝐜":"c","𝑐":"c","𝒄":"c","𝒸":"c","𝓬":"c","𝔠":"c","𝕔":"c","𝖈":"c","𝖼":"c","𝗰":"c","𝘤":"c","𝙘":"c","𝚌":"c","ᴄ":"c","ϲ":"c","ⲥ":"c","с":"c","ꮯ":"c","𐐽":"c","ⷭ":"ͨ","🝌":"C","𑣲":"C","𑣩":"C","Ｃ":"C","Ⅽ":"C","ℂ":"C","ℭ":"C","𝐂":"C","𝐶":"C","𝑪":"C","𝒞":"C","𝓒":"C","𝕮":"C","𝖢":"C","𝗖":"C","𝘊":"C","𝘾":"C","𝙲":"C","Ϲ":"C","Ⲥ":"C","С":"C","Ꮯ":"C","ꓚ":"C","𐊢":"C","𐌂":"C","𐐕":"C","𐔜":"C","¢":"c̸","ȼ":"c̸","₡":"C⃫","🅮":"C⃠","ç":"c̦","ҫ":"c̦","Ç":"C̦","Ҫ":"C̦","Ƈ":"C\'","℅":"c/o","℆":"c/u","🅭":"㏄\\t⃝","⋴":"ꞓ","ɛ":"ꞓ","ε":"ꞓ","ϵ":"ꞓ","𝛆":"ꞓ","𝛜":"ꞓ","𝜀":"ꞓ","𝜖":"ꞓ","𝜺":"ꞓ","𝝐":"ꞓ","𝝴":"ꞓ","𝞊":"ꞓ","𝞮":"ꞓ","𝟄":"ꞓ","ⲉ":"ꞓ","є":"ꞓ","ԑ":"ꞓ","ꮛ":"ꞓ","𑣎":"ꞓ","𐐩":"ꞓ","€":"Ꞓ","Ⲉ":"Ꞓ","Є":"Ꞓ","⍷":"ꞓ̲","ͽ":"ꜿ","Ͽ":"Ꜿ","ⅾ":"d","ⅆ":"d","𝐝":"d","𝑑":"d","𝒅":"d","𝒹":"d","𝓭":"d","𝔡":"d","𝕕":"d","𝖉":"d","𝖽":"d","𝗱":"d","𝘥":"d","𝙙":"d","𝚍":"d","ԁ":"d","Ꮷ":"d","ᑯ":"d","ꓒ":"d","Ⅾ":"D","ⅅ":"D","𝐃":"D","𝐷":"D","𝑫":"D","𝒟":"D","𝓓":"D","𝔇":"D","𝔻":"D","𝕯":"D","𝖣":"D","𝗗":"D","𝘋":"D","𝘿":"D","𝙳":"D","Ꭰ":"D","ᗞ":"D","ᗪ":"D","ꓓ":"D","ɗ":"d̔","ɖ":"d̨","ƌ":"d̄","đ":"d̵","Đ":"D̵","Ð":"D̵","Ɖ":"D̵","₫":"ḏ̵","ꝺ":"Ꝺ","ᑻ":"d·","ᒇ":"d\'","ʤ":"dȝ","ǳ":"dz","ʣ":"dz","ǲ":"Dz","Ǳ":"DZ","ǆ":"dž","ǅ":"Dž","Ǆ":"DŽ","ʥ":"dʑ","ꭰ":"ᴅ","⸹":"ẟ","δ":"ẟ","𝛅":"ẟ","𝛿":"ẟ","𝜹":"ẟ","𝝳":"ẟ","𝞭":"ẟ","ծ":"ẟ","ᕷ":"ẟ","℮":"e","ｅ":"e","ℯ":"e","ⅇ":"e","𝐞":"e","𝑒":"e","𝒆":"e","𝓮":"e","𝔢":"e","𝕖":"e","𝖊":"e","𝖾":"e","𝗲":"e","𝘦":"e","𝙚":"e","𝚎":"e","ꬲ":"e","е":"e","ҽ":"e","ⷷ":"ͤ","⋿":"E","Ｅ":"E","ℰ":"E","𝐄":"E","𝐸":"E","𝑬":"E","𝓔":"E","𝔈":"E","𝔼":"E","𝕰":"E","𝖤":"E","𝗘":"E","𝘌":"E","𝙀":"E","𝙴":"E","Ε":"E","𝚬":"E","𝛦":"E","𝜠":"E","𝝚":"E","𝞔":"E","Е":"E","ⴹ":"E","Ꭼ":"E","ꓰ":"E","𑢦":"E","𑢮":"E","𐊆":"E","ě":"ĕ","Ě":"Ĕ","ɇ":"e̸","Ɇ":"E̸","ҿ":"ę","ꭼ":"ᴇ","ə":"ǝ","ә":"ǝ","∃":"Ǝ","ⴺ":"Ǝ","ꓱ":"Ǝ","ɚ":"ǝ˞","ᴔ":"ǝo","ꭁ":"ǝo̸","ꭂ":"ǝo̵","Ә":"Ə","𝈡":"Ɛ","ℇ":"Ɛ","Ԑ":"Ɛ","Ꮛ":"Ɛ","𖼭":"Ɛ","𐐁":"Ɛ","ᶟ":"ᵋ","ᴈ":"ɜ","з":"ɜ","ҙ":"ɜ̦","𐑂":"ɞ","ꞝ":"ʚ","𐐪":"ʚ","𝐟":"f","𝑓":"f","𝒇":"f","𝒻":"f","𝓯":"f","𝔣":"f","𝕗":"f","𝖋":"f","𝖿":"f","𝗳":"f","𝘧":"f","𝙛":"f","𝚏":"f","ꬵ":"f","ꞙ":"f","ſ":"f","ẝ":"f","ք":"f","𝈓":"F","ℱ":"F","𝐅":"F","𝐹":"F","𝑭":"F","𝓕":"F","𝔉":"F","𝔽":"F","𝕱":"F","𝖥":"F","𝗙":"F","𝘍":"F","𝙁":"F","𝙵":"F","Ꞙ":"F","Ϝ":"F","𝟊":"F","ᖴ":"F","ꓝ":"F","𑣂":"F","𑢢":"F","𐊇":"F","𐊥":"F","𐔥":"F","ƒ":"f̦","Ƒ":"F̦","ᵮ":"f̴","℻":"FAX","ﬀ":"ff","ﬃ":"ffi","ﬄ":"ffl","ﬁ":"fi","ﬂ":"fl","ʩ":"fŋ","ᖵ":"Ⅎ","ꓞ":"Ⅎ","𝈰":"ꟻ","ᖷ":"ꟻ","ｇ":"g","ℊ":"g","𝐠":"g","𝑔":"g","𝒈":"g","𝓰":"g","𝔤":"g","𝕘":"g","𝖌":"g","𝗀":"g","𝗴":"g","𝘨":"g","𝙜":"g","𝚐":"g","ɡ":"g","ᶃ":"g","ƍ":"g","ց":"g","𝐆":"G","𝐺":"G","𝑮":"G","𝒢":"G","𝓖":"G","𝔊":"G","𝔾":"G","𝕲":"G","𝖦":"G","𝗚":"G","𝘎":"G","𝙂":"G","𝙶":"G","Ԍ":"G","Ꮐ":"G","Ᏻ":"G","ꓖ":"G","ᶢ":"ᵍ","ɠ":"g̔","ǧ":"ğ","Ǧ":"Ğ","ǵ":"ģ","ǥ":"g̵","Ǥ":"G̵","Ɠ":"G\'","ԍ":"ɢ","ꮐ":"ɢ","ᏻ":"ɢ","ｈ":"h","ℎ":"h","𝐡":"h","𝒉":"h","𝒽":"h","𝓱":"h","𝔥":"h","𝕙":"h","𝖍":"h","𝗁":"h","𝗵":"h","𝘩":"h","𝙝":"h","𝚑":"h","һ":"h","հ":"h","Ꮒ":"h","Ｈ":"H","ℋ":"H","ℌ":"H","ℍ":"H","𝐇":"H","𝐻":"H","𝑯":"H","𝓗":"H","𝕳":"H","𝖧":"H","𝗛":"H","𝘏":"H","𝙃":"H","𝙷":"H","Η":"H","𝚮":"H","𝛨":"H","𝜢":"H","𝝜":"H","𝞖":"H","Ⲏ":"H","Н":"H","Ꮋ":"H","ᕼ":"H","ꓧ":"H","𐋏":"H","ᵸ":"ᴴ","ɦ":"h̔","ꚕ":"h̔","Ᏺ":"h̔","Ⱨ":"H̩","Ң":"H̩","ħ":"h̵","ℏ":"h̵","ћ":"h̵","Ħ":"H̵","Ӊ":"H̦","Ӈ":"H̦","н":"ʜ","ꮋ":"ʜ","ң":"ʜ̩","ӊ":"ʜ̦","ӈ":"ʜ̦","Ԋ":"Ƕ","ꮀ":"ⱶ","Ͱ":"Ⱶ","Ꭸ":"Ⱶ","Ꮀ":"Ⱶ","ꚱ":"Ⱶ","ꞕ":"ꜧ","˛":"i","⍳":"i","ｉ":"i","ⅰ":"i","ℹ":"i","ⅈ":"i","𝐢":"i","𝑖":"i","𝒊":"i","𝒾":"i","𝓲":"i","𝔦":"i","𝕚":"i","𝖎":"i","𝗂":"i","𝗶":"i","𝘪":"i","𝙞":"i","𝚒":"i","ı":"i","𝚤":"i","ɪ":"i","ɩ":"i","ι":"i","ι":"i","ͺ":"i","𝛊":"i","𝜄":"i","𝜾":"i","𝝸":"i","𝞲":"i","і":"i","ꙇ":"i","ӏ":"i","ꭵ":"i","Ꭵ":"i","𑣃":"i","ⓛ":"Ⓘ","⍸":"i̲","ǐ":"ĭ","Ǐ":"Ĭ","ɨ":"i̵","ᵻ":"i̵","ᵼ":"i̵","ⅱ":"ii","ⅲ":"iii","ĳ":"ij","ⅳ":"iv","ⅸ":"ix","ｊ":"j","ⅉ":"j","𝐣":"j","𝑗":"j","𝒋":"j","𝒿":"j","𝓳":"j","𝔧":"j","𝕛":"j","𝖏":"j","𝗃":"j","𝗷":"j","𝘫":"j","𝙟":"j","𝚓":"j","ϳ":"j","ј":"j","Ｊ":"J","𝐉":"J","𝐽":"J","𝑱":"J","𝒥":"J","𝓙":"J","𝔍":"J","𝕁":"J","𝕵":"J","𝖩":"J","𝗝":"J","𝘑":"J","𝙅":"J","𝙹":"J","Ʝ":"J","Ϳ":"J","Ј":"J","Ꭻ":"J","ᒍ":"J","ꓙ":"J","ɉ":"j̵","Ɉ":"J̵","ᒙ":"J·","𝚥":"ȷ","յ":"ȷ","ꭻ":"ᴊ","𝐤":"k","𝑘":"k","𝒌":"k","𝓀":"k","𝓴":"k","𝔨":"k","𝕜":"k","𝖐":"k","𝗄":"k","𝗸":"k","𝘬":"k","𝙠":"k","𝚔":"k","K":"K","Ｋ":"K","𝐊":"K","𝐾":"K","𝑲":"K","𝒦":"K","𝓚":"K","𝔎":"K","𝕂":"K","𝕶":"K","𝖪":"K","𝗞":"K","𝘒":"K","𝙆":"K","𝙺":"K","Κ":"K","𝚱":"K","𝛫":"K","𝜥":"K","𝝟":"K","𝞙":"K","Ⲕ":"K","К":"K","Ꮶ":"K","ᛕ":"K","ꓗ":"K","𐔘":"K","ƙ":"k̔","Ⱪ":"K̩","Қ":"K̩","₭":"K̵","Ꝁ":"K̵","Ҟ":"K̵","Ƙ":"K\'","׀":"l","|":"l","∣":"l","⏽":"l","￨":"l","١":"l","۱":"l","𐌠":"l","𞣇":"l","𝟏":"l","𝟙":"l","𝟣":"l","𝟭":"l","𝟷":"l","🯱":"l","I":"l","Ｉ":"l","Ⅰ":"l","ℐ":"l","ℑ":"l","𝐈":"l","𝐼":"l","𝑰":"l","𝓘":"l","𝕀":"l","𝕴":"l","𝖨":"l","𝗜":"l","𝘐":"l","𝙄":"l","𝙸":"l","Ɩ":"l","ｌ":"l","ⅼ":"l","ℓ":"l","𝐥":"l","𝑙":"l","𝒍":"l","𝓁":"l","𝓵":"l","𝔩":"l","𝕝":"l","𝖑":"l","𝗅":"l","𝗹":"l","𝘭":"l","𝙡":"l","𝚕":"l","ǀ":"l","Ι":"l","𝚰":"l","𝛪":"l","𝜤":"l","𝝞":"l","𝞘":"l","Ⲓ":"l","І":"l","Ӏ":"l","ו":"l","ן":"l","ا":"l","𞸀":"l","𞺀":"l","ﺎ":"l","ﺍ":"l","ߊ":"l","ⵏ":"l","ᛁ":"l","ꓲ":"l","𖼨":"l","𐊊":"l","𐌉":"l","𝈪":"L","Ⅼ":"L","ℒ":"L","𝐋":"L","𝐿":"L","𝑳":"L","𝓛":"L","𝔏":"L","𝕃":"L","𝕷":"L","𝖫":"L","𝗟":"L","𝘓":"L","𝙇":"L","𝙻":"L","Ⳑ":"L","Ꮮ":"L","ᒪ":"L","ꓡ":"L","𖼖":"L","𑢣":"L","𑢲":"L","𐐛":"L","𐔦":"L","ﴼ":"l̋","ﴽ":"l̋","ł":"l̸","Ł":"L̸","ɭ":"l̨","Ɨ":"l̵","ƚ":"l̵","ɫ":"l̴","إ":"lٕ","ﺈ":"lٕ","ﺇ":"lٕ","ٳ":"lٕ","ŀ":"l·","Ŀ":"l·","ᒷ":"l·","🄂":"l,","⒈":"l.","ױ":"l\'","⒓":"l2.","㏫":"l2日","㋋":"l2月","㍤":"l2点","⒔":"l3.","㏬":"l3日","㍥":"l3点","⒕":"l4.","㏭":"l4日","㍦":"l4点","⒖":"l5.","㏮":"l5日","㍧":"l5点","⒗":"l6.","㏯":"l6日","㍨":"l6点","⒘":"l7.","㏰":"l7日","㍩":"l7点","⒙":"l8.","㏱":"l8日","㍪":"l8点","⒚":"l9.","㏲":"l9日","㍫":"l9点","ǉ":"lj","Ĳ":"lJ","ǈ":"Lj","Ǉ":"LJ","‖":"ll","∥":"ll","Ⅱ":"ll","ǁ":"ll","װ":"ll","𐆙":"l̵l̵","⒒":"ll.","Ⅲ":"lll","𐆘":"l̵l̵S̵","㏪":"ll日","㋊":"ll月","㍣":"ll点","Ю":"lO","⒑":"lO.","㏩":"lO日","㋉":"lO月","㍢":"lO点","ʪ":"ls","₶":"lt","Ⅳ":"lV","Ⅸ":"lX","ɮ":"lȝ","ʫ":"lz","أ":"lٴ","ﺄ":"lٴ","ﺃ":"lٴ","ٲ":"lٴ","ٵ":"lٴ","ﷳ":"lكبر","ﷲ":"lللّٰo","㏠":"l日","㋀":"l月","㍙":"l点","ⳑ":"ʟ","ꮮ":"ʟ","𐑃":"ʟ","Ｍ":"M","Ⅿ":"M","ℳ":"M","𝐌":"M","𝑀":"M","𝑴":"M","𝓜":"M","𝔐":"M","𝕄":"M","𝕸":"M","𝖬":"M","𝗠":"M","𝘔":"M","𝙈":"M","𝙼":"M","Μ":"M","𝚳":"M","𝛭":"M","𝜧":"M","𝝡":"M","𝞛":"M","Ϻ":"M","Ⲙ":"M","М":"M","Ꮇ":"M","ᗰ":"M","ᛖ":"M","ꓟ":"M","𐊰":"M","𐌑":"M","Ӎ":"M̦","🝫":"MB","ⷨ":"ᷟ","𝐧":"n","𝑛":"n","𝒏":"n","𝓃":"n","𝓷":"n","𝔫":"n","𝕟":"n","𝖓":"n","𝗇":"n","𝗻":"n","𝘯":"n","𝙣":"n","𝚗":"n","ո":"n","ռ":"n","Ｎ":"N","ℕ":"N","𝐍":"N","𝑁":"N","𝑵":"N","𝒩":"N","𝓝":"N","𝔑":"N","𝕹":"N","𝖭":"N","𝗡":"N","𝘕":"N","𝙉":"N","𝙽":"N","Ν":"N","𝚴":"N","𝛮":"N","𝜨":"N","𝝢":"N","𝞜":"N","Ⲛ":"N","ꓠ":"N","𐔓":"N","𐆎":"N̊","ɳ":"n̨","ƞ":"n̩","η":"n̩","𝛈":"n̩","𝜂":"n̩","𝜼":"n̩","𝝶":"n̩","𝞰":"n̩","Ɲ":"N̦","ᵰ":"n̴","ǌ":"nj","ǋ":"Nj","Ǌ":"NJ","№":"No","ͷ":"ᴎ","и":"ᴎ","𐑍":"ᴎ","ņ":"ɲ","ం":"o","ಂ":"o","ം":"o","ං":"o","०":"o","੦":"o","૦":"o","௦":"o","౦":"o","೦":"o","൦":"o","๐":"o","໐":"o","၀":"o","٥":"o","۵":"o","ｏ":"o","ℴ":"o","𝐨":"o","𝑜":"o","𝒐":"o","𝓸":"o","𝔬":"o","𝕠":"o","𝖔":"o","𝗈":"o","𝗼":"o","𝘰":"o","𝙤":"o","𝚘":"o","ᴏ":"o","ᴑ":"o","ꬽ":"o","ο":"o","𝛐":"o","𝜊":"o","𝝄":"o","𝝾":"o","𝞸":"o","σ":"o","𝛔":"o","𝜎":"o","𝝈":"o","𝞂":"o","𝞼":"o","ⲟ":"o","о":"o","ჿ":"o","օ":"o","ס":"o","ه":"o","𞸤":"o","𞹤":"o","𞺄":"o","ﻫ":"o","ﻬ":"o","ﻪ":"o","ﻩ":"o","ھ":"o","ﮬ":"o","ﮭ":"o","ﮫ":"o","ﮪ":"o","ہ":"o","ﮨ":"o","ﮩ":"o","ﮧ":"o","ﮦ":"o","ە":"o","ഠ":"o","ဝ":"o","𐓪":"o","𑣈":"o","𑣗":"o","𐐬":"o","߀":"O","০":"O","୦":"O","〇":"O","𑓐":"O","𑣠":"O","𝟎":"O","𝟘":"O","𝟢":"O","𝟬":"O","𝟶":"O","🯰":"O","Ｏ":"O","𝐎":"O","𝑂":"O","𝑶":"O","𝒪":"O","𝓞":"O","𝔒":"O","𝕆":"O","𝕺":"O","𝖮":"O","𝗢":"O","𝘖":"O","𝙊":"O","𝙾":"O","Ο":"O","𝚶":"O","𝛰":"O","𝜪":"O","𝝤":"O","𝞞":"O","Ⲟ":"O","О":"O","Օ":"O","ⵔ":"O","ዐ":"O","ଠ":"O","𐓂":"O","ꓳ":"O","𑢵":"O","𐊒":"O","𐊫":"O","𐐄":"O","𐔖":"O","⁰":"º","ᵒ":"º","ǒ":"ŏ","Ǒ":"Ŏ","ۿ":"ô","Ő":"Ö","ø":"o̸","ꬾ":"o̸","Ø":"O̸","ⵁ":"O̸","Ǿ":"Ó̸","ɵ":"o̵","ꝋ":"o̵","ө":"o̵","ѳ":"o̵","ꮎ":"o̵","ꮻ":"o̵","⊖":"O̵","⊝":"O̵","⍬":"O̵","𝈚":"O̵","🜔":"O̵","Ɵ":"O̵","Ꝋ":"O̵","θ":"O̵","ϑ":"O̵","𝛉":"O̵","𝛝":"O̵","𝜃":"O̵","𝜗":"O̵","𝜽":"O̵","𝝑":"O̵","𝝷":"O̵","𝞋":"O̵","𝞱":"O̵","𝟅":"O̵","Θ":"O̵","ϴ":"O̵","𝚯":"O̵","𝚹":"O̵","𝛩":"O̵","𝛳":"O̵","𝜣":"O̵","𝜭":"O̵","𝝝":"O̵","𝝧":"O̵","𝞗":"O̵","𝞡":"O̵","Ө":"O̵","Ѳ":"O̵","ⴱ":"O̵","Ꮎ":"O̵","Ꮻ":"O̵","ꭴ":"ơ","ﳙ":"oٰ","🄁":"O,","🄀":"O.","ơ":"o\'","Ơ":"O\'","Ꭴ":"O\'","%":"º/₀","٪":"º/₀","⁒":"º/₀","‰":"º/₀₀","؉":"º/₀₀","‱":"º/₀₀₀","؊":"º/₀₀₀","œ":"oe","Œ":"OE","ɶ":"oᴇ","∞":"oo","ꝏ":"oo","ꚙ":"oo","Ꝏ":"OO","Ꚙ":"OO","ﳗ":"oج","ﱑ":"oج","ﳘ":"oم","ﱒ":"oم","ﶓ":"oمج","ﶔ":"oمم","ﱓ":"oى","ﱔ":"oى","ൟ":"oരo","တ":"oာ","㍘":"O点","ↄ":"ɔ","ᴐ":"ɔ","ͻ":"ɔ","𐑋":"ɔ","Ↄ":"Ɔ","Ͻ":"Ɔ","ꓛ":"Ɔ","𐐣":"Ɔ","ꬿ":"ɔ̸","ꭢ":"ɔe","𐐿":"ɷ","⍴":"p","ｐ":"p","𝐩":"p","𝑝":"p","𝒑":"p","𝓅":"p","𝓹":"p","𝔭":"p","𝕡":"p","𝖕":"p","𝗉":"p","𝗽":"p","𝘱":"p","𝙥":"p","𝚙":"p","ρ":"p","ϱ":"p","𝛒":"p","𝛠":"p","𝜌":"p","𝜚":"p","𝝆":"p","𝝔":"p","𝞀":"p","𝞎":"p","𝞺":"p","𝟈":"p","ⲣ":"p","р":"p","Ｐ":"P","ℙ":"P","𝐏":"P","𝑃":"P","𝑷":"P","𝒫":"P","𝓟":"P","𝔓":"P","𝕻":"P","𝖯":"P","𝗣":"P","𝘗":"P","𝙋":"P","𝙿":"P","Ρ":"P","𝚸":"P","𝛲":"P","𝜬":"P","𝝦":"P","𝞠":"P","Ⲣ":"P","Р":"P","Ꮲ":"P","ᑭ":"P","ꓑ":"P","𐊕":"P","ƥ":"p̔","ᵽ":"p̵","ᑷ":"p·","ᒆ":"P\'","ᴩ":"ᴘ","ꮲ":"ᴘ","φ":"ɸ","ϕ":"ɸ","𝛗":"ɸ","𝛟":"ɸ","𝜑":"ɸ","𝜙":"ɸ","𝝋":"ɸ","𝝓":"ɸ","𝞅":"ɸ","𝞍":"ɸ","𝞿":"ɸ","𝟇":"ɸ","ⲫ":"ɸ","ф":"ɸ","𝐪":"q","𝑞":"q","𝒒":"q","𝓆":"q","𝓺":"q","𝔮":"q","𝕢":"q","𝖖":"q","𝗊":"q","𝗾":"q","𝘲":"q","𝙦":"q","𝚚":"q","ԛ":"q","գ":"q","զ":"q","ℚ":"Q","𝐐":"Q","𝑄":"Q","𝑸":"Q","𝒬":"Q","𝓠":"Q","𝔔":"Q","𝕼":"Q","𝖰":"Q","𝗤":"Q","𝘘":"Q","𝙌":"Q","𝚀":"Q","ⵕ":"Q","ʠ":"q̔","🜀":"QE","ᶐ":"ɋ","ᴋ":"ĸ","κ":"ĸ","ϰ":"ĸ","𝛋":"ĸ","𝛞":"ĸ","𝜅":"ĸ","𝜘":"ĸ","𝜿":"ĸ","𝝒":"ĸ","𝝹":"ĸ","𝞌":"ĸ","𝞳":"ĸ","𝟆":"ĸ","ⲕ":"ĸ","к":"ĸ","ꮶ":"ĸ","қ":"ĸ̩","ҟ":"ĸ̵","𝐫":"r","𝑟":"r","𝒓":"r","𝓇":"r","𝓻":"r","𝔯":"r","𝕣":"r","𝖗":"r","𝗋":"r","𝗿":"r","𝘳":"r","𝙧":"r","𝚛":"r","ꭇ":"r","ꭈ":"r","ᴦ":"r","ⲅ":"r","г":"r","ꮁ":"r","𝈖":"R","ℛ":"R","ℜ":"R","ℝ":"R","𝐑":"R","𝑅":"R","𝑹":"R","𝓡":"R","𝕽":"R","𝖱":"R","𝗥":"R","𝘙":"R","𝙍":"R","𝚁":"R","Ʀ":"R","Ꭱ":"R","Ꮢ":"R","𐒴":"R","ᖇ":"R","ꓣ":"R","𖼵":"R","ɽ":"r̨","ɼ":"r̩","ɍ":"r̵","ғ":"r̵","ᵲ":"r̴","ґ":"r\'","𑣣":"rn","m":"rn","ⅿ":"rn","𝐦":"rn","𝑚":"rn","𝒎":"rn","𝓂":"rn","𝓶":"rn","𝔪":"rn","𝕞":"rn","𝖒":"rn","𝗆":"rn","𝗺":"rn","𝘮":"rn","𝙢":"rn","𝚖":"rn","𑜀":"rn","₥":"rn̸","ɱ":"rn̦","ᵯ":"rn̴","₨":"Rs","ꭱ":"ʀ","ꮢ":"ʀ","я":"ᴙ","ᵳ":"ɾ̴","℩":"ɿ","ｓ":"s","𝐬":"s","𝑠":"s","𝒔":"s","𝓈":"s","𝓼":"s","𝔰":"s","𝕤":"s","𝖘":"s","𝗌":"s","𝘀":"s","𝘴":"s","𝙨":"s","𝚜":"s","ꜱ":"s","ƽ":"s","ѕ":"s","ꮪ":"s","𑣁":"s","𐑈":"s","Ｓ":"S","𝐒":"S","𝑆":"S","𝑺":"S","𝒮":"S","𝓢":"S","𝔖":"S","𝕊":"S","𝕾":"S","𝖲":"S","𝗦":"S","𝘚":"S","𝙎":"S","𝚂":"S","Ѕ":"S","Տ":"S","Ꮥ":"S","Ꮪ":"S","ꓢ":"S","𖼺":"S","𐊖":"S","𐐠":"S","ʂ":"s̨","ᵴ":"s̴","ꞵ":"ß","β":"ß","ϐ":"ß","𝛃":"ß","𝛽":"ß","𝜷":"ß","𝝱":"ß","𝞫":"ß","Ᏸ":"ß","🝜":"sss","ﬆ":"st","∫":"ʃ","ꭍ":"ʃ","∑":"Ʃ","⅀":"Ʃ","Σ":"Ʃ","𝚺":"Ʃ","𝛴":"Ʃ","𝜮":"Ʃ","𝝨":"Ʃ","𝞢":"Ʃ","ⵉ":"Ʃ","∬":"ʃʃ","∭":"ʃʃʃ","⨌":"ʃʃʃʃ","𝐭":"t","𝑡":"t","𝒕":"t","𝓉":"t","𝓽":"t","𝔱":"t","𝕥":"t","𝖙":"t","𝗍":"t","𝘁":"t","𝘵":"t","𝙩":"t","𝚝":"t","⊤":"T","⟙":"T","🝨":"T","Ｔ":"T","𝐓":"T","𝑇":"T","𝑻":"T","𝒯":"T","𝓣":"T","𝔗":"T","𝕋":"T","𝕿":"T","𝖳":"T","𝗧":"T","𝘛":"T","𝙏":"T","𝚃":"T","Τ":"T","𝚻":"T","𝛵":"T","𝜯":"T","𝝩":"T","𝞣":"T","Ⲧ":"T","Т":"T","Ꭲ":"T","ꓔ":"T","𖼊":"T","𑢼":"T","𐊗":"T","𐊱":"T","𐌕":"T","ƭ":"t̔","⍡":"T̈","Ⱦ":"T̸","Ț":"Ţ","Ʈ":"T̨","Ҭ":"T̩","₮":"T⃫","ŧ":"t̵","Ŧ":"T̵","ᵵ":"t̴","Ⴀ":"Ꞇ","Ꜩ":"T3","ʨ":"tɕ","℡":"TEL","ꝷ":"tf","ʦ":"ts","ʧ":"tʃ","ꜩ":"tȝ","τ":"ᴛ","𝛕":"ᴛ","𝜏":"ᴛ","𝝉":"ᴛ","𝞃":"ᴛ","𝞽":"ᴛ","т":"ᴛ","ꭲ":"ᴛ","ҭ":"ᴛ̩","ţ":"ƫ","ț":"ƫ","Ꮏ":"ƫ","𝐮":"u","𝑢":"u","𝒖":"u","𝓊":"u","𝓾":"u","𝔲":"u","𝕦":"u","𝖚":"u","𝗎":"u","𝘂":"u","𝘶":"u","𝙪":"u","𝚞":"u","ꞟ":"u","ᴜ":"u","ꭎ":"u","ꭒ":"u","ʋ":"u","υ":"u","𝛖":"u","𝜐":"u","𝝊":"u","𝞄":"u","𝞾":"u","ս":"u","𐓶":"u","𑣘":"u","∪":"U","⋃":"U","𝐔":"U","𝑈":"U","𝑼":"U","𝒰":"U","𝓤":"U","𝔘":"U","𝕌":"U","𝖀":"U","𝖴":"U","𝗨":"U","𝘜":"U","𝙐":"U","𝚄":"U","Ս":"U","ሀ":"U","𐓎":"U","ᑌ":"U","ꓴ":"U","𖽂":"U","𑢸":"U","ǔ":"ŭ","Ǔ":"Ŭ","ᵾ":"u̵","ꮜ":"u̵","Ʉ":"U̵","Ꮜ":"U̵","ᑘ":"U·","ᑧ":"U\'","ᵫ":"ue","ꭣ":"uo","ṃ":"ꭑ","պ":"ɰ","ሣ":"ɰ","℧":"Ʊ","ᘮ":"Ʊ","ᘴ":"Ʊ","ᵿ":"ʊ̵","∨":"v","⋁":"v","ｖ":"v","ⅴ":"v","𝐯":"v","𝑣":"v","𝒗":"v","𝓋":"v","𝓿":"v","𝔳":"v","𝕧":"v","𝖛":"v","𝗏":"v","𝘃":"v","𝘷":"v","𝙫":"v","𝚟":"v","ᴠ":"v","ν":"v","𝛎":"v","𝜈":"v","𝝂":"v","𝝼":"v","𝞶":"v","ѵ":"v","ט":"v","𑜆":"v","ꮩ":"v","𑣀":"v","𝈍":"V","٧":"V","۷":"V","Ⅴ":"V","𝐕":"V","𝑉":"V","𝑽":"V","𝒱":"V","𝓥":"V","𝔙":"V","𝕍":"V","𝖁":"V","𝖵":"V","𝗩":"V","𝘝":"V","𝙑":"V","𝚅":"V","Ѵ":"V","ⴸ":"V","Ꮩ":"V","ᐯ":"V","ꛟ":"V","ꓦ":"V","𖼈":"V","𑢠":"V","𐔝":"V","𐆗":"V̵","ᐻ":"V·","🝬":"VB","ⅵ":"vi","ⅶ":"vii","ⅷ":"viii","Ⅵ":"Vl","Ⅶ":"Vll","Ⅷ":"Vlll","🜈":"Vᷤ","ᴧ":"ʌ","𐓘":"ʌ","٨":"Ʌ","۸":"Ʌ","Λ":"Ʌ","𝚲":"Ʌ","𝛬":"Ʌ","𝜦":"Ʌ","𝝠":"Ʌ","𝞚":"Ʌ","Л":"Ʌ","ⴷ":"Ʌ","𐒰":"Ʌ","ᐱ":"Ʌ","ꛎ":"Ʌ","ꓥ":"Ʌ","𖼽":"Ʌ","𐊍":"Ʌ","Ӆ":"Ʌ̦","ᐽ":"Ʌ·","ɯ":"w","𝐰":"w","𝑤":"w","𝒘":"w","𝓌":"w","𝔀":"w","𝔴":"w","𝕨":"w","𝖜":"w","𝗐":"w","𝘄":"w","𝘸":"w","𝙬":"w","𝚠":"w","ᴡ":"w","ѡ":"w","ԝ":"w","ա":"w","𑜊":"w","𑜎":"w","𑜏":"w","ꮃ":"w","𑣯":"W","𑣦":"W","𝐖":"W","𝑊":"W","𝑾":"W","𝒲":"W","𝓦":"W","𝔚":"W","𝕎":"W","𝖂":"W","𝖶":"W","𝗪":"W","𝘞":"W","𝙒":"W","𝚆":"W","Ԝ":"W","Ꮃ":"W","Ꮤ":"W","ꓪ":"W","ѽ":"w҆҇","𑓅":"ẇ","₩":"W̵","ꝡ":"w̦","ᴍ":"ʍ","м":"ʍ","ꮇ":"ʍ","ӎ":"ʍ̦","᙮":"x","×":"x","⤫":"x","⤬":"x","⨯":"x","ｘ":"x","ⅹ":"x","𝐱":"x","𝑥":"x","𝒙":"x","𝓍":"x","𝔁":"x","𝔵":"x","𝕩":"x","𝖝":"x","𝗑":"x","𝘅":"x","𝘹":"x","𝙭":"x","𝚡":"x","х":"x","ᕁ":"x","ᕽ":"x","ⷯ":"ͯ","᙭":"X","╳":"X","𐌢":"X","𑣬":"X","Ｘ":"X","Ⅹ":"X","𝐗":"X","𝑋":"X","𝑿":"X","𝒳":"X","𝓧":"X","𝔛":"X","𝕏":"X","𝖃":"X","𝖷":"X","𝗫":"X","𝘟":"X","𝙓":"X","𝚇":"X","Ꭓ":"X","Χ":"X","𝚾":"X","𝛸":"X","𝜲":"X","𝝬":"X","𝞦":"X","Ⲭ":"X","Х":"X","ⵝ":"X","ᚷ":"X","ꓫ":"X","𐊐":"X","𐊴":"X","𐌗":"X","𐔧":"X","⨰":"ẋ","Ҳ":"X̩","𐆖":"X̵","ⅺ":"xi","ⅻ":"xii","Ⅺ":"Xl","Ⅻ":"Xll","ɣ":"y","ᶌ":"y","ｙ":"y","𝐲":"y","𝑦":"y","𝒚":"y","𝓎":"y","𝔂":"y","𝔶":"y","𝕪":"y","𝖞":"y","𝗒":"y","𝘆":"y","𝘺":"y","𝙮":"y","𝚢":"y","ʏ":"y","ỿ":"y","ꭚ":"y","γ":"y","ℽ":"y","𝛄":"y","𝛾":"y","𝜸":"y","𝝲":"y","𝞬":"y","у":"y","ү":"y","ყ":"y","𑣜":"y","Ｙ":"Y","𝐘":"Y","𝑌":"Y","𝒀":"Y","𝒴":"Y","𝓨":"Y","𝔜":"Y","𝕐":"Y","𝖄":"Y","𝖸":"Y","𝗬":"Y","𝘠":"Y","𝙔":"Y","𝚈":"Y","Υ":"Y","ϒ":"Y","𝚼":"Y","𝛶":"Y","𝜰":"Y","𝝪":"Y","𝞤":"Y","Ⲩ":"Y","У":"Y","Ү":"Y","Ꭹ":"Y","Ꮍ":"Y","ꓬ":"Y","𖽃":"Y","𑢤":"Y","𐊲":"Y","ƴ":"y̔","ɏ":"y̵","ұ":"y̵","¥":"Y̵","Ɏ":"Y̵","Ұ":"Y̵","ʒ":"ȝ","ꝫ":"ȝ","ⳍ":"ȝ","ӡ":"ȝ","ჳ":"ȝ","𝐳":"z","𝑧":"z","𝒛":"z","𝓏":"z","𝔃":"z","𝔷":"z","𝕫":"z","𝖟":"z","𝗓":"z","𝘇":"z","𝘻":"z","𝙯":"z","𝚣":"z","ᴢ":"z","ꮓ":"z","𑣄":"z","𐋵":"Z","𑣥":"Z","Ｚ":"Z","ℤ":"Z","ℨ":"Z","𝐙":"Z","𝑍":"Z","𝒁":"Z","𝒵":"Z","𝓩":"Z","𝖅":"Z","𝖹":"Z","𝗭":"Z","𝘡":"Z","𝙕":"Z","𝚉":"Z","Ζ":"Z","𝚭":"Z","𝛧":"Z","𝜡":"Z","𝝛":"Z","𝞕":"Z","Ꮓ":"Z","ꓜ":"Z","𑢩":"Z","ʐ":"z̨","ƶ":"z̵","Ƶ":"Z̵","ȥ":"z̦","Ȥ":"Z̦","ᵶ":"z̴","ƿ":"þ","ϸ":"þ","Ϸ":"Þ","𐓄":"Þ","⁹":"ꝰ","ᴤ":"ƨ","ϩ":"ƨ","ꙅ":"ƨ","ь":"ƅ","ꮟ":"ƅ","ы":"ƅi","ꭾ":"ɂ","ˤ":"ˁ","ꛍ":"ʡ","⊙":"ʘ","☉":"ʘ","⨀":"ʘ","Ꙩ":"ʘ","ⵙ":"ʘ","𐓃":"ʘ","ℾ":"Γ","𝚪":"Γ","𝛤":"Γ","𝜞":"Γ","𝝘":"Γ","𝞒":"Γ","Ⲅ":"Γ","Г":"Γ","Ꮁ":"Γ","ᒥ":"Γ","𖼇":"Γ","Ғ":"Γ̵","ᒯ":"Γ·","Ґ":"Γ\'","∆":"Δ","△":"Δ","🜂":"Δ","𝚫":"Δ","𝛥":"Δ","𝜟":"Δ","𝝙":"Δ","𝞓":"Δ","Ⲇ":"Δ","ⵠ":"Δ","ᐃ":"Δ","𖼚":"Δ","𐊅":"Δ","𐊣":"Δ","⍙":"Δ̲","ᐏ":"Δ·","ᐬ":"Δᐠ","𝟋":"ϝ","𝛇":"ζ","𝜁":"ζ","𝜻":"ζ","𝝵":"ζ","𝞯":"ζ","ⳤ":"ϗ","𝛌":"λ","𝜆":"λ","𝝀":"λ","𝝺":"λ","𝞴":"λ","Ⲗ":"λ","𐓛":"λ","µ":"μ","𝛍":"μ","𝜇":"μ","𝝁":"μ","𝝻":"μ","𝞵":"μ","𝛏":"ξ","𝜉":"ξ","𝝃":"ξ","𝝽":"ξ","𝞷":"ξ","𝚵":"Ξ","𝛯":"Ξ","𝜩":"Ξ","𝝣":"Ξ","𝞝":"Ξ","ϖ":"π","ℼ":"π","𝛑":"π","𝛡":"π","𝜋":"π","𝜛":"π","𝝅":"π","𝝕":"π","𝝿":"π","𝞏":"π","𝞹":"π","𝟉":"π","ᴨ":"π","п":"π","∏":"Π","ℿ":"Π","𝚷":"Π","𝛱":"Π","𝜫":"Π","𝝥":"Π","𝞟":"Π","Ⲡ":"Π","П":"Π","ꛛ":"Π","𐊭":"Ϙ","𐌒":"Ϙ","ϛ":"ς","𝛓":"ς","𝜍":"ς","𝝇":"ς","𝞁":"ς","𝞻":"ς","𝚽":"Φ","𝛷":"Φ","𝜱":"Φ","𝝫":"Φ","𝞥":"Φ","Ⲫ":"Φ","Ф":"Φ","Փ":"Φ","ቀ":"Φ","ᛰ":"Φ","𐊳":"Φ","ꭓ":"χ","ꭕ":"χ","𝛘":"χ","𝜒":"χ","𝝌":"χ","𝞆":"χ","𝟀":"χ","ⲭ":"χ","𝛙":"ψ","𝜓":"ψ","𝝍":"ψ","𝞇":"ψ","𝟁":"ψ","ѱ":"ψ","𐓹":"ψ","𝚿":"Ψ","𝛹":"Ψ","𝜳":"Ψ","𝝭":"Ψ","𝞧":"Ψ","Ⲯ":"Ψ","Ѱ":"Ψ","𐓑":"Ψ","ᛘ":"Ψ","𐊵":"Ψ","⍵":"ω","ꞷ":"ω","𝛚":"ω","𝜔":"ω","𝝎":"ω","𝞈":"ω","𝟂":"ω","ⲱ":"ω","ꙍ":"ω","Ω":"Ω","𝛀":"Ω","𝛺":"Ω","𝜴":"Ω","𝝮":"Ω","𝞨":"Ω","ᘯ":"Ω","ᘵ":"Ω","𐊶":"Ω","⍹":"ω̲","ώ":"ῴ","☰":"Ⲷ","Ⳝ":"Ϭ","җ":"ж̩","Җ":"Ж̩","𝈋":"И","Ͷ":"И","ꚡ":"И","𐐥":"И","Й":"Ѝ","Ҋ":"Ѝ̦","ѝ":"й","ҋ":"й̦","𐒼":"Ӄ","ᴫ":"л","ӆ":"л̦","ꭠ":"љ","𐓫":"ꙩ","ᷮ":"ⷬ","𐓍":"Ћ","𝈂":"Ӿ","𝈢":"Ѡ","Ꮗ":"Ѡ","ᗯ":"Ѡ","Ѽ":"Ѡ҆҇","ᣭ":"Ѡ·","Ꞷ":"Ꙍ","ӌ":"ҷ","Ӌ":"Ҷ","Ҿ":"Ҽ̨","ⲽ":"ш","Ⲽ":"Ш","Ꙑ":"Ъl","℈":"Э","🜁":"Ꙙ","𖼜":"Ꙙ","ꦒ":"ⰿ","և":"եւ","ኔ":"ձ","ﬔ":"մե","ﬕ":"մի","ﬗ":"մխ","ﬓ":"մն","∩":"Ո","⋂":"Ո","𝉅":"Ո","በ":"Ո","ᑎ":"Ո","ꓵ":"Ո","ᑚ":"Ո·","ᑨ":"Ո\'","ﬖ":"վն","₽":"Ք","˓":"ՙ","ʿ":"ՙ","ℵ":"א","ﬡ":"א","אָ":"אַ","אּ":"אַ","ﭏ":"אל","ℶ":"ב","ℷ":"ג","ℸ":"ד","ﬢ":"ד","ﬣ":"ה","יּ":"יִ","ﬤ":"כ","ﬥ":"ל","ﬦ":"ם","ﬠ":"ע","ﬧ":"ר","שׂ":"שׁ","שּ":"שׁ","שּׂ":"שּׁ","ﬨ":"ת","ﺀ":"ء","۽":"ء͈","ﺂ":"آ","ﺁ":"آ","ﭑ":"ٱ","ﭐ":"ٱ","𞸁":"ب","𞸡":"ب","𞹡":"ب","𞺁":"ب","𞺡":"ب","ﺑ":"ب","ﺒ":"ب","ﺐ":"ب","ﺏ":"ب","ݑ":"بۛ","ࢶ":"بۢ","ࢡ":"بٔ","ﲠ":"بo","ﳢ":"بo","ﲜ":"بج","ﰅ":"بج","ﲝ":"بح","ﰆ":"بح","ﷂ":"بحى","ﲞ":"بخ","ﰇ":"بخ","ﳒ":"بخ","ﱋ":"بخ","ﶞ":"بخى","ﱪ":"بر","ﱫ":"بز","ﲟ":"بم","ﳡ":"بم","ﱬ":"بم","ﰈ":"بم","ﱭ":"بن","ﱮ":"بى","ﰉ":"بى","ﱯ":"بى","ﰊ":"بى","ﭔ":"ٻ","ﭕ":"ٻ","ﭓ":"ٻ","ﭒ":"ٻ","ې":"ٻ","ﯦ":"ٻ","ﯧ":"ٻ","ﯥ":"ٻ","ﯤ":"ٻ","ﭜ":"ڀ","ﭝ":"ڀ","ﭛ":"ڀ","ﭚ":"ڀ","ࢩ":"ݔ","ݧ":"ݔ","⍥":"ة","ö":"ة","ﺔ":"ة","ﺓ":"ة","ۃ":"ة","𞸕":"ت","𞸵":"ت","𞹵":"ت","𞺕":"ت","𞺵":"ت","ﺗ":"ت","ﺘ":"ت","ﺖ":"ت","ﺕ":"ت","ﲥ":"تo","ﳤ":"تo","ﲡ":"تج","ﰋ":"تج","ﵐ":"تجم","ﶠ":"تجى","ﶟ":"تجى","ﲢ":"تح","ﰌ":"تح","ﵒ":"تحج","ﵑ":"تحج","ﵓ":"تحم","ﲣ":"تخ","ﰍ":"تخ","ﵔ":"تخم","ﶢ":"تخى","ﶡ":"تخى","ﱰ":"تر","ﱱ":"تز","ﲤ":"تم","ﳣ":"تم","ﱲ":"تم","ﰎ":"تم","ﵕ":"تمج","ﵖ":"تمح","ﵗ":"تمخ","ﶤ":"تمى","ﶣ":"تمى","ﱳ":"تن","ﱴ":"تى","ﰏ":"تى","ﱵ":"تى","ﰐ":"تى","ﭠ":"ٺ","ﭡ":"ٺ","ﭟ":"ٺ","ﭞ":"ٺ","ﭤ":"ٿ","ﭥ":"ٿ","ﭣ":"ٿ","ﭢ":"ٿ","𞸂":"ج","𞸢":"ج","𞹂":"ج","𞹢":"ج","𞺂":"ج","𞺢":"ج","ﺟ":"ج","ﺠ":"ج","ﺞ":"ج","ﺝ":"ج","ﲧ":"جح","ﰕ":"جح","ﶦ":"جحى","ﶾ":"جحى","ﷻ":"جل جلlلo","ﲨ":"جم","ﰖ":"جم","ﵙ":"جمح","ﵘ":"جمح","ﶧ":"جمى","ﶥ":"جمى","ﴝ":"جى","ﴁ":"جى","ﴞ":"جى","ﴂ":"جى","ﭸ":"ڃ","ﭹ":"ڃ","ﭷ":"ڃ","ﭶ":"ڃ","ﭴ":"ڄ","ﭵ":"ڄ","ﭳ":"ڄ","ﭲ":"ڄ","ﭼ":"چ","ﭽ":"چ","ﭻ":"چ","ﭺ":"چ","ﮀ":"ڇ","ﮁ":"ڇ","ﭿ":"ڇ","ﭾ":"ڇ","𞸇":"ح","𞸧":"ح","𞹇":"ح","𞹧":"ح","𞺇":"ح","𞺧":"ح","ﺣ":"ح","ﺤ":"ح","ﺢ":"ح","ﺡ":"ح","څ":"حۛ","ځ":"حٔ","ݲ":"حٔ","ﲩ":"حج","ﰗ":"حج","ﶿ":"حجى","ﲪ":"حم","ﰘ":"حم","ﵛ":"حمى","ﵚ":"حمى","ﴛ":"حى","ﳿ":"حى","ﴜ":"حى","ﴀ":"حى","𞸗":"خ","𞸷":"خ","𞹗":"خ","𞹷":"خ","𞺗":"خ","𞺷":"خ","ﺧ":"خ","ﺨ":"خ","ﺦ":"خ","ﺥ":"خ","ﲫ":"خج","ﰙ":"خج","ﰚ":"خح","ﲬ":"خم","ﰛ":"خم","ﴟ":"خى","ﴃ":"خى","ﴠ":"خى","ﴄ":"خى","𐋡":"د","𞸃":"د","𞺃":"د","𞺣":"د","ﺪ":"د","ﺩ":"د","ڈ":"دؕ","ﮉ":"دؕ","ﮈ":"دؕ","ڎ":"دۛ","ﮇ":"دۛ","ﮆ":"دۛ","ۮ":"د̂","ࢮ":"د̤̣","𞸘":"ذ","𞺘":"ذ","𞺸":"ذ","ﺬ":"ذ","ﺫ":"ذ","ﱛ":"ذٰ","ڋ":"ڊؕ","ﮅ":"ڌ","ﮄ":"ڌ","ﮃ":"ڍ","ﮂ":"ڍ","𞸓":"ر","𞺓":"ر","𞺳":"ر","ﺮ":"ر","ﺭ":"ر","ڑ":"رؕ","ﮍ":"رؕ","ﮌ":"رؕ","ژ":"رۛ","ﮋ":"رۛ","ﮊ":"رۛ","ڒ":"ر̆","ࢹ":"ر̆̇","ۯ":"ر̂","ݬ":"رٔ","ﱜ":"رٰ","ﷶ":"رسول","﷼":"رىlل","𞸆":"ز","𞺆":"ز","𞺦":"ز","ﺰ":"ز","ﺯ":"ز","ࢲ":"ز̂","ݱ":"ڗؕ","𞸎":"س","𞸮":"س","𞹎":"س","𞹮":"س","𞺎":"س","𞺮":"س","ﺳ":"س","ﺴ":"س","ﺲ":"س","ﺱ":"س","ش":"سۛ","𞸔":"سۛ","𞸴":"سۛ","𞹔":"سۛ","𞹴":"سۛ","𞺔":"سۛ","𞺴":"سۛ","ﺷ":"سۛ","ﺸ":"سۛ","ﺶ":"سۛ","ﺵ":"سۛ","ݾ":"س̂","ﴱ":"سo","ﳨ":"سo","ﴲ":"سۛo","ﳪ":"سۛo","ﲭ":"سج","ﴴ":"سج","ﰜ":"سج","ﴭ":"سۛج","ﴷ":"سۛج","ﴥ":"سۛج","ﴉ":"سۛج","ﵝ":"سجح","ﵞ":"سجى","ﵩ":"سۛجى","ﲮ":"سح","ﴵ":"سح","ﰝ":"سح","ﴮ":"سۛح","ﴸ":"سۛح","ﴦ":"سۛح","ﴊ":"سۛح","ﵜ":"سحج","ﵨ":"سۛحم","ﵧ":"سۛحم","ﶪ":"سۛحى","ﲯ":"سخ","ﴶ":"سخ","ﰞ":"سخ","ﴯ":"سۛخ","ﴹ":"سۛخ","ﴧ":"سۛخ","ﴋ":"سۛخ","ﶨ":"سخى","ﷆ":"سخى","ﴪ":"سر","ﴎ":"سر","ﴩ":"سۛر","ﴍ":"سۛر","ﲰ":"سم","ﳧ":"سم","ﰟ":"سم","ﴰ":"سۛم","ﳩ":"سۛم","ﴨ":"سۛم","ﴌ":"سۛم","ﵡ":"سمج","ﵠ":"سمح","ﵟ":"سمح","ﵫ":"سۛمخ","ﵪ":"سۛمخ","ﵣ":"سمم","ﵢ":"سمم","ﵭ":"سۛمم","ﵬ":"سۛمم","ﴗ":"سى","ﳻ":"سى","ﴘ":"سى","ﳼ":"سى","ﴙ":"سۛى","ﳽ":"سۛى","ﴚ":"سۛى","ﳾ":"سۛى","𐋲":"ص","𞸑":"ص","𞸱":"ص","𞹑":"ص","𞹱":"ص","𞺑":"ص","𞺱":"ص","ﺻ":"ص","ﺼ":"ص","ﺺ":"ص","ﺹ":"ص","ڞ":"صۛ","ࢯ":"ص̤̣","ﲱ":"صح","ﰠ":"صح","ﵥ":"صحح","ﵤ":"صحح","ﶩ":"صحى","ﲲ":"صخ","ﴫ":"صر","ﴏ":"صر","ﷵ":"صلعم","ﷹ":"صلى","ﷰ":"صلى","ﷺ":"صلى lللo علىo وسلم","ﲳ":"صم","ﰡ":"صم","ﷅ":"صمم","ﵦ":"صمم","ﴡ":"صى","ﴅ":"صى","ﴢ":"صى","ﴆ":"صى","𞸙":"ض","𞸹":"ض","𞹙":"ض","𞹹":"ض","𞺙":"ض","𞺹":"ض","ﺿ":"ض","ﻀ":"ض","ﺾ":"ض","ﺽ":"ض","ﲴ":"ضج","ﰢ":"ضج","ﲵ":"ضح","ﰣ":"ضح","ﵮ":"ضحى","ﶫ":"ضحى","ﲶ":"ضخ","ﰤ":"ضخ","ﵰ":"ضخم","ﵯ":"ضخم","ﴬ":"ضر","ﴐ":"ضر","ﲷ":"ضم","ﰥ":"ضم","ﴣ":"ضى","ﴇ":"ضى","ﴤ":"ضى","ﴈ":"ضى","𐋨":"ط","𞸈":"ط","𞹨":"ط","𞺈":"ط","𞺨":"ط","ﻃ":"ط","ﻄ":"ط","ﻂ":"ط","ﻁ":"ط","ڟ":"طۛ","ﲸ":"طح","ﰦ":"طح","ﴳ":"طم","ﴺ":"طم","ﰧ":"طم","ﵲ":"طمح","ﵱ":"طمح","ﵳ":"طمم","ﵴ":"طمى","ﴑ":"طى","ﳵ":"طى","ﴒ":"طى","ﳶ":"طى","𞸚":"ظ","𞹺":"ظ","𞺚":"ظ","𞺺":"ظ","ﻇ":"ظ","ﻈ":"ظ","ﻆ":"ظ","ﻅ":"ظ","ﲹ":"ظم","ﴻ":"ظم","ﰨ":"ظم","؏":"ع","𞸏":"ع","𞸯":"ع","𞹏":"ع","𞹯":"ع","𞺏":"ع","𞺯":"ع","ﻋ":"ع","ﻌ":"ع","ﻊ":"ع","ﻉ":"ع","ﲺ":"عج","ﰩ":"عج","ﷄ":"عجم","ﵵ":"عجم","ﷷ":"علىo","ﲻ":"عم","ﰪ":"عم","ﵷ":"عمم","ﵶ":"عمم","ﵸ":"عمى","ﶶ":"عمى","ﴓ":"عى","ﳷ":"عى","ﴔ":"عى","ﳸ":"عى","𞸛":"غ","𞸻":"غ","𞹛":"غ","𞹻":"غ","𞺛":"غ","𞺻":"غ","ﻏ":"غ","ﻐ":"غ","ﻎ":"غ","ﻍ":"غ","ﲼ":"غج","ﰫ":"غج","ﲽ":"غم","ﰬ":"غم","ﵹ":"غمم","ﵻ":"غمى","ﵺ":"غمى","ﴕ":"غى","ﳹ":"غى","ﴖ":"غى","ﳺ":"غى","𞸐":"ف","𞸰":"ف","𞹰":"ف","𞺐":"ف","𞺰":"ف","ﻓ":"ف","ﻔ":"ف","ﻒ":"ف","ﻑ":"ف","ڧ":"ف","ﲾ":"فج","ﰭ":"فج","ﲿ":"فح","ﰮ":"فح","ﳀ":"فخ","ﰯ":"فخ","ﵽ":"فخم","ﵼ":"فخم","ﳁ":"فم","ﰰ":"فم","ﷁ":"فمى","ﱼ":"فى","ﰱ":"فى","ﱽ":"فى","ﰲ":"فى","𞸞":"ڡ","𞹾":"ڡ","ࢻ":"ڡ","ٯ":"ڡ","𞸟":"ڡ","𞹟":"ڡ","ࢼ":"ڡ","ڤ":"ڡۛ","ﭬ":"ڡۛ","ﭭ":"ڡۛ","ﭫ":"ڡۛ","ﭪ":"ڡۛ","ڨ":"ڡۛ","ࢤ":"ڢۛ","ﭰ":"ڦ","ﭱ":"ڦ","ﭯ":"ڦ","ﭮ":"ڦ","𞸒":"ق","𞸲":"ق","𞹒":"ق","𞹲":"ق","𞺒":"ق","𞺲":"ق","ﻗ":"ق","ﻘ":"ق","ﻖ":"ق","ﻕ":"ق","ﳂ":"قح","ﰳ":"قح","ﷱ":"قلى","ﳃ":"قم","ﰴ":"قم","ﶴ":"قمح","ﵾ":"قمح","ﵿ":"قمم","ﶲ":"قمى","ﱾ":"قى","ﰵ":"قى","ﱿ":"قى","ﰶ":"قى","𞸊":"ك","𞸪":"ك","𞹪":"ك","ﻛ":"ك","ﻜ":"ك","ﻚ":"ك","ﻙ":"ك","ک":"ك","ﮐ":"ك","ﮑ":"ك","ﮏ":"ك","ﮎ":"ك","ڪ":"ك","ڭ":"كۛ","ﯕ":"كۛ","ﯖ":"كۛ","ﯔ":"كۛ","ﯓ":"كۛ","ݣ":"كۛ","ﲀ":"كl","ﰷ":"كl","ﳄ":"كج","ﰸ":"كج","ﳅ":"كح","ﰹ":"كح","ﳆ":"كخ","ﰺ":"كخ","ﳇ":"كل","ﳫ":"كل","ﲁ":"كل","ﰻ":"كل","ﳈ":"كم","ﳬ":"كم","ﲂ":"كم","ﰼ":"كم","ﷃ":"كمم","ﶻ":"كمم","ﶷ":"كمى","ﲃ":"كى","ﰽ":"كى","ﲄ":"كى","ﰾ":"كى","ݢ":"ڬ","ﮔ":"گ","ﮕ":"گ","ﮓ":"گ","ﮒ":"گ","ࢰ":"گ","ڴ":"گۛ","ﮜ":"ڱ","ﮝ":"ڱ","ﮛ":"ڱ","ﮚ":"ڱ","ﮘ":"ڳ","ﮙ":"ڳ","ﮗ":"ڳ","ﮖ":"ڳ","𞸋":"ل","𞸫":"ل","𞹋":"ل","𞺋":"ل","𞺫":"ل","ﻟ":"ل","ﻠ":"ل","ﻞ":"ل","ﻝ":"ل","ڷ":"لۛ","ڵ":"ل̆","ﻼ":"لl","ﻻ":"لl","ﻺ":"لlٕ","ﻹ":"لlٕ","ﻸ":"لlٴ","ﻷ":"لlٴ","ﳍ":"لo","ﻶ":"لآ","ﻵ":"لآ","ﳉ":"لج","ﰿ":"لج","ﶃ":"لجج","ﶄ":"لجج","ﶺ":"لجم","ﶼ":"لجم","ﶬ":"لجى","ﳊ":"لح","ﱀ":"لح","ﶵ":"لحم","ﶀ":"لحم","ﶂ":"لحى","ﶁ":"لحى","ﳋ":"لخ","ﱁ":"لخ","ﶆ":"لخم","ﶅ":"لخم","ﳌ":"لم","ﳭ":"لم","ﲅ":"لم","ﱂ":"لم","ﶈ":"لمح","ﶇ":"لمح","ﶭ":"لمى","ﲆ":"لى","ﱃ":"لى","ﲇ":"لى","ﱄ":"لى","𞸌":"م","𞸬":"م","𞹬":"م","𞺌":"م","𞺬":"م","ﻣ":"م","ﻤ":"م","ﻢ":"م","ﻡ":"م","ࢧ":"مۛ","۾":"م͈","ﲈ":"مl","ﳎ":"مج","ﱅ":"مج","ﶌ":"مجح","ﶒ":"مجخ","ﶍ":"مجم","ﷀ":"مجى","ﳏ":"مح","ﱆ":"مح","ﶉ":"محج","ﶊ":"محم","ﷴ":"محمد","ﶋ":"محى","ﳐ":"مخ","ﱇ":"مخ","ﶎ":"مخج","ﶏ":"مخم","ﶹ":"مخى","ﳑ":"مم","ﲉ":"مم","ﱈ":"مم","ﶱ":"ممى","ﱉ":"مى","ﱊ":"مى","𞸍":"ن","𞸭":"ن","𞹍":"ن","𞹭":"ن","𞺍":"ن","𞺭":"ن","ﻧ":"ن","ﻨ":"ن","ﻦ":"ن","ﻥ":"ن","ݨ":"نؕ","ݩ":"ن̆","ﳖ":"نo","ﳯ":"نo","ﶸ":"نجح","ﶽ":"نجح","ﶘ":"نجم","ﶗ":"نجم","ﶙ":"نجى","ﷇ":"نجى","ﳓ":"نح","ﱌ":"نح","ﶕ":"نحم","ﶖ":"نحى","ﶳ":"نحى","ﳔ":"نخ","ﱍ":"نخ","ﲊ":"نر","ﲋ":"نز","ﳕ":"نم","ﳮ":"نم","ﲌ":"نم","ﱎ":"نم","ﶛ":"نمى","ﶚ":"نمى","ﲍ":"نن","ﲎ":"نى","ﱏ":"نى","ﲏ":"نى","ﱐ":"نى","ۂ":"ۀ","ﮥ":"ۀ","ﮤ":"ۀ","𐋤":"و","𞸅":"و","𞺅":"و","𞺥":"و","ﻮ":"و","ﻭ":"و","ࢱ":"و","ۋ":"وۛ","ﯟ":"وۛ","ﯞ":"وۛ","ۇ":"و̓","ﯘ":"و̓","ﯗ":"و̓","ۆ":"و̆","ﯚ":"و̆","ﯙ":"و̆","ۉ":"و̂","ﯣ":"و̂","ﯢ":"و̂","ۈ":"وٰ","ﯜ":"وٰ","ﯛ":"وٰ","ؤ":"وٴ","ﺆ":"وٴ","ﺅ":"وٴ","ٶ":"وٴ","ٷ":"و̓ٴ","ﯝ":"و̓ٴ","ﷸ":"وسلم","ﯡ":"ۅ","ﯠ":"ۅ","ٮ":"ى","𞸜":"ى","𞹼":"ى","ں":"ى","𞸝":"ى","𞹝":"ى","ﮟ":"ى","ﮞ":"ى","ࢽ":"ى","ﯨ":"ى","ﯩ":"ى","ﻰ":"ى","ﻯ":"ى","ي":"ى","𞸉":"ى","𞸩":"ى","𞹉":"ى","𞹩":"ى","𞺉":"ى","𞺩":"ى","ﻳ":"ى","ﻴ":"ى","ﻲ":"ى","ﻱ":"ى","ی":"ى","ﯾ":"ى","ﯿ":"ى","ﯽ":"ى","ﯼ":"ى","ے":"ى","ﮯ":"ى","ﮮ":"ى","ٹ":"ىؕ","ﭨ":"ىؕ","ﭩ":"ىؕ","ﭧ":"ىؕ","ﭦ":"ىؕ","ڻ":"ىؕ","ﮢ":"ىؕ","ﮣ":"ىؕ","ﮡ":"ىؕ","ﮠ":"ىؕ","پ":"ىۛ","ﭘ":"ىۛ","ﭙ":"ىۛ","ﭗ":"ىۛ","ﭖ":"ىۛ","ث":"ىۛ","𞸖":"ىۛ","𞸶":"ىۛ","𞹶":"ىۛ","𞺖":"ىۛ","𞺶":"ىۛ","ﺛ":"ىۛ","ﺜ":"ىۛ","ﺚ":"ىۛ","ﺙ":"ىۛ","ڽ":"ىۛ","ۑ":"ىۛ","ؿ":"ىۛ","ࢷ":"ىۛۢ","ݖ":"ى̆","ێ":"ى̆","ࢺ":"ى̆̇","ؽ":"ى̂","ࢨ":"ىٔ","ﲐ":"ىٰ","ﱝ":"ىٰ","ﳞ":"ىo","ﳱ":"ىo","ﳦ":"ىۛo","ئ":"ىٴ","ﺋ":"ىٴ","ﺌ":"ىٴ","ﺊ":"ىٴ","ﺉ":"ىٴ","ٸ":"ىٴ","ﯫ":"ىٴl","ﯪ":"ىٴl","ﲛ":"ىٴo","ﳠ":"ىٴo","ﯭ":"ىٴo","ﯬ":"ىٴo","ﯸ":"ىٴٻ","ﯷ":"ىٴٻ","ﯶ":"ىٴٻ","ﲗ":"ىٴج","ﰀ":"ىٴج","ﲘ":"ىٴح","ﰁ":"ىٴح","ﲙ":"ىٴخ","ﱤ":"ىٴر","ﱥ":"ىٴز","ﲚ":"ىٴم","ﳟ":"ىٴم","ﱦ":"ىٴم","ﰂ":"ىٴم","ﱧ":"ىٴن","ﯯ":"ىٴو","ﯮ":"ىٴو","ﯱ":"ىٴو̓","ﯰ":"ىٴو̓","ﯳ":"ىٴو̆","ﯲ":"ىٴو̆","ﯵ":"ىٴوٰ","ﯴ":"ىٴوٰ","ﯻ":"ىٴى","ﯺ":"ىٴى","ﱨ":"ىٴى","ﯹ":"ىٴى","ﰃ":"ىٴى","ﱩ":"ىٴى","ﰄ":"ىٴى","ﳚ":"ىج","ﱕ":"ىج","ﰑ":"ىۛج","ﶯ":"ىجى","ﳛ":"ىح","ﱖ":"ىح","ﶮ":"ىحى","ﳜ":"ىخ","ﱗ":"ىخ","ﲑ":"ىر","ﱶ":"ىۛر","ﲒ":"ىز","ﱷ":"ىۛز","ﳝ":"ىم","ﳰ":"ىم","ﲓ":"ىم","ﱘ":"ىم","ﲦ":"ىۛم","ﳥ":"ىۛم","ﱸ":"ىۛم","ﰒ":"ىۛم","ﶝ":"ىمم","ﶜ":"ىمم","ﶰ":"ىمى","ﲔ":"ىن","ﱹ":"ىۛن","ﲕ":"ىى","ﱙ":"ىى","ﲖ":"ىى","ﱚ":"ىى","ﱺ":"ىۛى","ﰓ":"ىۛى","ﱻ":"ىۛى","ﰔ":"ىۛى","ﮱ":"ۓ","ﮰ":"ۓ","𐊸":"ⵀ","⁞":"ⵂ","⸽":"ⵂ","⦙":"ⵂ","︙":"ⵗ","⁝":"ⵗ","⋮":"ⵗ","Մ":"ሆ","Ռ":"ቡ","Ի":"ኮ","Պ":"ጣ","आ":"अा","ऒ":"अाॆ","ओ":"अाे","औ":"अाै","ऄ":"अॆ","ऑ":"अॉ","ऍ":"एॅ","ऎ":"एॆ","ऐ":"एे","ई":"र्इ","ઽ":"ऽ","𑇜":"ꣻ","𑇋":"ऺ","ુ":"ु","ૂ":"ू","ੋ":"ॆ","੍":"्","્":"्","আ":"অা","ৠ":"ঋৃ","ৡ":"ঋৃ","𑒒":"ঘ","𑒔":"চ","𑒖":"জ","𑒘":"ঞ","𑒙":"ট","𑒛":"ড","𑒪":"ণ","𑒞":"ত","𑒟":"থ","𑒠":"দ","𑒡":"ধ","𑒢":"ন","𑒣":"প","𑒩":"ব","𑒧":"ম","𑒨":"য","𑒫":"র","𑒝":"ল","𑒭":"ষ","𑒮":"স","𑓄":"ঽ","𑒰":"া","𑒱":"ি","𑒹":"ে","𑒼":"ো","𑒾":"ৌ","𑓂":"্","𑒽":"ৗ","ਉ":"ੳੁ","ਊ":"ੳੂ","ਆ":"ਅਾ","ਐ":"ਅੈ","ਔ":"ਅੌ","ਇ":"ੲਿ","ਈ":"ੲੀ","ਏ":"ੲੇ","આ":"અા","ઑ":"અાૅ","ઓ":"અાે","ઔ":"અાૈ","ઍ":"અૅ","એ":"અે","ઐ":"અૈ","ଆ":"ଅା","௮":"அ","ர":"ஈ","ா":"ஈ","௫":"ஈு","௨":"உ","ഉ":"உ","ஊ":"உள","ഊ":"உൗ","௭":"எ","௷":"எவ","ஜ":"ஐ","ജ":"ஐ","௧":"க","௪":"ச","௬":"சு","௲":"சூ","ഺ":"டி","ണ":"ண","௺":"நீ","௴":"மீ","௰":"ய","ഴ":"ழ","ௗ":"ள","ை":"ன","ശ":"ஶ","௸":"ஷ","ി":"ி","ീ":"ி","ொ":"ெஈ","ௌ":"ெள","ோ":"ேஈ","ಅ":"అ","ಆ":"ఆ","ಇ":"ఇ","ౠ":"ఋా","ౡ":"ఌా","ಒ":"ఒ","ఔ":"ఒౌ","ಔ":"ఒౌ","ఓ":"ఒౕ","ಓ":"ఒౕ","ಜ":"జ","ಞ":"ఞ","ఢ":"డ̣","ಣ":"ణ","థ":"ధּ","భ":"బ̣","ಯ":"య","ఠ":"రּ","ಱ":"ఱ","ಲ":"ల","ష":"వ̣","హ":"వా","మ":"వు","ూ":"ుా","ౄ":"ృా","ೡ":"ಌಾ","ഈ":"ഇൗ","ഐ":"എെ","ഓ":"ഒാ","ഔ":"ഒൗ","ൡ":"ഞ","൫":"ദ്ര","൹":"നു","ഌ":"നു","ങ":"നു","൯":"ന്","ൻ":"ന്","൬":"ന്ന","൚":"ന്മ","റ":"ര","൪":"ര്","ർ":"ര്","൮":"വ്ര","൶":"ഹ്മ","ൂ":"ു","ൃ":"ു","ൈ":"െെ","෪":"ජ","෫":"ද","𑐓":"𑐴𑑂𑐒","𑐙":"𑐴𑑂𑐘","𑐤":"𑐴𑑂𑐣","𑐪":"𑐴𑑂𑐩","𑐭":"𑐴𑑂𑐬","𑐯":"𑐴𑑂𑐮","𑗘":"𑖂","𑗙":"𑖂","𑗚":"𑖃","𑗛":"𑖄","𑗜":"𑖲","𑗝":"𑖳","ฃ":"ข","ด":"ค","ต":"ค","ม":"ฆ","ຈ":"จ","ซ":"ช","ฏ":"ฎ","ท":"ฑ","ບ":"บ","ປ":"ป","ຝ":"ฝ","ພ":"พ","ຟ":"ฟ","ฦ":"ภ","ຍ":"ย","។":"ฯ","ๅ":"า","ำ":"̊า","ិ":"ิ","ី":"ี","ឹ":"ึ","ឺ":"ื","ຸ":"ุ","ູ":"ู","แ":"เเ","ໜ":"ຫນ","ໝ":"ຫມ","ຳ":"̊າ","༂":"འུྂཿ","༃":"འུྂ༔","ཪ":"ར","ༀ":"ཨོཾ","ཷ":"ྲཱྀ","ཹ":"ླཱྀ","𑲲":"𑲪","ႁ":"ဂှ","က":"ဂာ","ၰ":"ဃှ","ၦ":"ပှ","ဟ":"ပာ","ၯ":"ပာှ","ၾ":"ၽှ","ဩ":"သြ","ဪ":"သြော်","႞":"ႃ̊","ឣ":"អ","᧐":"ᦞ","᧑":"ᦱ","᪀":"ᩅ","᪐":"ᩅ","꩓":"ꨁ","꩖":"ꨣ","᭒":"ᬍ","᭓":"ᬑ","᭘":"ᬨ","ꦣ":"ꦝ","ᢖ":"ᡜ","ᡕ":"ᠵ","ῶ":"Ꮿ","ᐍ":"ᐁ·","ᐫ":"ᐁᐠ","ᐑ":"ᐄ·","ᐓ":"ᐅ·","ᐭ":"ᐅᐠ","ᐕ":"ᐆ·","ᐘ":"ᐊ·","ᐮ":"ᐊᐠ","ᐚ":"ᐋ·","ᣝ":"ᐞᣟ","ᓑ":"ᐡ","ᕀ":"ᐩ","ᐿ":"ᐲ·","ᑃ":"ᐴ·","⍩":"ᐵ","ᑇ":"ᐹ·","ᑜ":"ᑏ·","⸧":"ᑐ","⊃":"ᑐ","ᑞ":"ᑐ·","ᑩ":"ᑐ\'","⟉":"ᑐ/","⫗":"ᑐᑕ","ᑠ":"ᑑ·","⸦":"ᑕ","⊂":"ᑕ","ᑢ":"ᑕ·","ᑪ":"ᑕ\'","ᑤ":"ᑖ·","ᑵ":"ᑫ·","ᒅ":"ᑫ\'","ᑹ":"ᑮ·","ᑽ":"ᑰ·","ᘃ":"ᒉ","ᒓ":"ᒉ·","ᒕ":"ᒋ·","ᒗ":"ᒌ·","ᒛ":"ᒎ·","ᘂ":"ᒐ","ᒝ":"ᒐ·","ᒟ":"ᒑ·","ᒭ":"ᒣ·","ᒱ":"ᒦ·","ᒳ":"ᒧ·","ᒵ":"ᒨ·","ᒹ":"ᒫ·","ᓊ":"ᓀ·","ᣇ":"ᓂ·","ᣉ":"ᓃ·","ᣋ":"ᓄ·","ᣍ":"ᓅ·","ᓌ":"ᓇ·","ᓎ":"ᓈ·","ᘄ":"ᓓ","ᓝ":"ᓓ·","ᓟ":"ᓕ·","ᓡ":"ᓖ·","ᓣ":"ᓗ·","ᓥ":"ᓘ·","ᘇ":"ᓚ","ᓧ":"ᓚ·","ᓩ":"ᓛ·","ᓷ":"ᓭ·","ᓹ":"ᓯ·","ᓻ":"ᓰ·","ᓽ":"ᓱ·","ᓿ":"ᓲ·","ᔁ":"ᓴ·","ᔃ":"ᓵ·","ᔌ":"ᔋ<","ᔎ":"ᔋb","ᔍ":"ᔋᑕ","ᔏ":"ᔋᒐ","ᔘ":"ᔐ·","ᔚ":"ᔑ·","ᔜ":"ᔒ·","ᔞ":"ᔓ·","ᔠ":"ᔔ·","ᔢ":"ᔕ·","ᔤ":"ᔖ·","ᔲ":"ᔨ·","ᔴ":"ᔩ·","ᔶ":"ᔪ·","ᔸ":"ᔫ·","ᔺ":"ᔭ·","ᔼ":"ᔮ·","ᘢ":"ᕃ","ᣠ":"ᕃ·","ᘣ":"ᕆ","ᘤ":"ᕊ","ᕏ":"ᕌ·","ᖃ":"ᕐb","ᖄ":"ᕐḃ","ᖁ":"ᕐd","ᕿ":"ᕐP","ᙯ":"ᕐᑫ","ᕾ":"ᕐᑬ","ᖀ":"ᕐᑮ","ᖂ":"ᕐᑰ","ᖅ":"ᕐᒃ","ᕜ":"ᕚ·","ᣣ":"ᕞ·","ᣤ":"ᕦ·","ᕩ":"ᕧ·","ᣥ":"ᕫ·","ᣨ":"ᖆ·","ᖑ":"ᖕJ","ᙰ":"ᖕᒉ","ᖎ":"ᖕᒊ","ᖏ":"ᖕᒋ","ᖐ":"ᖕᒌ","ᖒ":"ᖕᒎ","ᖓ":"ᖕᒐ","ᖔ":"ᖕᒑ","ᙳ":"ᖖJ","ᙱ":"ᖖᒋ","ᙲ":"ᖖᒌ","ᙴ":"ᖖᒎ","ᙵ":"ᖖᒐ","ᙶ":"ᖖᒑ","ᣪ":"ᖗ·","ᙷ":"ᖧ·","ᙸ":"ᖨ·","ᙹ":"ᖩ·","ᙺ":"ᖪ·","ᙻ":"ᖫ·","ᙼ":"ᖬ·","ᙽ":"ᖭ·","⪫":"ᗒ","⪪":"ᗕ","ꓷ":"ᗡ","ᣰ":"ᗴ·","ᣲ":"ᘛ·","ᶻ":"ᙆ","ꓭ":"ᙠ","ᶺ":"ᣔ","ᴾ":"ᣖ","ᣜ":"ᣟᐞ","ˡ":"ᣳ","ʳ":"ᣴ","ˢ":"ᣵ","ᣛ":"ᣵ","ꚰ":"ᚹ","ᛡ":"ᚼ","⍿":"ᚽ","ᛂ":"ᚽ","𝈿":"ᛋ","↑":"ᛏ","↿":"ᛐ","⥮":"ᛐ⇂","⥣":"ᛐᛚ","ⵣ":"ᛯ","↾":"ᛚ","⨡":"ᛚ","⋄":"ᛜ","◇":"ᛜ","◊":"ᛜ","♢":"ᛜ","🝔":"ᛜ","𑢷":"ᛜ","𐊔":"ᛜ","⍚":"ᛜ̲","⋈":"ᛞ","⨝":"ᛞ","𐓐":"ᛦ","↕":"ᛨ","𐳼":"𐲂","𐳺":"𐲥","ㄱ":"ᄀ","ᆨ":"ᄀ","ᄁ":"ᄀᄀ","ㄲ":"ᄀᄀ","ᆩ":"ᄀᄀ","ᇺ":"ᄀᄂ","ᅚ":"ᄀᄃ","ᇃ":"ᄀᄅ","ᇻ":"ᄀᄇ","ᆪ":"ᄀᄉ","ㄳ":"ᄀᄉ","ᇄ":"ᄀᄉᄀ","ᇼ":"ᄀᄎ","ᇽ":"ᄀᄏ","ᇾ":"ᄀᄒ","ㄴ":"ᄂ","ᆫ":"ᄂ","ᄓ":"ᄂᄀ","ᇅ":"ᄂᄀ","ᄔ":"ᄂᄂ","ㅥ":"ᄂᄂ","ᇿ":"ᄂᄂ","ᄕ":"ᄂᄃ","ㅦ":"ᄂᄃ","ᇆ":"ᄂᄃ","ퟋ":"ᄂᄅ","ᄖ":"ᄂᄇ","ᅛ":"ᄂᄉ","ᇇ":"ᄂᄉ","ㅧ":"ᄂᄉ","ᅜ":"ᄂᄌ","ᆬ":"ᄂᄌ","ㄵ":"ᄂᄌ","ퟌ":"ᄂᄎ","ᇉ":"ᄂᄐ","ᅝ":"ᄂᄒ","ᆭ":"ᄂᄒ","ㄶ":"ᄂᄒ","ᇈ":"ᄂᅀ","ㅨ":"ᄂᅀ","ㄷ":"ᄃ","ᆮ":"ᄃ","ᄗ":"ᄃᄀ","ᇊ":"ᄃᄀ","ᄄ":"ᄃᄃ","ㄸ":"ᄃᄃ","ퟍ":"ᄃᄃ","ퟎ":"ᄃᄃᄇ","ᅞ":"ᄃᄅ","ᇋ":"ᄃᄅ","ꥠ":"ᄃᄆ","ꥡ":"ᄃᄇ","ퟏ":"ᄃᄇ","ꥢ":"ᄃᄉ","ퟐ":"ᄃᄉ","ퟑ":"ᄃᄉᄀ","ꥣ":"ᄃᄌ","ퟒ":"ᄃᄌ","ퟓ":"ᄃᄎ","ퟔ":"ᄃᄐ","ㄹ":"ᄅ","ᆯ":"ᄅ","ꥤ":"ᄅᄀ","ᆰ":"ᄅᄀ","ㄺ":"ᄅᄀ","ꥥ":"ᄅᄀᄀ","ퟕ":"ᄅᄀᄀ","ᇌ":"ᄅᄀᄉ","ㅩ":"ᄅᄀᄉ","ퟖ":"ᄅᄀᄒ","ᄘ":"ᄅᄂ","ᇍ":"ᄅᄂ","ꥦ":"ᄅᄃ","ᇎ":"ᄅᄃ","ㅪ":"ᄅᄃ","ꥧ":"ᄅᄃᄃ","ᇏ":"ᄅᄃᄒ","ᄙ":"ᄅᄅ","ᇐ":"ᄅᄅ","ퟗ":"ᄅᄅᄏ","ꥨ":"ᄅᄆ","ᆱ":"ᄅᄆ","ㄻ":"ᄅᄆ","ᇑ":"ᄅᄆᄀ","ᇒ":"ᄅᄆᄉ","ퟘ":"ᄅᄆᄒ","ꥩ":"ᄅᄇ","ᆲ":"ᄅᄇ","ㄼ":"ᄅᄇ","ퟙ":"ᄅᄇᄃ","ꥪ":"ᄅᄇᄇ","ᇓ":"ᄅᄇᄉ","ㅫ":"ᄅᄇᄉ","ꥫ":"ᄅᄇᄋ","ᇕ":"ᄅᄇᄋ","ퟚ":"ᄅᄇᄑ","ᇔ":"ᄅᄇᄒ","ꥬ":"ᄅᄉ","ᆳ":"ᄅᄉ","ㄽ":"ᄅᄉ","ᇖ":"ᄅᄉᄉ","ᄛ":"ᄅᄋ","ퟝ":"ᄅᄋ","ꥭ":"ᄅᄌ","ꥮ":"ᄅᄏ","ᇘ":"ᄅᄏ","ᆴ":"ᄅᄐ","ㄾ":"ᄅᄐ","ᆵ":"ᄅᄑ","ㄿ":"ᄅᄑ","ᄚ":"ᄅᄒ","ㅀ":"ᄅᄒ","ᄻ":"ᄅᄒ","ᆶ":"ᄅᄒ","ퟲ":"ᄅᄒ","ᇗ":"ᄅᅀ","ㅬ":"ᄅᅀ","ퟛ":"ᄅᅌ","ᇙ":"ᄅᅙ","ㅭ":"ᄅᅙ","ퟜ":"ᄅᅙᄒ","ㅁ":"ᄆ","ᆷ":"ᄆ","ꥯ":"ᄆᄀ","ᇚ":"ᄆᄀ","ퟞ":"ᄆᄂ","ퟟ":"ᄆᄂᄂ","ꥰ":"ᄆᄃ","ᇛ":"ᄆᄅ","ퟠ":"ᄆᄆ","ᄜ":"ᄆᄇ","ㅮ":"ᄆᄇ","ᇜ":"ᄆᄇ","ퟡ":"ᄆᄇᄉ","ꥱ":"ᄆᄉ","ᇝ":"ᄆᄉ","ㅯ":"ᄆᄉ","ᇞ":"ᄆᄉᄉ","ᄝ":"ᄆᄋ","ㅱ":"ᄆᄋ","ᇢ":"ᄆᄋ","ퟢ":"ᄆᄌ","ᇠ":"ᄆᄎ","ᇡ":"ᄆᄒ","ᇟ":"ᄆᅀ","ㅰ":"ᄆᅀ","ㅂ":"ᄇ","ᆸ":"ᄇ","ᄞ":"ᄇᄀ","ㅲ":"ᄇᄀ","ᄟ":"ᄇᄂ","ᄠ":"ᄇᄃ","ㅳ":"ᄇᄃ","ퟣ":"ᄇᄃ","ᇣ":"ᄇᄅ","ퟤ":"ᄇᄅᄑ","ퟥ":"ᄇᄆ","ᄈ":"ᄇᄇ","ㅃ":"ᄇᄇ","ퟦ":"ᄇᄇ","ᄬ":"ᄇᄇᄋ","ㅹ":"ᄇᄇᄋ","ᄡ":"ᄇᄉ","ㅄ":"ᄇᄉ","ᆹ":"ᄇᄉ","ᄢ":"ᄇᄉᄀ","ㅴ":"ᄇᄉᄀ","ᄣ":"ᄇᄉᄃ","ㅵ":"ᄇᄉᄃ","ퟧ":"ᄇᄉᄃ","ᄤ":"ᄇᄉᄇ","ᄥ":"ᄇᄉᄉ","ᄦ":"ᄇᄉᄌ","ꥲ":"ᄇᄉᄐ","ᄫ":"ᄇᄋ","ㅸ":"ᄇᄋ","ᇦ":"ᄇᄋ","ᄧ":"ᄇᄌ","ㅶ":"ᄇᄌ","ퟨ":"ᄇᄌ","ᄨ":"ᄇᄎ","ퟩ":"ᄇᄎ","ꥳ":"ᄇᄏ","ᄩ":"ᄇᄐ","ㅷ":"ᄇᄐ","ᄪ":"ᄇᄑ","ᇤ":"ᄇᄑ","ꥴ":"ᄇᄒ","ᇥ":"ᄇᄒ","ㅅ":"ᄉ","ᆺ":"ᄉ","ᄭ":"ᄉᄀ","ㅺ":"ᄉᄀ","ᇧ":"ᄉᄀ","ᄮ":"ᄉᄂ","ㅻ":"ᄉᄂ","ᄯ":"ᄉᄃ","ㅼ":"ᄉᄃ","ᇨ":"ᄉᄃ","ᄰ":"ᄉᄅ","ᇩ":"ᄉᄅ","ᄱ":"ᄉᄆ","ퟪ":"ᄉᄆ","ᄲ":"ᄉᄇ","ㅽ":"ᄉᄇ","ᇪ":"ᄉᄇ","ᄳ":"ᄉᄇᄀ","ퟫ":"ᄉᄇᄋ","ᄊ":"ᄉᄉ","ㅆ":"ᄉᄉ","ᆻ":"ᄉᄉ","ퟬ":"ᄉᄉᄀ","ퟭ":"ᄉᄉᄃ","ꥵ":"ᄉᄉᄇ","ᄴ":"ᄉᄉᄉ","ᄵ":"ᄉᄋ","ᄶ":"ᄉᄌ","ㅾ":"ᄉᄌ","ퟯ":"ᄉᄌ","ᄷ":"ᄉᄎ","ퟰ":"ᄉᄎ","ᄸ":"ᄉᄏ","ᄹ":"ᄉᄐ","ퟱ":"ᄉᄐ","ᄺ":"ᄉᄑ","ퟮ":"ᄉᅀ","ㅇ":"ᄋ","ᆼ":"ᄋ","ᅁ":"ᄋᄀ","ᇬ":"ᄋᄀ","ᇭ":"ᄋᄀᄀ","ᅂ":"ᄋᄃ","ꥶ":"ᄋᄅ","ᅃ":"ᄋᄆ","ᅄ":"ᄋᄇ","ᅅ":"ᄋᄉ","ᇱ":"ᄋᄉ","ㆂ":"ᄋᄉ","ᅇ":"ᄋᄋ","ㆀ":"ᄋᄋ","ᇮ":"ᄋᄋ","ᅈ":"ᄋᄌ","ᅉ":"ᄋᄎ","ᇯ":"ᄋᄏ","ᅊ":"ᄋᄐ","ᅋ":"ᄋᄑ","ꥷ":"ᄋᄒ","ᅆ":"ᄋᅀ","ᇲ":"ᄋᅀ","ㆃ":"ᄋᅀ","ㅈ":"ᄌ","ᆽ":"ᄌ","ퟷ":"ᄌᄇ","ퟸ":"ᄌᄇᄇ","ᅍ":"ᄌᄋ","ᄍ":"ᄌᄌ","ㅉ":"ᄌᄌ","ퟹ":"ᄌᄌ","ꥸ":"ᄌᄌᄒ","ㅊ":"ᄎ","ᆾ":"ᄎ","ᅒ":"ᄎᄏ","ᅓ":"ᄎᄒ","ㅋ":"ᄏ","ᆿ":"ᄏ","ㅌ":"ᄐ","ᇀ":"ᄐ","ꥹ":"ᄐᄐ","ㅍ":"ᄑ","ᇁ":"ᄑ","ᅖ":"ᄑᄇ","ᇳ":"ᄑᄇ","ퟺ":"ᄑᄉ","ᅗ":"ᄑᄋ","ㆄ":"ᄑᄋ","ᇴ":"ᄑᄋ","ퟻ":"ᄑᄐ","ꥺ":"ᄑᄒ","ㅎ":"ᄒ","ᇂ":"ᄒ","ᇵ":"ᄒᄂ","ᇶ":"ᄒᄅ","ᇷ":"ᄒᄆ","ᇸ":"ᄒᄇ","ꥻ":"ᄒᄉ","ᅘ":"ᄒᄒ","ㆅ":"ᄒᄒ","ᄽ":"ᄼᄼ","ᄿ":"ᄾᄾ","ㅿ":"ᅀ","ᇫ":"ᅀ","ퟳ":"ᅀᄇ","ퟴ":"ᅀᄇᄋ","ㆁ":"ᅌ","ᇰ":"ᅌ","ퟵ":"ᅌᄆ","ퟶ":"ᅌᄒ","ᅏ":"ᅎᅎ","ᅑ":"ᅐᅐ","ㆆ":"ᅙ","ᇹ":"ᅙ","ꥼ":"ᅙᅙ","ㅤ":"ᅠ","ㅏ":"ᅡ","ᆣ":"ᅡー","ᅶ":"ᅡᅩ","ᅷ":"ᅡᅮ","ᅢ":"ᅡ丨","ㅐ":"ᅡ丨","ㅑ":"ᅣ","ᅸ":"ᅣᅩ","ᅹ":"ᅣᅭ","ᆤ":"ᅣᅮ","ᅤ":"ᅣ丨","ㅒ":"ᅣ丨","ㅓ":"ᅥ","ᅼ":"ᅥー","ᅺ":"ᅥᅩ","ᅻ":"ᅥᅮ","ᅦ":"ᅥ丨","ㅔ":"ᅥ丨","ㅕ":"ᅧ","ᆥ":"ᅧᅣ","ᅽ":"ᅧᅩ","ᅾ":"ᅧᅮ","ᅨ":"ᅧ丨","ㅖ":"ᅧ丨","ㅗ":"ᅩ","ᅪ":"ᅩᅡ","ㅘ":"ᅩᅡ","ᅫ":"ᅩᅡ丨","ㅙ":"ᅩᅡ丨","ᆦ":"ᅩᅣ","ᆧ":"ᅩᅣ丨","ᅿ":"ᅩᅥ","ᆀ":"ᅩᅥ丨","ힰ":"ᅩᅧ","ᆁ":"ᅩᅧ丨","ᆂ":"ᅩᅩ","ힱ":"ᅩᅩ丨","ᆃ":"ᅩᅮ","ᅬ":"ᅩ丨","ㅚ":"ᅩ丨","ㅛ":"ᅭ","ힲ":"ᅭᅡ","ힳ":"ᅭᅡ丨","ᆄ":"ᅭᅣ","ㆇ":"ᅭᅣ","ᆆ":"ᅭᅣ","ᆅ":"ᅭᅣ丨","ㆈ":"ᅭᅣ丨","ힴ":"ᅭᅥ","ᆇ":"ᅭᅩ","ᆈ":"ᅭ丨","ㆉ":"ᅭ丨","ㅜ":"ᅮ","ᆉ":"ᅮᅡ","ᆊ":"ᅮᅡ丨","ᅯ":"ᅮᅥ","ㅝ":"ᅮᅥ","ᆋ":"ᅮᅥー","ᅰ":"ᅮᅥ丨","ㅞ":"ᅮᅥ丨","ힵ":"ᅮᅧ","ᆌ":"ᅮᅧ丨","ᆍ":"ᅮᅮ","ᅱ":"ᅮ丨","ㅟ":"ᅮ丨","ힶ":"ᅮ丨丨","ㅠ":"ᅲ","ᆎ":"ᅲᅡ","ힷ":"ᅲᅡ丨","ᆏ":"ᅲᅥ","ᆐ":"ᅲᅥ丨","ᆑ":"ᅲᅧ","ㆊ":"ᅲᅧ","ᆒ":"ᅲᅧ丨","ㆋ":"ᅲᅧ丨","ힸ":"ᅲᅩ","ᆓ":"ᅲᅮ","ᆔ":"ᅲ丨","ㆌ":"ᅲ丨","ㆍ":"ᆞ","ퟅ":"ᆞᅡ","ᆟ":"ᆞᅥ","ퟆ":"ᆞᅥ丨","ᆠ":"ᆞᅮ","ᆢ":"ᆞᆞ","ᆡ":"ᆞ丨","ㆎ":"ᆞ丨","ヘ":"へ","⍁":"〼","⧄":"〼","꒞":"ꁊ","꒬":"ꁐ","꒜":"ꃀ","꒨":"ꄲ","꒿":"ꉙ","꒾":"ꊱ","꒔":"ꋍ","꓀":"ꎫ","꓂":"ꎵ","꒺":"ꎿ","꒰":"ꏂ","꒧":"ꑘ","⊥":"ꓕ","⟂":"ꓕ","𝈜":"ꓕ","Ʇ":"ꓕ","Ꞟ":"ꓤ","⅁":"ꓨ","⅂":"ꓶ","𝈕":"ꓶ","𝈫":"ꓶ","𖼦":"ꓶ","𐐑":"ꓶ","⅃":"𖼀","𑫦":"𑫥𑫯","𑫨":"𑫥𑫥","𑫩":"𑫥𑫥𑫯","𑫪":"𑫥𑫥𑫰","𑫧":"𑫥𑫰","𑫴":"𑫳𑫯","𑫶":"𑫳𑫳","𑫷":"𑫳𑫳𑫯","𑫸":"𑫳𑫳𑫰","𑫵":"𑫳𑫰","𑫬":"𑫫𑫯","𑫭":"𑫫𑫫","𑫮":"𑫫𑫫𑫯","⊕":"𐊨","⨁":"𐊨","🜨":"𐊨","Ꚛ":"𐊨","▽":"𐊼","𝈔":"𐊼","🜄":"𐊼","⧖":"𐋀","ꞛ":"𐐺","Ꞛ":"𐐒","𐒠":"𐒆","𐏑":"𐎂","𐏓":"𐎓","𒀸":"𐎚","☥":"𐦞","𓋹":"𐦞","〹":"卄","不":"不","丽":"丽","並":"並","⎜":"丨","⎟":"丨","⎢":"丨","⎥":"丨","⎪":"丨","⎮":"丨","㇑":"丨","ᅵ":"丨","ㅣ":"丨","⼁":"丨","ᆜ":"丨ー","ᆘ":"丨ᅡ","ᆙ":"丨ᅣ","ힽ":"丨ᅣᅩ","ힾ":"丨ᅣ丨","ힿ":"丨ᅧ","ퟀ":"丨ᅧ丨","ᆚ":"丨ᅩ","ퟁ":"丨ᅩ丨","ퟂ":"丨ᅭ","ᆛ":"丨ᅮ","ퟃ":"丨ᅲ","ᆝ":"丨ᆞ","ퟄ":"丨丨","串":"串","丸":"丸","丹":"丹","乁":"乁","㇠":"乙","⼄":"乙","㇟":"乚","⺃":"乚","㇖":"乛","⺂":"乛","⻲":"亀","亂":"亂","㇚":"亅","⼅":"亅","了":"了","ニ":"二","⼆":"二","𠄢":"𠄢","⼇":"亠","亮":"亮","⼈":"人","イ":"亻","⺅":"亻","什":"什","仌":"仌","令":"令","你":"你","倂":"併","倂":"併","侀":"侀","來":"來","例":"例","侮":"侮","侮":"侮","侻":"侻","便":"便","值":"値","倫":"倫","偺":"偺","備":"備","像":"像","僚":"僚","僧":"僧","僧":"僧","㒞":"㒞","⼉":"儿","兀":"兀","⺎":"兀","充":"充","免":"免","免":"免","兔":"兔","兤":"兤","⼊":"入","內":"內","全":"全","兩":"兩","ハ":"八","⼋":"八","六":"六","具":"具","𠔜":"𠔜","𠔥":"𠔥","冀":"冀","㒹":"㒹","⼌":"冂","再":"再","𠕋":"𠕋","冒":"冒","冕":"冕","㒻":"㒻","最":"最","⼍":"冖","冗":"冗","冤":"冤","⼎":"冫","冬":"冬","况":"况","况":"况","冷":"冷","凉":"凉","凌":"凌","凜":"凜","凞":"凞","⼏":"几","𠘺":"𠘺","凵":"凵","⼐":"凵","⼑":"刀","⺉":"刂","刃":"刃","切":"切","切":"切","列":"列","利":"利","㓟":"㓟","刺":"刺","刻":"刻","剆":"剆","割":"割","剷":"剷","劉":"劉","𠠄":"𠠄","カ":"力","力":"力","⼒":"力","劣":"劣","㔕":"㔕","劳":"劳","勇":"勇","勇":"勇","勉":"勉","勉":"勉","勒":"勒","勞":"勞","勤":"勤","勤":"勤","勵":"勵","⼓":"勹","勺":"勺","勺":"勺","包":"包","匆":"匆","𠣞":"𠣞","⼔":"匕","北":"北","北":"北","⼕":"匚","⼖":"匸","匿":"匿","⼗":"十","〸":"十","〺":"卅","卉":"卉","࿖":"卍","࿕":"卐","卑":"卑","卑":"卑","博":"博","ト":"卜","⼘":"卜","⼙":"卩","⺋":"㔾","即":"即","卵":"卵","卽":"卽","卿":"卿","卿":"卿","卿":"卿","⼚":"厂","𠨬":"𠨬","⼛":"厶","參":"參","⼜":"又","及":"及","叟":"叟","𠭣":"𠭣","ロ":"口","⼝":"口","囗":"口","⼞":"口","句":"句","叫":"叫","叱":"叱","吆":"吆","吏":"吏","吝":"吝","吸":"吸","呂":"呂","呈":"呈","周":"周","咞":"咞","咢":"咢","咽":"咽","䎛":"㖈","哶":"哶","唐":"唐","啓":"啓","啟":"啓","啕":"啕","啣":"啣","善":"善","善":"善","喇":"喇","喙":"喙","喙":"喙","喝":"喝","喝":"喝","喫":"喫","喳":"喳","嗀":"嗀","嗂":"嗂","嗢":"嗢","嘆":"嘆","嘆":"嘆","噑":"噑","噴":"噴","器":"器","囹":"囹","圖":"圖","圗":"圗","⼟":"土","士":"土","⼠":"土","型":"型","城":"城","㦳":"㘽","埴":"埴","堍":"堍","報":"報","堲":"堲","塀":"塀","塚":"塚","塚":"塚","塞":"塞","填":"塡","壿":"墫","墬":"墬","墳":"墳","壘":"壘","壟":"壟","𡓤":"𡓤","壮":"壮","売":"売","壷":"壷","⼡":"夂","夆":"夆","⼢":"夊","タ":"夕","⼣":"夕","多":"多","夢":"夢","⼤":"大","奄":"奄","奈":"奈","契":"契","奔":"奔","奢":"奢","女":"女","⼥":"女","𡚨":"𡚨","𡛪":"𡛪","姘":"姘","姬":"姬","娛":"娛","娧":"娧","婢":"婢","婦":"婦","嬀":"媯","㛮":"㛮","㛼":"㛼","媵":"媵","嬈":"嬈","嬨":"嬨","嬾":"嬾","嬾":"嬾","⼦":"子","⼧":"宀","宅":"宅","𡧈":"𡧈","寃":"寃","寘":"寘","寧":"寧","寧":"寧","寧":"寧","寮":"寮","寳":"寳","𡬘":"𡬘","⼨":"寸","寿":"寿","将":"将","⼩":"小","尢":"尢","⺐":"尢","⼪":"尢","⺏":"尣","㞁":"㞁","⼫":"尸","尿":"尿","屠":"屠","屢":"屢","層":"層","履":"履","屮":"屮","屮":"屮","⼬":"屮","𡴋":"𡴋","⼭":"山","峀":"峀","岍":"岍","𡷤":"𡷤","𡷦":"𡷦","崙":"崙","嵃":"嵃","嵐":"嵐","嵫":"嵫","嵮":"嵮","嵼":"嵼","嶲":"嶲","嶺":"嶺","⼮":"巛","巢":"巢","エ":"工","⼯":"工","⼰":"己","⺒":"巳","㠯":"㠯","巽":"巽","⼱":"巾","帲":"帡","帨":"帨","帽":"帽","幩":"幩","㡢":"㡢","𢆃":"𢆃","⼲":"干","年":"年","𢆟":"𢆟","⺓":"幺","⼳":"幺","⼴":"广","度":"度","㡼":"㡼","庰":"庰","庳":"庳","庶":"庶","廊":"廊","廊":"廊","廉":"廉","廒":"廒","廓":"廓","廙":"廙","廬":"廬","⼵":"廴","廾":"廾","⼶":"廾","𢌱":"𢌱","𢌱":"𢌱","弄":"弄","⼷":"弋","⼸":"弓","弢":"弢","弢":"弢","⼹":"彐","⺔":"彑","当":"当","㣇":"㣇","⼺":"彡","形":"形","彩":"彩","彫":"彫","⼻":"彳","律":"律","㣣":"㣣","徚":"徚","復":"復","徭":"徭","⼼":"心","⺖":"忄","⺗":"㣺","忍":"忍","志":"志","念":"念","忹":"忹","怒":"怒","怜":"怜","恵":"恵","㤜":"㤜","㤺":"㤺","悁":"悁","悔":"悔","悔":"悔","惇":"惇","惘":"惘","惡":"惡","𢛔":"𢛔","愈":"愈","慨":"慨","慄":"慄","慈":"慈","慌":"慌","慌":"慌","慎":"慎","慎":"慎","慠":"慠","慺":"慺","憎":"憎","憎":"憎","憎":"憎","憐":"憐","憤":"憤","憯":"憯","憲":"憲","𢡄":"𢡄","𢡊":"𢡊","懞":"懞","懲":"懲","懲":"懲","懲":"懲","懶":"懶","懶":"懶","戀":"戀","⼽":"戈","成":"成","戛":"戛","戮":"戮","戴":"戴","⼾":"戶","戸":"戶","⼿":"手","⺘":"扌","扝":"扝","抱":"抱","拉":"拉","拏":"拏","拓":"拓","拔":"拔","拼":"拼","拾":"拾","𢬌":"𢬌","挽":"挽","捐":"捐","捨":"捨","捻":"捻","掃":"掃","掠":"掠","掩":"掩","揄":"揄","揤":"揤","摒":"摒","𢯱":"𢯱","搜":"搜","搢":"搢","揅":"揅","摩":"摩","摷":"摷","摾":"摾","㨮":"㨮","搉":"㩁","撚":"撚","撝":"撝","擄":"擄","㩬":"㩬","⽀":"支","⽁":"攴","⺙":"攵","敏":"敏","敏":"敏","敖":"敖","敬":"敬","數":"數","𣀊":"𣀊","⽂":"文","⻫":"斉","⽃":"斗","料":"料","⽄":"斤","⽅":"方","旅":"旅","⽆":"无","⺛":"旡","既":"既","旣":"旣","⽇":"日","易":"易","曶":"㫚","㫤":"㫤","晉":"晉","晩":"晚","晴":"晴","晴":"晴","暑":"暑","暑":"暑","暈":"暈","㬈":"㬈","暜":"暜","暴":"暴","曆":"曆","㬙":"㬙","𣊸":"𣊸","⽈":"曰","更":"更","書":"書","⽉":"月","𣍟":"𣍟","肦":"朌","胐":"朏","胊":"朐","脁":"朓","胶":"㬵","朗":"朗","朗":"朗","朗":"朗","脧":"朘","望":"望","望":"望","幐":"㬺","䐠":"㬻","𣎓":"𣎓","膧":"朣","𣎜":"𣎜","⽊":"木","李":"李","杓":"杓","杖":"杖","杞":"杞","𣏃":"𣏃","柿":"杮","杻":"杻","枅":"枅","林":"林","㭉":"㭉","𣏕":"𣏕","柳":"柳","柺":"柺","栗":"栗","栟":"栟","桒":"桒","𣑭":"𣑭","梁":"梁","梅":"梅","梅":"梅","梎":"梎","梨":"梨","椔":"椔","楂":"楂","㮝":"㮝","㮝":"㮝","槩":"㮣","樧":"榝","榣":"榣","槪":"槪","樂":"樂","樂":"樂","樂":"樂","樓":"樓","𣚣":"𣚣","檨":"檨","櫓":"櫓","櫛":"櫛","欄":"欄","㰘":"㰘","⽋":"欠","次":"次","𣢧":"𣢧","歔":"歔","㱎":"㱎","⽌":"止","⻭":"歯","歲":"歲","歷":"歷","歹":"歹","⽍":"歹","⺞":"歺","殟":"殟","殮":"殮","⽎":"殳","殺":"殺","殺":"殺","殺":"殺","殻":"殻","𣪍":"𣪍","⽏":"毋","⺟":"母","𣫺":"𣫺","⽐":"比","⽑":"毛","⽒":"氏","⺠":"民","⽓":"气","⽔":"水","⺡":"氵","⺢":"氺","汎":"汎","汧":"汧","沈":"沈","沿":"沿","泌":"泌","泍":"泍","泥":"泥","𣲼":"𣲼","洛":"洛","洞":"洞","洴":"洴","派":"派","流":"流","流":"流","流":"流","洖":"洖","浩":"浩","浪":"浪","海":"海","海":"海","浸":"浸","涅":"涅","𣴞":"𣴞","淋":"淋","淚":"淚","淪":"淪","淹":"淹","渚":"渚","港":"港","湮":"湮","潙":"溈","滋":"滋","滋":"滋","溜":"溜","溺":"溺","滇":"滇","滑":"滑","滛":"滛","㴳":"㴳","漏":"漏","漢":"漢","漢":"漢","漣":"漣","𣻑":"𣻑","潮":"潮","𣽞":"𣽞","𣾎":"𣾎","濆":"濆","濫":"濫","濾":"濾","瀛":"瀛","瀞":"瀞","瀞":"瀞","瀹":"瀹","灊":"灊","㶖":"㶖","⽕":"火","⺣":"灬","灰":"灰","灷":"灷","災":"災","炙":"炙","炭":"炭","烈":"烈","烙":"烙","煮":"煮","煮":"煮","𤉣":"𤉣","煅":"煅","煉":"煉","𤋮":"𤋮","熜":"熜","燎":"燎","燐":"燐","𤎫":"𤎫","爐":"爐","爛":"爛","爨":"爨","⽖":"爪","爫":"爫","⺤":"爫","爵":"爵","爵":"爵","⽗":"父","⽘":"爻","⺦":"丬","⽙":"爿","⽚":"片","牐":"牐","⽛":"牙","𤘈":"𤘈","⽜":"牛","牢":"牢","犀":"犀","犕":"犕","⽝":"犬","⺨":"犭","犯":"犯","狀":"狀","𤜵":"𤜵","狼":"狼","猪":"猪","猪":"猪","𤠔":"𤠔","獵":"獵","獺":"獺","⽞":"玄","率":"率","率":"率","⽟":"玉","王":"王","㺬":"㺬","玥":"玥","玲":"玲","㺸":"㺸","㺸":"㺸","珞":"珞","琉":"琉","理":"理","琢":"琢","瑇":"瑇","瑜":"瑜","瑩":"瑩","瑱":"瑱","瑱":"瑱","璅":"璅","璉":"璉","璘":"璘","瓊":"瓊","⽠":"瓜","⽡":"瓦","㼛":"㼛","甆":"甆","⽢":"甘","⽣":"生","甤":"甤","⽤":"用","⽥":"田","画":"画","甾":"甾","𤰶":"𤰶","留":"留","略":"略","異":"異","異":"異","𤲒":"𤲒","⽦":"疋","⽧":"疒","痢":"痢","瘐":"瘐","瘟":"瘟","瘝":"瘝","療":"療","癩":"癩","⽨":"癶","⽩":"白","𤾡":"𤾡","𤾸":"𤾸","⽪":"皮","⽫":"皿","𥁄":"𥁄","㿼":"㿼","益":"益","益":"益","盛":"盛","盧":"盧","䀈":"䀈","⽬":"目","直":"直","直":"直","𥃲":"𥃲","𥃳":"𥃳","省":"省","䀘":"䀘","𥄙":"𥄙","眞":"眞","真":"真","真":"真","𥄳":"𥄳","着":"着","睊":"睊","睊":"睊","鿃":"䀹","䀹":"䀹","䀹":"䀹","晣":"䀿","䁆":"䁆","瞋":"瞋","𥉉":"𥉉","瞧":"瞧","⽭":"矛","⽮":"矢","⽯":"石","䂖":"䂖","𥐝":"𥐝","硏":"研","硎":"硎","硫":"硫","碌":"碌","碌":"碌","碑":"碑","磊":"磊","磌":"磌","磌":"磌","磻":"磻","䃣":"䃣","礪":"礪","⽰":"示","⺭":"礻","礼":"礼","社":"社","祈":"祈","祉":"祉","𥘦":"𥘦","祐":"祐","祖":"祖","祖":"祖","祝":"祝","神":"神","祥":"祥","視":"視","視":"視","祿":"祿","𥚚":"𥚚","禍":"禍","禎":"禎","福":"福","福":"福","𥛅":"𥛅","禮":"禮","⽱":"禸","⽲":"禾","秊":"秊","䄯":"䄯","秫":"秫","稜":"稜","穊":"穊","穀":"穀","穀":"穀","穏":"穏","⽳":"穴","突":"突","𥥼":"𥥼","窱":"窱","立":"立","⽴":"立","⻯":"竜","𥪧":"𥪧","𥪧":"𥪧","竮":"竮","⽵":"竹","笠":"笠","節":"節","節":"節","䈂":"䈂","𥮫":"𥮫","篆":"篆","䈧":"䈧","築":"築","𥲀":"𥲀","𥳐":"𥳐","簾":"簾","籠":"籠","⽶":"米","类":"类","粒":"粒","精":"精","糒":"糒","糖":"糖","糨":"糨","䊠":"䊠","糣":"糣","糧":"糧","⽷":"糸","⺯":"糹","𥾆":"𥾆","紀":"紀","紐":"紐","索":"索","累":"累","絶":"絕","絣":"絣","絛":"絛","綠":"綠","綾":"綾","緇":"緇","練":"練","練":"練","練":"練","縂":"縂","䌁":"䌁","縉":"縉","縷":"縷","繁":"繁","繅":"繅","𦇚":"𦇚","䌴":"䌴","⽸":"缶","𦈨":"𦈨","缾":"缾","𦉇":"𦉇","⽹":"网","⺫":"罒","⺲":"罒","⺱":"罓","䍙":"䍙","署":"署","𦋙":"𦋙","罹":"罹","罺":"罺","羅":"羅","𦌾":"𦌾","⽺":"羊","羕":"羕","羚":"羚","羽":"羽","⽻":"羽","翺":"翺","老":"老","⽼":"老","⺹":"耂","者":"者","者":"者","者":"者","⽽":"而","𦓚":"𦓚","⽾":"耒","𦔣":"𦔣","⽿":"耳","聆":"聆","聠":"聠","𦖨":"𦖨","聯":"聯","聰":"聰","聾":"聾","⾀":"聿","⺺":"肀","⾁":"肉","肋":"肋","肭":"肭","育":"育","䏕":"䏕","䏙":"䏙","腁":"胼","脃":"脃","脾":"脾","䐋":"䐋","朡":"朡","𦞧":"𦞧","𦞵":"𦞵","朦":"䑃","臘":"臘","⾂":"臣","臨":"臨","⾃":"自","臭":"臭","⾄":"至","⾅":"臼","舁":"舁","舁":"舁","舄":"舄","⾆":"舌","舘":"舘","⾇":"舛","⾈":"舟","䑫":"䑫","⾉":"艮","良":"良","⾊":"色","⾋":"艸","艹":"艹","艹":"艹","⺾":"艹","⺿":"艹","⻀":"艹","芋":"芋","芑":"芑","芝":"芝","花":"花","芳":"芳","芽":"芽","若":"若","若":"若","苦":"苦","𦬼":"𦬼","茶":"茶","荒":"荒","荣":"荣","茝":"茝","茣":"茣","莽":"莽","荓":"荓","菉":"菉","菊":"菊","菌":"菌","菜":"菜","菧":"菧","華":"華","菱":"菱","著":"著","著":"著","𦰶":"𦰶","莭":"莭","落":"落","葉":"葉","蔿":"蒍","𦳕":"𦳕","𦵫":"𦵫","蓮":"蓮","蓱":"蓱","蓳":"蓳","蓼":"蓼","蔖":"蔖","䔫":"䔫","蕤":"蕤","𦼬":"𦼬","藍":"藍","䕝":"䕝","𦾱":"𦾱","䕡":"䕡","藺":"藺","蘆":"蘆","䕫":"䕫","蘒":"蘒","蘭":"蘭","𧃒":"𧃒","虁":"蘷","蘿":"蘿","⾌":"虍","⻁":"虎","虐":"虐","虜":"虜","虜":"虜","虧":"虧","虩":"虩","⾍":"虫","蚩":"蚩","蚈":"蚈","蛢":"蛢","蜎":"蜎","蜨":"蜨","蝫":"蝫","蟡":"蟡","蝹":"蝹","蝹":"蝹","螆":"螆","䗗":"䗗","𧏊":"𧏊","螺":"螺","蠁":"蠁","䗹":"䗹","蠟":"蠟","⾎":"血","行":"行","⾏":"行","衠":"衠","衣":"衣","⾐":"衣","⻂":"衤","裂":"裂","𧙧":"𧙧","裏":"裏","裗":"裗","裞":"裞","裡":"裡","裸":"裸","裺":"裺","䘵":"䘵","褐":"褐","襁":"襁","襤":"襤","⾑":"襾","⻄":"西","⻃":"覀","覆":"覆","見":"見","⾒":"見","𧢮":"𧢮","⻅":"见","⾓":"角","⾔":"言","𧥦":"𧥦","詽":"訮","訞":"䚶","䚾":"䚾","䛇":"䛇","誠":"誠","說":"說","說":"說","調":"調","請":"請","諒":"諒","論":"論","諭":"諭","諭":"諭","諸":"諸","諸":"諸","諾":"諾","諾":"諾","謁":"謁","謁":"謁","謹":"謹","謹":"謹","識":"識","讀":"讀","讏":"讆","變":"變","變":"變","⻈":"讠","⾕":"谷","⾖":"豆","豈":"豈","豕":"豕","⾗":"豕","豣":"豜","⾘":"豸","𧲨":"𧲨","⾙":"貝","貫":"貫","賁":"賁","賂":"賂","賈":"賈","賓":"賓","贈":"贈","贈":"贈","贛":"贛","⻉":"贝","⾚":"赤","⾛":"走","起":"起","趆":"赿","𧻓":"𧻓","𧼯":"𧼯","⾜":"足","跋":"跋","趼":"趼","跺":"跥","路":"路","跰":"跰","躛":"躗","⾝":"身","車":"車","⾞":"車","軔":"軔","輧":"軿","輦":"輦","輪":"輪","輸":"輸","輸":"輸","輻":"輻","轢":"轢","⻋":"车","⾟":"辛","辞":"辞","辰":"辰","⾠":"辰","⾡":"辵","辶":"辶","⻌":"辶","⻍":"辶","巡":"巡","連":"連","逸":"逸","逸":"逸","遲":"遲","遼":"遼","𨗒":"𨗒","𨗭":"𨗭","邏":"邏","⾢":"邑","邔":"邔","郎":"郎","郞":"郎","郞":"郎","郱":"郱","都":"都","𨜮":"𨜮","鄑":"鄑","鄛":"鄛","⾣":"酉","酪":"酪","醙":"醙","醴":"醴","⾤":"釆","里":"里","⾥":"里","量":"量","金":"金","⾦":"金","鈴":"鈴","鈸":"鈸","鉶":"鉶","鋗":"鋗","鋘":"鋘","鉼":"鉼","錄":"錄","鍊":"鍊","鎮":"鎭","鏹":"鏹","鐕":"鐕","𨯺":"𨯺","⻐":"钅","⻑":"長","⾧":"長","⻒":"镸","⻓":"长","⾨":"門","開":"開","䦕":"䦕","閭":"閭","閷":"閷","𨵷":"𨵷","⻔":"门","⾩":"阜","⻏":"阝","⻖":"阝","阮":"阮","陋":"陋","降":"降","陵":"陵","陸":"陸","陼":"陼","隆":"隆","隣":"隣","䧦":"䧦","⾪":"隶","隷":"隷","隸":"隷","隸":"隷","⾫":"隹","雃":"雃","離":"離","難":"難","難":"難","⾬":"雨","零":"零","雷":"雷","霣":"霣","𩅅":"𩅅","露":"露","靈":"靈","⾭":"靑","⻘":"青","靖":"靖","靖":"靖","𩇟":"𩇟","⾮":"非","⾯":"面","𩈚":"𩈚","⾰":"革","䩮":"䩮","䩶":"䩶","⾱":"韋","韛":"韛","韠":"韠","⻙":"韦","⾲":"韭","𩐊":"𩐊","⾳":"音","響":"響","響":"響","⾴":"頁","䪲":"䪲","頋":"頋","頋":"頋","頋":"頋","領":"領","頩":"頩","𩒖":"𩒖","頻":"頻","頻":"頻","類":"類","⻚":"页","⾵":"風","𩖶":"𩖶","⻛":"风","⾶":"飛","⻜":"飞","⻝":"食","⾷":"食","⻟":"飠","飢":"飢","飯":"飯","飼":"飼","䬳":"䬳","館":"館","餩":"餩","⻠":"饣","⾸":"首","⾹":"香","馧":"馧","⾺":"馬","駂":"駂","駱":"駱","駾":"駾","驪":"驪","⻢":"马","⾻":"骨","䯎":"䯎","⾼":"高","⾽":"髟","𩬰":"𩬰","鬒":"鬒","鬒":"鬒","⾾":"鬥","⾿":"鬯","⿀":"鬲","⿁":"鬼","⻤":"鬼","⿂":"魚","魯":"魯","鱀":"鱀","鱗":"鱗","⻥":"鱼","⿃":"鳥","鳽":"鳽","䳎":"䳎","鵧":"鵧","䳭":"䳭","𪃎":"𪃎","鶴":"鶴","𪄅":"𪄅","䳸":"䳸","鷺":"鷺","𪈎":"𪈎","鸞":"鸞","鹃":"鹂","⿄":"鹵","鹿":"鹿","⿅":"鹿","𪊑":"𪊑","麗":"麗","麟":"麟","⿆":"麥","⻨":"麦","麻":"麻","⿇":"麻","𪎒":"𪎒","⿈":"黃","⻩":"黄","⿉":"黍","黎":"黎","䵖":"䵖","⿊":"黑","黒":"黑","墨":"墨","黹":"黹","⿋":"黹","⿌":"黽","鼅":"鼅","黾":"黾","⿍":"鼎","鼏":"鼏","⿎":"鼓","鼖":"鼖","⿏":"鼠","鼻":"鼻","⿐":"鼻","齃":"齃","⿑":"齊","⻬":"齐","⿒":"齒","𪘀":"𪘀","⻮":"齿","龍":"龍","⿓":"龍","龎":"龎","⻰":"龙","龜":"龜","龜":"龜","龜":"龜","⿔":"龜","⻳":"龟","⿕":"龠"}')},160:function(e,t,r){"use strict";r.d(t,{$3:function(){return v},$H:function(){return N},BH:function(){return W},BX:function(){return re},Bm:function(){return E},C4:function(){return Q},CE:function(){return f},CP:function(){return l},DY:function(){return B},Gv:function(){return _},J$:function(){return Z},Kg:function(){return b},MZ:function(){return i},Mp:function(){return c},NO:function(){return a},Oj:function(){return o},PT:function(){return M},Qd:function(){return k},Ro:function(){return j},SU:function(){return C},TF:function(){return u},Tg:function(){return x},Tn:function(){return S},Tr:function(){return H},We:function(){return V},X$:function(){return d},Y2:function(){return ee},ZH:function(){return U},Zf:function(){return R},bB:function(){return F},cy:function(){return p},gd:function(){return y},pD:function(){return n},rU:function(){return L},tE:function(){return s},u3:function(){return ne},vM:function(){return g},v_:function(){return oe},yI:function(){return A},yL:function(){return w},yQ:function(){return K}});r(4114),r(8111),r(2489),r(7588),r(1701),r(8237);
/**
* @vue/shared v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/
/*! #__NO_SIDE_EFFECTS__ */
function n(e){const t=Object.create(null);for(const r of e.split(","))t[r]=1;return e=>e in t}const i={},o=[],s=()=>{},a=()=>!1,c=e=>111===e.charCodeAt(0)&&110===e.charCodeAt(1)&&(e.charCodeAt(2)>122||e.charCodeAt(2)<97),l=e=>e.startsWith("onUpdate:"),d=Object.assign,u=(e,t)=>{const r=e.indexOf(t);r>-1&&e.splice(r,1)},h=Object.prototype.hasOwnProperty,v=(e,t)=>h.call(e,t),p=Array.isArray,f=e=>"[object Map]"===T(e),g=e=>"[object Set]"===T(e),m=e=>"[object Date]"===T(e),y=e=>"[object RegExp]"===T(e),S=e=>"function"===typeof e,b=e=>"string"===typeof e,E=e=>"symbol"===typeof e,_=e=>null!==e&&"object"===typeof e,w=e=>(_(e)||S(e))&&S(e.then)&&S(e.catch),I=Object.prototype.toString,T=e=>I.call(e),R=e=>T(e).slice(8,-1),k=e=>"[object Object]"===T(e),A=e=>b(e)&&"NaN"!==e&&"-"!==e[0]&&""+parseInt(e,10)===e,C=n(",key,ref,ref_for,ref_key,onVnodeBeforeMount,onVnodeMounted,onVnodeBeforeUpdate,onVnodeUpdated,onVnodeBeforeUnmount,onVnodeUnmounted"),O=e=>{const t=Object.create(null);return r=>{const n=t[r];return n||(t[r]=e(r))}},D=/-(\w)/g,M=O((e=>e.replace(D,((e,t)=>t?t.toUpperCase():"")))),P=/\B([A-Z])/g,x=O((e=>e.replace(P,"-$1").toLowerCase())),U=O((e=>e.charAt(0).toUpperCase()+e.slice(1))),L=O((e=>{const t=e?`on${U(e)}`:"";return t})),N=(e,t)=>!Object.is(e,t),B=(e,...t)=>{for(let r=0;r<e.length;r++)e[r](...t)},K=(e,t,r,n=!1)=>{Object.defineProperty(e,t,{configurable:!0,enumerable:!1,writable:n,value:r})},F=e=>{const t=parseFloat(e);return isNaN(t)?e:t},j=e=>{const t=b(e)?Number(e):NaN;return isNaN(t)?e:t};let q;const V=()=>q||(q="undefined"!==typeof globalThis?globalThis:"undefined"!==typeof self?self:"undefined"!==typeof window?window:"undefined"!==typeof r.g?r.g:{});const G="Infinity,undefined,NaN,isFinite,isNaN,parseFloat,parseInt,decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,Math,Number,Date,Array,Object,Boolean,String,RegExp,Map,Set,JSON,Intl,BigInt,console,Error,Symbol",W=n(G);function H(e){if(p(e)){const t={};for(let r=0;r<e.length;r++){const n=e[r],i=b(n)?Y(n):H(n);if(i)for(const e in i)t[e]=i[e]}return t}if(b(e)||_(e))return e}const $=/;(?![^(]*\))/g,J=/:([^]+)/,z=/\/\*[^]*?\*\//g;function Y(e){const t={};return e.replace(z,"").split($).forEach((e=>{if(e){const r=e.split(J);r.length>1&&(t[r[0].trim()]=r[1].trim())}})),t}function Q(e){let t="";if(b(e))t=e;else if(p(e))for(let r=0;r<e.length;r++){const n=Q(e[r]);n&&(t+=n+" ")}else if(_(e))for(const r in e)e[r]&&(t+=r+" ");return t.trim()}const X="itemscope,allowfullscreen,formnovalidate,ismap,nomodule,novalidate,readonly",Z=n(X);function ee(e){return!!e||""===e}function te(e,t){if(e.length!==t.length)return!1;let r=!0;for(let n=0;r&&n<e.length;n++)r=re(e[n],t[n]);return r}function re(e,t){if(e===t)return!0;let r=m(e),n=m(t);if(r||n)return!(!r||!n)&&e.getTime()===t.getTime();if(r=E(e),n=E(t),r||n)return e===t;if(r=p(e),n=p(t),r||n)return!(!r||!n)&&te(e,t);if(r=_(e),n=_(t),r||n){if(!r||!n)return!1;const i=Object.keys(e).length,o=Object.keys(t).length;if(i!==o)return!1;for(const r in e){const n=e.hasOwnProperty(r),i=t.hasOwnProperty(r);if(n&&!i||!n&&i||!re(e[r],t[r]))return!1}}return String(e)===String(t)}function ne(e,t){return e.findIndex((e=>re(e,t)))}const ie=e=>!(!e||!0!==e["__v_isRef"]),oe=e=>b(e)?e:null==e?"":p(e)||_(e)&&(e.toString===I||!S(e.toString))?ie(e)?oe(e.value):JSON.stringify(e,se,2):String(e),se=(e,t)=>ie(t)?se(e,t.value):f(t)?{[`Map(${t.size})`]:[...t.entries()].reduce(((e,[t,r],n)=>(e[ae(t,n)+" =>"]=r,e)),{})}:g(t)?{[`Set(${t.size})`]:[...t.values()].map((e=>ae(e)))}:E(t)?ae(t):!_(t)||p(t)||k(t)?t:String(t),ae=(e,t="")=>{var r;return E(e)?`Symbol(${null!=(r=e.description)?r:t})`:e}},283:function(e,t,r){"use strict";var n=r(9504),i=r(9039),o=r(4901),s=r(9297),a=r(3724),c=r(350).CONFIGURABLE,l=r(3706),d=r(1181),u=d.enforce,h=d.get,v=String,p=Object.defineProperty,f=n("".slice),g=n("".replace),m=n([].join),y=a&&!i((function(){return 8!==p((function(){}),"length",{value:8}).length})),S=String(String).split("String"),b=e.exports=function(e,t,r){"Symbol("===f(v(t),0,7)&&(t="["+g(v(t),/^Symbol\(([^)]*)\).*$/,"$1")+"]"),r&&r.getter&&(t="get "+t),r&&r.setter&&(t="set "+t),(!s(e,"name")||c&&e.name!==t)&&(a?p(e,"name",{value:t,configurable:!0}):e.name=t),y&&r&&s(r,"arity")&&e.length!==r.arity&&p(e,"length",{value:r.arity});try{r&&s(r,"constructor")&&r.constructor?a&&p(e,"prototype",{writable:!1}):e.prototype&&(e.prototype=void 0)}catch(i){}var n=u(e);return s(n,"source")||(n.source=m(S,"string"==typeof t?t:"")),e};Function.prototype.toString=b((function(){return o(this)&&h(this).source||l(this)}),"toString")},291:function(e,t,r){r(4114),r(8111),r(2489),r(7588),r(1701),r(8237);var n=function(e){return String(Number(e))===e?Number(e):e},i=function(e,t,r,i){if(i&&!r)t[i]=n(e[1]);else for(var o=0;o<r.length;o+=1)null!=e[o+1]&&(t[r[o]]=n(e[o+1]))},o=function(e,t,r){var n=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:n&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:n?t[e.name]:t;i(r.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},s=r(5555),a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},r=[],n=t;return e.split(/(\r\n|\r|\n)/).filter(a).forEach((function(e){var t=e[0],i=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),n=r[r.length-1]);for(var a=0;a<(s[t]||[]).length;a+=1){var c=s[t][a];if(c.reg.test(i))return o(c,n,i)}})),t.media=r,t};var c=function(e,t){var r=t.split(/=(.+)/,2);return 2===r.length?e[r[0]]=n(r[1]):1===r.length&&t.length>1&&(e[r[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(c,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],r=e.split(" ").map(n),i=0;i<r.length;i+=3)t.push({component:r[i],ip:r[i+1],port:r[i+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(c,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,r=!1;return"~"!==e[0]?t=n(e):(t=n(e.substring(1,e.length)),r=!0),{scid:t,paused:r}}))}))}},309:function(e,t,r){"use strict";r.d(t,{n:function(){return n.CrossSigningKey}});var n=r(4864)},350:function(e,t,r){"use strict";var n=r(3724),i=r(9297),o=Function.prototype,s=n&&Object.getOwnPropertyDescriptor,a=i(o,"name"),c=a&&"something"===function(){}.name,l=a&&(!n||n&&s(o,"name").configurable);e.exports={EXISTS:a,PROPER:c,CONFIGURABLE:l}},397:function(e,t,r){"use strict";var n=r(7751);e.exports=n("document","documentElement")},421:function(e){"use strict";e.exports={}},507:function(e,t,r){"use strict";var n=r(9565);e.exports=function(e,t,r){var i,o,s=r?e:e.iterator,a=e.next;while(!(i=n(a,s)).done)if(o=t(i.value),void 0!==o)return o}},616:function(e,t,r){"use strict";var n=r(9039);e.exports=!n((function(){var e=function(){}.bind();return"function"!=typeof e||e.hasOwnProperty("prototype")}))},650:function(e,t,r){"use strict";function n(e){if(!e)return!1;try{var t=new URL(e);return"http"===t.protocol||"https"===t.protocol}catch(r){if(r instanceof TypeError)return!1;throw r}}r(4603),r(7566),r(8721),Object.defineProperty(t,"__esModule",{value:!0}),t.isValidUrl=n},655:function(e,t,r){"use strict";var n=r(6955),i=String;e.exports=function(e){if("Symbol"===n(e))throw new TypeError("Cannot convert a Symbol value to a string");return i(e)}},679:function(e,t,r){"use strict";var n=r(1625),i=TypeError;e.exports=function(e,t){if(n(t,e))return e;throw new i("Incorrect invocation")}},698:function(e,t,r){"use strict";function n(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,i)}function i(e){return function(){var t=this,r=arguments;return new Promise((function(i,o){var s=e.apply(t,r);function a(e){n(s,i,o,a,c,"next",e)}function c(e){n(s,i,o,a,c,"throw",e)}a(void 0)}))}}r.d(t,{A:function(){return i}})},713:function(e,t,r){"use strict";var n=r(9565),i=r(9306),o=r(8551),s=r(1767),a=r(9462),c=r(6319),l=a((function(){var e=this.iterator,t=o(n(this.next,e)),r=this.done=!!t.done;if(!r)return c(e,this.mapper,[t.value,this.counter++],!0)}));e.exports=function(e){return o(this),i(e),new l(s(this),{mapper:e})}},741:function(e){"use strict";var t=Math.ceil,r=Math.floor;e.exports=Math.trunc||function(e){var n=+e;return(n>0?r:t)(n)}},757:function(e,t,r){"use strict";var n=r(7751),i=r(4901),o=r(1625),s=r(7040),a=Object;e.exports=s?function(e){return"symbol"==typeof e}:function(e){var t=n("Symbol");return i(t)&&o(t.prototype,a(e))}},806:function(e,t,r){"use strict";r.r(t),r.d(t,{getTextForLocationEvent:function(){return m},makeBeaconContent:function(){return I},makeBeaconInfoContent:function(){return _},makeEmoteMessage:function(){return g},makeHtmlEmote:function(){return v},makeHtmlMessage:function(){return u},makeHtmlNotice:function(){return h},makeLocationContent:function(){return y},makeNotice:function(){return f},makeTextMessage:function(){return p},makeTopicContent:function(){return b},parseBeaconContent:function(){return T},parseBeaconInfoContent:function(){return w},parseLocationEvent:function(){return S},parseTopicContent:function(){return E}});r(4114),r(8111),r(2489),r(116),r(7588);var n=r(4761),i=r(5629),o=r(7898),s=r(8105),a=r(9454),c=r(5677);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function u(e,t){return{msgtype:i.Wr.Text,format:"org.matrix.custom.html",body:e,formatted_body:t}}function h(e,t){return{msgtype:i.Wr.Notice,format:"org.matrix.custom.html",body:e,formatted_body:t}}function v(e,t){return{msgtype:i.Wr.Emote,format:"org.matrix.custom.html",body:e,formatted_body:t}}function p(e){return{msgtype:i.Wr.Text,body:e}}function f(e){return{msgtype:i.Wr.Notice,body:e}}function g(e){return{msgtype:i.Wr.Emote,body:e}}var m=(e,t,r,n)=>{var i="at ".concat(new Date(r).toISOString()),o=t===a.Yg.Self?"User":void 0,s=n?'"'.concat(n,'"'):void 0;return[o,"Location",s,e,i].filter(Boolean).join(" ")},y=(e,t,r,n,s)=>{var c=null!==e&&void 0!==e?e:m(t,s||a.Yg.Self,r,n),l=r?{[a.vo.name]:r}:{};return d({msgtype:i.Wr.Location,body:c,geo_uri:t,[a.M6.name]:{description:n,uri:t},[a.J1.name]:{type:s||a.Yg.Self},[o.yB.name]:c},l)},S=e=>{var t,r,n=a.M6.findIn(e),i=a.J1.findIn(e),s=a.vo.findIn(e),c=o.yB.findIn(e),l=null!==(t=null===n||void 0===n?void 0:n.uri)&&void 0!==t?t:null===e||void 0===e?void 0:e.geo_uri,d=null===n||void 0===n?void 0:n.description,u=null!==(r=null===i||void 0===i?void 0:i.type)&&void 0!==r?r:a.Yg.Self,h=null!==c&&void 0!==c?c:e.body;return y(h,l,null!==s&&void 0!==s?s:void 0,d,u)},b=(e,t)=>{var r=[];return(0,s.c)(e)&&r.push({body:e,mimetype:"text/plain"}),(0,s.c)(t)&&r.push({body:t,mimetype:"text/html"}),{topic:e,[c.s.name]:r}},E=e=>{var t,r,n,i,o,a=c.s.findIn(e);if(!Array.isArray(a))return{text:null!==(o=e.topic)&&void 0!==o?o:void 0};var l=null!==(t=null!==(r=null===a||void 0===a||null===(n=a.find((e=>!(0,s.c)(e.mimetype)||"text/plain"===e.mimetype)))||void 0===n?void 0:n.body)&&void 0!==r?r:e.topic)&&void 0!==t?t:void 0,d=null===a||void 0===a||null===(i=a.find((e=>"text/html"===e.mimetype)))||void 0===i?void 0:i.body;return{text:l,html:d}},_=(e,t,r,n,i)=>({description:r,timeout:e,live:t,[a.vo.name]:i||Date.now(),[a.J1.name]:{type:null!==n&&void 0!==n?n:a.Yg.Self}}),w=e=>{var t,{description:r,timeout:n,live:i}=e,o=null!==(t=a.vo.findIn(e))&&void 0!==t?t:void 0,s=a.J1.findIn(e);return{description:r,timeout:n,live:i,assetType:null===s||void 0===s?void 0:s.type,timestamp:o}},I=(e,t,r,n)=>({[a.M6.name]:{description:n,uri:e},[a.vo.name]:t,"m.relates_to":{rel_type:o.BJ.name,event_id:r}}),T=e=>{var t,r=a.M6.findIn(e),n=null!==(t=a.vo.findIn(e))&&void 0!==t?t:void 0;return{description:null===r||void 0===r?void 0:r.description,uri:null===r||void 0===r?void 0:r.uri,timestamp:n}}},812:function(e,t,r){"use strict";r.d(t,{_:function(){return h}});r(4114),r(8111),r(2489),r(7588),r(3579);var n=r(698),i=r(4761),o=r(3271),s=r(6170),a=r(5982);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function d(e,t){return encodeURIComponent(e)+"/"+encodeURIComponent(t)}function u(e){var t=e.split("/"),r=decodeURIComponent(t[0]),n=decodeURIComponent(t[1]);return{senderKey:r,sessionId:n}}class h{constructor(){(0,i.A)(this,"migrationState",a.Il.NOT_STARTED),(0,i.A)(this,"outgoingRoomKeyRequests",[]),(0,i.A)(this,"account",null),(0,i.A)(this,"crossSigningKeys",null),(0,i.A)(this,"privateKeys",{}),(0,i.A)(this,"sessions",{}),(0,i.A)(this,"sessionProblems",{}),(0,i.A)(this,"notifiedErrorDevices",{}),(0,i.A)(this,"inboundGroupSessions",{}),(0,i.A)(this,"inboundGroupSessionsWithheld",{}),(0,i.A)(this,"deviceData",null),(0,i.A)(this,"rooms",{}),(0,i.A)(this,"sessionsNeedingBackup",{}),(0,i.A)(this,"sharedHistoryInboundGroupSessions",{}),(0,i.A)(this,"parkedSharedHistory",new Map)}containsData(){var e=this;return(0,n.A)((function*(){return null!==e.account}))()}startup(){var e=this;return(0,n.A)((function*(){return e}))()}deleteAllData(){return Promise.resolve()}getMigrationState(){var e=this;return(0,n.A)((function*(){return e.migrationState}))()}setMigrationState(e){var t=this;return(0,n.A)((function*(){t.migrationState=e}))()}getOrAddOutgoingRoomKeyRequest(e){var t=e.requestBody;return(0,s.j0)((()=>{var r=this._getOutgoingRoomKeyRequest(t);return r?(o.v.log("already have key request outstanding for "+"".concat(t.room_id," / ").concat(t.session_id,": ")+"not sending another"),r):(o.v.log("enqueueing key request for ".concat(t.room_id," / ")+t.session_id),this.outgoingRoomKeyRequests.push(e),e)}))}getOutgoingRoomKeyRequest(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}_getOutgoingRoomKeyRequest(e){for(var t of this.outgoingRoomKeyRequests)if((0,s.ky)(t.requestBody,e))return t;return null}getOutgoingRoomKeyRequestByState(e){for(var t of this.outgoingRoomKeyRequests)for(var r of e)if(t.state===r)return Promise.resolve(t);return Promise.resolve(null)}getAllOutgoingRoomKeyRequestsByState(e){return Promise.resolve(this.outgoingRoomKeyRequests.filter((t=>t.state==e)))}getOutgoingRoomKeyRequestsByTarget(e,t,r){var n=[];for(var i of this.outgoingRoomKeyRequests)for(var o of r)i.state===o&&i.recipients.some((r=>r.userId===e&&r.deviceId===t))&&n.push(i);return Promise.resolve(n)}updateOutgoingRoomKeyRequest(e,t,r){for(var n of this.outgoingRoomKeyRequests)if(n.requestId===e)return n.state!==t?(o.v.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(n.state)),Promise.resolve(null)):(Object.assign(n,r),Promise.resolve(n));return Promise.resolve(null)}deleteOutgoingRoomKeyRequest(e,t){for(var r=0;r<this.outgoingRoomKeyRequests.length;r++){var n=this.outgoingRoomKeyRequests[r];if(n.requestId===e)return n.state!=t?(o.v.warn("Cannot delete room key request in state ".concat(n.state," ")+"(expected ".concat(t,")")),Promise.resolve(null)):(this.outgoingRoomKeyRequests.splice(r,1),Promise.resolve(n))}return Promise.resolve(null)}getAccount(e,t){t(this.account)}storeAccount(e,t){this.account=t}getCrossSigningKeys(e,t){t(this.crossSigningKeys)}getSecretStorePrivateKey(e,t,r){var n=this.privateKeys[r];t(n||null)}storeCrossSigningKeys(e,t){this.crossSigningKeys=t}storeSecretStorePrivateKey(e,t,r){this.privateKeys[t]=r}countEndToEndSessions(e,t){var r=0;for(var n of Object.values(this.sessions))r+=Object.keys(n).length;t(r)}getEndToEndSession(e,t,r,n){var i=this.sessions[e]||{};n(i[t]||null)}getEndToEndSessions(e,t,r){r(this.sessions[e]||{})}getAllEndToEndSessions(e,t){Object.entries(this.sessions).forEach((e=>{var[r,n]=e;Object.entries(n).forEach((e=>{var[n,i]=e;t(l(l({},i),{},{deviceKey:r,sessionId:n}))}))}))}storeEndToEndSession(e,t,r,n){var i=this.sessions[e];void 0===i&&(i={},this.sessions[e]=i),(0,s.C6)(i,t,r)}storeEndToEndSessionProblem(e,t,r){var i=this;return(0,n.A)((function*(){var n=i.sessionProblems[e]=i.sessionProblems[e]||[];n.push({type:t,fixed:r,time:Date.now()}),n.sort(((e,t)=>e.time-t.time))}))()}getEndToEndSessionProblem(e,t){var r=this;return(0,n.A)((function*(){var n=r.sessionProblems[e]||[];if(!n.length)return null;var i=n[n.length-1];for(var o of n)if(o.time>t)return Object.assign({},o,{fixed:i.fixed});return i.fixed?null:i}))()}filterOutNotifiedErrorDevices(e){var t=this;return(0,n.A)((function*(){var r=t.notifiedErrorDevices,n=[];for(var i of e){var{userId:o,deviceInfo:a}=i;o in r?a.deviceId in r[o]||(n.push(i),(0,s.C6)(r[o],a.deviceId,!0)):(n.push(i),(0,s.C6)(r,o,{[a.deviceId]:!0}))}return n}))()}getEndToEndSessionsBatch(){var e=this;return(0,n.A)((function*(){var t=[];for(var r of Object.values(e.sessions))for(var n of Object.values(r))if(t.push(n),t.length>=a.oT)return t;return 0===t.length?null:t}))()}deleteEndToEndSessionsBatch(e){var t=this;return(0,n.A)((function*(){for(var{deviceKey:r,sessionId:n}of e){var i=t.sessions[r]||{};delete i[n],0===Object.keys(i).length&&delete t.sessions[r]}}))()}getEndToEndInboundGroupSession(e,t,r,n){var i=d(e,t);n(this.inboundGroupSessions[i]||null,this.inboundGroupSessionsWithheld[i]||null)}getAllEndToEndInboundGroupSessions(e,t){for(var r of Object.keys(this.inboundGroupSessions))t(l(l({},u(r)),{},{sessionData:this.inboundGroupSessions[r]}));t(null)}addEndToEndInboundGroupSession(e,t,r,n){var i=d(e,t);void 0===this.inboundGroupSessions[i]&&(this.inboundGroupSessions[i]=r)}storeEndToEndInboundGroupSession(e,t,r,n){var i=d(e,t);this.inboundGroupSessions[i]=r}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){var i=d(e,t);this.inboundGroupSessionsWithheld[i]=r}countEndToEndInboundGroupSessions(){var e=this;return(0,n.A)((function*(){return Object.keys(e.inboundGroupSessions).length}))()}getEndToEndInboundGroupSessionsBatch(){var e=this;return(0,n.A)((function*(){var t=[];for(var[r,n]of Object.entries(e.inboundGroupSessions))if(t.push(l(l({},u(r)),{},{sessionData:n,needsBackup:r in e.sessionsNeedingBackup})),t.length>=a.oT)return t;return 0===t.length?null:t}))()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return(0,n.A)((function*(){for(var{senderKey:r,sessionId:n}of e){var i=d(r,n);delete t.inboundGroupSessions[i]}}))()}getEndToEndDeviceData(e,t){t(this.deviceData)}storeEndToEndDeviceData(e,t){this.deviceData=e}storeEndToEndRoom(e,t,r){this.rooms[e]=t}getEndToEndRooms(e,t){t(this.rooms)}getSessionsNeedingBackup(e){var t=[];for(var r in this.sessionsNeedingBackup)if(this.inboundGroupSessions[r]&&(t.push(l(l({},u(r)),{},{sessionData:this.inboundGroupSessions[r]})),e&&r.length>=e))break;return Promise.resolve(t)}countSessionsNeedingBackup(){return Promise.resolve(Object.keys(this.sessionsNeedingBackup).length)}unmarkSessionsNeedingBackup(e){for(var t of e){var r=d(t.senderKey,t.sessionId);delete this.sessionsNeedingBackup[r]}return Promise.resolve()}markSessionsNeedingBackup(e){for(var t of e){var r=d(t.senderKey,t.sessionId);this.sessionsNeedingBackup[r]=!0}return Promise.resolve()}addSharedHistoryInboundGroupSession(e,t,r){var n=this.sharedHistoryInboundGroupSessions[e]||[];n.push([t,r]),this.sharedHistoryInboundGroupSessions[e]=n}getSharedHistoryInboundGroupSessions(e){return Promise.resolve(this.sharedHistoryInboundGroupSessions[e]||[])}addParkedSharedHistory(e,t){var r,n=null!==(r=this.parkedSharedHistory.get(e))&&void 0!==r?r:[];n.push(t),this.parkedSharedHistory.set(e,n)}takeParkedSharedHistory(e){var t,r=null!==(t=this.parkedSharedHistory.get(e))&&void 0!==t?t:[];return this.parkedSharedHistory.delete(e),Promise.resolve(r)}doTxn(e,t,r){return Promise.resolve(r(null))}}},851:function(e,t,r){"use strict";var n=r(6955),i=r(5966),o=r(4117),s=r(6269),a=r(8227),c=a("iterator");e.exports=function(e){if(!o(e))return i(e,c)||i(e,"@@iterator")||s[n(e)]}},944:function(e,t,r){"use strict";r.d(t,{A4:function(){return s},PP:function(){return o},WG:function(){return i},y4:function(){return c}});r(6573),r(8100),r(7936),r(8111),r(8237),r(7467),r(4732),r(9577),r(4979);function n(e,t){if("function"===typeof e.toBase64)return e.toBase64(t);var r=btoa(e.reduce(((e,t)=>e+String.fromCharCode(t)),""));return t.omitPadding&&(r=r.replace(/={1,2}$/,"")),"base64url"===t.alphabet&&(r=r.replace(/\+/g,"-").replace(/\//g,"_")),r}function i(e){return n(e,{alphabet:"base64",omitPadding:!1})}function o(e){return n(e,{alphabet:"base64",omitPadding:!0})}function s(e){return n(e,{alphabet:"base64url",omitPadding:!0})}function a(e,t){return"function"===typeof Uint8Array.fromBase64?Uint8Array.fromBase64(e,t):Uint8Array.from(atob(e),(e=>e.charCodeAt(0)))}function c(e){return a(e.replace(/-/g,"+").replace(/_/g,"/"),{alphabet:"base64",lastChunkHandling:"loose"})}},972:function(e,t,r){"use strict";r.d(t,{HF:function(){return d},JH:function(){return a},M9:function(){return l},ai:function(){return c}});r(8111),r(2489);var n=r(4761),i=r(806),o=r(6170),s=r(2668),a=function(e){return e["New"]="Beacon.new",e["Update"]="Beacon.update",e["LivenessChange"]="Beacon.LivenessChange",e["Destroy"]="Beacon.Destroy",e["LocationUpdate"]="Beacon.LocationUpdate",e}({}),c=(e,t,r)=>r>=e&&e+t>=r,l=e=>"".concat(e.getRoomId(),"_").concat(e.getStateKey());class d extends s.X{constructor(e){super(),this.rootEvent=e,(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"_beaconInfo",void 0),(0,n.A)(this,"_isLive",void 0),(0,n.A)(this,"livenessWatchTimeout",void 0),(0,n.A)(this,"_latestLocationEvent",void 0),(0,n.A)(this,"clearLatestLocation",(()=>{this._latestLocationEvent=void 0,this.emit(a.LocationUpdate,this.latestLocationState)})),this.roomId=this.rootEvent.getRoomId(),this.setBeaconInfo(this.rootEvent)}get isLive(){return!!this._isLive}get identifier(){return l(this.rootEvent)}get beaconInfoId(){return this.rootEvent.getId()}get beaconInfoOwner(){return this.rootEvent.getStateKey()}get beaconInfoEventType(){return this.rootEvent.getType()}get beaconInfo(){return this._beaconInfo}get latestLocationState(){return this._latestLocationEvent&&(0,i.parseBeaconContent)(this._latestLocationEvent.getContent())}get latestLocationEvent(){return this._latestLocationEvent}update(e){if(l(e)!==this.identifier)throw new Error("Invalid updating event");e.getTs()<this.rootEvent.getTs()||(this.rootEvent=e,this.setBeaconInfo(this.rootEvent),this.emit(a.Update,e,this),this.clearLatestLocation())}destroy(){this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this._isLive=!1,this.emit(a.Destroy,this.identifier)}monitorLiveness(){if(this.livenessWatchTimeout&&clearTimeout(this.livenessWatchTimeout),this.checkLiveness(),this.beaconInfo)if(this.isLive){var e=this.beaconInfo.timestamp+this.beaconInfo.timeout-Date.now();e>1&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),e))}else this.beaconInfo.timestamp>Date.now()&&(this.livenessWatchTimeout=setTimeout((()=>{this.monitorLiveness()}),this.beaconInfo.timestamp-Date.now()))}addLocations(e){var t;if(this.isLive){var r=e.filter((e=>{var t=e.getContent(),r=(0,i.parseBeaconContent)(t);if(!r.uri||!r.timestamp)return!1;var{timestamp:n}=r;return this._beaconInfo.timestamp&&c(this._beaconInfo.timestamp,this._beaconInfo.timeout,n)&&(!this.latestLocationState||n>this.latestLocationState.timestamp)})),n=null===(t=r.sort(o.Fq))||void 0===t?void 0:t[0];n&&(this._latestLocationEvent=n,this.emit(a.LocationUpdate,this.latestLocationState))}}setBeaconInfo(e){this._beaconInfo=(0,i.parseBeaconInfoContent)(e.getContent()),this.checkLiveness()}checkLiveness(){var e=this.isLive;if(this.beaconInfo){var t=this.beaconInfo.timestamp>Date.now()?this.beaconInfo.timestamp-36e4:this.beaconInfo.timestamp;this._isLive=!!this._beaconInfo.live&&!!t&&c(t,this._beaconInfo.timeout,Date.now()),e!==this.isLive&&this.emit(a.LivenessChange,this.isLive,this)}}}},1009:function(e,t,r){"use strict";r.d(t,{L:function(){return l},d:function(){return c}});r(4114),r(8111),r(2489);var n=r(698),i=r(4761),o=r(2668),s=r(4768),a=r(3271),c=function(e){return e["LocalStreamsChanged"]="local_streams_changed",e}({});class l extends o.X{constructor(e){super(),this.client=e,(0,i.A)(this,"audioInput",void 0),(0,i.A)(this,"audioSettings",void 0),(0,i.A)(this,"videoInput",void 0),(0,i.A)(this,"localUserMediaStream",void 0),(0,i.A)(this,"userMediaStreams",[]),(0,i.A)(this,"screensharingStreams",[]),(0,i.A)(this,"getMediaStreamPromise",void 0)}restoreMediaSettings(e,t){this.audioInput=e,this.videoInput=t}setAudioInput(e){var t=this;return(0,n.A)((function*(){a.v.info("MediaHandler setAudioInput() running (deviceId=".concat(e,")")),t.audioInput!==e&&(t.audioInput=e,yield t.updateLocalUsermediaStreams())}))()}setAudioSettings(e){var t=this;return(0,n.A)((function*(){a.v.info("MediaHandler setAudioSettings() running (opts=".concat(JSON.stringify(e),")")),t.audioSettings=Object.assign({},e),yield t.updateLocalUsermediaStreams()}))()}setVideoInput(e){var t=this;return(0,n.A)((function*(){a.v.info("MediaHandler setVideoInput() running (deviceId=".concat(e,")")),t.videoInput!==e&&(t.videoInput=e,yield t.updateLocalUsermediaStreams())}))()}setMediaInputs(e,t){var r=this;return(0,n.A)((function*(){a.v.log("MediaHandler setMediaInputs() running (audioInput: ".concat(e," videoInput: ").concat(t,")")),r.audioInput=e,r.videoInput=t,yield r.updateLocalUsermediaStreams()}))()}updateLocalUsermediaStreams(){var e=this;return(0,n.A)((function*(){if(0!==e.userMediaStreams.length){var t=new Map;for(var r of e.client.callEventHandler.calls.values())t.set(r.callId,{audio:r.hasLocalUserMediaAudioTrack,video:r.hasLocalUserMediaVideoTrack});for(var n of e.userMediaStreams)for(var i of(a.v.log("MediaHandler updateLocalUsermediaStreams() stopping all tracks (streamId=".concat(n.id,")")),n.getTracks()))i.stop();for(var o of(e.userMediaStreams=[],e.localUserMediaStream=void 0,e.client.callEventHandler.calls.values()))if(!o.callHasEnded()&&t.has(o.callId)){var{audio:l,video:d}=t.get(o.callId);a.v.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (callId=".concat(o.callId,")"));var u=yield e.getUserMediaStream(l,d);o.callHasEnded()||(yield o.updateLocalUsermediaStream(u))}for(var h of e.client.groupCallEventHandler.groupCalls.values())if(h.localCallFeed){a.v.log("MediaHandler updateLocalUsermediaStreams() calling getUserMediaStream() (groupCallId=".concat(h.groupCallId,")"));var v=yield e.getUserMediaStream(!0,h.type===s.Ad.Video);h.state!==s.F_.Ended&&(yield h.updateLocalUsermediaStream(v))}e.emit(c.LocalStreamsChanged)}}))()}hasAudioDevice(){return(0,n.A)((function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter((e=>"audioinput"===e.kind)).length>0}catch(t){return a.v.log("MediaHandler hasAudioDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}}))()}hasVideoDevice(){return(0,n.A)((function*(){try{var e=yield navigator.mediaDevices.enumerateDevices();return e.filter((e=>"videoinput"===e.kind)).length>0}catch(t){return a.v.log("MediaHandler hasVideoDevice() calling navigator.mediaDevices.enumerateDevices with error",t),!1}}))()}getUserMediaStream(e,t){var r=arguments,i=this;return(0,n.A)((function*(){var n=!(r.length>2&&void 0!==r[2])||r[2];return i.getMediaStreamPromise?i.getMediaStreamPromise=i.getMediaStreamPromise.then((()=>i.getUserMediaStreamInternal(e,t,n))):i.getMediaStreamPromise=i.getUserMediaStreamInternal(e,t,n),i.getMediaStreamPromise}))()}getUserMediaStreamInternal(e,t,r){var i=this;return(0,n.A)((function*(){var n,o,s,l=e&&(yield i.hasAudioDevice()),d=t&&(yield i.hasVideoDevice()),u=!0;i.localUserMediaStream?(l!==i.localUserMediaStream.getAudioTracks().length>0&&(u=!1),d!==i.localUserMediaStream.getVideoTracks().length>0&&(u=!1),l&&(null===(o=i.localUserMediaStream.getAudioTracks()[0])||void 0===o||null===(o=o.getSettings())||void 0===o?void 0:o.deviceId)!==i.audioInput&&(u=!1),d&&(null===(s=i.localUserMediaStream.getVideoTracks()[0])||void 0===s||null===(s=s.getSettings())||void 0===s?void 0:s.deviceId)!==i.videoInput&&(u=!1)):u=!1;if(u){var h;if(n=i.localUserMediaStream.clone(),a.v.log("MediaHandler getUserMediaStreamInternal() cloning (oldStreamId=".concat(null===(h=i.localUserMediaStream)||void 0===h?void 0:h.id," newStreamId=").concat(n.id," shouldRequestAudio=").concat(l," shouldRequestVideo=").concat(d,")")),!l)for(var v of n.getAudioTracks())n.removeTrack(v);if(!d)for(var p of n.getVideoTracks())n.removeTrack(p)}else{var f=i.getUserMediaContraints(l,d);for(var g of(n=yield navigator.mediaDevices.getUserMedia(f),a.v.log("MediaHandler getUserMediaStreamInternal() calling getUserMediaStream (streamId=".concat(n.id,", shouldRequestAudio=").concat(l,", shouldRequestVideo=").concat(d,", constraints=").concat(JSON.stringify(f),")")),n.getTracks())){var m=g.getSettings();"audio"===g.kind?i.audioInput=m.deviceId:"video"===g.kind&&(i.videoInput=m.deviceId)}r&&(i.localUserMediaStream=n)}return r&&i.userMediaStreams.push(n),i.emit(c.LocalStreamsChanged),n}))()}stopUserMediaStream(e){for(var t of(a.v.log("MediaHandler stopUserMediaStream() stopping (streamId=".concat(e.id,")")),e.getTracks()))t.stop();var r=this.userMediaStreams.indexOf(e);if(-1!==r&&(a.v.debug("MediaHandler stopUserMediaStream() splicing usermedia stream out stream array (streamId=".concat(e.id,")"),e.id),this.userMediaStreams.splice(r,1)),this.emit(c.LocalStreamsChanged),this.localUserMediaStream===e)this.localUserMediaStream=void 0;else for(var n of e.getTracks()){var i;if(null!==(i=this.localUserMediaStream)&&void 0!==i&&i.getTrackById(n.id)){this.stopUserMediaStream(this.localUserMediaStream);break}}}getScreensharingStream(){var e=arguments,t=this;return(0,n.A)((function*(){var r,n=e.length>0&&void 0!==e[0]?e[0]:{},i=!(e.length>1&&void 0!==e[1])||e[1];if(0===t.screensharingStreams.length){var o=t.getScreenshareContraints(n);n.desktopCapturerSourceId?(a.v.debug("MediaHandler getScreensharingStream() calling getUserMedia() (opts=".concat(JSON.stringify(n),")")),r=yield navigator.mediaDevices.getUserMedia(o)):(a.v.debug("MediaHandler getScreensharingStream() calling getDisplayMedia() (opts=".concat(JSON.stringify(n),")")),r=yield navigator.mediaDevices.getDisplayMedia(o))}else{var s=t.screensharingStreams[t.screensharingStreams.length-1];a.v.log("MediaHandler getScreensharingStream() cloning (streamId=".concat(s.id,")")),r=s.clone()}return i&&t.screensharingStreams.push(r),t.emit(c.LocalStreamsChanged),r}))()}stopScreensharingStream(e){for(var t of(a.v.debug("MediaHandler stopScreensharingStream() stopping stream (streamId=".concat(e.id,")")),e.getTracks()))t.stop();var r=this.screensharingStreams.indexOf(e);-1!==r&&(a.v.debug("MediaHandler stopScreensharingStream() splicing stream out (streamId=".concat(e.id,")")),this.screensharingStreams.splice(r,1)),this.emit(c.LocalStreamsChanged)}stopAllStreams(){for(var e of this.userMediaStreams)for(var t of(a.v.log("MediaHandler stopAllStreams() stopping (streamId=".concat(e.id,")")),e.getTracks()))t.stop();for(var r of this.screensharingStreams)for(var n of r.getTracks())n.stop();this.userMediaStreams=[],this.screensharingStreams=[],this.localUserMediaStream=void 0,this.emit(c.LocalStreamsChanged)}getUserMediaContraints(e,t){var r=!!navigator.webkitGetUserMedia;return{audio:!!e&&{deviceId:this.audioInput?{ideal:this.audioInput}:void 0,autoGainControl:this.audioSettings?{ideal:this.audioSettings.autoGainControl}:void 0,echoCancellation:this.audioSettings?{ideal:this.audioSettings.echoCancellation}:void 0,noiseSuppression:this.audioSettings?{ideal:this.audioSettings.noiseSuppression}:void 0},video:!!t&&{deviceId:this.videoInput?{ideal:this.videoInput}:void 0,width:r?{exact:640}:{ideal:640},height:r?{exact:360}:{ideal:360}}}}getScreenshareContraints(e){var{desktopCapturerSourceId:t,audio:r}=e;return t?{audio:null!==r&&void 0!==r&&r,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t}}}:{audio:null!==r&&void 0!==r&&r,video:!0}}}},1072:function(e,t,r){"use strict";var n=r(1828),i=r(8727);e.exports=Object.keys||function(e){return n(e,i)}},1108:function(e,t,r){"use strict";var n=r(6955);e.exports=function(e){var t=n(e);return"BigInt64Array"===t||"BigUint64Array"===t}},1148:function(e,t,r){"use strict";var n=r(6518),i=r(2652),o=r(9306),s=r(8551),a=r(1767);n({target:"Iterator",proto:!0,real:!0},{every:function(e){s(this),o(e);var t=a(this),r=0;return!i(t,(function(t,n){if(!e(t,r++))return n()}),{IS_RECORD:!0,INTERRUPTED:!0}).stopped}})},1169:function(e,t){"use strict";t.A=(e,t)=>{const r=e.__vccOpts||e;for(const[n,i]of t)r[n]=i;return r}},1181:function(e,t,r){"use strict";var n,i,o,s=r(8622),a=r(4576),c=r(34),l=r(6699),d=r(9297),u=r(7629),h=r(6119),v=r(421),p="Object already initialized",f=a.TypeError,g=a.WeakMap,m=function(e){return o(e)?i(e):n(e,{})},y=function(e){return function(t){var r;if(!c(t)||(r=i(t)).type!==e)throw new f("Incompatible receiver, "+e+" required");return r}};if(s||u.state){var S=u.state||(u.state=new g);S.get=S.get,S.has=S.has,S.set=S.set,n=function(e,t){if(S.has(e))throw new f(p);return t.facade=e,S.set(e,t),t},i=function(e){return S.get(e)||{}},o=function(e){return S.has(e)}}else{var b=h("state");v[b]=!0,n=function(e,t){if(d(e,b))throw new f(p);return t.facade=e,l(e,b,t),t},i=function(e){return d(e,b)?e[b]:{}},o=function(e){return d(e,b)}}e.exports={set:n,get:i,has:o,enforce:m,getterFor:y}},1212:function(e,t,r){"use strict";r.d(t,{Bn:function(){return O},Fe:function(){return D},IU:function(){return C},Lm:function(){return T},M:function(){return P},w_:function(){return M}});r(4114),r(8111),r(2489),r(116),r(7588),r(1701),r(8237);var n=r(698),i=r(4761),o=r(1423),s=r(8965),a=r(6170),c=r(6483),l=r(2292),d=r(3271),u=r(4108),h=r(9683),v=r(5629),p=r(4123),f=r(8058),g=r(972),m=r(7430),y=r(9381),S=r(3877);function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function E(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var _=!0,w=8e4,I=3,T=function(e){return e["Error"]="ERROR",e["Prepared"]="PREPARED",e["Stopped"]="STOPPED",e["Syncing"]="SYNCING",e["Catchup"]="CATCHUP",e["Reconnecting"]="RECONNECTING",e}({}),R=["org.matrix.msc2716v3"];function k(e,t){return"FILTER_SYNC_".concat(e)+(t?"_"+t:"")}function A(){_&&d.v.log(...arguments)}var C=function(e){return e["Offline"]="offline",e["Online"]="online",e["Unavailable"]="unavailable",e}({});function O(e){return E({initialSyncLimit:8,resolveInvitesToProfiles:!1,pollTimeout:3e4,pendingEventOrdering:u.eO.Chronological,threadSupport:!1},e)}function D(e){return E({canResetEntireTimeline:e=>!1},e)}class M{constructor(e,t,r){var o=this;this.client=e,(0,i.A)(this,"opts",void 0),(0,i.A)(this,"syncOpts",void 0),(0,i.A)(this,"_peekRoom",null),(0,i.A)(this,"currentSyncRequest",void 0),(0,i.A)(this,"abortController",void 0),(0,i.A)(this,"syncState",null),(0,i.A)(this,"syncStateData",void 0),(0,i.A)(this,"catchingUp",!1),(0,i.A)(this,"running",!1),(0,i.A)(this,"keepAliveTimer",void 0),(0,i.A)(this,"connectionReturnedDefer",void 0),(0,i.A)(this,"notifEvents",[]),(0,i.A)(this,"failedSyncCount",0),(0,i.A)(this,"storeIsInvalid",!1),(0,i.A)(this,"presence",void 0),(0,i.A)(this,"getPushRules",(0,n.A)((function*(){try{A("Getting push rules...");var e=yield o.client.getPushRules();A("Got push rules"),o.client.pushRules=e}catch(t){if(d.v.error("Getting push rules failed",t),o.shouldAbortSync(t))return;return A("Waiting for saved sync before retrying push rules..."),yield o.recoverFromSyncStartupError(o.savedSyncPromise,t),o.getPushRules()}}))),(0,i.A)(this,"buildDefaultFilter",(()=>{var e=new c.d(this.client.credentials.userId);return this.client.canSupport.get(y.Xj.ThreadUnreadNotifications)!==y.Tj.Unsupported&&e.setUnreadThreadNotifications(!0),e})),(0,i.A)(this,"prepareLazyLoadingForSync",(0,n.A)((function*(){var e;(A("Prepare lazy loading for sync..."),o.client.isGuest()&&(o.opts.lazyLoadMembers=!1),o.opts.lazyLoadMembers&&(A("Enabling lazy load on sync filter..."),o.opts.filter||(o.opts.filter=o.buildDefaultFilter()),o.opts.filter.setLazyLoadMembers(!0)),o.opts.lazyLoadMembers)&&(null===(e=o.syncOpts.crypto)||void 0===e||e.enableLazyLoading())}))),(0,i.A)(this,"storeClientOptions",(0,n.A)((function*(){try{A("Storing client options..."),yield o.client.storeClientOptions(),A("Stored client options")}catch(e){throw d.v.error("Storing client options failed",e),e}}))),(0,i.A)(this,"getFilter",(0,n.A)((function*(){var e,t;A("Getting filter..."),e=o.opts.filter?o.opts.filter:o.buildDefaultFilter();try{t=yield o.client.getOrCreateFilter(k(o.client.credentials.userId),e)}catch(r){return d.v.error("Getting filter failed",r),o.shouldAbortSync(r)?{}:(A("Waiting for saved sync before retrying filter..."),yield o.recoverFromSyncStartupError(o.savedSyncPromise,r),o.getFilter())}return{filter:e,filterId:t}}))),(0,i.A)(this,"savedSyncPromise",void 0),(0,i.A)(this,"onOnline",(()=>{A("Browser thinks we are back online"),this.startKeepAlives(0)})),this.opts=O(t),this.syncOpts=D(r),e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),[s.u9.Timeline,s.u9.TimelineReset])}createRoom(e){var t=P(this.client,e,this.opts);return t.on(p.f.Marker,((e,r)=>{this.onMarkerStateEvent(t,e,r)})),t}onMarkerStateEvent(e,t){var{timelineWasEmpty:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(r)d.v.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," ")+"because the timeline was empty before the marker arrived which means there is nothing to refresh.");else{var n=R.includes(e.getVersion())||t.getSender()===e.getCreator();n?(d.v.debug("MarkerState: Timeline needs to be refreshed because "+"a new markerEventId=".concat(t.getId()," was sent in roomId=").concat(e.roomId)),e.setTimelineNeedsRefresh(!0),e.emit(s.u9.HistoryImportedWithinTimeline,t,e)):d.v.debug("MarkerState: Ignoring markerEventId=".concat(t.getId()," in roomId=").concat(e.roomId," because ")+"MSC2716 is not supported in the room version or for any room version, the marker wasn't sent by the room creator.")}}syncLeftRooms(){var e=this;return(0,n.A)((function*(){var t,r=e.client,i=new c.d(e.client.credentials.userId);i.setTimelineLimit(1),i.setIncludeLeaveRooms(!0);var o=e.opts.pollTimeout+w,s=yield r.getOrCreateFilter(k(r.credentials.userId,"LEFT_ROOMS"),i),a={timeout:0,filter:s,"org.matrix.msc4222.use_state_after":!0},d=yield r.http.authedRequest(h.IT.Get,"/sync",a,void 0,{localTimeoutMs:o}),v=[];null!==(t=d.rooms)&&void 0!==t&&t.leave&&(v=e.mapSyncResponseToRoomArray(d.rooms.leave));var p=yield Promise.all(v.map(function(){var t=(0,n.A)((function*(t){var n=t.room;if(t.isBrandNewRoom){t.timeline=t.timeline||{prev_batch:null,events:[]},n.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.q.BACKWARDS);var{timelineEvents:i}=yield e.mapAndInjectRoomEvents(t);return n.recalculate(),r.store.storeRoom(n),r.emit(u.AU.Room,n),e.processEventsForNotifs(n,i),n}}));return function(e){return t.apply(this,arguments)}}()));return p.filter(Boolean)}))()}peek(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;if((null===(t=this._peekRoom)||void 0===t?void 0:t.roomId)===e)return Promise.resolve(this._peekRoom);var n=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,r).then((t=>{var r;if((null===(r=this._peekRoom)||void 0===r?void 0:r.roomId)!==e)throw new Error("Peeking aborted");t.messages=t.messages||{chunk:[]},t.messages.chunk=t.messages.chunk||[],t.state=t.state||[];var i=(0,a.A4)(t.state).map(n.getEventMapper()),s=t.state.map(n.getEventMapper()),c=t.messages.chunk.map(n.getEventMapper());return Array.isArray(t.presence)&&t.presence.map(n.getEventMapper()).forEach((function(e){var t=n.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=o.K.createUser(e.getContent().user_id,n),t.setPresenceEvent(e),n.store.storeUser(t)),n.emit(u.AU.Event,e)})),t.messages.start&&(this._peekRoom.oldState.paginationToken=t.messages.start),this._peekRoom.oldState.setStateEvents(i),this._peekRoom.currentState.setStateEvents(s),this.resolveInvites(this._peekRoom),this._peekRoom.recalculate(),this._peekRoom.addEventsToTimeline(c.reverse(),!0,!0,this._peekRoom.getLiveTimeline(),t.messages.start),n.store.storeRoom(this._peekRoom),n.emit(u.AU.Room,this._peekRoom),this.peekPoll(this._peekRoom),this._peekRoom}))}stopPeeking(){this._peekRoom=null}peekPoll(e,t){var r,i=this;this._peekRoom===e?this.client.http.authedRequest(h.IT.Get,"/events",{room_id:e.roomId,timeout:String(3e4),from:t},void 0,{localTimeoutMs:5e4,abortSignal:null===(r=this.abortController)||void 0===r?void 0:r.signal}).then(function(){var t=(0,n.A)((function*(t){if(i._peekRoom===e){t.chunk.filter((function(e){return"m.presence"===e.type})).map(i.client.getEventMapper()).forEach((e=>{var t=i.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):(t=o.K.createUser(e.getContent().user_id,i.client),t.setPresenceEvent(e),i.client.store.storeUser(t)),i.client.emit(u.AU.Event,e)}));var r=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(i.client.getEventMapper());yield e.addLiveEvents(r,{addToState:!0}),i.peekPoll(e,t.end)}else A("Stopped peeking in room %s",e.roomId)}));return function(e){return t.apply(this,arguments)}}(),(r=>{d.v.error("[%s] Peek poll failed: %s",e.roomId,r),setTimeout((()=>{this.peekPoll(e,t)}),3e4)})):A("Stopped peeking in room %s",e.roomId)}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}recoverFromSyncStartupError(e,t){var r=this;return(0,n.A)((function*(){yield e;var n=r.startKeepAlives();r.updateSyncState(T.Error,{error:t}),yield n}))()}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(d.v.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(T.Error,{error:e}),!0)}sync(){var e=this;return(0,n.A)((function*(){var t,r;if(e.running=!0,e.abortController=new AbortController,null===(t=globalThis.window)||void 0===t||null===(r=t.addEventListener)||void 0===r||r.call(t,"online",e.onOnline,!1),e.client.isGuest())return e.doSync({});A("Getting saved sync token...");var n=e.client.store.getSavedSyncToken().then((e=>(A("Got saved sync token"),e)));e.savedSyncPromise=e.client.store.getSavedSync().then((t=>{if(A("Got reply from saved sync, exists? ".concat(!!t)),t)return e.syncFromCache(t)})).catch((e=>{d.v.error("Getting saved sync failed",e)})),yield e.getPushRules(),yield e.prepareLazyLoadingForSync(),yield e.storeClientOptions();var{filterId:i,filter:o}=yield e.getFilter();if(o){if(e.client.resetNotifTimelineSet(),!e.currentSyncRequest){var s=i,a=yield n;if(a)A("Sending first sync request...");else{A("Sending initial sync request...");var c=e.buildDefaultFilter();c.setDefinition(o.getDefinition()),c.setTimelineLimit(e.opts.initialSyncLimit),s=JSON.stringify(c.getDefinition())}e.currentSyncRequest=e.doSyncRequest({filter:s},a)}return A("Waiting for saved sync before starting sync processing..."),yield e.savedSyncPromise,e.doSync({filter:i})}}))()}stop(){var e,t,r;A("SyncApi.stop"),null===(e=globalThis.window)||void 0===e||null===(t=e.removeEventListener)||void 0===t||t.call(e,"online",this.onOnline,!1),this.running=!1,null===(r=this.abortController)||void 0===r||r.abort(),this.keepAliveTimer&&(clearTimeout(this.keepAliveTimer),this.keepAliveTimer=void 0)}retryImmediately(){return!!this.connectionReturnedDefer&&(this.startKeepAlives(0),!0)}syncFromCache(e){var t=this;return(0,n.A)((function*(){A("sync(): not doing HTTP hit, instead returning stored /sync data");var r=e.nextBatch;t.client.store.setSyncToken(r);var n={nextSyncToken:r,catchingUp:!1,fromCache:!0},i={next_batch:r,rooms:e.roomsData,account_data:{events:e.accountData}};try{yield t.processSyncResponse(n,i)}catch(o){d.v.error("Error processing cached sync",o)}t.storeIsInvalid||t.updateSyncState(T.Prepared,n)}))()}doSync(e){var t=this;return(0,n.A)((function*(){while(t.running){var r=t.client.store.getSyncToken(),n=void 0;try{t.currentSyncRequest||(t.currentSyncRequest=t.doSyncRequest(e,r)),n=yield t.currentSyncRequest}catch(s){var i=yield t.onSyncError(s);if(i)return;continue}finally{t.currentSyncRequest=void 0}t.client.store.setSyncToken(n.next_batch),t.failedSyncCount=0;var o={oldSyncToken:null!==r&&void 0!==r?r:void 0,nextSyncToken:n.next_batch,catchingUp:t.catchingUp};t.syncOpts.crypto&&(yield t.syncOpts.crypto.onSyncWillProcess(o));try{yield t.processSyncResponse(o,n)}catch(s){d.v.error("Caught /sync error",s),t.client.emit(u.AU.SyncUnexpectedError,s)}yield t.client.store.setSyncData(n),o.catchingUp=t.catchingUp,e.hasSyncedBefore||(t.updateSyncState(T.Prepared,o),e.hasSyncedBefore=!0),t.syncOpts.cryptoCallbacks&&(yield t.syncOpts.cryptoCallbacks.onSyncCompleted(o)),t.updateSyncState(T.Syncing,o),t.client.store.wantsSave()&&(t.syncOpts.crypto&&(yield t.syncOpts.crypto.saveDeviceList(0)),yield t.client.store.save())}t.running||(A("Sync no longer running: exiting."),t.connectionReturnedDefer&&(t.connectionReturnedDefer.reject(),t.connectionReturnedDefer=void 0),t.updateSyncState(T.Stopped))}))()}doSyncRequest(e,t){var r,n=this.getSyncParams(e,t);return this.client.http.authedRequest(h.IT.Get,"/sync",n,void 0,{localTimeoutMs:n.timeout+w,abortSignal:null===(r=this.abortController)||void 0===r?void 0:r.signal})}getSyncParams(e,t){var r=this.opts.pollTimeout;(this.getSyncState()!==T.Syncing||this.catchingUp)&&(this.catchingUp=!0,r=0);var n=e.filter;this.client.isGuest()&&!n&&(n=this.getGuestFilter());var i={filter:n,timeout:r,"org.matrix.msc4222.use_state_after":!0};return this.opts.disablePresence?i.set_presence=C.Offline:void 0!==this.presence&&(i.set_presence=this.presence),t?i.since=t:i._cacheBuster=Date.now(),[T.Reconnecting,T.Error].includes(this.getSyncState())&&(i.timeout=0),i}setPresence(e){this.presence=e}onSyncError(e){var t=this;return(0,n.A)((function*(){if(!t.running)return A("Sync no longer running: exiting"),t.connectionReturnedDefer&&(t.connectionReturnedDefer.reject(),t.connectionReturnedDefer=void 0),t.updateSyncState(T.Stopped),!0;if(d.v.error("/sync error %s",e),t.shouldAbortSync(e))return!0;t.failedSyncCount++,d.v.log("Number of consecutive failed sync requests:",t.failedSyncCount),A("Starting keep-alive");var r=t.startKeepAlives();t.currentSyncRequest=void 0,t.updateSyncState(t.failedSyncCount>=I?T.Error:T.Reconnecting,{error:e});var n=yield r;return n&&t.getSyncState()===T.Error&&t.updateSyncState(T.Catchup,{catchingUp:!0}),!1}))()}processSyncResponse(e,t){var r=this;return(0,n.A)((function*(){var i,c,h,p,f=r.client;if(Array.isArray(null===(i=t.presence)||void 0===i?void 0:i.events)&&t.presence.events.filter(a.O5).map(f.getEventMapper()).forEach((function(e){var t=f.store.getUser(e.getSender());t?t.setPresenceEvent(e):(t=o.K.createUser(e.getSender(),f),t.setPresenceEvent(e),f.store.storeUser(t)),f.emit(u.AU.Event,e)})),Array.isArray(null===(c=t.account_data)||void 0===c?void 0:c.events)){var g=t.account_data.events.filter(a.O5).map(f.getEventMapper()),y=g.reduce(((e,t)=>(e[t.getType()]=f.store.getAccountData(t.getType()),e)),{});f.store.storeAccountDataEvents(g),g.forEach((function(e){if(e.getType()===v.Bx.PushRules){var t=e.getContent();f.setPushRules(t)}var r=y[e.getType()];return f.emit(u.AU.AccountData,e,r),e}))}if(t.to_device&&Array.isArray(t.to_device.events)&&t.to_device.events.length>0){var S=t.to_device.events.filter(a.O5);r.syncOpts.cryptoCallbacks&&(S=yield r.syncOpts.cryptoCallbacks.preprocessToDeviceMessages(S));var b=[];S.map(f.getEventMapper({toDevice:!0})).map((e=>{if("m.key.verification.cancel"===e.getType()){var t=e.getContent()["transaction_id"];t&&b.push(t)}return e})).forEach((function(e){var t=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=t.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){var r=t["transaction_id"];b.includes(r)&&e.flagCancelled()}f.emit(u.AU.ToDeviceEvent,e)}else d.v.log("Ignoring undecryptable to-device event from "+e.getSender())}))}else r.catchingUp=!1;var E=[],_=[],w=[],I=[];t.rooms&&(t.rooms.invite&&(E=r.mapSyncResponseToRoomArray(t.rooms.invite)),t.rooms.join&&(_=r.mapSyncResponseToRoomArray(t.rooms.join)),t.rooms.leave&&(w=r.mapSyncResponseToRoomArray(t.rooms.leave)),t.rooms.knock&&(I=r.mapSyncResponseToRoomArray(t.rooms.knock))),r.notifEvents=[],yield(0,a.d8)(E,function(){var e=(0,n.A)((function*(e){var t,n=e.room,i=r.mapSyncEventsFormat(e.invite_state,n);yield r.injectRoomEvents(n,i,void 0);var o=null===(t=n.currentState.getStateEvents(v.Bx.RoomMember,f.getUserId()))||void 0===t?void 0:t.getSender(),s=f.crypto;if(s){var a=yield s.cryptoStore.takeParkedSharedHistory(n.roomId);for(var c of a)c.senderId===o&&(yield s.olmDevice.addInboundGroupSession(n.roomId,c.senderKey,c.forwardingCurve25519KeyChain,c.sessionId,c.sessionKey,c.keysClaimed,!0,{sharedHistory:!0,untrusted:!0}))}e.isBrandNewRoom?(n.recalculate(),f.store.storeRoom(n),f.emit(u.AU.Room,n)):n.recalculate(),i.forEach((function(e){f.emit(u.AU.Event,e)}))}));return function(t){return e.apply(this,arguments)}}()),yield(0,a.d8)(_,function(){var t=(0,n.A)((function*(t){var n,i=t.room,o=r.mapSyncEventsFormat(t.state,i),a=r.mapSyncEventsFormat(t["org.matrix.msc4222.state_after"],i),c=r.mapSyncEventsFormat(t.timeline,i,!1),h=r.mapSyncEventsFormat(t.ephemeral),p=r.mapSyncEventsFormat(t.account_data),g=t["org.matrix.msc4222.state_after"]?a:o.concat(c),y=r.isRoomEncrypted(i,g);if(t.unread_notifications){var S,b;if(!y||0===t.unread_notifications.notification_count)i.setUnreadNotificationCount(s.X5.Total,null!==(S=t.unread_notifications.notification_count)&&void 0!==S?S:0);if(!y||i.getUnreadNotificationCount(s.X5.Highlight)<=0)i.setUnreadNotificationCount(s.X5.Highlight,null!==(b=t.unread_notifications.highlight_count)&&void 0!==b?b:0)}var E=null!==(n=t[m.a.name])&&void 0!==n?n:t[m.a.altName];if(E)for(var[_,w]of(i.resetThreadUnreadNotificationCountFromSync(Object.keys(E)),Object.entries(E))){var I;if(!y||0===w.notification_count)i.setThreadUnreadNotificationCount(_,s.X5.Total,null!==(I=w.notification_count)&&void 0!==I?I:0);var T,R=i.getThreadUnreadNotificationCount(_,s.X5.Highlight)<=0;if(!y||y&&R)i.setThreadUnreadNotificationCount(_,s.X5.Highlight,null!==(T=w.highlight_count)&&void 0!==T?T:0)}else i.resetThreadUnreadNotificationCountFromSync();if(t.timeline=t.timeline||{},t.isBrandNewRoom)null!==t.timeline.prev_batch&&i.getLiveTimeline().setPaginationToken(t.timeline.prev_batch,l.q.BACKWARDS);else if(t.timeline.limited){for(var k,C=!0,O=c.length-1;O>=0;O--){var D=c[O].getId();if(i.getTimelineForEvent(D)){A("Already have event ".concat(D," in limited sync - not resetting")),C=!1,c.splice(0,O);break}}if(C)i.resetLiveTimeline(t.timeline.prev_batch,r.syncOpts.canResetEntireTimeline(i.roomId)?null:null!==(k=e.oldSyncToken)&&void 0!==k?k:null),f.resetNotifTimelineSet()}if(r.syncOpts.cryptoCallbacks)for(var M of g)M.isState()&&M.getType()===v.Bx.RoomEncryption&&""===M.getStateKey()&&(yield r.syncOpts.cryptoCallbacks.onCryptoEvent(i,M));try{"org.matrix.msc4222.state_after"in t?yield r.injectRoomEvents(i,void 0,a,c,e.fromCache):yield r.injectRoomEvents(i,o,void 0,c,e.fromCache)}catch(M){d.v.error("Failed to process events on room ".concat(i.roomId,":"),M)}t.summary&&i.setSummary(t.summary),i.addEphemeralEvents(h),i.addAccountData(p),i.recalculate(),t.isBrandNewRoom&&(f.store.storeRoom(i),f.emit(u.AU.Room,i)),r.processEventsForNotifs(i,c);var P=e=>f.emit(u.AU.Event,e);o.forEach(P),c.forEach(P),h.forEach(P),p.forEach(P),i.decryptCriticalEvents()}));return function(e){return t.apply(this,arguments)}}()),yield(0,a.d8)(w,function(){var e=(0,n.A)((function*(e){var t=e.room,{timelineEvents:n,stateEvents:i,stateAfterEvents:o}=yield r.mapAndInjectRoomEvents(e),s=r.mapSyncEventsFormat(e.account_data);t.addAccountData(s),t.recalculate(),e.isBrandNewRoom&&(f.store.storeRoom(t),f.emit(u.AU.Room,t)),r.processEventsForNotifs(t,n),null===i||void 0===i||i.forEach((function(e){f.emit(u.AU.Event,e)})),null===o||void 0===o||o.forEach((function(e){f.emit(u.AU.Event,e)})),n.forEach((function(e){f.emit(u.AU.Event,e)})),s.forEach((function(e){f.emit(u.AU.Event,e)}))}));return function(t){return e.apply(this,arguments)}}()),yield(0,a.d8)(I,function(){var e=(0,n.A)((function*(e){var t=e.room,n=r.mapSyncEventsFormat(e.knock_state,t);yield r.injectRoomEvents(t,n,void 0),e.isBrandNewRoom?(t.recalculate(),f.store.storeRoom(t),f.emit(u.AU.Room,t)):t.recalculate(),n.forEach((function(e){f.emit(u.AU.Event,e)}))}));return function(t){return e.apply(this,arguments)}}()),e.oldSyncToken&&r.notifEvents.length&&(r.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),r.notifEvents.forEach((function(e){var t;null===(t=f.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e,{addToState:!0})}))),t.device_lists&&r.syncOpts.cryptoCallbacks&&(yield r.syncOpts.cryptoCallbacks.processDeviceLists(t.device_lists)),yield null===(h=r.syncOpts.cryptoCallbacks)||void 0===h?void 0:h.processKeyCounts(t.device_one_time_keys_count,null!==(p=t.device_unused_fallback_key_types)&&void 0!==p?p:t["org.matrix.msc2732.device_unused_fallback_key_types"])}))()}startKeepAlives(e){return void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this.keepAliveTimer&&clearTimeout(this.keepAliveTimer),e>0?this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this),e):this.pokeKeepAlive(),this.connectionReturnedDefer||(this.connectionReturnedDefer=(0,a.v6)()),this.connectionReturnedDefer.promise}pokeKeepAlive(){var e,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(!this.running)return clearTimeout(this.keepAliveTimer),void(this.connectionReturnedDefer&&(this.connectionReturnedDefer.reject("SyncApi.stop() was called"),this.connectionReturnedDefer=void 0));var r=()=>{clearTimeout(this.keepAliveTimer),this.connectionReturnedDefer&&(this.connectionReturnedDefer.resolve(t),this.connectionReturnedDefer=void 0)};this.client.http.request(h.IT.Get,"/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3,abortSignal:null===(e=this.abortController)||void 0===e?void 0:e.signal}).then((()=>{r()}),(e=>{400==e.httpStatus||404==e.httpStatus?this.keepAliveTimer=setTimeout(r,2e3):(t=!0,this.keepAliveTimer=setTimeout(this.pokeKeepAlive.bind(this,t),5e3+Math.floor(5e3*Math.random())),this.updateSyncState(T.Error,{error:e}))}))}mapSyncResponseToRoomArray(e){var t=this.client;return Object.keys(e).filter((e=>!(0,a.YY)(e))).map((r=>{var n=t.store.getRoom(r),i=!1;return n||(n=this.createRoom(r),i=!0),E(E({},e[r]),{},{room:n,isBrandNewRoom:i})}))}mapSyncEventsFormat(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!e||!Array.isArray(e.events))return[];var n=this.client.getEventMapper({decrypt:r});return e.events.filter(a.O5).map((function(e){return t&&(e.room_id=t.roomId),n(e)}))}resolveInvites(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership(S.O.Invite).forEach((function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n,i=t.getUser(r.userId);n=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(r.userId),n.then((function(t){var n=r.events.member;(null===n||void 0===n?void 0:n.getContent().membership)===S.O.Invite&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))}),(function(e){}))}}))}}findEncryptionEvent(e){return null===e||void 0===e?void 0:e.find((e=>e.getType()===v.Bx.RoomEncryption&&""===e.getStateKey()))}isRoomEncrypted(e,t){return e.hasEncryptionStateEvent()||!!this.findEncryptionEvent(t)}mapAndInjectRoomEvents(e){var t=this;return(0,n.A)((function*(){var r=t.mapSyncEventsFormat(e.state,e.room),n=t.mapSyncEventsFormat(e["org.matrix.msc4222.state_after"],e.room),i=t.mapSyncEventsFormat(e.timeline,e.room);return"org.matrix.msc4222.state_after"in e?yield t.injectRoomEvents(e.room,void 0,n,i):yield t.injectRoomEvents(e.room,r,void 0,i),{timelineEvents:i,stateEvents:r,stateAfterEvents:n}}))()}injectRoomEvents(e,t,r,i){var o=arguments,s=this;return(0,n.A)((function*(){var n=o.length>4&&void 0!==o[4]&&o[4],a=null!==r&&void 0!==r?r:t,c=e.getLiveTimeline(),l=0==c.getEvents().length;if(l){for(var d of a)s.client.getPushActionsForEvent(d);c.initialiseState(a,{timelineWasEmpty:l})}s.resolveInvites(e),e.recalculate(),l||(e.oldState.setStateEvents(a),e.currentState.setStateEvents(a)),yield e.addLiveEvents(i||[],{fromCache:n,timelineWasEmpty:l,addToState:void 0===r}),s.client.processBeaconEvents(e,i)}))()}processEventsForNotifs(e,t){if(this.client.getNotifTimelineSet())for(var r of t){var n,i=this.client.getPushActionsForEvent(r);null!==i&&void 0!==i&&i.notify&&null!==(n=i.tweaks)&&void 0!==n&&n.highlight&&this.notifEvents.push(r)}}getGuestFilter(){return"{}"}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(u.AU.Sync,this.syncState,r,t)}}function P(e,t,r){var{timelineSupport:n}=e,i=new s.Wv(t,e,e.getUserId(),{lazyLoadMembers:r.lazyLoadMembers,pendingEventOrdering:r.pendingEventOrdering,timelineSupport:n});return e.reEmitter.reEmit(i,[s.u9.Name,s.u9.Redaction,s.u9.RedactionCancelled,s.u9.Receipt,s.u9.Tags,s.u9.LocalEchoUpdated,s.u9.AccountData,s.u9.MyMembership,s.u9.Timeline,s.u9.TimelineReset,p.f.Events,p.f.Members,p.f.NewMember,p.f.Update,g.JH.New,g.JH.Update,g.JH.Destroy,g.JH.LivenessChange]),i.on(p.f.NewMember,((t,r,n)=>{var i;n.user=null!==(i=e.getUser(n.userId))&&void 0!==i?i:void 0,e.reEmitter.reEmit(n,[f.o.Name,f.o.Typing,f.o.PowerLevel,f.o.Membership])})),i}},1240:function(e,t,r){"use strict";r.d(t,{Hh:function(){return g},BL:function(){return f},Tw:function(){return v}});r(4114),r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);var n=r(4761),i=r(3036),o=null,s=0,a=()=>(null===o&&(o=new AudioContext),s++,o),c=()=>{var e;(s--,0===s)&&(null===(e=o)||void 0===e||e.close(),o=null)},l=r(3271),d=r(2668),u=r(3061),h=200,v=-60,p=8,f=function(e){return e["NewStream"]="new_stream",e["MuteStateChanged"]="mute_state_changed",e["LocalVolumeChanged"]="local_volume_changed",e["VolumeChanged"]="volume_changed",e["ConnectedChanged"]="connected_changed",e["Speaking"]="speaking",e["Disposed"]="disposed",e}({});class g extends d.X{constructor(e){super(),(0,n.A)(this,"stream",void 0),(0,n.A)(this,"sdpMetadataStreamId",void 0),(0,n.A)(this,"userId",void 0),(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"purpose",void 0),(0,n.A)(this,"speakingVolumeSamples",void 0),(0,n.A)(this,"client",void 0),(0,n.A)(this,"call",void 0),(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"audioMuted",void 0),(0,n.A)(this,"videoMuted",void 0),(0,n.A)(this,"localVolume",1),(0,n.A)(this,"measuringVolumeActivity",!1),(0,n.A)(this,"audioContext",void 0),(0,n.A)(this,"analyser",void 0),(0,n.A)(this,"frequencyBinCount",void 0),(0,n.A)(this,"speakingThreshold",v),(0,n.A)(this,"speaking",!1),(0,n.A)(this,"volumeLooperTimeout",void 0),(0,n.A)(this,"_disposed",!1),(0,n.A)(this,"_connected",!1),(0,n.A)(this,"onAddTrack",(()=>{this.emit(f.NewStream,this.stream)})),(0,n.A)(this,"onCallState",(e=>{e===u.iP.Connected?this.connected=!0:e===u.iP.Connecting&&(this.connected=!1)})),(0,n.A)(this,"volumeLooper",(()=>{if(this.analyser&&this.measuringVolumeActivity){this.analyser.getFloatFrequencyData(this.frequencyBinCount);var e=-1/0;for(var t of this.frequencyBinCount)t>e&&(e=t);this.speakingVolumeSamples.shift(),this.speakingVolumeSamples.push(e),this.emit(f.VolumeChanged,e);var r=!1;for(var n of this.speakingVolumeSamples)if(n>this.speakingThreshold){r=!0;break}this.speaking!==r&&(this.speaking=r,this.emit(f.Speaking,this.speaking)),this.volumeLooperTimeout=setTimeout(this.volumeLooper,h)}})),this.client=e.client,this.call=e.call,this.roomId=e.roomId,this.userId=e.userId,this.deviceId=e.deviceId,this.purpose=e.purpose,this.audioMuted=e.audioMuted,this.videoMuted=e.videoMuted,this.speakingVolumeSamples=new Array(p).fill(-1/0),this.sdpMetadataStreamId=e.stream.id,this.updateStream(null,e.stream),this.stream=e.stream,this.hasAudioTrack&&this.initVolumeMeasuring(),e.call&&(e.call.addListener(u.$E.State,this.onCallState),this.onCallState(e.call.state))}get connected(){return this.isLocal()||this._connected}set connected(e){this._connected=e,this.emit(f.ConnectedChanged,this.connected)}get hasAudioTrack(){return this.stream.getAudioTracks().length>0}updateStream(e,t){if(t!==e){var r=this.measuringVolumeActivity;e&&(e.removeEventListener("addtrack",this.onAddTrack),this.measureVolumeActivity(!1)),this.stream=t,t.addEventListener("addtrack",this.onAddTrack),this.hasAudioTrack?(this.initVolumeMeasuring(),r&&this.measureVolumeActivity(!0)):this.measureVolumeActivity(!1),this.emit(f.NewStream,this.stream)}}initVolumeMeasuring(){if(this.hasAudioTrack){this.audioContext||(this.audioContext=a()),this.analyser=this.audioContext.createAnalyser(),this.analyser.fftSize=512,this.analyser.smoothingTimeConstant=.1;var e=this.audioContext.createMediaStreamSource(this.stream);e.connect(this.analyser),this.frequencyBinCount=new Float32Array(this.analyser.frequencyBinCount)}}getMember(){var e,t=this.client.getRoom(this.roomId);return null!==(e=null===t||void 0===t?void 0:t.getMember(this.userId))&&void 0!==e?e:null}isLocal(){return this.userId===this.client.getUserId()&&(void 0===this.deviceId||this.deviceId===this.client.getDeviceId())}isAudioMuted(){return 0===this.stream.getAudioTracks().length||this.audioMuted}isVideoMuted(){return 0===this.stream.getVideoTracks().length||this.videoMuted}isSpeaking(){return this.speaking}setNewStream(e){this.updateStream(this.stream,e)}setAudioVideoMuted(e,t){null!==e&&(this.audioMuted!==e&&this.speakingVolumeSamples.fill(-1/0),this.audioMuted=e),null!==t&&(this.videoMuted=t),this.emit(f.MuteStateChanged,this.audioMuted,this.videoMuted)}measureVolumeActivity(e){if(e){if(!this.analyser||!this.frequencyBinCount||!this.hasAudioTrack)return;this.measuringVolumeActivity=!0,this.volumeLooper()}else this.measuringVolumeActivity=!1,this.speakingVolumeSamples.fill(-1/0),this.emit(f.VolumeChanged,-1/0)}setSpeakingThreshold(e){this.speakingThreshold=e}clone(){var e=this.client.getMediaHandler(),t=this.stream.clone();return l.v.log("CallFeed clone() cloning stream (originalStreamId=".concat(this.stream.id,", newStreamId").concat(t.id,")")),this.purpose===i.h.Usermedia?e.userMediaStreams.push(t):e.screensharingStreams.push(t),new g({client:this.client,roomId:this.roomId,userId:this.userId,deviceId:this.deviceId,stream:t,purpose:this.purpose,audioMuted:this.audioMuted,videoMuted:this.videoMuted})}dispose(){var e,t;clearTimeout(this.volumeLooperTimeout),null===(e=this.stream)||void 0===e||e.removeEventListener("addtrack",this.onAddTrack),null===(t=this.call)||void 0===t||t.removeListener(u.$E.State,this.onCallState),this.audioContext&&(this.audioContext=void 0,this.analyser=void 0,c()),this._disposed=!0,this.emit(f.Disposed)}get disposed(){return this._disposed}set disposed(e){this._disposed=e}getLocalVolume(){return this.localVolume}setLocalVolume(e){this.localVolume=e,this.emit(f.LocalVolumeChanged,e)}}},1291:function(e,t,r){"use strict";var n=r(741);e.exports=function(e){var t=+e;return t!==t||0===t?0:n(t)}},1327:function(e,t,r){"use strict";r.d(t,{IG:function(){return k},IO:function(){return b},M7:function(){return A}});r(4114),r(6573),r(8100),r(7936),r(8111),r(3579),r(7467),r(4732),r(9577);var n=r(698),i=r(4761),o=r(4108),s=r(3271),a=r(8620),c=r(8269),l=r(6170),d=r(8968),u=r(4229),h=r(3562),v=r(9683),p=r(4864),f=r(4519),g=r(3571),m=r(1915),y=200,S=5e3;class b{constructor(e,t){this.baseApis=e,this.getKey=t,(0,i.A)(this,"algorithm",void 0),(0,i.A)(this,"backupInfo",void 0),(0,i.A)(this,"checkedForBackup",void 0),(0,i.A)(this,"sendingBackups",void 0),(0,i.A)(this,"sessionLastCheckAttemptedTime",{}),(0,i.A)(this,"clientRunning",!0),this.checkedForBackup=!1,this.sendingBackups=!1}stop(){this.clientRunning=!1}get version(){return this.backupInfo&&this.backupInfo.version}static checkBackupVersion(e){var t=T[e.algorithm];if(!t)throw new Error("Unknown backup algorithm: "+e.algorithm);if("object"!==typeof e.auth_data)throw new Error("Invalid backup data returned");return t.checkBackupVersion(e)}static makeAlgorithm(e,t){var r=T[e.algorithm];if(!r)throw new Error("Unknown backup algorithm");return r.init(e.auth_data,t)}enableKeyBackup(e){var t=this;return(0,n.A)((function*(){t.backupInfo=e,t.algorithm&&t.algorithm.free(),t.algorithm=yield b.makeAlgorithm(e,t.getKey),t.baseApis.emit(h.cr.KeyBackupStatus,!0),t.scheduleKeyBackupSend()}))()}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit(h.cr.KeyBackupStatus,!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}prepareKeyBackupVersion(e,t){return(0,n.A)((function*(){var r=t?T[t]:R;if(!r)throw new Error("Unknown backup algorithm");var[n,i]=yield r.prepare(e),o=(0,p.encodeRecoveryKey)(n);return{algorithm:r.algorithmName,auth_data:i,recovery_key:o,privateKey:n}}))()}createKeyBackupVersion(e){var t=this;return(0,n.A)((function*(){t.algorithm=yield b.makeAlgorithm(e,t.getKey)}))()}deleteAllKeyBackupVersions(){var e=this;return(0,n.A)((function*(){var t,r,n=null!==(t=null===(r=yield e.baseApis.getKeyBackupVersion())||void 0===r?void 0:r.version)&&void 0!==t?t:null;while(null!=n){var i,o;yield e.deleteKeyBackupVersion(n),e.disableKeyBackup(),n=null!==(i=null===(o=yield e.baseApis.getKeyBackupVersion())||void 0===o?void 0:o.version)&&void 0!==i?i:null}}))()}deleteKeyBackupVersion(e){var t=this;return(0,n.A)((function*(){var r=(0,l.RR)("/room_keys/version/$version",{$version:e});yield t.baseApis.http.authedRequest(v.IT.Delete,r,void 0,void 0,{prefix:v.iD.V3})}))()}checkAndStart(){var e=this;return(0,n.A)((function*(){if(s.v.log("Checking key backup status..."),e.baseApis.isGuest())return s.v.log("Skipping key backup check since user is guest"),e.checkedForBackup=!0,null;var t;try{var r;t=null!==(r=yield e.baseApis.getKeyBackupVersion())&&void 0!==r?r:void 0}catch(i){return s.v.log("Error checking for active key backup",i),404===i.httpStatus&&(e.checkedForBackup=!0),null}e.checkedForBackup=!0;var n=yield e.isKeyBackupTrusted(t);return n.usable&&!e.backupInfo?(s.v.log("Found usable key backup v".concat(t.version,": enabling key backups")),yield e.enableKeyBackup(t)):!n.usable&&e.backupInfo?(s.v.log("No usable key backup: disabling key backup"),e.disableKeyBackup()):n.usable||e.backupInfo?n.usable&&e.backupInfo&&(t.version!==e.backupInfo.version?(s.v.log("On backup version ".concat(e.backupInfo.version," but ")+"found version ".concat(t.version,": switching.")),e.disableKeyBackup(),yield e.enableKeyBackup(t),yield e.scheduleAllGroupSessionsForBackup()):s.v.log("Backup version ".concat(t.version," still current"))):s.v.log("No usable key backup: not enabling key backup"),{backupInfo:t,trustInfo:n}}))()}checkKeyBackup(){var e=this;return(0,n.A)((function*(){return e.checkedForBackup=!1,e.checkAndStart()}))()}queryKeyBackupRateLimited(e,t){var r=this;return(0,n.A)((function*(){if(r.backupInfo){var n=(new Date).getTime();(!r.sessionLastCheckAttemptedTime[t]||n-r.sessionLastCheckAttemptedTime[t]>S)&&(r.sessionLastCheckAttemptedTime[t]=n,yield r.baseApis.restoreKeyBackupWithCache(e,t,r.backupInfo,{}))}}))()}isKeyBackupTrusted(e){var t=this;return(0,n.A)((function*(){var r={usable:!1,trusted_locally:!1,sigs:[]};if(!e||!e.algorithm||!e.auth_data||!e.auth_data.signatures)return s.v.info("Key backup is absent or missing required data: ".concat(JSON.stringify(e))),r;var i=t.baseApis.getUserId(),o=yield t.baseApis.crypto.getSessionBackupPrivateKey();if(o){var c=null;try{c=yield b.makeAlgorithm(e,(0,n.A)((function*(){return o}))),(yield c.keyMatches(o))&&(s.v.info("Backup is trusted locally"),r.trusted_locally=!0)}catch(g){}finally{var l;null===(l=c)||void 0===l||l.free()}}var d=e.auth_data.signatures[i]||{};for(var u of Object.keys(d)){var h=u.split(":");if("ed25519"===h[0]){var v={deviceId:h[1]},p=t.baseApis.crypto.crossSigningInfo.getId();if(p!==v.deviceId){var f=t.baseApis.crypto.deviceList.getStoredDevice(i,v.deviceId);if(f){v.device=f,v.deviceTrust=t.baseApis.checkDeviceTrust(i,v.deviceId);try{yield(0,a.verifySignature)(t.baseApis.crypto.olmDevice,e.auth_data,i,f.deviceId,f.getFingerprint()),v.valid=!0}catch(m){s.v.info("Bad signature from key ID "+u+" userID "+t.baseApis.getUserId()+" device ID "+f.deviceId+" fingerprint: "+f.getFingerprint(),e.auth_data,m),v.valid=!1}}else v.valid=null,s.v.info("Ignoring signature from unknown key "+u);r.sigs.push(v)}else{v.crossSigningId=!0;try{yield(0,a.verifySignature)(t.baseApis.crypto.olmDevice,e.auth_data,i,v.deviceId,p),v.valid=!0}catch(m){s.v.warn("Bad signature from cross signing key "+p,m),v.valid=!1}r.sigs.push(v)}}else s.v.log("Ignoring unknown signature type: "+h[0])}return r.usable=r.sigs.some((e=>{var t;return e.valid&&(e.device&&(null===(t=e.deviceTrust)||void 0===t?void 0:t.isVerified())||e.crossSigningId)})),r}))()}scheduleKeyBackupSend(){var e=arguments,t=this;return(0,n.A)((function*(){var r=e.length>0&&void 0!==e[0]?e[0]:1e4;if(s.v.debug("Key backup: scheduleKeyBackupSend currentSending:".concat(t.sendingBackups," delay:").concat(r)),!t.sendingBackups){t.sendingBackups=!0;try{var n=Math.random()*r;if(yield(0,l.yy)(n),!t.clientRunning)return void(t.sendingBackups=!1);for(var i=0;;){if(!t.algorithm)return;try{var o=yield t.backupPendingKeys(y);if(0===o)return void(t.sendingBackups=!1);i=0}catch(c){if(i++,s.v.log("Key backup request failed",c),c instanceof v.up){var a=c.data.errcode;if("M_NOT_FOUND"==a||"M_WRONG_ROOM_KEYS_VERSION"==a)return t.sendingBackups=!1,t.baseApis.crypto.emit(h.cr.KeyBackupFailed,a),void(yield t.checkKeyBackup())}}if(i&&(yield(0,l.yy)(1e3*Math.pow(2,Math.min(i-1,4)))),!t.clientRunning)return s.v.debug("Key backup send loop aborted, client stopped"),void(t.sendingBackups=!1)}}catch(c){s.v.log("Backup loop failed ".concat(c)),t.sendingBackups=!1}}}))()}backupPendingKeys(e){var t=this;return(0,n.A)((function*(){var r=yield t.baseApis.crypto.cryptoStore.getSessionsNeedingBackup(e);if(!r.length)return 0;var n=yield t.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();t.baseApis.crypto.emit(h.cr.KeyBackupSessionsRemaining,n);var i={};for(var o of r){var s,c=o.sessionData.room_id;(0,l.C6)(i,c,i[c]||{sessions:{}});var d=t.baseApis.crypto.olmDevice.exportInboundGroupSession(o.senderKey,o.sessionId,o.sessionData);d.algorithm=a.MEGOLM_ALGORITHM;var u=(d.forwarding_curve25519_key_chain||[]).length,v=t.baseApis.crypto.deviceList.getUserByIdentityKey(a.MEGOLM_ALGORITHM,o.senderKey),p=null!==(s=t.baseApis.crypto.deviceList.getDeviceByIdentityKey(a.MEGOLM_ALGORITHM,o.senderKey))&&void 0!==s?s:void 0,f=t.baseApis.crypto.checkDeviceInfoTrust(v,p).isVerified();(0,l.C6)(i[c]["sessions"],o.sessionId,{first_message_index:d.first_known_index,forwarded_count:u,is_verified:f,session_data:yield t.algorithm.encryptSession(d)})}return yield t.baseApis.sendKeyBackup(void 0,void 0,t.backupInfo.version,{rooms:i}),yield t.baseApis.crypto.cryptoStore.unmarkSessionsNeedingBackup(r),n=yield t.baseApis.crypto.cryptoStore.countSessionsNeedingBackup(),t.baseApis.crypto.emit(h.cr.KeyBackupSessionsRemaining,n),r.length}))()}backupGroupSession(e,t){var r=this;return(0,n.A)((function*(){yield r.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),r.backupInfo&&r.scheduleKeyBackupSend()}))()}scheduleAllGroupSessionsForBackup(){var e=this;return(0,n.A)((function*(){yield e.flagAllGroupSessionsForBackup(),e.scheduleKeyBackupSend(0)}))()}flagAllGroupSessionsForBackup(){var e=this;return(0,n.A)((function*(){yield e.baseApis.crypto.cryptoStore.doTxn("readwrite",[d.y.STORE_INBOUND_GROUP_SESSIONS,d.y.STORE_BACKUP],(t=>{e.baseApis.crypto.cryptoStore.getAllEndToEndInboundGroupSessions(t,(r=>{null!==r&&e.baseApis.crypto.cryptoStore.markSessionsNeedingBackup([r],t)}))}));var t=yield e.baseApis.crypto.cryptoStore.countSessionsNeedingBackup();return e.baseApis.emit(h.cr.KeyBackupSessionsRemaining,t),t}))()}countSessionsNeedingBackup(){return this.baseApis.crypto.cryptoStore.countSessionsNeedingBackup()}}class E{constructor(e,t,r){this.authData=e,this.publicKey=t,this.getKey=r}static init(e,t){return(0,n.A)((function*(){if(!e||!("public_key"in e))throw new Error("auth_data missing required information");var r=new globalThis.Olm.PkEncryption;return r.set_recipient_key(e.public_key),new E(e,r,t)}))()}static prepare(e){return(0,n.A)((function*(){var t=new globalThis.Olm.PkDecryption;try{var r={};if(e)if(e instanceof Uint8Array)r.public_key=t.init_with_private_key(e);else{var n=yield(0,c.SM)(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,r.public_key=t.init_with_private_key(n.key)}else r.public_key=t.generate_key();var i=new globalThis.Olm.PkEncryption;return i.set_recipient_key(r.public_key),[t.get_private_key(),r]}finally{t.free()}}))()}static checkBackupVersion(e){if(!("public_key"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!0}encryptSession(e){var t=this;return(0,n.A)((function*(){var r=Object.assign({},e);return delete r.session_id,delete r.room_id,delete r.first_known_index,t.publicKey.encrypt(JSON.stringify(r))}))()}decryptSessions(e){var t=this;return(0,n.A)((function*(){var r=yield t.getKey(),n=new globalThis.Olm.PkDecryption;try{var i=n.init_with_private_key(r);if(i!==t.authData.public_key)throw new v.up({errcode:o.pB.RESTORE_BACKUP_ERROR_BAD_KEY});var a=[];for(var[c,l]of Object.entries(e))try{var d=JSON.parse(n.decrypt(l.session_data.ephemeral,l.session_data.mac,l.session_data.ciphertext));d.session_id=c,a.push(d)}catch(u){s.v.log("Failed to decrypt megolm session from backup",u,l)}return a}finally{n.free()}}))()}keyMatches(e){var t=this;return(0,n.A)((function*(){var r,n=new globalThis.Olm.PkDecryption;try{r=n.init_with_private_key(e)}finally{n.free()}return r===t.authData.public_key}))()}free(){this.publicKey.free()}}function _(e){var t=new Uint8Array(e);return globalThis.crypto.getRandomValues(t),t}(0,i.A)(E,"algorithmName","m.megolm_backup.v1.curve25519-aes-sha2");var w=new u.qr("m.megolm_backup.v1.aes-hmac-sha2","org.matrix.msc3270.v1.aes-hmac-sha2");class I{constructor(e,t){this.authData=e,this.key=t}static init(e,t){return(0,n.A)((function*(){if(!e)throw new Error("auth_data missing");var r=yield t();if(e.mac){var{mac:n}=yield(0,m.calculateKeyCheck)(r,e.iv);if(e.mac.replace(/=+$/g,"")!==n.replace(/=+/g,""))throw new Error("Key does not match")}return new I(e,r)}))()}static prepare(e){return(0,n.A)((function*(){var t,r={};if(e)if(e instanceof Uint8Array)t=new Uint8Array(e);else{var n=yield(0,c.SM)(e);r.private_key_salt=n.salt,r.private_key_iterations=n.iterations,t=n.key}else t=_(32);var{iv:i,mac:o}=yield(0,m.calculateKeyCheck)(t);return r.iv=i,r.mac=o,[t,r]}))()}static checkBackupVersion(e){if(!("iv"in e.auth_data)||!("mac"in e.auth_data))throw new Error("Invalid backup data returned")}get untrusted(){return!1}encryptSession(e){var t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,(0,g.A)(JSON.stringify(t),this.key,e.session_id)}decryptSessions(e){var t=this;return(0,n.A)((function*(){var r=[];for(var[n,i]of Object.entries(e))try{var o=JSON.parse(yield(0,f.A)(i.session_data,t.key,n));o.session_id=n,r.push(o)}catch(a){s.v.log("Failed to decrypt megolm session from backup",a,i)}return r}))()}keyMatches(e){var t=this;return(0,n.A)((function*(){if(t.authData.mac){var{mac:r}=yield(0,m.calculateKeyCheck)(e,t.authData.iv);return t.authData.mac.replace(/=+$/g,"")===r.replace(/=+/g,"")}return!0}))()}free(){this.key.fill(0)}}(0,i.A)(I,"algorithmName",w.name);var T={[E.algorithmName]:E,[I.algorithmName]:I},R=E;function k(e){var t;return{trusted:e.usable,matchesDecryptionKey:null!==(t=e.trusted_locally)&&void 0!==t&&t}}class A{constructor(e){(0,i.A)(this,"algorithm",void 0),(0,i.A)(this,"sourceTrusted",void 0),this.algorithm=e,this.sourceTrusted=!e.untrusted}free(){this.algorithm.free()}decryptSessions(e){var t=this;return(0,n.A)((function*(){return yield t.algorithm.decryptSessions(e)}))()}}},1337:function(e,t,r){"use strict";r.d(t,{m:function(){return h},x:function(){return u}});r(4114),r(8111),r(2489),r(116);var n,i=r(4761),o=r(2292),s=r(3271),a=r(8965),c=r(2668),l=r(4653),d=!0;n=d?s.v.log.bind(s.v):function(){};var u=function(e){return e["Ignore"]="ignore",e["Replace"]="replace",e}({});class h extends c.X{constructor(e){var t,r,n,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2?arguments[2]:void 0,c=arguments.length>3?arguments[3]:void 0,d=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;super(),this.room=e,this.thread=c,this.threadListType=d,(0,i.A)(this,"relations",void 0),(0,i.A)(this,"timelineSupport",void 0),(0,i.A)(this,"displayPendingEvents",void 0),(0,i.A)(this,"liveTimeline",void 0),(0,i.A)(this,"timelines",void 0),(0,i.A)(this,"_eventIdToTimeline",new Map),(0,i.A)(this,"filter",void 0),this.timelineSupport=Boolean(s.timelineSupport),this.liveTimeline=new o.q(this),this.displayPendingEvents=!1!==s.pendingEvents,this.timelines=[this.liveTimeline],this._eventIdToTimeline=new Map,this.filter=s.filter,this.relations=null!==(t=null===(r=this.room)||void 0===r?void 0:r.relations)&&void 0!==t?t:new l.t(null!==(n=null===e||void 0===e?void 0:e.client)&&void 0!==n?n:a)}getTimelines(){return this.timelines}getFilter(){return this.filter}setFilter(e){this.filter=e}getPendingEvents(){return this.room&&this.displayPendingEvents?this.room.getPendingEvents():[]}getLiveTimeline(){return this.liveTimeline}setLiveTimeline(e){this.liveTimeline=e}eventIdToTimeline(e){return this._eventIdToTimeline.get(e)}replaceEventId(e,t){var r=this._eventIdToTimeline.get(e);r&&(this._eventIdToTimeline.delete(e),this._eventIdToTimeline.set(t,r))}resetLiveTimeline(e,t){var r=!this.timelineSupport||!t,n=this.liveTimeline,i=r?n.forkLive(o.q.FORWARDS):n.fork(o.q.FORWARDS);r?(this.timelines=[i],this._eventIdToTimeline=new Map):this.timelines.push(i),t&&n.setPaginationToken(t,o.q.FORWARDS),i.setPaginationToken(null!==e&&void 0!==e?e:null,o.q.BACKWARDS),this.liveTimeline=i,this.emit(a.u9.TimelineReset,this.room,this,r)}getTimelineForEvent(e){if(null===e||void 0===e)return null;var t=this._eventIdToTimeline.get(e);return void 0===t?null:t}findEventById(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))}addTimeline(){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new o.q(this);return this.timelines.push(e),e}addEventsToTimeline(e,t,r,i,a){if(!i)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&i==this.liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!this.filter||(e=this.filter.filterRoomTimeline(e),e.length)){var c=t?o.q.BACKWARDS:o.q.FORWARDS,l=t?o.q.FORWARDS:o.q.BACKWARDS,d=!1,u=!1;for(var h of e){var v=h.getId(),p=this._eventIdToTimeline.get(v);if(p)if(u=!1,p!=i){var f=i.getNeighbouringTimeline(c);if(f)n(p==f?"Event "+v+" in neighbouring timeline - switching to "+p:"Event "+v+" already in a different timeline "+p),i=p;else{s.v.info("Already have timeline for "+v+" - joining timeline "+i+" to "+p);var g=p===this.liveTimeline,m=i===this.liveTimeline,y=c===o.q.BACKWARDS&&g,S=c===o.q.FORWARDS&&m;y||S?(y&&s.v.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+p+")"),S&&s.v.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+i+")")):(i.setNeighbouringTimeline(p,c),p.setNeighbouringTimeline(i,l),i=p,d=!0)}}else n("Event "+v+" already in timeline "+i);else this.addEventToTimeline(h,i,{toStartOfTimeline:t,addToState:r}),u=!0,d=!0}if(u||!d){if(c===o.q.FORWARDS&&i===this.liveTimeline)return s.v.warn({lastEventWasNew:u,didUpdate:d}),void s.v.warn("Refusing to set forwards pagination token of live timeline "+"".concat(i," to ").concat(a));i.setPaginationToken(null!==a&&void 0!==a?a:null,c)}}}addLiveEvent(e,t){var{duplicateStrategy:r,fromCache:i,roomState:s,timelineWasEmpty:a,addToState:c}=t;if(this.filter){var l=this.filter.filterRoomTimeline([e]);if(!l.length)return}var d=this._eventIdToTimeline.get(e.getId());if(d)if(r===u.Replace){n("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var h=d.getEvents(),v=0;v<h.length;v++)if(h[v].getId()===e.getId()){s||(s=d.getState(o.q.FORWARDS)),o.q.setEventMetadata(e,s,!1),h[v]=e;break}}else n("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,fromCache:i,roomState:s,timelineWasEmpty:a,addToState:c})}addEventToTimeline(e,t,r){var n,{toStartOfTimeline:i,fromCache:o=!1,roomState:c,timelineWasEmpty:l,addToState:d}=r;if(t.getTimelineSet()!==this)throw new Error("EventTimelineSet.addEventToTimeline: Timeline=".concat(t.toString(),' does not belong " +\n                "in timelineSet(threadId=').concat(null===(n=this.thread)||void 0===n?void 0:n.id,")"));var u=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var h,v="event=".concat(u);return e.threadRootId&&(v+="(belongs to thread=".concat(e.threadRootId,")")),void s.v.warn("EventTimelineSet.addEventToTimeline: Ignoring ".concat(v," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat(null===(h=this.thread)||void 0===h?void 0:h.id,")"))}t.addEvent(e,{toStartOfTimeline:i,roomState:c,timelineWasEmpty:l,addToState:d}),this._eventIdToTimeline.set(u,t);var p={timeline:t,liveEvent:!i&&t==this.liveTimeline&&!o};this.emit(a.u9.Timeline,e,this.room,Boolean(i),!1,p)}insertEventIntoTimeline(e,t,r,n){var i;if(t.getTimelineSet()!==this)throw new Error("EventTimelineSet.insertEventIntoTimeline: Timeline=".concat(t.toString(),' does not belong " +\n                "in timelineSet(threadId=').concat(null===(i=this.thread)||void 0===i?void 0:i.id,")"));var o=e.getId();if(this.relations.aggregateParentEvent(e),this.relations.aggregateChildEvent(e,this),this.room&&!this.canContain(e)){var c,l="event=".concat(o);return e.threadRootId&&(l+="(belongs to thread=".concat(e.threadRootId,")")),void s.v.warn("EventTimelineSet.insertEventIntoTimeline: Ignoring ".concat(l," that does not belong ")+"in timeline=".concat(t.toString()," timelineSet(threadId=").concat(null===(c=this.thread)||void 0===c?void 0:c.id,")"))}var d=e.relationEventId;if(d){for(var u=this.findEventById(d),h=t.getEvents(),v=void 0!==u?h.indexOf(u):0,p=v;p<h.length;p++){var f=h[p];if(f.getTs()>e.getTs())break}t.insertEvent(e,p,r,n),this._eventIdToTimeline.set(o,t);var g={timeline:t,liveEvent:!1};this.emit(a.u9.Timeline,e,this.room,!1,!1,g)}else this.addEventToTimeline(e,t,{toStartOfTimeline:!1,fromCache:!1,timelineWasEmpty:!1,roomState:r,addToState:n})}handleRemoteEcho(e,t,r){var n=this._eventIdToTimeline.get(t);n?(this._eventIdToTimeline.delete(t),this._eventIdToTimeline.set(r,n)):this.filter&&!this.filter.filterRoomTimeline([e]).length||this.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:!1,addToState:!1})}removeEvent(e){var t=this._eventIdToTimeline.get(e);if(!t)return null;var r=t.removeEvent(e);if(r){this._eventIdToTimeline.delete(e);var n={timeline:t};this.emit(a.u9.Timeline,r,this.room,void 0,!0,n)}return r}compareEventOrdering(e,t){if(e==t)return 0;var r=this._eventIdToTimeline.get(e),n=this._eventIdToTimeline.get(t);if(void 0===r)return null;if(void 0===n)return null;if(r===n){for(var i=void 0,s=void 0,a=r.getEvents(),c=0;c<a.length&&(void 0===i||void 0===s);c++){var l=a[c].getId();l==e&&(i=c),l==t&&(s=c)}var d=i-s;return d<0?-1:d>0?1:0}var u=r;while(u){if(u===n)return-1;u=u.getNeighbouringTimeline(o.q.FORWARDS)}u=r;while(u){if(u===n)return 1;u=u.getNeighbouringTimeline(o.q.BACKWARDS)}return null}canContain(e){if(!this.room)throw new Error("Cannot call `EventTimelineSet::canContain without a `room` set. Set the room when creating the EventTimelineSet to call this method.");var t,{threadId:r,shouldLiveInRoom:n,shouldLiveInThread:i}=this.room.eventShouldLiveIn(e);if(this.thread)return this.thread.id===r;n||i||s.v.warn("EventTimelineSet:canContain event encountered which cannot be added to any timeline roomId=".concat(null===(t=this.room)||void 0===t?void 0:t.roomId," eventId=").concat(e.getId()," threadId=").concat(e.threadRootId));return n}}},1366:function(e,t,r){"use strict";r.d(t,{O:function(){return i}});r(8111),r(1701);var n=r(4761);class i extends Error{constructor(e,t,r){super(t),this.code=e,(0,n.A)(this,"detailedString",void 0),this.name="DecryptionError",this.detailedString=o(this,r)}}function o(e,t){var r=e.name+"[msg: "+e.message;return t&&(r+=", "+Object.keys(t).map((e=>e+": "+t[e])).join(", ")),r+="]",r}},1396:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.EmoteEvent=void 0;var i=r(4477),o=r(1711),s=r(1880);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t,r){return t&&l(e.prototype,t),r&&l(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(){return u="undefined"!==typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=h(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},u.apply(this,arguments)}function h(e,t){while(!Object.prototype.hasOwnProperty.call(e,t))if(e=S(e),null===e)break;return e}function v(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function f(e){var t=y();return function(){var r,n=S(e);if(t){var i=S(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return g(this,r)}}function g(e,t){if(t&&("object"===n(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return m(e)}function m(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}var b=function(e){v(r,e);var t=f(r);function r(e){return c(this,r),t.call(this,e)}return d(r,[{key:"isEmote",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,o.M_EMOTE)||u(S(r.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=u(S(r.prototype),"serialize",this).call(this);return e.content["msgtype"]="m.emote",e}}],[{key:"from",value:function(e,t){var n;return new r({type:o.M_EMOTE.name,content:(n={},a(n,o.M_TEXT.name,e),a(n,o.M_HTML.name,t),n)})}}]),r}(i.MessageEvent);t.EmoteEvent=b},1423:function(e,t,r){"use strict";r.d(t,{K:function(){return s},U:function(){return o}});r(4114);var n=r(4761),i=r(2668),o=function(e){return e["DisplayName"]="User.displayName",e["AvatarUrl"]="User.avatarUrl",e["Presence"]="User.presence",e["CurrentlyActive"]="User.currentlyActive",e["LastPresenceTs"]="User.lastPresenceTs",e}({});class s extends i.X{constructor(e){super(),this.userId=e,(0,n.A)(this,"modified",-1),(0,n.A)(this,"displayName",void 0),(0,n.A)(this,"rawDisplayName",void 0),(0,n.A)(this,"avatarUrl",void 0),(0,n.A)(this,"presenceStatusMsg",void 0),(0,n.A)(this,"presence","offline"),(0,n.A)(this,"lastActiveAgo",0),(0,n.A)(this,"lastPresenceTs",0),(0,n.A)(this,"currentlyActive",!1),(0,n.A)(this,"events",{}),this.displayName=e,this.rawDisplayName=e,this.updateModifiedTime()}static createUser(e,t){var r=new s(e);return t.reEmitter.reEmit(r,[o.AvatarUrl,o.DisplayName,o.Presence,o.CurrentlyActive,o.LastPresenceTs]),r}setPresenceEvent(e){if("m.presence"===e.getType()){var t=null===this.events.presence;this.events.presence=e;var r=[];for(var n of((e.getContent().presence!==this.presence||t)&&r.push(o.Presence),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push(o.AvatarUrl),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push(o.DisplayName),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&r.push(o.CurrentlyActive),this.presence=e.getContent().presence,r.push(o.LastPresenceTs),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this.updateModifiedTime(),r))this.emit(n,e,this)}}setDisplayName(e){var t=this.displayName;this.displayName=e,e!==t&&this.updateModifiedTime()}setRawDisplayName(e){this.rawDisplayName=e}setAvatarUrl(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this.updateModifiedTime()}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getLastActiveTs(){return this.lastPresenceTs-this.lastActiveAgo}}},1459:function(e,t,r){r(4114),r(8111),r(7588);var n=r(5555),i=/%[sdv%]/g,o=function(e){var t=1,r=arguments,n=r.length;return e.replace(i,(function(e){if(t>=n)return e;var i=r[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}}))},s=function(e,t,r){var n=t.format instanceof Function?t.format(t.push?r:r[t.name]):t.format,i=[e+"="+n];if(t.names)for(var s=0;s<t.names.length;s+=1){var a=t.names[s];t.name?i.push(r[t.name][a]):i.push(r[t.names[s]])}else i.push(r[t.name]);return o.apply(null,i)},a=["v","o","s","i","u","e","p","c","b","t","r","z","a"],c=["i","c","b","a"];e.exports=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var r=t.outerOrder||a,i=t.innerOrder||c,o=[];return r.forEach((function(t){n[t].forEach((function(r){r.name in e&&null!=e[r.name]?o.push(s(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){o.push(s(t,r,e))}))}))})),e.media.forEach((function(e){o.push(s("m",n.m[0],e)),i.forEach((function(t){n[t].forEach((function(r){r.name in e&&null!=e[r.name]?o.push(s(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){o.push(s(t,r,e))}))}))}))})),o.join("\r\n")+"\r\n"}},1548:function(e,t,r){"use strict";var n=r(4576),i=r(9039),o=r(9519),s=r(4215),a=n.structuredClone;e.exports=!!a&&!i((function(){if("DENO"===s&&o>92||"NODE"===s&&o>94||"BROWSER"===s&&o>97)return!1;var e=new ArrayBuffer(8),t=a(e,{transfer:[e]});return 0!==e.byteLength||8!==t.byteLength}))},1550:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.NoticeEvent=void 0;var i=r(4477),o=r(1711),s=r(1880);function a(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function l(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function d(e,t,r){return t&&l(e.prototype,t),r&&l(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function u(){return u="undefined"!==typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=h(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},u.apply(this,arguments)}function h(e,t){while(!Object.prototype.hasOwnProperty.call(e,t))if(e=S(e),null===e)break;return e}function v(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&p(e,t)}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function f(e){var t=y();return function(){var r,n=S(e);if(t){var i=S(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return g(this,r)}}function g(e,t){if(t&&("object"===n(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return m(e)}function m(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function y(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}var b=function(e){v(r,e);var t=f(r);function r(e){return c(this,r),t.call(this,e)}return d(r,[{key:"isNotice",get:function(){return!0}},{key:"isEquivalentTo",value:function(e){return(0,s.isEventTypeSame)(e,o.M_NOTICE)||u(S(r.prototype),"isEquivalentTo",this).call(this,e)}},{key:"serialize",value:function(){var e=u(S(r.prototype),"serialize",this).call(this);return e.content["msgtype"]="m.notice",e}}],[{key:"from",value:function(e,t){var n;return new r({type:o.M_NOTICE.name,content:(n={},a(n,o.M_TEXT.name,e),a(n,o.M_HTML.name,t),n)})}}]),r}(i.MessageEvent);t.NoticeEvent=b},1575:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}r(4114),r(8111),r(2489),r(7588),Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiResponseError=t.WidgetApi=void 0;var i=r(9366),o=r(6819),s=r(8614),a=r(7223),c=r(8098),l=r(6327),d=r(1954),u=r(5030),h=r(8848),v=r(3378);function p(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */
p=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},o="function"==typeof Symbol?Symbol:{},s=o.iterator||"@@iterator",a=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function l(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(O){l=function(e,t,r){return e[t]=r}}function d(e,t,r,n){var o=t&&t.prototype instanceof v?t:v,s=Object.create(o.prototype),a=new k(n||[]);return i(s,"_invoke",{value:w(e,r,a)}),s}function u(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(O){return{type:"throw",arg:O}}}e.wrap=d;var h={};function v(){}function f(){}function g(){}var m={};l(m,s,(function(){return this}));var y=Object.getPrototypeOf,S=y&&y(y(A([])));S&&S!==t&&r.call(S,s)&&(m=S);var b=g.prototype=v.prototype=Object.create(m);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function _(e,t){function o(i,s,a,c){var l=u(e[i],e,s);if("throw"!==l.type){var d=l.arg,h=d.value;return h&&"object"==n(h)&&r.call(h,"__await")?t.resolve(h.__await).then((function(e){o("next",e,a,c)}),(function(e){o("throw",e,a,c)})):t.resolve(h).then((function(e){d.value=e,a(d)}),(function(e){return o("throw",e,a,c)}))}c(l.arg)}var s;i(this,"_invoke",{value:function(e,r){function n(){return new t((function(t,n){o(e,r,t,n)}))}return s=s?s.then(n,n):n()}})}function w(e,t,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return C()}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=I(s,r);if(a){if(a===h)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=u(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===h)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}function I(e,t){var r=t.method,n=e.iterator[r];if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator["return"]&&(t.method="return",t.arg=void 0,I(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),h;var i=u(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,h;var o=i.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,h):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,h)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function A(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:C}}function C(){return{value:void 0,done:!0}}return f.prototype=g,i(b,"constructor",{value:g,configurable:!0}),i(g,"constructor",{value:f,configurable:!0}),f.displayName=l(g,c,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===f||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,g):(e.__proto__=g,l(e,c,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},E(_.prototype),l(_.prototype,a,(function(){return this})),e.AsyncIterator=_,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new _(d(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},E(b),l(b,c,"Generator"),l(b,s,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=A,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,h):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;R(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:A(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),h}},e}function f(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(l){return void r(l)}a.done?t(c):Promise.resolve(c).then(n,i)}function g(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function s(e){f(o,n,i,s,a,"next",e)}function a(e){f(o,n,i,s,a,"throw",e)}s(void 0)}))}}function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach((function(t){S(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function S(e,t,r){return t=_(t),t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function b(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_(n.key),n)}}function E(e,t,r){return t&&b(e.prototype,t),r&&b(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _(e){var t=w(e,"string");return"symbol"===n(t)?t:String(t)}function w(e,t){if("object"!==n(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function I(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function T(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&P(e,t)}function R(e){var t=D();return function(){var r,n=x(e);if(t){var i=x(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return k(this,r)}}function k(e,t){if(t&&("object"===n(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return A(e)}function A(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function C(e){var t="function"===typeof Map?new Map:void 0;return C=function(e){if(null===e||!M(e))return e;if("function"!==typeof e)throw new TypeError("Super expression must either be null or a function");if("undefined"!==typeof t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return O(e,arguments,x(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),P(r,e)},C(e)}function O(e,t,r){return O=D()?Reflect.construct.bind():function(e,t,r){var n=[null];n.push.apply(n,t);var i=Function.bind.apply(e,n),o=new i;return r&&P(o,r.prototype),o},O.apply(null,arguments)}function D(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function M(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function P(e,t){return P=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},P(e,t)}function x(e){return x=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},x(e)}function U(e){return new B(e,0)}function L(e){return function(){return new N(e.apply(this,arguments))}}function N(e){var t,r;function n(t,r){try{var o=e[t](r),s=o.value,a=s instanceof B;Promise.resolve(a?s.v:s).then((function(r){if(a){var c="return"===t?"return":"next";if(!s.k||r.done)return n(c,r);r=e[c](r).value}i(o.done?"return":"normal",r)}),(function(e){n("throw",e)}))}catch(c){i("throw",c)}}function i(e,i){switch(e){case"return":t.resolve({value:i,done:!0});break;case"throw":t.reject(i);break;default:t.resolve({value:i,done:!1})}(t=t.next)?n(t.key,t.arg):r=null}this._invoke=function(e,i){return new Promise((function(o,s){var a={key:e,arg:i,resolve:o,reject:s,next:null};r?r=r.next=a:(t=r=a,n(e,i))}))},"function"!=typeof e["return"]&&(this["return"]=void 0)}function B(e,t){this.v=e,this.k=t}N.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},N.prototype.next=function(e){return this._invoke("next",e)},N.prototype["throw"]=function(e){return this._invoke("throw",e)},N.prototype["return"]=function(e){return this._invoke("return",e)};var K=function(e){T(r,e);var t=R(r);function r(e,n){var i;return I(this,r),i=t.call(this,e),i.data=n,i}return E(r)}(C(Error));t.WidgetApiResponseError=K,K.prototype.name=K.name;var F=function(e){T(r,e);var t=R(r);function r(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(I(this,r),e=t.call(this),e.clientOrigin=i,S(A(e),"transport",void 0),S(A(e),"capabilitiesFinished",!1),S(A(e),"supportsMSC2974Renegotiate",!1),S(A(e),"requestedCapabilities",[]),S(A(e),"approvedCapabilities",void 0),S(A(e),"cachedClientVersions",void 0),S(A(e),"turnServerWatchers",0),!window.parent)throw new Error("No parent window. This widget doesn't appear to be embedded properly.");return e.transport=new a.PostmessageTransport(o.WidgetApiDirection.FromWidget,n,window.parent,window),e.transport.targetOrigin=i,e.transport.on("message",e.handleMessage.bind(A(e))),e}return E(r,[{key:"hasCapability",value:function(e){return Array.isArray(this.approvedCapabilities)?this.approvedCapabilities.includes(e):this.requestedCapabilities.includes(e)}},{key:"requestCapability",value:function(e){if(this.capabilitiesFinished&&!this.supportsMSC2974Renegotiate)throw new Error("Capabilities have already been negotiated");this.requestedCapabilities.push(e)}},{key:"requestCapabilities",value:function(e){var t=this;e.forEach((function(e){return t.requestCapability(e)}))}},{key:"requestCapabilityForRoomTimeline",value:function(e){this.requestCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"requestCapabilityToSendState",value:function(e,t){this.requestCapability(h.WidgetEventCapability.forStateEvent(h.EventDirection.Send,e,t).raw)}},{key:"requestCapabilityToReceiveState",value:function(e,t){this.requestCapability(h.WidgetEventCapability.forStateEvent(h.EventDirection.Receive,e,t).raw)}},{key:"requestCapabilityToSendToDevice",value:function(e){this.requestCapability(h.WidgetEventCapability.forToDeviceEvent(h.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveToDevice",value:function(e){this.requestCapability(h.WidgetEventCapability.forToDeviceEvent(h.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendEvent",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomEvent(h.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveEvent",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomEvent(h.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToSendMessage",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomMessageEvent(h.EventDirection.Send,e).raw)}},{key:"requestCapabilityToReceiveMessage",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomMessageEvent(h.EventDirection.Receive,e).raw)}},{key:"requestCapabilityToReceiveRoomAccountData",value:function(e){this.requestCapability(h.WidgetEventCapability.forRoomAccountData(h.EventDirection.Receive,e).raw)}},{key:"requestOpenIDConnectToken",value:function(){var e=this;return new Promise((function(t,r){e.transport.sendComplete(c.WidgetApiFromWidgetAction.GetOpenIDCredentials,{}).then((function(n){var i=n.response;if(i.state===l.OpenIDRequestState.Allowed)t(i);else if(i.state===l.OpenIDRequestState.Blocked)r(new Error("User declined to verify their identity"));else if(i.state===l.OpenIDRequestState.PendingUserConfirmation){var o=function o(s){s.preventDefault();var a=s.detail;a.data.original_request_id===n.requestId&&(a.data.state===l.OpenIDRequestState.Allowed?(t(a.data),e.transport.reply(a,{})):a.data.state===l.OpenIDRequestState.Blocked?(r(new Error("User declined to verify their identity")),e.transport.reply(a,{})):(r(new Error("Invalid state on reply: "+i.state)),e.transport.reply(a,{error:{message:"Invalid state"}})),e.off("action:".concat(c.WidgetApiToWidgetAction.OpenIDCredentials),o))};e.on("action:".concat(c.WidgetApiToWidgetAction.OpenIDCredentials),o)}else r(new Error("Invalid state: "+i.state))}))["catch"](r)}))}},{key:"updateRequestedCapabilities",value:function(){return this.transport.send(c.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities,{capabilities:this.requestedCapabilities}).then()}},{key:"sendContentLoaded",value:function(){return this.transport.send(c.WidgetApiFromWidgetAction.ContentLoaded,{}).then()}},{key:"sendSticker",value:function(e){return this.transport.send(c.WidgetApiFromWidgetAction.SendSticker,e).then()}},{key:"setAlwaysOnScreen",value:function(e){return this.transport.send(c.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,{value:e}).then((function(e){return e.success}))}},{key:"openModalWidget",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:d.MatrixWidgetType.Custom;return this.transport.send(c.WidgetApiFromWidgetAction.OpenModalWidget,{type:i,url:e,name:t,buttons:r,data:n}).then()}},{key:"closeModalWidget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.transport.send(c.WidgetApiFromWidgetAction.CloseModalWidget,e).then()}},{key:"sendRoomEvent",value:function(e,t,r,n,i){return this.sendEvent(e,void 0,t,r,n,i)}},{key:"sendStateEvent",value:function(e,t,r,n,i,o){return this.sendEvent(e,t,r,n,i,o)}},{key:"sendEvent",value:function(e,t,r,n,i,o){return this.transport.send(c.WidgetApiFromWidgetAction.SendEvent,y(y(y(y({type:e,content:r},void 0!==t&&{state_key:t}),void 0!==n&&{room_id:n}),void 0!==i&&{delay:i}),void 0!==o&&{parent_delay_id:o}))}},{key:"updateDelayedEvent",value:function(e,t){return this.transport.send(c.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent,{delay_id:e,action:t})}},{key:"sendToDevice",value:function(e,t,r){return this.transport.send(c.WidgetApiFromWidgetAction.SendToDevice,{type:e,encrypted:t,messages:r})}},{key:"readRoomAccountData",value:function(e,t){var r={type:e};return t&&(t.includes(v.Symbols.AnyRoom)?r.room_ids=v.Symbols.AnyRoom:r.room_ids=t),this.transport.send(c.WidgetApiFromWidgetAction.BeeperReadRoomAccountData,r).then((function(e){return e.events}))}},{key:"readRoomEvents",value:function(e,t,r,n,i){var o={type:e,msgtype:r};return void 0!==t&&(o.limit=t),n&&(n.includes(v.Symbols.AnyRoom)?o.room_ids=v.Symbols.AnyRoom:o.room_ids=n),i&&(o.since=i),this.transport.send(c.WidgetApiFromWidgetAction.MSC2876ReadEvents,o).then((function(e){return e.events}))}},{key:"readEventRelations",value:function(){var e=g(p().mark((function e(t,r,n,i,o,a,l,d){var u,h;return p().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(u=e.sent,u.includes(s.UnstableApiVersion.MSC3869)){e.next=5;break}throw new Error("The read_relations action is not supported by the client.");case 5:return h={event_id:t,rel_type:n,event_type:i,room_id:r,to:l,from:a,limit:o,direction:d},e.abrupt("return",this.transport.send(c.WidgetApiFromWidgetAction.MSC3869ReadRelations,h));case 7:case"end":return e.stop()}}),e,this)})));function t(t,r,n,i,o,s,a,c){return e.apply(this,arguments)}return t}()},{key:"readStateEvents",value:function(e,t,r,n){var i={type:e,state_key:void 0===r||r};return void 0!==t&&(i.limit=t),n&&(n.includes(v.Symbols.AnyRoom)?i.room_ids=v.Symbols.AnyRoom:i.room_ids=n),this.transport.send(c.WidgetApiFromWidgetAction.MSC2876ReadEvents,i).then((function(e){return e.events}))}},{key:"setModalButtonEnabled",value:function(e,t){if(e===u.BuiltInModalButtonID.Close)throw new Error("The close button cannot be disabled");return this.transport.send(c.WidgetApiFromWidgetAction.SetModalButtonEnabled,{button:e,enabled:t}).then()}},{key:"navigateTo",value:function(e){if(!e||!e.startsWith("https://matrix.to/#"))throw new Error("Invalid matrix.to URI");return this.transport.send(c.WidgetApiFromWidgetAction.MSC2931Navigate,{uri:e}).then()}},{key:"getTurnServers",value:function(){var e=this;return L(p().mark((function t(){var r,n;return p().wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(n=function(){var t=g(p().mark((function t(n){return p().wrap((function(t){while(1)switch(t.prev=t.next){case 0:return n.preventDefault(),r(n.detail.data),t.next=4,e.transport.reply(n.detail,{});case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}(),e.on("action:".concat(c.WidgetApiToWidgetAction.UpdateTurnServers),n),0!==e.turnServerWatchers){t.next=12;break}return t.prev=3,t.next=6,U(e.transport.send(c.WidgetApiFromWidgetAction.WatchTurnServers,{}));case 6:t.next=12;break;case 8:throw t.prev=8,t.t0=t["catch"](3),e.off("action:".concat(c.WidgetApiToWidgetAction.UpdateTurnServers),n),t.t0;case 12:e.turnServerWatchers++,t.prev=13;case 14:return t.next=17,U(new Promise((function(e){return r=e})));case 17:return t.next=19,t.sent;case 19:t.next=14;break;case 21:if(t.prev=21,e.off("action:".concat(c.WidgetApiToWidgetAction.UpdateTurnServers),n),e.turnServerWatchers--,0!==e.turnServerWatchers){t.next=27;break}return t.next=27,U(e.transport.send(c.WidgetApiFromWidgetAction.UnwatchTurnServers,{}));case 27:return t.finish(21);case 28:case"end":return t.stop()}}),t,null,[[3,8],[13,,21,28]])})))()}},{key:"searchUserDirectory",value:function(){var e=g(p().mark((function e(t,r){var n,i;return p().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(n=e.sent,n.includes(s.UnstableApiVersion.MSC3973)){e.next=5;break}throw new Error("The user_directory_search action is not supported by the client.");case 5:return i={search_term:t,limit:r},e.abrupt("return",this.transport.send(c.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch,i));case 7:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"getMediaConfig",value:function(){var e=g(p().mark((function e(){var t,r;return p().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(t=e.sent,t.includes(s.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The get_media_config action is not supported by the client.");case 5:return r={},e.abrupt("return",this.transport.send(c.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction,r));case 7:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"uploadFile",value:function(){var e=g(p().mark((function e(t){var r,n;return p().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(r=e.sent,r.includes(s.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The upload_file action is not supported by the client.");case 5:return n={file:t},e.abrupt("return",this.transport.send(c.WidgetApiFromWidgetAction.MSC4039UploadFileAction,n));case 7:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"downloadFile",value:function(){var e=g(p().mark((function e(t){var r,n;return p().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.getClientVersions();case 2:if(r=e.sent,r.includes(s.UnstableApiVersion.MSC4039)){e.next=5;break}throw new Error("The download_file action is not supported by the client.");case 5:return n={content_uri:t},e.abrupt("return",this.transport.send(c.WidgetApiFromWidgetAction.MSC4039DownloadFileAction,n));case 7:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"start",value:function(){var e=this;this.transport.start(),this.getClientVersions().then((function(t){t.includes(s.UnstableApiVersion.MSC2974)&&(e.supportsMSC2974Renegotiate=!0)}))}},{key:"handleMessage",value:function(e){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case c.WidgetApiToWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case c.WidgetApiToWidgetAction.Capabilities:return this.handleCapabilities(e.detail);case c.WidgetApiToWidgetAction.UpdateVisibility:return this.transport.reply(e.detail,{});case c.WidgetApiToWidgetAction.NotifyCapabilities:return this.transport.reply(e.detail,{});default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:s.CurrentApiVersions})}},{key:"getClientVersions",value:function(){var e=this;return Array.isArray(this.cachedClientVersions)?Promise.resolve(this.cachedClientVersions):this.transport.send(c.WidgetApiFromWidgetAction.SupportedApiVersions,{}).then((function(t){return e.cachedClientVersions=t.supported_versions,t.supported_versions}))["catch"]((function(e){return console.warn("non-fatal error getting supported client versions: ",e),[]}))}},{key:"handleCapabilities",value:function(e){var t=this;return this.capabilitiesFinished?this.transport.reply(e,{error:{message:"Capability negotiation already completed"}}):this.getClientVersions().then((function(r){return r.includes(s.UnstableApiVersion.MSC2871)?t.once("action:".concat(c.WidgetApiToWidgetAction.NotifyCapabilities),(function(e){t.approvedCapabilities=e.detail.data.approved,t.emit("ready")})):t.emit("ready"),t.capabilitiesFinished=!0,t.transport.reply(e,{capabilities:t.requestedCapabilities})}))}}]),r}(i.EventEmitter);t.WidgetApi=F},1625:function(e,t,r){"use strict";var n=r(9504);e.exports=n({}.isPrototypeOf)},1658:function(e,t,r){"use strict";var n=r(6518),i=r(6469),o=r(6837),s=r(6198),a=r(5610),c=r(5397),l=r(1291),d=Array,u=Math.max,h=Math.min;n({target:"Array",proto:!0},{toSpliced:function(e,t){var r,n,i,v,p=c(this),f=s(p),g=a(e,f),m=arguments.length,y=0;for(0===m?r=n=0:1===m?(r=0,n=f-g):(r=m-2,n=h(u(l(t),0),f-g)),i=o(f+r-n),v=d(i);y<g;y++)v[y]=p[y];for(;y<g+r;y++)v[y]=arguments[y-g+2];for(;y<i;y++)v[y]=p[y+n-r];return v}}),i("toSpliced")},1698:function(e,t,r){"use strict";var n=r(6518),i=r(4204),o=r(4916);n({target:"Set",proto:!0,real:!0,forced:!o("union")},{union:i})},1701:function(e,t,r){"use strict";var n=r(6518),i=r(713),o=r(6395);n({target:"Iterator",proto:!0,real:!0,forced:o},{map:i})},1711:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_TEXT=t.M_NOTICE=t.M_MESSAGE=t.M_HTML=t.M_EMOTE=void 0;var n=r(6288),i=new n.UnstableValue("m.message","org.matrix.msc1767.message");t.M_MESSAGE=i;var o=new n.UnstableValue("m.text","org.matrix.msc1767.text");t.M_TEXT=o;var s=new n.UnstableValue("m.html","org.matrix.msc1767.html");t.M_HTML=s;var a=new n.UnstableValue("m.emote","org.matrix.msc1767.emote");t.M_EMOTE=a;var c=new n.UnstableValue("m.notice","org.matrix.msc1767.notice");t.M_NOTICE=c},1767:function(e){"use strict";e.exports=function(e){return{iterator:e,next:e.next,done:!1}}},1828:function(e,t,r){"use strict";var n=r(9504),i=r(9297),o=r(5397),s=r(9617).indexOf,a=r(421),c=n([].push);e.exports=function(e,t){var r,n=o(e),l=0,d=[];for(r in n)!i(a,r)&&i(n,r)&&c(d,r);while(t.length>l)i(n,r=t[l++])&&(~s(d,r)||c(d,r));return d}},1880:function(e,t){"use strict";function r(e,t){if("string"===typeof e)return"string"===typeof t?t===e:t.matches(e);if("string"===typeof t)return e.matches(t);var r=t,n=e;return r.matches(n.name)||r.matches(n.altName)}Object.defineProperty(t,"__esModule",{value:!0}),t.isEventTypeSame=r},1915:function(e,t,r){"use strict";r.r(t),r.d(t,{SECRET_STORAGE_ALGORITHM_V1_AES:function(){return l},ServerSideSecretStorageImpl:function(){return d},calculateKeyCheck:function(){return v},trimTrailingEquals:function(){return u}});var n=r(698),i=r(4108),o=r(9553),s=r(3271),a=r(3571),c=r(4519),l="m.secret_storage.v1.aes-hmac-sha2";class d{constructor(e,t){this.accountDataAdapter=e,this.callbacks=t}getDefaultKeyId(){var e=this;return(0,n.A)((function*(){var t,r=yield e.accountDataAdapter.getAccountDataFromServer("m.secret_storage.default_key");return r&&null!==(t=r.key)&&void 0!==t?t:null}))()}setDefaultKeyId(e){return new Promise(((t,r)=>{var n=r=>{if("m.secret_storage.default_key"===r.getType()){var o=r.getContent(),s=null===e?0===Object.keys(o).length:o.key===e;s&&(this.accountDataAdapter.removeListener(i.AU.AccountData,n),t())}};this.accountDataAdapter.on(i.AU.AccountData,n);var o=null===e?{}:{key:e};this.accountDataAdapter.setAccountData("m.secret_storage.default_key",o).catch((e=>{this.accountDataAdapter.removeListener(i.AU.AccountData,n),r(e)}))}))}addKey(e,t,r){var i=this;return(0,n.A)((function*(){if(e!==l)throw new Error("Unknown key algorithm ".concat(e));var n={algorithm:e};t.name&&(n.name=t.name),t.passphrase&&(n.passphrase=t.passphrase);var{iv:s,mac:a}=yield v(t.key);if(n.iv=s,n.mac=a,!r)do{r=(0,o.US)(32)}while(yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(r)));return yield i.accountDataAdapter.setAccountData("m.secret_storage.key.".concat(r),n),{keyId:r,keyInfo:n}}))()}getKey(e){var t=this;return(0,n.A)((function*(){if(e||(e=yield t.getDefaultKeyId()),!e)return null;var r=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(e));return r?[e,r]:null}))()}hasKey(e){var t=this;return(0,n.A)((function*(){var r=yield t.getKey(e);return Boolean(r)}))()}checkKey(e,t){return(0,n.A)((function*(){if(t.algorithm===l){if(t.mac){var{mac:r}=yield v(e,t.iv);return u(t.mac)===u(r)}return!0}throw new Error("Unknown algorithm")}))()}store(e,t,r){var i=this;return(0,n.A)((function*(){var n={};if(!r){var o=yield i.getDefaultKeyId();if(!o)throw new Error("No keys specified and no default key present");r=[o]}if(0===r.length)throw new Error("Zero keys given to encrypt with!");for(var a of r){var c=yield i.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(a));if(!c)throw new Error("Unknown key: "+a);if(c.algorithm===l){var d={[a]:c},[,u]=yield i.getSecretStorageKey(d,e);n[a]=yield u.encrypt(t)}else s.v.warn("unknown algorithm for secret storage key "+a+": "+c.algorithm)}yield i.accountDataAdapter.setAccountData(e,{encrypted:n})}))()}get(e){var t=this;return(0,n.A)((function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(r){if(!r.encrypted)throw new Error("Content is not encrypted!");var n={};for(var i of Object.keys(r.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(i)),s=r.encrypted[i];(null===o||void 0===o?void 0:o.algorithm)===l&&s.iv&&s.ciphertext&&s.mac&&(n[i]=o)}if(0===Object.keys(n).length)throw new Error("Could not decrypt ".concat(e," because none of ")+"the keys it is encrypted with are for a supported algorithm");var[a,c]=yield t.getSecretStorageKey(n,e),d=r.encrypted[a];return c.decrypt(d)}}))()}isStored(e){var t=this;return(0,n.A)((function*(){var r=yield t.accountDataAdapter.getAccountDataFromServer(e);if(null===r||void 0===r||!r.encrypted)return null;var n={};for(var i of Object.keys(r.encrypted)){var o=yield t.accountDataAdapter.getAccountDataFromServer("m.secret_storage.key.".concat(i));if(o){var s=r.encrypted[i];o.algorithm===l&&s.iv&&s.ciphertext&&s.mac&&(n[i]=o)}}return Object.keys(n).length?n:null}))()}getSecretStorageKey(e,t){var r=this;return(0,n.A)((function*(){if(!r.callbacks.getSecretStorageKey)throw new Error("No getSecretStorageKey callback supplied");var n=yield r.callbacks.getSecretStorageKey({keys:e},t);if(!n)throw new Error("getSecretStorageKey callback returned falsey");if(n.length<2)throw new Error("getSecretStorageKey callback returned invalid data");var[i,o]=n;if(!e[i])throw new Error("App returned unknown key from getSecretStorageKey!");if(e[i].algorithm===l){var s={encrypt:function(e){return(0,a.A)(e,o,t)},decrypt:function(e){return(0,c.A)(e,o,t)}};return[i,s]}throw new Error("Unknown key type: "+e[i].algorithm)}))()}}function u(e){var t=e.length;while(t>=1&&61==e.charCodeAt(t-1))t--;return t<e.length?e.substring(0,t):e}var h="\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0";function v(e,t){return(0,a.A)(h,e,"",t)}},1949:function(e,t,r){"use strict";r.d(t,{F:function(){return w}});r(4114);var n=r(698),i=r(3271),o=r(812),s=r(5982),a=r(6170),c="crypto.",l=c+"migration",d=c+"account",u=c+"cross_signing_keys",h=c+"notified_error_devices",v=c+"device_data",p=c+"inboundgroupsessions/",f=c+"inboundgroupsessions.withheld/",g=c+"rooms/",m=c+"sessionsneedingbackup";function y(e){return c+"sessions/"+e}function S(e){return c+"session.problems/"+e}function b(e,t){return p+e+"/"+t}function E(e,t){return f+e+"/"+t}function _(e){return g+e}class w extends o._{static exists(e){for(var t=e.length,r=0;r<t;r++){var n;if(null!==(n=e.key(r))&&void 0!==n&&n.startsWith(c))return!0}return!1}constructor(e){super(),this.store=e}containsData(){var e=this;return(0,n.A)((function*(){return w.exists(e.store)}))()}getMigrationState(){var e=this;return(0,n.A)((function*(){var t;return null!==(t=I(e.store,l))&&void 0!==t?t:s.Il.NOT_STARTED}))()}setMigrationState(e){var t=this;return(0,n.A)((function*(){T(t.store,l,e)}))()}countEndToEndSessions(e,t){for(var r=0,n=0;n<this.store.length;++n){var i=this.store.key(n);if(null!==i&&void 0!==i&&i.startsWith(y(""))){var o=I(this.store,i);r+=Object.keys(null!==o&&void 0!==o?o:{}).length}}t(r)}_getEndToEndSessions(e){var t=I(this.store,y(e)),r={};for(var[n,i]of Object.entries(t||{}))r[n]="string"===typeof i?{session:i}:i;return r}getEndToEndSession(e,t,r,n){var i,o=this._getEndToEndSessions(e);n(null!==(i=o[t])&&void 0!==i?i:{})}getEndToEndSessions(e,t,r){var n;r(null!==(n=this._getEndToEndSessions(e))&&void 0!==n?n:{})}getAllEndToEndSessions(e,t){for(var r=0;r<this.store.length;++r){var n;if(null!==(n=this.store.key(r))&&void 0!==n&&n.startsWith(y(""))){var i=this.store.key(r).split("/")[1];for(var o of Object.values(this._getEndToEndSessions(i)))t(o)}}}storeEndToEndSession(e,t,r,n){var i=this._getEndToEndSessions(e)||{};i[t]=r,T(this.store,y(e),i)}storeEndToEndSessionProblem(e,t,r){var i=this;return(0,n.A)((function*(){var n=S(e),o=I(i.store,n)||[];o.push({type:t,fixed:r,time:Date.now()}),o.sort(((e,t)=>e.time-t.time)),T(i.store,n,o)}))()}getEndToEndSessionProblem(e,t){var r=this;return(0,n.A)((function*(){var n=S(e),i=I(r.store,n)||[];if(!i.length)return null;var o=i[i.length-1];for(var s of i)if(s.time>t)return Object.assign({},s,{fixed:o.fixed});return o.fixed?null:o}))()}filterOutNotifiedErrorDevices(e){var t=this;return(0,n.A)((function*(){var r=I(t.store,h)||{},n=[];for(var i of e){var{userId:o,deviceInfo:s}=i;o in r?s.deviceId in r[o]||(n.push(i),(0,a.C6)(r[o],s.deviceId,!0)):(n.push(i),(0,a.C6)(r,o,{[s.deviceId]:!0}))}return T(t.store,h,r),n}))()}getEndToEndSessionsBatch(){var e=this;return(0,n.A)((function*(){for(var t=[],r=0;r<e.store.length;++r){var n;if(null!==(n=e.store.key(r))&&void 0!==n&&n.startsWith(y(""))){var i=e.store.key(r).split("/")[1];for(var o of Object.values(e._getEndToEndSessions(i)))if(t.push(o),t.length>=s.oT)return t}}return 0===t.length?null:t}))()}deleteEndToEndSessionsBatch(e){var t=this;return(0,n.A)((function*(){for(var{deviceKey:r,sessionId:n}of e){var i=t._getEndToEndSessions(r)||{};delete i[n],0===Object.keys(i).length?t.store.removeItem(y(r)):T(t.store,y(r),i)}}))()}getEndToEndInboundGroupSession(e,t,r,n){n(I(this.store,b(e,t)),I(this.store,E(e,t)))}getAllEndToEndInboundGroupSessions(e,t){for(var r=0;r<this.store.length;++r){var n=this.store.key(r);null!==n&&void 0!==n&&n.startsWith(p)&&t({senderKey:n.slice(p.length,p.length+43),sessionId:n.slice(p.length+44),sessionData:I(this.store,n)})}t(null)}addEndToEndInboundGroupSession(e,t,r,n){var i=I(this.store,b(e,t));i||this.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){T(this.store,b(e,t),r)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){T(this.store,E(e,t),r)}countEndToEndInboundGroupSessions(){var e=this;return(0,n.A)((function*(){for(var t=0,r=0;r<e.store.length;++r){var n=e.store.key(r);null!==n&&void 0!==n&&n.startsWith(p)&&(t+=1)}return t}))()}getEndToEndInboundGroupSessionsBatch(){var e=this;return(0,n.A)((function*(){for(var t=I(e.store,m)||{},r=[],n=0;n<e.store.length;++n){var i=e.store.key(n);if(null!==i&&void 0!==i&&i.startsWith(p)){var o=i.slice(p.length);if(r.push({senderKey:o.slice(0,43),sessionId:o.slice(44),sessionData:I(e.store,i),needsBackup:o in t}),r.length>=s.oT)return r}}return 0===r.length?null:r}))()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return(0,n.A)((function*(){for(var{senderKey:r,sessionId:n}of e){var i=b(r,n);t.store.removeItem(i)}}))()}getEndToEndDeviceData(e,t){t(I(this.store,v))}storeEndToEndDeviceData(e,t){T(this.store,v,e)}storeEndToEndRoom(e,t,r){T(this.store,_(e),t)}getEndToEndRooms(e,t){for(var r={},n=_(""),i=0;i<this.store.length;++i){var o=this.store.key(i);if(null!==o&&void 0!==o&&o.startsWith(n)){var s=o.slice(n.length);r[s]=I(this.store,o)}}t(r)}getSessionsNeedingBackup(e){var t=this,r=I(this.store,m)||{},n=[],i=function(){if(Object.prototype.hasOwnProperty.call(r,o)){var i=o.slice(0,43),s=o.slice(44);if(t.getEndToEndInboundGroupSession(i,s,null,(e=>{n.push({senderKey:i,sessionId:s,sessionData:e})})),e&&n.length>=e)return 1}};for(var o in r)if(i())break;return Promise.resolve(n)}countSessionsNeedingBackup(){var e=I(this.store,m)||{};return Promise.resolve(Object.keys(e).length)}unmarkSessionsNeedingBackup(e){var t=I(this.store,m)||{};for(var r of e)delete t[r.senderKey+"/"+r.sessionId];return T(this.store,m,t),Promise.resolve()}markSessionsNeedingBackup(e){var t=I(this.store,m)||{};for(var r of e)t[r.senderKey+"/"+r.sessionId]=!0;return T(this.store,m,t),Promise.resolve()}deleteAllData(){return this.store.removeItem(d),Promise.resolve()}getAccount(e,t){var r=I(this.store,d);t(r)}storeAccount(e,t){T(this.store,d,t)}getCrossSigningKeys(e,t){var r=I(this.store,u);t(r)}getSecretStorePrivateKey(e,t,r){var n=I(this.store,c+"ssss_cache.".concat(r));t(n)}storeCrossSigningKeys(e,t){T(this.store,u,t)}storeSecretStorePrivateKey(e,t,r){T(this.store,c+"ssss_cache.".concat(t),r)}doTxn(e,t,r){return Promise.resolve(r(null))}}function I(e,t){try{return JSON.parse(e.getItem(t))}catch(r){i.v.log("Error: Failed to get key %s: %s",t,r.message),i.v.log(r.stack)}return null}function T(e,t,r){e.setItem(t,JSON.stringify(r))}},1954:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MatrixWidgetType=void 0;var r=function(e){return e["Custom"]="m.custom",e["JitsiMeet"]="m.jitsi",e["Stickerpicker"]="m.stickerpicker",e}({});t.MatrixWidgetType=r},1996:function(e,t,r){e.exports=r(2306)},2040:function(e,t,r){"use strict";r.d(t,{C4:function(){return I},EW:function(){return Ne},Gc:function(){return me},IG:function(){return Te},IJ:function(){return Oe},KR:function(){return Ce},Kh:function(){return ge},Pr:function(){return Ue},R1:function(){return Pe},X2:function(){return l},bl:function(){return T},fE:function(){return _e},g8:function(){return be},hV:function(){return Ve},hZ:function(){return L},i9:function(){return Ae},ju:function(){return we},lJ:function(){return Re},qA:function(){return B},u4:function(){return U},ux:function(){return Ie},wB:function(){return qe},yC:function(){return s}});r(4114),r(9678),r(7145),r(1658),r(8111),r(2489),r(7588),r(1701),r(3579),r(9479),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(160);let i,o;class s{constructor(e=!1){this.detached=e,this._active=!0,this.effects=[],this.cleanups=[],this._isPaused=!1,this.parent=i,!e&&i&&(this.index=(i.scopes||(i.scopes=[])).push(this)-1)}get active(){return this._active}pause(){if(this._active){let e,t;if(this._isPaused=!0,this.scopes)for(e=0,t=this.scopes.length;e<t;e++)this.scopes[e].pause();for(e=0,t=this.effects.length;e<t;e++)this.effects[e].pause()}}resume(){if(this._active&&this._isPaused){let e,t;if(this._isPaused=!1,this.scopes)for(e=0,t=this.scopes.length;e<t;e++)this.scopes[e].resume();for(e=0,t=this.effects.length;e<t;e++)this.effects[e].resume()}}run(e){if(this._active){const t=i;try{return i=this,e()}finally{i=t}}else 0}on(){i=this}off(){i=this.parent}stop(e){if(this._active){let t,r;for(this._active=!1,t=0,r=this.effects.length;t<r;t++)this.effects[t].stop();for(this.effects.length=0,t=0,r=this.cleanups.length;t<r;t++)this.cleanups[t]();if(this.cleanups.length=0,this.scopes){for(t=0,r=this.scopes.length;t<r;t++)this.scopes[t].stop(!0);this.scopes.length=0}if(!this.detached&&this.parent&&!e){const e=this.parent.scopes.pop();e&&e!==this&&(this.parent.scopes[this.index]=e,e.index=this.index)}this.parent=void 0}}}function a(){return i}const c=new WeakSet;class l{constructor(e){this.fn=e,this.deps=void 0,this.depsTail=void 0,this.flags=5,this.next=void 0,this.cleanup=void 0,this.scheduler=void 0,i&&i.active&&i.effects.push(this)}pause(){this.flags|=64}resume(){64&this.flags&&(this.flags&=-65,c.has(this)&&(c.delete(this),this.trigger()))}notify(){2&this.flags&&!(32&this.flags)||8&this.flags||v(this)}run(){if(!(1&this.flags))return this.fn();this.flags|=2,R(this),g(this);const e=o,t=_;o=this,_=!0;try{return this.fn()}finally{0,m(this),o=e,_=t,this.flags&=-3}}stop(){if(1&this.flags){for(let e=this.deps;e;e=e.nextDep)b(e);this.deps=this.depsTail=void 0,R(this),this.onStop&&this.onStop(),this.flags&=-2}}trigger(){64&this.flags?c.add(this):this.scheduler?this.scheduler():this.runIfDirty()}runIfDirty(){y(this)&&this.run()}get dirty(){return y(this)}}let d,u,h=0;function v(e,t=!1){if(e.flags|=8,t)return e.next=u,void(u=e);e.next=d,d=e}function p(){h++}function f(){if(--h>0)return;if(u){let e=u;u=void 0;while(e){const t=e.next;e.next=void 0,e.flags&=-9,e=t}}let e;while(d){let r=d;d=void 0;while(r){const n=r.next;if(r.next=void 0,r.flags&=-9,1&r.flags)try{r.trigger()}catch(t){e||(e=t)}r=n}}if(e)throw e}function g(e){for(let t=e.deps;t;t=t.nextDep)t.version=-1,t.prevActiveLink=t.dep.activeLink,t.dep.activeLink=t}function m(e){let t,r=e.depsTail,n=r;while(n){const e=n.prevDep;-1===n.version?(n===r&&(r=e),b(n),E(n)):t=n,n.dep.activeLink=n.prevActiveLink,n.prevActiveLink=void 0,n=e}e.deps=t,e.depsTail=r}function y(e){for(let t=e.deps;t;t=t.nextDep)if(t.dep.version!==t.version||t.dep.computed&&(S(t.dep.computed)||t.dep.version!==t.version))return!0;return!!e._dirty}function S(e){if(4&e.flags&&!(16&e.flags))return;if(e.flags&=-17,e.globalVersion===k)return;e.globalVersion=k;const t=e.dep;if(e.flags|=2,t.version>0&&!e.isSSR&&e.deps&&!y(e))return void(e.flags&=-3);const r=o,i=_;o=e,_=!0;try{g(e);const r=e.fn(e._value);(0===t.version||(0,n.$H)(r,e._value))&&(e._value=r,t.version++)}catch(s){throw t.version++,s}finally{o=r,_=i,m(e),e.flags&=-3}}function b(e,t=!1){const{dep:r,prevSub:n,nextSub:i}=e;if(n&&(n.nextSub=i,e.prevSub=void 0),i&&(i.prevSub=n,e.nextSub=void 0),r.subs===e&&(r.subs=n,!n&&r.computed)){r.computed.flags&=-5;for(let e=r.computed.deps;e;e=e.nextDep)b(e,!0)}t||--r.sc||!r.map||r.map.delete(r.key)}function E(e){const{prevDep:t,nextDep:r}=e;t&&(t.nextDep=r,e.prevDep=void 0),r&&(r.prevDep=t,e.nextDep=void 0)}let _=!0;const w=[];function I(){w.push(_),_=!1}function T(){const e=w.pop();_=void 0===e||e}function R(e){const{cleanup:t}=e;if(e.cleanup=void 0,t){const e=o;o=void 0;try{t()}finally{o=e}}}let k=0;class A{constructor(e,t){this.sub=e,this.dep=t,this.version=t.version,this.nextDep=this.prevDep=this.nextSub=this.prevSub=this.prevActiveLink=void 0}}class C{constructor(e){this.computed=e,this.version=0,this.activeLink=void 0,this.subs=void 0,this.map=void 0,this.key=void 0,this.sc=0}track(e){if(!o||!_||o===this.computed)return;let t=this.activeLink;if(void 0===t||t.sub!==o)t=this.activeLink=new A(o,this),o.deps?(t.prevDep=o.depsTail,o.depsTail.nextDep=t,o.depsTail=t):o.deps=o.depsTail=t,O(t);else if(-1===t.version&&(t.version=this.version,t.nextDep)){const e=t.nextDep;e.prevDep=t.prevDep,t.prevDep&&(t.prevDep.nextDep=e),t.prevDep=o.depsTail,t.nextDep=void 0,o.depsTail.nextDep=t,o.depsTail=t,o.deps===t&&(o.deps=e)}return t}trigger(e){this.version++,k++,this.notify(e)}notify(e){p();try{0;for(let e=this.subs;e;e=e.prevSub)e.sub.notify()&&e.sub.dep.notify()}finally{f()}}}function O(e){if(e.dep.sc++,4&e.sub.flags){const t=e.dep.computed;if(t&&!e.dep.subs){t.flags|=20;for(let e=t.deps;e;e=e.nextDep)O(e)}const r=e.dep.subs;r!==e&&(e.prevSub=r,r&&(r.nextSub=e)),e.dep.subs=e}}const D=new WeakMap,M=Symbol(""),P=Symbol(""),x=Symbol("");function U(e,t,r){if(_&&o){let t=D.get(e);t||D.set(e,t=new Map);let n=t.get(r);n||(t.set(r,n=new C),n.map=t,n.key=r),n.track()}}function L(e,t,r,i,o,s){const a=D.get(e);if(!a)return void k++;const c=e=>{e&&e.trigger()};if(p(),"clear"===t)a.forEach(c);else{const o=(0,n.cy)(e),s=o&&(0,n.yI)(r);if(o&&"length"===r){const e=Number(i);a.forEach(((t,r)=>{("length"===r||r===x||!(0,n.Bm)(r)&&r>=e)&&c(t)}))}else switch((void 0!==r||a.has(void 0))&&c(a.get(r)),s&&c(a.get(x)),t){case"add":o?s&&c(a.get("length")):(c(a.get(M)),(0,n.CE)(e)&&c(a.get(P)));break;case"delete":o||(c(a.get(M)),(0,n.CE)(e)&&c(a.get(P)));break;case"set":(0,n.CE)(e)&&c(a.get(M));break}}f()}function N(e){const t=Ie(e);return t===e?t:(U(t,"iterate",x),_e(e)?t:t.map(Re))}function B(e){return U(e=Ie(e),"iterate",x),e}const K={__proto__:null,[Symbol.iterator](){return F(this,Symbol.iterator,Re)},concat(...e){return N(this).concat(...e.map((e=>(0,n.cy)(e)?N(e):e)))},entries(){return F(this,"entries",(e=>(e[1]=Re(e[1]),e)))},every(e,t){return q(this,"every",e,t,void 0,arguments)},filter(e,t){return q(this,"filter",e,t,(e=>e.map(Re)),arguments)},find(e,t){return q(this,"find",e,t,Re,arguments)},findIndex(e,t){return q(this,"findIndex",e,t,void 0,arguments)},findLast(e,t){return q(this,"findLast",e,t,Re,arguments)},findLastIndex(e,t){return q(this,"findLastIndex",e,t,void 0,arguments)},forEach(e,t){return q(this,"forEach",e,t,void 0,arguments)},includes(...e){return G(this,"includes",e)},indexOf(...e){return G(this,"indexOf",e)},join(e){return N(this).join(e)},lastIndexOf(...e){return G(this,"lastIndexOf",e)},map(e,t){return q(this,"map",e,t,void 0,arguments)},pop(){return W(this,"pop")},push(...e){return W(this,"push",e)},reduce(e,...t){return V(this,"reduce",e,t)},reduceRight(e,...t){return V(this,"reduceRight",e,t)},shift(){return W(this,"shift")},some(e,t){return q(this,"some",e,t,void 0,arguments)},splice(...e){return W(this,"splice",e)},toReversed(){return N(this).toReversed()},toSorted(e){return N(this).toSorted(e)},toSpliced(...e){return N(this).toSpliced(...e)},unshift(...e){return W(this,"unshift",e)},values(){return F(this,"values",Re)}};function F(e,t,r){const n=B(e),i=n[t]();return n===e||_e(e)||(i._next=i.next,i.next=()=>{const e=i._next();return e.value&&(e.value=r(e.value)),e}),i}const j=Array.prototype;function q(e,t,r,n,i,o){const s=B(e),a=s!==e&&!_e(e),c=s[t];if(c!==j[t]){const t=c.apply(e,o);return a?Re(t):t}let l=r;s!==e&&(a?l=function(t,n){return r.call(this,Re(t),n,e)}:r.length>2&&(l=function(t,n){return r.call(this,t,n,e)}));const d=c.call(s,l,n);return a&&i?i(d):d}function V(e,t,r,n){const i=B(e);let o=r;return i!==e&&(_e(e)?r.length>3&&(o=function(t,n,i){return r.call(this,t,n,i,e)}):o=function(t,n,i){return r.call(this,t,Re(n),i,e)}),i[t](o,...n)}function G(e,t,r){const n=Ie(e);U(n,"iterate",x);const i=n[t](...r);return-1!==i&&!1!==i||!we(r[0])?i:(r[0]=Ie(r[0]),n[t](...r))}function W(e,t,r=[]){I(),p();const n=Ie(e)[t].apply(e,r);return f(),T(),n}const H=(0,n.pD)("__proto__,__v_isRef,__isVue"),$=new Set(Object.getOwnPropertyNames(Symbol).filter((e=>"arguments"!==e&&"caller"!==e)).map((e=>Symbol[e])).filter(n.Bm));function J(e){(0,n.Bm)(e)||(e=String(e));const t=Ie(this);return U(t,"has",e),t.hasOwnProperty(e)}class z{constructor(e=!1,t=!1){this._isReadonly=e,this._isShallow=t}get(e,t,r){if("__v_skip"===t)return e["__v_skip"];const i=this._isReadonly,o=this._isShallow;if("__v_isReactive"===t)return!i;if("__v_isReadonly"===t)return i;if("__v_isShallow"===t)return o;if("__v_raw"===t)return r===(i?o?ve:he:o?ue:de).get(e)||Object.getPrototypeOf(e)===Object.getPrototypeOf(r)?e:void 0;const s=(0,n.cy)(e);if(!i){let e;if(s&&(e=K[t]))return e;if("hasOwnProperty"===t)return J}const a=Reflect.get(e,t,Ae(e)?e:r);return((0,n.Bm)(t)?$.has(t):H(t))?a:(i||U(e,"get",t),o?a:Ae(a)?s&&(0,n.yI)(t)?a:a.value:(0,n.Gv)(a)?i?ye(a):ge(a):a)}}class Y extends z{constructor(e=!1){super(!1,e)}set(e,t,r,i){let o=e[t];if(!this._isShallow){const t=Ee(o);if(_e(r)||Ee(r)||(o=Ie(o),r=Ie(r)),!(0,n.cy)(e)&&Ae(o)&&!Ae(r))return!t&&(o.value=r,!0)}const s=(0,n.cy)(e)&&(0,n.yI)(t)?Number(t)<e.length:(0,n.$3)(e,t),a=Reflect.set(e,t,r,Ae(e)?e:i);return e===Ie(i)&&(s?(0,n.$H)(r,o)&&L(e,"set",t,r,o):L(e,"add",t,r)),a}deleteProperty(e,t){const r=(0,n.$3)(e,t),i=e[t],o=Reflect.deleteProperty(e,t);return o&&r&&L(e,"delete",t,void 0,i),o}has(e,t){const r=Reflect.has(e,t);return(0,n.Bm)(t)&&$.has(t)||U(e,"has",t),r}ownKeys(e){return U(e,"iterate",(0,n.cy)(e)?"length":M),Reflect.ownKeys(e)}}class Q extends z{constructor(e=!1){super(!0,e)}set(e,t){return!0}deleteProperty(e,t){return!0}}const X=new Y,Z=new Q,ee=new Y(!0),te=e=>e,re=e=>Reflect.getPrototypeOf(e);function ne(e,t,r){return function(...i){const o=this["__v_raw"],s=Ie(o),a=(0,n.CE)(s),c="entries"===e||e===Symbol.iterator&&a,l="keys"===e&&a,d=o[e](...i),u=r?te:t?ke:Re;return!t&&U(s,"iterate",l?P:M),{next(){const{value:e,done:t}=d.next();return t?{value:e,done:t}:{value:c?[u(e[0]),u(e[1])]:u(e),done:t}},[Symbol.iterator](){return this}}}}function ie(e){return function(...t){return"delete"!==e&&("clear"===e?void 0:this)}}function oe(e,t){const r={get(r){const i=this["__v_raw"],o=Ie(i),s=Ie(r);e||((0,n.$H)(r,s)&&U(o,"get",r),U(o,"get",s));const{has:a}=re(o),c=t?te:e?ke:Re;return a.call(o,r)?c(i.get(r)):a.call(o,s)?c(i.get(s)):void(i!==o&&i.get(r))},get size(){const t=this["__v_raw"];return!e&&U(Ie(t),"iterate",M),Reflect.get(t,"size",t)},has(t){const r=this["__v_raw"],i=Ie(r),o=Ie(t);return e||((0,n.$H)(t,o)&&U(i,"has",t),U(i,"has",o)),t===o?r.has(t):r.has(t)||r.has(o)},forEach(r,n){const i=this,o=i["__v_raw"],s=Ie(o),a=t?te:e?ke:Re;return!e&&U(s,"iterate",M),o.forEach(((e,t)=>r.call(n,a(e),a(t),i)))}};(0,n.X$)(r,e?{add:ie("add"),set:ie("set"),delete:ie("delete"),clear:ie("clear")}:{add(e){t||_e(e)||Ee(e)||(e=Ie(e));const r=Ie(this),n=re(r),i=n.has.call(r,e);return i||(r.add(e),L(r,"add",e,e)),this},set(e,r){t||_e(r)||Ee(r)||(r=Ie(r));const i=Ie(this),{has:o,get:s}=re(i);let a=o.call(i,e);a||(e=Ie(e),a=o.call(i,e));const c=s.call(i,e);return i.set(e,r),a?(0,n.$H)(r,c)&&L(i,"set",e,r,c):L(i,"add",e,r),this},delete(e){const t=Ie(this),{has:r,get:n}=re(t);let i=r.call(t,e);i||(e=Ie(e),i=r.call(t,e));const o=n?n.call(t,e):void 0,s=t.delete(e);return i&&L(t,"delete",e,void 0,o),s},clear(){const e=Ie(this),t=0!==e.size,r=void 0,n=e.clear();return t&&L(e,"clear",void 0,void 0,r),n}});const i=["keys","values","entries",Symbol.iterator];return i.forEach((n=>{r[n]=ne(n,e,t)})),r}function se(e,t){const r=oe(e,t);return(t,i,o)=>"__v_isReactive"===i?!e:"__v_isReadonly"===i?e:"__v_raw"===i?t:Reflect.get((0,n.$3)(r,i)&&i in t?r:t,i,o)}const ae={get:se(!1,!1)},ce={get:se(!1,!0)},le={get:se(!0,!1)};const de=new WeakMap,ue=new WeakMap,he=new WeakMap,ve=new WeakMap;function pe(e){switch(e){case"Object":case"Array":return 1;case"Map":case"Set":case"WeakMap":case"WeakSet":return 2;default:return 0}}function fe(e){return e["__v_skip"]||!Object.isExtensible(e)?0:pe((0,n.Zf)(e))}function ge(e){return Ee(e)?e:Se(e,!1,X,ae,de)}function me(e){return Se(e,!1,ee,ce,ue)}function ye(e){return Se(e,!0,Z,le,he)}function Se(e,t,r,i,o){if(!(0,n.Gv)(e))return e;if(e["__v_raw"]&&(!t||!e["__v_isReactive"]))return e;const s=o.get(e);if(s)return s;const a=fe(e);if(0===a)return e;const c=new Proxy(e,2===a?i:r);return o.set(e,c),c}function be(e){return Ee(e)?be(e["__v_raw"]):!(!e||!e["__v_isReactive"])}function Ee(e){return!(!e||!e["__v_isReadonly"])}function _e(e){return!(!e||!e["__v_isShallow"])}function we(e){return!!e&&!!e["__v_raw"]}function Ie(e){const t=e&&e["__v_raw"];return t?Ie(t):e}function Te(e){return!(0,n.$3)(e,"__v_skip")&&Object.isExtensible(e)&&(0,n.yQ)(e,"__v_skip",!0),e}const Re=e=>(0,n.Gv)(e)?ge(e):e,ke=e=>(0,n.Gv)(e)?ye(e):e;function Ae(e){return!!e&&!0===e["__v_isRef"]}function Ce(e){return De(e,!1)}function Oe(e){return De(e,!0)}function De(e,t){return Ae(e)?e:new Me(e,t)}class Me{constructor(e,t){this.dep=new C,this["__v_isRef"]=!0,this["__v_isShallow"]=!1,this._rawValue=t?e:Ie(e),this._value=t?e:Re(e),this["__v_isShallow"]=t}get value(){return this.dep.track(),this._value}set value(e){const t=this._rawValue,r=this["__v_isShallow"]||_e(e)||Ee(e);e=r?e:Ie(e),(0,n.$H)(e,t)&&(this._rawValue=e,this._value=r?e:Re(e),this.dep.trigger())}}function Pe(e){return Ae(e)?e.value:e}const xe={get:(e,t,r)=>"__v_raw"===t?e:Pe(Reflect.get(e,t,r)),set:(e,t,r,n)=>{const i=e[t];return Ae(i)&&!Ae(r)?(i.value=r,!0):Reflect.set(e,t,r,n)}};function Ue(e){return be(e)?e:new Proxy(e,xe)}class Le{constructor(e,t,r){this.fn=e,this.setter=t,this._value=void 0,this.dep=new C(this),this.__v_isRef=!0,this.deps=void 0,this.depsTail=void 0,this.flags=16,this.globalVersion=k-1,this.next=void 0,this.effect=this,this["__v_isReadonly"]=!t,this.isSSR=r}notify(){if(this.flags|=16,!(8&this.flags||o===this))return v(this,!0),!0}get value(){const e=this.dep.track();return S(this),e&&(e.version=this.dep.version),this._value}set value(e){this.setter&&this.setter(e)}}function Ne(e,t,r=!1){let i,o;(0,n.Tn)(e)?i=e:(i=e.get,o=e.set);const s=new Le(i,o,r);return s}const Be={},Ke=new WeakMap;let Fe;function je(e,t=!1,r=Fe){if(r){let t=Ke.get(r);t||Ke.set(r,t=[]),t.push(e)}else 0}function qe(e,t,r=n.MZ){const{immediate:i,deep:o,once:s,scheduler:c,augmentJob:d,call:u}=r,h=e=>o?e:_e(e)||!1===o||0===o?Ve(e,1):Ve(e);let v,p,f,g,m=!1,y=!1;if(Ae(e)?(p=()=>e.value,m=_e(e)):be(e)?(p=()=>h(e),m=!0):(0,n.cy)(e)?(y=!0,m=e.some((e=>be(e)||_e(e))),p=()=>e.map((e=>Ae(e)?e.value:be(e)?h(e):(0,n.Tn)(e)?u?u(e,2):e():void 0))):p=(0,n.Tn)(e)?t?u?()=>u(e,2):e:()=>{if(f){I();try{f()}finally{T()}}const t=Fe;Fe=v;try{return u?u(e,3,[g]):e(g)}finally{Fe=t}}:n.tE,t&&o){const e=p,t=!0===o?1/0:o;p=()=>Ve(e(),t)}const S=a(),b=()=>{v.stop(),S&&S.active&&(0,n.TF)(S.effects,v)};if(s&&t){const e=t;t=(...t)=>{e(...t),b()}}let E=y?new Array(e.length).fill(Be):Be;const _=e=>{if(1&v.flags&&(v.dirty||e))if(t){const e=v.run();if(o||m||(y?e.some(((e,t)=>(0,n.$H)(e,E[t]))):(0,n.$H)(e,E))){f&&f();const r=Fe;Fe=v;try{const r=[e,E===Be?void 0:y&&E[0]===Be?[]:E,g];u?u(t,3,r):t(...r),E=e}finally{Fe=r}}}else v.run()};return d&&d(_),v=new l(p),v.scheduler=c?()=>c(_,!1):_,g=e=>je(e,!1,v),f=v.onStop=()=>{const e=Ke.get(v);if(e){if(u)u(e,4);else for(const t of e)t();Ke.delete(v)}},t?i?_(!0):E=v.run():c?c(_.bind(null,!0),!0):v.run(),b.pause=v.pause.bind(v),b.resume=v.resume.bind(v),b.stop=b,b}function Ve(e,t=1/0,r){if(t<=0||!(0,n.Gv)(e)||e["__v_skip"])return e;if(r=r||new Set,r.has(e))return e;if(r.add(e),t--,Ae(e))Ve(e.value,t,r);else if((0,n.cy)(e))for(let n=0;n<e.length;n++)Ve(e[n],t,r);else if((0,n.vM)(e)||(0,n.CE)(e))e.forEach((e=>{Ve(e,t,r)}));else if((0,n.Qd)(e)){for(const n in e)Ve(e[n],t,r);for(const n of Object.getOwnPropertySymbols(e))Object.prototype.propertyIsEnumerable.call(e,n)&&Ve(e[n],t,r)}return e}},2106:function(e,t,r){"use strict";var n=r(283),i=r(4913);e.exports=function(e,t,r){return r.get&&n(r.get,t,{getter:!0}),r.set&&n(r.set,t,{setter:!0}),i.f(e,t,r)}},2140:function(e,t,r){"use strict";var n=r(8227),i=n("toStringTag"),o={};o[i]="z",e.exports="[object z]"===String(o)},2195:function(e,t,r){"use strict";var n=r(9504),i=n({}.toString),o=n("".slice);e.exports=function(e){return o(i(e),8,-1)}},2211:function(e,t,r){"use strict";var n=r(9039);e.exports=!n((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype}))},2292:function(e,t,r){"use strict";r.d(t,{O:function(){return s},q:function(){return a}});var n=r(4761),i=r(4123),o=r(5629),s=function(e){return e["Backward"]="b",e["Forward"]="f",e}({});class a{static setEventMetadata(e,t,r){e.setMetadata(t,r)}constructor(e){var t,r;this.eventTimelineSet=e,(0,n.A)(this,"roomId",void 0),(0,n.A)(this,"name",void 0),(0,n.A)(this,"events",[]),(0,n.A)(this,"baseIndex",0),(0,n.A)(this,"startState",void 0),(0,n.A)(this,"endState",void 0),(0,n.A)(this,"startToken",null),(0,n.A)(this,"endToken",null),(0,n.A)(this,"prevTimeline",null),(0,n.A)(this,"nextTimeline",null),(0,n.A)(this,"paginationRequests",{[s.Backward]:null,[s.Forward]:null}),this.roomId=null!==(t=null===(r=e.room)||void 0===r?void 0:r.roomId)&&void 0!==t?t:null,this.roomId&&(this.startState=new i.H(this.roomId),this.endState=new i.H(this.roomId)),this.paginationRequests={b:null,f:null},this.name=this.roomId+":"+(new Date).toISOString()}initialiseState(e){var t,r,{timelineWasEmpty:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.events.length>0)throw new Error("Cannot initialise state after events are added");null===(t=this.startState)||void 0===t||t.setStateEvents(e,{timelineWasEmpty:n}),null===(r=this.endState)||void 0===r||r.setStateEvents(e,{timelineWasEmpty:n})}forkLive(e){var t=this.getState(e),r=new a(this.eventTimelineSet);return r.startState=null===t||void 0===t?void 0:t.clone(),r.endState=t,this.endState=null===t||void 0===t?void 0:t.clone(),r}fork(e){var t=this.getState(e),r=new a(this.eventTimelineSet);return r.startState=null===t||void 0===t?void 0:t.clone(),r.endState=null===t||void 0===t?void 0:t.clone(),r}getRoomId(){return this.roomId}getFilter(){return this.eventTimelineSet.getFilter()}getTimelineSet(){return this.eventTimelineSet}getBaseIndex(){return this.baseIndex}getEvents(){return this.events}getState(e){if(e==a.BACKWARDS)return this.startState;if(e==a.FORWARDS)return this.endState;throw new Error("Invalid direction '"+e+"'")}getPaginationToken(e){return this.roomId?this.getState(e).paginationToken:e===s.Backward?this.startToken:this.endToken}setPaginationToken(e,t){this.roomId?this.getState(t).paginationToken=e:t===s.Backward?this.startToken=e:this.endToken=e}getNeighbouringTimeline(e){if(e==a.BACKWARDS)return this.prevTimeline;if(e==a.FORWARDS)return this.nextTimeline;throw new Error("Invalid direction '"+e+"'")}setNeighbouringTimeline(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==a.BACKWARDS)this.prevTimeline=e;else{if(t!=a.FORWARDS)throw new Error("Invalid direction '"+t+"'");this.nextTimeline=e}this.setPaginationToken(null,t)}addEvent(e,t){var{toStartOfTimeline:r,roomState:n,timelineWasEmpty:i,addToState:s}=t;n||(n=r?this.startState:this.endState);var c,l,d=this.getTimelineSet();d.room&&(a.setEventMetadata(e,n,r),s&&e.isState()&&d.room.getUnfilteredTimelineSet()===d&&(null===(c=n)||void 0===c||c.setStateEvents([e],{timelineWasEmpty:i}),e.sender&&(e.getType()!==o.Bx.RoomMember||r)||a.setEventMetadata(e,n,r)));l=r?0:this.events.length,this.events.splice(l,0,e),r&&this.baseIndex++}insertEvent(e,t,r,n){var i=this.getTimelineSet();i.room&&(a.setEventMetadata(e,r,!1),n&&e.isState()&&i.room.getUnfilteredTimelineSet()===i&&(r.setStateEvents([e],{}),e.sender&&e.getType()!==o.Bx.RoomMember||a.setEventMetadata(e,r,!1))),this.events.splice(t,0,e)}removeEvent(e){for(var t=this.events.length-1;t>=0;t--){var r=this.events[t];if(r.getId()==e)return this.events.splice(t,1),t<this.baseIndex&&this.baseIndex--,r}return null}toString(){return this.name}}(0,n.A)(a,"BACKWARDS",s.Backward),(0,n.A)(a,"FORWARDS",s.Forward)},2306:function(e,t,r){r(4114);var n=r(3908);t.operation=function(e){var r=t.timeouts(e);return new n(r,{forever:e&&(e.forever||e.retries===1/0),unref:e&&e.unref,maxRetryTime:e&&e.maxRetryTime})},t.timeouts=function(e){if(e instanceof Array)return[].concat(e);var t={retries:10,factor:2,minTimeout:1e3,maxTimeout:1/0,randomize:!1};for(var r in e)t[r]=e[r];if(t.minTimeout>t.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var n=[],i=0;i<t.retries;i++)n.push(this.createTimeout(i,t));return e&&e.forever&&!n.length&&n.push(this.createTimeout(i,t)),n.sort((function(e,t){return e-t})),n},t.createTimeout=function(e,t){var r=t.randomize?Math.random()+1:1,n=Math.round(r*Math.max(t.minTimeout,1)*Math.pow(t.factor,e));return n=Math.min(n,t.maxTimeout),n},t.wrap=function(e,r,n){if(r instanceof Array&&(n=r,r=null),!n)for(var i in n=[],e)"function"===typeof e[i]&&n.push(i);for(var o=0;o<n.length;o++){var s=n[o],a=e[s];e[s]=function(n){var i=t.operation(r),o=Array.prototype.slice.call(arguments,1),s=o.pop();o.push((function(e){i.retry(e)||(e&&(arguments[0]=i.mainError()),s.apply(this,arguments))})),i.attempt((function(){n.apply(e,o)}))}.bind(e,a),e[s].options=r}}},2360:function(e,t,r){"use strict";var n,i=r(8551),o=r(6801),s=r(8727),a=r(421),c=r(397),l=r(4055),d=r(6119),u=">",h="<",v="prototype",p="script",f=d("IE_PROTO"),g=function(){},m=function(e){return h+p+u+e+h+"/"+p+u},y=function(e){e.write(m("")),e.close();var t=e.parentWindow.Object;return e=null,t},S=function(){var e,t=l("iframe"),r="java"+p+":";return t.style.display="none",c.appendChild(t),t.src=String(r),e=t.contentWindow.document,e.open(),e.write(m("document.F=Object")),e.close(),e.F},b=function(){try{n=new ActiveXObject("htmlfile")}catch(t){}b="undefined"!=typeof document?document.domain&&n?y(n):S():y(n);var e=s.length;while(e--)delete b[v][s[e]];return b()};a[f]=!0,e.exports=Object.create||function(e,t){var r;return null!==e?(g[v]=i(e),r=new g,g[v]=null,r[f]=e):r=b(),void 0===t?r:o.f(r,t)}},2475:function(e,t,r){"use strict";var n=r(6518),i=r(8527),o=r(4916),s=!o("isSupersetOf",(function(e){return!e}));n({target:"Set",proto:!0,real:!0,forced:s},{isSupersetOf:i})},2489:function(e,t,r){"use strict";var n=r(6518),i=r(9565),o=r(9306),s=r(8551),a=r(1767),c=r(9462),l=r(6319),d=r(6395),u=c((function(){var e,t,r,n=this.iterator,o=this.predicate,a=this.next;while(1){if(e=s(i(a,n)),t=this.done=!!e.done,t)return;if(r=e.value,l(n,o,[r,this.counter++],!0))return r}}));n({target:"Iterator",proto:!0,real:!0,forced:d},{filter:function(e){return s(this),o(e),new u(a(this),{predicate:e})}})},2529:function(e){"use strict";e.exports=function(e,t){return{value:e,done:t}}},2555:function(e,t){"use strict";function r(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=n(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==r["return"]||r["return"]()}finally{if(c)throw s}}}}function n(e,t){if(e){if("string"===typeof e)return i(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?i(e,t):void 0}}function i(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function a(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}Object.defineProperty(t,"__esModule",{value:!0}),t.NamespacedMap=void 0;var l=function(){function e(t){if(o(this,e),c(this,"internalMap",new Map),t){var n,i=r(t);try{for(i.s();!(n=i.n()).done;){var s=n.value;this.set(s[0],s[1])}}catch(a){i.e(a)}finally{i.f()}}}return a(e,[{key:"get",value:function(e){return e.name&&this.internalMap.has(e.name)?this.internalMap.get(e.name):e.altName&&this.internalMap.has(e.altName)?this.internalMap.get(e.altName):null}},{key:"set",value:function(e,t){e.name&&this.internalMap.set(e.name,t),e.altName&&this.internalMap.set(e.altName,t)}},{key:"has",value:function(e){return!!this.get(e)}},{key:"delete",value:function(e){e.name&&this.internalMap["delete"](e.name),e.altName&&this.internalMap["delete"](e.altName)}},{key:"hasNamespaced",value:function(e){return this.internalMap.has(e)}},{key:"getNamespaced",value:function(e){return this.internalMap.get(e)}}]),e}();t.NamespacedMap=l},2603:function(e,t,r){"use strict";var n=r(655);e.exports=function(e,t){return void 0===e?arguments.length<2?"":t:n(e)}},2652:function(e,t,r){"use strict";var n=r(6080),i=r(9565),o=r(8551),s=r(6823),a=r(4209),c=r(6198),l=r(1625),d=r(81),u=r(851),h=r(9539),v=TypeError,p=function(e,t){this.stopped=e,this.result=t},f=p.prototype;e.exports=function(e,t,r){var g,m,y,S,b,E,_,w=r&&r.that,I=!(!r||!r.AS_ENTRIES),T=!(!r||!r.IS_RECORD),R=!(!r||!r.IS_ITERATOR),k=!(!r||!r.INTERRUPTED),A=n(t,w),C=function(e){return g&&h(g,"normal",e),new p(!0,e)},O=function(e){return I?(o(e),k?A(e[0],e[1],C):A(e[0],e[1])):k?A(e,C):A(e)};if(T)g=e.iterator;else if(R)g=e;else{if(m=u(e),!m)throw new v(s(e)+" is not iterable");if(a(m)){for(y=0,S=c(e);S>y;y++)if(b=O(e[y]),b&&l(f,b))return b;return new p(!1)}g=d(e,m)}E=T?e.next:g.next;while(!(_=i(E,g)).done){try{b=O(_.value)}catch(D){h(g,"throw",D)}if("object"==typeof b&&b&&l(f,b))return b}return new p(!1)}},2668:function(e,t,r){"use strict";r.d(t,{X:function(){return s},u:function(){return o}});r(8111),r(1701);var n=r(698),i=r(9366),o=function(e){return e["NewListener"]="newListener",e["RemoveListener"]="removeListener",e["Error"]="error",e}({});class s extends i.EventEmitter{addListener(e,t){return super.addListener(e,t)}emit(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];return super.emit(e,...r)}emitPromised(e){var t=arguments,r=this;return(0,n.A)((function*(){for(var n=t.length,i=new Array(n>1?n-1:0),o=1;o<n;o++)i[o-1]=t[o];var s=r.listeners(e);return Promise.allSettled(s.map((e=>e(...i)))).then((()=>s.length>0))}))()}listenerCount(e){return super.listenerCount(e)}listeners(e){return super.listeners(e)}off(e,t){return super.off(e,t)}on(e,t){return super.on(e,t)}once(e,t){return super.once(e,t)}prependListener(e,t){return super.prependListener(e,t)}prependOnceListener(e,t){return super.prependOnceListener(e,t)}removeAllListeners(e){return void 0===e?super.removeAllListeners():super.removeAllListeners(e)}removeListener(e,t){return super.removeListener(e,t)}rawListeners(e){return super.rawListeners(e)}}},2696:function(e){"use strict";for(var t=/[\\\"\x00-\x1F]/g,r={},n=0;n<32;++n)r[String.fromCharCode(n)]="\\U"+("0000"+n.toString(16)).slice(-4).toUpperCase();function i(e){return t.lastIndex=0,e.replace(t,(function(e){return r[e]}))}function o(e){switch(typeof e){case"string":return'"'+i(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?s(e):a(e);default:throw new Error("Cannot stringify: "+typeof e)}}function s(e){for(var t="[",r="",n=0;n<e.length;++n)r+=t,t=",",r+=o(e[n]);return","!=t?"[]":r+"]"}function a(e){var t="{",r="",n=Object.keys(e);n.sort();for(var s=0;s<n.length;++s){var a=n[s];r+=t+'"'+i(a)+'":',t=",",r+=o(e[a])}return","!=t?"{}":r+"}"}r["\b"]="\\b",r["\t"]="\\t",r["\n"]="\\n",r["\f"]="\\f",r["\r"]="\\r",r['"']='\\"',r["\\"]="\\\\",e.exports={stringify:o}},2777:function(e,t,r){"use strict";var n=r(9565),i=r(34),o=r(757),s=r(5966),a=r(4270),c=r(8227),l=TypeError,d=c("toPrimitive");e.exports=function(e,t){if(!i(e)||o(e))return e;var r,c=s(e,d);if(c){if(void 0===t&&(t="default"),r=n(c,e,t),!i(r)||o(r))return r;throw new l("Can't convert object to primitive value")}return void 0===t&&(t="number"),a(e,t)}},2787:function(e,t,r){"use strict";var n=r(9297),i=r(4901),o=r(8981),s=r(6119),a=r(2211),c=s("IE_PROTO"),l=Object,d=l.prototype;e.exports=a?l.getPrototypeOf:function(e){var t=o(e);if(n(t,c))return t[c];var r=t.constructor;return i(r)&&t instanceof r?r.prototype:t instanceof l?d:null}},2796:function(e,t,r){"use strict";var n=r(9039),i=r(4901),o=/#|\.prototype\./,s=function(e,t){var r=c[a(e)];return r===d||r!==l&&(i(t)?n(t):!!t)},a=s.normalize=function(e){return String(e).replace(o,".").toLowerCase()},c=s.data={},l=s.NATIVE="N",d=s.POLYFILL="P";e.exports=s},2812:function(e){"use strict";var t=TypeError;e.exports=function(e,r){if(e<r)throw new t("Not enough arguments");return e}},2839:function(e,t,r){"use strict";var n=r(4576),i=n.navigator,o=i&&i.userAgent;e.exports=o?String(o):""},2967:function(e,t,r){"use strict";var n=r(6706),i=r(34),o=r(7750),s=r(3506);e.exports=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,r={};try{e=n(Object.prototype,"__proto__","set"),e(r,[]),t=r instanceof Array}catch(a){}return function(r,n){return o(r),s(n),i(r)?(t?e(r,n):r.__proto__=n,r):r}}():void 0)},3036:function(e,t,r){"use strict";r.d(t,{A:function(){return n},h:function(){return i}});var n="org.matrix.msc3077.sdp_stream_metadata",i=function(e){return e["Usermedia"]="m.usermedia",e["Screenshare"]="m.screenshare",e}({})},3061:function(e,t,r){"use strict";r.d(t,{$E:function(){return w},Il:function(){return I},QO:function(){return E},RA:function(){return D},WE:function(){return M},iP:function(){return S},ms:function(){return L},sj:function(){return N},sv:function(){return B}});r(4114),r(8111),r(2489),r(116),r(7588),r(1701),r(3579);var n=r(698),i=r(4761),o=r(5187),s=r(9594),a=r(3271),c=r(6170),l=r(5629),d=r(9553),u=r(3036),h=r(1240),v=r(2668),p=r(3723),f=r(4768),g=r(9683);function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var S=function(e){return e["Fledgling"]="fledgling",e["InviteSent"]="invite_sent",e["WaitLocalMedia"]="wait_local_media",e["CreateOffer"]="create_offer",e["CreateAnswer"]="create_answer",e["Connecting"]="connecting",e["Connected"]="connected",e["Ringing"]="ringing",e["Ended"]="ended",e}({}),b=function(e){return e["Voice"]="voice",e["Video"]="video",e}({}),E=function(e){return e["Inbound"]="inbound",e["Outbound"]="outbound",e}({}),_=function(e){return e["Local"]="local",e["Remote"]="remote",e}({}),w=function(e){return e["Hangup"]="hangup",e["State"]="state",e["Error"]="error",e["Replaced"]="replaced",e["LocalHoldUnhold"]="local_hold_unhold",e["RemoteHoldUnhold"]="remote_hold_unhold",e["HoldUnhold"]="hold_unhold",e["FeedsChanged"]="feeds_changed",e["AssertedIdentityChanged"]="asserted_identity_changed",e["LengthChanged"]="length_changed",e["DataChannel"]="datachannel",e["SendVoipEvent"]="send_voip_event",e["PeerConnectionCreated"]="peer_connection_created",e}({}),I=function(e){return e["UserHangup"]="user_hangup",e["LocalOfferFailed"]="local_offer_failed",e["NoUserMedia"]="no_user_media",e["UnknownDevices"]="unknown_devices",e["SendInvite"]="send_invite",e["CreateAnswer"]="create_answer",e["CreateOffer"]="create_offer",e["SendAnswer"]="send_answer",e["SetRemoteDescription"]="set_remote_description",e["SetLocalDescription"]="set_local_description",e["AnsweredElsewhere"]="answered_elsewhere",e["IceFailed"]="ice_failed",e["InviteTimeout"]="invite_timeout",e["Replaced"]="replaced",e["SignallingFailed"]="signalling_timeout",e["UserBusy"]="user_busy",e["Transferred"]="transferred",e["NewSession"]="new_session",e}({}),T="1",R="stun:turn.matrix.org",k=6e4,A=1e3,C=3e4,O=2e3;class D extends Error{constructor(e,t,r){super(t+": "+r),(0,i.A)(this,"code",void 0),this.code=e}}function M(){return Date.now().toString()+(0,d.US)(16)}function P(e){var t=[{mediaType:"audio",codec:"opus",enableDtx:!0,maxAverageBitrate:e?12e3:void 0}];return t}function x(e,t){return e+":"+t}class U extends v.X{constructor(e){var t,r;if(super(),t=this,(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"callId",void 0),(0,i.A)(this,"invitee",void 0),(0,i.A)(this,"hangupParty",void 0),(0,i.A)(this,"hangupReason",void 0),(0,i.A)(this,"direction",void 0),(0,i.A)(this,"ourPartyId",void 0),(0,i.A)(this,"peerConn",void 0),(0,i.A)(this,"toDeviceSeq",0),(0,i.A)(this,"isPtt",!1),(0,i.A)(this,"_state",S.Fledgling),(0,i.A)(this,"client",void 0),(0,i.A)(this,"forceTURN",void 0),(0,i.A)(this,"turnServers",void 0),(0,i.A)(this,"candidateSendQueue",[]),(0,i.A)(this,"candidateSendTries",0),(0,i.A)(this,"candidatesEnded",!1),(0,i.A)(this,"feeds",[]),(0,i.A)(this,"transceivers",new Map),(0,i.A)(this,"inviteOrAnswerSent",!1),(0,i.A)(this,"waitForLocalAVStream",!1),(0,i.A)(this,"successor",void 0),(0,i.A)(this,"opponentMember",void 0),(0,i.A)(this,"opponentVersion",void 0),(0,i.A)(this,"opponentPartyId",void 0),(0,i.A)(this,"opponentCaps",void 0),(0,i.A)(this,"iceDisconnectedTimeout",void 0),(0,i.A)(this,"iceReconnectionTimeOut",void 0),(0,i.A)(this,"inviteTimeout",void 0),(0,i.A)(this,"removeTrackListeners",new Map),(0,i.A)(this,"remoteOnHold",!1),(0,i.A)(this,"callStatsAtEnd",void 0),(0,i.A)(this,"makingOffer",!1),(0,i.A)(this,"ignoreOffer",!1),(0,i.A)(this,"isSettingRemoteAnswerPending",!1),(0,i.A)(this,"responsePromiseChain",void 0),(0,i.A)(this,"remoteCandidateBuffer",new Map),(0,i.A)(this,"remoteAssertedIdentity",void 0),(0,i.A)(this,"remoteSDPStreamMetadata",void 0),(0,i.A)(this,"callLengthInterval",void 0),(0,i.A)(this,"callStartTime",void 0),(0,i.A)(this,"opponentDeviceId",void 0),(0,i.A)(this,"opponentDeviceInfo",void 0),(0,i.A)(this,"opponentSessionId",void 0),(0,i.A)(this,"groupCallId",void 0),(0,i.A)(this,"stopVideoTrackTimer",void 0),(0,i.A)(this,"isOnlyDataChannelAllowed",void 0),(0,i.A)(this,"stats",void 0),(0,i.A)(this,"gotLocalIceCandidate",(e=>{if(e.candidate){if(this.candidatesEnded&&a.v.warn("Call ".concat(this.callId," gotLocalIceCandidate() got candidate after candidates have ended!")),a.v.debug("Call ".concat(this.callId," got local ICE ").concat(e.candidate.sdpMid," ").concat(e.candidate.candidate)),this.callHasEnded())return;""===e.candidate.candidate?this.queueCandidate(null):this.queueCandidate(e.candidate)}})),(0,i.A)(this,"onIceGatheringStateChange",(e=>{var t;a.v.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state changed to ").concat(this.peerConn.iceGatheringState)),"complete"===(null===(t=this.peerConn)||void 0===t?void 0:t.iceGatheringState)&&(this.queueCandidate(null),a.v.debug("Call ".concat(this.callId," onIceGatheringStateChange() ice gathering state complete, set candidates have ended")))})),(0,i.A)(this,"getLocalOfferFailed",(e=>{a.v.error("Call ".concat(this.callId," getLocalOfferFailed() running"),e),this.emit(w.Error,new D(I.LocalOfferFailed,"Failed to get local offer!",e),this),this.terminate(_.Local,I.LocalOfferFailed,!1)})),(0,i.A)(this,"getUserMediaFailed",(e=>{this.successor?this.successor.getUserMediaFailed(e):(a.v.warn("Call ".concat(this.callId," getUserMediaFailed() failed to get user media - ending call"),e),this.emit(w.Error,new D(I.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e),this),this.terminate(_.Local,I.NoUserMedia,!1))})),(0,i.A)(this,"placeCallFailed",(e=>{this.successor?this.successor.placeCallFailed(e):(a.v.warn("Call ".concat(this.callId," placeCallWithCallFeeds() failed - ending call"),e),this.emit(w.Error,new D(I.IceFailed,"Couldn't start call! Invalid ICE server configuration.",e),this),this.terminate(_.Local,I.IceFailed,!1))})),(0,i.A)(this,"onIceConnectionStateChanged",(()=>{var e,t,r,n,i,o;if(!this.callHasEnded()){if(a.v.debug("Call ".concat(this.callId," onIceConnectionStateChanged() running (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState,", conn=").concat(null===(t=this.peerConn)||void 0===t?void 0:t.connectionState,")")),["connected","completed"].includes(null!==(r=null===(n=this.peerConn)||void 0===n?void 0:n.iceConnectionState)&&void 0!==r?r:""))clearTimeout(this.iceDisconnectedTimeout),this.iceDisconnectedTimeout=void 0,this.iceReconnectionTimeOut&&clearTimeout(this.iceReconnectionTimeOut),this.state=S.Connected,this.callLengthInterval||this.callStartTime||(this.callStartTime=Date.now(),this.callLengthInterval=setInterval((()=>{this.emit(w.LengthChanged,Math.round((Date.now()-this.callStartTime)/1e3),this)}),A));else if("failed"==(null===(i=this.peerConn)||void 0===i?void 0:i.iceConnectionState)){var s,c;if(this.candidatesEnded=!1,null!==(s=this.peerConn)&&void 0!==s&&s.restartIce)this.candidatesEnded=!1,a.v.debug("Call ".concat(this.callId," onIceConnectionStateChanged() ice restart (state=").concat(null===(c=this.peerConn)||void 0===c?void 0:c.iceConnectionState,")")),this.peerConn.restartIce();else a.v.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE failed and no ICE restart method)")),this.hangup(I.IceFailed,!1)}else"disconnected"==(null===(o=this.peerConn)||void 0===o?void 0:o.iceConnectionState)&&(this.candidatesEnded=!1,this.iceReconnectionTimeOut=setTimeout((()=>{var e,t,r;a.v.info("Call ".concat(this.callId," onIceConnectionStateChanged() ICE restarting because of ICE disconnected, (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.iceConnectionState,", conn=").concat(null===(t=this.peerConn)||void 0===t?void 0:t.connectionState,")")),null!==(r=this.peerConn)&&void 0!==r&&r.restartIce&&(this.candidatesEnded=!1,this.peerConn.restartIce()),this.iceReconnectionTimeOut=void 0}),O),this.iceDisconnectedTimeout=setTimeout((()=>{a.v.info("Call ".concat(this.callId," onIceConnectionStateChanged() hanging up call (ICE disconnected for too long)")),this.hangup(I.IceFailed,!1)}),C),this.state=S.Connecting);if(this.isPtt&&["failed","disconnected"].includes(this.peerConn.iceConnectionState))for(var l of this.getRemoteFeeds())l.setAudioVideoMuted(!0,!0)}})),(0,i.A)(this,"onSignallingStateChanged",(()=>{var e;a.v.debug("Call ".concat(this.callId," onSignallingStateChanged() running (state=").concat(null===(e=this.peerConn)||void 0===e?void 0:e.signalingState,")"))})),(0,i.A)(this,"onTrack",(e=>{if(0!==e.streams.length){var t=e.streams[0];if(this.pushRemoteFeed(t),!this.removeTrackListeners.has(t)){var r=()=>{0===t.getTracks().length&&(a.v.info("Call ".concat(this.callId," onTrack() removing track (streamId=").concat(t.id,")")),this.deleteFeedByStream(t),t.removeEventListener("removetrack",r),this.removeTrackListeners.delete(t))};t.addEventListener("removetrack",r),this.removeTrackListeners.set(t,r)}}else a.v.warn("Call ".concat(this.callId," onTrack() called with streamless track streamless (kind=").concat(e.track.kind,")"))})),(0,i.A)(this,"onDataChannel",(e=>{this.emit(w.DataChannel,e.channel,this)})),(0,i.A)(this,"onNegotiationNeeded",(0,n.A)((function*(){a.v.info("Call ".concat(t.callId," onNegotiationNeeded() negotiation is needed!")),t.state===S.CreateOffer||0!==t.opponentVersion?t.queueGotLocalOffer():a.v.info("Call ".concat(t.callId," onNegotiationNeeded() opponent does not support renegotiation: ignoring negotiationneeded event"))}))),(0,i.A)(this,"onHangupReceived",(e=>{a.v.debug("Call ".concat(this.callId," onHangupReceived() running")),this.partyIdMatches(e)||this.state===S.Ringing?this.terminate(_.Remote,e.reason||I.UserHangup,!0):a.v.info("Call ".concat(this.callId," onHangupReceived() ignoring message from party ID ").concat(e.party_id,": our partner is ").concat(this.opponentPartyId))})),(0,i.A)(this,"onRejectReceived",(e=>{a.v.debug("Call ".concat(this.callId," onRejectReceived() running"));var t=[S.InviteSent,S.Ringing].includes(this.state)||this.state===S.Fledgling&&this.direction===E.Inbound;t?this.terminate(_.Remote,e.reason||I.UserHangup,!0):a.v.debug("Call ".concat(this.callId," onRejectReceived() called in wrong state (state=").concat(this.state,")"))})),(0,i.A)(this,"onAnsweredElsewhere",(e=>{a.v.debug("Call ".concat(this.callId," onAnsweredElsewhere() running")),this.terminate(_.Remote,I.AnsweredElsewhere,!0)})),this.roomId=e.roomId,this.invitee=e.invitee,this.client=e.client,!this.client.deviceId)throw new Error("Client must have a device ID to start calls");for(var o of(this.forceTURN=null!==(r=e.forceTURN)&&void 0!==r&&r,this.ourPartyId=this.client.deviceId,this.opponentDeviceId=e.opponentDeviceId,this.opponentSessionId=e.opponentSessionId,this.groupCallId=e.groupCallId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[R]}),this.turnServers))(0,c.UB)(o,["urls"]);this.callId=M(),this.isOnlyDataChannelAllowed=this.client.isVoipWithNoMediaAllowed}placeVoiceCall(){var e=this;return(0,n.A)((function*(){yield e.placeCall(!0,!1)}))()}placeVideoCall(){var e=this;return(0,n.A)((function*(){yield e.placeCall(!0,!0)}))()}createDataChannel(e,t){var r=this.peerConn.createDataChannel(e,t);return this.emit(w.DataChannel,r,this),r}getOpponentMember(){return this.opponentMember}getOpponentDeviceId(){return this.opponentDeviceId}getOpponentSessionId(){return this.opponentSessionId}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}opponentSupportsDTMF(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.dtmf"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}get state(){return this._state}set state(e){var t=this._state;this._state=e,this.emit(w.State,e,t,this)}get type(){return this.hasUserMediaVideoSender||this.hasRemoteUserMediaVideoTrack?b.Video:b.Voice}get hasLocalUserMediaVideoTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getVideoTracks().length)}get hasRemoteUserMediaVideoTrack(){return this.getRemoteFeeds().some((e=>{var t;return e.purpose===u.h.Usermedia&&(null===(t=e.stream)||void 0===t?void 0:t.getVideoTracks().length)}))}get hasLocalUserMediaAudioTrack(){var e;return!(null===(e=this.localUsermediaStream)||void 0===e||!e.getAudioTracks().length)}get hasRemoteUserMediaAudioTrack(){return this.getRemoteFeeds().some((e=>{var t;return e.purpose===u.h.Usermedia&&!(null===(t=e.stream)||void 0===t||!t.getAudioTracks().length)}))}get hasUserMediaAudioSender(){var e;return Boolean(null===(e=this.transceivers.get(x(u.h.Usermedia,"audio")))||void 0===e?void 0:e.sender)}get hasUserMediaVideoSender(){var e;return Boolean(null===(e=this.transceivers.get(x(u.h.Usermedia,"video")))||void 0===e?void 0:e.sender)}get localUsermediaFeed(){return this.getLocalFeeds().find((e=>e.purpose===u.h.Usermedia))}get localScreensharingFeed(){return this.getLocalFeeds().find((e=>e.purpose===u.h.Screenshare))}get localUsermediaStream(){var e;return null===(e=this.localUsermediaFeed)||void 0===e?void 0:e.stream}get localScreensharingStream(){var e;return null===(e=this.localScreensharingFeed)||void 0===e?void 0:e.stream}get remoteUsermediaFeed(){return this.getRemoteFeeds().find((e=>e.purpose===u.h.Usermedia))}get remoteScreensharingFeed(){return this.getRemoteFeeds().find((e=>e.purpose===u.h.Screenshare))}get remoteUsermediaStream(){var e;return null===(e=this.remoteUsermediaFeed)||void 0===e?void 0:e.stream}get remoteScreensharingStream(){var e;return null===(e=this.remoteScreensharingFeed)||void 0===e?void 0:e.stream}getFeedByStreamId(e){return this.getFeeds().find((t=>t.stream.id===e))}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter((e=>e.isLocal()))}getRemoteFeeds(){return this.feeds.filter((e=>!e.isLocal()))}initOpponentCrypto(){var e=this;return(0,n.A)((function*(){var t,r;if(e.opponentDeviceId&&e.client.getUseE2eForGroupCall())if(e.client.isCryptoEnabled()){if(!e.client.crypto)throw new Error("Crypto is not initialised.");var n=e.invitee||(null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId);if(!n)throw new Error("Couldn't find opponent user ID to init crypto");var i=yield e.client.crypto.deviceList.downloadKeys([n],!1);if(e.opponentDeviceInfo=null===(r=i.get(n))||void 0===r?void 0:r.get(e.opponentDeviceId),void 0===e.opponentDeviceInfo)throw new f.Iy(n)}else e.opponentDeviceInfo=new p.V(e.opponentDeviceId)}))()}getLocalSDPStreamMetadata(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={};for(var r of this.getLocalFeeds())e&&(r.sdpMetadataStreamId=r.stream.id),t[r.sdpMetadataStreamId]={purpose:r.purpose,audio_muted:r.isAudioMuted(),video_muted:r.isVideoMuted()};return t}noIncomingFeeds(){return!this.feeds.some((e=>!e.isLocal()))}pushRemoteFeed(e){if(this.opponentSupportsSDPStreamMetadata()){var t=this.getOpponentMember().userId,r=this.remoteSDPStreamMetadata[e.id].purpose,n=this.remoteSDPStreamMetadata[e.id].audio_muted,i=this.remoteSDPStreamMetadata[e.id].video_muted;r?this.getFeedByStreamId(e.id)?a.v.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")")):(this.feeds.push(new h.Hh({client:this.client,call:this,roomId:this.roomId,userId:t,deviceId:this.getOpponentDeviceId(),stream:e,purpose:r,audioMuted:n,videoMuted:i})),this.emit(w.FeedsChanged,this.feeds,this),a.v.info("Call ".concat(this.callId," pushRemoteFeed() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,", purpose=").concat(r,")"))):a.v.warn("Call ".concat(this.callId," pushRemoteFeed() ignoring stream because we didn't get any metadata about it (streamId=").concat(e.id,")"))}else this.pushRemoteFeedWithoutMetadata(e)}pushRemoteFeedWithoutMetadata(e){var t,r=this.getOpponentMember().userId,n=u.h.Usermedia,i=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;i&&e.id!==i.id?a.v.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring new stream because we already have stream (streamId=").concat(e.id,")")):this.getFeedByStreamId(e.id)?a.v.warn("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")")):(this.feeds.push(new h.Hh({client:this.client,call:this,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:r,deviceId:this.getOpponentDeviceId(),stream:e,purpose:n})),this.emit(w.FeedsChanged,this.feeds,this),a.v.info("Call ".concat(this.callId," pushRemoteFeedWithoutMetadata() pushed stream (streamId=").concat(e.id,", active=").concat(e.active,")")))}pushNewLocalFeed(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.client.getUserId();L(e.getAudioTracks(),!0),L(e.getVideoTracks(),!0),this.getFeedByStreamId(e.id)?a.v.warn("Call ".concat(this.callId," pushNewLocalFeed() ignoring stream because we already have a feed for it (streamId=").concat(e.id,")")):this.pushLocalFeed(new h.Hh({client:this.client,roomId:this.roomId,audioMuted:!1,videoMuted:!1,userId:n,deviceId:this.getOpponentDeviceId(),stream:e,purpose:t}),r)}pushLocalFeed(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.feeds.some((t=>e.stream.id===t.stream.id)))a.v.info("Call ".concat(this.callId," pushLocalFeed() ignoring duplicate local stream (streamId=").concat(e.stream.id,")"));else{if(this.feeds.push(e),r){var n=function(){a.v.info("Call ".concat(t.callId," pushLocalFeed() adding track to peer connection (id=").concat(i.id,", kind=").concat(i.kind,", streamId=").concat(e.stream.id,", streamPurpose=").concat(e.purpose,", enabled=").concat(i.enabled,")"));var r=x(e.purpose,i.kind);if(t.transceivers.has(r)){var n=t.transceivers.get(r);n.sender.replaceTrack(i),n.direction="inactive"===n.direction?"sendonly":"sendrecv"}else{var o=t.peerConn.addTrack(i,e.stream),s=t.peerConn.getTransceivers().find((e=>e.sender===o));s?t.transceivers.set(r,s):a.v.warn("Call ".concat(t.callId," pushLocalFeed() didn't find a matching transceiver after adding track!"))}};for(var i of e.stream.getTracks())n()}a.v.info("Call ".concat(this.callId," pushLocalFeed() pushed stream (id=").concat(e.stream.id,", active=").concat(e.stream.active,", purpose=").concat(e.purpose,")")),this.emit(w.FeedsChanged,this.feeds,this)}}removeLocalFeed(e){var t=x(e.purpose,"audio"),r=x(e.purpose,"video");for(var n of[t,r])if(this.transceivers.has(n)){var i=this.transceivers.get(n);i.sender&&this.peerConn.removeTrack(i.sender)}e.purpose===u.h.Screenshare&&this.client.getMediaHandler().stopScreensharingStream(e.stream),this.deleteFeed(e)}deleteAllFeeds(){for(var e of this.feeds)e.isLocal()&&this.groupCallId||e.dispose();this.feeds=[],this.emit(w.FeedsChanged,this.feeds,this)}deleteFeedByStream(e){var t=this.getFeedByStreamId(e.id);t?this.deleteFeed(t):a.v.warn("Call ".concat(this.callId," deleteFeedByStream() didn't find the feed to delete (streamId=").concat(e.id,")"))}deleteFeed(e){e.dispose(),this.feeds.splice(this.feeds.indexOf(e),1),this.emit(w.FeedsChanged,this.feeds,this)}getCurrentCallStats(){var e=this;return(0,n.A)((function*(){return e.callHasEnded()?e.callStatsAtEnd:e.collectCallStats()}))()}collectCallStats(){var e=this;return(0,n.A)((function*(){if(e.peerConn){var t=yield e.peerConn.getStats(),r=[];return t.forEach((e=>{r.push(e)})),r}}))()}initWithInvite(e){var t=this;return(0,n.A)((function*(){var r,n=e.getContent();t.direction=E.Inbound;var i=yield t.client.checkTurnServers();i||a.v.warn("Call ".concat(t.callId," initWithInvite() failed to get TURN credentials! Proceeding with call anyway..."));var o=n[u.A];o?t.updateRemoteSDPStreamMetadata(o):a.v.debug("Call ".concat(t.callId," initWithInvite() did not get any SDPStreamMetadata! Can not send/receive multiple streams")),t.peerConn=t.createPeerConnection(),t.emit(w.PeerConnectionCreated,t.peerConn,t),t.chooseOpponent(e),yield t.initOpponentCrypto();try{yield t.peerConn.setRemoteDescription(n.offer),a.v.debug("Call ".concat(t.callId," initWithInvite() set remote description: ").concat(n.offer.type)),yield t.addBufferedIceCandidates()}catch(d){return a.v.debug("Call ".concat(t.callId," initWithInvite() failed to set remote description"),d),void t.terminate(_.Local,I.SetRemoteDescription,!1)}var s=null===(r=t.feeds.find((e=>!e.isLocal())))||void 0===r?void 0:r.stream;if(!t.isOnlyDataChannelAllowed&&(!s||0===s.getTracks().length))return a.v.error("Call ".concat(t.callId," initWithInvite() no remote stream or no tracks after setting remote description!")),void t.terminate(_.Local,I.SetRemoteDescription,!1);if(t.state=S.Ringing,e.getLocalAge()){var c=setTimeout((()=>{var e;t.state==S.Ringing&&(a.v.debug("Call ".concat(t.callId," initWithInvite() invite has expired. Hanging up.")),t.hangupParty=_.Remote,t.state=S.Ended,t.stopAllMedia(),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),null===(e=t.stats)||void 0===e||e.removeStatsReportGatherer(t.callId),t.emit(w.Hangup,t))}),n.lifetime-e.getLocalAge()),l=e=>{e!==S.Ringing&&(clearTimeout(c),t.off(w.State,l))};t.on(w.State,l)}}))()}initWithHangup(e){this.state=S.Ended}shouldAnswerWithMediaType(e,t,r){return e&&!t?(a.v.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r," because the other side isn't sending it either.")),!1):(0,c.hX)(e)||e===t||this.opponentSupportsSDPStreamMetadata()?null!==e&&void 0!==e?e:t:(a.v.warn("Call ".concat(this.callId," shouldAnswerWithMediaType() unable to answer with ").concat(r,"=").concat(e," because the other side doesn't support it. Answering with ").concat(r,"=").concat(t,".")),t)}answer(e,t){var r=this;return(0,n.A)((function*(){if(!r.inviteOrAnswerSent){if(!1===e&&!1===t)throw new Error("You CANNOT answer a call without media");if(r.localUsermediaStream||r.waitForLocalAVStream)r.waitForLocalAVStream&&(r.state=S.WaitLocalMedia);else{var n=r.state,i=r.shouldAnswerWithMediaType(e,r.hasRemoteUserMediaAudioTrack,"audio"),o=r.shouldAnswerWithMediaType(t,r.hasRemoteUserMediaVideoTrack,"video");r.state=S.WaitLocalMedia,r.waitForLocalAVStream=!0;try{var s,c=yield r.client.getMediaHandler().getUserMediaStream(i,o);r.waitForLocalAVStream=!1;var l=new h.Hh({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:null!==(s=r.client.getDeviceId())&&void 0!==s?s:void 0,stream:c,purpose:u.h.Usermedia,audioMuted:!1,videoMuted:!1}),d=[l];r.localScreensharingFeed&&d.push(r.localScreensharingFeed),r.answerWithCallFeeds(d)}catch(v){if(!o)return void r.getUserMediaFailed(v);a.v.warn("Call ".concat(r.callId," answer() failed to getUserMedia(), trying to getUserMedia() without video")),r.state=n,r.waitForLocalAVStream=!1,yield r.answer(i,!1)}}}}))()}answerWithCallFeeds(e){this.inviteOrAnswerSent||this.queueGotCallFeedsForAnswer(e)}replacedBy(e){a.v.debug("Call ".concat(this.callId," replacedBy() running (newCallId=").concat(e.callId,")")),this.state===S.WaitLocalMedia?(a.v.debug("Call ".concat(this.callId," replacedBy() telling new call to wait for local media (newCallId=").concat(e.callId,")")),e.waitForLocalAVStream=!0):[S.CreateOffer,S.InviteSent].includes(this.state)&&(e.direction===E.Outbound?e.queueGotCallFeedsForAnswer([]):(a.v.debug("Call ".concat(this.callId," replacedBy() handing local stream to new call(newCallId=").concat(e.callId,")")),e.queueGotCallFeedsForAnswer(this.getLocalFeeds().map((e=>e.clone()))))),this.successor=e,this.emit(w.Replaced,e,this),this.hangup(I.Replaced,!0)}hangup(e,t){if(!this.callHasEnded()&&(a.v.debug("Call ".concat(this.callId," hangup() ending call (reason=").concat(e,")")),this.terminate(_.Local,e,!t),![S.Fledgling,S.WaitLocalMedia].includes(this.state))){var r={};(this.opponentVersion&&0!==this.opponentVersion||e!==I.UserHangup)&&(r["reason"]=e),this.sendVoipEvent(l.Bx.CallHangup,r)}}reject(){if(this.state!==S.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(0===this.opponentVersion)return a.v.info("Call ".concat(this.callId," reject() opponent version is less than 1: sending hangup instead of reject (opponentVersion=").concat(this.opponentVersion,")")),void this.hangup(I.UserHangup,!0);a.v.debug("Rejecting call: "+this.callId),this.terminate(_.Local,I.UserHangup,!0),this.sendVoipEvent(l.Bx.CallReject,{})}upgradeCall(e,t){var r=this;return(0,n.A)((function*(){if((e||t)&&r.opponentSupportsSDPStreamMetadata())try{a.v.debug("Call ".concat(r.callId," upgradeCall() upgrading call (audio=").concat(e,", video=").concat(t,")"));var n=e||r.hasLocalUserMediaAudioTrack,i=t||r.hasLocalUserMediaVideoTrack,o=yield r.client.getMediaHandler().getUserMediaStream(n,i,!1);yield r.updateLocalUsermediaStream(o,e,t)}catch(s){a.v.error("Call ".concat(r.callId," upgradeCall() failed to upgrade the call"),s),r.emit(w.Error,new D(I.NoUserMedia,"Failed to get camera access: ",s),r)}}))()}opponentSupportsSDPStreamMetadata(){return Boolean(this.remoteSDPStreamMetadata)}isScreensharing(){return Boolean(this.localScreensharingStream)}setScreensharingEnabled(e,t){var r=this;return(0,n.A)((function*(){if(e&&r.isScreensharing())return a.v.warn("Call ".concat(r.callId," setScreensharingEnabled() there is already a screensharing stream - there is nothing to do!")),!0;if(!e&&!r.isScreensharing())return a.v.warn("Call ".concat(r.callId," setScreensharingEnabled() there already isn't a screensharing stream - there is nothing to do!")),!1;if(!r.opponentSupportsSDPStreamMetadata())return r.setScreensharingEnabledWithoutMetadataSupport(e,t);if(a.v.debug("Call ".concat(r.callId," setScreensharingEnabled() running (enabled=").concat(e,")")),!e){var n=r.transceivers.get(x(u.h.Screenshare,"audio")),i=r.transceivers.get(x(u.h.Screenshare,"video"));for(var o of[n,i])o&&o.sender&&r.peerConn.removeTrack(o.sender);return r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}try{var s=yield r.client.getMediaHandler().getScreensharingStream(t);return!!s&&(r.pushNewLocalFeed(s,u.h.Screenshare),!0)}catch(c){return a.v.error("Call ".concat(r.callId," setScreensharingEnabled() failed to get screen-sharing stream:"),c),!1}}))()}setScreensharingEnabledWithoutMetadataSupport(e,t){var r=this;return(0,n.A)((function*(){if(a.v.debug("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() running (enabled=").concat(e,")")),!e){var n,i,o=null===(n=r.localUsermediaStream)||void 0===n?void 0:n.getTracks().find((e=>"video"===e.kind)),s=null===(i=r.transceivers.get(x(u.h.Usermedia,"video")))||void 0===i?void 0:i.sender;return null===s||void 0===s||s.replaceTrack(null!==o&&void 0!==o?o:null),r.client.getMediaHandler().stopScreensharingStream(r.localScreensharingStream),r.deleteFeedByStream(r.localScreensharingStream),!1}try{var c,l=yield r.client.getMediaHandler().getScreensharingStream(t);if(!l)return!1;var d=l.getTracks().find((e=>"video"===e.kind)),h=null===(c=r.transceivers.get(x(u.h.Usermedia,"video")))||void 0===c?void 0:c.sender;return null===h||void 0===h||h.replaceTrack(null!==d&&void 0!==d?d:null),r.pushNewLocalFeed(l,u.h.Screenshare,!1),!0}catch(v){return a.v.error("Call ".concat(r.callId," setScreensharingEnabledWithoutMetadataSupport() failed to get screen-sharing stream:"),v),!1}}))()}updateLocalUsermediaStream(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]&&t[1],i=t.length>2&&void 0!==t[2]&&t[2],o=r.localUsermediaFeed,s=n||!o.isAudioMuted()&&!r.remoteOnHold,c=i||!o.isVideoMuted()&&!r.remoteOnHold;for(var l of(a.v.log("Call ".concat(r.callId," updateLocalUsermediaStream() running (streamId=").concat(e.id,", audio=").concat(s,", video=").concat(c,")")),L(e.getAudioTracks(),s),L(e.getVideoTracks(),c),r.localUsermediaStream.getTracks()))r.localUsermediaStream.removeTrack(l),l.stop();for(var d of e.getTracks())r.localUsermediaStream.addTrack(d);var h=function*(){var t=x(u.h.Usermedia,v.kind),n=r.transceivers.get(t),i=null===n||void 0===n?void 0:n.sender,s=!1;if(i)try{a.v.info("Call ".concat(r.callId," updateLocalUsermediaStream() replacing track (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")")),yield i.replaceTrack(v),n.direction="inactive"===n.direction?"sendonly":"sendrecv",s=!0}catch(d){a.v.warn("Call ".concat(r.callId," updateLocalUsermediaStream() replaceTrack failed: adding new transceiver instead"),d)}if(!s){a.v.info("Call ".concat(r.callId," updateLocalUsermediaStream() adding track to peer connection (id=").concat(v.id,", kind=").concat(v.kind,", streamId=").concat(e.id,", streamPurpose=").concat(o.purpose,")"));var c=r.peerConn.addTrack(v,r.localUsermediaStream),l=r.peerConn.getTransceivers().find((e=>e.sender===c));l?r.transceivers.set(t,l):a.v.warn("Call ".concat(r.callId," updateLocalUsermediaStream() couldn't find matching transceiver for newly added track!"))}};for(var v of e.getTracks())yield*h()}))()}setLocalVideoMuted(e){var t=this;return(0,n.A)((function*(){var r,n;if(a.v.log("Call ".concat(t.callId," setLocalVideoMuted() running ").concat(e)),e||void 0===t.stopVideoTrackTimer||(clearTimeout(t.stopVideoTrackTimer),t.stopVideoTrackTimer=void 0),!(yield t.client.getMediaHandler().hasVideoDevice()))return t.isLocalVideoMuted();if(!t.hasUserMediaVideoSender&&!e)return null===(n=t.localUsermediaFeed)||void 0===n||n.setAudioVideoMuted(null,e),yield t.upgradeCall(!1,!0),t.isLocalVideoMuted();if(!e&&0===t.localUsermediaStream.getVideoTracks().length){var i=yield t.client.getMediaHandler().getUserMediaStream(!0,!0);yield t.updateLocalUsermediaStream(i)}return null===(r=t.localUsermediaFeed)||void 0===r||r.setAudioVideoMuted(null,e),t.updateMuteStatus(),yield t.sendMetadataUpdate(),e&&(t.stopVideoTrackTimer=setTimeout((()=>{for(var e of t.localUsermediaStream.getVideoTracks())e.stop(),t.localUsermediaStream.removeTrack(e)}),120)),t.isLocalVideoMuted()}))()}isLocalVideoMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isVideoMuted())&&void 0!==e&&e}setMicrophoneMuted(e){var t=this;return(0,n.A)((function*(){var r;return a.v.log("Call ".concat(t.callId," setMicrophoneMuted() running ").concat(e)),(yield t.client.getMediaHandler().hasAudioDevice())?e||t.hasUserMediaAudioSender&&t.hasLocalUserMediaAudioTrack?(null===(r=t.localUsermediaFeed)||void 0===r||r.setAudioVideoMuted(e,null),t.updateMuteStatus(),yield t.sendMetadataUpdate(),t.isMicrophoneMuted()):(yield t.upgradeCall(!0,!1),t.isMicrophoneMuted()):t.isMicrophoneMuted()}))()}isMicrophoneMuted(){var e,t;return null!==(e=null===(t=this.localUsermediaFeed)||void 0===t?void 0:t.isAudioMuted())&&void 0!==e&&e}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){for(var t of(this.remoteOnHold=e,this.peerConn.getTransceivers()))t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.sendMetadataUpdate(),this.emit(w.RemoteHoldUnhold,this.remoteOnHold,this)}}isLocalOnHold(){if(this.state!==S.Connected)return!1;var e=!0;for(var t of this.peerConn.getTransceivers()){var r=["inactive","recvonly"].includes(t.currentDirection);r||(e=!1)}return e}sendDtmfDigit(e){for(var t of this.peerConn.getSenders()){var r;if("audio"===(null===(r=t.track)||void 0===r?void 0:r.kind)&&t.dtmf)return void t.dtmf.insertDTMF(e)}throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){var e=this.isMicrophoneMuted()||this.remoteOnHold,t=this.isLocalVideoMuted()||this.remoteOnHold;a.v.log("Call ".concat(this.callId," updateMuteStatus stream ").concat(this.localUsermediaStream.id," micShouldBeMuted ").concat(e," vidShouldBeMuted ").concat(t)),L(this.localUsermediaStream.getAudioTracks(),!e),L(this.localUsermediaStream.getVideoTracks(),!t)}sendMetadataUpdate(){var e=this;return(0,n.A)((function*(){yield e.sendVoipEvent(l.Bx.CallSDPStreamMetadataChangedPrefix,{[u.A]:e.getLocalSDPStreamMetadata()})}))()}gotCallFeedsForInvite(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.successor)this.successor.queueGotCallFeedsForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{for(var r of e)this.pushLocalFeed(r);t&&this.peerConn.addTransceiver("video",{direction:"recvonly"}),this.state=S.CreateOffer,a.v.debug("Call ".concat(this.callId," gotUserMediaForInvite() run"))}}sendAnswer(){var e=this;return(0,n.A)((function*(){var t={answer:{sdp:e.peerConn.localDescription.sdp,type:e.peerConn.localDescription.type},[u.A]:e.getLocalSDPStreamMetadata(!0)};t.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1};var r=e.discardDuplicateCandidates();a.v.info("Call ".concat(e.callId," sendAnswer() discarding ").concat(r," candidates that will be sent in answer"));try{yield e.sendVoipEvent(l.Bx.CallAnswer,t),e.inviteOrAnswerSent=!0}catch(o){e.state=S.Ringing,o instanceof g.up&&o.event&&e.client.cancelPendingEvent(o.event);var n=I.SendAnswer,i="Failed to send answer";throw"UnknownDeviceError"==o.name&&(n=I.UnknownDevices,i="Unknown devices present in the room"),e.emit(w.Error,new D(n,i,o),e),o}e.sendCandidateQueue()}))()}queueGotCallFeedsForAnswer(e){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then((()=>this.gotCallFeedsForAnswer(e))):this.responsePromiseChain=this.gotCallFeedsForAnswer(e)}mungeSdp(e,t){var r=(0,s.qg)(e.sdp);r.media.forEach((e=>{var r=new Map,n=new Map;for(var i of e.rtp)r.set(i.payload,i.codec),n.set(i.codec,i.payload);for(var o of t)if(o.mediaType===e.type)if(n.has(o.codec)){var s=[];void 0!==o.enableDtx&&s.push("usedtx=".concat(o.enableDtx?"1":"0")),void 0!==o.maxAverageBitrate&&s.push("maxaveragebitrate=".concat(o.maxAverageBitrate));var c=!1;for(var l of e.fmtp)r.get(l.payload)===o.codec&&(c=!0,l.config+=";"+s.join(";"));c||e.fmtp.push({payload:n.get(o.codec),config:s.join(";")})}else a.v.info("Call ".concat(this.callId," mungeSdp() ignoring SDP modifications for ").concat(o.codec," as it's not present."))})),e.sdp=(0,s.M9)(r)}createOffer(){var e=this;return(0,n.A)((function*(){var t=yield e.peerConn.createOffer();return e.mungeSdp(t,P(e.isPtt)),t}))()}createAnswer(){var e=this;return(0,n.A)((function*(){var t=yield e.peerConn.createAnswer();return e.mungeSdp(t,P(e.isPtt)),t}))()}gotCallFeedsForAnswer(e){var t=this;return(0,n.A)((function*(){if(!t.callHasEnded()){for(var r of(t.waitForLocalAVStream=!1,e))t.pushLocalFeed(r);var n;t.state=S.CreateAnswer;try{t.getRidOfRTXCodecs(),n=yield t.createAnswer()}catch(i){return a.v.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() failed to create answer: "),i),void t.terminate(_.Local,I.CreateAnswer,!0)}try{if(yield t.peerConn.setLocalDescription(n),t.callHasEnded())return;if(t.state=S.Connecting,yield new Promise((e=>{setTimeout(e,200)})),t.callHasEnded())return;t.sendAnswer()}catch(i){return a.v.debug("Call ".concat(t.callId," gotCallFeedsForAnswer() error setting local description!"),i),void t.terminate(_.Local,I.SetLocalDescription,!0)}}}))()}onRemoteIceCandidatesReceived(e){var t=this;return(0,n.A)((function*(){if(!t.callHasEnded()){var r=e.getContent(),n=r.candidates;if(n){var i=0===r.version?null:r.party_id||null;if(void 0!==t.opponentPartyId)t.partyIdMatches(r)?yield t.addIceCandidates(n):a.v.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates from party ID ").concat(r.party_id,": we have chosen party ID ").concat(t.opponentPartyId));else if(i){a.v.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() buffering ").concat(n.length," candidates until we pick an opponent"));var o=t.remoteCandidateBuffer.get(i)||[];o.push(...n),t.remoteCandidateBuffer.set(i,o)}}else a.v.info("Call ".concat(t.callId," onRemoteIceCandidatesReceived() ignoring candidates event with no candidates!"))}}))()}onAnswerReceived(e){var t=this;return(0,n.A)((function*(){var r=e.getContent();if(a.v.debug("Call ".concat(t.callId," onAnswerReceived() running (hangupParty=").concat(r.party_id,")")),t.callHasEnded())a.v.debug("Call ".concat(t.callId," onAnswerReceived() ignoring answer because call has ended"));else if(void 0===t.opponentPartyId){t.chooseOpponent(e),yield t.addBufferedIceCandidates(),t.state=S.Connecting;var n=r[u.A];n?t.updateRemoteSDPStreamMetadata(n):a.v.warn("Call ".concat(t.callId," onAnswerReceived() did not get any SDPStreamMetadata! Can not send/receive multiple streams"));try{t.isSettingRemoteAnswerPending=!0,yield t.peerConn.setRemoteDescription(r.answer),t.isSettingRemoteAnswerPending=!1,a.v.debug("Call ".concat(t.callId," onAnswerReceived() set remote description: ").concat(r.answer.type))}catch(i){return t.isSettingRemoteAnswerPending=!1,a.v.debug("Call ".concat(t.callId," onAnswerReceived() failed to set remote description"),i),void t.terminate(_.Local,I.SetRemoteDescription,!1)}if(null!==t.opponentPartyId)try{yield t.sendVoipEvent(l.Bx.CallSelectAnswer,{selected_party_id:t.opponentPartyId})}catch(o){a.v.warn("Call ".concat(t.callId," onAnswerReceived() failed to send select_answer event"),o)}}else a.v.info("Call ".concat(t.callId," onAnswerReceived() ignoring answer from party ID ").concat(r.party_id,": we already have an answer/reject from ").concat(t.opponentPartyId))}))()}onSelectAnswerReceived(e){var t=this;return(0,n.A)((function*(){if(t.direction===E.Inbound){var r=e.getContent().selected_party_id;void 0!==r&&null!==r?r!==t.ourPartyId&&(a.v.info("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for party ID ").concat(r,": we are party ID ").concat(t.ourPartyId,".")),yield t.terminate(_.Remote,I.AnsweredElsewhere,!0)):a.v.warn("Call ".concat(t.callId," onSelectAnswerReceived() got nonsensical select_answer with null/undefined selected_party_id: ignoring"))}else a.v.warn("Call ".concat(t.callId," onSelectAnswerReceived() got select_answer for an outbound call: ignoring"))}))()}onNegotiateReceived(e){var t=this;return(0,n.A)((function*(){var r=e.getContent(),n=r.description;if(n&&n.sdp&&n.type){var i=t.direction===E.Inbound,o=!t.makingOffer&&("stable"===t.peerConn.signalingState||t.isSettingRemoteAnswerPending),s="offer"===n.type&&!o;if(t.ignoreOffer=!i&&s,t.ignoreOffer)a.v.info("Call ".concat(t.callId," onNegotiateReceived() ignoring colliding negotiate event because we're impolite"));else{var c=t.isLocalOnHold(),d=r[u.A];d?t.updateRemoteSDPStreamMetadata(d):a.v.warn("Call ".concat(t.callId," onNegotiateReceived() received negotiation event without SDPStreamMetadata!"));try{if(t.isSettingRemoteAnswerPending="answer"==n.type,yield t.peerConn.setRemoteDescription(n),t.isSettingRemoteAnswerPending=!1,a.v.debug("Call ".concat(t.callId," onNegotiateReceived() set remote description: ").concat(n.type)),"offer"===n.type){var h,v;try{t.getRidOfRTXCodecs(),v=yield t.createAnswer()}catch(f){return a.v.debug("Call ".concat(t.callId," onNegotiateReceived() failed to create answer: "),f),void t.terminate(_.Local,I.CreateAnswer,!0)}yield t.peerConn.setLocalDescription(v),a.v.debug("Call ".concat(t.callId," onNegotiateReceived() create an answer")),t.sendVoipEvent(l.Bx.CallNegotiate,{lifetime:k,description:null===(h=t.peerConn.localDescription)||void 0===h?void 0:h.toJSON(),[u.A]:t.getLocalSDPStreamMetadata(!0)})}}catch(f){t.isSettingRemoteAnswerPending=!1,a.v.warn("Call ".concat(t.callId," onNegotiateReceived() failed to complete negotiation"),f)}var p=t.isLocalOnHold();c!==p&&(t.emit(w.LocalHoldUnhold,p,t),t.emit(w.HoldUnhold,p))}}else a.v.info("Call ".concat(t.callId," onNegotiateReceived() ignoring invalid m.call.negotiate event"))}))()}updateRemoteSDPStreamMetadata(e){for(var t of(this.remoteSDPStreamMetadata=(0,c.Bi)(this.remoteSDPStreamMetadata||{},e,!0),this.getRemoteFeeds())){var r,n=t.stream.id,i=this.remoteSDPStreamMetadata[n];t.setAudioVideoMuted(null===i||void 0===i?void 0:i.audio_muted,null===i||void 0===i?void 0:i.video_muted),t.purpose=null===(r=this.remoteSDPStreamMetadata[n])||void 0===r?void 0:r.purpose}}onSDPStreamMetadataChangedReceived(e){var t=e.getContent(),r=t[u.A];this.updateRemoteSDPStreamMetadata(r)}onAssertedIdentityReceived(e){var t=this;return(0,n.A)((function*(){var r=e.getContent();r.asserted_identity&&(t.remoteAssertedIdentity={id:r.asserted_identity.id,displayName:r.asserted_identity.display_name},t.emit(w.AssertedIdentityChanged,t))}))()}callHasEnded(){return this.state===S.Ended}queueGotLocalOffer(){this.responsePromiseChain?this.responsePromiseChain=this.responsePromiseChain.then((()=>this.wrappedGotLocalOffer())):this.responsePromiseChain=this.wrappedGotLocalOffer()}wrappedGotLocalOffer(){var e=this;return(0,n.A)((function*(){e.makingOffer=!0;try{yield e.gotLocalOffer()}catch(t){return void e.getLocalOfferFailed(t)}finally{e.makingOffer=!1}}))()}gotLocalOffer(){var e=this;return(0,n.A)((function*(){if(a.v.debug("Call ".concat(e.callId," gotLocalOffer() running")),e.callHasEnded())a.v.debug("Call ".concat(e.callId,' gotLocalOffer() ignoring newly created offer because the call has ended"'));else{var t;try{e.getRidOfRTXCodecs(),t=yield e.createOffer()}catch(h){return a.v.debug("Call ".concat(e.callId," gotLocalOffer() failed to create offer: "),h),void e.terminate(_.Local,I.CreateOffer,!0)}try{yield e.peerConn.setLocalDescription(t)}catch(h){return a.v.debug("Call ".concat(e.callId," gotLocalOffer() error setting local description!"),h),void e.terminate(_.Local,I.SetLocalDescription,!0)}if("gathering"===e.peerConn.iceGatheringState&&(yield new Promise((e=>{setTimeout(e,200)}))),!e.callHasEnded()){var r,n,i=e.state===S.CreateOffer?l.Bx.CallInvite:l.Bx.CallNegotiate,o={lifetime:k};if(i===l.Bx.CallInvite&&e.invitee&&(o.invitee=e.invitee),e.state===S.CreateOffer)o.offer=null===(r=e.peerConn.localDescription)||void 0===r?void 0:r.toJSON();else o.description=null===(n=e.peerConn.localDescription)||void 0===n?void 0:n.toJSON();o.capabilities={"m.call.transferee":e.client.supportsCallTransfer,"m.call.dtmf":!1},o[u.A]=e.getLocalSDPStreamMetadata(!0);var s=e.discardDuplicateCandidates();a.v.info("Call ".concat(e.callId," gotLocalOffer() discarding ").concat(s," candidates that will be sent in offer"));try{yield e.sendVoipEvent(i,o)}catch(v){a.v.error("Call ".concat(e.callId," gotLocalOffer() failed to send invite"),v),v instanceof g.up&&v.event&&e.client.cancelPendingEvent(v.event);var c=I.SignallingFailed,d="Signalling failed";return e.state===S.CreateOffer&&(c=I.SendInvite,d="Failed to send invite"),"UnknownDeviceError"==v.name&&(c=I.UnknownDevices,d="Unknown devices present in the room"),e.emit(w.Error,new D(c,d,v),e),void e.terminate(_.Local,c,!1)}e.sendCandidateQueue(),e.state===S.CreateOffer&&(e.inviteOrAnswerSent=!0,e.state=S.InviteSent,e.inviteTimeout=setTimeout((()=>{e.inviteTimeout=void 0,e.state===S.InviteSent&&e.hangup(I.InviteTimeout,!1)}),k))}}}))()}getRidOfRTXCodecs(){if(RTCRtpReceiver.getCapabilities&&RTCRtpSender.getCapabilities){var e=this.transceivers.get(x(u.h.Screenshare,"video"));if(e&&e.setCodecPreferences){var t=RTCRtpReceiver.getCapabilities("video").codecs,r=RTCRtpSender.getCapabilities("video").codecs,n=[];for(var i of[...t,...r])if("video/rtx"!==i.mimeType){n.push(i);try{e.setCodecPreferences(n)}catch(o){a.v.info("Working around buggy WebRTC impl: claimed to support codec but threw when setting codec preferences",i,o),n.pop()}}}}}sendVoipEvent(e,t){var r=this;return(0,n.A)((function*(){var n=y(y({},t),{},{version:T,call_id:r.callId,party_id:r.ourPartyId,conf_id:r.groupCallId});if(r.opponentDeviceId){var i,s=r.toDeviceSeq++,c=y(y({},n),{},{device_id:r.client.deviceId,sender_session_id:r.client.getSessionId(),dest_session_id:r.opponentSessionId,seq:s,[l.wt]:(0,o.A)()});r.emit(w.SendVoipEvent,{type:"toDevice",eventType:e,userId:r.invitee||(null===(i=r.getOpponentMember())||void 0===i?void 0:i.userId),opponentDeviceId:r.opponentDeviceId,content:c},r);var d=r.invitee||r.getOpponentMember().userId;if(r.client.getUseE2eForGroupCall()){if(!r.opponentDeviceInfo)return void a.v.warn("Call ".concat(r.callId," sendVoipEvent() failed: we do not have opponentDeviceInfo"));yield r.client.encryptAndSendToDevices([{userId:d,deviceInfo:r.opponentDeviceInfo}],{type:e,content:c})}else yield r.client.sendToDevice(e,new Map([[d,new Map([[r.opponentDeviceId,c]])]]))}else{var u;r.emit(w.SendVoipEvent,{type:"sendEvent",eventType:e,roomId:r.roomId,content:n,userId:r.invitee||(null===(u=r.getOpponentMember())||void 0===u?void 0:u.userId)},r),yield r.client.sendEvent(r.roomId,e,n)}}))()}queueCandidate(e){if(e?this.candidateSendQueue.push(e):this.candidatesEnded=!0,this.state!==S.Ringing&&this.inviteOrAnswerSent){var t=this.direction===E.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout((()=>{this.sendCandidateQueue()}),t)}}discardDuplicateCandidates(){for(var e=0,t=[],r=0;r<this.candidateSendQueue.length;r++){var n=this.candidateSendQueue[r];""===n.candidate?t.push(n):e++}return this.candidateSendQueue=t,e}transfer(e){var t=this;return(0,n.A)((function*(){var r=yield t.client.getProfileInfo(e),n=M(),i={replacement_id:M(),target_user:{id:e,display_name:r.displayname,avatar_url:r.avatar_url},create_call:n};yield t.sendVoipEvent(l.Bx.CallReplaces,i),yield t.terminate(_.Local,I.Transferred,!0)}))()}transferToCall(e){var t=this;return(0,n.A)((function*(){var r,n,i=null===(r=e.getOpponentMember())||void 0===r?void 0:r.userId,o=i?yield t.client.getProfileInfo(i):void 0,s=null===(n=t.getOpponentMember())||void 0===n?void 0:n.userId,a=s?yield t.client.getProfileInfo(s):void 0,c=M(),d={replacement_id:M(),target_user:{id:s,display_name:null===a||void 0===a?void 0:a.displayname,avatar_url:null===a||void 0===a?void 0:a.avatar_url},await_call:c};yield e.sendVoipEvent(l.Bx.CallReplaces,d);var u={replacement_id:M(),target_user:{id:i,display_name:null===o||void 0===o?void 0:o.displayname,avatar_url:null===o||void 0===o?void 0:o.avatar_url},create_call:c};yield t.sendVoipEvent(l.Bx.CallReplaces,u),yield t.terminate(_.Local,I.Transferred,!0),yield e.terminate(_.Local,I.Transferred,!0)}))()}terminate(e,t,r){var i=this;return(0,n.A)((function*(){var n;if(!i.callHasEnded()){for(var[o,s]of(i.hangupParty=e,i.hangupReason=t,i.state=S.Ended,i.inviteTimeout&&(clearTimeout(i.inviteTimeout),i.inviteTimeout=void 0),void 0!==i.iceDisconnectedTimeout&&(clearTimeout(i.iceDisconnectedTimeout),i.iceDisconnectedTimeout=void 0),i.callLengthInterval&&(clearInterval(i.callLengthInterval),i.callLengthInterval=void 0),void 0!==i.stopVideoTrackTimer&&(clearTimeout(i.stopVideoTrackTimer),i.stopVideoTrackTimer=void 0),i.removeTrackListeners))o.removeEventListener("removetrack",s);i.removeTrackListeners.clear(),i.callStatsAtEnd=yield i.collectCallStats(),i.stopAllMedia(),i.deleteAllFeeds(),i.peerConn&&"closed"!==i.peerConn.signalingState&&i.peerConn.close(),null===(n=i.stats)||void 0===n||n.removeStatsReportGatherer(i.callId),r&&i.emit(w.Hangup,i),i.client.callEventHandler.calls.delete(i.callId)}}))()}stopAllMedia(){for(var e of(a.v.debug("Call ".concat(this.callId," stopAllMedia() running")),this.feeds))if(e.isLocal()&&e.purpose===u.h.Usermedia)this.client.getMediaHandler().stopUserMediaStream(e.stream);else if(e.isLocal()&&e.purpose===u.h.Screenshare)this.client.getMediaHandler().stopScreensharingStream(e.stream);else if(!e.isLocal())for(var t of(a.v.debug("Call ".concat(this.callId," stopAllMedia() stopping stream (streamId=").concat(e.stream.id,")")),e.stream.getTracks()))t.stop()}checkForErrorListener(){if(0===this.listeners(v.u.Error).length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){var e=this;return(0,n.A)((function*(){if(0!==e.candidateSendQueue.length&&!e.callHasEnded()){var t=e.candidateSendQueue;e.candidateSendQueue=[],++e.candidateSendTries;var r={candidates:t.map((e=>e.toJSON()))};e.candidatesEnded&&r.candidates.push({candidate:""}),a.v.debug("Call ".concat(e.callId," sendCandidateQueue() attempting to send ").concat(t.length," candidates"));try{yield e.sendVoipEvent(l.Bx.CallCandidates,r),e.candidateSendTries=0,e.sendCandidateQueue()}catch(s){if(s instanceof g.up&&s.event&&e.client.cancelPendingEvent(s.event),e.candidateSendQueue.push(...t),e.candidateSendTries>5){a.v.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates on attempt ").concat(e.candidateSendTries,". Giving up on this call."),s);var n=I.SignallingFailed,i="Signalling failed";return e.emit(w.Error,new D(n,i,s),e),void e.hangup(n,!1)}var o=500*Math.pow(2,e.candidateSendTries);++e.candidateSendTries,a.v.debug("Call ".concat(e.callId," sendCandidateQueue() failed to send candidates. Retrying in ").concat(o,"ms"),s),setTimeout((()=>{e.sendCandidateQueue()}),o)}}}))()}placeCall(e,t){var r=this;return(0,n.A)((function*(){if(!e)throw new Error("You CANNOT start a call without audio");var n;r.state=S.WaitLocalMedia;try{var i,o=yield r.client.getMediaHandler().getUserMediaStream(e,t);L(o.getAudioTracks(),!0),L(o.getVideoTracks(),!0),n=new h.Hh({client:r.client,roomId:r.roomId,userId:r.client.getUserId(),deviceId:null!==(i=r.client.getDeviceId())&&void 0!==i?i:void 0,stream:o,purpose:u.h.Usermedia,audioMuted:!1,videoMuted:!1})}catch(s){return void r.getUserMediaFailed(s)}try{yield r.placeCallWithCallFeeds([n])}catch(s){return void r.placeCallFailed(s)}}))()}placeCallWithCallFeeds(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]&&t[1];r.checkForErrorListener(),r.direction=E.Outbound,yield r.initOpponentCrypto(),r.client.callEventHandler.calls.set(r.callId,r);var i=yield r.client.checkTurnServers();i||a.v.warn("Call ".concat(r.callId," placeCallWithCallFeeds() failed to get TURN credentials! Proceeding with call anyway...")),r.peerConn=r.createPeerConnection(),r.emit(w.PeerConnectionCreated,r.peerConn,r),r.gotCallFeedsForInvite(e,n)}))()}createPeerConnection(){var e,t=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers.length?this.turnServers:void 0,iceCandidatePoolSize:this.client.iceCandidatePoolSize,bundlePolicy:"max-bundle"});t.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),t.addEventListener("signalingstatechange",this.onSignallingStateChanged),t.addEventListener("icecandidate",this.gotLocalIceCandidate),t.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),t.addEventListener("track",this.onTrack),t.addEventListener("negotiationneeded",this.onNegotiationNeeded),t.addEventListener("datachannel",this.onDataChannel);var r=this.getOpponentMember(),n=r?r.userId:"unknown";return null===(e=this.stats)||void 0===e||e.addStatsReportGatherer(this.callId,n,t),t}partyIdMatches(e){var t=0===e.version?null:e.party_id||null;return t===this.opponentPartyId}chooseOpponent(e){var t,r,n=e.getContent();(a.v.debug("Call ".concat(this.callId," chooseOpponent() running (partyId=").concat(n.party_id,")")),this.opponentVersion=n.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=n.party_id||null,this.opponentCaps=n.capabilities||{},this.opponentMember=null!==(t=this.client.getRoom(this.roomId).getMember(e.getSender()))&&void 0!==t?t:void 0,this.opponentMember)&&(null===(r=this.stats)||void 0===r||r.updateOpponentMember(this.callId,this.opponentMember.userId))}addBufferedIceCandidates(){var e=this;return(0,n.A)((function*(){var t=e.remoteCandidateBuffer.get(e.opponentPartyId);t&&(a.v.info("Call ".concat(e.callId," addBufferedIceCandidates() adding ").concat(t.length," buffered candidates for opponent ").concat(e.opponentPartyId)),yield e.addIceCandidates(t)),e.remoteCandidateBuffer.clear()}))()}addIceCandidates(e){var t=this;return(0,n.A)((function*(){for(var r of e){null!==r.sdpMid&&void 0!==r.sdpMid||null!==r.sdpMLineIndex&&void 0!==r.sdpMLineIndex?a.v.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE candidate (sdpMid=").concat(r.sdpMid,", candidate=").concat(r.candidate,")")):a.v.debug("Call ".concat(t.callId," addIceCandidates() got remote ICE end-of-candidates"));try{yield t.peerConn.addIceCandidate(r)}catch(n){t.ignoreOffer?a.v.debug("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate because ignoring offer"),n):a.v.info("Call ".concat(t.callId," addIceCandidates() failed to add remote ICE candidate"),n)}}}))()}get hasPeerConnection(){return Boolean(this.peerConn)}initStats(e){this.stats=e,this.stats.start()}}function L(e,t){for(var r of e)r.enabled=t}function N(){if("undefined"===typeof window||"undefined"===typeof document)return!1;try{var e,t,r,n=Boolean(null!==(e=null!==(t=null!==(r=window.RTCPeerConnection)&&void 0!==r?r:window.RTCSessionDescription)&&void 0!==t?t:window.RTCIceCandidate)&&void 0!==e?e:navigator.mediaDevices);if(!n)return a.v.error("WebRTC is not supported in this browser / environment"),!1}catch(i){return a.v.error("Exception thrown when trying to access WebRTC",i),!1}return!0}function B(e,t,r){if(!N())return null;var n=!!r&&r.forceTURN,i={client:e,roomId:t,invitee:null===r||void 0===r?void 0:r.invitee,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||n,opponentDeviceId:null===r||void 0===r?void 0:r.opponentDeviceId,opponentSessionId:null===r||void 0===r?void 0:r.opponentSessionId,groupCallId:null===r||void 0===r?void 0:r.groupCallId},o=new U(i);return e.reEmitter.reEmit(o,Object.values(w)),o}},3124:function(e,t,r){"use strict";r.d(t,{q:function(){return s}});r(8111),r(2489),r(1701);var n=r(4761),i=r(2292);class o{constructor(e){this.ourEvent=e,(0,n.A)(this,"timeline",void 0),(0,n.A)(this,"ourEventIndex",0),(0,n.A)(this,"paginateTokens",{[i.O.Backward]:null,[i.O.Forward]:null}),this.timeline=[e]}getEvent(){return this.timeline[this.ourEventIndex]}getTimeline(){return this.timeline}getOurEventIndex(){return this.ourEventIndex}getPaginateToken(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return this.paginateTokens[e?i.O.Backward:i.O.Forward]}setPaginateToken(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.paginateTokens[t?i.O.Backward:i.O.Forward]=null!==e&&void 0!==e?e:null}addEvents(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t?(this.timeline=e.concat(this.timeline),this.ourEventIndex+=e.length):this.timeline=this.timeline.concat(e)}}class s{static fromJson(e,t){var r=e.context||{},n=(r.events_before||[]).map(t),i=(r.events_after||[]).map(t),a=new o(t(e.result)),c=a.ourEvent.threadRootId;return n=n.filter((e=>e.threadRootId===c)),i=i.filter((e=>e.threadRootId===c)),a.setPaginateToken(r.start,!0),a.addEvents(n,!0),a.addEvents(i,!1),a.setPaginateToken(r.end,!1),new s(e.rank,a)}constructor(e,t){this.rank=e,this.context=t}}},3167:function(e,t,r){"use strict";var n=r(4901),i=r(34),o=r(2967);e.exports=function(e,t,r){var s,a;return o&&n(s=t.constructor)&&s!==r&&i(a=s.prototype)&&a!==r.prototype&&o(e,a),e}},3178:function(e,t,r){"use strict";r.d(t,{OQ:function(){return m},fb:function(){return f.f},kl:function(){return y}});r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(698),i=r(4761),o=r(7046),s=r(3271),a=r(5629),c=r(6170),l=r(7528),d=r(5462),u=r(2668),h=r(1366),v=r(2292),p=r(4864),f=r(4977),g=Object.freeze({visible:!0}),m=function(e){return e["Decrypted"]="Event.decrypted",e["BeforeRedaction"]="Event.beforeRedaction",e["VisibilityChange"]="Event.visibilityChange",e["LocalEventIdReplaced"]="Event.localEventIdReplaced",e["Status"]="Event.status",e["Replaced"]="Event.replaced",e["RelationsCreated"]="Event.relationsCreated",e["SentinelUpdated"]="Event.sentinelUpdated",e}({});class y extends u.X{setMetadata(e,t){var r,n,i=this.isState()&&this.getType()===a.Bx.RoomMember&&this.getSender()===this.getStateKey(),o=!1;if(i||null===(r=this.sender)||void 0===r||null===(r=r.events)||void 0===r||!r.member){var s=e.getSentinelMember(this.getSender());s!==this.sender&&(o=!0),this.sender=s}if(i||(null===(n=this.target)||void 0===n||null===(n=n.events)||void 0===n||!n.member)&&this.getType()===a.Bx.RoomMember){var c=e.getSentinelMember(this.getStateKey());c!==this.target&&(o=!0),this.target=c}this.isState()&&t&&(this.forwardLooking=!1),o&&this.emit(m.SentinelUpdated)}constructor(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};super(),this.event=t,(0,i.A)(this,"pushDetails",{}),(0,i.A)(this,"_replacingEvent",null),(0,i.A)(this,"_localRedactionEvent",null),(0,i.A)(this,"_isCancelled",!1),(0,i.A)(this,"clearEvent",void 0),(0,i.A)(this,"visibility",g),(0,i.A)(this,"_hasCachedExtEv",!1),(0,i.A)(this,"_cachedExtEv",void 0),(0,i.A)(this,"_decryptionFailureReason",null),(0,i.A)(this,"senderCurve25519Key",null),(0,i.A)(this,"claimedEd25519Key",null),(0,i.A)(this,"forwardingCurve25519KeyChain",[]),(0,i.A)(this,"untrusted",null),(0,i.A)(this,"decryptionPromise",null),(0,i.A)(this,"retryDecryption",!1),(0,i.A)(this,"txnId",void 0),(0,i.A)(this,"thread",void 0),(0,i.A)(this,"threadId",void 0),(0,i.A)(this,"localTimestamp",void 0),(0,i.A)(this,"sender",null),(0,i.A)(this,"target",null),(0,i.A)(this,"status",null),(0,i.A)(this,"error",null),(0,i.A)(this,"forwardLooking",!0),(0,i.A)(this,"verificationRequest",void 0),(0,i.A)(this,"reEmitter",void 0),["state_key","type","sender","room_id","membership"].forEach((e=>{"string"===typeof t[e]&&(t[e]=(0,c.yD)(t[e]))})),["membership","avatar_url","displayname"].forEach((e=>{var r;"string"===typeof(null===(r=t.content)||void 0===r?void 0:r[e])&&(t.content[e]=(0,c.yD)(t.content[e]))})),["rel_type"].forEach((e=>{var r;"string"===typeof(null===(r=t.content)||void 0===r||null===(r=r["m.relates_to"])||void 0===r?void 0:r[e])&&(t.content["m.relates_to"][e]=(0,c.yD)(t.content["m.relates_to"][e]))})),this.txnId=t.txn_id;var r=this.getAge();this.localTimestamp=void 0!==r?Date.now()-r:null!==(e=this.getTs())&&void 0!==e?e:Date.now(),this.reEmitter=new d.Q(this)}get unstableExtensibleEvent(){return this._hasCachedExtEv||(this._cachedExtEv=o.ExtensibleEvents.parse(this.getEffectiveEvent())),this._cachedExtEv}invalidateExtensibleEvent(){this._hasCachedExtEv=!1}getEffectiveEvent(){var e=Object.assign({},this.getContent());if(this.getWireType()===a.Bx.RoomMessageEncrypted)for(var[t,r]of Object.entries(this.getWireContent()))["algorithm","ciphertext","device_id","sender_key","session_id"].includes(t)||void 0===e[t]&&(e[t]=r);return Object.assign({},this.event,this.clearEvent,{content:e})}getId(){return this.event.event_id}getSender(){return this.event.sender}getType(){return this.clearEvent?this.clearEvent.type:this.event.type}getWireType(){return this.event.type}getRoomId(){return this.event.room_id}getTs(){return this.event.origin_server_ts}getDate(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null}getDetails(){var e,t=this.getRoomId();if(t)return"id=".concat(this.getId()," type=").concat(this.getWireType()," sender=").concat(this.getSender()," room=").concat(t," ts=").concat(null===(e=this.getDate())||void 0===e?void 0:e.toISOString());var r=this.getContent()[a.wt];return"msgid=".concat(r," type=").concat(this.getWireType()," sender=").concat(this.getSender())}getOriginalContent(){var e,t;return this._localRedactionEvent?{}:this.clearEvent?null!==(t=this.clearEvent.content)&&void 0!==t?t:{}:null!==(e=this.event.content)&&void 0!==e?e:{}}getContent(){return this._localRedactionEvent?{}:this._replacingEvent?null!==(e=this._replacingEvent.getContent()["m.new_content"])&&void 0!==e?e:{}:this.getOriginalContent();var e}getWireContent(){return this.event.content||{}}get threadRootId(){var e;if(!this.isState()){var t=null===(e=this.getWireContent())||void 0===e?void 0:e["m.relates_to"];if((null===t||void 0===t?void 0:t.rel_type)===l.RN.name)return t.event_id;if(this.thread)return this.thread.id;if(void 0!==this.threadId)return this.threadId;var r=this.getUnsigned();return"string"===typeof r[a.Sr.name]?r[a.Sr.name]:void 0}}get isThreadRoot(){if(this.isState())return!1;var e=this.getServerAggregatedRelation(l.RN.name);return!!e||this.threadRootId===this.getId()}get replyEventId(){var e;return null===(e=this.getWireContent()["m.relates_to"])||void 0===e||null===(e=e["m.in_reply_to"])||void 0===e?void 0:e.event_id}get relationEventId(){var e;return null===(e=this.getWireContent())||void 0===e||null===(e=e["m.relates_to"])||void 0===e?void 0:e.event_id}getPrevContent(){return this.getUnsigned().prev_content||{}}getDirectionalContent(){return this.forwardLooking?this.getContent():this.getPrevContent()}getAge(){return this.getUnsigned().age}getLocalAge(){return Date.now()-this.localTimestamp}getStateKey(){return this.event.state_key}isState(){return void 0!==this.event.state_key}getMembershipAtEvent(){var e=this.getUnsigned();return a.SY.findIn(e)}makeEncrypted(e,t,r,n){this.clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this.senderCurve25519Key=r,this.claimedEd25519Key=n}isBeingDecrypted(){return null!=this.decryptionPromise}getDecryptionPromise(){return this.decryptionPromise}isDecryptionFailure(){return null!==this._decryptionFailureReason}get decryptionFailureReason(){return this._decryptionFailureReason}get isEncryptedDisabledForUnverifiedDevices(){return this.decryptionFailureReason===p.DecryptionFailureCode.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE}shouldAttemptDecryption(){return!this.isRedacted()&&(!this.isBeingDecrypted()&&(!this.clearEvent&&!!this.isEncrypted()))}attemptDecryption(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};if(!r.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");var i=r.clearEvent&&!r.isDecryptionFailure(),o=n.forceRedecryptIfUntrusted&&r.isKeySourceUntrusted();if(i&&!o)throw new Error("Attempt to decrypt event which has already been decrypted");return r.decryptionPromise?(s.v.log("Event ".concat(r.getId()," already being decrypted; queueing a retry")),r.retryDecryption=!0,r.decryptionPromise):(r.decryptionPromise=r.decryptionLoop(e,n),r.decryptionPromise)}))()}cancelAndResendKeyRequest(e,t){var r=this.getWireContent();return e.requestRoomKey({algorithm:r.algorithm,room_id:this.getRoomId(),session_id:r.session_id,sender_key:r.sender_key},this.getKeyRequestRecipients(t),!0)}getKeyRequestRecipients(e){var t=[{userId:e,deviceId:"*"}];return t}decryptionLoop(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};yield Promise.resolve();while(1){r.retryDecryption=!1;var i=void 0;try{var o=yield e.decryptEvent(r);!0===n.isRetry&&s.v.info("Decrypted event on retry (".concat(r.getDetails(),")")),r.setClearData(o),r._decryptionFailureReason=null}catch(c){var a=c instanceof h.O?c.detailedString:String(c);if(i=c,r.retryDecryption){s.v.log("Error decrypting event (".concat(r.getDetails(),"), but retrying: ").concat(a));continue}s.v.warn("Error decrypting event (".concat(r.getDetails(),"): ").concat(a)),r.setClearDataForDecryptionFailure(String(c)),r._decryptionFailureReason=c instanceof h.O?c.code:p.DecryptionFailureCode.UNKNOWN_ERROR}return r.decryptionPromise=null,r.retryDecryption=!1,r.setPushDetails(),void(!1!==n.emit&&r.emit(m.Decrypted,r,i))}}))()}setClearData(e){var t,r;this.clearEvent=e.clearEvent,this.senderCurve25519Key=null!==(t=e.senderCurve25519Key)&&void 0!==t?t:null,this.claimedEd25519Key=null!==(r=e.claimedEd25519Key)&&void 0!==r?r:null,this.forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this.untrusted=e.untrusted||!1,this.invalidateExtensibleEvent()}setClearDataForDecryptionFailure(e){this.clearEvent={type:a.Bx.RoomMessage,content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: ".concat(e," **")}},this.senderCurve25519Key=null,this.claimedEd25519Key=null,this.forwardingCurve25519KeyChain=[],this.untrusted=!1,this.invalidateExtensibleEvent()}getClearContent(){return this.clearEvent?this.clearEvent.content:null}isEncrypted(){return!this.isState()&&this.event.type===a.Bx.RoomMessageEncrypted}getSenderKey(){return this.senderCurve25519Key}getKeysClaimed(){return this.claimedEd25519Key?{ed25519:this.claimedEd25519Key}:{}}getClaimedEd25519Key(){return this.claimedEd25519Key}getForwardingCurve25519KeyChain(){return this.forwardingCurve25519KeyChain}isKeySourceUntrusted(){return!!this.untrusted}getUnsigned(){return this.event.unsigned||{}}setUnsigned(e){this.event.unsigned=e}unmarkLocallyRedacted(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=void 0),!!e}markLocallyRedacted(e){this._localRedactionEvent||(this.emit(m.BeforeRedaction,this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)}applyVisibilityEvent(e){var t,r,n=null===(t=null===e||void 0===e?void 0:e.visible)||void 0===t||t,i=null!==(r=null===e||void 0===e?void 0:e.reason)&&void 0!==r?r:null,o=!1;this.visibility.visible!==n?o=!0:this.visibility.visible||this.visibility["reason"]===i||(o=!0),o&&(this.visibility=n?g:Object.freeze({visible:!1,reason:i}),this.emit(m.VisibilityChange,this,n))}messageVisibility(){return this.visibility}makeRedacted(e,t){if(!e.event)throw new Error("invalid redactionEvent in makeRedacted");for(var r in this._localRedactionEvent=null,this.emit(m.BeforeRedaction,this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(r)&&!S.has(r)&&delete this.event[r];this.isEncrypted()&&(this.clearEvent=void 0);var n=this.getType()in b?b[this.getType()]:{},i=this.getContent();for(var o in i)i.hasOwnProperty(o)&&!n[o]&&delete i[o];!this.isThreadRoot&&this.threadRootId&&this.threadRootId!==this.getId()&&(this.moveAllRelatedToMainTimeline(t),e.moveToMainTimeline(t)),this.invalidateExtensibleEvent()}moveAllRelatedToMainTimeline(e){var t=this.thread;if(this.moveToMainTimeline(e),t)for(var r of t.events){var n;(null===(n=r.getRelation())||void 0===n?void 0:n.event_id)===this.getId()&&r.moveAllRelatedToMainTimeline(e)}}moveToMainTimeline(e){var t;null===(t=this.thread)||void 0===t||t.timelineSet.removeEvent(this.getId()),this.setThread(void 0);var r=e.getLiveTimeline();r.getTimelineSet().insertEventIntoTimeline(this,r,r.getState(v.q.FORWARDS),!1)}isRedacted(){return Boolean(this.getUnsigned().redacted_because)}isRedaction(){return this.getType()===a.Bx.RoomRedaction}asVisibilityChange(){if(!a.Yg.matches(this.getType()))return null;var e=this.getRelation();if(!e||"m.reference"!=e.rel_type)return null;var t=e.event_id;if(!t)return null;var r=this.getWireContent(),n=!!r.visible,i=r.reason;return i&&"string"!=typeof i?null:{visible:n,reason:i,eventId:t}}isVisibilityEvent(){return a.Yg.matches(this.getType())}getRedactionEvent(){var e,t,r,n;return this.isRedacted()?null!==(e=this.clearEvent)&&void 0!==e&&e.unsigned?null!==(r=null===(n=this.clearEvent)||void 0===n?void 0:n.unsigned.redacted_because)&&void 0!==r?r:null:null!==(t=this.event.unsigned)&&void 0!==t&&t.redacted_because?this.event.unsigned.redacted_because:{}:null}getPushActions(){return this.pushDetails.actions||null}getPushDetails(){return this.pushDetails}setPushDetails(e,t){this.pushDetails={actions:e,rule:t}}handleRemoteEcho(e){var t,r=this.getUnsigned(),n=this.getId();this.event=e,r.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=r.redacted_because),this.setStatus(null),this.getId()!==n&&this.emit(m.LocalEventIdReplaced,this),this.localTimestamp=Date.now()-(null!==(t=this.getAge())&&void 0!==t?t:0)}isSending(){return!!this.status}setStatus(e){this.status=e,this.emit(m.Status,this,e)}replaceLocalEventId(e){this.event.event_id=e,this.emit(m.LocalEventIdReplaced,this)}isRelation(e){var t,r=null===(t=this.getWireContent())||void 0===t?void 0:t["m.relates_to"];return!(this.isState()&&null!==r&&void 0!==r&&r.rel_type&&[a.zZ.Replace,a.zZ.Thread].includes(r.rel_type))&&!(null===r||void 0===r||!r.rel_type||!r.event_id||e&&r.rel_type!==e)}getRelation(){var e;return this.isRelation()&&null!==(e=this.getWireContent()["m.relates_to"])&&void 0!==e?e:null}makeReplaced(e){this.isRedacted()&&e||this.isState()||this._replacingEvent!==e&&(this._replacingEvent=null!==e&&void 0!==e?e:null,this.emit(m.Replaced,this),this.invalidateExtensibleEvent())}getAssociatedStatus(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status}getServerAggregatedRelation(e){var t;return null===(t=this.getUnsigned()["m.relations"])||void 0===t?void 0:t[e]}replacingEventId(){var e=this.getServerAggregatedRelation(a.zZ.Replace);return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0}replacingEvent(){return this._replacingEvent}replacingEventDate(){var e=this.getServerAggregatedRelation(a.zZ.Replace);if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent){var r;return null!==(r=this._replacingEvent.getDate())&&void 0!==r?r:void 0}}localRedactionEvent(){return this._localRedactionEvent}getAssociatedId(){var e=this.getRelation();return this.replyEventId?this.replyEventId:e?e.event_id:this.isRedaction()?this.event.redacts:void 0}hasAssociation(){return!!this.getAssociatedId()}updateAssociatedId(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)}flagCancelled(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._isCancelled=e}isCancelled(){return this._isCancelled}toSnapshot(){var e=new y(JSON.parse(JSON.stringify(this.event)));for(var[t,r]of Object.entries(this))"event"!==t&&(e[t]=r);return e}isEquivalentTo(e){if(!e)return!1;if(e===this)return!0;var t=(0,c.hl)(this.event),r=(0,c.hl)(e.event);return JSON.stringify(t)===JSON.stringify(r)}toJSON(){var e=this.getEffectiveEvent();return this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}setVerificationRequest(e){this.verificationRequest=e}setTxnId(e){this.txnId=e}getTxnId(){return this.txnId}setThread(e){this.isState()||(this.thread&&this.reEmitter.stopReEmitting(this.thread,[l.ju.Update]),this.thread=e,this.setThreadId(null===e||void 0===e?void 0:e.id),e&&this.reEmitter.reEmit(e,[l.ju.Update]))}getThread(){return this.thread}setThreadId(e){this.threadId=e}}var S=new Set(["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"]),b={[a.Bx.RoomMember]:{membership:1},[a.Bx.RoomJoinRules]:{join_rule:1},[a.Bx.RoomPowerLevels]:{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1}}},3232:function(e,t,r){"use strict";r.d(t,{D7:function(){return s},Jv:function(){return c},bv:function(){return n},dx:function(){return o},k:function(){return i},rF:function(){return a}});var n=function(e){return e["Public"]="public",e["Private"]="private",e}({}),i=function(e){return e["PrivateChat"]="private_chat",e["TrustedPrivateChat"]="trusted_private_chat",e["PublicChat"]="public_chat",e}({}),o=function(e){return e["Public"]="public",e["Invite"]="invite",e["Private"]="private",e["Knock"]="knock",e["Restricted"]="restricted",e}({}),s=function(e){return e["RoomMembership"]="m.room_membership",e}({}),a=function(e){return e["CanJoin"]="can_join",e["Forbidden"]="forbidden",e}({}),c=function(e){return e["Invited"]="invited",e["Joined"]="joined",e["Shared"]="shared",e["WorldReadable"]="world_readable",e}({})},3238:function(e,t,r){"use strict";var n=r(4576),i=r(7811),o=r(7394),s=n.DataView;e.exports=function(e){if(!i||0!==o(e))return!1;try{return new s(e),!1}catch(t){return!0}}},3271:function(e,t,r){"use strict";r.d(t,{T:function(){return l},v:function(){return c}});var n=r(4761),i=r(7568),o="matrix";function s(e){var t=e;t.getChild=t.withPrefix=function(e){var t=this.prefix||"";return a(t+e)}}function a(e){var t=i.getLogger("".concat(o,"-").concat(e));return t.prefix!==e&&(s(t),t.prefix=e,t.setLevel(i.levels.DEBUG,!1)),t}i.methodFactory=function(e,t,r){return function(){for(var t=arguments.length,r=new Array(t),n=0;n<t;n++)r[n]=arguments[n];this.prefix&&r.unshift(this.prefix);var i="error"===e||"warn"===e||"trace"===e||"info"===e||"debug"===e;return i?console[e](...r):console.log(...r)}};var c=i.getLogger(o);c.setLevel(i.levels.DEBUG,!1),s(c);class l{constructor(e,t){this.parent=e,(0,n.A)(this,"name",void 0),this.name=t+":"}trace(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.trace(this.name,...t)}debug(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.debug(this.name,...t)}info(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.info(this.name,...t)}warn(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.warn(this.name,...t)}error(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];this.parent.error(this.name,...t)}}},3339:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function o(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function c(e){var t=v();return function(){var r,n=g(e);if(t){var i=g(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return l(this,r)}}function l(e,t){if(t&&("object"===n(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return d(e)}function d(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function u(e){var t="function"===typeof Map?new Map:void 0;return u=function(e){if(null===e||!p(e))return e;if("function"!==typeof e)throw new TypeError("Super expression must either be null or a function");if("undefined"!==typeof t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return h(e,arguments,g(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),f(r,e)},u(e)}function h(e,t,r){return h=v()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=Function.bind.apply(e,n),o=new i;return r&&f(o,r.prototype),o},h.apply(null,arguments)}function v(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function p(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function g(e){return g=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},g(e)}r(4114),Object.defineProperty(t,"__esModule",{value:!0}),t.InvalidEventError=void 0;var m=function(e){a(r,e);var t=c(r);function r(e){return s(this,r),t.call(this,e)}return o(r)}(u(Error));t.InvalidEventError=m},3378:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Symbols=void 0;var r=function(e){return e["AnyRoom"]="*",e}({});t.Symbols=r},3392:function(e,t,r){"use strict";var n=r(9504),i=0,o=Math.random(),s=n(1..toString);e.exports=function(e){return"Symbol("+(void 0===e?"":e)+")_"+s(++i+o,36)}},3440:function(e,t,r){"use strict";var n=r(7080),i=r(4402),o=r(9286),s=r(5170),a=r(3789),c=r(8469),l=r(507),d=i.has,u=i.remove;e.exports=function(e){var t=n(this),r=a(e),i=o(t);return s(t)<=r.size?c(t,(function(e){r.includes(e)&&u(i,e)})):l(r.getIterator(),(function(e){d(t,e)&&u(i,e)})),i}},3506:function(e,t,r){"use strict";var n=r(3925),i=String,o=TypeError;e.exports=function(e){if(n(e))return e;throw new o("Can't set "+i(e)+" as a prototype")}},3530:function(e,t,r){"use strict";r.d(t,{S:function(){return h},v:function(){return p}});r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);var n=r(698),i=r(4761),o=r(2696),s=r(944),a=r(8968),c=r(3271),l=r(9683),d=r(4519),u=r(3571),h="org.matrix.msc2697.v1.olm.libolm_pickle",v=6048e5;class p{constructor(e){this.crypto=e,(0,i.A)(this,"inProgress",!1),(0,i.A)(this,"timeoutId",void 0),(0,i.A)(this,"key",void 0),(0,i.A)(this,"keyInfo",void 0),(0,i.A)(this,"deviceDisplayName",void 0),this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){var e=this;return this.crypto.cryptoStore.doTxn("readonly",[a.y.STORE_ACCOUNT],(t=>{this.crypto.cryptoStore.getSecretStorePrivateKey(t,function(){var t=(0,n.A)((function*(t){if(t){var{key:r,keyInfo:n,deviceDisplayName:i,time:o}=t,a=Buffer.from(e.crypto.olmDevice.pickleKey),c=yield(0,d.A)(r,a,h);e.key=(0,s.y4)(c),e.keyInfo=n,e.deviceDisplayName=i;var l=Date.now(),u=Math.max(1,o+v-l);e.timeoutId=globalThis.setTimeout(e.dehydrateDevice.bind(e),u)}}));return function(e){return t.apply(this,arguments)}}(),"dehydration")}))}setKeyAndQueueDehydration(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{},i=t.length>2?t[2]:void 0,o=yield r.setKey(e,n,i);o||r.dehydrateDevice()}))()}setKey(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{},i=t.length>2?t[2]:void 0;if(!e)return r.timeoutId&&(globalThis.clearTimeout(r.timeoutId),r.timeoutId=void 0),yield r.crypto.cryptoStore.doTxn("readwrite",[a.y.STORE_ACCOUNT],(e=>{r.crypto.cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)})),r.key=void 0,void(r.keyInfo=void 0);for(var o=!!r.key&&e.length==r.key.length,s=0;o&&s<e.length;s++)e[s]!=r.key[s]&&(o=!1);return o||(r.key=e,r.keyInfo=n,r.deviceDisplayName=i),o}))()}dehydrateDevice(){var e=this;return(0,n.A)((function*(){if(e.inProgress)c.v.log("Dehydration already in progress -- not starting new dehydration");else{e.inProgress=!0,e.timeoutId&&(globalThis.clearTimeout(e.timeoutId),e.timeoutId=void 0);try{var t=Buffer.from(e.crypto.olmDevice.pickleKey),r=yield(0,u.A)((0,s.WG)(e.key),t,h);yield e.crypto.cryptoStore.doTxn("readwrite",[a.y.STORE_ACCOUNT],(t=>{e.crypto.cryptoStore.storeSecretStorePrivateKey(t,"dehydration",{keyInfo:e.keyInfo,key:r,deviceDisplayName:e.deviceDisplayName,time:Date.now()})})),c.v.log("Attempting to dehydrate device"),c.v.log("Creating account");var n=new globalThis.Olm.Account;n.create();var i=JSON.parse(n.identity_keys()),d=n.max_number_of_one_time_keys();n.generate_one_time_keys(d/2),n.generate_fallback_key();var p=JSON.parse(n.one_time_keys()),f=JSON.parse(n.fallback_key());n.mark_keys_as_published();var g=n.pickle(new Uint8Array(e.key)),m={algorithm:h,account:g};e.keyInfo.passphrase&&(m.passphrase=e.keyInfo.passphrase),c.v.log("Uploading account to server");var y=yield e.crypto.baseApis.http.authedRequest(l.IT.Put,"/dehydrated_device",void 0,{device_data:m,initial_device_display_name:e.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"}),S=y.device_id;c.v.log("Preparing device keys",S);var b={algorithms:e.crypto.supportedAlgorithms,device_id:S,user_id:e.crypto.userId,keys:{["ed25519:".concat(S)]:i.ed25519,["curve25519:".concat(S)]:i.curve25519}},E=n.sign(o.stringify(b));b.signatures={[e.crypto.userId]:{["ed25519:".concat(S)]:E}},e.crypto.crossSigningInfo.getId("self_signing")&&(yield e.crypto.crossSigningInfo.signObject(b,"self_signing")),c.v.log("Preparing one-time keys");var _={};for(var[w,I]of Object.entries(p.curve25519)){var T={key:I},R=n.sign(o.stringify(T));T.signatures={[e.crypto.userId]:{["ed25519:".concat(S)]:R}},_["signed_curve25519:".concat(w)]=T}c.v.log("Preparing fallback keys");var k={};for(var[A,C]of Object.entries(f.curve25519)){var O={key:C,fallback:!0},D=n.sign(o.stringify(O));O.signatures={[e.crypto.userId]:{["ed25519:".concat(S)]:D}},k["signed_curve25519:".concat(A)]=O}return c.v.log("Uploading keys to server"),yield e.crypto.baseApis.http.authedRequest(l.IT.Post,"/keys/upload/"+encodeURI(S),void 0,{device_keys:b,one_time_keys:_,"org.matrix.msc2732.fallback_keys":k}),c.v.log("Done dehydrating"),e.timeoutId=globalThis.setTimeout(e.dehydrateDevice.bind(e),v),S}finally{e.inProgress=!1}}}))()}stop(){this.timeoutId&&(globalThis.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}},3562:function(e,t,r){"use strict";r.d(t,{Qr:function(){return ar},cr:function(){return sr},D$:function(){return cr},DM:function(){return nr}});r(4114),r(6573),r(8100),r(7936),r(8111),r(2489),r(7588),r(1701),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698),r(7467),r(4732),r(9577);var n=r(698),i=r(4761),o=r(2696),s=r(5187),a=r(5629),c=r(5462),l=r(3271),d=r(8968),u=r(4864),h=r(1366),v=49152;class p extends Error{constructor(){super(...arguments),(0,i.A)(this,"data",{errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"})}}function f(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>v)throw new p("Message too long (".concat(e.length," bytes). ")+"The maximum for an encrypted message is ".concat(v," bytes."))}class g{constructor(e){this.cryptoStore=e,(0,i.A)(this,"pickleKey","DEFAULT_KEY"),(0,i.A)(this,"deviceCurve25519Key",null),(0,i.A)(this,"deviceEd25519Key",null),(0,i.A)(this,"maxOneTimeKeys",null),(0,i.A)(this,"outboundGroupSessionStore",{}),(0,i.A)(this,"inboundGroupSessionMessageIndexes",{}),(0,i.A)(this,"sessionsInProgress",{}),(0,i.A)(this,"olmPrekeyPromise",Promise.resolve())}static getOlmVersion(){return globalThis.Olm.get_library_version()}init(){var e=arguments,t=this;return(0,n.A)((function*(){var r,{pickleKey:n,fromExportedDevice:i}=e.length>0&&void 0!==e[0]?e[0]:{},o=new globalThis.Olm.Account;try{i?(n&&l.v.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),t.pickleKey=i.pickleKey,yield t.initialiseFromExportedDevice(i,o)):(n&&(t.pickleKey=n),yield t.initialiseAccount(o)),r=JSON.parse(o.identity_keys()),t.maxOneTimeKeys=o.max_number_of_one_time_keys()}finally{o.free()}t.deviceCurve25519Key=r.curve25519,t.deviceEd25519Key=r.ed25519}))()}initialiseFromExportedDevice(e,t){var r=this;return(0,n.A)((function*(){yield r.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT,d.y.STORE_SESSIONS],(t=>{r.cryptoStore.storeAccount(t,e.pickledAccount),e.sessions.forEach((e=>{var{deviceKey:n,sessionId:i}=e,o={session:e.session,lastReceivedMessageTs:e.lastReceivedMessageTs};r.cryptoStore.storeEndToEndSession(n,i,o,t)}))})),t.unpickle(r.pickleKey,e.pickledAccount)}))()}initialiseAccount(e){var t=this;return(0,n.A)((function*(){yield t.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT],(r=>{t.cryptoStore.getAccount(r,(n=>{null!==n?e.unpickle(t.pickleKey,n):(e.create(),n=e.pickle(t.pickleKey),t.cryptoStore.storeAccount(r,n))}))}))}))()}getAccount(e,t){this.cryptoStore.getAccount(e,(e=>{var r=new globalThis.Olm.Account;try{r.unpickle(this.pickleKey,e),t(r)}finally{r.free()}}))}storeAccount(e,t){this.cryptoStore.storeAccount(e,t.pickle(this.pickleKey))}export(){var e=this;return(0,n.A)((function*(){var t={pickleKey:e.pickleKey};return yield e.cryptoStore.doTxn("readonly",[d.y.STORE_ACCOUNT,d.y.STORE_SESSIONS],(r=>{e.cryptoStore.getAccount(r,(e=>{t.pickledAccount=e})),t.sessions=[],e.cryptoStore.getAllEndToEndSessions(r,(e=>{t.sessions.push(e)}))})),t}))()}getSession(e,t,r,n){this.cryptoStore.getEndToEndSession(e,t,r,(e=>{this.unpickleSession(e,n)}))}unpickleSession(e,t){var r=new globalThis.Olm.Session;try{r.unpickle(this.pickleKey,e.session);var n=Object.assign({},e,{session:r});t(n)}finally{r.free()}}saveSession(e,t,r){var n=t.session.session_id();l.v.debug("Saving Olm session ".concat(n," with device ").concat(e,": ").concat(t.session.describe()));var i=Object.assign(t,{session:t.session.pickle(this.pickleKey)});this.cryptoStore.storeEndToEndSession(e,n,i,r)}getUtility(e){var t=new globalThis.Olm.Utility;try{return e(t)}finally{t.free()}}sign(e){var t=this;return(0,n.A)((function*(){var r;return yield t.cryptoStore.doTxn("readonly",[d.y.STORE_ACCOUNT],(n=>{t.getAccount(n,(t=>{r=t.sign(e)}))})),r}))()}getOneTimeKeys(){var e=this;return(0,n.A)((function*(){var t;return yield e.cryptoStore.doTxn("readonly",[d.y.STORE_ACCOUNT],(r=>{e.getAccount(r,(e=>{t=JSON.parse(e.one_time_keys())}))})),t}))()}maxNumberOfOneTimeKeys(){var e;return null!==(e=this.maxOneTimeKeys)&&void 0!==e?e:-1}markKeysAsPublished(){var e=this;return(0,n.A)((function*(){yield e.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT],(t=>{e.getAccount(t,(r=>{r.mark_keys_as_published(),e.storeAccount(t,r)}))}))}))()}generateOneTimeKeys(e){return this.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT],(t=>{this.getAccount(t,(r=>{r.generate_one_time_keys(e),this.storeAccount(t,r)}))}))}generateFallbackKey(){var e=this;return(0,n.A)((function*(){yield e.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT],(t=>{e.getAccount(t,(r=>{r.generate_fallback_key(),e.storeAccount(t,r)}))}))}))()}getFallbackKey(){var e=this;return(0,n.A)((function*(){var t;return yield e.cryptoStore.doTxn("readonly",[d.y.STORE_ACCOUNT],(r=>{e.getAccount(r,(e=>{t=JSON.parse(e.unpublished_fallback_key())}))})),t}))()}forgetOldFallbackKey(){var e=this;return(0,n.A)((function*(){yield e.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT],(t=>{e.getAccount(t,(r=>{r.forget_old_fallback_key(),e.storeAccount(t,r)}))}))}))()}createOutboundSession(e,t){var r=this;return(0,n.A)((function*(){var n;return yield r.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT,d.y.STORE_SESSIONS],(i=>{r.getAccount(i,(o=>{var s=new globalThis.Olm.Session;try{s.create_outbound(o,e,t),n=s.session_id(),r.storeAccount(i,o);var a={session:s,lastReceivedMessageTs:Date.now()};r.saveSession(e,a,i)}finally{s.free()}}))}),l.v.getChild("[createOutboundSession]")),n}))()}createInboundSession(e,t,r){var i=this;return(0,n.A)((function*(){if(0!==t)throw new Error("Need messageType == 0 to create inbound session");var n;return yield i.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT,d.y.STORE_SESSIONS],(o=>{i.getAccount(o,(s=>{var a=new globalThis.Olm.Session;try{a.create_inbound_from(s,e,r),s.remove_one_time_keys(a),i.storeAccount(o,s);var c=a.decrypt(t,r),l={session:a,lastReceivedMessageTs:Date.now()};i.saveSession(e,l,o),n={payload:c,session_id:a.session_id()}}finally{a.free()}}))}),l.v.getChild("[createInboundSession]")),n}))()}getSessionIdsForDevice(e){var t=this;return(0,n.A)((function*(){var r,n=l.v.getChild("[getSessionIdsForDevice]");if(e in t.sessionsInProgress){n.debug("Waiting for Olm session for ".concat(e," to be created"));try{yield t.sessionsInProgress[e]}catch(i){}}return yield t.cryptoStore.doTxn("readonly",[d.y.STORE_SESSIONS],(n=>{t.cryptoStore.getEndToEndSessions(e,n,(e=>{r=Object.keys(e)}))}),n),r}))()}getSessionIdForDevice(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]&&t[1],i=t.length>2?t[2]:void 0,o=yield r.getSessionInfoForDevice(e,n,i);if(0===o.length)return null;for(var s=0,a=1;a<o.length;a++){var c=o[a],l=void 0===c.lastReceivedMessageTs?0:c.lastReceivedMessageTs,d=o[s],u=void 0===d.lastReceivedMessageTs?0:d.lastReceivedMessageTs;(l>u||l===u&&c.sessionId<d.sessionId)&&(s=a)}return o[s].sessionId}))()}getSessionInfoForDevice(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]&&t[1],i=t.length>2&&void 0!==t[2]?t[2]:l.v;if(i=i.getChild("[getSessionInfoForDevice]"),e in r.sessionsInProgress&&!n){i.debug("Waiting for Olm session for ".concat(e," to be created"));try{yield r.sessionsInProgress[e]}catch(s){}}var o=[];return yield r.cryptoStore.doTxn("readonly",[d.y.STORE_SESSIONS],(t=>{r.cryptoStore.getEndToEndSessions(e,t,(e=>{var t=Object.keys(e).sort(),n=function(t){r.unpickleSession(e[t],(e=>{o.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:t})}))};for(var i of t)n(i)}))}),i),o}))()}encryptMessage(e,t,r){var i=this;return(0,n.A)((function*(){var n;return f(r),yield i.cryptoStore.doTxn("readwrite",[d.y.STORE_SESSIONS],(o=>{i.getSession(e,t,o,(s=>{var a=s.session.describe();l.v.log("encryptMessage: Olm Session ID "+t+" to "+e+": "+a),n=s.session.encrypt(r),i.saveSession(e,s,o)}))}),l.v.getChild("[encryptMessage]")),n}))()}decryptMessage(e,t,r,i){var o=this;return(0,n.A)((function*(){var n;return yield o.cryptoStore.doTxn("readwrite",[d.y.STORE_SESSIONS],(s=>{o.getSession(e,t,s,(a=>{var c=a.session.describe();l.v.log("decryptMessage: Olm Session ID "+t+" from "+e+": "+c),n=a.session.decrypt(r,i),a.lastReceivedMessageTs=Date.now(),o.saveSession(e,a,s)}))}),l.v.getChild("[decryptMessage]")),n}))()}matchesSession(e,t,r,i){var o=this;return(0,n.A)((function*(){return 0===r&&(yield o.cryptoStore.doTxn("readonly",[d.y.STORE_SESSIONS],(r=>{o.getSession(e,t,r,(e=>{n=e.session.matches_inbound(i)}))}),l.v.getChild("[matchesSession]")),n);var n}))()}recordSessionProblem(e,t,r){var i=this;return(0,n.A)((function*(){l.v.info("Recording problem on olm session with ".concat(e," of type ").concat(t,". Recreating: ").concat(r)),yield i.cryptoStore.storeEndToEndSessionProblem(e,t,r)}))()}sessionMayHaveProblems(e,t){return this.cryptoStore.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.cryptoStore.filterOutNotifiedErrorDevices(e)}saveOutboundGroupSession(e){this.outboundGroupSessionStore[e.session_id()]=e.pickle(this.pickleKey)}getOutboundGroupSession(e,t){var r=this.outboundGroupSessionStore[e];if(void 0===r)throw new Error("Unknown outbound group session "+e);var n=new globalThis.Olm.OutboundGroupSession;try{return n.unpickle(this.pickleKey,r),t(n)}finally{n.free()}}createOutboundGroupSession(){var e=new globalThis.Olm.OutboundGroupSession;try{return e.create(),this.saveOutboundGroupSession(e),e.session_id()}finally{e.free()}}encryptGroupMessage(e,t){return l.v.log("encrypting msg with megolm session ".concat(e)),f(t),this.getOutboundGroupSession(e,(e=>{var r=e.encrypt(t);return this.saveOutboundGroupSession(e),r}))}getOutboundGroupSessionKey(e){return this.getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))}unpickleInboundGroupSession(e,t){var r=new globalThis.Olm.InboundGroupSession;try{return r.unpickle(this.pickleKey,e.session),t(r)}finally{r.free()}}getInboundGroupSession(e,t,r,n,i){this.cryptoStore.getEndToEndInboundGroupSession(t,r,n,((t,r)=>{if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");this.unpickleInboundGroupSession(t,(e=>{i(e,t,r)}))}else i(null,null,r)}))}addInboundGroupSession(e,t,r,i,o,s,a){var c=arguments,u=this;return(0,n.A)((function*(){var n=c.length>7&&void 0!==c[7]?c[7]:{};yield u.cryptoStore.doTxn("readwrite",[d.y.STORE_INBOUND_GROUP_SESSIONS,d.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,d.y.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(c=>{u.getInboundGroupSession(e,t,i,c,((d,h)=>{var v=new globalThis.Olm.InboundGroupSession;try{if(a?v.import_session(o):v.create(o),i!=v.session_id())throw new Error("Mismatched group session ID from senderKey: "+t);if(d&&(l.v.log("Update for megolm session ".concat(t,"|").concat(i)),d.first_known_index()<=v.first_known_index())){if(!h.untrusted||n.untrusted)return void l.v.log("Keeping existing megolm session ".concat(t,"|").concat(i));if(d.first_known_index()<v.first_known_index())return void(d.export_session(v.first_known_index())===v.export_session(v.first_known_index())?(l.v.info("Upgrading trust of existing megolm session "+"".concat(t,"|").concat(i," based on newly-received trusted session")),h.untrusted=!1,u.cryptoStore.storeEndToEndInboundGroupSession(t,i,h,c)):l.v.warn("Newly-received megolm session ".concat(t,"|$sessionId}")+" does not match existing session! Keeping existing session"))}l.v.debug("Storing megolm session ".concat(t,"|").concat(i," with first index ")+v.first_known_index());var p=Object.assign({},n,{room_id:e,session:v.pickle(u.pickleKey),keysClaimed:s,forwardingCurve25519KeyChain:r});u.cryptoStore.storeEndToEndInboundGroupSession(t,i,p,c),!d&&n.sharedHistory&&u.cryptoStore.addSharedHistoryInboundGroupSession(e,t,i,c)}finally{v.free()}}))}),l.v.getChild("[addInboundGroupSession]"))}))()}addInboundGroupSessionWithheld(e,t,r,i,o){var s=this;return(0,n.A)((function*(){yield s.cryptoStore.doTxn("readwrite",[d.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(n=>{s.cryptoStore.storeEndToEndInboundGroupSessionWithheld(t,r,{room_id:e,code:i,reason:o},n)}))}))()}decryptGroupMessage(e,t,r,i,o,s){var a=this;return(0,n.A)((function*(){var n,c=null;if(yield a.cryptoStore.doTxn("readwrite",[d.y.STORE_INBOUND_GROUP_SESSIONS,d.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(l=>{a.getInboundGroupSession(e,t,r,l,((e,d,v)=>{if(null!==e&&null!==d){var p;try{p=e.decrypt(i)}catch(E){if("OLM.UNKNOWN_MESSAGE_INDEX"===(null===E||void 0===E?void 0:E.message)&&v){var f="m.unverified"===v.code?u.DecryptionFailureCode.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:u.DecryptionFailureCode.MEGOLM_KEY_WITHHELD;n=new h.O(f,y(v),{session:t+"|"+r})}else n=E;return}var g=p.plaintext;if(void 0===g)g=p;else{var m=t+"|"+r+"|"+p.message_index;if(m in a.inboundGroupSessionMessageIndexes){var S=a.inboundGroupSessionMessageIndexes[m];if(S.id!==o||S.timestamp!==s)return void(n=new Error("Duplicate message index, possible replay attack: "+m))}a.inboundGroupSessionMessageIndexes[m]={id:o,timestamp:s}}d.session=e.pickle(a.pickleKey),a.cryptoStore.storeEndToEndInboundGroupSession(t,r,d,l),c={result:g,keysClaimed:d.keysClaimed||{},senderKey:t,forwardingCurve25519KeyChain:d.forwardingCurve25519KeyChain||[],untrusted:!!d.untrusted}}else{if(v){var b="m.unverified"===v.code?u.DecryptionFailureCode.MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE:u.DecryptionFailureCode.MEGOLM_KEY_WITHHELD;n=new h.O(b,y(v),{session:t+"|"+r})}c=null}}))}),l.v.getChild("[decryptGroupMessage]")),n)throw n;return c}))()}hasInboundSessionKeys(e,t,r){var i=this;return(0,n.A)((function*(){var n;return yield i.cryptoStore.doTxn("readonly",[d.y.STORE_INBOUND_GROUP_SESSIONS,d.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(o=>{i.cryptoStore.getEndToEndInboundGroupSession(t,r,o,(i=>{null!==i?e!==i.room_id?(l.v.warn("requested keys for inbound group session ".concat(t,"|")+"".concat(r,", with incorrect room_id ")+"(expected ".concat(i.room_id,", ")+"was ".concat(e,")")),n=!1):n=!0:n=!1}))}),l.v.getChild("[hasInboundSessionKeys]")),n}))()}getInboundGroupSessionKey(e,t,r,i){var o=this;return(0,n.A)((function*(){var n=null;return yield o.cryptoStore.doTxn("readonly",[d.y.STORE_INBOUND_GROUP_SESSIONS,d.y.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(s=>{o.getInboundGroupSession(e,t,r,s,((e,t)=>{if(null!==e&&null!==t){void 0===i&&(i=e.first_known_index());var r=e.export_session(i),o=t.keysClaimed||{},s=o.ed25519||null,a=t.forwardingCurve25519KeyChain||[],c="untrusted"in t?t.untrusted:a.length>0;n={chain_index:i,key:r,forwarding_curve25519_key_chain:a,sender_claimed_ed25519_key:s,shared_history:t.sharedHistory||!1,untrusted:c}}else n=null}))}),l.v.getChild("[getInboundGroupSessionKey]")),n}))()}exportInboundGroupSession(e,t,r){return this.unpickleInboundGroupSession(r,(n=>{var i=n.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:n.export_session(i),forwarding_curve25519_key_chain:r.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":r.sharedHistory||!1}}))}getSharedHistoryInboundGroupSessions(e){var t=this;return(0,n.A)((function*(){var r;return yield t.cryptoStore.doTxn("readonly",[d.y.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(n=>{r=t.cryptoStore.getSharedHistoryInboundGroupSessions(e,n)}),l.v.getChild("[getSharedHistoryInboundGroupSessionsForRoom]")),r}))()}verifySignature(e,t,r){this.getUtility((function(n){n.ed25519_verify(e,t,r)}))}}var m={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function y(e){return e.code&&e.code in m?m[e.code]:e.reason?e.reason:"decryption key withheld"}var S=r(8620),b=r(3723),E=r(944),_=r(3571),w=r(4519),I=6e4;function T(e){return Object.values(e.keys)[0]}class R{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.userId=e,this.callbacks=t,this.cacheCallbacks=r,(0,i.A)(this,"keys",{}),(0,i.A)(this,"firstUse",!0),(0,i.A)(this,"crossSigningVerifiedBefore",!1)}static fromStorage(e,t){var r=new R(t);for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}toStorage(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}getCrossSigningKey(e,t){var r=this;return(0,n.A)((function*(){var n=["master","self_signing","user_signing"].indexOf(e)>=0;if(!r.callbacks.getCrossSigningKey)throw new Error("No getCrossSigningKey callback supplied");function i(e){if(e){var r=new globalThis.Olm.PkSigning,n=r.init_with_seed(e);if(n===t)return[n,r];r.free()}}void 0===t&&(t=r.getId(e));var o=null;r.cacheCallbacks.getCrossSigningKeyCache&&n&&(o=yield r.cacheCallbacks.getCrossSigningKeyCache(e,t));var s=i(o);if(s)return s;o=yield r.callbacks.getCrossSigningKey(e,t);var a=i(o);if(a)return r.cacheCallbacks.storeCrossSigningKeyCache&&n&&(yield r.cacheCallbacks.storeCrossSigningKeyCache(e,o)),a;if(!o)throw new Error("getCrossSigningKey callback for "+e+" returned falsey");throw new Error("Key type "+e+" from getCrossSigningKey callback did not match")}))()}isStoredInSecretStorage(e){return(0,n.A)((function*(){var t=(yield e.isStored("m.cross_signing.master"))||{};function r(e){for(var r of Object.keys(t))e[r]||delete t[r]}for(var n of["self_signing","user_signing"])r((yield e.isStored("m.cross_signing.".concat(n)))||{});return Object.keys(t).length?t:null}))()}static storeInSecretStorage(e,t){return(0,n.A)((function*(){for(var[r,n]of e){var i=(0,E.WG)(n);yield t.store("m.cross_signing.".concat(r),i)}}))()}static getFromSecretStorage(e,t){return(0,n.A)((function*(){var r=yield t.get("m.cross_signing.".concat(e));return r?(0,E.y4)(r):null}))()}isStoredInKeyCache(e){var t=this;return(0,n.A)((function*(){var r=t.cacheCallbacks;if(!r)return!1;var n=e?[e]:["master","self_signing","user_signing"];for(var i of n){var o;if(!(yield null===(o=r.getCrossSigningKeyCache)||void 0===o?void 0:o.call(r,i)))return!1}return!0}))()}getCrossSigningKeysFromCache(){var e=this;return(0,n.A)((function*(){var t=new Map,r=e.cacheCallbacks;if(!r)return t;for(var n of["master","self_signing","user_signing"]){var i,o=yield null===(i=r.getCrossSigningKeyCache)||void 0===i?void 0:i.call(r,n);o&&t.set(n,o)}return t}))()}getId(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"master";if(!this.keys[e])return null;var t=this.keys[e];return T(t)}resetKeys(e){var t=this;return(0,n.A)((function*(){if(!t.callbacks.saveCrossSigningKeys)throw new Error("No saveCrossSigningKeys callback supplied");if(void 0===e||e&A.MASTER||!t.keys.master)e=A.MASTER|A.USER_SIGNING|A.SELF_SIGNING;else if(0===e)return;var r,n,i={},o={};try{if(e&A.MASTER?(r=new globalThis.Olm.PkSigning,i.master=r.generate_seed(),n=r.init_with_seed(i.master),o.master={user_id:t.userId,usage:["master"],keys:{["ed25519:"+n]:n}}):[n,r]=yield t.getCrossSigningKey("master"),e&A.SELF_SIGNING){var s=new globalThis.Olm.PkSigning;try{i.self_signing=s.generate_seed();var a=s.init_with_seed(i.self_signing);o.self_signing={user_id:t.userId,usage:["self_signing"],keys:{["ed25519:"+a]:a}},(0,S.pkSign)(o.self_signing,r,t.userId,n)}finally{s.free()}}if(e&A.USER_SIGNING){var c=new globalThis.Olm.PkSigning;try{i.user_signing=c.generate_seed();var l=c.init_with_seed(i.user_signing);o.user_signing={user_id:t.userId,usage:["user_signing"],keys:{["ed25519:"+l]:l}},(0,S.pkSign)(o.user_signing,r,t.userId,n)}finally{c.free()}}Object.assign(t.keys,o),t.callbacks.saveCrossSigningKeys(i)}finally{r&&r.free()}}))()}clearKeys(){this.keys={}}setKeys(e){var t={};if(e.master){if(e.master.user_id!==this.userId){var r="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw l.v.error(r),new Error(r)}this.keys.master?T(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}var n=T(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){var i="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw l.v.error(i),new Error(i)}try{(0,S.pkVerify)(e.user_signing,n,this.userId)}catch(s){throw l.v.error("invalid signature on user-signing key"),s}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){var o="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw l.v.error(o),new Error(o)}try{(0,S.pkVerify)(e.self_signing,n,this.userId)}catch(s){throw l.v.error("invalid signature on self-signing key"),s}}e.master&&(this.keys.master=e.master,delete this.keys["self_signing"],delete this.keys["user_signing"]),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}updateCrossSigningVerifiedBefore(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}signObject(e,t){var r=this;return(0,n.A)((function*(){if(!r.keys[t])throw new Error("Attempted to sign with "+t+" key but no such key present");var[n,i]=yield r.getCrossSigningKey(t);try{return(0,S.pkSign)(e,i,r.userId,n),e}finally{i.free()}}))()}signUser(e){var t=this;return(0,n.A)((function*(){if(t.keys.user_signing)return t.signObject(e.keys.master,"user_signing");l.v.info("No user signing key: not signing user")}))()}signDevice(e,t){var r=this;return(0,n.A)((function*(){if(e!==r.userId)throw new Error("Trying to sign ".concat(e,"'s device; can only sign our own device"));if(r.keys.self_signing)return r.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing");l.v.info("No self signing key: not signing device")}))()}checkUserTrust(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new u.UserVerificationStatus(!0,!0,this.firstUse);if(!this.keys.user_signing)return new u.UserVerificationStatus(!1,!1,e.firstUse);var t,r=e.keys.master,n=this.getId("user_signing");try{(0,S.pkVerify)(r,n,this.userId),t=!0}catch(i){t=!1}return new u.UserVerificationStatus(t,e.crossSigningVerifiedBefore,e.firstUse)}checkDeviceTrust(e,t,r,n){var i=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new C(!1,!1,r,n);var s=k(t,e.userId);try{return(0,S.pkVerify)(o,e.getId(),e.userId),(0,S.pkVerify)(s,T(o),e.userId),C.fromUserTrustLevel(i,r,n)}catch(a){return new C(!1,!1,r,n)}}getCacheCallbacks(){return this.cacheCallbacks}}function k(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}var A=function(e){return e[e["MASTER"]=4]="MASTER",e[e["USER_SIGNING"]=2]="USER_SIGNING",e[e["SELF_SIGNING"]=1]="SELF_SIGNING",e}({});class C extends u.DeviceVerificationStatus{constructor(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];super({crossSigningVerified:e,tofu:t,localVerified:r,trustCrossSignedDevices:n,signedByOwner:i})}static fromUserTrustLevel(e,t,r){return new C(e.isCrossSigningVerified(),e.isTofu(),t,r,!0)}isCrossSigningVerified(){return this.crossSigningVerified}isLocallyVerified(){return this.localVerified}isTofu(){return this.tofu}}function O(e,t){return{getCrossSigningKeyCache:function(){var r=(0,n.A)((function*(r,n){var i=yield new Promise((t=>{e.doTxn("readonly",[d.y.STORE_ACCOUNT],(n=>{e.getSecretStorePrivateKey(n,t,r)}))}));if(i&&i.ciphertext){var o=Buffer.from(t.pickleKey),s=yield(0,w.A)(i,o,r);return(0,E.y4)(s)}return i}));function i(e,t){return r.apply(this,arguments)}return i}(),storeCrossSigningKeyCache:function(){var r=(0,n.A)((function*(r,n){if(!(n instanceof Uint8Array))throw new Error("storeCrossSigningKeyCache expects Uint8Array, got ".concat(n));var i=Buffer.from(t.pickleKey),o=yield(0,_.A)((0,E.WG)(n),i,r);return e.doTxn("readwrite",[d.y.STORE_ACCOUNT],(t=>{e.storeSecretStorePrivateKey(t,r,o)}))}));function i(e,t){return r.apply(this,arguments)}return i}()}}function D(e,t,r){return M.apply(this,arguments)}function M(){return M=(0,n.A)((function*(e,t,r){if(e.getUserId()===t)return l.v.log("Cross-signing: Self-verification done; requesting keys"),new Promise(((t,i)=>{var o=e,s=o.crypto.crossSigningInfo,a=new R(s.userId,{getCrossSigningKey:function(){var e=(0,n.A)((function*(e){l.v.debug("Cross-signing: requesting secret",e,r);var{promise:t}=o.requestSecret("m.cross_signing.".concat(e),[r]),n=yield t,i=(0,E.y4)(n);return Uint8Array.from(i)}));function t(t){return e.apply(this,arguments)}return t}()},s.getCacheCallbacks());a.keys=s.keys;var c=new Promise((e=>{setTimeout(e,I,new Error("Timeout"))})),d=(0,n.A)((function*(){var e=yield o.crypto.getSessionBackupPrivateKey();if(!e){l.v.info("No cached backup key found. Requesting...");var t=o.requestSecret("m.megolm_backup.v1",[r]),n=yield t.promise;l.v.info("Got key backup key, decoding...");var i=(0,E.y4)(n);l.v.info("Decoded backup key, storing..."),yield o.crypto.storeSessionBackupPrivateKey(Uint8Array.from(i)),l.v.info("Backup key stored. Starting backup restore...");var s=yield o.getKeyBackupVersion();o.restoreKeyBackupWithCache(void 0,void 0,s).then((()=>{l.v.info("Backup restored.")}))}}))();Promise.race([Promise.all([a.getCrossSigningKey("master"),a.getCrossSigningKey("self_signing"),a.getCrossSigningKey("user_signing"),d]),c]).then(t,i)})).catch((e=>{l.v.warn("Cross-signing: failure while requesting keys:",e)}))})),M.apply(this,arguments)}var P=r(6170),x=r(2668),U=function(e){return e[e["NotTracked"]=0]="NotTracked",e[e["PendingDownload"]=1]="PendingDownload",e[e["DownloadInProgress"]=2]="DownloadInProgress",e[e["UpToDate"]=3]="UpToDate",e}({});class L extends x.X{constructor(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:250;super(),this.cryptoStore=t,this.keyDownloadChunkSize=n,(0,i.A)(this,"devices",{}),(0,i.A)(this,"crossSigningInfo",{}),(0,i.A)(this,"userByIdentityKey",{}),(0,i.A)(this,"deviceTrackingStatus",{}),(0,i.A)(this,"syncToken",null),(0,i.A)(this,"keyDownloadsInProgressByUser",new Map),(0,i.A)(this,"dirty",!1),(0,i.A)(this,"savePromise",null),(0,i.A)(this,"resolveSavePromise",null),(0,i.A)(this,"savePromiseTime",null),(0,i.A)(this,"saveTimer",null),(0,i.A)(this,"hasFetched",null),(0,i.A)(this,"serialiser",void 0),this.serialiser=new N(e,r,this)}load(){var e=this;return(0,n.A)((function*(){for(var t of(yield e.cryptoStore.doTxn("readonly",[d.y.STORE_DEVICE_DATA],(t=>{e.cryptoStore.getEndToEndDeviceData(t,(t=>{var r;for(var n of(e.hasFetched=Boolean(null===t||void 0===t?void 0:t.devices),e.devices=t?t.devices:{},e.crossSigningInfo=t&&t.crossSigningInfo||{},e.deviceTrackingStatus=t?t.trackingStatus:{},e.syncToken=null!==(r=null===t||void 0===t?void 0:t.syncToken)&&void 0!==r?r:null,e.userByIdentityKey={},Object.keys(e.devices))){var i=e.devices[n];for(var o of Object.keys(i)){var s=i[o].keys["curve25519:"+o];void 0!==s&&(e.userByIdentityKey[s]=n)}}}))})),Object.keys(e.deviceTrackingStatus)))e.deviceTrackingStatus[t]==U.DownloadInProgress&&(e.deviceTrackingStatus[t]=U.PendingDownload)}))()}stop(){null!==this.saveTimer&&clearTimeout(this.saveTimer)}saveIfDirty(){var e=arguments,t=this;return(0,n.A)((function*(){var r=e.length>0&&void 0!==e[0]?e[0]:500;if(!t.dirty)return Promise.resolve(!1);var n=Date.now()+r;t.savePromiseTime&&n<t.savePromiseTime&&(clearTimeout(t.saveTimer),t.saveTimer=null,t.savePromiseTime=null);var i=t.savePromise;if(null===i&&(i=new Promise((e=>{t.resolveSavePromise=e})),t.savePromise=i),null===t.saveTimer){var o=t.resolveSavePromise;t.savePromiseTime=n,t.saveTimer=setTimeout((()=>{l.v.log("Saving device tracking data",t.syncToken),t.savePromiseTime=null,t.saveTimer=null,t.savePromise=null,t.resolveSavePromise=null,t.cryptoStore.doTxn("readwrite",[d.y.STORE_DEVICE_DATA],(e=>{var r;t.cryptoStore.storeEndToEndDeviceData({devices:t.devices,crossSigningInfo:t.crossSigningInfo,trackingStatus:t.deviceTrackingStatus,syncToken:null!==(r=t.syncToken)&&void 0!==r?r:void 0},e)})).then((()=>{t.dirty=!1,null===o||void 0===o||o(!0)}),(e=>{l.v.error("Failed to save device tracking data",t.syncToken),l.v.error(e)}))}),r)}return i}))()}getSyncToken(){return this.syncToken}setSyncToken(e){this.syncToken=e}downloadKeys(e,t){var r=[],n=[];if(e.forEach((e=>{var i=this.deviceTrackingStatus[e];this.keyDownloadsInProgressByUser.has(e)?(l.v.log("downloadKeys: already have a download in progress for "+"".concat(e,": awaiting its result")),n.push(this.keyDownloadsInProgressByUser.get(e))):(t||i!=U.UpToDate)&&r.push(e)})),0!=r.length){l.v.log("downloadKeys: downloading for",r);var i=this.doKeyDownload(r);n.push(i)}return 0===n.length&&l.v.log("downloadKeys: already have all necessary keys"),Promise.all(n).then((()=>this.getDevicesFromStore(e)))}getDevicesFromStore(e){var t=new Map;return e.forEach((e=>{var r,n=new Map;null===(r=this.getStoredDevicesForUser(e))||void 0===r||r.forEach((function(e){n.set(e.deviceId,e)})),t.set(e,n)})),t}getKnownUserIds(){return Object.keys(this.devices)}getStoredDevicesForUser(e){var t=this.devices[e];if(!t)return null;var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(b.V.fromStorage(t[n],n));return r}getRawStoredDevicesForUser(e){return this.devices[e]}getStoredCrossSigningForUser(e){return this.crossSigningInfo[e]?R.fromStorage(this.crossSigningInfo[e],e):null}storeCrossSigningForUser(e,t){this.crossSigningInfo[e]=t,this.dirty=!0}getStoredDevice(e,t){var r=this.devices[e];if(null!==r&&void 0!==r&&r[t])return b.V.fromStorage(r[t],t)}getUserByIdentityKey(e,t){return e!==S.OLM_ALGORITHM&&e!==S.MEGOLM_ALGORITHM?null:this.userByIdentityKey[t]}getDeviceByIdentityKey(e,t){var r=this.getUserByIdentityKey(e,t);if(!r)return null;var n=this.devices[r];if(!n)return null;for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];for(var s in o.keys)if(o.keys.hasOwnProperty(s)&&0===s.indexOf("curve25519:")){var a=o.keys[s];if(a==t)return b.V.fromStorage(o,i)}}return null}storeDevicesForUser(e,t){this.setRawStoredDevicesForUser(e,t),this.dirty=!0}startTrackingDeviceList(e){if("string"!==typeof e)throw new Error("userId must be a string; was "+e);this.deviceTrackingStatus[e]||(l.v.log("Now tracking device list for "+e),this.deviceTrackingStatus[e]=U.PendingDownload,this.dirty=!0)}stopTrackingDeviceList(e){this.deviceTrackingStatus[e]&&(l.v.log("No longer tracking device list for "+e),this.deviceTrackingStatus[e]=U.NotTracked,this.dirty=!0)}stopTrackingAllDeviceLists(){for(var e of Object.keys(this.deviceTrackingStatus))this.deviceTrackingStatus[e]=U.NotTracked;this.dirty=!0}invalidateUserDeviceList(e){this.deviceTrackingStatus[e]&&(l.v.log("Marking device list outdated for",e),this.deviceTrackingStatus[e]=U.PendingDownload,this.dirty=!0)}refreshOutdatedDeviceLists(){this.saveIfDirty();var e=[];for(var t of Object.keys(this.deviceTrackingStatus)){var r=this.deviceTrackingStatus[t];r==U.PendingDownload&&e.push(t)}return this.doKeyDownload(e)}setRawStoredDevicesForUser(e,t){if(void 0!==this.devices[e])for(var[r,n]of Object.entries(this.devices[e])){var i=n.keys["curve25519:"+r];delete this.userByIdentityKey[i]}for(var[o,s]of(this.devices[e]=t,Object.entries(t))){var a=s.keys["curve25519:"+o];this.userByIdentityKey[a]=e}}setRawStoredCrossSigningForUser(e,t){this.crossSigningInfo[e]=t}doKeyDownload(e){if(0===e.length)return Promise.resolve();var t=this.serialiser.updateDevicesForUsers(e,this.syncToken).then((()=>{r(!0)}),(t=>{throw l.v.error("Error downloading keys for "+e+":",t),r(!1),t}));e.forEach((e=>{this.keyDownloadsInProgressByUser.set(e,t);var r=this.deviceTrackingStatus[e];r==U.PendingDownload&&(this.deviceTrackingStatus[e]=U.DownloadInProgress)}));var r=r=>{this.emit(sr.WillUpdateDevices,e,!this.hasFetched),e.forEach((e=>{if(this.dirty=!0,this.keyDownloadsInProgressByUser.get(e)===t){this.keyDownloadsInProgressByUser.delete(e);var n=this.deviceTrackingStatus[e];n==U.DownloadInProgress&&(r?(this.deviceTrackingStatus[e]=U.UpToDate,l.v.log("Device list for",e,"now up to date")):this.deviceTrackingStatus[e]=U.PendingDownload)}else l.v.log("Another update in the queue for",e,"- not marking up-to-date")})),this.saveIfDirty(),this.emit(sr.DevicesUpdated,e,!this.hasFetched),this.hasFetched=!0};return t}}class N{constructor(e,t,r){this.baseApis=e,this.olmDevice=t,this.deviceList=r,(0,i.A)(this,"downloadInProgress",!1),(0,i.A)(this,"keyDownloadsQueuedByUser",{}),(0,i.A)(this,"queuedQueryDeferred",void 0),(0,i.A)(this,"syncToken",void 0)}updateDevicesForUsers(e,t){return e.forEach((e=>{this.keyDownloadsQueuedByUser[e]=!0})),this.queuedQueryDeferred||(this.queuedQueryDeferred=(0,P.v6)()),this.syncToken=t,this.downloadInProgress?(l.v.log("Queued key download for",e),this.queuedQueryDeferred.promise):this.doQueuedQueries()}doQueuedQueries(){var e=this;if(this.downloadInProgress)throw new Error("DeviceListUpdateSerialiser.doQueuedQueries called with request active");var t=Object.keys(this.keyDownloadsQueuedByUser);this.keyDownloadsQueuedByUser={};var r=this.queuedQueryDeferred;this.queuedQueryDeferred=void 0,l.v.log("Starting key download for",t),this.downloadInProgress=!0;var i={};this.syncToken&&(i.token=this.syncToken);for(var o=[],s=function(){var r=t.slice(a,a+e.deviceList.keyDownloadChunkSize);o.push((()=>e.baseApis.downloadKeysForUsers(r,i)))},a=0;a<t.length;a+=this.deviceList.keyDownloadChunkSize)s();return(0,P.iK)(o,3).then(function(){var r=(0,n.A)((function*(r){var n=Object.assign({},...r.map((e=>e.device_keys||{}))),i=Object.assign({},...r.map((e=>e.master_keys||{}))),o=Object.assign({},...r.map((e=>e.self_signing_keys||{}))),s=Object.assign({},...r.map((e=>e.user_signing_keys||{})));for(var a of t){yield(0,P.yy)(5);try{yield e.processQueryResponseForUser(a,n[a],{master:null===i||void 0===i?void 0:i[a],self_signing:null===o||void 0===o?void 0:o[a],user_signing:null===s||void 0===s?void 0:s[a]})}catch(c){l.v.error("Error processing keys for ".concat(a,":"),c)}}}));return function(e){return r.apply(this,arguments)}}()).then((()=>{l.v.log("Completed key download for "+t),this.downloadInProgress=!1,null===r||void 0===r||r.resolve(),this.queuedQueryDeferred&&this.doQueuedQueries()}),(e=>{l.v.warn("Error downloading keys for "+t+":",e),this.downloadInProgress=!1,null===r||void 0===r||r.reject(e)})),r.promise}processQueryResponseForUser(e,t,r){var i=this;return(0,n.A)((function*(){l.v.log("got device keys for "+e+":",t),l.v.log("got cross-signing keys for "+e+":",r);var n={},o=i.deviceList.getRawStoredDevicesForUser(e);o&&Object.keys(o).forEach((e=>{var t=b.V.fromStorage(o[e],e);n[e]=t})),yield B(i.olmDevice,e,n,t||{},i.baseApis.getUserId(),i.baseApis.deviceId);var s={};if(Object.keys(n).forEach((e=>{s[e]=n[e].toStorage()})),i.deviceList.setRawStoredDevicesForUser(e,s),r&&(r.master||r.self_signing||r.user_signing)){var a=i.deviceList.getStoredCrossSigningForUser(e)||new R(e);a.setKeys(r),i.deviceList.setRawStoredCrossSigningForUser(e,a.toStorage()),i.deviceList.emit(sr.UserCrossSigningUpdated,e)}}))()}}function B(e,t,r,n,i,o){return K.apply(this,arguments)}function K(){return K=(0,n.A)((function*(e,t,r,n,i,o){var s=!1;for(var a in r)if(r.hasOwnProperty(a)&&!(a in n)){if(t===i&&a===o){l.v.warn("Local device ".concat(a," missing from sync, skipping removal"));continue}l.v.log("Device "+t+":"+a+" has been removed"),delete r[a],s=!0}for(var c in n)if(n.hasOwnProperty(c)){var d=n[c];d.user_id===t?d.device_id===c?(yield F(e,r,d))&&(s=!0):l.v.warn("Mismatched device_id "+d.device_id+" in keys from "+t+":"+c):l.v.warn("Mismatched user_id "+d.user_id+" in keys from "+t+":"+c)}return s})),K.apply(this,arguments)}function F(e,t,r){return j.apply(this,arguments)}function j(){return j=(0,n.A)((function*(e,t,r){if(!r.keys)return!1;var n=r.device_id,i=r.user_id,o="ed25519:"+n,s=r.keys[o];if(!s)return l.v.warn("Device "+i+":"+n+" has no ed25519 key"),!1;var a,c=r.unsigned||{},d=r.signatures||{};try{yield S.verifySignature(e,r,i,n,s)}catch(u){return l.v.warn("Unable to verify signature on device "+i+":"+n+":"+u),!1}if(n in t){if(a=t[n],a.getFingerprint()!=s)return l.v.warn("Ed25519 key for device "+i+":"+n+" has changed"),!1}else t[n]=a=new b.V(n);return a.keys=r.keys||{},a.algorithms=r.algorithms||[],a.unsigned=c,a.signatures=d,!0})),j.apply(this,arguments)}var q=new Map,V=new Map;class G{constructor(e){(0,i.A)(this,"userId",void 0),(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"crypto",void 0),(0,i.A)(this,"olmDevice",void 0),(0,i.A)(this,"baseApis",void 0),this.userId=e.userId,this.deviceId=e.deviceId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis}prepareToEncrypt(e){}onRoomMembership(e,t,r){}}class W{constructor(e){(0,i.A)(this,"userId",void 0),(0,i.A)(this,"crypto",void 0),(0,i.A)(this,"olmDevice",void 0),(0,i.A)(this,"baseApis",void 0),this.userId=e.userId,this.crypto=e.crypto,this.olmDevice=e.olmDevice,this.baseApis=e.baseApis}onRoomKeyEvent(e){return(0,n.A)((function*(){}))()}importRoomKey(e,t){return(0,n.A)((function*(){}))()}hasKeysForKeyRequest(e){return Promise.resolve(!1)}shareKeysWithDevice(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}retryDecryptionFromSender(e){return(0,n.A)((function*(){return!1}))()}}class H extends Error{constructor(e,t,r){super(e),this.devices=t,this.event=r,this.name="UnknownDeviceError",this.devices=t}}function $(e,t,r){q.set(e,t),V.set(e,r)}var J=b.V.DeviceVerification;class z extends G{constructor(){super(...arguments),(0,i.A)(this,"sessionPrepared",!1),(0,i.A)(this,"prepPromise",null)}ensureSession(e){return this.prepPromise?this.prepPromise:this.sessionPrepared?Promise.resolve():(this.prepPromise=this.crypto.downloadKeys(e).then((()=>this.crypto.ensureOlmSessionsForUsers(e))).then((()=>{this.sessionPrepared=!0})).finally((()=>{this.prepPromise=null})),this.prepPromise)}encryptMessage(e,t,r){var i=this;return(0,n.A)((function*(){var n=yield e.getEncryptionTargetMembers(),o=n.map((function(e){return e.userId}));yield i.ensureSession(o);var s={room_id:e.roomId,type:t,content:r},a={algorithm:S.OLM_ALGORITHM,sender_key:i.olmDevice.deviceCurve25519Key,ciphertext:{}},c=[];for(var l of o){var d=i.crypto.getStoredDevicesForUser(l)||[];for(var u of d){var h=u.getIdentityKey();h!=i.olmDevice.deviceCurve25519Key&&(u.verified!=J.BLOCKED&&c.push(S.encryptMessageForDevice(a.ciphertext,i.userId,i.deviceId,i.olmDevice,l,u,s)))}}return Promise.all(c).then((()=>a))}))()}}class Y extends W{decryptEvent(e){var t=this;return(0,n.A)((function*(){var r=e.getWireContent(),n=r.sender_key,i=r.ciphertext;if(!i)throw new h.O(u.DecryptionFailureCode.OLM_MISSING_CIPHERTEXT,"Missing ciphertext");if(!(t.olmDevice.deviceCurve25519Key in i))throw new h.O(u.DecryptionFailureCode.OLM_NOT_INCLUDED_IN_RECIPIENTS,"Not included in recipients");var o,s=i[t.olmDevice.deviceCurve25519Key];try{o=yield t.decryptMessage(n,s)}catch(d){throw new h.O(u.DecryptionFailureCode.OLM_BAD_ENCRYPTED_MESSAGE,"Bad Encrypted Message",{sender:n,err:d})}var a=JSON.parse(o);if(a.recipient!=t.userId)throw new h.O(u.DecryptionFailureCode.OLM_BAD_RECIPIENT,"Message was intended for "+a.recipient);if(a.recipient_keys.ed25519!=t.olmDevice.deviceEd25519Key)throw new h.O(u.DecryptionFailureCode.OLM_BAD_RECIPIENT_KEY,"Message not intended for this device",{intended:a.recipient_keys.ed25519,our_key:t.olmDevice.deviceEd25519Key});var c=t.crypto.deviceList.getUserByIdentityKey(S.OLM_ALGORITHM,n);if(void 0===c||null===c){try{yield t.crypto.deviceList.downloadKeys([e.getSender()],!1)}catch(d){throw new h.O(u.DecryptionFailureCode.OLM_BAD_SENDER_CHECK_FAILED,"Could not verify sender identity",{sender:n,err:d})}c=t.crypto.deviceList.getUserByIdentityKey(S.OLM_ALGORITHM,n)}if(c!==e.getSender()&&void 0!==c&&null!==c)throw new h.O(u.DecryptionFailureCode.OLM_BAD_SENDER,"Message claimed to be from "+e.getSender(),{real_sender:c});if(a.sender!=e.getSender())throw new h.O(u.DecryptionFailureCode.OLM_FORWARDED_MESSAGE,"Message forwarded from "+a.sender,{reported_sender:e.getSender()});if(a.room_id!==e.getRoomId())throw new h.O(u.DecryptionFailureCode.OLM_BAD_ROOM,"Message intended for room "+a.room_id,{reported_room:e.getRoomId()||"ROOM_ID_UNDEFINED"});var l=a.keys||{};return{clearEvent:a,senderCurve25519Key:n,claimedEd25519Key:l.ed25519||null}}))()}decryptMessage(e,t){if(0!==t.type)return this.reallyDecryptMessage(e,t);var r=this.olmDevice.olmPrekeyPromise.then((()=>this.reallyDecryptMessage(e,t)));return this.olmDevice.olmPrekeyPromise=r.catch((()=>{})),r}reallyDecryptMessage(e,t){var r=this;return(0,n.A)((function*(){var n,i=yield r.olmDevice.getSessionIdsForDevice(e),o={};for(var s of i)try{var a=yield r.olmDevice.decryptMessage(e,s,t.type,t.body);return l.v.log("Decrypted Olm message from "+e+" with session "+s),a}catch(d){var c=yield r.olmDevice.matchesSession(e,s,t.type,t.body);if(c)throw new Error("Error decrypting prekey message with existing session id "+s+": "+d.message);o[s]=d.message}if(0!==t.type){if(0===i.length)throw new Error("No existing sessions");throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(o))}try{n=yield r.olmDevice.createInboundSession(e,t.type,t.body)}catch(d){throw o["(new)"]=d.message,new Error("Error decrypting prekey message: "+JSON.stringify(o))}return l.v.log("created new inbound Olm session ID "+n.session_id+" with "+e),n.payload}))()}}$(S.OLM_ALGORITHM,z,Y);r(3579);function Q(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function X(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Q(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Q(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Z=500,ee=function(e){return e[e["Unsent"]=0]="Unsent",e[e["Sent"]=1]="Sent",e[e["CancellationPending"]=2]="CancellationPending",e[e["CancellationPendingAndWillResend"]=3]="CancellationPendingAndWillResend",e}({});class te{constructor(e,t,r){this.baseApis=e,this.deviceId=t,this.cryptoStore=r,(0,i.A)(this,"sendOutgoingRoomKeyRequestsTimer",void 0),(0,i.A)(this,"sendOutgoingRoomKeyRequestsRunning",!1),(0,i.A)(this,"clientRunning",!0)}stop(){l.v.log("stopping OutgoingRoomKeyRequestManager"),this.clientRunning=!1}sendQueuedRequests(){this.startTimer()}queueRoomKeyRequest(e,t){var r=arguments,i=this;return(0,n.A)((function*(){var n=r.length>2&&void 0!==r[2]&&r[2],o=yield i.cryptoStore.getOutgoingRoomKeyRequest(e);if(o)switch(o.state){case ee.CancellationPendingAndWillResend:case ee.Unsent:return;case ee.CancellationPending:var s=n?ee.CancellationPendingAndWillResend:ee.Sent;yield i.cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,ee.CancellationPending,{state:s,cancellationTxnId:i.baseApis.makeTxnId()});break;case ee.Sent:if(n){var a=ee.CancellationPendingAndWillResend,c=yield i.cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,ee.Sent,{state:a,cancellationTxnId:i.baseApis.makeTxnId(),requestTxnId:i.baseApis.makeTxnId()});if(!c)return i.queueRoomKeyRequest(e,t,n);try{yield i.sendOutgoingRoomKeyRequestCancellation(c,!0)}catch(d){l.v.error("Error sending room key request cancellation; will retry later.",d)}}break;default:throw new Error("unhandled state: "+o.state)}else yield i.cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:e,recipients:t,requestId:i.baseApis.makeTxnId(),state:ee.Unsent})}))()}cancelRoomKeyRequest(e){return this.cryptoStore.getOutgoingRoomKeyRequest(e).then((t=>{if(t)switch(t.state){case ee.CancellationPending:case ee.CancellationPendingAndWillResend:return;case ee.Unsent:return l.v.log("deleting unnecessary room key request for "+re(e)),this.cryptoStore.deleteOutgoingRoomKeyRequest(t.requestId,ee.Unsent);case ee.Sent:return this.cryptoStore.updateOutgoingRoomKeyRequest(t.requestId,ee.Sent,{state:ee.CancellationPending,cancellationTxnId:this.baseApis.makeTxnId()}).then((t=>{t?this.sendOutgoingRoomKeyRequestCancellation(t).catch((e=>{l.v.error("Error sending room key request cancellation; will retry later.",e),this.startTimer()})):l.v.log("Tried to cancel room key request for "+re(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+t.state)}}))}getOutgoingSentRoomKeyRequest(e,t){return this.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[ee.Sent])}cancelAndResendAllOutgoingRequests(){var e=this;return(0,n.A)((function*(){var t=yield e.cryptoStore.getAllOutgoingRoomKeyRequestsByState(ee.Sent);return Promise.all(t.map((t=>{var{requestBody:r,recipients:n}=t;return e.queueRoomKeyRequest(r,n,!0)})))}))()}startTimer(){if(!this.sendOutgoingRoomKeyRequestsTimer){var e=()=>{if(this.sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");this.sendOutgoingRoomKeyRequestsRunning=!0,this.sendOutgoingRoomKeyRequests().finally((()=>{this.sendOutgoingRoomKeyRequestsRunning=!1})).catch((e=>{l.v.warn("error in OutgoingRoomKeyRequestManager: ".concat(e))}))};this.sendOutgoingRoomKeyRequestsTimer=setTimeout(e,Z)}}sendOutgoingRoomKeyRequests(){var e=this;return(0,n.A)((function*(){if(e.clientRunning){var t=yield e.cryptoStore.getOutgoingRoomKeyRequestByState([ee.CancellationPending,ee.CancellationPendingAndWillResend,ee.Unsent]);if(t)try{switch(t.state){case ee.Unsent:yield e.sendOutgoingRoomKeyRequest(t);break;case ee.CancellationPending:yield e.sendOutgoingRoomKeyRequestCancellation(t);break;case ee.CancellationPendingAndWillResend:yield e.sendOutgoingRoomKeyRequestCancellation(t,!0);break}return e.sendOutgoingRoomKeyRequests()}catch(r){l.v.error("Error sending room key request; will retry later.",r),e.sendOutgoingRoomKeyRequestsTimer=void 0}else e.sendOutgoingRoomKeyRequestsTimer=void 0}else e.sendOutgoingRoomKeyRequestsTimer=void 0}))()}sendOutgoingRoomKeyRequest(e){l.v.log("Requesting keys for ".concat(re(e.requestBody))+" from ".concat(ne(e.recipients))+"(id ".concat(e.requestId,")"));var t={action:"request",requesting_device_id:this.deviceId,request_id:e.requestId,body:e.requestBody};return this.sendMessageToDevices(t,e.recipients,e.requestTxnId||e.requestId).then((()=>this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,ee.Unsent,{state:ee.Sent})))}sendOutgoingRoomKeyRequestCancellation(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];l.v.log("Sending cancellation for key request for "+"".concat(re(e.requestBody)," to ")+"".concat(ne(e.recipients)," ")+"(cancellation id ".concat(e.cancellationTxnId,")"));var r={action:"request_cancellation",requesting_device_id:this.deviceId,request_id:e.requestId};return this.sendMessageToDevices(r,e.recipients,e.cancellationTxnId).then((()=>t?this.cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,ee.CancellationPendingAndWillResend,{state:ee.Unsent}):this.cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,ee.CancellationPending)))}sendMessageToDevices(e,t,r){var n=new P.kG((()=>new Map));for(var i of t){var o=n.getOrCreate(i.userId);o.set(i.deviceId,X(X({},e),{},{[a.wt]:(0,s.A)()}))}return this.baseApis.sendToDevice(a.Bx.RoomKeyRequest,n,r)}}function re(e){return e.room_id+" / "+e.session_id}function ne(e){return"[".concat(e.map((e=>"".concat(e.userId,":").concat(e.deviceId))).join(","),"]")}var ie=r(3877);function oe(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function se(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?oe(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):oe(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function ae(e){var t,r,n=null===e||void 0===e||null===(t=e.currentState)||void 0===t?void 0:t.getStateEvents("m.room.history_visibility",""),i=null===n||void 0===n||null===(r=n.getContent())||void 0===r?void 0:r.history_visibility;return["world_readable","shared"].includes(i)}var ce=e=>"string"===typeof e.ciphertext?!!e.ciphertext.length:!!Object.keys(e.ciphertext).length;class le{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.sessionId=e,this.sharedHistory=t,(0,i.A)(this,"useCount",0),(0,i.A)(this,"creationTime",void 0),(0,i.A)(this,"sharedWithDevices",new P.kG((()=>new Map))),(0,i.A)(this,"blockedDevicesNotified",new P.kG((()=>new Map))),this.creationTime=(new Date).getTime()}needsRotation(e,t){var r=(new Date).getTime()-this.creationTime;return(this.useCount>=e||r>=t)&&(l.v.log("Rotating megolm session after "+this.useCount+" messages, "+r+"ms"),!0)}markSharedWithDevice(e,t,r,n){this.sharedWithDevices.getOrCreate(e).set(t,{deviceKey:r,messageIndex:n})}markNotifiedBlockedDevice(e,t){this.blockedDevicesNotified.getOrCreate(e).set(t,!0)}sharedWithTooManyDevices(e){for(var[t,r]of this.sharedWithDevices){if(!e.has(t))return l.v.log("Starting new megolm session because we shared with "+t),!0;for(var[n]of r){var i;if(null===(i=e.get(t))||void 0===i||!i.get(n))return l.v.log("Starting new megolm session because we shared with "+t+":"+n),!0}}return!1}}class de extends G{constructor(e){var t,r,n,o;super(e),(0,i.A)(this,"setupPromise",Promise.resolve(null)),(0,i.A)(this,"outboundSessions",{}),(0,i.A)(this,"sessionRotationPeriodMsgs",void 0),(0,i.A)(this,"sessionRotationPeriodMs",void 0),(0,i.A)(this,"encryptionPreparation",void 0),(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=l.v.getChild("[".concat(this.roomId," encryption]")),this.sessionRotationPeriodMsgs=null!==(t=null===(r=e.config)||void 0===r?void 0:r.rotation_period_msgs)&&void 0!==t?t:100,this.sessionRotationPeriodMs=null!==(n=null===(o=e.config)||void 0===o?void 0:o.rotation_period_ms)&&void 0!==n?n:6048e5}ensureOutboundSession(e,t,r){var i=arguments,o=this;return(0,n.A)((function*(){var s=i.length>3&&void 0!==i[3]&&i[3],a=function(){var i=(0,n.A)((function*(n){var i=ae(e),a=yield o.prepareSession(t,i,n);return yield o.shareSession(t,i,s,r,a),a}));return function(e){return i.apply(this,arguments)}}(),c=o.setupPromise.then(a);return o.setupPromise=c.catch((e=>(o.prefixedLogger.error("Failed to setup outbound session",e),null))),c}))()}prepareSession(e,t,r){var i=this;return(0,n.A)((function*(){var n,o;return r&&t!==r.sharedHistory&&(r=null),null!==(n=r)&&void 0!==n&&n.needsRotation(i.sessionRotationPeriodMsgs,i.sessionRotationPeriodMs)&&(i.prefixedLogger.debug("Starting new megolm session because we need to rotate."),r=null),null!==(o=r)&&void 0!==o&&o.sharedWithTooManyDevices(e)&&(r=null),r||(i.prefixedLogger.debug("Starting new megolm session"),r=yield i.prepareNewSession(t),i.prefixedLogger.debug("Started new megolm session ".concat(r.sessionId)),i.outboundSessions[r.sessionId]=r),r}))()}shareSession(e,t,r,i,o){var s=this;return(0,n.A)((function*(){var a={};for(var[c,l]of e)for(var[d,u]of l){var h,v=u.getIdentityKey();v!=s.olmDevice.deviceCurve25519Key&&(null!==(h=o.sharedWithDevices.get(c))&&void 0!==h&&h.get(d)||(a[c]=a[c]||[],a[c].push(u)))}var p=s.olmDevice.getOutboundGroupSessionKey(o.sessionId),f={type:"m.room_key",content:{algorithm:S.MEGOLM_ALGORITHM,room_id:s.roomId,session_id:o.sessionId,session_key:p.key,chain_index:p.chain_index,"org.matrix.msc3061.shared_history":t}},[g,m]=yield S.getExistingOlmSessions(s.olmDevice,s.baseApis,a);yield Promise.all([(0,n.A)((function*(){var e=Array.from(m.entries()).map((e=>{var[t,r]=e;return Array.from(r.entries()).map((e=>{var[r,n]=e;return"".concat(t,"/").concat(r,": ").concat(n.sessionId)}))})).flat(1);s.prefixedLogger.debug("Sharing keys with devices with existing Olm sessions:",e),yield s.shareKeyWithOlmSessions(o,p,f,m),s.prefixedLogger.debug("Shared keys with existing Olm sessions")}))(),(0,n.A)((function*(){var e=Array.from(g.entries()).map((e=>{var[t,r]=e;return r.map((e=>"".concat(t,"/").concat(e.deviceId)))})).flat(1);s.prefixedLogger.debug("Sharing keys (start phase 1) with devices without existing Olm sessions:",e);var t=[],i=Date.now(),a=[];yield s.shareKeyWithDevices(o,p,f,g,t,r?1e4:2e3,a),s.prefixedLogger.debug("Shared keys (end phase 1) with devices without existing Olm sessions"),!r&&Date.now()-i<1e4?(0,n.A)((function*(){var e=new P.kG((()=>[])),r=new Set;for(var n of a)r.add(n);var i=[];for(var{userId:c,deviceInfo:l}of t){var d=c.slice(c.indexOf(":")+1);r.has(d)?e.getOrCreate(c).push(l):i.push({userId:c,deviceInfo:l})}var u=Array.from(e.entries()).map((e=>{var[t,r]=e;return r.map((e=>"".concat(t,"/").concat(e.deviceId)))})).flat(1);u.length>0&&(s.prefixedLogger.debug("Sharing keys (start phase 2) with devices without existing Olm sessions:",u),yield s.shareKeyWithDevices(o,p,f,e,i,3e4),s.prefixedLogger.debug("Shared keys (end phase 2) with devices without existing Olm sessions")),yield s.notifyFailedOlmDevices(o,p,i)}))():yield s.notifyFailedOlmDevices(o,p,t)}))(),(0,n.A)((function*(){s.prefixedLogger.debug("There are ".concat(i.size," blocked devices:"),Array.from(i.entries()).map((e=>{var[t,r]=e;return Array.from(r.entries()).map((e=>{var[r,n]=e;return"".concat(t,"/").concat(r)}))})).flat(1));var e=new P.kG((()=>new Map)),t=0;for(var[r,n]of i)for(var[a,c]of n){var l;void 0===(null===(l=o.blockedDevicesNotified.get(r))||void 0===l?void 0:l.get(a))&&(e.getOrCreate(r).set(a,{device:c}),t++)}t&&(s.prefixedLogger.debug("Notifying ".concat(t," newly blocked devices:"),Array.from(e.entries()).map((e=>{var[t,r]=e;return Object.entries(r).map((e=>{var[r,n]=e;return"".concat(t,"/").concat(r)}))})).flat(1)),yield s.notifyBlockedDevices(o,e),s.prefixedLogger.debug("Notified ".concat(t," newly blocked devices")))}))()])}))()}prepareNewSession(e){var t=this;return(0,n.A)((function*(){var r=t.olmDevice.createOutboundGroupSession(),n=t.olmDevice.getOutboundGroupSessionKey(r);return yield t.olmDevice.addInboundGroupSession(t.roomId,t.olmDevice.deviceCurve25519Key,[],r,n.key,{ed25519:t.olmDevice.deviceEd25519Key},!1,{sharedHistory:e}),t.crypto.backupManager.backupGroupSession(t.olmDevice.deviceCurve25519Key,r),new le(r,e)}))()}getDevicesWithoutSessions(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];for(var[n,i]of t){var o=e.get(n);for(var s of i){var a=s.deviceId,c=null===o||void 0===o?void 0:o.get(a);null!==c&&void 0!==c&&c.sessionId||(r.push({userId:n,deviceInfo:s}),null===o||void 0===o||o.delete(a))}}return r}splitDevices(e){var t=20,r=[],n=[r];for(var[i,o]of e){for(var s of o.values())r.push({userId:i,deviceInfo:s.device});r.length>t&&(r=[],n.push(r))}return 0===r.length&&n.pop(),n}encryptAndSendKeysToDevices(e,t,r,n){return this.crypto.encryptAndSendToDevices(r,n).then((()=>{for(var n of r)e.markSharedWithDevice(n.userId,n.deviceInfo.deviceId,n.deviceInfo.getIdentityKey(),t)})).catch((e=>{throw this.prefixedLogger.error("failed to encryptAndSendToDevices",e),e}))}sendBlockedNotificationsToDevices(e,t,r){var i=this;return(0,n.A)((function*(){var n=new P.kG((()=>new Map));for(var o of t){var c=o.userId,l=o.deviceInfo,d=l.deviceInfo,u=d.deviceId,h=se(se({},r),{},{code:l.code,reason:l.reason,[a.wt]:(0,s.A)()});"m.no_olm"===h.code&&(delete h.room_id,delete h.session_id),n.getOrCreate(c).set(u,h)}for(var[v,p]of(yield i.baseApis.sendToDevice("m.room_key.withheld",n),n))for(var f of p.keys())e.markNotifiedBlockedDevice(v,f)}))()}reshareKeyWithDevice(e,t,r,i){var o=this;return(0,n.A)((function*(){var n,c=o.outboundSessions[t];if(c)if(c.sharedWithDevices.has(r)){var l=null===(n=c.sharedWithDevices.get(r))||void 0===n?void 0:n.get(i.deviceId);if(void 0!==l)if(l.deviceKey===i.getIdentityKey()){var d=yield o.olmDevice.getInboundGroupSessionKey(o.roomId,e,t,l.messageIndex);if(d){yield S.ensureOlmSessionsForDevices(o.olmDevice,o.baseApis,new Map([[r,[i]]]));var u={type:"m.forwarded_room_key",content:{algorithm:S.MEGOLM_ALGORITHM,room_id:o.roomId,session_id:t,session_key:d.key,chain_index:d.chain_index,sender_key:e,sender_claimed_ed25519_key:d.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:d.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":d.shared_history||!1}},h={algorithm:S.OLM_ALGORITHM,sender_key:o.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,s.A)()};yield S.encryptMessageForDevice(h.ciphertext,o.userId,o.deviceId,o.olmDevice,r,i,u),yield o.baseApis.sendToDevice("m.room.encrypted",new Map([[r,new Map([[i.deviceId,h]])]])),o.prefixedLogger.debug("Re-shared key for megolm session ".concat(e,"|").concat(t," with ").concat(r,":").concat(i.deviceId))}else o.prefixedLogger.warn("No inbound session key found for megolm session ".concat(e,"|").concat(t,": not re-sharing keys"))}else o.prefixedLogger.warn("Megolm session ".concat(e,"|").concat(t," has been shared with device ").concat(i.deviceId," but ")+"with identity key ".concat(l.deviceKey,". Key is now ").concat(i.getIdentityKey(),"!"));else o.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," never shared with device ").concat(r,":").concat(i.deviceId))}else o.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," never shared with user ").concat(r));else o.prefixedLogger.debug("megolm session ".concat(e,"|").concat(t," not found: not re-sharing keys"))}))()}shareKeyWithDevices(e,t,r,i,o,s,a){var c=this;return(0,n.A)((function*(){var n=yield S.ensureOlmSessionsForDevices(c.olmDevice,c.baseApis,i,!1,s,a,c.prefixedLogger);c.getDevicesWithoutSessions(n,i,o),yield c.shareKeyWithOlmSessions(e,t,r,n)}))()}shareKeyWithOlmSessions(e,t,r,i){var o=this;return(0,n.A)((function*(){for(var n=o.splitDevices(i),s=0;s<n.length;s++){var a="megolm keys for ".concat(e.sessionId," (slice ").concat(s+1,"/").concat(n.length,")");try{o.prefixedLogger.debug("Sharing ".concat(a),n[s].map((e=>"".concat(e.userId,"/").concat(e.deviceInfo.deviceId)))),yield o.encryptAndSendKeysToDevices(e,t.chain_index,n[s],r),o.prefixedLogger.debug("Shared ".concat(a))}catch(c){throw o.prefixedLogger.error("Failed to share ".concat(a)),c}}}))()}notifyFailedOlmDevices(e,t,r){var i=this;return(0,n.A)((function*(){for(var{userId:n,deviceInfo:o}of(i.prefixedLogger.debug("Notifying ".concat(r.length," devices we failed to create Olm sessions")),r)){var s=o.deviceId;e.markSharedWithDevice(n,s,o.getIdentityKey(),t.chain_index)}var a=yield i.olmDevice.filterOutNotifiedErrorDevices(r);i.prefixedLogger.debug("Need to notify ".concat(a.length," failed devices which haven't been notified before"));var c=new P.kG((()=>new Map));for(var{userId:l,deviceInfo:d}of a)c.getOrCreate(l).set(d.deviceId,{device:{code:"m.no_olm",reason:m["m.no_olm"],deviceInfo:d}});yield i.notifyBlockedDevices(e,c),i.prefixedLogger.debug("Notified ".concat(a.length," devices we failed to create Olm sessions"))}))()}notifyBlockedDevices(e,t){var r=this;return(0,n.A)((function*(){for(var n={room_id:r.roomId,session_id:e.sessionId,algorithm:S.MEGOLM_ALGORITHM,sender_key:r.olmDevice.deviceCurve25519Key},i=r.splitDevices(t),o=0;o<i.length;o++)try{yield r.sendBlockedNotificationsToDevices(e,i[o],n),r.prefixedLogger.debug("Completed blacklist notification for ".concat(e.sessionId," ")+"(slice ".concat(o+1,"/").concat(i.length,")"))}catch(s){throw r.prefixedLogger.debug("blacklist notification for ".concat(e.sessionId," ")+"(slice ".concat(o+1,"/").concat(i.length,") failed")),s}}))()}prepareToEncrypt(e){var t=this;if(e.roomId!==this.roomId)throw new Error("MegolmEncryption.prepareToEncrypt called on unexpected room");if(null!=this.encryptionPreparation){var r=Date.now()-this.encryptionPreparation.startTime;return this.prefixedLogger.debug("Already started preparing to encrypt for this room ".concat(r,"ms ago, skipping")),this.encryptionPreparation.cancel}this.prefixedLogger.debug("Preparing to encrypt events");var i=!1,o=()=>i;return this.encryptionPreparation={startTime:Date.now(),promise:(0,n.A)((function*(){try{var r=yield t.getDevicesInRoom(e,!1,o);if(null===r)return;var[n,i]=r;t.crypto.globalErrorOnUnknownDevices&&t.removeUnknownDevices(n),t.prefixedLogger.debug("Ensuring outbound megolm session"),yield t.ensureOutboundSession(e,n,i,!0),t.prefixedLogger.debug("Ready to encrypt events")}catch(s){t.prefixedLogger.error("Failed to prepare to encrypt events",s)}finally{delete t.encryptionPreparation}}))(),cancel:()=>{i=!0,delete this.encryptionPreparation}},this.encryptionPreparation.cancel}encryptMessage(e,t,r){var i=this;return(0,n.A)((function*(){if(i.prefixedLogger.debug("Starting to encrypt event"),null!=i.encryptionPreparation)try{yield i.encryptionPreparation.promise}catch(u){}var n=i.isVerificationEvent(t,r),[o,s]=yield i.getDevicesInRoom(e,n);i.crypto.globalErrorOnUnknownDevices&&i.checkForUnknownDevices(o);var a=yield i.ensureOutboundSession(e,o,s),c={room_id:i.roomId,type:t,content:r},l=i.olmDevice.encryptGroupMessage(a.sessionId,JSON.stringify(c)),d={algorithm:S.MEGOLM_ALGORITHM,sender_key:i.olmDevice.deviceCurve25519Key,ciphertext:l,session_id:a.sessionId,device_id:i.deviceId};return a.useCount++,d}))()}isVerificationEvent(e,t){switch(e){case a.Bx.KeyVerificationCancel:case a.Bx.KeyVerificationDone:case a.Bx.KeyVerificationMac:case a.Bx.KeyVerificationStart:case a.Bx.KeyVerificationKey:case a.Bx.KeyVerificationReady:case a.Bx.KeyVerificationAccept:return!0;case a.Bx.RoomMessage:return t["msgtype"]===a.Wr.KeyVerificationRequest;default:return!1}}forceDiscardSession(){this.setupPromise=this.setupPromise.then((()=>null))}checkForUnknownDevices(e){var t=new P.kG((()=>new Map));for(var[r,n]of e)for(var[i,o]of n)o.isUnverified()&&!o.isKnown()&&t.getOrCreate(r).set(i,o);if(t.size)throw new H("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)}removeUnknownDevices(e){for(var[t,r]of e){for(var[n,i]of r)i.isUnverified()&&!i.isKnown()&&r.delete(n);0===r.size&&e.delete(t)}}getDevicesInRoom(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]&&t[1],i=t.length>2?t[2]:void 0,o=yield e.getEncryptionTargetMembers();r.prefixedLogger.debug("Encrypting for users (shouldEncryptForInvitedMembers: ".concat(e.shouldEncryptForInvitedMembers(),"):"),o.map((e=>"".concat(e.userId," (").concat(e.membership,")"))));var s=o.map((function(e){return e.userId})),a=r.crypto.globalBlacklistUnverifiedDevices,c=e.getBlacklistUnverifiedDevices();"boolean"===typeof c&&(a=c);var l=yield r.crypto.downloadKeys(s,!1);if(!0===(null===i||void 0===i?void 0:i()))return null;var d=new P.kG((()=>new Map));for(var[u,h]of l)for(var[v,p]of h){if(void 0!==i&&(yield(0,P.iH)()),!0===(null===i||void 0===i?void 0:i()))return null;var f=r.crypto.checkDeviceTrust(u,v);if(p.isBlocked()||!f.isVerified()&&a&&!n){var g=d.getOrCreate(u),y=p.isBlocked();g.set(v,{code:y?"m.blacklisted":"m.unverified",reason:m[y?"m.blacklisted":"m.unverified"],deviceInfo:p}),h.delete(v)}}return[l,d]}))()}}class ue extends W{constructor(e){super(e),(0,i.A)(this,"pendingEvents",new Map),(0,i.A)(this,"olmlib",S),(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"prefixedLogger",void 0),this.roomId=e.roomId,this.prefixedLogger=l.v.getChild("[".concat(this.roomId," decryption]"))}decryptEvent(e){var t=this;return(0,n.A)((function*(){var r,n=e.getWireContent();if(!n.sender_key||!n.session_id||!n.ciphertext)throw new h.O(u.DecryptionFailureCode.MEGOLM_MISSING_FIELDS,"Missing fields in input");t.addEventToPendingList(e);try{r=yield t.olmDevice.decryptGroupMessage(e.getRoomId(),n.sender_key,n.session_id,n.ciphertext,e.getId(),e.getTs())}catch(c){if("DecryptionError"===c.name)throw c;var i=u.DecryptionFailureCode.OLM_DECRYPT_GROUP_MESSAGE_ERROR;throw"OLM.UNKNOWN_MESSAGE_INDEX"===(null===c||void 0===c?void 0:c.message)&&(t.requestKeysForEvent(e),i=u.DecryptionFailureCode.OLM_UNKNOWN_MESSAGE_INDEX),new h.O(i,c instanceof Error?c.message:"Unknown Error: Error is undefined",{session:n.sender_key+"|"+n.session_id})}if(null===r){t.crypto.backupManager.queryKeyBackupRateLimited(e.getRoomId(),n.session_id).catch((()=>{})),t.requestKeysForEvent(e);var o=yield t.olmDevice.sessionMayHaveProblems(n.sender_key,e.getTs()-12e4);if(o){t.prefixedLogger.info("When handling UISI from ".concat(e.getSender()," (sender key ").concat(n.sender_key,"): ")+"recent session problem with that sender:",o);var s=he[o.type]||he.unknown;throw o.fixed&&(s+=" Trying to create a new secure channel and re-requesting the keys."),new h.O(u.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,s,{session:n.sender_key+"|"+n.session_id})}throw new h.O(u.DecryptionFailureCode.MEGOLM_UNKNOWN_INBOUND_SESSION_ID,"The sender's device has not sent us the keys for this message.",{session:n.sender_key+"|"+n.session_id})}r.untrusted||t.removeEventFromPendingList(e);var a=JSON.parse(r.result);if(a.room_id!==e.getRoomId())throw new h.O(u.DecryptionFailureCode.MEGOLM_BAD_ROOM,"Message intended for room "+a.room_id);return{clearEvent:a,senderCurve25519Key:r.senderKey,claimedEd25519Key:r.keysClaimed.ed25519,forwardingCurve25519KeyChain:r.forwardingCurve25519KeyChain,untrusted:r.untrusted}}))()}requestKeysForEvent(e){var t=e.getWireContent(),r=e.getKeyRequestRecipients(this.userId);this.crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},r)}addEventToPendingList(e){var t,r=e.getWireContent(),n=r.sender_key,i=r.session_id;this.pendingEvents.has(n)||this.pendingEvents.set(n,new Map);var o=this.pendingEvents.get(n);o.has(i)||o.set(i,new Set),null===(t=o.get(i))||void 0===t||t.add(e)}removeEventFromPendingList(e){var t=e.getWireContent(),r=t.sender_key,n=t.session_id,i=this.pendingEvents.get(r),o=null===i||void 0===i?void 0:i.get(n);o&&(o.delete(e),0===o.size&&i.delete(n),0===i.size&&this.pendingEvents.delete(r))}roomKeyFromEvent(e){var t=e.getSenderKey(),r=e.getContent(),n={};if(r.room_id&&r.session_key&&r.session_id&&r.algorithm){if(S.isOlmEncrypted(e)){r["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0);var i={senderKey:t,sessionId:r.session_id,sessionKey:r.session_key,extraSessionData:n,exportFormat:!1,roomId:r.room_id,algorithm:r.algorithm,forwardingKeyChain:[],keysClaimed:e.getKeysClaimed()};return i}this.prefixedLogger.error("key event not properly encrypted")}else this.prefixedLogger.error("key event is missing fields")}forwardedRoomKeyFromEvent(e){var t=this.roomKeyFromEvent(e);if(t){var r=e.getSenderKey(),n=e.getContent(),i=this.baseApis.crypto.deviceList.getUserByIdentityKey(S.OLM_ALGORITHM,r),o=n.sender_key,s=n.sender_claimed_ed25519_key,a=Array.isArray(n.forwarding_curve25519_key_chain)?n.forwarding_curve25519_key_chain:[];if(a=a.slice(),a.push(r),i===e.getSender())if(o){if(s){var c={ed25519:s};return t.senderKey=o,t.keysClaimed=c,t.exportFormat=!0,t.forwardingKeyChain=a,t.extraSessionData.untrusted=!0,t}this.prefixedLogger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field")}else this.prefixedLogger.error("forwarded_room_key event is missing sender_key field");else this.prefixedLogger.error("sending device does not belong to the user it claims to be from")}}shouldAcceptForwardedKey(e,t){var r=this;return(0,n.A)((function*(){var n,i=e.getSenderKey(),o=null!==(n=r.crypto.deviceList.getDeviceByIdentityKey(S.OLM_ALGORITHM,i))&&void 0!==n?n:void 0,s=r.crypto.checkDeviceInfoTrust(e.getSender(),o),a=e.getSender()===r.baseApis.getUserId(),c=s.isVerified()&&a,l=yield r.wasRoomKeyRequested(e,t),d=r.wasRoomKeyForwardedByInviter(e,t),u=r.wasRoomKeyForwardedAsHistory(t);return l&&c||d&&u}))()}wasRoomKeyRequested(e,t){var r=this;return(0,n.A)((function*(){var n=yield r.crypto.cryptoStore.getOutgoingRoomKeyRequestsByTarget(e.getSender(),"*",[ee.Sent]);return n.some((e=>e.requestBody.room_id===t.roomId&&e.requestBody.session_id===t.sessionId))}))()}wasRoomKeyForwardedByInviter(e,t){var r,n,i,o=this.baseApis.getRoom(t.roomId),s=e.getSenderKey();if(!s)return!1;var a=this.crypto.deviceList.getUserByIdentityKey(S.OLM_ALGORITHM,s);if(!a)return!1;var c=null===o||void 0===o||null===(r=o.getMember(this.userId))||void 0===r?void 0:r.events.member,l=(null===c||void 0===c?void 0:c.getSender())===a||(null===c||void 0===c||null===(n=c.getUnsigned())||void 0===n?void 0:n.prev_sender)===a&&(null===c||void 0===c||null===(i=c.getPrevContent())||void 0===i?void 0:i.membership)===ie.O.Invite;return!(!o||!l)}wasRoomKeyForwardedAsHistory(e){var t=this.baseApis.getRoom(e.roomId);return!(!t||!e.extraSessionData.sharedHistory)}shouldParkForwardedKey(e){var t=this.baseApis.getRoom(e.roomId);return!(t||!e.extraSessionData.sharedHistory)}parkForwardedKey(e,t){var r=this;return(0,n.A)((function*(){var n={senderId:e.getSender(),senderKey:t.senderKey,sessionId:t.sessionId,sessionKey:t.sessionKey,keysClaimed:t.keysClaimed,forwardingCurve25519KeyChain:t.forwardingKeyChain};yield r.crypto.cryptoStore.doTxn("readwrite",["parked_shared_history"],(e=>r.crypto.cryptoStore.addParkedSharedHistory(t.roomId,n,e)),l.v.getChild("[addParkedSharedHistory]"))}))()}addRoomKey(e){var t=this;return(0,n.A)((function*(){try{yield t.olmDevice.addInboundGroupSession(e.roomId,e.senderKey,e.forwardingKeyChain,e.sessionId,e.sessionKey,e.keysClaimed,e.exportFormat,e.extraSessionData),(yield t.retryDecryption(e.senderKey,e.sessionId,!e.extraSessionData.untrusted))&&t.crypto.cancelRoomKeyRequest({algorithm:e.algorithm,room_id:e.roomId,session_id:e.sessionId,sender_key:e.senderKey}),yield t.crypto.backupManager.backupGroupSession(e.senderKey,e.sessionId)}catch(r){t.prefixedLogger.error("Error handling m.room_key_event: ".concat(r))}}))()}onForwardedRoomKey(e){var t=this;return(0,n.A)((function*(){var r=t.forwardedRoomKeyFromEvent(e);r&&((yield t.shouldAcceptForwardedKey(e,r))?yield t.addRoomKey(r):t.shouldParkForwardedKey(r)&&(yield t.parkForwardedKey(e,r)))}))()}onRoomKeyEvent(e){var t=this;return(0,n.A)((function*(){if("m.forwarded_room_key"==e.getType())yield t.onForwardedRoomKey(e);else{var r=t.roomKeyFromEvent(e);if(!r)return;yield t.addRoomKey(r)}}))()}onRoomKeyWithheldEvent(e){var t=this;return(0,n.A)((function*(){var r=e.getContent(),n=r.sender_key;"m.no_olm"===r.code?yield t.onNoOlmWithheldEvent(e):"m.unavailable"===r.code||(yield t.olmDevice.addInboundGroupSessionWithheld(r.room_id,n,r.session_id,r.code,r.reason)),r.session_id?yield t.retryDecryption(n,r.session_id):yield t.retryDecryptionFromSender(n)}))()}onNoOlmWithheldEvent(e){var t=this;return(0,n.A)((function*(){var r=e.getContent(),n=r.sender_key,i=e.getSender();if(t.prefixedLogger.warn("".concat(i,":").concat(n," was unable to establish an olm session with us")),yield t.olmDevice.getSessionIdForDevice(n))return t.prefixedLogger.debug("New session already created.  Not creating a new one."),void(yield t.olmDevice.recordSessionProblem(n,"no_olm",!0));var o=t.crypto.deviceList.getDeviceByIdentityKey(r.algorithm,n);if(!o&&(yield t.crypto.downloadKeys([i],!1),o=t.crypto.deviceList.getDeviceByIdentityKey(r.algorithm,n),!o))return t.prefixedLogger.info("Couldn't find device for identity key "+n+": not establishing session"),void(yield t.olmDevice.recordSessionProblem(n,"no_olm",!1));yield S.ensureOlmSessionsForDevices(t.olmDevice,t.baseApis,new Map([[i,[o]]]),!1);var c={algorithm:S.OLM_ALGORITHM,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,s.A)()};yield S.encryptMessageForDevice(c.ciphertext,t.userId,void 0,t.olmDevice,i,o,{type:"m.dummy"}),yield t.olmDevice.recordSessionProblem(n,"no_olm",!0),yield t.baseApis.sendToDevice("m.room.encrypted",new Map([[i,new Map([[o.deviceId,c]])]]))}))()}hasKeysForKeyRequest(e){var t=e.requestBody;return this.olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)}shareKeysWithDevice(e){var t=e.userId,r=e.deviceId,n=this.crypto.getStoredDevice(t,r),i=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,new Map([[t,[n]]])).then((e=>{var n,o=null===(n=e.get(t))||void 0===n?void 0:n.get(r);return null!==o&&void 0!==o&&o.sessionId?(this.prefixedLogger.debug("sharing keys for session "+i.sender_key+"|"+i.session_id+" with device "+t+":"+r),this.buildKeyForwardingMessage(i.room_id,i.sender_key,i.session_id)):null})).then((e=>{var i={algorithm:S.OLM_ALGORITHM,sender_key:this.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,s.A)()};return this.olmlib.encryptMessageForDevice(i.ciphertext,this.userId,void 0,this.olmDevice,t,n,e).then((()=>this.baseApis.sendToDevice("m.room.encrypted",new Map([[t,new Map([[r,i]])]]))))}))}buildKeyForwardingMessage(e,t,r){var i=this;return(0,n.A)((function*(){var n=yield i.olmDevice.getInboundGroupSessionKey(e,t,r);return{type:"m.forwarded_room_key",content:{algorithm:S.MEGOLM_ALGORITHM,room_id:e,sender_key:t,sender_claimed_ed25519_key:n.sender_claimed_ed25519_key,session_id:r,session_key:n.key,chain_index:n.chain_index,forwarding_curve25519_key_chain:n.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":n.shared_history||!1}}}))()}importRoomKey(e){var{untrusted:t,source:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={};return(t||e.untrusted)&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this.olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then((()=>{"backup"!==r&&this.crypto.backupManager.backupGroupSession(e.sender_key,e.session_id).catch((e=>{this.prefixedLogger.debug("Failed to back up megolm session",e)})),this.retryDecryption(e.sender_key,e.session_id,!n.untrusted)}))}retryDecryption(e,t,r){var i=this;return(0,n.A)((function*(){var o,s=i.pendingEvents.get(e);if(!s)return!0;var a=s.get(t);if(!a)return!0;var c=[...a];return i.prefixedLogger.debug("Retrying decryption on events:",c.map((e=>"".concat(e.getId())))),yield Promise.all(c.map(function(){var e=(0,n.A)((function*(e){try{yield e.attemptDecryption(i.crypto,{isRetry:!0,forceRedecryptIfUntrusted:r})}catch(t){}}));return function(t){return e.apply(this,arguments)}}())),!(null!==(o=i.pendingEvents.get(e))&&void 0!==o&&o.has(t))}))()}retryDecryptionFromSender(e){var t=this;return(0,n.A)((function*(){var r=t.pendingEvents.get(e);return!r||(t.pendingEvents.delete(e),yield Promise.all([...r].map(function(){var e=(0,n.A)((function*(e){var[r,i]=e;yield Promise.all([...i].map(function(){var e=(0,n.A)((function*(e){try{yield e.attemptDecryption(t.crypto)}catch(r){}}));return function(t){return e.apply(this,arguments)}}()))}));return function(t){return e.apply(this,arguments)}}())),!t.pendingEvents.has(e))}))()}sendSharedHistoryInboundSessions(e){var t=this;return(0,n.A)((function*(){yield S.ensureOlmSessionsForDevices(t.olmDevice,t.baseApis,e);var r=yield t.olmDevice.getSharedHistoryInboundGroupSessions(t.roomId);for(var[n,i]of(t.prefixedLogger.debug("Sharing history in with users ".concat(Array.from(e.keys())),r.map((e=>{var[t,r]=e;return"".concat(t,"|").concat(r)}))),r)){var o=yield t.buildKeyForwardingMessage(t.roomId,n,i),c=[],l=new Map;for(var[d,u]of e){var h=new Map;for(var v of(l.set(d,h),u)){var p={algorithm:S.OLM_ALGORITHM,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,s.A)()};h.set(v.deviceId,p),c.push(S.encryptMessageForDevice(p.ciphertext,t.userId,void 0,t.olmDevice,d,v,o))}}for(var[f,g]of(yield Promise.all(c),l)){for(var[m,y]of g)ce(y)||(t.prefixedLogger.debug("No ciphertext for device "+f+":"+m+": pruning"),g.delete(m));0===g.size&&(t.prefixedLogger.debug("Pruned all devices for user "+f),l.delete(f))}if(0===l.size)return void t.prefixedLogger.debug("No users left to send to: aborting");yield t.baseApis.sendToDevice("m.room.encrypted",l)}}))()}}var he={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};$(S.MEGOLM_ALGORITHM,de,ue);var ve=r(3178),pe=r(9683),fe=r(4108);class ge{constructor(e,t){(0,i.A)(this,"accountDataClientAdapter",void 0),(0,i.A)(this,"crossSigningCallbacks",void 0),(0,i.A)(this,"ssssCryptoCallbacks",void 0),(0,i.A)(this,"crossSigningKeys",void 0),(0,i.A)(this,"keySignatures",void 0),(0,i.A)(this,"keyBackupInfo",void 0),(0,i.A)(this,"sessionBackupPrivateKey",void 0),this.accountDataClientAdapter=new ye(e),this.crossSigningCallbacks=new Se,this.ssssCryptoCallbacks=new be(t)}addCrossSigningKeys(e,t){this.crossSigningKeys={authUpload:e,keys:t}}addSessionBackup(e){this.keyBackupInfo=e}addSessionBackupPrivateKeyToCache(e){this.sessionBackupPrivateKey=e}addKeySignature(e,t,r){var n;this.keySignatures||(this.keySignatures={});var i=null!==(n=this.keySignatures[e])&&void 0!==n?n:{};this.keySignatures[e]=i,i[t]=r}setAccountData(e,t){var r=this;return(0,n.A)((function*(){yield r.accountDataClientAdapter.setAccountData(e,t)}))()}buildOperation(){var e=this.accountDataClientAdapter.values;return new me(e,this.crossSigningKeys,this.keyBackupInfo,this.keySignatures)}persist(e){var t=this;return(0,n.A)((function*(){if(t.crossSigningKeys){var r=O(e.cryptoStore,e.olmDevice);for(var n of["master","self_signing","user_signing"]){var i;l.v.log("Cache ".concat(n," cross-signing private key locally"));var o=t.crossSigningCallbacks.privateKeys.get(n);yield null===(i=r.storeCrossSigningKeyCache)||void 0===i?void 0:i.call(r,n,o)}yield e.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT],(r=>{e.cryptoStore.storeCrossSigningKeys(r,t.crossSigningKeys.keys)}))}t.sessionBackupPrivateKey&&(yield e.storeSessionBackupPrivateKey(t.sessionBackupPrivateKey))}))()}}class me{constructor(e,t,r,n){this.accountData=e,this.crossSigningKeys=t,this.keyBackupInfo=r,this.keySignatures=n}apply(e){var t=this;return(0,n.A)((function*(){var r=e.baseApis;if(t.crossSigningKeys){var n,i,o={};for(var[s,a]of Object.entries(t.crossSigningKeys.keys))o[s+"_key"]=a;yield null===(n=(i=t.crossSigningKeys).authUpload)||void 0===n?void 0:n.call(i,(e=>r.uploadDeviceSigningKeys(null!==e&&void 0!==e?e:void 0,o))),e.crossSigningInfo.setKeys(t.crossSigningKeys.keys)}if(t.accountData)for(var[c,l]of t.accountData)yield r.setAccountData(c,l.getContent());t.keySignatures&&(yield r.uploadKeySignatures(t.keySignatures)),t.keyBackupInfo&&(t.keyBackupInfo.version?yield r.http.authedRequest(pe.IT.Put,"/room_keys/version/"+t.keyBackupInfo.version,void 0,{algorithm:t.keyBackupInfo.algorithm,auth_data:t.keyBackupInfo.auth_data},{prefix:pe.iD.V3}):yield r.http.authedRequest(pe.IT.Post,"/room_keys/version",void 0,t.keyBackupInfo,{prefix:pe.iD.V3}),yield e.backupManager.checkKeyBackup())}))()}}class ye extends x.X{constructor(e){super(),this.existingValues=e,(0,i.A)(this,"values",new Map)}getAccountDataFromServer(e){return Promise.resolve(this.getAccountData(e))}getAccountData(e){var t,r,n=null!==(t=this.values.get(e))&&void 0!==t?t:this.existingValues.get(e);return null!==(r=null===n||void 0===n?void 0:n.getContent())&&void 0!==r?r:null}setAccountData(e,t){var r=new ve.kl({type:e,content:t}),n=this.values.get(e);return this.values.set(e,r),Promise.resolve().then((()=>(this.emit(fe.AU.AccountData,r,n),{})))}}class Se{constructor(){(0,i.A)(this,"privateKeys",new Map)}getCrossSigningKeyCache(e,t){return this.getCrossSigningKey(e,t)}storeCrossSigningKeyCache(e,t){return this.privateKeys.set(e,t),Promise.resolve()}getCrossSigningKey(e,t){var r;return Promise.resolve(null!==(r=this.privateKeys.get(e))&&void 0!==r?r:null)}saveCrossSigningKeys(e){for(var[t,r]of Object.entries(e))this.privateKeys.set(t,r)}}class be{constructor(e){this.delegateCryptoCallbacks=e,(0,i.A)(this,"privateKeys",new Map)}getSecretStorageKey(e,t){var r=this;return(0,n.A)((function*(){var n,{keys:i}=e;for(var o of Object.keys(i)){var s=r.privateKeys.get(o);if(s)return[o,s]}if(null!==r&&void 0!==r&&null!==(n=r.delegateCryptoCallbacks)&&void 0!==n&&n.getSecretStorageKey){var a=yield r.delegateCryptoCallbacks.getSecretStorageKey({keys:i},t);if(a){var[c,l]=a;r.privateKeys.set(c,l)}return a}return null}))()}addPrivateKey(e,t,r){var n,i;this.privateKeys.set(e,r),null===(n=this.delegateCryptoCallbacks)||void 0===n||null===(i=n.cacheSecretStorageKey)||void 0===i||i.call(n,e,t,r)}}var Ee=r(1915);class _e{constructor(e,t){this.baseApis=e,this.cryptoCallbacks=t,(0,i.A)(this,"requests",new Map)}request(e,t){var r=this.baseApis.makeTxnId(),n=(0,P.v6)();this.requests.set(r,{name:e,devices:t,deferred:n});var i=e=>{var i={action:"request_cancellation",requesting_device_id:this.baseApis.deviceId,request_id:r},o=new Map;for(var s of t)o.set(s,i);this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),o]])),n.reject(new Error(e||"Cancelled"))},o={name:e,action:"request",requesting_device_id:this.baseApis.deviceId,request_id:r,[a.wt]:(0,s.A)()},c=new Map;for(var d of t)c.set(d,o);return l.v.info("Request secret ".concat(e," from ").concat(t,", id ").concat(r)),this.baseApis.sendToDevice("m.secret.request",new Map([[this.baseApis.getUserId(),c]])),{requestId:r,promise:n.promise,cancel:i}}onRequestReceived(e){var t=this;return(0,n.A)((function*(){var r=e.getSender(),n=e.getContent();if(r===t.baseApis.getUserId()&&n.name&&n.action&&n.requesting_device_id&&n.request_id){var i=n.requesting_device_id;if("request_cancellation"===n.action);else if("request"===n.action){if(i===t.baseApis.deviceId)return;if(l.v.info("received request for secret ("+r+", "+i+", "+n.request_id+")"),!t.cryptoCallbacks.onSecretRequested)return;var o=yield t.cryptoCallbacks.onSecretRequested(r,i,n.request_id,n.name,t.baseApis.checkDeviceTrust(r,i));if(o){l.v.info("Preparing ".concat(n.name," secret for ").concat(i));var c={type:"m.secret.send",content:{request_id:n.request_id,secret:o}},d={algorithm:S.OLM_ALGORITHM,sender_key:t.baseApis.crypto.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,s.A)()};yield S.ensureOlmSessionsForDevices(t.baseApis.crypto.olmDevice,t.baseApis,new Map([[r,[t.baseApis.getStoredDevice(r,i)]]])),yield S.encryptMessageForDevice(d.ciphertext,t.baseApis.getUserId(),t.baseApis.deviceId,t.baseApis.crypto.olmDevice,r,t.baseApis.getStoredDevice(r,i),c);var u=new Map([[r,new Map([[i,d]])]]);l.v.info("Sending ".concat(n.name," secret for ").concat(i)),t.baseApis.sendToDevice("m.room.encrypted",u)}else l.v.info("Request denied for ".concat(n.name," secret for ").concat(i))}}}))()}onSecretReceived(e){if(e.getSender()===this.baseApis.getUserId())if(S.isOlmEncrypted(e)){var t=e.getContent(),r=this.baseApis.crypto.deviceList.getUserByIdentityKey(S.OLM_ALGORITHM,e.getSenderKey()||"");if(r===e.getSender()){l.v.log("got secret share for request",t.request_id);var n=this.requests.get(t.request_id);if(n){var i=this.baseApis.crypto.deviceList.getDeviceByIdentityKey(S.OLM_ALGORITHM,e.getSenderKey());if(!i)return void l.v.log("secret share from unknown device with key",e.getSenderKey());if(!n.devices.includes(i.deviceId))return void l.v.log("unsolicited secret share from device",i.deviceId);var o=this.baseApis.crypto.checkDeviceInfoTrust(e.getSender(),i);if(!o.isVerified())return void l.v.log("secret share from unverified device");l.v.log("Successfully received secret ".concat(n.name," ")+"from ".concat(i.deviceId)),n.deferred.resolve(t.secret)}}else l.v.error("sending device does not belong to the user it claims to be from")}else l.v.error("secret event not properly encrypted")}}class we{constructor(e,t,r){(0,i.A)(this,"storageImpl",void 0),(0,i.A)(this,"sharingImpl",void 0),this.storageImpl=new Ee.ServerSideSecretStorageImpl(e,t),this.sharingImpl=new _e(r,t)}getDefaultKeyId(){return this.storageImpl.getDefaultKeyId()}setDefaultKeyId(e){return this.storageImpl.setDefaultKeyId(e)}addKey(e,t,r){return this.storageImpl.addKey(e,t,r)}getKey(e){return this.storageImpl.getKey(e)}hasKey(e){return this.storageImpl.hasKey(e)}checkKey(e,t){return this.storageImpl.checkKey(e,t)}store(e,t,r){return this.storageImpl.store(e,t,r)}get(e){return this.storageImpl.get(e)}isStored(e){var t=this;return(0,n.A)((function*(){return t.storageImpl.isStored(e)}))()}request(e,t){return this.sharingImpl.request(e,t)}onRequestReceived(e){return this.sharingImpl.onRequestReceived(e)}onSecretReceived(e){this.sharingImpl.onSecretReceived(e)}}var Ie=r(309);function Te(e,t,r){var n=Object.assign({},{code:e,reason:t},r);return new ve.kl({type:a.Bx.KeyVerificationCancel,content:n})}function Re(e,t){return function(r){return Te(e,t,r)}}var ke=Re("m.user","Cancelled by user"),Ae=Re("m.timeout","Timed out"),Ce=Re("m.unknown_method","Unknown method"),Oe=Re("m.unexpected_message","Unexpected message"),De=Re("m.key_mismatch","Key mismatch"),Me=Re("m.invalid_message","Invalid message");function Pe(e){var t=e.getContent();if(t){var{code:r,reason:n}=t;return{code:r,reason:n}}return{code:"Unknown error",reason:"m.unknown"}}var xe=r(7841),Ue=new Error("Verification timed out");class Le extends Error{constructor(e){super(),this.startEvent=e}}var Ne=xe.Ji;class Be extends x.X{constructor(e,t,r,n,o,s){super(),this.channel=e,this.baseApis=t,this.userId=r,this.deviceId=n,this.startEvent=o,this.request=s,(0,i.A)(this,"cancelled",!1),(0,i.A)(this,"_done",!1),(0,i.A)(this,"promise",null),(0,i.A)(this,"transactionTimeoutTimer",null),(0,i.A)(this,"expectedEvent",void 0),(0,i.A)(this,"resolve",void 0),(0,i.A)(this,"reject",void 0),(0,i.A)(this,"resolveEvent",void 0),(0,i.A)(this,"rejectEvent",void 0),(0,i.A)(this,"started",void 0),(0,i.A)(this,"doVerification",void 0)}get initiatedByMe(){if(!this.startEvent)return!0;var e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this.baseApis.getUserId()&&t.from_device===this.baseApis.getDeviceId()}get hasBeenCancelled(){return this.cancelled}resetTimer(){l.v.info("Refreshing/starting the verification transaction timeout timer"),null!==this.transactionTimeoutTimer&&clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=setTimeout((()=>{this._done||this.cancelled||(l.v.info("Triggering verification timeout"),this.cancel(Ue))}),6e5)}endTimer(){null!==this.transactionTimeoutTimer&&(clearTimeout(this.transactionTimeoutTimer),this.transactionTimeoutTimer=null)}send(e,t){return this.channel.send(e,t)}waitForEvent(e){if(this._done)return Promise.reject(new Error("Verification is already done"));var t=this.request.getEventFromOtherParty(e);return t?Promise.resolve(t):(this.expectedEvent=e,new Promise(((e,t)=>{this.resolveEvent=e,this.rejectEvent=t})))}canSwitchStartEvent(e){return!1}switchStartEvent(e){if(this.canSwitchStartEvent(e))if(l.v.log("Verification Base: switching verification start event",{restartingFlow:!!this.rejectEvent}),this.rejectEvent){var t=this.rejectEvent;this.rejectEvent=void 0,t(new Le(e))}else this.startEvent=e}handleEvent(e){var t;if(!this._done)if(e.getType()===this.expectedEvent)this.expectedEvent!==a.Bx.KeyVerificationDone&&(this.expectedEvent=void 0,this.rejectEvent=void 0,this.resetTimer(),null===(t=this.resolveEvent)||void 0===t||t.call(this,e));else if(e.getType()===a.Bx.KeyVerificationCancel){var r=this.reject;if(this.reject=void 0,r){var n=e.getContent(),{reason:i,code:o}=n;r(new Error("Other side cancelled verification "+"because ".concat(i," (").concat(o,")")))}}else if(this.expectedEvent){var s=new Error("Unexpected message: expecting "+this.expectedEvent+" but got "+e.getType());if(this.expectedEvent=void 0,this.rejectEvent){var c=this.rejectEvent;this.rejectEvent=void 0,c(s)}this.cancel(s)}}done(){var e=this;return(0,n.A)((function*(){var t;if(e.endTimer(),!e._done)return e.request.onVerifierFinished(),null===(t=e.resolve)||void 0===t||t.call(e),D(e.baseApis,e.userId,e.deviceId)}))()}cancel(e){if(this.endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===Ue){var t=Ae();this.send(t.getType(),t.getContent())}else if(e instanceof ve.kl){var r=e.getSender();if(r!==this.userId){var n=e.getContent();e.getType()===a.Bx.KeyVerificationCancel?(n.code=n.code||"m.unknown",n.reason=n.reason||n.body||"Unknown reason",this.send(a.Bx.KeyVerificationCancel,n)):this.send(a.Bx.KeyVerificationCancel,{code:"m.unknown",reason:n.body||"Unknown reason"})}}else this.send(a.Bx.KeyVerificationCancel,{code:"m.unknown",reason:e.toString()});null!==this.promise?this.reject&&this.reject(e):this.promise=Promise.reject(e),this.emit(Ne.Cancel,e)}}verify(){var e=this;return this.promise||(this.promise=new Promise(((t,r)=>{this.resolve=function(){e._done=!0,e.endTimer(),t(...arguments)},this.reject=e=>{this._done=!0,this.endTimer(),r(e)}})),this.doVerification&&!this.started&&(this.started=!0,this.resetTimer(),new Promise(((e,t)=>{var r,n=null===(r=this.baseApis.crypto.deviceList.getStoredCrossSigningForUser(this.userId))||void 0===r?void 0:r.getId();n===this.deviceId&&t(new Error("Device ID is the same as the cross-signing ID")),e()})).then((()=>this.doVerification())).then(this.done.bind(this),this.cancel.bind(this)))),this.promise}verifyKeys(e,t,r){var i=this;return(0,n.A)((function*(){var n=[];for(var[o,s]of Object.entries(t)){var a=o.split(":",2)[1],c=i.baseApis.getStoredDevice(e,a);if(c)r(o,c,s),n.push([a,o,c.keys[o]]);else{var d=i.baseApis.crypto.deviceList.getStoredCrossSigningForUser(e);d&&d.getId()===a?(r(o,b.V.fromStorage({keys:{[o]:a}},a),s),n.push([a,o,a])):l.v.warn("verification: Could not find device ".concat(a," to verify"))}}if(!n.length)throw new Error("No devices could be verified");for(var[u,h,v]of(l.v.info("Verification completed! Marking devices verified: ",n),n))yield i.baseApis.crypto.setDeviceVerification(e,u,!0,null,null,{[h]:v});e==i.baseApis.credentials.userId&&(yield i.baseApis.checkKeyBackup())}))()}get events(){}getShowSasCallbacks(){return null}getReciprocateQrCodeCallbacks(){return null}}var Ke=r(5942),Fe=Ke.V.ShowQrCode,je=Ke.V.ScanQrCode,qe=xe.Ji;class Ve extends Be{constructor(){var e;super(...arguments),e=this,(0,i.A)(this,"reciprocateQREvent",void 0),(0,i.A)(this,"doVerification",(0,n.A)((function*(){if(!e.startEvent)throw new Error("It is not currently possible to start verificationwith this method yet.");var{qrCodeData:t}=e.request;if(e.startEvent.getContent()["secret"]!==(null===t||void 0===t?void 0:t.encodedSharedSecret))throw De();yield new Promise(((t,r)=>{e.reciprocateQREvent={confirm:t,cancel:()=>r(ke())},e.emit(qe.ShowReciprocateQr,e.reciprocateQREvent)}));var r={};switch(null===t||void 0===t?void 0:t.mode){case He.VerifyOtherUser:var n=t.otherUserMasterKey;r["ed25519:".concat(n)]=n;break;case He.VerifySelfTrusted:var i=e.request.targetDevice.deviceId;r["ed25519:".concat(i)]=t.otherDeviceKey;break;case He.VerifySelfUntrusted:var o=t.myMasterKey;r["ed25519:".concat(o)]=o;break}yield e.verifyKeys(e.userId,r,((e,t,n)=>{var i=r[e];if(!i)throw De();if(n!==i)throw l.v.error("key ID from key info does not match"),De();for(var o in t.keys)if(o.startsWith("ed25519")){var s=r[o];if(!s)throw De();if(t.keys[o]!==s)throw l.v.error("master key does not match"),De()}}))})))}static factory(e,t,r,n,i,o){return new Ve(e,t,r,n,i,o)}static get NAME(){return"m.reciprocate.v1"}getReciprocateQrCodeCallbacks(){var e;return null!==(e=this.reciprocateQREvent)&&void 0!==e?e:null}}var Ge=2,We="MATRIX",He=function(e){return e[e["VerifyOtherUser"]=0]="VerifyOtherUser",e[e["VerifySelfTrusted"]=1]="VerifySelfTrusted",e[e["VerifySelfUntrusted"]=2]="VerifySelfUntrusted",e}(He||{});class $e{constructor(e,t,r,n,i,o){this.mode=e,this.sharedSecret=t,this.otherUserMasterKey=r,this.otherDeviceKey=n,this.myMasterKey=i,this.buffer=o}static create(e,t){return(0,n.A)((function*(){var r=$e.generateSharedSecret(),n=$e.determineMode(e,t),i=null,o=null,s=null;if(n===He.VerifyOtherUser){var a=t.getStoredCrossSigningForUser(e.otherUserId);i=a.getId("master")}else if(n===He.VerifySelfTrusted)o=yield $e.getOtherDeviceKey(e,t);else if(n===He.VerifySelfUntrusted){var c=t.getUserId(),l=t.getStoredCrossSigningForUser(c);s=l.getId("master")}var d=$e.generateQrData(e,t,n,r,i,o,s),u=$e.generateBuffer(d);return new $e(n,r,i,o,s,u)}))()}get encodedSharedSecret(){return this.sharedSecret}getBuffer(){return this.buffer}static generateSharedSecret(){var e=new Uint8Array(11);return globalThis.crypto.getRandomValues(e),(0,E.PP)(e)}static getOtherDeviceKey(e,t){return(0,n.A)((function*(){var r=t.getUserId(),n=e.targetDevice,i=n.deviceId?t.getStoredDevice(r,n.deviceId):void 0;if(!i)throw new Error("could not find device "+(null===n||void 0===n?void 0:n.deviceId));return i.getFingerprint()}))()}static determineMode(e,t){var r=t.getUserId(),n=e.otherUserId,i=He.VerifyOtherUser;if(r===n){var o=t.checkUserTrust(r);i=o.isCrossSigningVerified()?He.VerifySelfTrusted:He.VerifySelfUntrusted}return i}static generateQrData(e,t,r,n,i,o,s){var a=t.getUserId(),c=e.channel.transactionId,l={prefix:We,version:Ge,mode:r,transactionId:c,firstKeyB64:"",secondKeyB64:"",secretB64:n},d=t.getStoredCrossSigningForUser(a);return r===He.VerifyOtherUser?(l.firstKeyB64=d.getId("master"),l.secondKeyB64=i):r===He.VerifySelfTrusted?(l.firstKeyB64=d.getId("master"),l.secondKeyB64=o):r===He.VerifySelfUntrusted&&(l.firstKeyB64=t.getDeviceEd25519Key(),l.secondKeyB64=s),l}static generateBuffer(e){var t=Buffer.alloc(0),r=e=>{var r=Buffer.from([e]);t=Buffer.concat([t,r])},n=e=>{var r=Buffer.alloc(2);r.writeInt16BE(e,0),t=Buffer.concat([t,r])},i=function(e,r){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=Buffer.from(e,r);i&&n(o.byteLength),t=Buffer.concat([t,o])},o=e=>{var r=(0,E.y4)(e),n=Buffer.from(r);t=Buffer.concat([t,n])};return i(e.prefix,"ascii",!1),r(e.version),r(e.mode),i(e.transactionId,"utf-8"),o(e.firstKeyB64),o(e.secondKeyB64),o(e.secretB64),t}}function Je(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]}var ze,Ye=a.Bx.KeyVerificationStart,Qe=[a.Bx.KeyVerificationAccept,a.Bx.KeyVerificationKey,a.Bx.KeyVerificationMac],Xe=Re("m.mismatched_sas","Mismatched short authentication string"),Ze=Re("m.mismatched_commitment","Mismatched commitment"),et=[["🐶","dog"],["🐱","cat"],["🦁","lion"],["🐎","horse"],["🦄","unicorn"],["🐷","pig"],["🐘","elephant"],["🐰","rabbit"],["🐼","panda"],["🐓","rooster"],["🐧","penguin"],["🐢","turtle"],["🐟","fish"],["🐙","octopus"],["🦋","butterfly"],["🌷","flower"],["🌳","tree"],["🌵","cactus"],["🍄","mushroom"],["🌏","globe"],["🌙","moon"],["☁️","cloud"],["🔥","fire"],["🍌","banana"],["🍎","apple"],["🍓","strawberry"],["🌽","corn"],["🍕","pizza"],["🎂","cake"],["❤️","heart"],["😀","smiley"],["🤖","robot"],["🎩","hat"],["👓","glasses"],["🔧","spanner"],["🎅","santa"],["👍","thumbs up"],["☂️","umbrella"],["⌛","hourglass"],["⏰","clock"],["🎁","gift"],["💡","light bulb"],["📕","book"],["✏️","pencil"],["📎","paperclip"],["✂️","scissors"],["🔒","lock"],["🔑","key"],["🔨","hammer"],["☎️","telephone"],["🏁","flag"],["🚂","train"],["🚲","bicycle"],["✈️","aeroplane"],["🚀","rocket"],["🏆","trophy"],["⚽","ball"],["🎸","guitar"],["🎺","trumpet"],["🔔","bell"],["⚓","anchor"],["🎧","headphones"],["📁","folder"],["📌","pin"]];function tt(e){var t=[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6];return t.map((e=>et[e]))}var rt={decimal:Je,emoji:tt};function nt(e,t){var r={};for(var n of t)n in rt&&(r[n]=rt[n](Array.from(e)));return r}var it={"hkdf-hmac-sha256":"calculate_mac","org.matrix.msc3783.hkdf-hmac-sha256":"calculate_mac_fixed_base64","hkdf-hmac-sha256.v2":"calculate_mac_fixed_base64","hmac-sha256":"calculate_mac_long_kdf"};function ot(e,t){return function(r,n){var i=e[it[t]](r,n);return l.v.log("SAS calculateMAC:",t,[r,n],i),i}}var st={"curve25519-hkdf-sha256":function(e,t,r){var n="".concat(e.baseApis.getUserId(),"|").concat(e.baseApis.deviceId,"|")+"".concat(e.ourSASPubKey,"|"),i="".concat(e.userId,"|").concat(e.deviceId,"|").concat(e.theirSASPubKey,"|"),o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+i:i+n)+e.channel.transactionId;return t.generate_bytes(o,r)},curve25519:function(e,t,r){var n="".concat(e.baseApis.getUserId()).concat(e.baseApis.deviceId),i="".concat(e.userId).concat(e.deviceId),o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+i:i+n)+e.channel.transactionId;return t.generate_bytes(o,r)}},at=["curve25519-hkdf-sha256","curve25519"],ct=["sha256"],lt=["hkdf-hmac-sha256.v2","org.matrix.msc3783.hkdf-hmac-sha256","hkdf-hmac-sha256","hmac-sha256"],dt=Object.keys(rt),ut=new Set(at),ht=new Set(ct),vt=new Set(lt),pt=new Set(dt);function ft(e,t){return Array.isArray(e)?e.filter((e=>t.has(e))):[]}var gt=xe.Ji;class mt extends Be{constructor(){var e;super(...arguments),e=this,(0,i.A)(this,"waitingForAccept",void 0),(0,i.A)(this,"ourSASPubKey",void 0),(0,i.A)(this,"theirSASPubKey",void 0),(0,i.A)(this,"sasEvent",void 0),(0,i.A)(this,"doVerification",(0,n.A)((function*(){yield globalThis.Olm.init(),ze=ze||new globalThis.Olm.Utility,yield e.baseApis.downloadKeys([e.userId]);var t=!1;do{try{return e.initiatedByMe?yield e.doSendVerification():yield e.doRespondVerification()}catch(r){if(!(r instanceof Le))throw r;e.startEvent=r.startEvent,t=!0}}while(t)})))}static get NAME(){return Ke.V.Sas}get events(){return Qe}canSwitchStartEvent(e){if(e.getType()!==Ye)return!1;var t=e.getContent();return(null===t||void 0===t?void 0:t.method)===mt.NAME&&!!this.waitingForAccept}sendStart(){var e=this;return(0,n.A)((function*(){var t=e.channel.completeContent(Ye,{method:mt.NAME,from_device:e.baseApis.deviceId,key_agreement_protocols:at,hashes:ct,message_authentication_codes:lt,short_authentication_string:dt});return yield e.channel.sendCompleted(Ye,t),t}))()}verifyAndCheckMAC(e,t,r,i){var o=this;return(0,n.A)((function*(){var s=st[e](o,r,6),c=new Promise(((e,a)=>{o.sasEvent={sas:nt(s,t),confirm:function(){var t=(0,n.A)((function*(){try{yield o.sendMAC(r,i),e()}catch(t){a(t)}}));function s(){return t.apply(this,arguments)}return s}(),cancel:()=>a(ke()),mismatch:()=>a(Xe())},o.emit(gt.ShowSas,o.sasEvent)})),[l]=yield Promise.all([o.waitForEvent(a.Bx.KeyVerificationMac).then((e=>(o.expectedEvent=a.Bx.KeyVerificationDone,e))),c]),d=l.getContent();yield o.checkMAC(r,d,i)}))()}doSendVerification(){var e=this;return(0,n.A)((function*(){var t,r;if(e.waitingForAccept=!0,t=e.startEvent?e.channel.completedContentFromEvent(e.startEvent):yield e.sendStart(),!e.initiatedByMe)throw new Le(e.startEvent);try{r=yield e.waitForEvent(a.Bx.KeyVerificationAccept)}finally{e.waitingForAccept=!1}var n=r.getContent(),i=ft(n.short_authentication_string,pt);if(!(ut.has(n.key_agreement_protocol)&&ht.has(n.hash)&&vt.has(n.message_authentication_code)&&i.length))throw Ce();if("string"!==typeof n.commitment)throw Me();var s=n.key_agreement_protocol,c=n.message_authentication_code,l=n.commitment,d=new globalThis.Olm.SAS;try{e.ourSASPubKey=d.get_pubkey(),yield e.send(a.Bx.KeyVerificationKey,{key:e.ourSASPubKey}),r=yield e.waitForEvent(a.Bx.KeyVerificationKey),n=r.getContent();var u=n.key+o.stringify(t);if(ze.sha256(u)!==l)throw Ze();e.theirSASPubKey=n.key,d.set_their_key(n.key),yield e.verifyAndCheckMAC(s,i,d,c)}finally{d.free()}}))()}doRespondVerification(){var e=this;return(0,n.A)((function*(){var t=e.channel.completedContentFromEvent(e.startEvent),r=ft(at,new Set(t.key_agreement_protocols))[0],n=ft(ct,new Set(t.hashes))[0],i=ft(lt,new Set(t.message_authentication_codes))[0],s=ft(t.short_authentication_string,pt);if(void 0===r||void 0===n||void 0===i||!s.length)throw Ce();var c=new globalThis.Olm.SAS;try{var l=c.get_pubkey()+o.stringify(t);yield e.send(a.Bx.KeyVerificationAccept,{key_agreement_protocol:r,hash:n,message_authentication_code:i,short_authentication_string:s,commitment:ze.sha256(l)});var d=yield e.waitForEvent(a.Bx.KeyVerificationKey);t=d.getContent(),e.theirSASPubKey=t.key,c.set_their_key(t.key),e.ourSASPubKey=c.get_pubkey(),yield e.send(a.Bx.KeyVerificationKey,{key:e.ourSASPubKey}),yield e.verifyAndCheckMAC(r,s,c,i)}finally{c.free()}}))()}sendMAC(e,t){var r={},n=[],i="MATRIX_KEY_VERIFICATION_MAC"+this.baseApis.getUserId()+this.baseApis.deviceId+this.userId+this.deviceId+this.channel.transactionId,o="ed25519:".concat(this.baseApis.deviceId);r[o]=ot(e,t)(this.baseApis.getDeviceEd25519Key(),i+o),n.push(o);var s=this.baseApis.getCrossSigningId();if(s){var c="ed25519:".concat(s);r[c]=ot(e,t)(s,i+c),n.push(c)}var l=ot(e,t)(n.sort().join(","),i+"KEY_IDS");return this.send(a.Bx.KeyVerificationMac,{mac:r,keys:l})}checkMAC(e,t,r){var i=this;return(0,n.A)((function*(){var n="MATRIX_KEY_VERIFICATION_MAC"+i.userId+i.deviceId+i.baseApis.getUserId()+i.baseApis.deviceId+i.channel.transactionId;if(t.keys!==ot(e,r)(Object.keys(t.mac).sort().join(","),n+"KEY_IDS"))throw De();yield i.verifyKeys(i.userId,t.mac,((t,i,o)=>{if(o!==ot(e,r)(i.keys[t],n+t))throw De()}))}))()}getShowSasCallbacks(){var e;return null!==(e=this.sasEvent)&&void 0!==e?e:null}}var yt=r(8269),St=6e5,bt=12e4,Et=3e3,_t="m.key.verification.",wt=_t+"request",It=_t+"start",Tt=_t+"cancel",Rt=_t+"done",kt=_t+"ready",At=xe.X9.Unsent,Ct=xe.X9.Requested,Ot=xe.X9.Ready,Dt=xe.X9.Started,Mt=xe.X9.Cancelled,Pt=xe.X9.Done;class xt extends x.X{constructor(e,t,r){var o;super(),o=this,this.channel=e,this.verificationMethods=t,this.client=r,(0,i.A)(this,"eventsByUs",new Map),(0,i.A)(this,"eventsByThem",new Map),(0,i.A)(this,"_observeOnly",!1),(0,i.A)(this,"timeoutTimer",null),(0,i.A)(this,"_accepting",!1),(0,i.A)(this,"_declining",!1),(0,i.A)(this,"verifierHasFinished",!1),(0,i.A)(this,"_cancelled",!1),(0,i.A)(this,"_chosenMethod",null),(0,i.A)(this,"_qrCodeData",null),(0,i.A)(this,"requestReceivedAt",null),(0,i.A)(this,"commonMethods",[]),(0,i.A)(this,"_phase",void 0),(0,i.A)(this,"_cancellingUserId",void 0),(0,i.A)(this,"_verifier",void 0),(0,i.A)(this,"cancelOnTimeout",(0,n.A)((function*(){try{o.initiatedByMe?yield o.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):yield o.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){l.v.error("Error while cancelling verification request",e)}}))),this.channel.request=this,this.setPhase(At,!1)}static validateEvent(e,t,r){var n=t.getContent();return!(!e||!e.startsWith(_t))&&(n?e!==wt&&e!==kt||Array.isArray(n.methods)?e!==wt&&e!==kt&&e!==It||"string"===typeof n.from_device&&0!==n.from_device.length||(l.v.log("VerificationRequest: validateEvent: fail because from_device"),!1):(l.v.log("VerificationRequest: validateEvent: fail because methods"),!1):(l.v.log("VerificationRequest: validateEvent: no content"),!1))}get transactionId(){return this.channel.transactionId}get roomId(){return this.channel.roomId}get invalid(){return this.phase===At}get requested(){return this.phase===Ct}get cancelled(){return this.phase===Mt}get ready(){return this.phase===Ot}get started(){return this.phase===Dt}get done(){return this.phase===Pt}get methods(){return this.commonMethods}get chosenMethod(){return this._chosenMethod}calculateEventTimeout(e){var t=this.channel.getTimestamp(e)+St;if(this.requestReceivedAt&&!this.initiatedByMe&&this.phase<=Ct){var r=this.requestReceivedAt+bt;t=Math.min(t,r)}return Math.max(0,t-Date.now())}get timeout(){var e=this.getEventByEither(wt);return e?this.calculateEventTimeout(e):0}get requestEvent(){return this.getEventByEither(wt)}get phase(){return this._phase}get verifier(){return this._verifier}get canAccept(){return(0,xe.Dy)(this)}get accepting(){return this._accepting}get declining(){return this._declining}get pending(){return!this.observeOnly&&this._phase!==Pt&&this._phase!==Mt}get qrCodeData(){return this._qrCodeData}getQRCodeBytes(){if(this._qrCodeData)return new Uint8ClampedArray(this._qrCodeData.getBuffer())}generateQRCode(){var e=this;return(0,n.A)((function*(){return e.getQRCodeBytes()}))()}otherPartySupportsMethod(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t&&!this.ready&&!this.started)return!1;var r=this.eventsByThem.get(wt)||this.eventsByThem.get(kt);if(!r){if(this.started&&this.initiatedByMe){var n=this.eventsByUs.get(It),i=n&&n.getContent(),o=i&&i.method;return e==o}return!1}var s=r.getContent();if(!s)return!1;var{methods:a}=s;return!!Array.isArray(a)&&a.includes(e)}get initiatedByMe(){var e=this.eventsByUs.size+this.eventsByThem.size===0;if(this._phase===At&&e)return!0;var t=this.eventsByUs.has(wt),r=this.eventsByThem.has(wt);if(t&&!r)return!0;if(!t&&r)return!1;var n=this.eventsByUs.has(It),i=this.eventsByThem.has(It);return!(!n||i)}get requestingUserId(){return this.initiatedByMe?this.client.getUserId():this.otherUserId}get receivingUserId(){return this.initiatedByMe?this.otherUserId:this.client.getUserId()}get otherUserId(){return this.channel.userId}get otherDeviceId(){return this.channel.deviceId}get isSelfVerification(){return this.client.getUserId()===this.otherUserId}get cancellingUserId(){var e=this.eventsByUs.get(Tt),t=this.eventsByThem.get(Tt);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}get cancellationCode(){var e=this.getEventByEither(Tt);return e?e.getContent().code:null}get observeOnly(){return this._observeOnly}get targetDevice(){var e=this.eventsByThem.get(wt)||this.eventsByThem.get(kt)||this.eventsByThem.get(It),t=null===e||void 0===e?void 0:e.getContent(),r=null===t||void 0===t?void 0:t.from_device;return{userId:this.otherUserId,deviceId:r}}beginKeyVerification(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.observeOnly&&!this._verifier){var r=this.phase===Ct||this.phase===Ot||this.phase===At&&this.channel.canCreateRequest(It);if(r){if(this.commonMethods.length&&!this.commonMethods.includes(e))throw Ce();if(this._verifier=this.createVerifier(e,null,t),!this._verifier)throw Ce();this._chosenMethod=e}}return this._verifier}startVerification(e){var t=this;return(0,n.A)((function*(){var r=t.beginKeyVerification(e);return r.verify(),r}))()}scanQRCode(e){throw new Error("QR code scanning not supported by legacy crypto")}sendRequest(){var e=this;return(0,n.A)((function*(){if(!e.observeOnly&&e._phase===At){var t=[...e.verificationMethods.keys()];yield e.channel.send(wt,{methods:t})}}))()}cancel(){var e=arguments,t=this;return(0,n.A)((function*(){var{reason:r="User declined",code:n="m.user"}=e.length>0&&void 0!==e[0]?e[0]:{};if(!t.observeOnly&&t._phase!==Mt){if(t._declining=!0,t.emit(xe.FM.Change),t._verifier)return t._verifier.cancel(Re(n,r)());t._cancellingUserId=t.client.getUserId(),yield t.channel.send(Tt,{code:n,reason:r})}}))()}accept(){var e=this;return(0,n.A)((function*(){if(!e.observeOnly&&e.phase===Ct&&!e.initiatedByMe){var t=[...e.verificationMethods.keys()];e._accepting=!0,e.emit(xe.FM.Change),yield e.channel.send(kt,{methods:t})}}))()}waitFor(e){return new Promise(((t,r)=>{var n=()=>{var i=!1;return e(this)?(t(this),i=!0):this.cancelled&&(r(new Error("cancelled")),i=!0),i&&this.off(xe.FM.Change,n),i};n()||this.on(xe.FM.Change,n)}))}setPhase(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._phase=e,t&&this.emit(xe.FM.Change)}getEventByEither(e){return this.eventsByThem.get(e)||this.eventsByUs.get(e)}getEventBy(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return t?this.eventsByThem.get(e):this.eventsByUs.get(e)}calculatePhaseTransitions(){var e=[{phase:At}],t=()=>e[e.length-1].phase,r=this.eventsByThem.has(wt),n=this.getEventBy(wt,r);n&&e.push({phase:Ct,event:n});var i,o=n&&this.getEventBy(kt,!r);if(o&&t()===Ct&&e.push({phase:Ot,event:o}),o||!n){var s=this.eventsByThem.get(It),a=this.eventsByUs.get(It);i=s&&a?s.getSender()<a.getSender()?s:a:s||a}else i=this.getEventBy(It,!r);if(i){var c=t()===Ct&&(null===n||void 0===n?void 0:n.getSender())!==i.getSender(),l=t()===At&&this.channel.canCreateRequest(It);(c||t()===Ot||l)&&e.push({phase:Dt,event:i})}var d=this.eventsByUs.get(Rt);(this.verifierHasFinished||d&&t()===Dt)&&e.push({phase:Pt});var u=this.getEventByEither(Tt);return(this._cancelled||u)&&t()!==Pt?(e.push({phase:Mt,event:u}),e):e}transitionToPhase(e){var{phase:t,event:r}=e;if((t===Ct||t===Ot)&&!this.wasSentByOwnDevice(r)){var n=r.getContent();this.commonMethods=n.methods.filter((e=>this.verificationMethods.has(e)))}if(this.observeOnly||t!==Ct&&t!==Dt&&t!==Ot||this.channel.receiveStartFromOtherDevices&&this.wasSentByOwnUser(r)&&!this.wasSentByOwnDevice(r)&&(this._observeOnly=!0),t===Dt){var{method:i}=r.getContent();this._verifier||this.observeOnly||(this._verifier=this.createVerifier(i,r),this._verifier?this._chosenMethod=i:this.cancel({code:"m.unknown_method",reason:"Unknown method: ".concat(i)}))}}applyPhaseTransitions(){var e=this.calculatePhaseTransitions(),t=e.findIndex((e=>e.phase===this.phase)),r=e.slice(t+1);for(var n of r)this.transitionToPhase(n);return r}isWinningStartRace(e){if(e.getType()!==It)return!1;var t,r,n=this._verifier.startEvent;if(this.isSelfVerification)if(n){var i=n.getContent();t=i&&i.from_device}else t=this.client.getDeviceId();else t=n?n.getSender():this.client.getUserId();if(this.isSelfVerification){var o=e.getContent();r=o&&o.from_device}else r=e.getSender();return r<t}hasEventId(e){for(var t of this.eventsByUs.values())if(t.getId()===e)return!0;for(var r of this.eventsByThem.values())if(r.getId()===e)return!0;return!1}handleEvent(e,t,r,i,o){var s=this;return(0,n.A)((function*(){if(!s.done&&!s.cancelled){var n=s._observeOnly;if(s.adjustObserveOnly(t,r),s.observeOnly||i||!(yield s.cancelOnError(e,t))){var a=o?s.eventsByUs.has(e):s.eventsByThem.has(e);if(!a){var c=s.phase;s.addEvent(e,t,o);var d=s.applyPhaseTransitions();try{if(s._verifier&&!s.observeOnly){var u=s.isWinningStartRace(t);if(s._verifier.canSwitchStartEvent(t)&&u)s._verifier.switchStartEvent(t);else if(!i){var h;(e===Tt||null!==(h=s._verifier.events)&&void 0!==h&&h.includes(e))&&s._verifier.handleEvent(t)}}if(d.length){if(r&&d.some((e=>e.phase===Ot))){var v=s.otherPartySupportsMethod(je,!0);v&&(s._qrCodeData=yield $e.create(s,s.client))}var p=d[d.length-1],{phase:f}=p;s.setupTimeout(f),s.setPhase(f)}else s._observeOnly!==n&&s.emit(xe.FM.Change)}finally{l.v.log("Verification request ".concat(s.channel.transactionId,": ")+"".concat(e," event with id:").concat(t.getId(),", ")+"content:".concat(JSON.stringify(t.getContent())," ")+"deviceId:".concat(s.channel.deviceId,", ")+"sender:".concat(t.getSender(),", isSentByUs:").concat(o,", ")+"isLiveEvent:".concat(r,", isRemoteEcho:").concat(i,", ")+"phase:".concat(c,"=>").concat(s.phase,", ")+"observeOnly:".concat(n,"=>").concat(s._observeOnly))}}}}}))()}setupTimeout(e){var t=!this.timeoutTimer&&!this.observeOnly&&e===Ct;if(t&&(this.timeoutTimer=setTimeout(this.cancelOnTimeout,this.timeout)),this.timeoutTimer){var r=e===Dt||e===Ot||e===Pt||e===Mt;r&&(clearTimeout(this.timeoutTimer),this.timeoutTimer=null)}}cancelOnError(e,t){var r=this;return(0,n.A)((function*(){if(e===It){var n=t.getContent().method;if(!r.verificationMethods.has(n))return yield r.cancel(Pe(Ce())),!0}var i=e===wt&&r.phase!==At,o=e===kt&&r.phase!==Ct&&r.phase!==Dt;if(r.phase!==At&&(i||o)){l.v.warn("Cancelling, unexpected ".concat(e," verification ")+"event from ".concat(t.getSender()));var s="Unexpected ".concat(e," event in phase ").concat(r.phase);return yield r.cancel(Pe(Oe({reason:s}))),!0}return!1}))()}adjustObserveOnly(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];t||(this._observeOnly=!0),this.calculateEventTimeout(e)<Et&&(this._observeOnly=!0)}addEvent(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(r?this.eventsByUs.set(e,t):this.eventsByThem.set(e,t),e===wt){for(var[n,i]of this.eventsByThem.entries())i.getSender()!==this.otherUserId&&this.eventsByThem.delete(n);this.requestReceivedAt=Date.now()}}createVerifier(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r||(r=this.targetDevice);var{userId:n,deviceId:i}=r,o=this.verificationMethods.get(e);if(o)return new o(this.channel,this.client,n,i,t,this);l.v.warn("could not find verifier constructor for method",e)}wasSentByOwnUser(e){return(null===e||void 0===e?void 0:e.getSender())===this.client.getUserId()}wasSentByOwnDevice(e){if(!this.wasSentByOwnUser(e))return!1;var t=e.getContent();return!(!t||t.from_device!==this.client.getDeviceId())}onVerifierCancelled(){this._cancelled=!0;var e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}onVerifierFinished(){this.channel.send(a.Bx.KeyVerificationDone,{}),this.verifierHasFinished=!0;var e=this.applyPhaseTransitions();e.length&&this.setPhase(e[e.length-1].phase)}getEventFromOtherParty(e){return this.eventsByThem.get(e)}}var Ut=a.Bx.RoomMessage,Lt="m.reference",Nt="m.relates_to";class Bt{constructor(e,t,r){this.client=e,this.roomId=t,this.userId=r,(0,i.A)(this,"requestEventId",void 0)}get receiveStartFromOtherDevices(){return!0}get transactionId(){return this.requestEventId}static getOtherPartyUserId(e,t){var r=Bt.getEventType(e);if(r===wt){var n=t.getUserId(),i=e.getSender(),o=e.getContent(),s=o.to;return i===n?s:s===n?i:void 0}}getTimestamp(e){return e.getTs()}static canCreateRequest(e){return e===wt}canCreateRequest(e){return Bt.canCreateRequest(e)}static getTransactionId(e){if(Bt.getEventType(e)===wt)return e.getId();var t=e.getRelation();return(null===t||void 0===t?void 0:t.rel_type)===Lt?t.event_id:void 0}static validateEvent(e,t){var r=Bt.getTransactionId(e);if("string"!==typeof r||0===r.length)return!1;var n=Bt.getEventType(e),i=e.getContent();if(n===wt){if(!i||"string"!==typeof i.to||!i.to.length)return l.v.log("InRoomChannel: validateEvent: no valid to "+i.to),!1;if(!Bt.getOtherPartyUserId(e,t))return l.v.log("InRoomChannel: validateEvent: "+"not directed to or sent by me: ".concat(e.getSender())+", ".concat(i.to)),!1}return xt.validateEvent(n,e,t)}static getEventType(e){var t=e.getType();if(t===Ut){var r=e.getContent();if(r){var{msgtype:n}=r;if(n===wt)return wt}}return t&&t!==wt?t:""}handleEvent(e,t){var r=arguments,i=this;return(0,n.A)((function*(){var n=r.length>2&&void 0!==r[2]&&r[2];if(!t.hasEventId(e.getId())){var o=Bt.getEventType(e);if(e.getRoomId()===i.roomId){if(!i.userId){var s=Bt.getOtherPartyUserId(e,i.client);s&&(i.userId=s)}var a=i.client.getUserId(),c=e.getSender();if(!i.userId||c===a||c===i.userId){i.requestEventId||(i.requestEventId=Bt.getTransactionId(e));var d=!!e.getTxnId(),u=!!e.getUnsigned().transaction_id,h=e.getSender()===i.client.getUserId();return t.handleEvent(o,e,n,d||u,h)}l.v.log("InRoomChannel: ignoring verification event from non-participating sender ".concat(c))}}}))()}completedContentFromEvent(e){var t=Object.assign({},e.getContent());return t[Nt]=e.getRelation(),t}completeContent(e,t){return t=Object.assign({},t),e!==wt&&e!==kt&&e!==It||(t.from_device=this.client.getDeviceId()),e===wt?t={body:this.client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:wt,to:this.userId,from_device:t.from_device,methods:t.methods}:t[Nt]={rel_type:Lt,event_id:this.transactionId},t}send(e,t){var r=this.completeContent(e,t);return this.sendCompleted(e,r)}sendCompleted(e,t){var r=this;return(0,n.A)((function*(){var n=e;e===wt&&(n=Ut);var i=yield r.client.sendEvent(r.roomId,n,t);e===wt&&(r.requestEventId=i.event_id)}))()}}class Kt{constructor(){(0,i.A)(this,"requestsByRoomId",new Map)}getRequest(e){var t=e.getRoomId(),r=Bt.getTransactionId(e);return this.getRequestByTxnId(t,r)}getRequestByChannel(e){return this.getRequestByTxnId(e.roomId,e.transactionId)}getRequestByTxnId(e,t){var r=this.requestsByRoomId.get(e);if(r)return r.get(t)}setRequest(e,t){this.doSetRequest(e.getRoomId(),Bt.getTransactionId(e),t)}setRequestByChannel(e,t){this.doSetRequest(e.roomId,e.transactionId,t)}doSetRequest(e,t,r){var n=this.requestsByRoomId.get(e);n||(n=new Map,this.requestsByRoomId.set(e,n)),n.set(t,r)}removeRequest(e){var t=e.getRoomId(),r=this.requestsByRoomId.get(t);r&&(r.delete(Bt.getTransactionId(e)),0===r.size&&this.requestsByRoomId.delete(t))}findRequestInProgress(e,t){var r=this.requestsByRoomId.get(e);if(r)for(var n of r.values())if(n.pending&&(void 0===t||n.requestingUserId===t))return n}}var Ft=r(9553);class jt{constructor(e,t,r,n,o){this.client=e,this.userId=t,this.devices=r,this.transactionId=n,this.deviceId=o,(0,i.A)(this,"request",void 0)}isToDevices(e){if(e.length===this.devices.length){for(var t of e)if(!this.devices.includes(t))return!1;return!0}return!1}static getEventType(e){return e.getType()}static getTransactionId(e){var t=e.getContent();return t&&t.transaction_id}static canCreateRequest(e){return e===wt||e===It}canCreateRequest(e){return jt.canCreateRequest(e)}static validateEvent(e,t){if(e.isCancelled())return l.v.warn("Ignoring flagged verification request from "+e.getSender()),!1;var r=e.getContent();if(!r)return l.v.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!r.transaction_id)return l.v.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;var n=e.getType();if(n===wt){if(!Number.isFinite(r.timestamp))return l.v.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&r.from_device==t.getDeviceId())return l.v.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return xt.validateEvent(n,e,t)}getTimestamp(e){var t=e.getContent();return t&&t.timestamp}handleEvent(e,t){var r=arguments,i=this;return(0,n.A)((function*(){var n=r.length>2&&void 0!==r[2]&&r[2],o=e.getType(),s=e.getContent();if(o===wt||o===kt||o===It){i.transactionId||(i.transactionId=s.transaction_id);var a=s.from_device;if(!i.deviceId&&i.devices.includes(a)&&(i.deviceId=a),!i.deviceId||i.deviceId!==a){var c=i.completeContent(Tt,Pe(Oe()));return i.sendToDevices(Tt,c,[a])}}var l=t.phase===Dt||t.phase===Ot;yield t.handleEvent(e.getType(),e,n,!1,!1);var d=t.phase===Dt||t.phase===Ot,u=o===It||o===kt;if(u&&!l&&d&&i.deviceId){var h=i.devices.filter((e=>e!==i.deviceId&&e!==i.client.getDeviceId()));if(h.length){var v=i.completeContent(Tt,{code:"m.accepted",reason:"Verification request accepted by another device"});yield i.sendToDevices(Tt,v,h)}}}))()}completedContentFromEvent(e){return e.getContent()}completeContent(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==wt&&e!==kt&&e!==It||(t.from_device=this.client.getDeviceId()),e===wt&&(t.timestamp=Date.now()),t}send(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};e!==wt&&e!==It||this.transactionId||(this.transactionId=jt.makeTransactionId());var r=this.completeContent(e,t);return this.sendCompleted(e,r)}sendCompleted(e,t){var r=this;return(0,n.A)((function*(){var n;n=e===wt||e===Tt&&!r.deviceId?yield r.sendToDevices(e,t,r.devices):yield r.sendToDevices(e,t,[r.deviceId]);var i=new ve.kl({sender:r.client.getUserId(),content:t,type:e});return yield r.request.handleEvent(e,i,!0,!0,!0),n}))()}sendToDevices(e,t,r){var i=this;return(0,n.A)((function*(){if(r.length){var n=new Map;for(var o of r)n.set(o,t);yield i.client.sendToDevice(e,new Map([[i.userId,n]]))}}))()}static makeTransactionId(){return(0,Ft.US)(32)}}class qt{constructor(){(0,i.A)(this,"requestsByUserId",new Map)}getRequest(e){return this.getRequestBySenderAndTxnId(e.getSender(),jt.getTransactionId(e))}getRequestByChannel(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}getRequestBySenderAndTxnId(e,t){var r=this.requestsByUserId.get(e);if(r)return r.get(t)}setRequest(e,t){this.setRequestBySenderAndTxnId(e.getSender(),jt.getTransactionId(e),t)}setRequestByChannel(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}setRequestBySenderAndTxnId(e,t,r){var n=this.requestsByUserId.get(e);n||(n=new Map,this.requestsByUserId.set(e,n)),n.set(t,r)}removeRequest(e){var t=e.getSender(),r=this.requestsByUserId.get(t);r&&(r.delete(jt.getTransactionId(e)),0===r.size&&this.requestsByUserId.delete(t))}findRequestInProgress(e,t){var r=this.requestsByUserId.get(e);if(r)for(var n of r.values())if(n.pending&&n.channel.isToDevices(t))return n}getRequestsInProgress(e){var t=this.requestsByUserId.get(e);return t?Array.from(t.values()).filter((e=>e.pending)):[]}}class Vt extends Be{constructor(){super(...arguments),(0,i.A)(this,"doVerification",(0,n.A)((function*(){throw new Error("Verification is not possible with this method")})))}static factory(e,t,r,n,i,o){return new Vt(e,t,r,n,i,o)}static get NAME(){return"org.matrix.illegal_method"}}var Gt=r(6536),Wt=r(3530),Ht=r(1327),$t=r(8965),Jt=r(8058);class zt{constructor(e){this.cryptoStore=e,(0,i.A)(this,"roomEncryption",{})}init(){var e=this;return(0,n.A)((function*(){yield e.cryptoStore.doTxn("readwrite",[d.y.STORE_ROOMS],(t=>{e.cryptoStore.getEndToEndRooms(t,(t=>{e.roomEncryption=t}))}))}))()}getRoomEncryption(e){return this.roomEncryption[e]||null}isRoomEncrypted(e){return Boolean(this.getRoomEncryption(e))}setRoomEncryption(e,t){var r=this;return(0,n.A)((function*(){r.roomEncryption[e]=t,yield r.cryptoStore.doTxn("readwrite",[d.y.STORE_ROOMS],(n=>{r.cryptoStore.storeEndToEndRoom(e,t,n)}))}))()}}var Yt=r(4123),Qt=r(4178);function Xt(e,t){var r=new Map(Object.entries(e.keys)),n=e.getDisplayName()||void 0,i=new Map;if(e.signatures)for(var o in e.signatures)i.set(o,new Map(Object.entries(e.signatures[o])));return new Qt.p({deviceId:e.deviceId,userId:t,keys:r,algorithms:e.algorithms,verified:e.verified,signatures:i,displayName:n})}function Zt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function er(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Zt(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Zt(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var tr=b.V.DeviceVerification,rr={[Ve.NAME]:Ve,[mt.NAME]:mt,[Fe]:Vt,[je]:Vt};Ve.NAME,mt.NAME;function nr(){return Boolean(globalThis.Olm)}var ir=36e5,or=3e5,sr=function(e){return e["DeviceVerificationChanged"]="deviceVerificationChanged",e[e["UserTrustStatusChanged"]=u.CryptoEvent.UserTrustStatusChanged]="UserTrustStatusChanged",e["UserCrossSigningUpdated"]="userCrossSigningUpdated",e["RoomKeyRequest"]="crypto.roomKeyRequest",e["RoomKeyRequestCancellation"]="crypto.roomKeyRequestCancellation",e[e["KeyBackupStatus"]=u.CryptoEvent.KeyBackupStatus]="KeyBackupStatus",e[e["KeyBackupFailed"]=u.CryptoEvent.KeyBackupFailed]="KeyBackupFailed",e[e["KeyBackupSessionsRemaining"]=u.CryptoEvent.KeyBackupSessionsRemaining]="KeyBackupSessionsRemaining",e[e["KeyBackupDecryptionKeyCached"]=u.CryptoEvent.KeyBackupDecryptionKeyCached]="KeyBackupDecryptionKeyCached",e["KeySignatureUploadFailure"]="crypto.keySignatureUploadFailure",e["VerificationRequest"]="crypto.verification.request",e[e["VerificationRequestReceived"]=u.CryptoEvent.VerificationRequestReceived]="VerificationRequestReceived",e["Warning"]="crypto.warning",e[e["WillUpdateDevices"]=u.CryptoEvent.WillUpdateDevices]="WillUpdateDevices",e[e["DevicesUpdated"]=u.CryptoEvent.DevicesUpdated]="DevicesUpdated",e[e["KeysChanged"]=u.CryptoEvent.KeysChanged]="KeysChanged",e[e["LegacyCryptoStoreMigrationProgress"]=u.CryptoEvent.LegacyCryptoStoreMigrationProgress]="LegacyCryptoStoreMigrationProgress",e}({});class ar extends x.X{static getOlmVersion(){return g.getOlmVersion()}constructor(e,t,r,o,s,d){var u;if(super(),u=this,this.baseApis=e,this.userId=t,this.deviceId=r,this.clientStore=o,this.cryptoStore=s,(0,i.A)(this,"backupManager",void 0),(0,i.A)(this,"crossSigningInfo",void 0),(0,i.A)(this,"olmDevice",void 0),(0,i.A)(this,"deviceList",void 0),(0,i.A)(this,"dehydrationManager",void 0),(0,i.A)(this,"secretStorage",void 0),(0,i.A)(this,"roomList",void 0),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"verificationMethods",void 0),(0,i.A)(this,"supportedAlgorithms",void 0),(0,i.A)(this,"outgoingRoomKeyRequestManager",void 0),(0,i.A)(this,"toDeviceVerificationRequests",void 0),(0,i.A)(this,"inRoomVerificationRequests",void 0),(0,i.A)(this,"trustCrossSignedDevices",!0),(0,i.A)(this,"lastOneTimeKeyCheck",null),(0,i.A)(this,"oneTimeKeyCheckInProgress",!1),(0,i.A)(this,"roomEncryptors",new Map),(0,i.A)(this,"roomDecryptors",new Map),(0,i.A)(this,"deviceKeys",{}),(0,i.A)(this,"globalBlacklistUnverifiedDevices",!1),(0,i.A)(this,"globalErrorOnUnknownDevices",!0),(0,i.A)(this,"receivedRoomKeyRequests",[]),(0,i.A)(this,"receivedRoomKeyRequestCancellations",[]),(0,i.A)(this,"processingRoomKeyRequests",!1),(0,i.A)(this,"lazyLoadMembers",!1),(0,i.A)(this,"roomDeviceTrackingState",{}),(0,i.A)(this,"forceNewSessionRetryTime",new P.kG((()=>new P.kG((()=>0))))),(0,i.A)(this,"sendKeyRequestsImmediately",!1),(0,i.A)(this,"oneTimeKeyCount",void 0),(0,i.A)(this,"needsNewFallback",void 0),(0,i.A)(this,"fallbackCleanup",void 0),(0,i.A)(this,"onDeviceListUserCrossSigningUpdated",function(){var e=(0,n.A)((function*(e){if(e===u.userId){var t=u.deviceList.getStoredCrossSigningForUser(e),r=t?t.getId():null,n=u.crossSigningInfo.getId(),i=n!==r;n&&r&&!i?yield u.checkOwnCrossSigningTrust():(u.storeTrustedSelfKeys(null),u.emit(sr.KeysChanged,{}),u.emit(sr.UserTrustStatusChanged,u.userId,u.checkUserTrust(e)))}else{yield u.checkDeviceVerifications(e);var o=u.deviceList.getStoredCrossSigningForUser(e);o&&(o.updateCrossSigningVerifiedBefore(u.checkUserTrust(e).isCrossSigningVerified()),u.deviceList.setRawStoredCrossSigningForUser(e,o.toStorage())),u.emit(sr.UserTrustStatusChanged,e,u.checkUserTrust(e))}}));return function(t){return e.apply(this,arguments)}}()),(0,i.A)(this,"onMembership",((e,t,r)=>{try{this.onRoomMembership(e,t,r)}catch(n){l.v.error("Error handling membership change:",n)}})),(0,i.A)(this,"onToDeviceEvent",(e=>{try{l.v.log("received to-device ".concat(e.getType()," from: ")+"".concat(e.getSender()," id: ").concat(e.getContent()[a.wt])),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this.onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this.onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this.secretStorage.onRequestReceived(e):"m.secret.send"===e.getType()?this.secretStorage.onSecretReceived(e):"m.room_key.withheld"===e.getType()?this.onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this.onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this.onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once(ve.OQ.Decrypted,(e=>{this.onToDeviceEvent(e)})))}catch(t){l.v.error("Error handling toDeviceEvent:",t)}})),(0,i.A)(this,"onTimelineEvent",(function(e,t,r,n){var{liveEvent:i=!0}=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};if(Bt.validateEvent(e,u.baseApis)){var o=e=>{var t=new Bt(u.baseApis,e.getRoomId());return new xt(t,u.verificationMethods,u.baseApis)};u.handleVerificationEvent(e,u.inRoomVerificationRequests,o,i)}})),l.v.debug("Crypto: initialising roomlist..."),this.roomList=new zt(s),this.reEmitter=new c.Q(this),d)for(var h of(this.verificationMethods=new Map,d))"string"===typeof h?rr[h]&&this.verificationMethods.set(h,rr[h]):h["NAME"]?this.verificationMethods.set(h["NAME"],h):l.v.warn("Excluding unknown verification method ".concat(h));else this.verificationMethods=new Map(Object.entries(rr));this.backupManager=new Ht.IO(e,(0,n.A)((function*(){var e=yield u.getSessionBackupPrivateKey();if(e)return e;var t=yield u.secretStorage.get("m.megolm_backup.v1");if(t){var r=cr(t);if(r){var n=yield u.secretStorage.getKey();yield u.secretStorage.store("m.megolm_backup.v1",r,[n[0]])}return(0,E.y4)(r||t)}if(u.baseApis.cryptoCallbacks&&u.baseApis.cryptoCallbacks.getBackupKey)return u.baseApis.cryptoCallbacks.getBackupKey();throw new Error("Unable to get private key")}))),this.olmDevice=new g(s),this.deviceList=new L(e,s,this.olmDevice),this.deviceList.on(sr.UserCrossSigningUpdated,this.onDeviceListUserCrossSigningUpdated),this.reEmitter.reEmit(this.deviceList,[sr.DevicesUpdated,sr.WillUpdateDevices]),this.supportedAlgorithms=Array.from(V.keys()),this.outgoingRoomKeyRequestManager=new te(e,this.deviceId,this.cryptoStore),this.toDeviceVerificationRequests=new qt,this.inRoomVerificationRequests=new Kt;var v=this.baseApis.cryptoCallbacks||{},p=O(s,this.olmDevice);this.crossSigningInfo=new R(t,v,p),this.secretStorage=new we(e,v,e),this.dehydrationManager=new Wt.v(this),!v.getCrossSigningKey&&v.getSecretStorageKey&&(v.getCrossSigningKey=function(){var e=(0,n.A)((function*(e){return R.getFromSecretStorage(e,u.secretStorage)}));return function(t){return e.apply(this,arguments)}}())}init(){var e=arguments,t=this;return(0,n.A)((function*(){var{exportedOlmDevice:r,pickleKey:n}=e.length>0&&void 0!==e[0]?e[0]:{};l.v.log("Crypto: initialising Olm..."),yield globalThis.Olm.init(),l.v.log(r?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),yield t.olmDevice.init({fromExportedDevice:r,pickleKey:n}),l.v.log("Crypto: loading device list..."),yield t.deviceList.load(),t.deviceKeys["ed25519:"+t.deviceId]=t.olmDevice.deviceEd25519Key,t.deviceKeys["curve25519:"+t.deviceId]=t.olmDevice.deviceCurve25519Key,l.v.log("Crypto: fetching own devices...");var i=t.deviceList.getRawStoredDevicesForUser(t.userId);if(i||(i={}),!i[t.deviceId]){l.v.log("Crypto: adding this device to the store...");var o={keys:t.deviceKeys,algorithms:t.supportedAlgorithms,verified:tr.VERIFIED,known:!0};i[t.deviceId]=o,t.deviceList.storeDevicesForUser(t.userId,i),t.deviceList.saveIfDirty()}yield t.cryptoStore.doTxn("readonly",[d.y.STORE_ACCOUNT],(e=>{t.cryptoStore.getCrossSigningKeys(e,(e=>{e&&0!==Object.keys(e).length&&(l.v.log("Loaded cross-signing public keys from crypto store"),t.crossSigningInfo.setKeys(e))}))})),t.deviceList.startTrackingDeviceList(t.userId),l.v.debug("Crypto: initialising roomlist..."),yield t.roomList.init(),l.v.log("Crypto: checking for key backup..."),t.backupManager.checkAndStart()}))()}setDeviceIsolationMode(e){throw new Error("Not supported")}getVersion(){var e=ar.getOlmVersion();return"Olm ".concat(e[0],".").concat(e[1],".").concat(e[2])}getTrustCrossSignedDevices(){return this.trustCrossSignedDevices}getCryptoTrustCrossSignedDevices(){return this.trustCrossSignedDevices}setTrustCrossSignedDevices(e){for(var t of(this.trustCrossSignedDevices=e,this.deviceList.getKnownUserIds())){var r=this.deviceList.getRawStoredDevicesForUser(t);for(var n of Object.keys(r)){var i=this.checkDeviceTrust(t,n);if(!i.isLocallyVerified()&&i.isCrossSigningVerified()){var o=this.deviceList.getStoredDevice(t,n);this.emit(sr.DeviceVerificationChanged,t,n,o)}}}}setCryptoTrustCrossSignedDevices(e){this.setTrustCrossSignedDevices(e)}createRecoveryKeyFromPassphrase(e){return(0,n.A)((function*(){var t=new globalThis.Olm.PkDecryption;try{if(e){var r=yield(0,yt.SM)(e);t.init_with_private_key(r.key);var n=t.get_private_key();return{keyInfo:{passphrase:{algorithm:"m.pbkdf2",iterations:r.iterations,salt:r.salt}},privateKey:n,encodedPrivateKey:(0,u.encodeRecoveryKey)(n)}}t.generate_key();var i=t.get_private_key();return{privateKey:i,encodedPrivateKey:(0,u.encodeRecoveryKey)(i)}}finally{null===t||void 0===t||t.free()}}))()}userHasCrossSigningKeys(){var e=arguments,t=this;return(0,n.A)((function*(){var r=e.length>0&&void 0!==e[0]?e[0]:t.userId;return yield t.downloadKeys([r]),null!==t.deviceList.getStoredCrossSigningForUser(r)}))()}isCrossSigningReady(){var e=this;return(0,n.A)((function*(){var t=e.crossSigningInfo.getId(),r=(yield e.crossSigningInfo.isStoredInKeyCache())||(yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage));return!(!t||!r)}))()}isSecretStorageReady(){var e=this;return(0,n.A)((function*(){var t=yield e.secretStorage.hasKey(),r=yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage),n=!e.backupManager.getKeyBackupEnabled()||(yield e.baseApis.isKeyBackupKeyStored());return!!(t&&r&&n)}))()}getCrossSigningStatus(){var e=this;return(0,n.A)((function*(){var t,r,n,i=Boolean(e.crossSigningInfo.getId()),o=Boolean(yield e.crossSigningInfo.isStoredInSecretStorage(e.secretStorage)),s=e.crossSigningInfo.getCacheCallbacks(),a=Boolean(yield null===(t=s.getCrossSigningKeyCache)||void 0===t?void 0:t.call(s,"master")),c=Boolean(yield null===(r=s.getCrossSigningKeyCache)||void 0===r?void 0:r.call(s,"self_signing")),l=Boolean(yield null===(n=s.getCrossSigningKeyCache)||void 0===n?void 0:n.call(s,"user_signing"));return{publicKeysOnDevice:i,privateKeysInSecretStorage:o,privateKeysCachedLocally:{masterKey:a,selfSigningKey:c,userSigningKey:l}}}))()}bootstrapCrossSigning(){var e=arguments,t=this;return(0,n.A)((function*(){var{authUploadDeviceSigningKeys:r,setupNewCrossSigning:i}=e.length>0&&void 0!==e[0]?e[0]:{};l.v.log("Bootstrapping cross-signing");var o=t.baseApis.cryptoCallbacks,s=new ge(t.baseApis.store.accountData,o),a=new R(t.userId,s.crossSigningCallbacks,s.crossSigningCallbacks),c=function(){var e=(0,n.A)((function*(){a.resetKeys(),yield t.signObject(a.keys.master),s.addCrossSigningKeys(r,a.keys);var e=t.deviceList.getStoredDevice(t.userId,t.deviceId),n=yield a.signDevice(t.userId,e);s.addKeySignature(t.userId,t.deviceId,n),t.backupManager.backupInfo&&(yield a.signObject(t.backupManager.backupInfo.auth_data,"master"),s.addSessionBackup(t.backupManager.backupInfo))}));return function(){return e.apply(this,arguments)}}(),d=t.crossSigningInfo.getId(),u=yield t.crossSigningInfo.isStoredInKeyCache(),h=yield t.crossSigningInfo.isStoredInSecretStorage(t.secretStorage),v=u||h;l.v.log({setupNewCrossSigning:i,publicKeysOnDevice:d,privateKeysInCache:u,privateKeysInStorage:h,privateKeysExistSomewhere:v}),!v||i?(l.v.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),yield c()):d&&u?l.v.log("Cross-signing public keys trusted and private keys found locally"):h&&(l.v.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),yield t.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0}));var p=s.crossSigningCallbacks.privateKeys;if(p.size&&!t.baseApis.cryptoCallbacks.saveCrossSigningKeys){var f=new Ee.ServerSideSecretStorageImpl(s.accountDataClientAdapter,s.ssssCryptoCallbacks);(yield f.hasKey())&&(l.v.log("Storing new cross-signing private keys in secret storage"),yield R.storeInSecretStorage(p,f))}var g=s.buildOperation();yield g.apply(t),yield s.persist(t),l.v.log("Cross-signing ready")}))()}bootstrapSecretStorage(){var e=arguments,t=this;return(0,n.A)((function*(){var{createSecretStorageKey:r=(0,n.A)((function*(){return{}})),keyBackupInfo:i,setupNewKeyBackup:o,setupNewSecretStorage:s,getKeyBackupPassphrase:a}=e.length>0&&void 0!==e[0]?e[0]:{};l.v.log("Bootstrapping Secure Secret Storage");var c=t.baseApis.cryptoCallbacks,d=new ge(t.baseApis.store.accountData,c),h=new Ee.ServerSideSecretStorageImpl(d.accountDataClientAdapter,d.ssssCryptoCallbacks),v=null,p=function(){var e=(0,n.A)((function*(e){var{keyId:t,keyInfo:r}=yield h.addKey(Ee.SECRET_STORAGE_ALGORITHM_V1_AES,e);return d.ssssCryptoCallbacks.addPrivateKey(t,r,e.key),yield h.setDefaultKeyId(t),t}));return function(t){return e.apply(this,arguments)}}(),f=function(){var e=(0,n.A)((function*(e,r){if(!r.mac){var n,i,o=yield null===(n=(i=t.baseApis.cryptoCallbacks).getSecretStorageKey)||void 0===n?void 0:n.call(i,{keys:{[e]:r}},"");if(o){var s=o[1];d.ssssCryptoCallbacks.addPrivateKey(e,r,s);var{iv:a,mac:c}=yield(0,Ee.calculateKeyCheck)(s);r.iv=a,r.mac=c,yield d.setAccountData("m.secret_storage.key.".concat(e),r)}}}));return function(t,r){return e.apply(this,arguments)}}(),g=function(){var e=(0,n.A)((function*(e){if(t.crossSigningInfo.getId()&&(yield t.crossSigningInfo.isStoredInKeyCache("master")))try{l.v.log("Adding cross-signing signature to key backup"),yield t.crossSigningInfo.signObject(e,"master")}catch(r){l.v.error("Signing key backup with cross-signing keys failed",r)}else l.v.warn("Cross-signing keys not available, skipping signature on key backup")}));return function(t){return e.apply(this,arguments)}}(),m=yield t.secretStorage.getKey(),[y,S]=m||[null,null],b=!s&&S&&S.algorithm===Ee.SECRET_STORAGE_ALGORITHM_V1_AES;if(l.v.log({keyBackupInfo:i,setupNewKeyBackup:o,setupNewSecretStorage:s,storageExists:b,oldKeyInfo:S}),b||i)if(!b&&i){l.v.log("Secret storage does not exist, using key backup key");var _=(yield t.getSessionBackupPrivateKey())||(yield null===a||void 0===a?void 0:a()),w={key:_};i.auth_data.private_key_salt&&i.auth_data.private_key_iterations&&(w.passphrase={algorithm:"m.pbkdf2",iterations:i.auth_data.private_key_iterations,salt:i.auth_data.private_key_salt,bits:256}),v=yield p(w),yield h.store("m.megolm_backup.v1",(0,E.WG)(_),[v]),yield g(i.auth_data),d.addSessionBackup(i)}else l.v.log("Secret storage exists"),S&&S.algorithm===Ee.SECRET_STORAGE_ALGORITHM_V1_AES&&(yield f(y,S));else{l.v.log("Secret storage does not exist, creating new storage key");var{keyInfo:I,privateKey:T}=yield r();v=yield p({passphrase:null===I||void 0===I?void 0:I.passphrase,key:T,name:null===I||void 0===I?void 0:I.name})}if(!t.baseApis.cryptoCallbacks.saveCrossSigningKeys&&(yield t.isCrossSigningReady())&&(v||!(yield t.crossSigningInfo.isStoredInSecretStorage(h)))){l.v.log("Copying cross-signing private keys from cache to secret storage");var k=yield t.crossSigningInfo.getCrossSigningKeysFromCache();yield R.storeInSecretStorage(k,h)}if(o&&!i){l.v.log("Creating new message key backup version");var A=yield t.baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1}),C=(0,u.decodeRecoveryKey)(A.recovery_key);yield h.store("m.megolm_backup.v1",(0,E.WG)(C));var O={algorithm:A.algorithm,auth_data:A.auth_data};yield g(O.auth_data),yield t.signObject(O.auth_data),d.addSessionBackup(O)}var D=yield h.get("m.megolm_backup.v1");if(D){l.v.info("Got session backup key from secret storage: caching");var M=cr(D);if(M){var P=v||y;yield h.store("m.megolm_backup.v1",M,P?[P]:null)}var x=new Uint8Array((0,E.y4)(M||D));d.addSessionBackupPrivateKeyToCache(x)}else if(t.backupManager.getKeyBackupEnabled()){var U=(yield t.getSessionBackupPrivateKey())||(yield null===a||void 0===a?void 0:a());if(!U)return void l.v.error("Key backup is enabled but couldn't get key backup key!");l.v.info("Got session backup key from cache/user that wasn't in SSSS: saving to SSSS"),yield h.store("m.megolm_backup.v1",(0,E.WG)(U))}var L=d.buildOperation();yield L.apply(t),yield d.persist(t),l.v.log("Secure Secret Storage ready")}))()}resetKeyBackup(){var e=this;return(0,n.A)((function*(){yield e.backupManager.deleteAllKeyBackupVersions();var t=yield e.backupManager.prepareKeyBackupVersion();yield e.signObject(t.auth_data);var{version:r}=yield e.baseApis.http.authedRequest(pe.IT.Post,"/room_keys/version",void 0,t,{prefix:pe.iD.V3});l.v.log("Created backup version ".concat(r));var n=t.privateKey;yield e.secretStorage.store("m.megolm_backup.v1",(0,E.WG)(n)),yield e.storeSessionBackupPrivateKey(n),yield e.backupManager.checkAndStart(),yield e.backupManager.scheduleAllGroupSessionsForBackup()}))()}deleteKeyBackupVersion(e){var t=this;return(0,n.A)((function*(){yield t.backupManager.deleteKeyBackupVersion(e)}))()}addSecretStorageKey(e,t,r){return this.secretStorage.addKey(e,t,r)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}getSecretStorageKey(e){return this.secretStorage.getKey(e)}storeSecret(e,t,r){return this.secretStorage.store(e,t,r)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){return t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(this.userId))),this.secretStorage.request(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}checkSecretStoragePrivateKey(e,t){var r=null;try{r=new globalThis.Olm.PkDecryption;var n=r.init_with_private_key(e);return n===t}finally{var i;null===(i=r)||void 0===i||i.free()}}getSessionBackupPrivateKey(){var e=this;return(0,n.A)((function*(){var t=yield new Promise((t=>{e.cryptoStore.doTxn("readonly",[d.y.STORE_ACCOUNT],(r=>{e.cryptoStore.getSecretStorePrivateKey(r,t,"m.megolm_backup.v1")}))})),r=null;if("string"===typeof t&&(r=new Uint8Array((0,E.y4)(cr(t)||t)),yield e.storeSessionBackupPrivateKey(r)),t&&"object"===typeof t&&"ciphertext"in t){var n=Buffer.from(e.olmDevice.pickleKey),i=yield(0,w.A)(t,n,"m.megolm_backup.v1");r=(0,E.y4)(i)}return r}))()}storeSessionBackupPrivateKey(e,t){var r=this;return(0,n.A)((function*(){if(!(e instanceof Uint8Array))throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got ".concat(e));var t=Buffer.from(r.olmDevice.pickleKey),n=yield(0,_.A)((0,E.WG)(e),t,"m.megolm_backup.v1");return r.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT],(e=>{r.cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",n)}))}))()}loadSessionBackupPrivateKeyFromSecretStorage(){throw new Error("Not implmeented")}getActiveSessionBackupVersion(){var e=this;return(0,n.A)((function*(){var t;return e.backupManager.getKeyBackupEnabled()&&null!==(t=e.backupManager.version)&&void 0!==t?t:null}))()}getKeyBackupInfo(){return(0,n.A)((function*(){throw new Error("Not implemented")}))()}isKeyBackupTrusted(e){var t=this;return(0,n.A)((function*(){var r=yield t.backupManager.isKeyBackupTrusted(e);return(0,Ht.IG)(r)}))()}checkKeyBackupAndEnable(){var e=this;return(0,n.A)((function*(){var t=yield e.backupManager.checkKeyBackup();return t&&t.backupInfo?{backupInfo:t.backupInfo,trustInfo:(0,Ht.IG)(t.trustInfo)}:null}))()}checkCrossSigningPrivateKey(e,t){var r=null;try{r=new globalThis.Olm.PkSigning;var n=r.init_with_seed(e);return n===t}finally{var i;null===(i=r)||void 0===i||i.free()}}afterCrossSigningLocalKeyChange(){var e=this;return(0,n.A)((function*(){l.v.info("Starting cross-signing key change post-processing");var t=e.deviceList.getStoredDevice(e.userId,e.deviceId),r=yield e.crossSigningInfo.signDevice(e.userId,t);l.v.info("Starting background key sig upload for ".concat(e.deviceId));var n=t=>{var{shouldEmit:i=!1}=t;return e.baseApis.uploadKeySignatures({[e.userId]:{[e.deviceId]:r}}).then((t=>{var{failures:r}=t||{};if(Object.keys(r||[]).length>0)throw i&&e.baseApis.emit(sr.KeySignatureUploadFailure,r,"afterCrossSigningLocalKeyChange",n),new Gt.b0("Key upload failed",{failures:r});l.v.info("Finished background key sig upload for ".concat(e.deviceId))})).catch((t=>{l.v.error("Error during background key sig upload for ".concat(e.deviceId),t)}))};n({shouldEmit:!0});var i=e.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(i){l.v.info("Starting device verification upgrade");var o={};for(var[s,a]of Object.entries(e.deviceList.crossSigningInfo)){var c=yield e.checkForDeviceVerificationUpgrade(s,R.fromStorage(a,s));c&&(o[s]=c)}if(Object.keys(o).length>0){l.v.info("Found ".concat(Object.keys(o).length," verif users to upgrade"));try{var d=yield i({users:o});if(d)for(var u of d)u in o&&(yield e.baseApis.setDeviceVerified(u,o[u].crossSigningInfo.getId()))}catch(h){l.v.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",h)}}l.v.info("Finished device verification upgrade")}l.v.info("Finished cross-signing key change post-processing")}))()}checkForDeviceVerificationUpgrade(e,t){var r=this;return(0,n.A)((function*(){var n=r.crossSigningInfo.checkUserTrust(t);if(t.firstUse&&!n.isVerified()){var i=r.deviceList.getRawStoredDevicesForUser(e),o=yield r.checkForValidDeviceSignature(e,t.keys.master,i);if(o.length)return{devices:o.map((e=>b.V.fromStorage(i[e],e))),crossSigningInfo:t}}}))()}checkForValidDeviceSignature(e,t,r){var i=this;return(0,n.A)((function*(){var n=[];if(r&&t.signatures&&t.signatures[e])for(var o of Object.keys(t.signatures[e])){var[,s]=o.split(":",2);if(s in r&&r[s].verified===tr.VERIFIED)try{yield S.verifySignature(i.olmDevice,t,e,s,r[s].keys[o]),n.push(s)}catch(a){}}return n}))()}getCrossSigningKeyId(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Ie.n.Master;return Promise.resolve(this.getCrossSigningId(e))}getCrossSigningId(e){return this.crossSigningInfo.getId(e)}getStoredCrossSigningForUser(e){return this.deviceList.getStoredCrossSigningForUser(e)}checkUserTrust(e){var t=this.deviceList.getStoredCrossSigningForUser(e);return t?this.crossSigningInfo.checkUserTrust(t):new u.UserVerificationStatus(!1,!1,!1)}getUserVerificationStatus(e){var t=this;return(0,n.A)((function*(){return t.checkUserTrust(e)}))()}pinCurrentUserIdentity(e){return(0,n.A)((function*(){throw new Error("not implemented")}))()}withdrawVerificationRequirement(e){return(0,n.A)((function*(){throw new Error("not implemented")}))()}getDeviceVerificationStatus(e,t){var r=this;return(0,n.A)((function*(){var n=r.deviceList.getStoredDevice(e,t);return n?r.checkDeviceInfoTrust(e,n):null}))()}checkDeviceTrust(e,t){var r=this.deviceList.getStoredDevice(e,t);return this.checkDeviceInfoTrust(e,r)}checkDeviceInfoTrust(e,t){var r=!(null===t||void 0===t||!t.isVerified()),n=this.deviceList.getStoredCrossSigningForUser(e);if(t&&n){var i=this.trustCrossSignedDevices||e===this.userId;return this.crossSigningInfo.checkDeviceTrust(n,t,r,i)}return new C(!1,!1,r,!1)}checkIfOwnDeviceCrossSigned(e){var t,r=this.deviceList.getStoredDevice(this.userId,e);if(!r)return!1;var n=this.deviceList.getStoredCrossSigningForUser(this.userId);return null!==(t=null===n||void 0===n?void 0:n.checkDeviceTrust(n,r,!1,!0).isCrossSigningVerified())&&void 0!==t&&t}checkOwnCrossSigningTrust(){var e=arguments,t=this;return(0,n.A)((function*(){var{allowPrivateKeyRequests:r=!1}=e.length>0&&void 0!==e[0]?e[0]:{},n=t.userId;yield t.downloadKeys([t.userId]);var i=yield t.crossSigningInfo.getCrossSigningKeysFromCache(),o=t.deviceList.getStoredCrossSigningForUser(n);if(o){var s=o.getId(),a=t.crossSigningInfo.getId()!==s,c=o.getId()&&!i.has("master");if(a&&l.v.info("Got new master public key",s),r&&(a||c)){l.v.info("Attempting to retrieve cross-signing master private key");var d=null;try{var u=yield t.crossSigningInfo.getCrossSigningKey("master",s);d=u[1],l.v.info("Got cross-signing master private key")}finally{var h;null===(h=d)||void 0===h||h.free()}}var v=t.crossSigningInfo.getId("self_signing"),p=t.crossSigningInfo.getId("user_signing");t.storeTrustedSelfKeys(o.keys);var f=v!==o.getId("self_signing"),g=p!==o.getId("user_signing"),m=o.getId("self_signing")&&!i.has("self_signing"),y=o.getId("user_signing")&&!i.has("user_signing"),S={};if(f&&l.v.info("Got new self-signing key",o.getId("self_signing")),r&&(f||m)){l.v.info("Attempting to retrieve cross-signing self-signing private key");var b=null;try{var E=yield t.crossSigningInfo.getCrossSigningKey("self_signing",o.getId("self_signing"));b=E[1],l.v.info("Got cross-signing self-signing private key")}finally{var _;null===(_=b)||void 0===_||_.free()}var w=t.deviceList.getStoredDevice(t.userId,t.deviceId),I=yield t.crossSigningInfo.signDevice(t.userId,w);S[t.deviceId]=I}if(g&&l.v.info("Got new user-signing key",o.getId("user_signing")),r&&(g||y)){l.v.info("Attempting to retrieve cross-signing user-signing private key");var T=null;try{var R=yield t.crossSigningInfo.getCrossSigningKey("user_signing",o.getId("user_signing"));T=R[1],l.v.info("Got cross-signing user-signing private key")}finally{var k;null===(k=T)||void 0===k||k.free()}}if(a){var A=t.crossSigningInfo.keys.master;yield t.signObject(A);var C=A.signatures[t.userId]["ed25519:"+t.deviceId];S[t.crossSigningInfo.getId()]=Object.assign({},A,{signatures:{[t.userId]:{["ed25519:"+t.deviceId]:C}}})}var O=Object.keys(S);if(O.length){var D=e=>{var{shouldEmit:r=!1}=e;return l.v.info("Starting background key sig upload for ".concat(O)),t.baseApis.uploadKeySignatures({[t.userId]:S}).then((e=>{var{failures:n}=e||{};if(l.v.info("Finished background key sig upload for ".concat(O)),Object.keys(n||[]).length>0)throw r&&t.baseApis.emit(sr.KeySignatureUploadFailure,n,"checkOwnCrossSigningTrust",D),new Gt.b0("Key upload failed",{failures:n})})).catch((e=>{l.v.error("Error during background key sig upload for ".concat(O),e)}))};D({shouldEmit:!0})}t.emit(sr.UserTrustStatusChanged,n,t.checkUserTrust(n)),a&&(t.emit(sr.KeysChanged,{}),yield t.afterCrossSigningLocalKeyChange()),yield t.backupManager.checkKeyBackup()}else l.v.error("Got cross-signing update event for user "+n+" but no new cross-signing information found!")}))()}getBackupDecryptor(e,t){return(0,n.A)((function*(){if(!(t instanceof Uint8Array))throw new Error("getBackupDecryptor expects Uint8Array");var r=yield Ht.IO.makeAlgorithm(e,(0,n.A)((function*(){return t})));return(yield r.keyMatches(t))?new Ht.M7(r):Promise.reject(new pe.up({errcode:fe.pB.RESTORE_BACKUP_ERROR_BAD_KEY}))}))()}importBackedUpRoomKeys(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return r.source="backup",this.importRoomKeys(e,r)}storeTrustedSelfKeys(e){var t=this;return(0,n.A)((function*(){e?t.crossSigningInfo.setKeys(e):t.crossSigningInfo.clearKeys(),yield t.cryptoStore.doTxn("readwrite",[d.y.STORE_ACCOUNT],(e=>{t.cryptoStore.storeCrossSigningKeys(e,t.crossSigningInfo.keys)}))}))()}checkDeviceVerifications(e){var t=this;return(0,n.A)((function*(){var r=t.baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications;if(r){if(l.v.info("Starting device verification upgrade for ".concat(e)),t.crossSigningInfo.keys.user_signing){var n=t.deviceList.getStoredCrossSigningForUser(e);if(n){var i=yield t.checkForDeviceVerificationUpgrade(e,n);if(i){var o=yield r({users:{[e]:i}});o.includes(e)&&(yield t.baseApis.setDeviceVerified(e,n.getId()))}}}l.v.info("Finished device verification upgrade for ".concat(e))}}))()}enableLazyLoading(){this.lazyLoadMembers=!0}registerEventHandlers(e){e.on(Jt.o.Membership,this.onMembership),e.on(fe.AU.ToDeviceEvent,this.onToDeviceEvent),e.on($t.u9.Timeline,this.onTimelineEvent),e.on(ve.OQ.Decrypted,this.onTimelineEvent)}start(){l.v.warn("MatrixClient.crypto.start() is deprecated")}stop(){this.outgoingRoomKeyRequestManager.stop(),this.deviceList.stop(),this.dehydrationManager.stop(),this.backupManager.stop()}getDeviceEd25519Key(){return this.olmDevice.deviceEd25519Key}getDeviceCurve25519Key(){return this.olmDevice.deviceCurve25519Key}getOwnDeviceKeys(){var e=this;return(0,n.A)((function*(){if(!e.olmDevice.deviceCurve25519Key)throw new Error("Curve25519 key not yet created");if(!e.olmDevice.deviceEd25519Key)throw new Error("Ed25519 key not yet created");return{ed25519:e.olmDevice.deviceEd25519Key,curve25519:e.olmDevice.deviceCurve25519Key}}))()}setGlobalBlacklistUnverifiedDevices(e){this.globalBlacklistUnverifiedDevices=e}getGlobalBlacklistUnverifiedDevices(){return this.globalBlacklistUnverifiedDevices}uploadDeviceKeys(){var e={algorithms:this.supportedAlgorithms,device_id:this.deviceId,keys:this.deviceKeys,user_id:this.userId};return this.signObject(e).then((()=>this.baseApis.uploadKeysRequest({device_keys:e})))}getNeedsNewFallback(){return!!this.needsNewFallback}maybeUploadOneTimeKeys(){var e=this,t=6e4,r=5;if(!this.oneTimeKeyCheckInProgress){var i=Date.now();if(!(null!==this.lastOneTimeKeyCheck&&i-this.lastOneTimeKeyCheck<t)){this.lastOneTimeKeyCheck=i;var o=this.olmDevice.maxNumberOfOneTimeKeys(),s=Math.floor(o/2),a=function(){var t=(0,n.A)((function*(t){while(s>t||e.getNeedsNewFallback()){if(s>t){l.v.info("generating oneTimeKeys");var n=Math.min(s-t,r);yield e.olmDevice.generateOneTimeKeys(n)}if(e.getNeedsNewFallback()){var i=yield e.olmDevice.getFallbackKey();i.curve25519&&0!=Object.keys(i.curve25519).length||(l.v.info("generating fallback key"),e.fallbackCleanup&&(clearTimeout(e.fallbackCleanup),delete e.fallbackCleanup),yield e.olmDevice.generateFallbackKey())}l.v.info("calling uploadOneTimeKeys");var o=yield e.uploadOneTimeKeys();if(!o.one_time_key_counts||!o.one_time_key_counts.signed_curve25519)throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");t=o.one_time_key_counts.signed_curve25519}}));return function(e){return t.apply(this,arguments)}}();this.oneTimeKeyCheckInProgress=!0,Promise.resolve().then((()=>void 0!==this.oneTimeKeyCount?Promise.resolve(this.oneTimeKeyCount):this.baseApis.uploadKeysRequest({}).then((e=>e.one_time_key_counts.signed_curve25519||0)))).then((e=>a(e))).catch((e=>{l.v.error("Error uploading one-time keys",e.stack||e)})).finally((()=>{this.oneTimeKeyCount=void 0,this.oneTimeKeyCheckInProgress=!1}))}}}uploadOneTimeKeys(){var e=this;return(0,n.A)((function*(){var t,r=[];if(e.getNeedsNewFallback()){t={};var n=yield e.olmDevice.getFallbackKey();for(var[i,o]of Object.entries(n.curve25519)){var s={key:o,fallback:!0};t["signed_curve25519:"+i]=s,r.push(e.signObject(s))}e.needsNewFallback=!1}var a=yield e.olmDevice.getOneTimeKeys(),c={};for(var l in a.curve25519)if(a.curve25519.hasOwnProperty(l)){var d={key:a.curve25519[l]};c["signed_curve25519:"+l]=d,r.push(e.signObject(d))}yield Promise.all(r);var u={one_time_keys:c};t&&(u["org.matrix.msc2732.fallback_keys"]=t,u["fallback_keys"]=t);var h=yield e.baseApis.uploadKeysRequest(u);return t&&(e.fallbackCleanup=setTimeout((()=>{delete e.fallbackCleanup,e.olmDevice.forgetOldFallbackKey()}),36e5)),yield e.olmDevice.markKeysAsPublished(),h}))()}downloadKeys(e,t){return this.deviceList.downloadKeys(e,!!t)}getStoredDevicesForUser(e){return this.deviceList.getStoredDevicesForUser(e)}getUserDeviceInfo(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]&&t[1],i=new Map,o=[],s=function*(e){var t=yield r.getStoredDevicesForUser(e);if(t){var n=new Map(t.map((t=>[t.deviceId,Xt(t,e)])));i.set(e,n)}else o.push(e)};for(var a of e)yield*s(a);if(n&&o.length>0){var c=yield r.downloadKeys(o);c.forEach(((e,t)=>{var r=new Map;e.forEach(((e,n)=>r.set(n,Xt(e,t)))),i.set(t,r)}))}return i}))()}getStoredDevice(e,t){return this.deviceList.getStoredDevice(e,t)}saveDeviceList(e){return this.deviceList.saveIfDirty(e)}setDeviceVerified(e,t){var r=arguments,i=this;return(0,n.A)((function*(){var n=!(r.length>2&&void 0!==r[2])||r[2];yield i.setDeviceVerification(e,t,n)}))()}crossSignDevice(e){var t=this;return(0,n.A)((function*(){yield t.setDeviceVerified(t.userId,e,!0)}))()}setDeviceVerification(e,t){var r=arguments,i=this;return(0,n.A)((function*(){var o=r.length>2&&void 0!==r[2]?r[2]:null,s=r.length>3&&void 0!==r[3]?r[3]:null,a=r.length>4&&void 0!==r[4]?r[4]:null,c=r.length>5?r[5]:void 0,d=i.deviceList.getStoredCrossSigningForUser(e);if((null===d||void 0===d?void 0:d.getId())===t){if(null!==s||null!==a)throw new Error("Cannot set blocked or known for a cross-signing key");if(!o)throw new Error("Cannot set a cross-signing key as unverified");var u=c?Object.values(c)[0]:null;if(c&&(1!==Object.values(c).length||u!==d.getId()))throw new Error("Key did not match expected value: expected ".concat(d.getId(),", got ").concat(u));if(i.crossSigningInfo.getId()||e!==i.crossSigningInfo.userId||(i.storeTrustedSelfKeys(d.keys),i.emit(sr.UserTrustStatusChanged,i.userId,i.checkUserTrust(e))),e!==i.userId){l.v.info("Master key "+d.getId()+" for "+e+" marked verified. Signing...");var h=yield i.crossSigningInfo.signUser(d);if(h){var v=function(){var r=(0,n.A)((function*(r){var{shouldEmit:n=!1}=r;l.v.info("Uploading signature for "+e+"...");var o=yield i.baseApis.uploadKeySignatures({[e]:{[t]:h}}),{failures:s}=o||{};if(Object.keys(s||[]).length>0)throw n&&i.baseApis.emit(sr.KeySignatureUploadFailure,s,"setDeviceVerification",v),new Gt.b0("Key upload failed",{failures:s})}));return function(e){return r.apply(this,arguments)}}();yield v({shouldEmit:!0})}return h}return d}var p=i.deviceList.getRawStoredDevicesForUser(e);if(!p||!p[t])throw new Error("Unknown device "+e+":"+t);var f=p[t],g=f.verified;if(o){if(c)for(var[m,y]of Object.entries(c))if(f.keys[m]!==y)throw new Error("Key did not match expected value: expected ".concat(y,", got ").concat(f.keys[m]));g=tr.VERIFIED}else null!==o&&g==tr.VERIFIED&&(g=tr.UNVERIFIED);s?g=tr.BLOCKED:null!==s&&g==tr.BLOCKED&&(g=tr.UNVERIFIED);var S=f.known;if(null!==a&&(S=a),f.verified===g&&f.known===S||(f.verified=g,f.known=S,i.deviceList.storeDevicesForUser(e,p),i.deviceList.saveIfDirty()),o&&e===i.userId){var E;l.v.info("Own device "+t+" marked verified: signing");var _=i.checkDeviceTrust(e,t);if(_.isCrossSigningVerified()?l.v.log("Own device ".concat(t," already cross-signing verified")):E=yield i.crossSigningInfo.signDevice(e,b.V.fromStorage(f,t)),E){var w=function(){var r=(0,n.A)((function*(r){var{shouldEmit:n=!1}=r;l.v.info("Uploading signature for "+t);var o=yield i.baseApis.uploadKeySignatures({[e]:{[t]:E}}),{failures:s}=o||{};if(Object.keys(s||[]).length>0)throw n&&i.baseApis.emit(sr.KeySignatureUploadFailure,s,"setDeviceVerification",w),new Gt.b0("Key upload failed",{failures:s})}));return function(e){return r.apply(this,arguments)}}();yield w({shouldEmit:!0})}}var I=b.V.fromStorage(f,t);return i.emit(sr.DeviceVerificationChanged,e,t,I),I}))()}findVerificationRequestDMInProgress(e,t){return this.inRoomVerificationRequests.findRequestInProgress(e,t)}getVerificationRequestsToDeviceInProgress(e){return this.toDeviceVerificationRequests.getRequestsInProgress(e)}requestVerificationDM(e,t){var r=this.inRoomVerificationRequests.findRequestInProgress(t);if(r)return Promise.resolve(r);var n=new Bt(this.baseApis,t,e);return this.requestVerificationWithChannel(e,n,this.inRoomVerificationRequests)}requestVerification(e,t){t||(t=Object.keys(this.deviceList.getRawStoredDevicesForUser(e)));var r=this.toDeviceVerificationRequests.findRequestInProgress(e,t);if(r)return Promise.resolve(r);var n=new jt(this.baseApis,e,t,jt.makeTransactionId());return this.requestVerificationWithChannel(e,n,this.toDeviceVerificationRequests)}requestOwnUserVerification(){return this.requestVerification(this.userId)}requestDeviceVerification(e,t){return this.requestVerification(e,[t])}requestVerificationWithChannel(e,t,r){var i=this;return(0,n.A)((function*(){var e=new xt(t,i.verificationMethods,i.baseApis);t.transactionId&&r.setRequestByChannel(t,e),yield e.sendRequest();var n=r.getRequestByChannel(t);return n?e=n:(l.v.log("Crypto: adding new request to "+"requestsByTxnId with id ".concat(t.transactionId," ").concat(t.roomId)),r.setRequestByChannel(t,e)),e}))()}beginKeyVerification(e,t,r){var n,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(i){if(n=this.toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,i),!n)throw new Error("No request found for user ".concat(t," with ")+"transactionId ".concat(i))}else{i=jt.makeTransactionId();var o=new jt(this.baseApis,t,[r],i,r);n=new xt(o,this.verificationMethods,this.baseApis),this.toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,i,n)}return n.beginKeyVerification(e,{userId:t,deviceId:r})}legacyDeviceVerification(e,t,r){var i=this;return(0,n.A)((function*(){var n=jt.makeTransactionId(),o=new jt(i.baseApis,e,[t],n,t),s=new xt(o,i.verificationMethods,i.baseApis);i.toDeviceVerificationRequests.setRequestBySenderAndTxnId(e,n,s);var a=s.beginKeyVerification(r,{userId:e,deviceId:t});return yield Promise.race([a.verify(),s.waitFor((e=>e.started))]),s}))()}getOlmSessionsForUser(e){var t=this;return(0,n.A)((function*(){var r=t.getStoredDevicesForUser(e)||[],n={};for(var i of r){var o=i.getIdentityKey(),s=yield t.olmDevice.getSessionInfoForDevice(o);n[i.deviceId]={deviceIdKey:o,sessions:s}}return n}))()}getEventSenderDeviceInfo(e){var t=e.getSenderKey(),r=e.getWireContent().algorithm;if(!t||!r)return null;if(e.isKeySourceUntrusted())return null;var n=this.deviceList.getDeviceByIdentityKey(r,t);if(null===n)return null;var i=e.getClaimedEd25519Key();return i?i!==n.getFingerprint()?(l.v.warn("Event "+e.getId()+" claims ed25519 key "+i+" but sender device has key "+n.getFingerprint()),null):n:(l.v.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)}getEventEncryptionInfo(e){var t,r,n={};if(n.senderKey=null!==(t=e.getSenderKey())&&void 0!==t?t:void 0,n.algorithm=e.getWireContent().algorithm,!n.senderKey||!n.algorithm)return n.encrypted=!1,n;n.encrypted=!0,e.isKeySourceUntrusted()?n.authenticated=!1:n.authenticated=!0,n.sender=null!==(r=this.deviceList.getDeviceByIdentityKey(n.algorithm,n.senderKey))&&void 0!==r?r:void 0;var i=e.getClaimedEd25519Key();return i||(l.v.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),n.mismatchedSender=!0),n.sender&&i!==n.sender.getFingerprint()&&(l.v.warn("Event "+e.getId()+" claims ed25519 key "+i+"but sender device has key "+n.sender.getFingerprint()),n.mismatchedSender=!0),n}getEncryptionInfoForEvent(e){var t=this;return(0,n.A)((function*(){var r=t.getEventEncryptionInfo(e);if(!r.encrypted)return null;var n=e.getSender();if(!n||r.mismatchedSender)return{shieldColour:u.EventShieldColour.RED,shieldReason:u.EventShieldReason.MISMATCHED_SENDER_KEY};var i=t.checkUserTrust(n);if(!i.isCrossSigningVerified())return r.authenticated?{shieldColour:u.EventShieldColour.NONE,shieldReason:null}:{shieldColour:u.EventShieldColour.GREY,shieldReason:u.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED};var o=n&&r.sender&&(yield t.getDeviceVerificationStatus(n,r.sender.deviceId));return o?o.isVerified()?r.authenticated?{shieldColour:u.EventShieldColour.NONE,shieldReason:null}:{shieldColour:u.EventShieldColour.GREY,shieldReason:u.EventShieldReason.AUTHENTICITY_NOT_GUARANTEED}:{shieldColour:u.EventShieldColour.RED,shieldReason:u.EventShieldReason.UNSIGNED_DEVICE}:{shieldColour:u.EventShieldColour.GREY,shieldReason:u.EventShieldReason.UNKNOWN_DEVICE}}))()}forceDiscardSession(e){var t=this.roomEncryptors.get(e);if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");return t.forceDiscardSession(),Promise.resolve()}setRoomEncryption(e,t,r){var i=this;return(0,n.A)((function*(){var n=i.clientStore.getRoom(e);if(!n)throw new Error("Unable to enable encryption tracking devices in unknown room ".concat(e));yield i.setRoomEncryptionImpl(n,t),i.lazyLoadMembers||r||i.deviceList.refreshOutdatedDeviceLists()}))()}setRoomEncryptionImpl(e,t){var r=this;return(0,n.A)((function*(){var n=e.roomId;if(t.algorithm){var i=r.roomList.getRoomEncryption(n);if(i&&JSON.stringify(i)!=JSON.stringify(t))l.v.error("Ignoring m.room.encryption event which requests a change of config in "+n);else{var o=r.roomEncryptors.get(n);if(!o){var s=null;i||(s=r.roomList.setRoomEncryption(n,t));var a=q.get(t.algorithm);if(!a)throw new Error("Unable to encrypt with "+t.algorithm);var c=new a({userId:r.userId,deviceId:r.deviceId,crypto:r,olmDevice:r.olmDevice,baseApis:r.baseApis,roomId:n,config:t});if(r.roomEncryptors.set(n,c),s&&(yield s),l.v.log("Enabling encryption in ".concat(n)),e.membersLoaded())yield r.trackRoomDevicesImpl(e);else{var d=t=>{e.off(Yt.f.Update,d),e.membersLoaded()&&r.trackRoomDevicesImpl(e).catch((e=>{l.v.error("Error enabling device tracking in ".concat(n),e)}))};e.on(Yt.f.Update,d)}}}}else l.v.log("Ignoring setRoomEncryption with no algorithm")}))()}trackRoomDevices(e){var t=this.clientStore.getRoom(e);if(!t)throw new Error("Unable to start tracking devices in unknown room ".concat(e));return this.trackRoomDevicesImpl(t)}trackRoomDevicesImpl(e){var t=this,r=e.roomId,i=function(){var i=(0,n.A)((function*(){if(t.roomEncryptors.has(r)){l.v.log("Starting to track devices for room ".concat(r," ..."));var n=yield e.getEncryptionTargetMembers();n.forEach((e=>{t.deviceList.startTrackingDeviceList(e.userId)}))}}));return function(){return i.apply(this,arguments)}}(),o=this.roomDeviceTrackingState[r];return o||(o=i(),this.roomDeviceTrackingState[r]=o.catch((e=>{throw delete this.roomDeviceTrackingState[r],e}))),o}ensureOlmSessionsForUsers(e,t){var r=new Map;for(var n of e){var i=[];r.set(n,i);var o=this.getStoredDevicesForUser(n)||[];for(var s of o){var a=s.getIdentityKey();a!=this.olmDevice.deviceCurve25519Key&&(s.verified!=tr.BLOCKED&&i.push(s))}}return S.ensureOlmSessionsForDevices(this.olmDevice,this.baseApis,r,t)}exportRoomKeys(){var e=this;return(0,n.A)((function*(){var t=[];return yield e.cryptoStore.doTxn("readonly",[d.y.STORE_INBOUND_GROUP_SESSIONS],(r=>{e.cryptoStore.getAllEndToEndInboundGroupSessions(r,(r=>{if(null!==r){var n=e.olmDevice.exportInboundGroupSession(r.senderKey,r.sessionId,r.sessionData);delete n.first_known_index,n.algorithm=S.MEGOLM_ALGORITHM,t.push(n)}}))})),t}))()}exportRoomKeysAsJson(){var e=this;return(0,n.A)((function*(){return JSON.stringify(yield e.exportRoomKeys())}))()}importRoomKeys(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=0,n=0,i=e.length;function o(){var e;null===(e=t.progressCallback)||void 0===e||e.call(t,{stage:"load_keys",successes:r,failures:n,total:i})}return Promise.all(e.map((e=>{if(!e.room_id||!e.algorithm)return l.v.warn("ignoring room key entry with missing fields",e),n++,t.progressCallback&&o(),null;var i=this.getRoomDecryptor(e.room_id,e.algorithm);return i.importRoomKey(e,t).finally((()=>{r++,t.progressCallback&&o()}))}))).then()}importRoomKeysAsJson(e,t){var r=this;return(0,n.A)((function*(){return yield r.importRoomKeys(JSON.parse(e))}))()}countSessionsNeedingBackup(){return this.backupManager.countSessionsNeedingBackup()}prepareToEncrypt(e){var t=this.roomEncryptors.get(e.roomId);t&&t.prepareToEncrypt(e)}encryptEvent(e,t){var r=this;return(0,n.A)((function*(){var n=e.getRoomId(),i=r.roomEncryptors.get(n);if(!i)throw new Error("Room "+n+" was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");yield r.trackRoomDevicesImpl(t);var o=e.getContent(),s=o["m.relates_to"];s&&(o=Object.assign({},o),delete o["m.relates_to"]);var a=o["io.element.performance_metrics"];a&&(o=Object.assign({},o),delete o["io.element.performance_metrics"]);var c=yield i.encryptMessage(t,e.getType(),o);s&&(c["m.relates_to"]=s),a&&(c["io.element.performance_metrics"]=a),e.makeEncrypted("m.room.encrypted",c,r.olmDevice.deviceCurve25519Key,r.olmDevice.deviceEd25519Key)}))()}decryptEvent(e){var t=this;return(0,n.A)((function*(){if(e.isRedacted()){var r=new ve.kl(er({room_id:e.getRoomId()},e.getUnsigned().redacted_because)),n=e.getUnsigned().redacted_because;if(r.isEncrypted())try{var i=yield t.decryptEvent(r);n=i.clearEvent}catch(a){l.v.warn("Decryption of redaction failed. Falling back to unencrypted event.",a)}return{clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n}}}}var o=e.getWireContent(),s=t.getRoomDecryptor(e.getRoomId(),o.algorithm);return s.decryptEvent(e)}))()}processDeviceLists(e){var t=this;return(0,n.A)((function*(){yield t.evalDeviceListChanges(e)}))()}requestRoomKey(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,r).then((()=>{this.sendKeyRequestsImmediately&&this.outgoingRoomKeyRequestManager.sendQueuedRequests()})).catch((e=>{l.v.error("Error requesting key for event",e)}))}cancelRoomKeyRequest(e){this.outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((e=>{l.v.warn("Error clearing pending room key requests",e)}))}cancelAndResendAllOutgoingKeyRequests(){var e=this;return(0,n.A)((function*(){yield e.outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()}))()}onCryptoEvent(e,t){var r=this;return(0,n.A)((function*(){var n=t.getContent();yield r.setRoomEncryptionImpl(e,n)}))()}onSyncWillProcess(e){var t=this;return(0,n.A)((function*(){e.oldSyncToken||(l.v.log("Initial sync performed - resetting device tracking state"),t.deviceList.stopTrackingAllDeviceLists(),t.deviceList.startTrackingDeviceList(t.userId),t.roomDeviceTrackingState={}),t.sendKeyRequestsImmediately=!1}))()}onSyncCompleted(e){var t=this;return(0,n.A)((function*(){var r;t.deviceList.setSyncToken(null!==(r=e.nextSyncToken)&&void 0!==r?r:null),t.deviceList.saveIfDirty(),t.deviceList.startTrackingDeviceList(t.userId),t.deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(t.maybeUploadOneTimeKeys(),t.processReceivedRoomKeyRequests(),t.outgoingRoomKeyRequestManager.sendQueuedRequests(),t.sendKeyRequestsImmediately=!0)}))()}evalDeviceListChanges(e){var t=this;return(0,n.A)((function*(){if(Array.isArray(null===e||void 0===e?void 0:e.changed)&&e.changed.forEach((e=>{t.deviceList.invalidateUserDeviceList(e)})),Array.isArray(null===e||void 0===e?void 0:e.left)&&e.left.length){var r=new Set(yield t.getTrackedE2eUsers());e.left.forEach((e=>{r.has(e)||t.deviceList.stopTrackingDeviceList(e)}))}}))()}getTrackedE2eUsers(){var e=this;return(0,n.A)((function*(){var t=[];for(var r of e.getTrackedE2eRooms()){var n=yield r.getEncryptionTargetMembers();for(var i of n)t.push(i.userId)}return t}))()}getTrackedE2eRooms(){return this.clientStore.getRooms().filter((e=>{var t=this.roomEncryptors.get(e.roomId);if(!t)return!1;if(!this.roomDeviceTrackingState[e.roomId])return!1;var r=e.getMyMembership();return r===ie.O.Join||r===ie.O.Invite}))}encryptAndSendToDevices(e,t){var r=this;return(0,n.A)((function*(){try{var n=yield r.prepareToDeviceBatch(e,t);try{yield r.baseApis.queueToDevice(n)}catch(i){throw l.v.error("sendToDevice failed",i),i}}catch(i){throw l.v.error("encryptAndSendToDevices promises failed",i),i}}))()}prepareToDeviceBatch(e,t){var r=this;return(0,n.A)((function*(){var i={eventType:a.Bx.RoomMessageEncrypted,batch:[]};return yield Promise.all(e.map(function(){var e=(0,n.A)((function*(e){var{userId:n,deviceInfo:o}=e,c=o.deviceId,l={algorithm:S.OLM_ALGORITHM,sender_key:r.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,s.A)()};i.batch.push({userId:n,deviceId:c,payload:l}),yield S.ensureOlmSessionsForDevices(r.olmDevice,r.baseApis,new Map([[n,[o]]])),yield S.encryptMessageForDevice(l.ciphertext,r.userId,r.deviceId,r.olmDevice,n,o,t)}));return function(t){return e.apply(this,arguments)}}())),i.batch=i.batch.filter((e=>Object.keys(e.payload.ciphertext).length>0||(l.v.log("No ciphertext for device ".concat(e.userId,":").concat(e.deviceId,": pruning")),!1))),i}))()}encryptToDeviceMessages(e,t,r){var i=this;return(0,n.A)((function*(){var e=new Set(t.map((e=>{var{userId:t}=e;return t}))),n=yield i.downloadKeys(Array.from(e),!1),o=[];return t.forEach((e=>{var{userId:t,deviceId:r}=e,i=n.get(t);i?i.has(r)?o.push({userId:t,deviceInfo:i.get(r)}):l.v.warn("No device found for user ".concat(t," with id ").concat(r)):l.v.warn("No devices found for user ".concat(t))})),i.prepareToDeviceBatch(o,r)}))()}preprocessToDeviceMessages(e){return(0,n.A)((function*(){return e.filter((e=>{var t;return!(e.type===a.Bx.RoomMessageEncrypted&&!["m.olm.v1.curve25519-aes-sha2"].includes(null===(t=e.content)||void 0===t?void 0:t.algorithm))||(l.v.log("Ignoring invalid encrypted to-device event from "+e.sender),!1)}))}))()}updateOneTimeKeyCount(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this.oneTimeKeyCount=e}processKeyCounts(e,t){return void 0!==e&&this.updateOneTimeKeyCount(e["signed_curve25519"]||0),void 0!==t&&(this.needsNewFallback=!t.includes("signed_curve25519")),Promise.resolve()}onRoomKeyEvent(e){var t=e.getContent();if(t.room_id&&t.algorithm){this.backupManager.checkedForBackup||this.backupManager.checkAndStart();var r=this.getRoomDecryptor(t.room_id,t.algorithm);r.onRoomKeyEvent(e)}else l.v.error("key event is missing fields")}onRoomKeyWithheldEvent(e){var t=e.getContent();if(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key){l.v.info("Got room key withheld event from ".concat(e.getSender()," ")+"for ".concat(t.algorithm," session ").concat(t.sender_key,"|").concat(t.session_id," ")+"in room ".concat(t.room_id," with code ").concat(t.code," (").concat(t.reason,")"));var r=this.getRoomDecryptor(t.room_id,t.algorithm);if(r.onRoomKeyWithheldEvent&&r.onRoomKeyWithheldEvent(e),!t.room_id){var n=this.getRoomDecryptors(t.algorithm);for(var i of n)i.retryDecryptionFromSender(t.sender_key)}}else l.v.error("key withheld event is missing fields")}onKeyVerificationMessage(e){if(jt.validateEvent(e,this.baseApis)){var t=e=>{if(jt.canCreateRequest(jt.getEventType(e))){var t=e.getContent(),r=t&&t.from_device;if(r){var n=e.getSender(),i=new jt(this.baseApis,n,[r]);return new xt(i,this.verificationMethods,this.baseApis)}}};this.handleVerificationEvent(e,this.toDeviceVerificationRequests,t)}}handleVerificationEvent(e,t,r){var i=arguments,o=this;return(0,n.A)((function*(){var n,s,a=!(i.length>3&&void 0!==i[3])||i[3];if(e.isSending()&&e.status!=ve.fb.SENT)try{yield new Promise(((t,r)=>{n=t,s=()=>{e.status==ve.fb.CANCELLED&&r(new Error("Event status set to CANCELLED."))},e.once(ve.OQ.LocalEventIdReplaced,n),e.on(ve.OQ.Status,s)}))}catch(h){return void l.v.error("error while waiting for the verification event to be sent: ",h)}finally{e.removeListener(ve.OQ.LocalEventIdReplaced,n),e.removeListener(ve.OQ.Status,s)}var c=t.getRequest(e),d=!1;if(!c){if(c=r(e),!c)return void l.v.log("Crypto: could not find VerificationRequest for "+"".concat(e.getType(),", and could not create one, so ignoring."));d=!0,t.setRequest(e,c)}e.setVerificationRequest(c);try{yield c.channel.handleEvent(e,c,a)}catch(h){l.v.error("error while handling verification event",h)}var u=d&&!c.initiatedByMe&&!c.invalid&&!c.observeOnly;u&&(o.baseApis.emit(sr.VerificationRequest,c),o.baseApis.emit(sr.VerificationRequestReceived,c))}))()}onToDeviceBadEncrypted(e){var t=this;return(0,n.A)((function*(){var r=e.getWireContent(),n=e.getSender(),i=r.algorithm,o=r.sender_key;t.baseApis.emit(fe.AU.UndecryptableToDeviceEvent,e);var c=()=>{var e=t.getRoomDecryptors(S.MEGOLM_ALGORITHM);for(var r of e)r.retryDecryptionFromSender(o)};if(void 0!==n&&void 0!==o&&void 0!==o){var d=t.forceNewSessionRetryTime.getOrCreate(n),u=d.getOrCreate(o);if(u>Date.now())return l.v.debug("New session already forced with device ".concat(n,":").concat(o,": ")+"not forcing another until at least ".concat(new Date(u).toUTCString())),yield t.olmDevice.recordSessionProblem(o,"wedged",!0),void c();d.set(o,Date.now()+or);var h=t.deviceList.getDeviceByIdentityKey(i,o);if(!h&&(yield t.downloadKeys([n],!1),h=t.deviceList.getDeviceByIdentityKey(i,o),!h))return l.v.info("Couldn't find device for identity key "+o+": not re-establishing session"),yield t.olmDevice.recordSessionProblem(o,"wedged",!1),void c();var v=new Map([[n,[h]]]);yield S.ensureOlmSessionsForDevices(t.olmDevice,t.baseApis,v,!0),d.set(o,Date.now()+ir);var p={algorithm:S.OLM_ALGORITHM,sender_key:t.olmDevice.deviceCurve25519Key,ciphertext:{},[a.wt]:(0,s.A)()};yield S.encryptMessageForDevice(p.ciphertext,t.userId,t.deviceId,t.olmDevice,n,h,{type:"m.dummy"}),yield t.olmDevice.recordSessionProblem(o,"wedged",!0),c(),yield t.baseApis.sendToDevice("m.room.encrypted",new Map([[n,new Map([[h.deviceId,p]])]]));var f=yield t.outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,h.deviceId);for(var g of f)t.requestRoomKey(g.requestBody,g.recipients,!0)}}))()}onRoomMembership(e,t,r){var n=t.roomId,i=this.roomEncryptors.get(n);if(i){var o;if(n in this.roomDeviceTrackingState)t.membership==ie.O.Join?(l.v.log("Join event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId)):t.membership==ie.O.Invite&&null!==(o=this.clientStore.getRoom(n))&&void 0!==o&&o.shouldEncryptForInvitedMembers()&&(l.v.log("Invite event for "+t.userId+" in "+n),this.deviceList.startTrackingDeviceList(t.userId));i.onRoomMembership(e,t,r)}}onRoomKeyRequestEvent(e){var t=e.getContent();if("request"===t.action){var r=new lr(e);this.receivedRoomKeyRequests.push(r)}else if("request_cancellation"===t.action){var n=new dr(e);this.receivedRoomKeyRequestCancellations.push(n)}}processReceivedRoomKeyRequests(){var e=this;return(0,n.A)((function*(){if(!e.processingRoomKeyRequests){e.processingRoomKeyRequests=!0;try{var t=e.receivedRoomKeyRequests;e.receivedRoomKeyRequests=[];var r=e.receivedRoomKeyRequestCancellations;e.receivedRoomKeyRequestCancellations=[],yield Promise.all(t.map((t=>e.processReceivedRoomKeyRequest(t)))),yield Promise.all(r.map((t=>e.processReceivedRoomKeyRequestCancellation(t))))}catch(n){l.v.error("Error processing room key requsts: ".concat(n))}finally{e.processingRoomKeyRequests=!1}}}))()}processReceivedRoomKeyRequest(e){var t=this;return(0,n.A)((function*(){var r=e.userId,n=e.deviceId,i=e.requestBody,o=i.room_id,s=i.algorithm;if(l.v.log("m.room_key_request from ".concat(r,":").concat(n)+" for ".concat(o," / ").concat(i.session_id," (id ").concat(e.requestId,")")),r===t.userId)if(n!==t.deviceId)if(t.roomDecryptors.has(o)){var a=t.roomDecryptors.get(o).get(s);if(a)if(yield a.hasKeysForKeyRequest(e)){if(e.share=()=>{a.shareKeysWithDevice(e)},t.checkDeviceTrust(r,n).isVerified())return l.v.log("device is already verified: sharing keys"),void e.share();t.emit(sr.RoomKeyRequest,e)}else l.v.log("room key request for unknown session ".concat(o," / ")+i.session_id);else l.v.log("room key request for unknown alg ".concat(s," in room ").concat(o))}else l.v.log("room key request for unencrypted room ".concat(o));else l.v.log("Ignoring room key request from ourselves");else{if(!t.roomEncryptors.get(o))return void l.v.debug("room key request for unencrypted room ".concat(o));var c=t.roomEncryptors.get(o),d=t.deviceList.getStoredDevice(r,n);if(!d)return void l.v.debug("Ignoring keyshare for unknown device ".concat(r,":").concat(n));try{yield c.reshareKeyWithDevice(i.sender_key,i.session_id,r,d)}catch(u){l.v.warn("Failed to re-share keys for session "+i.session_id+" with device "+r+":"+d.deviceId,u)}}}))()}processReceivedRoomKeyRequestCancellation(e){var t=this;return(0,n.A)((function*(){l.v.log("m.room_key_request cancellation for ".concat(e.userId,":")+"".concat(e.deviceId," (id ").concat(e.requestId,")")),t.emit(sr.RoomKeyRequestCancellation,e)}))()}getRoomDecryptor(e,t){var r,n;if(e&&(r=this.roomDecryptors.get(e),r||(r=new Map,this.roomDecryptors.set(e,r)),n=r.get(t),n))return n;var i=V.get(t);if(!i)throw new h.O(u.DecryptionFailureCode.UNKNOWN_ENCRYPTION_ALGORITHM,'Unknown encryption algorithm "'+t+'".');return n=new i({userId:this.userId,crypto:this,olmDevice:this.olmDevice,baseApis:this.baseApis,roomId:null!==e&&void 0!==e?e:void 0}),r&&r.set(t,n),n}getRoomDecryptors(e){var t=[];for(var r of this.roomDecryptors.values())r.has(e)&&t.push(r.get(e));return t}signObject(e){var t=this;return(0,n.A)((function*(){var r=new Map(Object.entries(e.signatures||{})),n=e.unsigned;delete e.signatures,delete e.unsigned;var i=r.get(t.userId)||{};r.set(t.userId,i),i["ed25519:"+t.deviceId]=yield t.olmDevice.sign(o.stringify(e)),e.signatures=(0,P.HF)(r),void 0!==n&&(e.unsigned=n)}))()}isRoomEncrypted(e){return this.roomList.isRoomEncrypted(e)}isEncryptionEnabledInRoom(e){var t=this;return(0,n.A)((function*(){return t.isRoomEncrypted(e)}))()}getRoomEncryption(e){return this.roomList.getRoomEncryption(e)}isDehydrationSupported(){return(0,n.A)((function*(){return!1}))()}startDehydration(e){return(0,n.A)((function*(){throw new Error("Not implemented")}))()}restoreKeyBackup(e){throw new Error("Not implemented")}restoreKeyBackupWithPassphrase(e,t){throw new Error("Not implemented")}resetEncryption(){throw new Error("Not implemented")}}function cr(e){if("string"!==typeof e||e.indexOf(",")<0)return null;var t=Uint8Array.from(e.split(","),(e=>parseInt(e)));return(0,E.WG)(t)}class lr{constructor(e){(0,i.A)(this,"userId",void 0),(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"requestId",void 0),(0,i.A)(this,"requestBody",void 0),(0,i.A)(this,"share",void 0);var t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id,this.requestBody=t.body||{},this.share=()=>{throw new Error("don't know how to share keys for this request yet")}}}class dr{constructor(e){(0,i.A)(this,"userId",void 0),(0,i.A)(this,"deviceId",void 0),(0,i.A)(this,"requestId",void 0);var t=e.getContent();this.userId=e.getSender(),this.deviceId=t.requesting_device_id,this.requestId=t.request_id}}},3571:function(e,t,r){"use strict";r.d(t,{A:function(){return s}});r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);var n=r(698),i=r(944),o=r(8772);function s(e,t,r,n){return a.apply(this,arguments)}function a(){return a=(0,n.A)((function*(e,t,r,n){var s;n?s=(0,i.y4)(n):(s=new Uint8Array(16),globalThis.crypto.getRandomValues(s),s[8]&=127);var[a,c]=yield(0,o.C)(t,r),l=(new TextEncoder).encode(e),d=yield globalThis.crypto.subtle.encrypt({name:"AES-CTR",counter:s,length:64},a,l),u=yield globalThis.crypto.subtle.sign({name:"HMAC"},c,d);return{iv:(0,i.WG)(s),ciphertext:(0,i.WG)(new Uint8Array(d)),mac:(0,i.WG)(new Uint8Array(u))}})),a.apply(this,arguments)}},3579:function(e,t,r){"use strict";var n=r(6518),i=r(2652),o=r(9306),s=r(8551),a=r(1767);n({target:"Iterator",proto:!0,real:!0},{some:function(e){s(this),o(e);var t=a(this),r=0;return i(t,(function(t,n){if(e(t,r++))return n()}),{IS_RECORD:!0,INTERRUPTED:!0}).stopped}})},3650:function(e,t,r){"use strict";var n=r(7080),i=r(4402),o=r(9286),s=r(3789),a=r(507),c=i.add,l=i.has,d=i.remove;e.exports=function(e){var t=n(this),r=s(e).getIterator(),i=o(t);return a(r,(function(e){l(t,e)?d(i,e):c(i,e)})),i}},3706:function(e,t,r){"use strict";var n=r(9504),i=r(4901),o=r(7629),s=n(Function.toString);i(o.inspectSource)||(o.inspectSource=function(e){return s(e)}),e.exports=o.inspectSource},3717:function(e,t){"use strict";t.f=Object.getOwnPropertySymbols},3723:function(e,t,r){"use strict";r.d(t,{V:function(){return o}});var n=r(4761),i=r(4178);class o{static fromStorage(e,t){var r=new o(t);for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}constructor(e){this.deviceId=e,(0,n.A)(this,"algorithms",[]),(0,n.A)(this,"keys",{}),(0,n.A)(this,"verified",i.u.Unverified),(0,n.A)(this,"known",!1),(0,n.A)(this,"unsigned",{}),(0,n.A)(this,"signatures",{})}toStorage(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}}getFingerprint(){return this.keys["ed25519:"+this.deviceId]}getIdentityKey(){return this.keys["curve25519:"+this.deviceId]}getDisplayName(){return this.unsigned.device_display_name||null}isBlocked(){return this.verified==i.u.Blocked}isVerified(){return this.verified==i.u.Verified}isUnverified(){return this.verified==i.u.Unverified}isKnown(){return!0===this.known}}(0,n.A)(o,"DeviceVerification",{VERIFIED:i.u.Verified,UNVERIFIED:i.u.Unverified,BLOCKED:i.u.Blocked})},3724:function(e,t,r){"use strict";var n=r(9039);e.exports=!n((function(){return 7!==Object.defineProperty({},1,{get:function(){return 7}})[1]}))},3751:function(e,t,r){"use strict";r(4114),r(8111),r(2489),r(7588),Object.defineProperty(t,"__esModule",{value:!0}),t.LEGACY_M_ROOM_MESSAGE=void 0,t.parseMRoomMessage=h;var n=r(4477),i=r(1550),o=r(1396),s=r(6288),a=r(1711);function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){d(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function d(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var u=new s.NamespacedValue("m.room.message");function h(e){var t,r,s;if(a.M_MESSAGE.findIn(e.content)||a.M_TEXT.findIn(e.content))return new n.MessageEvent(e);var c,u,h,v=null===(t=e.content)||void 0===t?void 0:t.msgtype,p=null===(r=e.content)||void 0===r?void 0:r.body,f="org.matrix.custom.html"===(null===(s=e.content)||void 0===s?void 0:s.format)?e.content.formatted_body:null;return"m.text"===v?new n.MessageEvent(l(l({},e),{},{content:l(l({},e.content),{},(c={},d(c,a.M_TEXT.name,p),d(c,a.M_HTML.name,f),c))})):"m.notice"===v?new i.NoticeEvent(l(l({},e),{},{content:l(l({},e.content),{},(u={},d(u,a.M_TEXT.name,p),d(u,a.M_HTML.name,f),u))})):"m.emote"===v?new o.EmoteEvent(l(l({},e),{},{content:l(l({},e.content),{},(h={},d(h,a.M_TEXT.name,p),d(h,a.M_HTML.name,f),h))})):null}t.LEGACY_M_ROOM_MESSAGE=u},3789:function(e,t,r){"use strict";var n=r(9306),i=r(8551),o=r(9565),s=r(1291),a=r(1767),c="Invalid size",l=RangeError,d=TypeError,u=Math.max,h=function(e,t){this.set=e,this.size=u(t,0),this.has=n(e.has),this.keys=n(e.keys)};h.prototype={getIterator:function(){return a(i(o(this.keys,this.set)))},includes:function(e){return o(this.has,this.set,e)}},e.exports=function(e){i(e);var t=+e.size;if(t!==t)throw new d(c);var r=s(t);if(r<0)throw new l(c);return new h(e,r)}},3794:function(e,t){"use strict";var r=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,n=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,i=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,o=/\\([\u000b\u0020-\u00ff])/g,s=/([\\"])/g,a=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;
/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */function c(e){if(!e||"object"!==typeof e)throw new TypeError("argument obj is required");var t=e.parameters,r=e.type;if(!r||!a.test(r))throw new TypeError("invalid type");var n=r;if(t&&"object"===typeof t)for(var o,s=Object.keys(t).sort(),c=0;c<s.length;c++){if(o=s[c],!i.test(o))throw new TypeError("invalid parameter name");n+="; "+o+"="+u(t[o])}return n}function l(e){if(!e)throw new TypeError("argument string is required");var t="object"===typeof e?d(e):e;if("string"!==typeof t)throw new TypeError("argument string is required to be a string");var n=t.indexOf(";"),i=-1!==n?t.slice(0,n).trim():t.trim();if(!a.test(i))throw new TypeError("invalid media type");var s=new h(i.toLowerCase());if(-1!==n){var c,l,u;r.lastIndex=n;while(l=r.exec(t)){if(l.index!==n)throw new TypeError("invalid parameter format");n+=l[0].length,c=l[1].toLowerCase(),u=l[2],34===u.charCodeAt(0)&&(u=u.slice(1,-1),-1!==u.indexOf("\\")&&(u=u.replace(o,"$1"))),s.parameters[c]=u}if(n!==t.length)throw new TypeError("invalid parameter format")}return s}function d(e){var t;if("function"===typeof e.getHeader?t=e.getHeader("content-type"):"object"===typeof e.headers&&(t=e.headers&&e.headers["content-type"]),"string"!==typeof t)throw new TypeError("content-type header is missing from object");return t}function u(e){var t=String(e);if(i.test(t))return t;if(t.length>0&&!n.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(s,"\\$1")+'"'}function h(e){this.parameters=Object.create(null),this.type=e}t.q=l},3838:function(e,t,r){"use strict";var n=r(7080),i=r(5170),o=r(8469),s=r(3789);e.exports=function(e){var t=n(this),r=s(e);return!(i(t)>r.size)&&!1!==o(t,(function(e){if(!r.includes(e))return!1}),!0)}},3853:function(e,t,r){"use strict";var n=r(6518),i=r(4449),o=r(4916),s=!o("isDisjointFrom",(function(e){return!e}));n({target:"Set",proto:!0,real:!0,forced:s},{isDisjointFrom:i})},3877:function(e,t,r){"use strict";r.d(t,{O:function(){return n}});var n=function(e){return e["Ban"]="ban",e["Invite"]="invite",e["Join"]="join",e["Knock"]="knock",e["Leave"]="leave",e}({})},3908:function(e,t,r){function n(e,t){"boolean"===typeof t&&(t={forever:t}),this._originalTimeouts=JSON.parse(JSON.stringify(e)),this._timeouts=e,this._options=t||{},this._maxRetryTime=t&&t.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}r(4114),e.exports=n,n.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)},n.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null},n.prototype.retry=function(e){if(this._timeout&&clearTimeout(this._timeout),!e)return!1;var t=(new Date).getTime();if(e&&t-this._operationStart>=this._maxRetryTime)return this._errors.push(e),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(e);var r=this._timeouts.shift();if(void 0===r){if(!this._cachedTimeouts)return!1;this._errors.splice(0,this._errors.length-1),r=this._cachedTimeouts.slice(-1)}var n=this;return this._timer=setTimeout((function(){n._attempts++,n._operationTimeoutCb&&(n._timeout=setTimeout((function(){n._operationTimeoutCb(n._attempts)}),n._operationTimeout),n._options.unref&&n._timeout.unref()),n._fn(n._attempts)}),r),this._options.unref&&this._timer.unref(),!0},n.prototype.attempt=function(e,t){this._fn=e,t&&(t.timeout&&(this._operationTimeout=t.timeout),t.cb&&(this._operationTimeoutCb=t.cb));var r=this;this._operationTimeoutCb&&(this._timeout=setTimeout((function(){r._operationTimeoutCb()}),r._operationTimeout)),this._operationStart=(new Date).getTime(),this._fn(this._attempts)},n.prototype.try=function(e){console.log("Using RetryOperation.try() is deprecated"),this.attempt(e)},n.prototype.start=function(e){console.log("Using RetryOperation.start() is deprecated"),this.attempt(e)},n.prototype.start=n.prototype.try,n.prototype.errors=function(){return this._errors},n.prototype.attempts=function(){return this._attempts},n.prototype.mainError=function(){if(0===this._errors.length)return null;for(var e={},t=null,r=0,n=0;n<this._errors.length;n++){var i=this._errors[n],o=i.message,s=(e[o]||0)+1;e[o]=s,s>=r&&(t=i,r=s)}return t}},3925:function(e,t,r){"use strict";var n=r(34);e.exports=function(e){return n(e)||null===e}},4055:function(e,t,r){"use strict";var n=r(4576),i=r(34),o=n.document,s=i(o)&&i(o.createElement);e.exports=function(e){return s?o.createElement(e):{}}},4108:function(e,t,r){"use strict";r.d(t,{Kn:function(){return et},AU:function(){return ut},hx:function(){return it},pB:function(){return vt},eO:function(){return nt},NB:function(){return st},A0:function(){return at},uD:function(){return ot},HF:function(){return rt},jB:function(){return lt},rG:function(){return ct},mD:function(){return ft},fN:function(){return mt},Xb:function(){return gt}});r(4114),r(6573),r(8100),r(7936),r(8111),r(2489),r(116),r(7588),r(1701),r(8237),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698),r(7467),r(4732),r(9577),r(4603),r(7566),r(8721);function n(e,t){if(null==e)return{};var r={};for(var n in e)if({}.hasOwnProperty.call(e,n)){if(-1!==t.indexOf(n))continue;r[n]=e[n]}return r}function i(e,t){if(null==e)return{};var r,i,o=n(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(i=0;i<s.length;i++)r=s[i],-1===t.indexOf(r)&&{}.propertyIsEnumerable.call(e,r)&&(o[r]=e[r])}return o}var o=r(698),s=r(4761),a=r(1212),c=r(3178);class l{constructor(){(0,s.A)(this,"accountData",new Map),(0,s.A)(this,"fromToken",null)}isNewlyCreated(){return Promise.resolve(!0)}getSyncToken(){return this.fromToken}setSyncToken(e){this.fromToken=e}storeRoom(e){}getRoom(e){return null}getRooms(){return[]}removeRoom(e){}getRoomSummaries(){return[]}storeUser(e){}getUser(e){return null}getUsers(){return[]}scrollback(e,t){return[]}setUserCreator(e){}storeEvents(e,t,r,n){}storeFilter(e){}getFilter(e,t){return null}getFilterIdByName(e){return null}setFilterIdByName(e,t){}storeAccountDataEvents(e){}getAccountData(e){}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return Promise.resolve()}getOutOfBandMembers(){return Promise.resolve(null)}setOutOfBandMembers(e,t){return Promise.resolve()}clearOutOfBandMembers(){return Promise.resolve()}getClientOptions(){return Promise.resolve(void 0)}storeClientOptions(e){return Promise.resolve()}getPendingEvents(e){return(0,o.A)((function*(){return[]}))()}setPendingEvents(e,t){return Promise.resolve()}saveToDeviceBatches(e){return(0,o.A)((function*(){return Promise.resolve()}))()}getOldestToDeviceBatch(){return Promise.resolve(null)}removeToDeviceBatch(e){return(0,o.A)((function*(){return Promise.resolve()}))()}destroy(){return(0,o.A)((function*(){}))()}}var d=r(3061),u=r(6483),h=r(9377),v=r(6330),p=r(6170),f=r(2292),g=(r(3579),r(3271)),m=r(9898),y=r(5629);function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach((function(t){(0,s.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var E=[m.Ji.Override,m.Ji.ContentSpecific,m.Ji.RoomSpecific,m.Ji.SenderSpecific,m.Ji.Underride],_={".m.rule.is_room_mention":{rule_id:".m.rule.is_room_mention",default:!0,enabled:!0,conditions:[{kind:m.wp.EventPropertyIs,key:"content.m\\.mentions.room",value:!0},{kind:m.wp.SenderNotificationPermission,key:"room"}],actions:[m.YU.Notify,{set_tweak:m.QN.Highlight}]},".m.rule.reaction":{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:m.wp.EventMatch,key:"type",pattern:"m.reaction"}],actions:[m.YU.DontNotify]},".org.matrix.msc3786.rule.room.server_acl":{rule_id:".org.matrix.msc3786.rule.room.server_acl",default:!0,enabled:!0,conditions:[{kind:m.wp.EventMatch,key:"type",pattern:y.Bx.RoomServerAcl},{kind:m.wp.EventMatch,key:"state_key",pattern:""}],actions:[]}},w=Symbol("UserDefinedRules"),I=[m.kq.Master,w,m.kq.SuppressNotices,m.kq.InviteToSelf,m.kq.MemberEvent,m.kq.IsUserMention,m.kq.ContainsDisplayName,m.kq.IsRoomMention,m.kq.AtRoomNotification,m.kq.Tombstone,".m.rule.reaction",".m.rule.room.server_acl",".org.matrix.msc3786.rule.room.server_acl",".m.rule.suppress_edits"],T={".org.matrix.msc3914.rule.room.call":{rule_id:".org.matrix.msc3914.rule.room.call",default:!0,enabled:!0,conditions:[{kind:m.wp.EventMatch,key:"type",pattern:"org.matrix.msc3401.call"},{kind:m.wp.CallStarted}],actions:[m.YU.Notify,{set_tweak:m.QN.Sound,value:"default"}]}},R=[w,m.kq.IncomingCall,".org.matrix.msc3914.rule.room.call",m.kq.EncryptedDM,m.kq.DM,m.kq.Message,m.kq.EncryptedMessage];function k(e,t,r,n){var i=t.filter((e=>e.default)),o=t.filter((e=>!e.default));function s(t){t===w?c.push(...o):t in r?(g.v.warn("Adding default global ".concat(e," push rule ").concat(t)),c.push(r[t])):g.v.warn("Missing default global ".concat(e," push rule ").concat(t))}var a=0,c=[];for(var l of i){var d=n.indexOf(l.rule_id);if(-1!==d){while(d>a){var u=n[a];s(u),a+=1}c.push(l),a+=1}else c.push(l)}for(var h of n.slice(a))s(h);return c}class A{constructor(e){this.client=e,(0,s.A)(this,"parsedKeys",new Map)}static actionListToActionsObject(e){var t={notify:!1,tweaks:{}};for(var r of e)r===m.YU.Notify?t.notify=!0:"object"===typeof r&&(void 0===r.value&&(r.value=!0),t.tweaks[r.set_tweak]=r.value);return t}static rewriteDefaultRules(e){var t=JSON.parse(JSON.stringify(e));return t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]),t.global.underride||(t.global.underride=[]),t.global.override=k(m.Ji.Override,t.global.override,_,I),t.global.underride=k(m.Ji.Underride,t.global.underride,T,R),t}updateCachedPushRuleKeys(e){e||(e={}),e.global||(e.global={}),e.global.override||(e.global.override=[]),e.global.room||(e.global.room=[]),e.global.sender||(e.global.sender=[]),e.global.underride||(e.global.underride=[]);var t=new Set(this.parsedKeys.keys());for(var r of[e.global.override,e.global.room,e.global.sender,e.global.underride])for(var n of r)if(n.conditions)for(var i of n.conditions)i.kind===m.wp.EventMatch&&(t.delete(i.key),this.parsedKeys.set(i.key,A.partsForDottedKey(i.key)));t.forEach((e=>this.parsedKeys.delete(e)))}matchingRuleFromKindSet(e,t){for(var r of E){var n=t[r];if(n)for(var i of n)if(i.enabled){var o=this.templateRuleToRaw(r,i);if(o&&this.ruleMatchesEvent(o,e))return b(b({},i),{},{kind:r})}}return null}templateRuleToRaw(e,t){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case m.Ji.Underride:case m.Ji.Override:r.conditions=t.conditions;break;case m.Ji.RoomSpecific:if(!t.rule_id)return null;r.conditions.push({kind:m.wp.EventMatch,key:"room_id",value:t.rule_id});break;case m.Ji.SenderSpecific:if(!t.rule_id)return null;r.conditions.push({kind:m.wp.EventMatch,key:"user_id",value:t.rule_id});break;case m.Ji.ContentSpecific:if(!t.pattern)return null;r.conditions.push({kind:m.wp.EventMatch,key:"content.body",pattern:t.pattern});break}return r}eventFulfillsCondition(e,t){switch(e.kind){case m.wp.EventMatch:return this.eventFulfillsEventMatchCondition(e,t);case m.wp.EventPropertyIs:return this.eventFulfillsEventPropertyIsCondition(e,t);case m.wp.EventPropertyContains:return this.eventFulfillsEventPropertyContains(e,t);case m.wp.ContainsDisplayName:return this.eventFulfillsDisplayNameCondition(e,t);case m.wp.RoomMemberCount:return this.eventFulfillsRoomMemberCountCondition(e,t);case m.wp.SenderNotificationPermission:return this.eventFulfillsSenderNotifPermCondition(e,t);case m.wp.CallStarted:case m.wp.CallStartedPrefix:return this.eventFulfillsCallStartedCondition(e,t)}return!1}eventFulfillsSenderNotifPermCondition(e,t){var r=e["key"];if(!r)return!1;var n=this.client.getRoom(t.getRoomId());return!(null===n||void 0===n||!n.currentState)&&n.currentState.mayTriggerNotifOfType(r,t.getSender())}eventFulfillsRoomMemberCountCondition(e,t){if(!e.is)return!1;var r=this.client.getRoom(t.getRoomId());if(!r||!r.currentState||!r.currentState.members)return!1;var n=r.currentState.getJoinedMemberCount(),i=e.is.match(/^([=<>]*)(\d*)$/);if(!i)return!1;var o=i[1],s=parseInt(i[2]);if(isNaN(s))return!1;switch(o){case"":case"==":return n==s;case"<":return n<s;case">":return n>s;case"<=":return n<=s;case">=":return n>=s;default:return!1}}eventFulfillsDisplayNameCondition(e,t){var r,n=t.getContent();if(t.isEncrypted()&&t.getClearContent()&&(n=t.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;var i=this.client.getRoom(t.getRoomId()),o=null===i||void 0===i||null===(r=i.currentState)||void 0===r?void 0:r.getMember(this.client.credentials.userId);if(!o)return!1;var s=o.name,a=new RegExp("(^|\\W)"+(0,p.Nt)(s)+"(\\W|$)","i");return n.body.search(a)>-1}eventFulfillsEventMatchCondition(e,t){if(!e.key)return!1;var r=this.valueForDottedKey(e.key,t);if("string"!==typeof r)return!1;if(e.value)return e.value===r;if("string"!==typeof e.pattern)return!1;var n="content.body"===e.key?this.createCachedRegex("(^|\\W)",e.pattern,"(\\W|$)"):this.createCachedRegex("^",e.pattern,"$");return!!r.match(n)}eventFulfillsEventPropertyIsCondition(e,t){return!(!e.key||void 0===e.value)&&e.value===this.valueForDottedKey(e.key,t)}eventFulfillsEventPropertyContains(e,t){if(!e.key||void 0===e.value)return!1;var r=this.valueForDottedKey(e.key,t);return!!Array.isArray(r)&&r.includes(e.value)}eventFulfillsCallStartedCondition(e,t){return["m.ring","m.prompt"].includes(t.getContent()["m.intent"])&&!("m.terminated"in t.getContent())&&(t.getPrevContent()["m.terminated"]!==t.getContent()["m.terminated"]||(0,p.ky)(t.getPrevContent(),{}))}createCachedRegex(e,t,r){return A.cachedGlobToRegex[t]||(A.cachedGlobToRegex[t]=new RegExp(e+(0,p.dn)(t)+r,"i")),A.cachedGlobToRegex[t]}static partsForDottedKey(e){var t=[],r="",n=!1;for(var i of e)n?(r+="\\"===i||"."===i?i:"\\"+i,n=!1):"."==i?(t.push(r),r=""):"\\"==i?n=!0:r+=i;return n&&(r+="\\"),t.push(r),t}valueForDottedKey(e,t){var r,n=this.parsedKeys.get(e);void 0===n&&(n=A.partsForDottedKey(e),this.parsedKeys.set(e,n));var i=n[0],o=0;for("content"===i?(r=t.getContent(),++o):"type"===i?(r=t.getType(),++o):r=t.event;o<n.length;++o){if((0,p.hX)(r))return;var s=n[o];r=r[s]}return r}matchingRuleForEventWithRulesets(e,t){return t?e.getSender()===this.client.getSafeUserId()?null:this.matchingRuleFromKindSet(e,t.global):null}pushActionsForEventAndRulesets(e,t){var r=this.matchingRuleForEventWithRulesets(e,t);if(!r)return{};var n=A.actionListToActionsObject(r.actions);return void 0===n.tweaks.highlight&&(n.tweaks.highlight=r.kind==m.Ji.ContentSpecific),{actions:n,rule:r}}ruleMatchesEvent(e,t){var r;return(!this.client.supportsIntentionalMentions()||void 0===t.getContent()["m.mentions"]||e.rule_id!==m.kq.ContainsUserName&&e.rule_id!==m.kq.ContainsDisplayName&&e.rule_id!==m.kq.AtRoomNotification)&&!(null!==(r=e.conditions)&&void 0!==r&&r.some((e=>!this.eventFulfillsCondition(e,t))))}actionsForEvent(e){var{actions:t}=this.pushActionsForEventAndRulesets(e,this.client.pushRules);return t||{}}actionsAndRuleForEvent(e){return this.pushActionsForEventAndRulesets(e,this.client.pushRules)}getPushRuleById(e){var t,r=this.getPushRuleAndKindById(e);return null!==(t=null===r||void 0===r?void 0:r.rule)&&void 0!==t?t:null}getPushRuleAndKindById(e){for(var t of["global"]){var r;if(void 0!==(null===(r=this.client.pushRules)||void 0===r?void 0:r[t]))for(var n of E)if(void 0!==this.client.pushRules[t][n])for(var i of this.client.pushRules[t][n])if(i.rule_id===e)return{rule:i,kind:n}}return null}}(0,s.A)(A,"cachedGlobToRegex",{});var C=r(5315),O=r(944),D=r(5462),M=r(6508),P=r(9683),x=r(3562),U=r(1423),L=r(4279),N=r(3124),B=r(3530),K=r(309),F=r(806),j=r(8965),q=r(8058),V=r(3232);function G(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function W(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?G(Object(r),!0).forEach((function(t){(0,s.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):G(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function H(e,t){var r=Boolean(t.preventReEmit),n=!1!==t.decrypt;function i(o){t.toDevice&&delete o.room_id;var s,a=e.getRoom(o.room_id);a&&void 0===o.state_key&&(s=a.findEventById(o.event_id)),!s||s.status?s=new c.kl(o):(s.setUnsigned(W(W({},s.getUnsigned()),o.unsigned)),r=!0);var l=s.getServerAggregatedRelation(y.zZ.Replace);if(null!==l&&void 0!==l&&l.content){var d=i(l);s.makeReplaced(d)}var u=null===a||void 0===a?void 0:a.findThreadForEvent(s);return u&&s.setThread(u),s.isEncrypted()&&(r||e.reEmitter.reEmit(s,[c.OQ.Decrypted]),n&&e.decryptEventIfNeeded(s)),r||(e.reEmitter.reEmit(s,[c.OQ.Replaced,c.OQ.VisibilityChange]),null===a||void 0===a||a.reEmitter.reEmit(s,[c.OQ.BeforeRedaction])),s}return i}var $=r(9553),J=r(1327),z=(r(1148),r(8289));function Y(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Q(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Y(Object(r),!0).forEach((function(t){(0,s.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Y(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class X{constructor(e,t,r){this.client=e,this.indexEvent=t,this.directory=r}get id(){var e=this.indexEvent.getStateKey();if(!e)throw new Error("State key not found for branch");return e}get isActive(){return!0===this.indexEvent.getContent()["active"]}get version(){var e;return null!==(e=this.indexEvent.getContent()["version"])&&void 0!==e?e:1}get roomId(){return this.indexEvent.getRoomId()}delete(){var e=this;return(0,o.A)((function*(){yield e.client.sendStateEvent(e.roomId,y.iK.name,{},e.id),yield e.client.redactEvent(e.roomId,e.id);var t=(yield e.getVersionHistory())[1];t&&(yield t.delete())}))()}getName(){return this.indexEvent.getContent()["name"]||"Unnamed File"}setName(e){var t=this;return(0,o.A)((function*(){yield t.client.sendStateEvent(t.roomId,y.iK.name,Q(Q({},t.indexEvent.getContent()),{},{name:e}),t.id)}))()}isLocked(){return this.indexEvent.getContent()["locked"]||!1}setLocked(e){var t=this;return(0,o.A)((function*(){yield t.client.sendStateEvent(t.roomId,y.iK.name,Q(Q({},t.indexEvent.getContent()),{},{locked:e}),t.id)}))()}getFileInfo(){var e=this;return(0,o.A)((function*(){var t=yield e.getFileEvent(),r=t.getOriginalContent()["file"],n=e.client.mxcUrlToHttp(r["url"]);if(!n)throw new Error("No HTTP URL available for ".concat(r["url"]));return{info:r,httpUrl:n}}))()}getFileEvent(){var e=this;return(0,o.A)((function*(){var t=e.client.getRoom(e.roomId);if(!t)throw new Error("Unknown room");var r=t.getUnfilteredTimelineSet().findEventById(e.id);while(!r&&t.getLiveTimeline().getState(f.q.BACKWARDS).paginationToken)yield e.client.scrollback(t,100),r=t.getUnfilteredTimelineSet().findEventById(e.id);if(!r)throw new Error("Failed to find event");return yield e.client.decryptEventIfNeeded(r),r}))()}createNewVersion(e,t,r,n){var i=this;return(0,o.A)((function*(){var o=yield i.directory.createFile(e,t,r,Q(Q({},null!==n&&void 0!==n?n:{}),{},{"m.new_content":!0,"m.relates_to":{rel_type:y.zZ.Replace,event_id:i.id}}));return yield i.client.sendStateEvent(i.roomId,y.iK.name,{active:!0,name:e,version:i.version+1},o["event_id"]),yield i.client.sendStateEvent(i.roomId,y.iK.name,Q(Q({},i.indexEvent.getContent()),{},{active:!1}),i.id),o}))()}getVersionHistory(){var e=this;return(0,o.A)((function*(){var t=[];t.push(e);var r=e.client.getRoom(e.roomId);if(!r)throw new Error("Invalid or unknown room");var n,i=[...r.getLiveTimeline().getEvents()].reverse(),o=yield e.getFileEvent();do{if(n=i.find((e=>e.replacingEventId()===o.getId())),n){var s=e.directory.getFile(n.getId());if(!s)break;t.push(s),o=n}}while(n);return t}))()}}var Z=r(3877);function ee(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function te(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ee(Object(r),!0).forEach((function(t){(0,s.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ee(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var re={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[y.Bx.RoomPowerLevels]:100,[y.Bx.RoomHistoryVisibility]:100,[y.Bx.RoomTombstone]:100,[y.Bx.RoomEncryption]:100,[y.Bx.RoomName]:50,[y.Bx.RoomMessage]:50,[y.Bx.RoomMessageEncrypted]:50,[y.Bx.Sticker]:50},users:{}},ne=function(e){return e["Viewer"]="viewer",e["Editor"]="editor",e["Owner"]="owner",e}({});class ie{constructor(e,t){if(this.client=e,this.roomId=t,(0,s.A)(this,"room",void 0),this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){var e=this.room.currentState.getStateEvents(y.Bx.SpaceParent);return null===e||void 0===e||!e.length||e.every((e=>{var t;return!(null!==(t=e.getContent())&&void 0!==t&&t["via"])}))}setName(e){var t=this;return(0,o.A)((function*(){yield t.client.sendStateEvent(t.roomId,y.Bx.RoomName,{name:e},"")}))()}invite(e){var t=arguments,r=this;return(0,o.A)((function*(){var n=!(t.length>1&&void 0!==t[1])||t[1],i=[r.retryInvite(e)];n&&i.push(...r.getDirectories().map((t=>t.invite(e,n)))),yield Promise.all(i)}))()}retryInvite(e){var t=this;return(0,p.CC)((0,o.A)((function*(){yield t.client.invite(t.roomId,e).catch((e=>{if("M_FORBIDDEN"===(null===e||void 0===e?void 0:e.errcode))throw new z.AbortError(e);throw e}))})))}setPermissions(e,t){var r=this;return(0,o.A)((function*(){var n,i=r.room.currentState.getStateEvents(y.Bx.RoomPowerLevels,"");if(Array.isArray(i))throw new Error("Unexpected return type for power levels");var o=(null===i||void 0===i?void 0:i.getContent())||{},s=o["users_default"]||0,a=o["events_default"]||50,c=(null===(n=o["events"])||void 0===n?void 0:n[y.Bx.RoomPowerLevels])||100,l=o["users"]||{};switch(t){case ne.Viewer:l[e]=s;break;case ne.Editor:l[e]=a;break;case ne.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}o["users"]=l,yield r.client.sendStateEvent(r.roomId,y.Bx.RoomPowerLevels,o,"")}))()}getPermissions(e){var t,r,n=this.room.currentState.getStateEvents(y.Bx.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");var i=(null===n||void 0===n?void 0:n.getContent())||{},o=i["users_default"]||0,s=i["events_default"]||50,a=(null===(t=i["events"])||void 0===t?void 0:t[y.Bx.RoomPowerLevels])||100,c=(null===(r=i["users"])||void 0===r?void 0:r[e])||o;return c>=a?ne.Owner:c>=s?ne.Editor:ne.Viewer}createDirectory(e){var t=this;return(0,o.A)((function*(){var r=yield t.client.unstableCreateFileTree(e);return yield t.client.sendStateEvent(t.roomId,y.Bx.SpaceChild,{via:[t.client.getDomain()]},r.roomId),yield t.client.sendStateEvent(r.roomId,y.Bx.SpaceParent,{via:[t.client.getDomain()]},t.roomId),r}))()}getDirectories(){var e=[],t=this.room.currentState.getStateEvents(y.Bx.SpaceChild);for(var r of t)try{var n=r.getStateKey();if(n){var i=this.client.unstableGetFileTreeSpace(n);i&&e.push(i)}}catch(o){g.v.warn("Unable to create tree space instance for listing. Are we joined?",o)}return e}getDirectory(e){return this.getDirectories().find((t=>t.roomId===e))}delete(){var e=this;return(0,o.A)((function*(){var t=e.getDirectories();for(var r of t)yield r.delete();var n=[Z.O.Invite,Z.O.Knock,Z.O.Join],i=e.room.currentState.getStateEvents(y.Bx.RoomMember);for(var o of i){var s=o.getStateKey()!==e.client.getUserId();if(s&&n.includes(o.getContent().membership)){var a=o.getStateKey();if(!a)throw new Error("State key not found for branch");yield e.client.kick(e.roomId,a,"Room deleted")}}yield e.client.leave(e.roomId)}))()}getOrderedChildren(e){var t=e.map((e=>({roomId:e.getStateKey(),order:e.getContent()["order"]}))).filter((e=>e.roomId));return t.sort(((e,t)=>{if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return(0,p.aw)(e.order,t.order);var r,n,i,o,s=this.client.getRoom(e.roomId),a=this.client.getRoom(t.roomId);if(!s||!a)return(0,p.aw)(e.roomId,t.roomId);var c=null!==(r=null===(n=s.currentState.getStateEvents(y.Bx.RoomCreate,""))||void 0===n?void 0:n.getTs())&&void 0!==r?r:0,l=null!==(i=null===(o=a.currentState.getStateEvents(y.Bx.RoomCreate,""))||void 0===o?void 0:o.getTs())&&void 0!==i?i:0;return c===l?(0,p.aw)(e.roomId,t.roomId):c-l})),t}getParentRoom(){var e=this.room.currentState.getStateEvents(y.Bx.SpaceParent),t=e[0];if(!t)throw new Error("Expected to have a parent in a non-top level space");var r=t.getStateKey();if(!r)throw new Error("No state key found for parent");var n=this.client.getRoom(r);if(!n)throw new Error("Unable to locate room for parent");return n}getOrder(){if(this.isTopLevel)return-1;var e=this.getParentRoom(),t=e.currentState.getStateEvents(y.Bx.SpaceChild),r=this.getOrderedChildren(t);return r.findIndex((e=>e.roomId===this.roomId))}setOrder(e){var t=this;return(0,o.A)((function*(){var r;if(t.isTopLevel)throw new Error("Cannot set order of top level spaces currently");var n=t.getParentRoom(),i=n.currentState.getStateEvents(y.Bx.SpaceChild),o=t.getOrderedChildren(i);e=Math.max(Math.min(e,o.length-1),0);var s=t.getOrder(),a=s<e;a&&e===o.length-1?e--:a||0!==e||e++;var c=o[a?e:e-1],l=o[a?e+1:e],d=p.Mf[0],u=!1;if(c)if(e===o.length-1)null!==l&&void 0!==l&&l.order&&(d=(0,p.$9)(l.order));else{var h=null===c||void 0===c?void 0:c.order,v=null===l||void 0===l?void 0:l.order;h&&v?d=h===v?(0,p.$9)(h):(0,p.sy)(h,v):h?d=(0,p.$9)(h):v?d=(0,p.zR)(v):u=!0}else null!==l&&void 0!==l&&l.order&&(d=(0,p.zR)(l.order));if(u){for(var f,g=0;g<=e;g++){var m=o[g];if(0===g&&(f=m.order),m.order)f=m.order;else{var S;f=f?(0,p.$9)(f):p.Mf[0];var b=n.currentState.getStateEvents(y.Bx.SpaceChild,m.roomId),E=null!==(S=null===b||void 0===b?void 0:b.getContent())&&void 0!==S?S:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,y.Bx.SpaceChild,te(te({},E),{},{order:f}),m.roomId)}}f&&(d=(0,p.$9)(f))}var _=n.currentState.getStateEvents(y.Bx.SpaceChild,t.roomId),w=null!==(r=null===_||void 0===_?void 0:_.getContent())&&void 0!==r?r:{via:[t.client.getDomain()]};yield t.client.sendStateEvent(n.roomId,y.Bx.SpaceChild,te(te({},w),{},{order:d}),t.roomId)}))()}createFile(e,t,r,n){var i=this;return(0,o.A)((function*(){var o,{content_uri:s}=yield i.client.uploadContent(t,{includeFilename:!1});r.url=s;var a={msgtype:y.Wr.File,body:e,url:s,file:r};n=null!==(o=n)&&void 0!==o?o:{},n["m.new_content"]&&(n["m.new_content"]=a);var c=yield i.client.sendMessage(i.roomId,te(te(te({},n),a),{},{[y.ID.name]:{}}));return yield i.client.sendStateEvent(i.roomId,y.iK.name,{active:!0,name:e},c["event_id"]),c}))()}getFile(e){var t=this.room.currentState.getStateEvents(y.iK.name,e);return t?new X(this.client,t,this):null}listFiles(){return this.listAllFiles().filter((e=>e.isActive))}listAllFiles(){var e,t=null!==(e=this.room.currentState.getStateEvents(y.iK.name))&&void 0!==e?e:[];return t.map((e=>new X(this.client,e,this)))}}var oe=r(8161),se=r(4768),ae=r(1009),ce=r(2668),le=r(8645),de=r(4192),ue=r(7528),he=r(7621),ve=r(4229),pe=r(7738),fe=20;class ge{constructor(e){var t=this;this.client=e,(0,s.A)(this,"sending",!1),(0,s.A)(this,"running",!0),(0,s.A)(this,"retryTimeout",null),(0,s.A)(this,"retryAttempts",0),(0,s.A)(this,"sendQueue",(0,o.A)((function*(){if(null!==t.retryTimeout&&clearTimeout(t.retryTimeout),t.retryTimeout=null,!t.sending&&t.running){var e;g.v.debug("Attempting to send queued to-device messages"),t.sending=!0;try{while(t.running){if(e=yield t.client.store.getOldestToDeviceBatch(),null===e)break;yield t.sendBatch(e),yield t.client.store.removeToDeviceBatch(e.id),t.retryAttempts=0}if(!t.running)return;g.v.debug("All queued to-device messages sent")}catch(n){++t.retryAttempts;var r=pe.b.RETRY_BACKOFF_RATELIMIT(null,t.retryAttempts,n);if(-1===r)return void(4===Math.floor(n.httpStatus/100)?(g.v.error("Fatal error when sending to-device message - dropping to-device batch!",n),yield t.client.store.removeToDeviceBatch(e.id)):g.v.info("Automatic retry limit reached for to-device messages."));g.v.info("Failed to send batch of to-device messages. Will retry in ".concat(r,"ms"),n),t.retryTimeout=setTimeout(t.sendQueue,r)}finally{t.sending=!1}}}))),(0,s.A)(this,"onResumedSync",((e,t)=>{e===a.Lm.Syncing&&t!==a.Lm.Syncing&&(g.v.info("Resuming queue after resumed sync"),this.sendQueue())}))}start(){this.running=!0,this.sendQueue(),this.client.on(ut.Sync,this.onResumedSync)}stop(){this.running=!1,null!==this.retryTimeout&&clearTimeout(this.retryTimeout),this.retryTimeout=null,this.client.removeListener(ut.Sync,this.onResumedSync)}queueBatch(e){var t=this;return(0,o.A)((function*(){for(var r=[],n=0;n<e.batch.length;n+=fe){var i={eventType:e.eventType,batch:e.batch.slice(n,n+fe),txnId:t.client.makeTxnId()};r.push(i);var o=i.batch.map((e=>"".concat(e.userId,"/").concat(e.deviceId," (msgid ").concat(e.payload[y.wt],")")));g.v.info("Enqueuing batch of to-device messages. type=".concat(e.eventType," txnid=").concat(i.txnId),o)}yield t.client.store.saveToDeviceBatches(r),t.sendQueue()}))()}sendBatch(e){var t=this;return(0,o.A)((function*(){var r=new p.kG((()=>new Map));for(var n of e.batch)r.getOrCreate(n.userId).set(n.deviceId,n.payload);g.v.info("Sending batch of ".concat(e.batch.length," to-device messages with ID ").concat(e.id," and txnId ").concat(e.txnId)),yield t.client.sendToDevice(e.eventType,r,e.txnId)}))()}}var me=r(6337),ye={[me.Jo.User]:y.Bx.PolicyRuleUser,[me.Jo.Room]:y.Bx.PolicyRuleRoom,[me.Jo.Server]:y.Bx.PolicyRuleServer};class Se{constructor(e){this.client=e}addRule(e,t,r){var n=this;return(0,o.A)((function*(){var i=yield n.getOrCreateTargetRoom(),o=yield n.client.sendStateEvent(i.roomId,ye[e],{entity:t,reason:r,recommendation:me.Q5.Ban});return o.event_id}))()}removeRule(e){var t=this;return(0,o.A)((function*(){yield t.client.redactEvent(e.getRoomId(),e.getId())}))()}addSource(e){var t=this;return(0,o.A)((function*(){yield t.client.joinRoom(e);var r=(yield t.getOrCreateSourceRooms()).map((e=>e.roomId));return!r.includes(e)&&(r.push(e),yield t.withIgnoreInvitesPolicies((e=>{e.sources=r})),!0)}))()}getRuleForInvite(e){var t=this;return(0,o.A)((function*(){var{sender:r,roomId:n}=e,i=yield t.getOrCreateSourceRooms(),o=r.split(":")[1],s=n.split(":")[1];for(var a of i){var c=a.getUnfilteredTimelineSet().getLiveTimeline().getState(f.q.FORWARDS);for(var{scope:l,entities:d}of[{scope:me.Jo.Room,entities:[n]},{scope:me.Jo.User,entities:[r]},{scope:me.Jo.Server,entities:[o,s]}]){var u=c.getStateEvents(ye[l]);for(var h of u){var v=h.getContent();if((null===v||void 0===v?void 0:v.recommendation)==me.Q5.Ban){var g=null===v||void 0===v?void 0:v.entity;if(g){var m=void 0;try{m=new RegExp((0,p.dn)(g))}catch(S){continue}for(var y of d)if(y&&m.test(y))return h}}}}}return null}))()}getOrCreateTargetRoom(){var e=this;return(0,o.A)((function*(){var t=e.getIgnoreInvitesPolicies(),r=t.target;if("string"!==typeof r&&(r=null),r){var n=e.client.getRoom(r);if(n)return n;r=null}return r=(yield e.client.createRoom({name:"Individual Policy Room",preset:V.k.PrivateChat})).room_id,yield e.withIgnoreInvitesPolicies((e=>{e.target=r})),e.client.getRoom(r)}))()}getOrCreateSourceRooms(){var e=this;return(0,o.A)((function*(){var t=e.getIgnoreInvitesPolicies(),r=t.sources,n=!1;Array.isArray(r)||(n=!0,r=[]);var i=r.filter((e=>"string"===typeof e)).map((t=>e.client.getRoom(t))).filter((e=>!!e));if(i.length!=r.length&&(n=!0),0==i.length){var o=yield e.getOrCreateTargetRoom();n=!0,i=[o]}return n&&(yield e.withIgnoreInvitesPolicies((e=>{e.sources=r}))),i}))()}getIgnoreInvitesPolicies(){return this.getPoliciesAndIgnoreInvitesPolicies().ignoreInvitesPolicies}withIgnoreInvitesPolicies(e){var t=this;return(0,o.A)((function*(){var{policies:r,ignoreInvitesPolicies:n}=t.getPoliciesAndIgnoreInvitesPolicies();e(n),r[me.NG.name]=n,yield t.client.setAccountData(me.fx.name,r)}))()}getPoliciesAndIgnoreInvitesPolicies(){var e={};for(var t of[me.fx.name,me.fx.altName]){var r;if(t){var n=null===(r=this.client.getAccountData(t))||void 0===r?void 0:r.getContent();if(n){e=n;break}}}var i={},o=!1;for(var s of[me.NG.name,me.NG.altName])if(s){var a=e[s];if(a&&"object"==typeof a){i=a,o=!0;break}}return o||(e[me.NG.name]=i),{policies:e,ignoreInvitesPolicies:i}}}var be=r(9381),Ee="matrix-js-sdk",_e=r(4864),we=r(1915),Ie=r(4123),Te=e=>"livekit"===e.type&&"focus_selection"in e,Re=144e5,ke=(e,t)=>{var r,n="Malformed session membership event: ";return"string"!==typeof e.device_id&&t.push(n+"device_id must be string"),"string"!==typeof e.call_id&&t.push(n+"call_id must be string"),"string"!==typeof e.application&&t.push(n+"application must be a string"),"string"!==typeof(null===(r=e.focus_active)||void 0===r?void 0:r.type)&&t.push(n+"focus_active.type must be a string"),Array.isArray(e.foci_preferred)||t.push(n+"foci_preferred must be an array"),e.created_ts&&"number"!==typeof e.created_ts&&t.push(n+"created_ts must be number"),e.scope&&"string"!==typeof e.scope&&t.push(n+"scope must be string"),0===t.length};class Ae{static equal(e,t){return(0,p.ky)(e.membershipData,t.membershipData)}constructor(e,t){this.parentEvent=e,(0,s.A)(this,"membershipData",void 0);var r=[];if(!ke(t,r))throw Error("unknown CallMembership data. Does not match MSC4143 call.member (".concat(r.join(" & "),") events this could be a legacy membership event: (").concat(t,")"));this.membershipData=t}get sender(){return this.parentEvent.getSender()}get eventId(){return this.parentEvent.getId()}get callId(){return this.membershipData.call_id}get deviceId(){return this.membershipData.device_id}get application(){return this.membershipData.application}get scope(){return this.membershipData.scope}get membershipID(){return this.createdTs().toString()}createdTs(){var e;return null!==(e=this.membershipData.created_ts)&&void 0!==e?e:this.parentEvent.getTs()}getAbsoluteExpiry(){var e;return this.createdTs()+(null!==(e=this.membershipData.expires)&&void 0!==e?e:Re)}getMsUntilExpiry(){return this.getAbsoluteExpiry()-Date.now()}isExpired(){return this.getMsUntilExpiry()<=0}getPreferredFoci(){return this.membershipData.foci_preferred}getFocusSelection(){var e=this.membershipData.focus_active;if(Te(e))return e.focus_selection}}var Ce=r(6255),Oe=r(9310);class De{get callMemberEventRetryDelayMinimum(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.callMemberEventRetryDelayMinimum)&&void 0!==e?e:3e3}get membershipExpiryTimeout(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.membershipExpiryTimeout)&&void 0!==e?e:Re}get membershipServerSideExpiryTimeout(){var e,t,r;return null!==(e=null!==(t=this.membershipServerSideExpiryTimeoutOverride)&&void 0!==t?t:null===(r=this.joinConfig)||void 0===r?void 0:r.membershipServerSideExpiryTimeout)&&void 0!==e?e:8e3}get membershipKeepAlivePeriod(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.membershipKeepAlivePeriod)&&void 0!==e?e:5e3}get callMemberEventRetryJitter(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.callMemberEventRetryJitter)&&void 0!==e?e:2e3}constructor(e,t,r,n){var i=this;this.joinConfig=e,this.room=t,this.client=r,this.getOldestMembership=n,(0,s.A)(this,"relativeExpiry",void 0),(0,s.A)(this,"memberEventTimeout",void 0),(0,s.A)(this,"ownFociPreferred",void 0),(0,s.A)(this,"ownFocusActive",void 0),(0,s.A)(this,"updateCallMembershipRunning",!1),(0,s.A)(this,"needCallMembershipUpdate",!1),(0,s.A)(this,"membershipServerSideExpiryTimeoutOverride",void 0),(0,s.A)(this,"disconnectDelayId",void 0),(0,s.A)(this,"triggerCallMembershipEventUpdate",(0,o.A)((function*(){if(i.updateCallMembershipRunning)i.needCallMembershipUpdate=!0;else{i.updateCallMembershipRunning=!0;try{do{i.needCallMembershipUpdate=!1,yield i.updateCallMembershipEvent()}while(i.needCallMembershipUpdate)}finally{i.updateCallMembershipRunning=!1}}}))),(0,s.A)(this,"delayDisconnection",(0,o.A)((function*(){try{var e=i.disconnectDelayId;yield Me((()=>i.client._unstable_updateDelayedEvent(e,Ce.e.Restart))),i.scheduleDelayDisconnection()}catch(t){g.v.error("Failed to delay our disconnection event:",t)}})))}isJoined(){return void 0!==this.relativeExpiry}join(e,t){this.ownFocusActive=t,this.ownFociPreferred=e,this.relativeExpiry=this.membershipExpiryTimeout,this.triggerCallMembershipEventUpdate()}leave(){var e=arguments,t=this;return(0,o.A)((function*(){var r=e.length>0&&void 0!==e[0]?e[0]:void 0;if(t.relativeExpiry=void 0,t.ownFocusActive=void 0,t.memberEventTimeout&&(clearTimeout(t.memberEventTimeout),t.memberEventTimeout=void 0),r){var n=yield Promise.race([t.triggerCallMembershipEventUpdate(),(0,p.yy)(r,"timeout")]);return"timeout"!==n}return yield t.triggerCallMembershipEventUpdate(),!0}))()}onRTCSessionMemberUpdate(e){var t=this;return(0,o.A)((function*(){var r=e=>e.sender===t.client.getUserId()&&e.deviceId===t.client.getDeviceId();if(t.isJoined()&&!e.some(r))return g.v.warn("Missing own membership: force re-join"),t.triggerCallMembershipEventUpdate()}))()}getActiveFocus(){if(!this.ownFocusActive){var e=this.getOldestMembership();return null===e||void 0===e?void 0:e.getPreferredFoci()[0]}if(Te(this.ownFocusActive)){if("oldest_membership"===this.ownFocusActive.focus_selection){var t=this.getOldestMembership();return null===t||void 0===t?void 0:t.getPreferredFoci()[0]}}else g.v.warn("Unknown own ActiveFocus type. This makes it impossible to connect to an SFU.")}makeNewMembership(e){return this.isJoined()?this.makeMyMembership(e):{}}makeMyMembership(e){var t;return{call_id:"",scope:"m.room",application:"m.call",device_id:e,expires:this.relativeExpiry,focus_active:{type:"livekit",focus_selection:"oldest_membership"},foci_preferred:null!==(t=this.ownFociPreferred)&&void 0!==t?t:[]}}updateCallMembershipEvent(){var e=this;return(0,o.A)((function*(){e.memberEventTimeout&&(clearTimeout(e.memberEventTimeout),e.memberEventTimeout=void 0);var t=e.room.getLiveTimeline().getState(f.q.FORWARDS);if(!t)throw new Error("Couldn't get room state for room "+e.room.roomId);var r=e.client.getUserId(),n=e.client.getDeviceId();if(!r||!n)throw new Error("User ID or device ID was null!");var i={};i=e.makeNewMembership(n);try{if(e.isJoined()){var s=e.makeMembershipStateKey(r,n),a=function(){var t=(0,o.A)((function*(){try{var t=yield Me((()=>e.client._unstable_sendDelayedStateEvent(e.room.roomId,{delay:e.membershipServerSideExpiryTimeout},y.Bx.GroupCallMemberPrefix,{},s)));e.disconnectDelayId=t.delay_id}catch(n){if(n instanceof Oe.up&&"M_UNKNOWN"===n.errcode&&"M_MAX_DELAY_EXCEEDED"===n.data["org.matrix.msc4140.errcode"]){var r=n.data["org.matrix.msc4140.max_delay"];if("number"===typeof r&&e.membershipServerSideExpiryTimeout>r)return e.membershipServerSideExpiryTimeoutOverride=r,a()}g.v.error("Failed to prepare delayed disconnection event:",n)}}));return function(){return t.apply(this,arguments)}}();if(yield a(),yield Me((()=>e.client.sendStateEvent(e.room.roomId,y.Bx.GroupCallMemberPrefix,i,s))),void 0!==e.disconnectDelayId)try{var c=e.disconnectDelayId;yield Me((()=>e.client._unstable_updateDelayedEvent(c,Ce.e.Restart)))}catch(h){h instanceof Oe.up&&"M_NOT_FOUND"===h.errcode&&(g.v.warn("Failed to update delayed disconnection event, prepare it again:",h),e.disconnectDelayId=void 0,yield a())}void 0!==e.disconnectDelayId&&e.scheduleDelayDisconnection()}else{var l=!1;if(void 0!==e.disconnectDelayId){try{var d=e.disconnectDelayId;yield Me((()=>e.client._unstable_updateDelayedEvent(d,Ce.e.Send))),l=!0}catch(h){g.v.error("Failed to send our delayed disconnection event:",h)}e.disconnectDelayId=void 0}l||(yield Me((()=>e.client.sendStateEvent(e.room.roomId,y.Bx.GroupCallMemberPrefix,{},e.makeMembershipStateKey(r,n)))))}g.v.info("Sent updated call member event.")}catch(h){var u=e.callMemberEventRetryDelayMinimum+Math.random()*e.callMemberEventRetryJitter;g.v.warn("Failed to send call member event (retrying in ".concat(u,"): ").concat(h)),yield(0,p.yy)(u),yield e.triggerCallMembershipEventUpdate()}}))()}scheduleDelayDisconnection(){this.memberEventTimeout=setTimeout(this.delayDisconnection,this.membershipKeepAlivePeriod)}makeMembershipStateKey(e,t){var r="".concat(e,"_").concat(t);return/^org\.matrix\.msc(3757|3779)\b/.exec(this.room.getVersion())?r:"_".concat(r)}}function Me(e){return Pe.apply(this,arguments)}function Pe(){return Pe=(0,o.A)((function*(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;while(1)try{return yield e()}catch(o){if(!(t>0&&o instanceof Oe.Hl&&o.isRateLimitError()))throw o;t--;var r=void 0,n=5e3;try{var i;r=null!==(i=o.getRetryAfterMs())&&void 0!==i?i:n,g.v.info("Rate limited by server, retrying in ".concat(r,"ms"))}catch(o){g.v.warn("Error while retrieving a rate-limit retry delay, retrying after default delay of ".concat(n),o),r=n}yield(0,p.yy)(r)}})),Pe.apply(this,arguments)}var xe=g.v.getChild("MatrixRTCSession");class Ue{get updateEncryptionKeyThrottle(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.updateEncryptionKeyThrottle)&&void 0!==e?e:3e3}get makeKeyDelay(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.makeKeyDelay)&&void 0!==e?e:3e3}get useKeyDelay(){var e,t;return null!==(e=null===(t=this.joinConfig)||void 0===t?void 0:t.useKeyDelay)&&void 0!==e?e:5e3}constructor(e,t,r,n){var i=this;this.client=e,this.room=t,this.getMemberships=r,this.onEncryptionKeysChanged=n,(0,s.A)(this,"manageMediaKeys",!1),(0,s.A)(this,"keysEventUpdateTimeout",void 0),(0,s.A)(this,"makeNewKeyTimeout",void 0),(0,s.A)(this,"setNewKeyTimeouts",new Set),(0,s.A)(this,"encryptionKeys",new Map),(0,s.A)(this,"lastEncryptionKeyUpdateRequest",void 0),(0,s.A)(this,"lastMembershipFingerprints",void 0),(0,s.A)(this,"currentEncryptionKeyIndex",-1),(0,s.A)(this,"statistics",{counters:{roomEventEncryptionKeysSent:0,roomEventEncryptionKeysReceived:0},totals:{roomEventEncryptionKeysReceivedTotalAge:0}}),(0,s.A)(this,"joinConfig",void 0),(0,s.A)(this,"joined",!1),(0,s.A)(this,"isMyMembership",(e=>e.sender===this.client.getUserId()&&e.deviceId===this.client.getDeviceId())),(0,s.A)(this,"sendEncryptionKeysEvent",function(){var e=(0,o.A)((function*(e){if(void 0!==i.keysEventUpdateTimeout&&(clearTimeout(i.keysEventUpdateTimeout),i.keysEventUpdateTimeout=void 0),i.lastEncryptionKeyUpdateRequest=Date.now(),i.joined){xe.info("Sending encryption keys event. indexToSend=".concat(e));var t=i.client.getUserId(),r=i.client.getDeviceId();if(!t)throw new Error("No userId");if(!r)throw new Error("No deviceId");var n=i.getKeysForParticipant(t,r);if(n)if("number"===typeof e||-1!==i.currentEncryptionKeyIndex){var o=null!==e&&void 0!==e?e:i.currentEncryptionKeyIndex,s=n[o];try{var a={keys:[{index:o,key:(0,O.PP)(s)}],device_id:r,call_id:"",sent_ts:Date.now()};i.statistics.counters.roomEventEncryptionKeysSent+=1,yield i.client.sendEvent(i.room.roomId,y.Bx.CallEncryptionKeysPrefix,a),xe.debug("Embedded-E2EE-LOG updateEncryptionKeyEvent participantId=".concat(t,":").concat(r," numKeys=").concat(n.length," currentKeyIndex=").concat(i.currentEncryptionKeyIndex," keyIndexToSend=").concat(o),i.encryptionKeys)}catch(d){var c=d;if(c.event&&i.client.cancelPendingEvent(c.event),void 0===i.keysEventUpdateTimeout){var l=(0,Oe.eM)(c,5e3);xe.warn("Failed to send m.call.encryption_key, retrying in ".concat(l),d),i.keysEventUpdateTimeout=setTimeout(i.sendEncryptionKeysEvent,l)}else xe.info("Not scheduling key resend as another re-send is already pending")}}else xe.warn("Tried to send encryption keys event but no current key index found!");else xe.warn("Tried to send encryption keys event but no keys found!")}}));return function(t){return e.apply(this,arguments)}}()),(0,s.A)(this,"onCallEncryptionEventReceived",(e=>{var t=e.getSender(),r=e.getContent(),n=r["device_id"],i=r["call_id"];if(t)if(""===i)if(Array.isArray(r.keys))if(t!==this.client.getUserId()||n!==this.client.getDeviceId()){this.statistics.counters.roomEventEncryptionKeysReceived+=1;var o=Date.now()-("number"===typeof r.sent_ts?r.sent_ts:e.getTs());for(var s of(this.statistics.totals.roomEventEncryptionKeysReceivedTotalAge+=o,r.keys))if(s){var a=s.key,c=s.index;a&&void 0!==c&&null!==c&&void 0!==i&&null!==i&&"string"===typeof n&&"string"===typeof i&&"string"===typeof a&&"number"===typeof c?(xe.debug("Embedded-E2EE-LOG onCallEncryption userId=".concat(t,":").concat(n," encryptionKeyIndex=").concat(c," age=").concat(o,"ms"),this.encryptionKeys),this.setEncryptionKey(t,n,c,a,e.getTs())):xe.warn("Malformed call encryption_key: userId=".concat(t,", deviceId=").concat(n,", encryptionKeyIndex=").concat(c," callId=").concat(i))}else xe.info("Ignoring false-y key in keys event")}else xe.info("Ignoring our own keys event");else xe.warn("Received m.call.encryption_keys where keys wasn't an array: callId=".concat(i));else xe.warn("Received m.call.encryption_keys with unsupported callId: userId=".concat(t,", deviceId=").concat(n,", callId=").concat(i));else xe.warn("Received m.call.encryption_keys with no userId: callId=".concat(i))})),(0,s.A)(this,"onRotateKeyTimeout",(()=>{if(this.manageMediaKeys){this.makeNewKeyTimeout=void 0,xe.info("Making new sender key for key rotation");var e=this.makeNewSenderKey(!0);this.sendEncryptionKeysEvent(e)}}))}getEncryptionKeys(){return this.encryptionKeys}join(e){var t,r,n;this.joinConfig=e,this.joined=!0,this.manageMediaKeys=null!==(t=null===(r=this.joinConfig)||void 0===r?void 0:r.manageMediaKeys)&&void 0!==t?t:this.manageMediaKeys,null!==(n=this.joinConfig)&&void 0!==n&&n.manageMediaKeys&&(this.makeNewSenderKey(),this.requestSendCurrentKey())}leave(){var e=this.client.getUserId(),t=this.client.getDeviceId();if(!e)throw new Error("No userId");if(!t)throw new Error("No deviceId");for(var r of(this.encryptionKeys.set(Le(e,t),[]),void 0!==this.makeNewKeyTimeout&&(clearTimeout(this.makeNewKeyTimeout),this.makeNewKeyTimeout=void 0),this.setNewKeyTimeouts))clearTimeout(r);this.setNewKeyTimeouts.clear(),this.manageMediaKeys=!1,this.joined=!1}onMembershipsUpdate(e){var t=this;return(0,o.A)((function*(){if(t.manageMediaKeys&&t.joined){var r=new Set(e.filter((e=>!t.isMyMembership(e))).map(Be)),n=new Set(t.getMemberships().filter((e=>!t.isMyMembership(e))).map(Be)),i=Array.from(r).some((e=>!n.has(e))),o=Array.from(n).some((e=>!r.has(e))),s=t.lastMembershipFingerprints;if(t.storeLastMembershipFingerprints(),i)t.makeNewKeyTimeout||(xe.debug("Member(s) have left: queueing sender key rotation"),t.makeNewKeyTimeout=setTimeout(t.onRotateKeyTimeout,t.makeKeyDelay));else if(o)xe.debug("New member(s) have joined: re-sending keys"),t.requestSendCurrentKey();else if(s){var a=t.lastMembershipFingerprints,c=Array.from(s).some((e=>!a.has(e)))||Array.from(a).some((e=>!s.has(e)));c&&(xe.debug("Member(s) have updated/reconnected: re-sending keys to everyone"),t.requestSendCurrentKey())}}}))()}makeNewSenderKey(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.client.getUserId(),r=this.client.getDeviceId();if(!t)throw new Error("No userId");if(!r)throw new Error("No deviceId");var n=(0,$.rl)(16),i=this.getNewEncryptionKeyIndex();return xe.info("Generated new key at index "+i),this.setEncryptionKey(t,r,i,n,Date.now(),e),i}requestSendCurrentKey(){if(this.manageMediaKeys)return this.lastEncryptionKeyUpdateRequest&&this.lastEncryptionKeyUpdateRequest+this.updateEncryptionKeyThrottle>Date.now()?(xe.info("Last encryption key event sent too recently: postponing"),void(void 0===this.keysEventUpdateTimeout&&(this.keysEventUpdateTimeout=setTimeout(this.sendEncryptionKeysEvent,this.updateEncryptionKeyThrottle)))):void this.sendEncryptionKeysEvent()}getKeysForParticipant(e,t){var r;return null===(r=this.encryptionKeys.get(Le(e,t)))||void 0===r?void 0:r.map((e=>e.key))}storeLastMembershipFingerprints(){this.lastMembershipFingerprints=new Set(this.getMemberships().filter((e=>!this.isMyMembership(e))).map((e=>"".concat(Be(e),":").concat(e.createdTs()))))}getNewEncryptionKeyIndex(){return-1===this.currentEncryptionKeyIndex?0:(this.currentEncryptionKeyIndex+1)%256}setEncryptionKey(e,t,r,n,i){var o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=(0,O.y4)(n),a=Le(e,t);this.encryptionKeys.has(a)||this.encryptionKeys.set(a,[]);var c=this.encryptionKeys.get(a),l=c[r];if(l){if(l.timestamp>i)return void xe.info("Ignoring new key at index ".concat(r," for ").concat(a," as it is older than existing known key"));if(Ne(l.key,s))return void(l.timestamp=i)}if(c[r]={key:s,timestamp:i},o){var d=setTimeout((()=>{this.setNewKeyTimeouts.delete(d),xe.info("Delayed-emitting key changed event for ".concat(a," idx ").concat(r)),e===this.client.getUserId()&&t===this.client.getDeviceId()&&(this.currentEncryptionKeyIndex=r),this.onEncryptionKeysChanged(s,r,a)}),this.useKeyDelay);this.setNewKeyTimeouts.add(d)}else e===this.client.getUserId()&&t===this.client.getDeviceId()&&(this.currentEncryptionKeyIndex=r),this.onEncryptionKeysChanged(s,r,a)}}var Le=(e,t)=>"".concat(e,":").concat(t);function Ne(e,t){return e===t||!!e&&!!t&&e.length===t.length&&e.every(((e,r)=>e===t[r]))}var Be=e=>Le(e.sender,e.deviceId),Ke=g.v.getChild("MatrixRTCSession"),Fe=function(e){return e["MembershipsChanged"]="memberships_changed",e["JoinStateChanged"]="join_state_changed",e["EncryptionKeyChanged"]="encryption_key_changed",e}({});class je extends ce.X{get statistics(){return this.encryptionManager.statistics}get callId(){return this._callId}static callMembershipsForRoom(e){var t=e.getLiveTimeline().getState(f.q.FORWARDS);if(!t)throw Ke.warn("Couldn't get state for room "+e.roomId),new Error("Could't get state for room "+e.roomId);var r=t.getStateEvents(y.Bx.GroupCallMemberPrefix),n=[];for(var i of r){var o=i.getContent(),s=Object.keys(o).length;if(0!==s){var a=[];if(s>1&&"focus_active"in o?a.push(o):1===s&&"memberships"in o&&Ke.warn("Legacy event found. Those are ignored, they do not contribute to the MatrixRTC session"),0!==a.length)for(var c of a)try{var l,d=new Ae(i,c);if(""!==d.callId||"m.room"!==d.scope){Ke.info("Ignoring user-scoped call");continue}if(d.isExpired()){Ke.info("Ignoring expired device membership ".concat(d.sender,"/").concat(d.deviceId));continue}if(!e.hasMembershipState(null!==(l=d.sender)&&void 0!==l?l:"",Z.O.Join)){Ke.info("Ignoring membership of user ".concat(d.sender," who is not in the room."));continue}n.push(d)}catch(u){Ke.warn("Couldn't construct call membership: ",u)}}}return n.sort(((e,t)=>e.createdTs()-t.createdTs())),n.length>1&&Ke.debug("Call memberships in room ".concat(e.roomId,", in order: "),n.map((e=>[e.createdTs(),e.sender]))),n}static roomSessionForRoom(e,t){var r=je.callMembershipsForRoom(t);return new je(e,t,r)}constructor(e,t,r){var n;super(),this.client=e,this.room=t,this.memberships=r,(0,s.A)(this,"membershipManager",void 0),(0,s.A)(this,"encryptionManager",void 0),(0,s.A)(this,"_callId",void 0),(0,s.A)(this,"expiryTimeout",void 0),(0,s.A)(this,"onCallEncryption",(e=>{this.encryptionManager.onCallEncryptionEventReceived(e)})),(0,s.A)(this,"onMembershipUpdate",(()=>{this.recalculateSessionMembers()})),(0,s.A)(this,"onRoomMemberUpdate",(()=>{this.recalculateSessionMembers()})),(0,s.A)(this,"onRTCSessionMemberUpdate",(()=>{this.recalculateSessionMembers()})),(0,s.A)(this,"recalculateSessionMembers",(()=>{var e,t,r=this.memberships;this.memberships=je.callMembershipsForRoom(this.room),this._callId=null!==(e=this._callId)&&void 0!==e?e:null===(t=this.memberships[0])||void 0===t?void 0:t.callId;var n,i=r.length!=this.memberships.length||r.some(((e,t)=>!Ae.equal(e,this.memberships[t])));i&&(Ke.info("Memberships for call in room ".concat(this.room.roomId," have changed: emitting")),this.emit(Fe.MembershipsChanged,r,this.memberships),null===(n=this.membershipManager)||void 0===n||n.onRTCSessionMemberUpdate(this.memberships));this.encryptionManager.onMembershipsUpdate(r),this.setExpiryTimer()})),this._callId=null===(n=r[0])||void 0===n?void 0:n.callId;var i=this.room.getLiveTimeline().getState(f.q.FORWARDS);null===i||void 0===i||i.on(Ie.f.Members,this.onRoomMemberUpdate),this.setExpiryTimer(),this.encryptionManager=new Ue(this.client,this.room,(()=>this.memberships),((e,t,r)=>{this.emit(Fe.EncryptionKeyChanged,e,t,r)}))}isJoined(){var e,t;return null!==(e=null===(t=this.membershipManager)||void 0===t?void 0:t.isJoined())&&void 0!==e&&e}stop(){var e=this;return(0,o.A)((function*(){var t;yield null===(t=e.membershipManager)||void 0===t?void 0:t.leave(1e3),e.expiryTimeout&&(clearTimeout(e.expiryTimeout),e.expiryTimeout=void 0);var r=e.room.getLiveTimeline().getState(f.q.FORWARDS);null===r||void 0===r||r.off(Ie.f.Members,e.onRoomMemberUpdate)}))()}joinRoomSession(e,t,r){this.isJoined()?Ke.info("Already joined to session in room ".concat(this.room.roomId,": ignoring join call")):(this.membershipManager=new De(r,this.room,this.client,(()=>this.getOldestMembership())),this.membershipManager.join(e,t),this.encryptionManager.join(r),this.emit(Fe.JoinStateChanged,!0))}leaveRoomSession(){var e=arguments,t=this;return(0,o.A)((function*(){var r=e.length>0&&void 0!==e[0]?e[0]:void 0;if(!t.isJoined())return Ke.info("Not joined to session in room ".concat(t.room.roomId,": ignoring leave call")),!1;Ke.info("Leaving call session in room ".concat(t.room.roomId)),t.encryptionManager.leave();var n=t.membershipManager.leave(r);return t.emit(Fe.JoinStateChanged,!1),yield n}))()}getActiveFocus(){var e;return null===(e=this.membershipManager)||void 0===e?void 0:e.getActiveFocus()}getOldestMembership(){return this.memberships[0]}getFocusInUse(){var e=this.getOldestMembership();if("oldest_membership"===(null===e||void 0===e?void 0:e.getFocusSelection()))return e.getPreferredFoci()[0]}reemitEncryptionKeys(){this.encryptionManager.getEncryptionKeys().forEach(((e,t)=>{e.forEach(((e,r)=>{this.emit(Fe.EncryptionKeyChanged,e.key,r,t)}))}))}getEncryptionKeys(){var e,t=null!==(e=this.encryptionManager.getEncryptionKeys())&&void 0!==e?e:new Map;return Array.from(t.entries()).map((e=>{var[t,r]=e;return[t,r.map((e=>e.key))]})).values()}setExpiryTimer(){var e;for(var t of(this.expiryTimeout&&(clearTimeout(this.expiryTimeout),this.expiryTimeout=void 0),this.memberships)){var r=t.getMsUntilExpiry();void 0!==r&&(void 0===e||r<e)&&(e=r)}void 0!=e&&(this.expiryTimeout=setTimeout(this.onRTCSessionMemberUpdate,e))}}var qe=g.v.getChild("MatrixRTCSessionManager"),Ve=function(e){return e["SessionStarted"]="session_started",e["SessionEnded"]="session_ended",e}({});class Ge extends ce.X{constructor(e){super(),this.client=e,(0,s.A)(this,"roomSessions",new Map),(0,s.A)(this,"onTimeline",(e=>{this.consumeCallEncryptionEvent(e)})),(0,s.A)(this,"onRoom",(e=>{this.refreshRoom(e)})),(0,s.A)(this,"onRoomState",((e,t)=>{var r=this.client.getRoom(e.getRoomId());r?e.getType()==y.Bx.GroupCallMemberPrefix&&this.refreshRoom(r):qe.error("Got room state event for unknown room ".concat(e.getRoomId(),"!"))}))}start(){for(var e of null!==(t=this.client.getRooms())&&void 0!==t?t:[]){var t,r=je.roomSessionForRoom(this.client,e);r.memberships.length>0&&this.roomSessions.set(e.roomId,r)}this.client.on(ut.Room,this.onRoom),this.client.on(j.u9.Timeline,this.onTimeline),this.client.on(Ie.f.Events,this.onRoomState)}stop(){for(var e of this.roomSessions.values())e.stop();this.roomSessions.clear(),this.client.off(ut.Room,this.onRoom),this.client.off(j.u9.Timeline,this.onTimeline),this.client.off(Ie.f.Events,this.onRoomState)}getActiveRoomSession(e){return this.roomSessions.get(e.roomId)}getRoomSession(e){return this.roomSessions.has(e.roomId)||this.roomSessions.set(e.roomId,je.roomSessionForRoom(this.client,e)),this.roomSessions.get(e.roomId)}consumeCallEncryptionEvent(e){var t=arguments,r=this;return(0,o.A)((function*(){var n=t.length>1&&void 0!==t[1]&&t[1];if(yield r.client.decryptEventIfNeeded(e),e.isDecryptionFailure())n?qe.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason)):(qe.warn("Decryption failed for event ".concat(e.getId(),": ").concat(e.decryptionFailureReason," will retry once only")),setTimeout((()=>r.consumeCallEncryptionEvent(e,!0)),1e3));else{if(n&&qe.info("Decryption succeeded for event ".concat(e.getId()," after retry")),e.getType()!==y.Bx.CallEncryptionKeysPrefix)return Promise.resolve();var i=r.client.getRoom(e.getRoomId());if(!i)return qe.error("Got room state event for unknown room ".concat(e.getRoomId(),"!")),Promise.resolve();r.getRoomSession(i).onCallEncryption(e)}}))()}refreshRoom(e){var t=!this.roomSessions.has(e.roomId),r=this.getRoomSession(e),n=r.memberships.length>0&&!t;r.onRTCSessionMemberUpdate();var i=r.memberships.length>0;n&&!i?this.emit(Ve.SessionEnded,e.roomId,this.roomSessions.get(e.roomId)):!n&&i&&this.emit(Ve.SessionStarted,e.roomId,this.roomSessions.get(e.roomId))}}function We(e){return t=>{var r,n;return(null===(r=t.content)||void 0===r||null===(r=r["m.relates_to"])||void 0===r?void 0:r.event_id)!==e||(null===(n=t.content)||void 0===n||null===(n=n["m.relates_to"])||void 0===n?void 0:n.rel_type)===ue.RN.name}}var He=r(6718),$e=r(7363),Je=r(8695),ze=r(5092),Ye=["server","limit","since"];function Qe(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Xe(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Qe(Object(r),!0).forEach((function(t){(0,s.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Qe(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Ze=3e3,et=(0,x.DM)(),tt=6e5,rt=new ve.qr("last_seen_user_agent","org.matrix.msc3852.last_seen_user_agent"),nt=function(e){return e["Chronological"]="chronological",e["Detached"]="detached",e}({}),it=new ve.xu("m.get_login_token","org.matrix.msc3882.get_login_token"),ot="uk.half-shot.msc2666",st="uk.half-shot.msc2666.mutual_rooms",at="uk.half-shot.msc2666.query_mutual_rooms",ct="org.matrix.msc4140",lt="uk.tcpip.msc4133",dt="$",ut=function(e){return e["Sync"]="sync",e["Event"]="event",e["ToDeviceEvent"]="toDeviceEvent",e["AccountData"]="accountData",e["Room"]="Room",e["DeleteRoom"]="deleteRoom",e["SyncUnexpectedError"]="sync.unexpectedError",e["ClientWellKnown"]="WellKnown.client",e["ReceivedVoipEvent"]="received_voip_event",e["UndecryptableToDeviceEvent"]="toDeviceEvent.undecryptable",e["TurnServers"]="turnServers",e["TurnServersError"]="turnServers.error",e}({}),ht=new ve.qr("action","org.matrix.msc3824.action");class vt extends ce.X{constructor(e){var t,r,n,i;super(),n=this,(0,s.A)(this,"logger",void 0),(0,s.A)(this,"reEmitter",new D.Q(this)),(0,s.A)(this,"olmVersion",null),(0,s.A)(this,"usingExternalCrypto",!1),(0,s.A)(this,"_store",void 0),(0,s.A)(this,"deviceId",void 0),(0,s.A)(this,"credentials",void 0),(0,s.A)(this,"pickleKey",void 0),(0,s.A)(this,"scheduler",void 0),(0,s.A)(this,"clientRunning",!1),(0,s.A)(this,"timelineSupport",!1),(0,s.A)(this,"urlPreviewCache",{}),(0,s.A)(this,"identityServer",void 0),(0,s.A)(this,"http",void 0),(0,s.A)(this,"crypto",void 0),(0,s.A)(this,"cryptoBackend",void 0),(0,s.A)(this,"cryptoCallbacks",void 0),(0,s.A)(this,"callEventHandler",void 0),(0,s.A)(this,"groupCallEventHandler",void 0),(0,s.A)(this,"supportsCallTransfer",!1),(0,s.A)(this,"forceTURN",!1),(0,s.A)(this,"iceCandidatePoolSize",0),(0,s.A)(this,"idBaseUrl",void 0),(0,s.A)(this,"baseUrl",void 0),(0,s.A)(this,"isVoipWithNoMediaAllowed",void 0),(0,s.A)(this,"useLivekitForGroupCalls",void 0),(0,s.A)(this,"canSupportVoip",!1),(0,s.A)(this,"peekSync",null),(0,s.A)(this,"isGuestAccount",!1),(0,s.A)(this,"ongoingScrollbacks",{}),(0,s.A)(this,"notifTimelineSet",null),(0,s.A)(this,"cryptoStore",void 0),(0,s.A)(this,"verificationMethods",void 0),(0,s.A)(this,"fallbackICEServerAllowed",!1),(0,s.A)(this,"syncApi",void 0),(0,s.A)(this,"roomNameGenerator",void 0),(0,s.A)(this,"pushRules",void 0),(0,s.A)(this,"syncLeftRoomsPromise",void 0),(0,s.A)(this,"syncedLeftRooms",!1),(0,s.A)(this,"clientOpts",void 0),(0,s.A)(this,"clientWellKnownIntervalID",void 0),(0,s.A)(this,"canResetTimelineCallback",void 0),(0,s.A)(this,"canSupport",new Map),(0,s.A)(this,"pushProcessor",new A(this)),(0,s.A)(this,"serverVersionsPromise",void 0),(0,s.A)(this,"clientWellKnown",void 0),(0,s.A)(this,"clientWellKnownPromise",void 0),(0,s.A)(this,"turnServers",[]),(0,s.A)(this,"turnServersExpiry",0),(0,s.A)(this,"checkTurnServersIntervalID",void 0),(0,s.A)(this,"exportedOlmDeviceToImport",void 0),(0,s.A)(this,"txnCtr",0),(0,s.A)(this,"mediaHandler",new ae.L(this)),(0,s.A)(this,"sessionId",void 0),(0,s.A)(this,"eventsBeingEncrypted",new Set),(0,s.A)(this,"useE2eForGroupCall",!0),(0,s.A)(this,"toDeviceMessageQueue",void 0),(0,s.A)(this,"livekitServiceURL",void 0),(0,s.A)(this,"_secretStorage",void 0),(0,s.A)(this,"ignoredInvites",void 0),(0,s.A)(this,"matrixRTC",void 0),(0,s.A)(this,"serverCapabilitiesService",void 0),(0,s.A)(this,"startCallEventHandler",(()=>{this.isInitialSyncComplete()&&((0,d.sj)()&&(this.callEventHandler.start(),this.groupCallEventHandler.start()),this.off(ut.Sync,this.startCallEventHandler))})),(0,s.A)(this,"startMatrixRTC",(()=>{this.isInitialSyncComplete()&&(this.matrixRTC.start(),this.off(ut.Sync,this.startMatrixRTC))})),(0,s.A)(this,"fixupRoomNotifications",(()=>{if(this.isInitialSyncComplete()){var e,t=(null!==(e=this.getRooms())&&void 0!==e?e:[]).filter((e=>e.getUnreadNotificationCount(j.X5.Total)>0));for(var r of t){var n=this.getSafeUserId();r.fixupNotifications(n)}this.off(ut.Sync,this.fixupRoomNotifications)}})),this.logger=null!==(t=e.logger)&&void 0!==t?t:g.v,e.baseUrl=p.hc(e.baseUrl),e.idBaseUrl=p.hc(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer,this.usingExternalCrypto=null!==(r=e.usingExternalCrypto)&&void 0!==r&&r,this.store=e.store||new l,this.deviceId=e.deviceId||null,this.sessionId=(0,$.US)(10);var a=e.userId||null;this.credentials={userId:a},this.http=new P.ED(this,{fetchFn:e.fetchFn,baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,refreshToken:e.refreshToken,tokenRefreshFunction:e.tokenRefreshFunction,prefix:P.iD.V3,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader,logger:this.logger}),e.deviceToImport?this.deviceId?this.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?this.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):this.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.useLivekitForGroupCalls=Boolean(e.useLivekitForGroupCalls),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction(function(){var e=(0,o.A)((function*(e){var t=n.getRoom(e.getRoomId());e.status!==c.fb.SENDING&&n.updatePendingEventStatus(t,e,c.fb.SENDING);var r=yield n.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,c.fb.SENT,r.event_id),r}));return function(t){return e.apply(this,arguments)}}()),(0,d.sj)()&&(this.callEventHandler=new h.N(this),this.groupCallEventHandler=new v.e(this),this.canSupportVoip=!0,this.on(ut.Sync,this.startCallEventHandler)),this.matrixRTC=new Ge(this),this.serverCapabilitiesService=new He.K(this.http),this.on(ut.Sync,this.fixupRoomNotifications),this.timelineSupport=Boolean(e.timelineSupport),this.cryptoStore=e.cryptoStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.isVoipWithNoMediaAllowed=e.isVoipWithNoMediaAllowed||!1,void 0!==e.useE2eForGroupCall&&(this.useE2eForGroupCall=e.useE2eForGroupCall),this.livekitServiceURL=e.livekitServiceURL,this.roomNameGenerator=e.roomNameGenerator,this.toDeviceMessageQueue=new ge(this),this.on(c.OQ.Decrypted,(e=>{ft(this,e)})),this.ignoredInvites=new Se(this),this._secretStorage=new we.ServerSideSecretStorageImpl(this,null!==(i=e.cryptoCallbacks)&&void 0!==i?i:{}),this.setMaxListeners(0)}set store(e){this._store=e,this._store.setUserCreator((e=>U.K.createUser(e,this)))}get store(){return this._store}startClient(e){var t=this;return(0,o.A)((function*(){if(!t.clientRunning){t.clientRunning=!0,t.on(ut.Sync,t.startMatrixRTC);var r=t.getUserId();r&&t.store.storeUser(new U.K(r)),t.canSupportVoip&&(t.checkTurnServersIntervalID=setInterval((()=>{t.checkTurnServers()}),tt),t.checkTurnServers()),t.syncApi&&(t.logger.error("Still have sync object whilst not running: stopping old one"),t.syncApi.stop());try{yield t.getVersions();var{threads:n,list:i,fwdPagination:o}=yield t.doesServerSupportThread();ue.jV.setServerSideSupport(n),ue.jV.setServerSideListSupport(i),ue.jV.setServerSideFwdPaginationSupport(o)}catch(s){t.logger.error("Can't fetch server versions, continuing to initialise sync, this will be retried later",s)}t.clientOpts=null!==e&&void 0!==e?e:{},t.clientOpts.slidingSync?t.syncApi=new de.m(t.clientOpts.slidingSync,t,t.clientOpts,t.buildSyncApiOptions()):t.syncApi=new a.w_(t,t.clientOpts,t.buildSyncApiOptions()),t.syncApi.sync().catch((e=>t.logger.info("Sync startup aborted with an error:",e))),void 0!==t.clientOpts.clientWellKnownPollPeriod&&(t.clientWellKnownIntervalID=setInterval((()=>{t.fetchClientWellKnown()}),1e3*t.clientOpts.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.toDeviceMessageQueue.start(),t.serverCapabilitiesService.start()}}))()}buildSyncApiOptions(){return{crypto:this.crypto,cryptoCallbacks:this.cryptoBackend,canResetEntireTimeline:e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e)}}stopClient(){var e,t,r,n,i;null===(e=this.cryptoBackend)||void 0===e||e.stop(),this.off(ut.Sync,this.startMatrixRTC),this.clientRunning&&(this.logger.debug("stopping MatrixClient"),this.clientRunning=!1,null===(t=this.syncApi)||void 0===t||t.stop(),this.syncApi=void 0,null===(r=this.peekSync)||void 0===r||r.stopPeeking(),null===(n=this.callEventHandler)||void 0===n||n.stop(),null===(i=this.groupCallEventHandler)||void 0===i||i.stop(),this.callEventHandler=void 0,this.groupCallEventHandler=void 0,globalThis.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=void 0,void 0!==this.clientWellKnownIntervalID&&globalThis.clearInterval(this.clientWellKnownIntervalID),this.toDeviceMessageQueue.stop(),this.matrixRTC.stop(),this.serverCapabilitiesService.stop())}rehydrateDevice(){var e=this;return(0,o.A)((function*(){if(e.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(e.cryptoCallbacks.getDehydrationKey){var t=yield e.getDehydratedDevice();if(t)if(t.device_data&&t.device_id){var r=new globalThis.Olm.Account;try{var n=t.device_data;if(n.algorithm!==B.S)return void e.logger.warn("Wrong algorithm for dehydrated device");e.logger.debug("unpickling dehydrated device");var i=yield e.cryptoCallbacks.getDehydrationKey(n,(e=>{r.unpickle(new Uint8Array(e),n.account)}));r.unpickle(i,n.account),e.logger.debug("unpickled device");var o=yield e.http.authedRequest(P.IT.Post,"/dehydrated_device/claim",void 0,{device_id:t.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"});if(o.success){e.deviceId=t.device_id,e.logger.info("using dehydrated device");var s=e.pickleKey||"DEFAULT_KEY";return e.exportedOlmDeviceToImport={pickledAccount:r.pickle(s),sessions:[],pickleKey:s},r.free(),e.deviceId}return r.free(),void e.logger.info("not using dehydrated device")}catch(a){r.free(),e.logger.warn("could not unpickle",a)}}else e.logger.info("no dehydrated device found")}}))()}getDehydratedDevice(){var e=this;return(0,o.A)((function*(){try{return yield e.http.authedRequest(P.IT.Get,"/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(t){return void e.logger.info("could not get dehydrated device",t)}}))()}setDehydrationKey(e,t,r){var n=this;return(0,o.A)((function*(){if(n.crypto)return n.crypto.dehydrationManager.setKeyAndQueueDehydration(e,t,r);n.logger.warn("not dehydrating device if crypto is not enabled")}))()}createDehydratedDevice(e,t,r){var n=this;return(0,o.A)((function*(){if(n.crypto)return yield n.crypto.dehydrationManager.setKey(e,t,r),n.crypto.dehydrationManager.dehydrateDevice();n.logger.warn("not dehydrating device if crypto is not enabled")}))()}exportDevice(){var e=this;return(0,o.A)((function*(){if(e.crypto)return{userId:e.credentials.userId,deviceId:e.deviceId,olmDevice:yield e.crypto.olmDevice.export()};e.logger.warn("not exporting device if crypto is not enabled")}))()}clearStores(){var e=this;if(this.clientRunning)throw new Error("Cannot clear stores while client is running");var t=[];t.push(this.store.deleteAllData()),this.cryptoStore&&t.push(this.cryptoStore.deleteAllData());var r=function(){var t=(0,o.A)((function*(){var t;try{if(t=globalThis.indexedDB,!t)return}catch(i){return}var r=function*(r){var n=new Promise(((n,i)=>{e.logger.info("Removing IndexedDB instance ".concat(r));var o=t.deleteDatabase(r);o.onsuccess=t=>{e.logger.info("Removed IndexedDB instance ".concat(r)),n(0)},o.onerror=t=>{e.logger.warn("Failed to remove IndexedDB instance ".concat(r,":"),t),n(0)},o.onblocked=t=>{e.logger.info("cannot yet remove IndexedDB instance ".concat(r))}}));yield n};for(var n of["".concat(Ee,"::matrix-sdk-crypto"),"".concat(Ee,"::matrix-sdk-crypto-meta")])yield*r(n)}));return function(){return t.apply(this,arguments)}}();return t.push(r()),Promise.all(t).then()}getUserId(){var e,t;return null!==(e=null===(t=this.credentials)||void 0===t?void 0:t.userId)&&void 0!==e?e:null}getSafeUserId(){var e=this.getUserId();if(!e)throw new Error("Expected logged in user but found none.");return e}getDomain(){var e;return null!==(e=this.credentials)&&void 0!==e&&e.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){var e,t;return null!==(e=null===(t=this.credentials)||void 0===t||null===(t=t.userId)||void 0===t?void 0:t.split(":")[0].substring(1))&&void 0!==e?e:null}getDeviceId(){return this.deviceId}getSessionId(){return this.sessionId}supportsVoip(){return this.canSupportVoip}getMediaHandler(){return this.mediaHandler}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}getUseE2eForGroupCall(){return this.useE2eForGroupCall}createCall(e){return(0,d.sv)(this,e)}createGroupCall(e,t,r,n,i,s){var a=this;return(0,o.A)((function*(){if(a.getGroupCallForRoom(e))throw new Error("".concat(e," already has an existing group call"));var o=a.getRoom(e);if(!o)throw new Error("Cannot find room ".concat(e));return new se.eO(a,o,t,r,n,void 0,i||a.isVoipWithNoMediaAllowed,s,a.isVoipWithNoMediaAllowed,a.useLivekitForGroupCalls,a.livekitServiceURL).create()}))()}getLivekitServiceURL(){return this.livekitServiceURL}setLivekitServiceURL(e){this.livekitServiceURL=e}waitUntilRoomReadyForGroupCalls(e){return this.groupCallEventHandler.waitUntilRoomReadyForGroupCalls(e)}getGroupCallForRoom(e){return this.groupCallEventHandler.groupCalls.get(e)||null}getSyncState(){var e,t;return null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.getSyncState())&&void 0!==e?e:null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){var e=this.getSyncState();return!!e&&(e===a.Lm.Prepared||e===a.Lm.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){var e,t;return this.toDeviceMessageQueue.sendQueue(),null!==(e=null===(t=this.syncApi)||void 0===t?void 0:t.retryImmediately())&&void 0!==e&&e}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(){var e=this;return(0,o.A)((function*(){var t=e.serverCapabilitiesService.getCachedCapabilities();return t||e.serverCapabilitiesService.fetchCapabilities()}))()}getCachedCapabilities(){return this.serverCapabilitiesService.getCachedCapabilities()}fetchCapabilities(){return this.serverCapabilitiesService.fetchCapabilities()}initLegacyCrypto(){var e=this;return(0,o.A)((function*(){if(!(0,x.DM)())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(e.cryptoBackend)e.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");else{if(!e.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");e.logger.debug("Crypto: Starting up crypto store..."),yield e.cryptoStore.startup();var t=e.getUserId();if(null===t)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===e.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");var r=new x.Qr(e,t,e.deviceId,e.store,e.cryptoStore,e.verificationMethods);e.reEmitter.reEmit(r,[x.cr.KeyBackupFailed,x.cr.KeyBackupSessionsRemaining,x.cr.RoomKeyRequest,x.cr.RoomKeyRequestCancellation,x.cr.Warning,x.cr.DevicesUpdated,x.cr.WillUpdateDevices,x.cr.DeviceVerificationChanged,x.cr.UserTrustStatusChanged,x.cr.KeysChanged]),e.logger.debug("Crypto: initialising crypto object..."),yield r.init({exportedOlmDevice:e.exportedOlmDeviceToImport,pickleKey:e.pickleKey}),delete e.exportedOlmDeviceToImport,e.olmVersion=x.Qr.getOlmVersion(),r.registerEventHandlers(e),e.cryptoBackend=e.crypto=r,e.crypto.uploadDeviceKeys().catch((t=>{e.logger.error("Error uploading device keys",t)}))}}))()}initRustCrypto(){var e=arguments,t=this;return(0,o.A)((function*(){var n,i=e.length>0&&void 0!==e[0]?e[0]:{};if(t.cryptoBackend)t.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");else{var o=t.getUserId();if(null===o)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");var s=t.getDeviceId();if(null===s)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");t.logger.debug("Downloading Rust crypto library");var a=yield r.e(904).then(r.bind(r,7904)),c=yield a.initRustCrypto({logger:t.logger,http:t.http,userId:o,deviceId:s,secretStorage:t.secretStorage,cryptoCallbacks:t.cryptoCallbacks,storePrefix:!1===i.useIndexedDB?null:Ee,storeKey:i.storageKey,storePassphrase:i.storagePassword,legacyCryptoStore:t.cryptoStore,legacyPickleKey:null!==(n=t.pickleKey)&&void 0!==n?n:"DEFAULT_KEY",legacyMigrationProgressListener:(e,r)=>{t.emit(_e.CryptoEvent.LegacyCryptoStoreMigrationProgress,e,r)}});c.setSupportedVerificationMethods(t.verificationMethods),t.cryptoBackend=c,t.on(q.o.Membership,c.onRoomMembership.bind(c)),t.on(ut.Event,(e=>{c.onLiveEventFromSync(e)})),t.reEmitter.reEmit(c,[_e.CryptoEvent.VerificationRequestReceived,_e.CryptoEvent.UserTrustStatusChanged,_e.CryptoEvent.KeyBackupStatus,_e.CryptoEvent.KeyBackupSessionsRemaining,_e.CryptoEvent.KeyBackupFailed,_e.CryptoEvent.KeyBackupDecryptionKeyCached,_e.CryptoEvent.KeysChanged,_e.CryptoEvent.DevicesUpdated,_e.CryptoEvent.WillUpdateDevices,_e.CryptoEvent.DehydratedDeviceCreated,_e.CryptoEvent.DehydratedDeviceUploaded,_e.CryptoEvent.RehydrationStarted,_e.CryptoEvent.RehydrationProgress,_e.CryptoEvent.RehydrationCompleted,_e.CryptoEvent.RehydrationError,_e.CryptoEvent.DehydrationKeyCached,_e.CryptoEvent.DehydratedDeviceRotationError])}}))()}get secretStorage(){return this._secretStorage}getCrypto(){return this.cryptoBackend}isCryptoEnabled(){return!!this.cryptoBackend}getDeviceEd25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceEd25519Key())&&void 0!==e?e:null}getDeviceCurve25519Key(){var e,t;return null!==(e=null===(t=this.crypto)||void 0===t?void 0:t.getDeviceCurve25519Key())&&void 0!==e?e:null}uploadKeys(){var e=this;return(0,o.A)((function*(){e.logger.warn("MatrixClient.uploadKeys is deprecated")}))()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=this.setDeviceVerification(e,t,r,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),n}setDeviceBlocked(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.setDeviceVerification(e,t,null,r,null)}setDeviceKnown(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return this.setDeviceVerification(e,t,null,null,r)}setDeviceVerification(e,t,r,n,i){var s=this;return(0,o.A)((function*(){if(!s.crypto)throw new Error("End-to-end encryption disabled");yield s.crypto.setDeviceVerification(e,t,r,n,i)}))()}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");if(this.crypto)return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,r)}checkSecretStorageKey(e,t){return this.secretStorage.checkKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices=e,e}getGlobalBlacklistUnverifiedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalBlacklistUnverifiedDevices}setGlobalErrorOnUnknownDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.globalErrorOnUnknownDevices=e}getGlobalErrorOnUnknownDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.globalErrorOnUnknownDevices}getCrossSigningId(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:K.n.Master;if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkIfOwnDeviceCrossSigned(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkIfOwnDeviceCrossSigned(e)}checkOwnCrossSigningTrust(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,r)}prepareToEncrypt(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.prepareToEncrypt(e)}userHasCrossSigningKeys(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.userHasCrossSigningKeys()}isCrossSigningReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");this.cryptoBackend.setTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,r){return this.secretStorage.addKey(e,t,r)}hasSecretStorageKey(e){return this.secretStorage.hasKey(e)}storeSecret(e,t,r){return this.secretStorage.store(e,t,r)}getSecret(e){return this.secretStorage.get(e)}isSecretStored(e){return this.secretStorage.isStored(e)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){return this.secretStorage.getDefaultKeyId()}setDefaultSecretStorageKeyId(e){return this.secretStorage.setDefaultKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}getEventSenderDeviceInfo(e){var t=this;return(0,o.A)((function*(){return t.crypto?t.crypto.getEventSenderDeviceInfo(e):null}))()}isEventSenderVerified(e){var t=this;return(0,o.A)((function*(){var r=yield t.getEventSenderDeviceInfo(e);return!!r&&r.isVerified()}))()}getOutgoingRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");var t=e.getWireContent(),r={session_id:t.session_id,sender_key:t.sender_key,algorithm:t.algorithm,room_id:e.getRoomId()};return r.session_id&&r.sender_key&&r.algorithm&&r.room_id?this.crypto.cryptoStore.getOutgoingRoomKeyRequest(r):Promise.resolve(null)}cancelAndResendEventRoomKeyRequest(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){var t,r,n=this.getRoom(e);return!!n&&(!!n.hasEncryptionStateEvent()||null!==(t=null===(r=this.crypto)||void 0===r?void 0:r.isRoomEncrypted(e))&&void 0!==t&&t)}encryptAndSendToDevices(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.encryptAndSendToDevices(e,t)}forceDiscardSession(e){if(!this.cryptoBackend)throw new Error("End-to-End encryption disabled");this.cryptoBackend.forceDiscardSession(e)}exportRoomKeys(){return this.cryptoBackend?this.cryptoBackend.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.cryptoBackend)throw new Error("End-to-end encryption disabled");return this.cryptoBackend.importRoomKeys(e,t)}checkKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.checkKeyBackup()}getKeyBackupVersion(){var e=this;return(0,o.A)((function*(){var t;try{t=yield e.http.authedRequest(P.IT.Get,"/room_keys/version",void 0,void 0,{prefix:P.iD.V3})}catch(r){if("M_NOT_FOUND"===r.errcode)return null;throw r}return J.IO.checkBackupVersion(t),t}))()}isKeyBackupTrusted(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto.backupManager.disableKeyBackup()}prepareKeyBackupVersion(e){var t=arguments,r=this;return(0,o.A)((function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{secureSecretStorage:!1};if(!r.crypto)throw new Error("End-to-end encryption disabled");var{algorithm:i,auth_data:o,recovery_key:s,privateKey:a}=yield r.crypto.backupManager.prepareKeyBackupVersion(e);return n.secureSecretStorage&&(yield r.secretStorage.store("m.megolm_backup.v1",(0,O.WG)(a)),r.logger.info("Key backup private key stored in secret storage")),{algorithm:i,auth_data:o,recovery_key:s}}))()}isKeyBackupKeyStored(){return Promise.resolve(this.secretStorage.isStored("m.megolm_backup.v1"))}createKeyBackupVersion(e){var t=this;return(0,o.A)((function*(){if(!t.crypto)throw new Error("End-to-end encryption disabled");yield t.crypto.backupManager.createKeyBackupVersion(e);var r={algorithm:e.algorithm,auth_data:e.auth_data};yield t.crypto.signObject(r.auth_data),t.cryptoCallbacks.getCrossSigningKey&&t.crypto.crossSigningInfo.getId()&&(yield t.crypto.crossSigningInfo.signObject(r.auth_data,"master"));var n=yield t.http.authedRequest(P.IT.Post,"/room_keys/version",void 0,r);return yield t.checkKeyBackup(),t.getKeyBackupEnabled()||t.logger.error("Key backup not usable even though we just created it"),n}))()}deleteKeyBackupVersion(e){var t=this;return(0,o.A)((function*(){if(!t.cryptoBackend)throw new Error("End-to-end encryption disabled");yield t.cryptoBackend.deleteKeyBackupVersion(e)}))()}makeKeyBackupPath(e,t,r){var n;n=void 0!==t?p.RR("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?p.RR("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";var i=void 0===r?void 0:{version:r};return{path:n,queryData:i}}sendKeyBackup(e,t,r,n){var i=this;return(0,o.A)((function*(){if(!i.crypto)throw new Error("End-to-end encryption disabled");var o=i.makeKeyBackupPath(e,t,r);yield i.http.authedRequest(P.IT.Put,o.path,o.queryData,n,{prefix:P.iD.V3})}))()}scheduleAllGroupSessionsForBackup(){var e=this;return(0,o.A)((function*(){if(!e.crypto)throw new Error("End-to-end encryption disabled");yield e.crypto.backupManager.scheduleAllGroupSessionsForBackup()}))()}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return(0,_e.decodeRecoveryKey)(e),!0}catch(t){return!1}}keyBackupKeyFromPassword(e,t){return(0,Je.c)(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return(0,_e.decodeRecoveryKey)(e)}restoreKeyBackupWithPassword(e,t,r,n,i){var s=this;return(0,o.A)((function*(){var o=yield(0,Je.c)(n.auth_data,e);return s.restoreKeyBackup(o,t,r,n,i)}))()}restoreKeyBackupWithSecretStorage(e,t,r,n){var i=this;return(0,o.A)((function*(){if(!i.cryptoBackend)throw new Error("End-to-end encryption disabled");var o=yield i.secretStorage.get("m.megolm_backup.v1"),s=(0,x.D$)(o);if(s){var a=yield i.secretStorage.getKey();yield i.secretStorage.store("m.megolm_backup.v1",s,[a[0]])}var c=(0,O.y4)(s||o);return i.restoreKeyBackup(c,t,r,e,n)}))()}restoreKeyBackupWithRecoveryKey(e,t,r,n,i){var o=(0,_e.decodeRecoveryKey)(e);return this.restoreKeyBackup(o,t,r,n,i)}restoreKeyBackupWithCache(e,t,r,n){var i=this;return(0,o.A)((function*(){if(!i.cryptoBackend)throw new Error("End-to-end encryption disabled");var o=yield i.cryptoBackend.getSessionBackupPrivateKey();if(!o)throw new Error("Couldn't get key");return i.restoreKeyBackup(o,e,t,r,n)}))()}restoreKeyBackup(e,t,r,n,i){var s=this;return(0,o.A)((function*(){var a=null===i||void 0===i?void 0:i.cacheCompleteCallback,c=null===i||void 0===i?void 0:i.progressCallback;if(!s.cryptoBackend)throw new Error("End-to-end encryption disabled");if(!n.version)throw new Error("Backup version must be defined");var l=n.version,d=0,u=0,h=0,v=s.makeKeyBackupPath(t,r,l),p=yield s.cryptoBackend.getBackupDecryptor(n,e),f=!p.sourceTrusted;try{if(!(e instanceof Uint8Array))throw new Error("restoreKeyBackup expects Uint8Array, got ".concat(e));s.cryptoBackend.storeSessionBackupPrivateKey(e,l).catch((e=>{s.logger.warn("Error caching session backup key:",e)})).then(a),c&&c({stage:"fetch"});var m=yield s.http.authedRequest(P.IT.Get,v.path,v.queryData,void 0,{prefix:P.iD.V3});if(c&&c({stage:"load_keys"}),m.rooms)d=s.getTotalKeyCount(m),yield s.handleDecryptionOfAFullBackup(m,p,200,function(){var e=(0,o.A)((function*(e){try{var t=n.version;yield s.cryptoBackend.importBackedUpRoomKeys(e,t,{untrusted:f}),h+=e.length}catch(r){u+=e.length,g.v.error("Error importing keys from backup",r)}c&&c({total:d,successes:h,stage:"load_keys",failures:u})}));return function(t){return e.apply(this,arguments)}}());else if(m.sessions){var y=m.sessions;d=Object.keys(y).length;var S=yield p.decryptSessions(y);for(var b of S)b.room_id=t;yield s.cryptoBackend.importBackedUpRoomKeys(S,l,{progressCallback:c,untrusted:f}),h=S.length}else{d=1;try{var[E]=yield p.decryptSessions({[r]:m});E.room_id=t,E.session_id=r,yield s.cryptoBackend.importBackedUpRoomKeys([E],l,{progressCallback:c,untrusted:f}),h=1}catch(_){s.logger.debug("Failed to decrypt megolm session from backup",_)}}}finally{p.free()}return yield s.cryptoBackend.checkKeyBackupAndEnable(),{total:d,imported:h}}))()}getTotalKeyCount(e){var t=e.rooms,r=0;for(var n of Object.values(t))n.sessions&&(r+=Object.keys(n.sessions).length);return r}handleDecryptionOfAFullBackup(e,t,r,n){return(0,o.A)((function*(){var i=e.rooms,s=0,a=new Map,c=function(){var e=(0,o.A)((function*(e){var r=[];for(var i of e.keys()){var o=yield t.decryptSessions(e.get(i));for(var s in o){var a=o[s];a.room_id=i,r.push(a)}}yield n(r)}));return function(t){return e.apply(this,arguments)}}();for(var[l,d]of Object.entries(i))if(d.sessions)for(var[u,h]of(a.set(l,{}),Object.entries(d.sessions))){var v=a.get(l);v[u]=h,s+=1,s>=r&&(yield c(a),a=new Map,a.set(l,{}),s=0)}s>0&&(yield c(a))}))()}deleteKeysFromBackup(e,t,r){var n=this;return(0,o.A)((function*(){var i=n.makeKeyBackupPath(e,t,r);yield n.http.authedRequest(P.IT.Delete,i.path,i.queryData,void 0,{prefix:P.iD.V3})}))()}getMediaConfig(){return this.http.authedRequest(P.IT.Get,"/config",void 0,void 0,{prefix:P.zs.V3})}getRoom(e){return e?this.store.getRoom(e):null}getRooms(){return this.store.getRooms()}getVisibleRooms(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.store.getRooms(),r=new Set;for(var n of t){var i,o=null===(i=n.findPredecessor(e))||void 0===i?void 0:i.roomId;o&&r.add(o)}return t.filter((e=>{var t=e.currentState.getStateEvents(y.Bx.RoomTombstone,"");return!t||!r.has(e.roomId)}))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t){var r=p.RR("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return(0,P.Y6)(5,(()=>this.http.authedRequest(P.IT.Put,r,void 0,t)))}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){var t=this;return(0,o.A)((function*(){if(t.isInitialSyncComplete()){var r=t.store.getAccountData(e);return r?r.getContent():null}var n=p.RR("/user/$userId/account_data/$type",{$userId:t.credentials.userId,$type:e});try{return yield t.http.authedRequest(P.IT.Get,n)}catch(o){var i;if("M_NOT_FOUND"===(null===(i=o.data)||void 0===i?void 0:i.errcode))return null;throw o}}))()}deleteAccountData(e){var t=this;return(0,o.A)((function*(){var r=t.canSupport.get(be.Xj.AccountDataDeletion);if(r!==be.Tj.Unsupported){var n=p.RR("/user/$userId/account_data/$type",{$userId:t.getSafeUserId(),$type:e}),i=r===be.Tj.Unstable?{prefix:"/_matrix/client/unstable/org.matrix.msc3391"}:void 0;return yield t.http.authedRequest(P.IT.Delete,n,void 0,void 0,i)}yield t.setAccountData(e,{})}))()}getIgnoredUsers(){var e=this.getAccountData(y.Bx.IgnoredUserList);return null!==e&&void 0!==e&&e.getContent()["ignored_users"]?Object.keys(e.getContent()["ignored_users"]):[]}setIgnoredUsers(e){var t={ignored_users:{}};return e.forEach((e=>{t.ignored_users[e]={}})),this.setAccountData(y.Bx.IgnoredUserList,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e){var t=arguments,r=this;return(0,o.A)((function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};void 0===n.syncRoom&&(n.syncRoom=!0);var i=r.getRoom(e);if(null!==i&&void 0!==i&&i.hasMembershipState(r.credentials.userId,Z.O.Join))return i;var o=Promise.resolve();if(n.inviteSignUrl){var s=new URL(n.inviteSignUrl);s.searchParams.set("mxid",r.credentials.userId),o=r.http.requestOtherUrl(P.IT.Post,s)}var c={};n.viaServers&&(c.server_name=n.viaServers,c.via=n.viaServers);var l={},d=yield o;d&&(l.third_party_signed=d);var u=p.RR("/join/$roomid",{$roomid:e}),h=yield r.http.authedRequest(P.IT.Post,u,c,l),v=h.room_id,f=r.getRoom(v);if(null!==f&&void 0!==f&&f.hasMembershipState(r.credentials.userId,Z.O.Join))return f;var g=new a.w_(r,r.clientOpts,r.buildSyncApiOptions()),m=g.createRoom(v);return n.syncRoom,m}))()}knockRoom(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.getRoom(e);if(null!==r&&void 0!==r&&r.hasMembershipState(this.credentials.userId,Z.O.Knock))return Promise.resolve({room_id:r.roomId});var n=p.RR("/knock/$roomIdOrAlias",{$roomIdOrAlias:e}),i={};t.viaServers&&(i.server_name=t.viaServers,i.via=t.viaServers);var o={};return t.reason&&(o.reason=t.reason),this.http.authedRequest(P.IT.Post,n,i,o)}resendEvent(e,t){return this.toDeviceMessageQueue.sendQueue(),this.updatePendingEventStatus(t,e,c.fb.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if(![c.fb.QUEUED,c.fb.NOT_SENT,c.fb.ENCRYPTING].includes(e.status))throw new Error("cannot cancel an event with status "+e.status);e.status===c.fb.ENCRYPTING?this.eventsBeingEncrypted.delete(e.getId()):this.scheduler&&e.status===c.fb.QUEUED&&this.scheduler.removeEventFromQueue(e);var t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,c.fb.CANCELLED)}setRoomName(e,t){return this.sendStateEvent(e,y.Bx.RoomName,{name:t})}setRoomTopic(e,t,r){var n=F.makeTopicContent(t,r);return this.sendStateEvent(e,y.Bx.RoomTopic,n)}getRoomTags(e){var t=p.RR("/user/$userId/rooms/$roomId/tags",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(P.IT.Get,t)}setRoomTag(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=p.RR("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(P.IT.Put,n,void 0,r)}deleteRoomTag(e,t){var r=p.RR("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(P.IT.Delete,r)}setRoomAccountData(e,t,r){var n=p.RR("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(P.IT.Put,n,void 0,r)}setPowerLevel(e,t,r){var n=this;return(0,o.A)((function*(){var i,o,s;n.clientRunning&&n.isInitialSyncComplete()&&(o=null===(s=n.getRoom(e))||void 0===s||null===(s=s.currentState)||void 0===s||null===(s=s.getStateEvents(y.Bx.RoomPowerLevels,""))||void 0===s?void 0:s.getContent());if(!o)try{o=yield n.getStateEvent(e,y.Bx.RoomPowerLevels,"")}catch(l){if(!(l instanceof P.up&&"M_NOT_FOUND"===l.errcode))throw l;o={}}o=p.A4(o),null!==(i=o)&&void 0!==i&&i.users||(o.users={});var a=Array.isArray(t)?t:[t];for(var c of a)null==r?delete o.users[c]:o.users[c]=r;return n.sendStateEvent(e,y.Bx.RoomPowerLevels,o,"")}))()}unstable_createLiveBeacon(e,t){var r=this;return(0,o.A)((function*(){return r.unstable_setLiveBeacon(e,t)}))()}unstable_setLiveBeacon(e,t){var r=this;return(0,o.A)((function*(){return r.sendStateEvent(e,he.E.name,t,r.getUserId())}))()}sendEvent(e,t,r,n,i){var o,s,a,c;return null!==t&&void 0!==t&&t.startsWith(dt)||null===t?(c=i,a=n,s=r,o=t):(c=n,a=r,s=t,o=null),this.addThreadRelationIfNeeded(a,o,e),this.sendCompleteEvent(e,o,{type:s,content:a},c)}addThreadRelationIfNeeded(e,t,r){var n;if(t&&(null===(n=e["m.relates_to"])||void 0===n||!n.rel_type)){var i,o,s=!(null===(i=e["m.relates_to"])||void 0===i||!i["m.in_reply_to"]);e["m.relates_to"]=Xe(Xe({},e["m.relates_to"]),{},{rel_type:ue.RN.name,event_id:t,is_falling_back:!s});var a,c,l=null===(o=this.getRoom(r))||void 0===o?void 0:o.getThread(t);if(l&&!s)e["m.relates_to"]["m.in_reply_to"]={event_id:null!==(a=null===(c=l.lastReply((e=>e.isRelation(ue.RN.name)&&!e.status)))||void 0===c?void 0:c.getId())&&void 0!==a?a:t}}}sendCompleteEvent(e,t,r,n,i){var o,s;"string"===typeof n?s=n:(o=n,s=i),s||(s=this.makeTxnId());var a=new c.kl(Object.assign(r,{event_id:"~"+e+":"+s,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),l=this.getRoom(e),d=t?null===l||void 0===l?void 0:l.getThread(t):void 0;d&&a.setThread(d),o||(this.reEmitter.reEmit(a,[c.OQ.Replaced,c.OQ.VisibilityChange]),null===l||void 0===l||l.reEmitter.reEmit(a,[c.OQ.BeforeRedaction]));var u=a.getAssociatedId();if(null!==u&&void 0!==u&&u.startsWith("~")){var h=null===l||void 0===l?void 0:l.getPendingEvents().find((e=>e.getId()===u));null===h||void 0===h||h.once(c.OQ.LocalEventIdReplaced,(()=>{a.updateAssociatedId(h.getId())}))}var v=a.getType();return this.logger.debug("sendEvent of type ".concat(v," in ").concat(e," with txnId ").concat(s).concat(o?" (delayed event)":"")),a.setTxnId(s),a.setStatus(c.fb.SENDING),o?this.encryptAndSendEvent(l,a,o):(null===l||void 0===l||l.addPendingEvent(a,s),a.status===c.fb.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(l,a))}encryptAndSendEvent(e,t,r){var n=this;return(0,o.A)((function*(){if(r)return n.sendEventHttpRequest(t,r);try{var i;n.eventsBeingEncrypted.add(t.getId());try{yield n.encryptEventIfNeeded(t,null!==e&&void 0!==e?e:void 0)}finally{i=!n.eventsBeingEncrypted.delete(t.getId())}if(i)return{};t.status===c.fb.ENCRYPTING&&n.updatePendingEventStatus(e,t,c.fb.SENDING);var o=null;return n.scheduler&&(o=n.scheduler.queueEvent(t),o&&n.scheduler.getQueueForEvent(t).length>1&&n.updatePendingEventStatus(e,t,c.fb.QUEUED)),o||(o=n.sendEventHttpRequest(t),e&&(o=o.then((r=>(e.updatePendingEvent(t,c.fb.SENT,r["event_id"]),r))))),yield o}catch(s){n.logger.error("Error sending event",s);try{t.error=s,n.updatePendingEventStatus(e,t,c.fb.NOT_SENT)}catch(a){n.logger.error("Exception in error handler!",a)}throw s instanceof P.up&&(s.event=t),s}}))()}encryptEventIfNeeded(e,t){var r=this;return(0,o.A)((function*(){if(t&&(yield r.shouldEncryptEventForRoom(e,t))&&(r.cryptoBackend||!r.usingExternalCrypto)){if(!r.cryptoBackend)throw new Error("This room is configured to use encryption, but your client does not support encryption.");r.updatePendingEventStatus(t,e,c.fb.ENCRYPTING),yield r.cryptoBackend.encryptEvent(e,t)}}))()}shouldEncryptEventForRoom(e,t){var r=this;return(0,o.A)((function*(){var n;return!e.isEncrypted()&&(e.getType()!==y.Bx.Reaction&&(!e.isRedaction()&&(!!t.hasEncryptionStateEvent()||!!(yield null===(n=r.cryptoBackend)||void 0===n?void 0:n.isEncryptionEnabledInRoom(t.roomId)))))}))()}getEncryptedIfNeededEventType(e,t){var r;return t===y.Bx.Reaction?t:null!==(r=this.getRoom(e))&&void 0!==r&&r.hasEncryptionStateEvent()?y.Bx.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e,t){var r=e.getTxnId();r||(r=this.makeTxnId(),e.setTxnId(r));var n,i={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:r};if(e.isState()){var o="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(o="/rooms/$roomId/state/$eventType/$stateKey"),n=p.RR(o,i)}else if(e.isRedaction()&&e.event.redacts){var s="/rooms/$roomId/redact/$redactsEventId/$txnId";n=p.RR(s,Xe({$redactsEventId:e.event.redacts},i))}else n=p.RR("/rooms/$roomId/send/$eventType/$txnId",i);var a=e.getWireContent();return t?this.http.authedRequest(P.IT.Put,n,pt(t),a):this.http.authedRequest(P.IT.Put,n,void 0,a).then((t=>(this.logger.debug("Event sent to ".concat(e.getRoomId()," with event id ").concat(t.event_id)),t)))}redactEvent(e,t,r,n,i){var o,s,a;null!==(o=r)&&void 0!==o&&o.startsWith(dt)||(i=n,n=r,r=t,t=null);var c=null===(s=i)||void 0===s?void 0:s.reason,l={reason:c};if(void 0!==(null===(a=i)||void 0===a?void 0:a.with_rel_types)){if(this.canSupport.get(be.Xj.RelationBasedRedactions)===be.Tj.Unsupported)throw new Error("Server does not support relation based redactions "+"roomId ".concat(e," eventId ").concat(r," txnId: ").concat(n," threadId ").concat(t));var d=this.canSupport.get(be.Xj.RelationBasedRedactions)===be.Tj.Stable?y.Z3.stable:y.Z3.unstable;l[d]=i.with_rel_types}return this.sendCompleteEvent(e,t,{type:y.Bx.RoomRedaction,content:l,redacts:r},n)}sendMessage(e,t,r,n){"string"!==typeof t&&null!==t&&(n=r,r=t,t=null);var i=y.Bx.RoomMessage,o=r;return this.sendEvent(e,t,i,o,n)}sendTextMessage(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(dt)||null===t||(n=r,r=t,t=null);var o=F.makeTextMessage(r);return this.sendMessage(e,t,o,n)}sendNotice(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(dt)||null===t||(n=r,r=t,t=null);var o=F.makeNotice(r);return this.sendMessage(e,t,o,n)}sendEmoteMessage(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(dt)||null===t||(n=r,r=t,t=null);var o=F.makeEmoteMessage(r);return this.sendMessage(e,t,o,n)}sendImageMessage(e,t,r,n){var i,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Image";null!==(i=t)&&void 0!==i&&i.startsWith(dt)||null===t||(o=n||"Image",n=r,r=t,t=null);var s={msgtype:y.Wr.Image,url:r,info:n,body:o};return this.sendMessage(e,t,s)}sendStickerMessage(e,t,r,n){var i,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"Sticker";null!==(i=t)&&void 0!==i&&i.startsWith(dt)||null===t||(o=n||"Sticker",n=r,r=t,t=null);var s={url:r,info:n,body:o};return this.sendEvent(e,t,y.Bx.Sticker,s)}sendHtmlMessage(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(dt)||null===t||(n=r,r=t,t=null);var o=F.makeHtmlMessage(r,n);return this.sendMessage(e,t,o)}sendHtmlNotice(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(dt)||null===t||(n=r,r=t,t=null);var o=F.makeHtmlNotice(r,n);return this.sendMessage(e,t,o)}sendHtmlEmote(e,t,r,n){var i;null!==(i=t)&&void 0!==i&&i.startsWith(dt)||null===t||(n=r,r=t,t=null);var o=F.makeHtmlEmote(r,n);return this.sendMessage(e,t,o)}_unstable_sendDelayedEvent(e,t,r,n,i,s){var a=this;return(0,o.A)((function*(){if(!(yield a.doesServerSupportUnstableFeature(ct)))throw Error("Server does not support the delayed events API");return a.addThreadRelationIfNeeded(i,r,e),a.sendCompleteEvent(e,r,{type:n,content:i},t,s)}))()}_unstable_sendDelayedStateEvent(e,t,r,n){var i=arguments,s=this;return(0,o.A)((function*(){var o=i.length>4&&void 0!==i[4]?i[4]:"",a=i.length>5&&void 0!==i[5]?i[5]:{};if(!(yield s.doesServerSupportUnstableFeature(ct)))throw Error("Server does not support the delayed events API");var c={$roomId:e,$eventType:r,$stateKey:o},l=p.RR("/rooms/$roomId/state/$eventType",c);return void 0!==o&&(l=p.RR(l+"/$stateKey",c)),s.http.authedRequest(P.IT.Put,l,pt(t),n,a)}))()}_unstable_getDelayedEvents(e){var t=this;return(0,o.A)((function*(){if(!(yield t.doesServerSupportUnstableFeature(ct)))throw Error("Server does not support the delayed events API");var r=e?{from:e}:void 0;return yield t.http.authedRequest(P.IT.Get,"/delayed_events",r,void 0,{prefix:"".concat(P.iD.Unstable,"/").concat(ct)})}))()}_unstable_updateDelayedEvent(e,t){var r=this;return(0,o.A)((function*(){if(!(yield r.doesServerSupportUnstableFeature(ct)))throw Error("Server does not support the delayed events API");var n=p.RR("/delayed_events/$delayId",{$delayId:e}),i={action:t};return yield r.http.authedRequest(P.IT.Post,n,void 0,i,{prefix:"".concat(P.iD.Unstable,"/").concat(ct)})}))()}sendReceipt(e,t,r){var n=arguments,i=this;return(0,o.A)((function*(){var o=n.length>3&&void 0!==n[3]&&n[3];if(i.isGuest())return Promise.resolve({});var s=p.RR("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),a=!o&&i.supportsThreads(),c=a?Xe(Xe({},r),{},{thread_id:gt(e)}):r,l=i.http.authedRequest(P.IT.Post,s,void 0,c||{}),d=i.getRoom(e.getRoomId());return d&&i.credentials.userId&&d.addLocalEchoReceipt(i.credentials.userId,e,t,o),l}))()}sendReadReceipt(e){var t=arguments,r=this;return(0,o.A)((function*(){var n=t.length>1&&void 0!==t[1]?t[1]:le.L.Read,i=t.length>2&&void 0!==t[2]&&t[2];if(e){var o=e.getId(),s=r.getRoom(e.getRoomId());if(null!==s&&void 0!==s&&s.hasPendingEvent(o))throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));return r.sendReceipt(e,n,{},i)}}))()}setRoomReadMarkers(e,t,r,n){var i=this;return(0,o.A)((function*(){var o,s,a=i.getRoom(e);if(null!==a&&void 0!==a&&a.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event (".concat(t,")"));if(r){if(o=r.getId(),null!==a&&void 0!==a&&a.hasPendingEvent(o))throw new Error("Cannot set read receipt to a pending event (".concat(o,")"));null===a||void 0===a||a.addLocalEchoReceipt(i.credentials.userId,r,le.L.Read)}if(n){if(s=n.getId(),null!==a&&void 0!==a&&a.hasPendingEvent(s))throw new Error("Cannot set read receipt to a pending event (".concat(s,")"));null===a||void 0===a||a.addLocalEchoReceipt(i.credentials.userId,n,le.L.ReadPrivate)}return yield i.setRoomReadMarkersHttpRequest(e,t,o,s)}))()}getUrlPreview(e,t){t=6e4*Math.floor(t/6e4);var r=new URL(e);r.hash="",e=r.toString();var n=t+"_"+e;if(n in this.urlPreviewCache)return this.urlPreviewCache[n];var i=this.http.authedRequest(P.IT.Get,"/preview_url",{url:e,ts:t.toString()},void 0,{prefix:P.zs.V3,priority:"low"});return this.urlPreviewCache[n]=i,i}sendTyping(e,t,r){if(this.isGuest())return Promise.resolve({});var n=p.RR("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.getUserId()}),i={typing:t};return t&&(i.timeout=r||2e4),this.http.authedRequest(P.IT.Put,n,void 0,i)}getRoomUpgradeHistory(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getRoom(e);if(!n)return[];var i=this.findPredecessorRooms(n,t,r),o=this.findSuccessorRooms(n,t,r);return[...i,n,...o]}findPredecessorRooms(e,t,r){var n,i=[],o=new Set([e.roomId]),s=null===(n=e.findPredecessor(r))||void 0===n?void 0:n.roomId;while(null!==s){var a;if(s){if(o.has(s))break;o.add(s)}var c=this.getRoom(s);if(null===c)break;if(t){var l=c.currentState.getStateEvents(y.Bx.RoomTombstone,"");if(!l||l.getContent()["replacement_room"]!==e.roomId)break}i.splice(0,0,c),e=c,s=null===(a=e.findPredecessor(r))||void 0===a?void 0:a.roomId}return i}findSuccessorRooms(e,t,r){var n=[],i=e.currentState.getStateEvents(y.Bx.RoomTombstone,"");while(i){var o=this.getRoom(i.getContent()["replacement_room"]);if(!o)break;if(o.roomId===e.roomId)break;if(t){var s,a=null===(s=o.findPredecessor(r))||void 0===s?void 0:s.roomId;if(!a||a!==e.roomId)break}n.push(o);var c=new Set(n.map((e=>e.roomId)));if(c.size<n.length)return n.slice(0,n.length-1);e=o,i=e.currentState.getStateEvents(y.Bx.RoomTombstone,"")}return n}invite(e,t,r){return this.membershipChange(e,t,Z.O.Invite,r)}inviteByEmail(e,t){return this.inviteByThreePid(e,"email",t)}inviteByThreePid(e,t,r){var n=this;return(0,o.A)((function*(){var i,o=p.RR("/rooms/$roomId/invite",{$roomId:e}),s=n.getIdentityServerUrl(!0);if(!s)return Promise.reject(new P.up({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));var a={id_server:s,medium:t,address:r};if(null!==(i=n.identityServer)&&void 0!==i&&i.getAccessToken){var c=yield n.identityServer.getAccessToken();c&&(a["id_access_token"]=c)}return n.http.authedRequest(P.IT.Post,o,void 0,a)}))()}leave(e){return this.membershipChange(e,void 0,Z.O.Leave)}leaveRoomChain(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=this.getRoomUpgradeHistory(e),n=r;if(!t)for(var i of(n=[],r))if(n.push(i),i.roomId===e)break;var o={},s=[],a=e=>this.leave(e).then((()=>{delete o[e]})).catch((t=>{o[e]=t}));for(var c of n)s.push(a(c.roomId));return Promise.all(s).then((()=>o))}ban(e,t,r){return this.membershipChange(e,t,Z.O.Ban,r)}forget(e){var t=arguments,r=this;return(0,o.A)((function*(){var n=!(t.length>1&&void 0!==t[1])||t[1],i=p.RR("/rooms/$room_id/forget",{$room_id:e}),o=yield r.http.authedRequest(P.IT.Post,i);return n&&(r.store.removeRoom(e),r.emit(ut.DeleteRoom,e)),o}))()}unban(e,t){var r=p.RR("/rooms/$roomId/unban",{$roomId:e}),n={user_id:t};return this.http.authedRequest(P.IT.Post,r,void 0,n)}kick(e,t,r){var n=p.RR("/rooms/$roomId/kick",{$roomId:e}),i={user_id:t,reason:r};return this.http.authedRequest(P.IT.Post,n,void 0,i)}membershipChange(e,t,r,n){var i=p.RR("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(P.IT.Post,i,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.getPushActions()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushActions()}getPushDetailsForEvent(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!e.getPushDetails()||t){var{actions:r,rule:n}=this.pushProcessor.actionsAndRuleForEvent(e);e.setPushDetails(r,n)}return e.getPushDetails()}setProfileInfo(e,t){var r=p.RR("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(P.IT.Put,r,void 0,t)}setDisplayName(e){var t=this;return(0,o.A)((function*(){var r=yield t.setProfileInfo("displayname",{displayname:e}),n=t.getUser(t.getUserId());return n&&(n.displayName=e,n.emit(U.U.DisplayName,n.events.presence,n)),r}))()}setAvatarUrl(e){var t=this;return(0,o.A)((function*(){var r=yield t.setProfileInfo("avatar_url",{avatar_url:e}),n=t.getUser(t.getUserId());return n&&(n.avatarUrl=e,n.emit(U.U.AvatarUrl,n.events.presence,n)),r}))()}mxcUrlToHttp(e,t,r,n,i,o,s){return(0,L.y)(this.baseUrl,e,t,r,n,i,o,s)}setSyncPresence(e){var t=this;return(0,o.A)((function*(){var r;null===(r=t.syncApi)||void 0===r||r.setPresence(e)}))()}setPresence(e){var t=this;return(0,o.A)((function*(){var r=p.RR("/presence/$userId/status",{$userId:t.credentials.userId}),n=["offline","online","unavailable"];if(-1===n.indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);yield t.http.authedRequest(P.IT.Put,r,void 0,e)}))()}getPresence(e){var t=p.RR("/presence/$userId/status",{$userId:e});return this.http.authedRequest(P.IT.Get,t)}scrollback(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,r=0,n=this.ongoingScrollbacks[e.roomId]||{};if(n.promise)return n.promise;if(n.errorTs){var i=Date.now()-n.errorTs;r=Math.max(Ze-i,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);var o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;var s=new Promise(((n,i)=>{(0,p.yy)(r).then((()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,f.O.Backward))).then((t=>{var r,i,o=t.chunk.map(this.getEventMapper());if(t.state){var s=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(s)}var[a,c,l]=e.partitionThreadedEvents(o);this.processAggregatedTimelineEvents(e,a),e.addEventsToTimeline(a,!0,!0,e.getLiveTimeline()),this.processThreadEvents(e,c,!0),l.forEach((t=>e.relations.aggregateChildEvent(t))),e.oldState.paginationToken=null!==(r=t.end)&&void 0!==r?r:null,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,o,null!==(i=t.end)&&void 0!==i?i:null,!0),delete this.ongoingScrollbacks[e.roomId],n(e)})).catch((t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},i(t)}))}));return n={promise:s},this.ongoingScrollbacks[e.roomId]=n,s}getEventMapper(e){return H(this,e||{})}getEventTimeline(e,t){var r=this;return(0,o.A)((function*(){var n,i,o,s;if(!r.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(null===e||void 0===e||!e.room)throw new Error("getEventTimeline only supports room timelines");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);if(e.thread&&r.supportsThreads())return r.getThreadTimeline(e,t);var a=p.RR("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),c=void 0;null!==(n=r.clientOpts)&&void 0!==n&&n.lazyLoadMembers&&(c={filter:JSON.stringify(u.d.LAZY_LOADING_MESSAGES_FILTER)});var l=yield r.http.authedRequest(P.IT.Get,a,c);if(!l.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);var d=r.getEventMapper(),h=d(l.event);if(!h.isRelation(ue.RN.name)){var v=[...l.events_after.reverse().map(d),h,...l.events_before.map(d)],g=e.getTimelineForEvent(v[0].getId());g?g.getState(f.q.BACKWARDS).setUnknownStateEvents(l.state.map(d)):(g=e.addTimeline(),g.initialiseState(l.state.map(d)),g.getState(f.q.FORWARDS).paginationToken=l.end);var[m,y,S]=e.room.partitionThreadedEvents(v);return e.addEventsToTimeline(m,!0,!1,g,l.start),r.processThreadEvents(e.room,y,!0),r.processAggregatedTimelineEvents(e.room,m),S.forEach((t=>e.relations.aggregateChildEvent(t))),null!==(i=null!==(o=e.getTimelineForEvent(t))&&void 0!==o?o:null===(s=e.room.findThreadForEvent(h))||void 0===s?void 0:s.liveTimeline)&&void 0!==i?i:g}r.logger.warn("Tried loading a regular timeline at the position of a thread event")}))()}getThreadTimeline(e,t){var r=this;return(0,o.A)((function*(){var n;if(!r.supportsThreads())throw new Error("could not get thread timeline: no client support");if(!e.room)throw new Error("could not get thread timeline: not a room timeline");if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var i=p.RR("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),o={limit:"0"};null!==(n=r.clientOpts)&&void 0!==n&&n.lazyLoadMembers&&(o.filter=JSON.stringify(u.d.LAZY_LOADING_MESSAGES_FILTER));var s=yield r.http.authedRequest(P.IT.Get,i,o),a=r.getEventMapper(),c=a(s.event);if(e.canContain(c)){var l=r.canSupport.get(be.Xj.RelationsRecursion)!==be.Tj.Unsupported;if(ue.jV.hasServerSideSupport){if(ue.jV.hasServerSideFwdPaginationSupport){var d,h,v;if(!e.thread)throw new Error("could not get thread timeline: not a thread timeline");var g=e.thread,m=yield r.fetchRelations(e.room.roomId,g.id,null,null,{dir:f.O.Backward,from:s.start,recurse:l||void 0}),y=yield r.fetchRelations(e.room.roomId,g.id,null,null,{dir:f.O.Forward,from:s.end,recurse:l||void 0}),S=[...y.chunk.reverse().filter(We(g.id)).map(a),c,...m.chunk.filter(We(g.id)).map(a)];for(var b of S){var E;yield null===(E=e.thread)||void 0===E?void 0:E.processEvent(b)}var _=e.getTimelineForEvent(c.getId());if(_?_.getState(f.q.BACKWARDS).setUnknownStateEvents(s.state.map(a)):(_=e.addTimeline(),_.initialiseState(s.state.map(a))),e.addEventsToTimeline(S,!0,!1,_,y.next_batch),!m.next_batch){var w=yield r.fetchRoomEvent(e.room.roomId,g.id);e.addEventsToTimeline([a(w)],!0,!1,_,null)}return _.setPaginationToken(null!==(d=m.next_batch)&&void 0!==d?d:null,f.O.Backward),_.setPaginationToken(null!==(h=y.next_batch)&&void 0!==h?h:null,f.O.Forward),r.processAggregatedTimelineEvents(e.room,S),null!==(v=e.getTimelineForEvent(t))&&void 0!==v?v:_}var I,T=e.thread,R=yield r.fetchRelations(e.room.roomId,T.id,ue.RN.name,null,{dir:f.O.Backward,from:s.start,recurse:l||void 0}),k=[],A=s.end;while(A){var C,O=yield r.fetchRelations(e.room.roomId,T.id,ue.RN.name,null,{dir:f.O.Forward,from:A,recurse:l||void 0});A=null!==(C=O.next_batch)&&void 0!==C?C:null,k.push(...O.chunk)}var D=[...k.reverse().map(a),c,...R.chunk.map(a)];for(var M of D){var x;yield null===(x=e.thread)||void 0===x?void 0:x.processEvent(M)}var U=e.getLiveTimeline();if(U.getState(f.q.BACKWARDS).setUnknownStateEvents(s.state.map(a)),e.addEventsToTimeline(D,!0,!1,U,null),!R.next_batch){var L=yield r.fetchRoomEvent(e.room.roomId,T.id);e.addEventsToTimeline([a(L)],!0,!1,U,null)}return U.setPaginationToken(null!==(I=R.next_batch)&&void 0!==I?I:null,f.O.Backward),U.setPaginationToken(null,f.O.Forward),r.processAggregatedTimelineEvents(e.room,D),U}}}))()}getLatestTimeline(e){var t=this;return(0,o.A)((function*(){if(!t.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(!e.room)throw new Error("getLatestTimeline only supports room timelines");var r;if(null!==e.threadListType){var n,i=yield t.createThreadListMessagesRequest(e.room.roomId,null,1,f.O.Backward,e.threadListType,e.getFilter());r=null===(n=i.chunk)||void 0===n?void 0:n[0]}else if(e.thread&&ue.jV.hasServerSideSupport){var o,s=t.canSupport.get(be.Xj.RelationsRecursion)!==be.Tj.Unsupported,a=yield t.fetchRelations(e.room.roomId,e.thread.id,ue.RN.name,null,{dir:f.O.Backward,limit:1,recurse:s||void 0});r=null===(o=a.chunk)||void 0===o?void 0:o[0]}else{var c,l,d=p.RR("/rooms/$roomId/messages",{$roomId:e.room.roomId}),h={dir:"b"};null!==(c=t.clientOpts)&&void 0!==c&&c.lazyLoadMembers&&(h.filter=JSON.stringify(u.d.LAZY_LOADING_MESSAGES_FILTER));var v=yield t.http.authedRequest(P.IT.Get,d,h);r=null===(l=v.chunk)||void 0===l?void 0:l[0]}if(!r)throw new Error("No message returned when trying to construct getLatestTimeline");return t.getEventTimeline(e,r.event_id)}))()}createMessagesRequest(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,s=p.RR("/rooms/$roomId/messages",{$roomId:e}),a={limit:n.toString(),dir:i};t&&(a.from=t);var c,l=null;(null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(l=Object.assign({},u.d.LAZY_LOADING_MESSAGES_FILTER)),o)&&(l=l||{},Object.assign(l,null===(c=o.getRoomTimelineFilterComponent())||void 0===c?void 0:c.toJSON()));return l&&(a.filter=JSON.stringify(l)),this.http.authedRequest(P.IT.Get,s,a)}createThreadListMessagesRequest(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:30,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:f.O.Backward,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ue.x3.All,s=arguments.length>5?arguments[5]:void 0,a=p.RR("/rooms/$roomId/threads",{$roomId:e}),c={limit:n.toString(),dir:i,include:(0,ue.UR)(o)};t&&(c.from=t);var l,d={};(null!==(r=this.clientOpts)&&void 0!==r&&r.lazyLoadMembers&&(d=Xe({},u.d.LAZY_LOADING_MESSAGES_FILTER)),s)&&(d=Xe(Xe({},d),null===(l=s.getRoomTimelineFilterComponent())||void 0===l?void 0:l.toJSON()));Object.keys(d).length&&(c.filter=JSON.stringify(d));var h={prefix:ue.jV.hasServerSideListSupport===ue.c1.Stable?P.iD.V1:"/_matrix/client/unstable/org.matrix.msc3856"};return this.http.authedRequest(P.IT.Get,a,c,void 0,h).then((e=>{var t;return Xe(Xe({},e),{},{chunk:null===(t=e.chunk)||void 0===t?void 0:t.reverse(),start:e.prev_batch,end:e.next_batch})}))}paginateEventTimeline(e,t){var r=this,n=e.getTimelineSet()===this.notifTimelineSet,i=this.getRoom(e.getRoomId()),s=e.getTimelineSet().threadListType,a=e.getTimelineSet().thread;t=t||{};var c=t.backwards||!1;if(n&&!c)throw new Error("paginateNotifTimeline can only paginate backwards");var l,d,u,h,v=c?f.q.BACKWARDS:f.q.FORWARDS,g=e.getPaginationToken(v),m=e.paginationRequests[v];if(m)return m;if(n)l="/notifications",d={limit:(null!==(h=t.limit)&&void 0!==h?h:30).toString(),only:"highlight"},g&&"end"!==g&&(d.from=g),u=this.http.authedRequest(P.IT.Get,l,d).then(function(){var t=(0,o.A)((function*(t){var n=t.next_token,i=[];t.notifications=t.notifications.filter(p.O5);for(var o=0;o<t.notifications.length;o++){var s=t.notifications[o],a=r.getEventMapper()(s.event);r.getPushDetailsForEvent(a,!0),a.event.room_id=s.room_id,i[o]=a}var l=e.getTimelineSet();return l.addEventsToTimeline(i,c,!1,e,n),r.processAggregatedTimelineEvents(l.room,i),c&&!t.next_token&&e.setPaginationToken(null,v),Boolean(t.next_token)}));return function(e){return t.apply(this,arguments)}}()).finally((()=>{e.paginationRequests[v]=null})),e.paginationRequests[v]=u;else if(null!==s){if(!i)throw new Error("Unknown room "+e.getRoomId());if(!ue.jV.hasServerSideFwdPaginationSupport&&v===f.O.Forward)throw new Error("Cannot paginate threads forwards without server-side support for MSC 3715");u=this.createThreadListMessagesRequest(e.getRoomId(),g,t.limit,v,s,e.getFilter()).then((t=>{if(t.state){var r=e.getState(v),n=t.state.filter(p.O5).map(this.getEventMapper());r.setUnknownStateEvents(n)}var o=t.end,s=t.chunk.filter(p.O5).map(this.getEventMapper()),a=e.getTimelineSet();return a.addEventsToTimeline(s,c,!1,e,o),this.processAggregatedTimelineEvents(i,s),this.processThreadRoots(i,s,c),c&&t.end==t.start&&e.setPaginationToken(null,v),t.end!==t.start})).finally((()=>{e.paginationRequests[v]=null})),e.paginationRequests[v]=u}else if(a){var y,S,b=this.getRoom(null!==(y=e.getRoomId())&&void 0!==y?y:void 0);if(!b)throw new Error("Unknown room "+e.getRoomId());var E=this.canSupport.get(be.Xj.RelationsRecursion)!==be.Tj.Unsupported;u=this.fetchRelations(null!==(S=e.getRoomId())&&void 0!==S?S:"",a.id,null,null,{dir:v,limit:t.limit,from:null!==g&&void 0!==g?g:void 0,recurse:E||void 0}).then(function(){var t=(0,o.A)((function*(t){var n=r.getEventMapper(),i=t.chunk.filter(p.O5).filter(We(a.id)).map(n);for(var o of i.slice().reverse()){yield null===a||void 0===a?void 0:a.processEvent(o);var s=o.getSender();c&&null!==(null===a||void 0===a?void 0:a.getEventReadUpTo(s))||b.addLocalEchoReceipt(s,o,le.L.Read)}var l=t.next_batch,d=e.getTimelineSet();if(d.addEventsToTimeline(i,c,!1,e,null!==l&&void 0!==l?l:null),!l&&c){var u,h,f=null!==(u=a.rootEvent)&&void 0!==u?u:n(yield r.fetchRoomEvent(null!==(h=e.getRoomId())&&void 0!==h?h:"",a.id));d.addEventsToTimeline([f],!0,!1,e,null)}return r.processAggregatedTimelineEvents(d.room,i),c&&!l&&e.setPaginationToken(null,v),Boolean(l)}));return function(e){return t.apply(this,arguments)}}()).finally((()=>{e.paginationRequests[v]=null})),e.paginationRequests[v]=u}else{if(!i)throw new Error("Unknown room "+e.getRoomId());u=this.createMessagesRequest(e.getRoomId(),g,t.limit,v,e.getFilter()).then((t=>{if(t.state){var r=e.getState(v),n=t.state.filter(p.O5).map(this.getEventMapper());r.setUnknownStateEvents(n)}var o=t.end,s=t.chunk.filter(p.O5).map(this.getEventMapper()),a=e.getTimelineSet(),[l,,d]=i.partitionThreadedEvents(s);a.addEventsToTimeline(l,c,!1,e,o),this.processAggregatedTimelineEvents(i,l),this.processThreadRoots(i,l.filter((e=>e.getServerAggregatedRelation(ue.RN.name))),!1),d.forEach((e=>i.relations.aggregateChildEvent(e)));var u=void 0===t.end||t.end===t.start;return c&&u&&e.setPaginationToken(null,v),!u})).finally((()=>{e.paginationRequests[v]=null})),e.paginationRequests[v]=u}return u}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end")}peekInRoom(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20;return null===(t=this.peekSync)||void 0===t||t.stopPeeking(),this.peekSync=new a.w_(this,this.clientOpts,this.buildSyncApiOptions()),this.peekSync.peek(e,r)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){var r=this.sendStateEvent(e,y.Bx.RoomGuestAccess,{guest_access:t.allowJoin?V.rF.CanJoin:V.rF.Forbidden},""),n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,y.Bx.RoomHistoryVisibility,{history_visibility:V.Jv.WorldReadable},"")),Promise.all([n,r]).then()}requestRegisterEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestRegisterMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestAdd3pidEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestAdd3pidMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestPasswordEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestPasswordMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestTokenFromEndpoint(e,t){var r=this;return(0,o.A)((function*(){var n=Object.assign({},t);return r.http.request(P.IT.Post,e,void 0,n)}))()}getRoomPushRule(e,t){var r;if(this.pushRules)return null===(r=this.pushRules[e])||void 0===r||null===(r=r.room)||void 0===r?void 0:r.find((e=>e.rule_id===t));throw new Error("SyncApi.sync() must be done before accessing to push rules.")}setRoomMutePushRule(e,t,r){var n,i=!1,o=this.getRoomPushRule(e,t);if(null!==o&&void 0!==o&&o.actions.includes(m.YU.DontNotify)&&(i=!0),r)if(o){if(!i){var s=p.v6();this.deletePushRule(e,m.Ji.RoomSpecific,o.rule_id).then((()=>{this.addPushRule(e,m.Ji.RoomSpecific,t,{actions:[m.YU.DontNotify]}).then((()=>{s.resolve()})).catch((e=>{s.reject(e)}))})).catch((e=>{s.reject(e)})),n=s.promise}}else n=this.addPushRule(e,m.Ji.RoomSpecific,t,{actions:[m.YU.DontNotify]});else i&&(n=this.deletePushRule(e,m.Ji.RoomSpecific,o.rule_id));if(n)return new Promise(((e,t)=>{n.then((()=>{this.getPushRules().then((t=>{this.pushRules=t,e()})).catch((e=>{t(e)}))})).catch((e=>{this.getPushRules().then((r=>{this.pushRules=r,t(e)})).catch((r=>{t(e)}))}))}))}searchMessageText(e){var t={search_term:e.query};return"keys"in e&&(t.keys=e.keys),this.search({body:{search_categories:{room_events:t}}})}searchRoomEvents(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:oe.g.Recent,event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then((e=>this.processRoomEventsSearch(r,e)))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t,e.abortSignal).then((t=>this.processRoomEventsSearch(e,t))).finally((()=>{e.pendingRequest=void 0}));return e.pendingRequest=r,r}processRoomEventsSearch(e,t){var r,n,i=t.search_categories.room_events;e.count=i.count,e.next_batch=i.next_batch;var o=new Set(i.highlights);e.highlights.forEach((e=>{o.add(e)})),e.highlights=Array.from(o);for(var s=this.getEventMapper(),a=null!==(r=null===(n=i.results)||void 0===n?void 0:n.length)&&void 0!==r?r:0,c=0;c<a;c++){var l=N.q.fromJson(i.results[c],s),d=this.getRoom(l.context.getEvent().getRoomId());if(d)for(var u of l.context.getTimeline())u.setMetadata(d.currentState,!1);e.results.push(l)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;var e=new a.w_(this,this.clientOpts,this.buildSyncApiOptions());return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then((()=>{this.logger.debug("Marking success of sync left room request"),this.syncedLeftRooms=!0})).finally((()=>{this.syncLeftRoomsPromise=void 0})),this.syncLeftRoomsPromise}createFilter(e){var t=p.RR("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(P.IT.Post,t,void 0,e).then((t=>{var r=u.d.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(r),r}))}getFilter(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return Promise.resolve(n)}var i=p.RR("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(P.IT.Get,i).then((r=>{var n=u.d.fromJson(e,t,r);return this.store.storeFilter(n),n}))}getOrCreateFilter(e,t){var r=this;return(0,o.A)((function*(){var n,i=r.store.getFilterIdByName(e);if(i){try{var o=yield r.getFilter(r.credentials.userId,i,!0);if(o){var s=o.getDefinition(),a=t.getDefinition();p.ky(s,a)&&(n=i)}}catch(l){if("M_UNKNOWN"!==l.errcode&&"M_NOT_FOUND"!==l.errcode)throw l}n||r.store.setFilterIdByName(e,void 0)}if(n)return n;var c=yield r.createFilter(t.getDefinition());return r.store.setFilterIdByName(e,c.filterId),c.filterId}))()}getOpenIdToken(){var e=p.RR("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(P.IT.Post,e,void 0,{})}turnServer(){return this.http.authedRequest(P.IT.Get,"/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}get pollingTurnServers(){return void 0!==this.checkTurnServersIntervalID}checkTurnServers(){var e=this;return(0,o.A)((function*(){if(e.canSupportVoip){var t=!1,r=e.turnServersExpiry-Date.now();if(r>tt)e.logger.debug("TURN creds are valid for another "+r+" ms: not fetching new ones."),t=!0;else{e.logger.debug("Fetching new TURN credentials");try{var n=yield e.turnServer();if(n.uris){e.logger.debug("Got TURN URIs: "+n.uris+" refresh in "+n.ttl+" secs");var i={urls:n.uris,username:n.username,credential:n.password};e.turnServers=[i],e.turnServersExpiry=Date.now()+1e3*n.ttl,t=!0,e.emit(ut.TurnServers,e.turnServers)}}catch(o){e.logger.error("Failed to get TURN URIs",o),403===o.httpStatus?(e.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==e.checkTurnServersIntervalID&&globalThis.clearInterval(e.checkTurnServersIntervalID),e.checkTurnServersIntervalID=void 0,e.emit(ut.TurnServersError,o,!0)):e.emit(ut.TurnServersError,o,!1)}}return t}}))()}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){var e=p.RR("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(P.IT.Get,e,void 0,void 0,{prefix:""}).then((e=>e.admin))}whoisSynapseUser(e){var t=p.RR("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(P.IT.Get,t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){var t=p.RR("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(P.IT.Post,t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){var e=this;return(0,o.A)((function*(){var t;e.clientWellKnownPromise=C.MN.getRawClientConfig(null!==(t=e.getDomain())&&void 0!==t?t:void 0),e.clientWellKnown=yield e.clientWellKnownPromise,e.emit(ut.ClientWellKnown,e.clientWellKnown)}))()}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){if(!this.clientRunning)throw new Error("Client is not running");return this.clientWellKnownPromise}storeClientOptions(){var e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter((t=>{var[r,n]=t;return e.includes(typeof n)})).reduce(((e,t)=>{var[r,n]=t;return e[r]=n,e}),{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){var t=this;return(0,o.A)((function*(){var r,n,i=yield t.doesServerSupportUnstableFeature(ot),o=yield t.doesServerSupportUnstableFeature(st),s=yield t.doesServerSupportUnstableFeature(at);if(!i&&!o&&!s)throw Error("Server does not support the Mutual Rooms API");s?(r="/uk.half-shot.msc2666/user/mutual_rooms",n={user_id:e}):(r=p.RR("/uk.half-shot.msc2666/user/".concat(o?"mutual_rooms":"shared_rooms","/$userId"),{$userId:e}),n={});var a=[],c=null;do{var l={};null!=c&&s&&(l["batch_token"]=c);var d=yield t.http.authedRequest(P.IT.Get,r,Xe(Xe({},n),l),void 0,{prefix:P.iD.Unstable});a.push(...d.joined),c=void 0!==d.next_batch_token?d.next_batch_token:null}while(null!=c);return a}))()}getVersions(){var e=this;return(0,o.A)((function*(){if(e.serverVersionsPromise)return e.serverVersionsPromise;e.serverVersionsPromise=e.http.authedRequest(P.IT.Get,"/_matrix/client/versions",void 0,void 0,{prefix:""}).catch((t=>{throw e.serverVersionsPromise=void 0,t}));var t=yield e.serverVersionsPromise;return e.canSupport=yield(0,be.yk)(t),e.serverVersionsPromise}))()}isVersionSupported(e){var t=this;return(0,o.A)((function*(){var{versions:r}=yield t.getVersions();return r&&r.includes(e)}))()}doesServerSupportUnstableFeature(e){var t=this;return(0,o.A)((function*(){var r=yield t.getVersions();if(!r)return!1;var n=r["unstable_features"];return n&&!!n[e]}))()}doesServerForceEncryptionForPreset(e){var t=this;return(0,o.A)((function*(){var r=yield t.getVersions();if(!r)return!1;var n=r["unstable_features"],i=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return n&&!!n["io.element.e2ee_forced.".concat(i)]}))()}doesServerSupportThread(){var e=this;return(0,o.A)((function*(){if(yield e.isVersionSupported("v1.4"))return{threads:ue.c1.Stable,list:ue.c1.Stable,fwdPagination:ue.c1.Stable};try{var[t,r,n,i,o,s]=yield Promise.all([e.doesServerSupportUnstableFeature("org.matrix.msc3440"),e.doesServerSupportUnstableFeature("org.matrix.msc3440.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3856"),e.doesServerSupportUnstableFeature("org.matrix.msc3856.stable"),e.doesServerSupportUnstableFeature("org.matrix.msc3715"),e.doesServerSupportUnstableFeature("org.matrix.msc3715.stable")]);return{threads:(0,ue.FD)(r,t),list:(0,ue.FD)(i,n),fwdPagination:(0,ue.FD)(s,o)}}catch(a){return{threads:ue.c1.None,list:ue.c1.None,fwdPagination:ue.c1.None}}}))()}hasLazyLoadMembersEnabled(){var e;return!(null===(e=this.clientOpts)||void 0===e||!e.lazyLoadMembers)}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,r,n){var i=arguments,s=this;return(0,o.A)((function*(){var o,a,c=i.length>4&&void 0!==i[4]?i[4]:{dir:f.O.Backward},l=n?s.getEncryptedIfNeededEventType(e,n):null,[d,u]=yield Promise.all([s.fetchRoomEvent(e,t),s.fetchRelations(e,t,r,l,c)]),h=s.getEventMapper(),v=d?h(d):void 0,p=u.chunk.map(h);if(l===y.Bx.RoomMessageEncrypted){var g=v?p.concat(v):p;yield Promise.all(g.map((e=>s.decryptEventIfNeeded(e)))),null!==n&&(p=p.filter((e=>e.getType()===n)))}return v&&r===y.zZ.Replace&&(p=p.filter((e=>e.getSender()===v.getSender()))),{originalEvent:null!==v&&void 0!==v?v:null,events:p,nextBatch:null!==(o=u.next_batch)&&void 0!==o?o:null,prevBatch:null!==(a=u.prev_batch)&&void 0!==a?a:null}}))()}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e.crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return(0,$.US)(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&this.isCryptoEnabled()&&e.attemptDecryption(this.cryptoBackend,t),e.isBeingDecrypted()?e.getDecryptionPromise():Promise.resolve()}termsUrlForService(e,t){switch(e){case M.S.IS:return this.http.getUrl("/terms",void 0,P.Pw.V2,t);case M.S.IM:return this.http.getUrl("/terms",void 0,"/_matrix/integrations/v1",t);default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(){var e,t,r=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return r&&(null!==(e=this.idBaseUrl)&&void 0!==e&&e.startsWith("http://")||null!==(t=this.idBaseUrl)&&void 0!==t&&t.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=p.hc(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}getRefreshToken(){var e;return null!==(e=this.http.opts.refreshToken)&&void 0!==e?e:null}setAccessToken(e){this.http.opts.accessToken=e,this.serverVersionsPromise=void 0}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(P.IT.Get,"/register/available",{username:e}).then((e=>e.available)).catch((e=>"M_USER_IN_USE"!==e.errcode&&Promise.reject(e)))}register(e,t,r,n,i,o,s){r&&(n.session=r);var a={auth:n,refresh_token:!0};return void 0!==e&&null!==e&&(a.username=e),void 0!==t&&null!==t&&(a.password=t),void 0!==o&&null!==o&&(a.guest_access_token=o),void 0!==s&&null!==s&&(a.inhibit_login=s),this.registerRequest(a)}registerGuest(){var{body:e}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.registerRequest(e||{},"guest")}registerRequest(e,t){var r={};return t&&(r.kind=t),this.http.request(P.IT.Post,"/register",r,e)}refreshToken(e){var t=t=>this.http.authedRequest(P.IT.Post,"/refresh",void 0,{refresh_token:e},{prefix:t,inhibitLogoutEmit:!0});return t(P.iD.V3).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return t(P.iD.V1);throw e}))}loginFlows(){return this.http.request(P.IT.Get,"/login")}login(e,t){return this.loginRequest(Xe(Xe({},t),{},{type:e})).then((e=>(e.access_token&&e.user_id&&(this.http.opts.accessToken=e.access_token,this.credentials={userId:e.user_id}),e)))}loginWithPassword(e,t){return this.login("m.login.password",{user:e,password:t})}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"sso",r=arguments.length>2?arguments[2]:void 0,n=arguments.length>3?arguments[3]:void 0,i="/login/"+t+"/redirect";r&&(i+="/"+r);var o={redirectUrl:e,[ht.unstable]:n};return this.http.getUrl(i,o).href}loginWithToken(e){return this.login("m.login.token",{token:e})}loginRequest(e){var t=this;return(0,o.A)((function*(){return yield t.http.authedRequest(P.IT.Post,"/login",void 0,e)}))()}logout(){var e=arguments,t=this;return(0,o.A)((function*(){var r,n=e.length>0&&void 0!==e[0]&&e[0];if(null!==(r=t.crypto)&&void 0!==r&&null!==(r=r.backupManager)&&void 0!==r&&r.getKeyBackupEnabled())try{while((yield t.crypto.backupManager.backupPendingKeys(200))>0);}catch(i){t.logger.error("Key backup request failed when logging out. Some keys may be missing from backup",i)}return n&&(t.stopClient(),t.http.abort()),t.http.authedRequest(P.IT.Post,"/logout")}))()}deactivateAccount(e,t){var r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this.http.authedRequest(P.IT.Post,"/account/deactivate",void 0,r)}requestLoginToken(e){var t=this;return(0,o.A)((function*(){var r={auth:e};return t.http.authedRequest(P.IT.Post,"/login/get_token",void 0,r,{prefix:P.iD.V1})}))()}getFallbackAuthUrl(e,t){var r=p.RR("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t}).href}createRoom(e){var t=this;return(0,o.A)((function*(){var r,n=(e.invite_3pid||[]).filter((e=>!e.id_access_token));if(n.length>0&&null!==(r=t.identityServer)&&void 0!==r&&r.getAccessToken){var i=yield t.identityServer.getAccessToken();if(i)for(var o of n)o.id_access_token=i}return t.http.authedRequest(P.IT.Post,"/createRoom",void 0,e)}))()}fetchRelations(e,t,r,n){var i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{dir:f.O.Backward},o=i;ue.jV.hasServerSideFwdPaginationSupport===ue.c1.Experimental&&(o=(0,p.Ab)("dir","org.matrix.msc3715.dir",o)),this.canSupport.get(be.Xj.RelationsRecursion)===be.Tj.Unstable&&(o=(0,p.Ab)("recurse","org.matrix.msc3981.recurse",o));var s=p.hm(o),a="/rooms/$roomId/relations/$eventId";null!==r?(a+="/$relationType",null!==n&&(a+="/$eventType")):null!==n&&(this.logger.warn("eventType: ".concat(n," ignored when fetching\n            relations as relationType is null")),n=null);var c=p.RR(a+"?"+s,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return this.http.authedRequest(P.IT.Get,c,void 0,void 0,{prefix:P.iD.V1})}roomState(e){var t=p.RR("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(P.IT.Get,t)}fetchRoomEvent(e,t){var r=p.RR("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(P.IT.Get,r)}members(e,t,r,n){var i={};t&&(i.membership=t),r&&(i.not_membership=r),n&&(i.at=n);var o=p.hm(i),s=p.RR("/rooms/$roomId/members?"+o,{$roomId:e});return this.http.authedRequest(P.IT.Get,s)}upgradeRoom(e,t){var r=p.RR("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(P.IT.Post,r,void 0,{new_version:t})}getStateEvent(e,t,r){var n={$roomId:e,$eventType:t,$stateKey:r},i=p.RR("/rooms/$roomId/state/$eventType",n);return void 0!==r&&(i=p.RR(i+"/$stateKey",n)),this.http.authedRequest(P.IT.Get,i)}sendStateEvent(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"",i=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},o={$roomId:e,$eventType:t,$stateKey:n},s=p.RR("/rooms/$roomId/state/$eventType",o);return void 0!==n&&(s=p.RR(s+"/$stateKey",o)),this.http.authedRequest(P.IT.Put,s,void 0,r,i)}roomInitialSync(e,t){var r,n=p.RR("/rooms/$roomId/initialSync",{$roomId:e});return this.http.authedRequest(P.IT.Get,n,{limit:null!==(r=null===t||void 0===t?void 0:t.toString())&&void 0!==r?r:"30"})}setRoomReadMarkersHttpRequest(e,t,r,n){var i=this;return(0,o.A)((function*(){var o=p.RR("/rooms/$roomId/read_markers",{$roomId:e}),s={[le.L.FullyRead]:t,[le.L.Read]:r};return((yield i.doesServerSupportUnstableFeature("org.matrix.msc2285.stable"))||(yield i.isVersionSupported("v1.4")))&&(s[le.L.ReadPrivate]=n),i.http.authedRequest(P.IT.Post,o,void 0,s)}))()}getJoinedRooms(){var e=p.RR("/joined_rooms",{});return this.http.authedRequest(P.IT.Get,e)}getJoinedRoomMembers(e){var t=p.RR("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(P.IT.Get,t)}publicRooms(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},{server:t,limit:r,since:n}=e,o=i(e,Ye);if(0===Object.keys(o).length){var s={server:t,limit:r,since:n};return this.http.authedRequest(P.IT.Get,"/publicRooms",s)}var a={server:t},c=Xe({limit:r,since:n},o);return this.http.authedRequest(P.IT.Post,"/publicRooms",a,c)}createAlias(e,t){var r=p.RR("/directory/room/$alias",{$alias:e}),n={room_id:t};return this.http.authedRequest(P.IT.Put,r,void 0,n)}deleteAlias(e){var t=p.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(P.IT.Delete,t)}getLocalAliases(e){var t=p.RR("/rooms/$roomId/aliases",{$roomId:e}),r=P.iD.V3;return this.http.authedRequest(P.IT.Get,t,void 0,void 0,{prefix:r})}getRoomIdForAlias(e){var t=p.RR("/directory/room/$alias",{$alias:e});return this.http.authedRequest(P.IT.Get,t)}getRoomDirectoryVisibility(e){var t=p.RR("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(P.IT.Get,t)}setRoomDirectoryVisibility(e,t){var r=p.RR("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(P.IT.Put,r,void 0,{visibility:t})}searchUserDirectory(e){var{term:t,limit:r}=e,n={search_term:t};return void 0!==r&&(n.limit=r),this.http.authedRequest(P.IT.Post,"/user_directory/search",void 0,n)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t){var r=t?p.RR("/profile/$userId/$info",{$userId:e,$info:t}):p.RR("/profile/$userId",{$userId:e});return this.http.authedRequest(P.IT.Get,r)}doesServerSupportExtendedProfiles(){var e=this;return(0,o.A)((function*(){return e.doesServerSupportUnstableFeature(lt)}))()}getExtendedProfileRequestPrefix(){var e=this;return(0,o.A)((function*(){return(yield e.doesServerSupportUnstableFeature("uk.tcpip.msc4133.stable"))?P.iD.V3:"/_matrix/client/unstable/uk.tcpip.msc4133"}))()}getExtendedProfile(e){var t=this;return(0,o.A)((function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");return t.http.authedRequest(P.IT.Get,p.RR("/profile/$userId",{$userId:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})}))()}getExtendedProfileProperty(e,t){var r=this;return(0,o.A)((function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=yield r.http.authedRequest(P.IT.Get,p.RR("/profile/$userId/$key",{$userId:e,$key:t}),void 0,void 0,{prefix:yield r.getExtendedProfileRequestPrefix()});return n[t]}))()}setExtendedProfileProperty(e,t){var r=this;return(0,o.A)((function*(){if(!(yield r.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var n=r.getUserId();yield r.http.authedRequest(P.IT.Put,p.RR("/profile/$userId/$key",{$userId:n,$key:e}),void 0,{[e]:t},{prefix:yield r.getExtendedProfileRequestPrefix()})}))()}deleteExtendedProfileProperty(e){var t=this;return(0,o.A)((function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(P.IT.Delete,p.RR("/profile/$userId/$key",{$userId:r,$key:e}),void 0,void 0,{prefix:yield t.getExtendedProfileRequestPrefix()})}))()}patchExtendedProfile(e){var t=this;return(0,o.A)((function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();return t.http.authedRequest(P.IT.Patch,p.RR("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})}))()}setExtendedProfile(e){var t=this;return(0,o.A)((function*(){if(!(yield t.doesServerSupportExtendedProfiles()))throw new Error("Server does not support extended profiles");var r=t.getUserId();yield t.http.authedRequest(P.IT.Put,p.RR("/profile/$userId",{$userId:r}),{},e,{prefix:yield t.getExtendedProfileRequestPrefix()})}))()}getThreePids(){return this.http.authedRequest(P.IT.Get,"/account/3pid")}addThreePidOnly(e){var t=this;return(0,o.A)((function*(){var r="/account/3pid/add";return t.http.authedRequest(P.IT.Post,r,void 0,e)}))()}bindThreePid(e){var t=this;return(0,o.A)((function*(){var r="/account/3pid/bind";return t.http.authedRequest(P.IT.Post,r,void 0,e)}))()}unbindThreePid(e,t){var r=this;return(0,o.A)((function*(){var n="/account/3pid/unbind",i={medium:e,address:t,id_server:r.getIdentityServerUrl(!0)};return r.http.authedRequest(P.IT.Post,n,void 0,i)}))()}deleteThreePid(e,t){var r="/account/3pid/delete";return this.http.authedRequest(P.IT.Post,r,void 0,{medium:e,address:t})}setPassword(e,t,r){var n="/account/password",i={auth:e,new_password:t,logout_devices:r};return this.http.authedRequest(P.IT.Post,n,void 0,i)}getDevices(){return this.http.authedRequest(P.IT.Get,"/devices")}getDevice(e){var t=p.RR("/devices/$device_id",{$device_id:e});return this.http.authedRequest(P.IT.Get,t)}setDeviceDetails(e,t){var r=p.RR("/devices/$device_id",{$device_id:e});return this.http.authedRequest(P.IT.Put,r,void 0,t)}deleteDevice(e,t){var r=p.RR("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(P.IT.Delete,r,void 0,n)}deleteMultipleDevices(e,t){var r={devices:e};t&&(r.auth=t);var n="/delete_devices";return this.http.authedRequest(P.IT.Post,n,void 0,r)}getPushers(){var e=this;return(0,o.A)((function*(){var t=yield e.http.authedRequest(P.IT.Get,"/pushers");return(yield e.doesServerSupportUnstableFeature("org.matrix.msc3881"))||(t.pushers=t.pushers.map((e=>(e.hasOwnProperty(y.cr.name)||(e[y.cr.name]=!0),e)))),t}))()}setPusher(e){var t="/pushers/set";return this.http.authedRequest(P.IT.Post,t,void 0,e)}removePusher(e,t){var r="/pushers/set",n={pushkey:e,app_id:t,kind:null};return this.http.authedRequest(P.IT.Post,r,void 0,n)}setLocalNotificationSettings(e,t){var r="".concat(y.Xs.name,".").concat(e);return this.setAccountData(r,t)}getPushRules(){return this.http.authedRequest(P.IT.Get,"/pushrules/").then((e=>(this.setPushRules(e),this.pushRules)))}setPushRules(e){this.pushRules=A.rewriteDefaultRules(e,this.getUserId()),this.pushProcessor.updateCachedPushRuleKeys(this.pushRules)}addPushRule(e,t,r,n){var i=p.RR("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(P.IT.Put,i,void 0,n)}deletePushRule(e,t,r){var n=p.RR("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(P.IT.Delete,n)}setPushRuleEnabled(e,t,r,n){var i=p.RR("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(P.IT.Put,i,void 0,{enabled:n})}setPushRuleActions(e,t,r,n){var i=p.RR("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(P.IT.Put,i,void 0,{actions:n})}search(e,t){var{body:r,next_batch:n}=e,i={};return n&&(i.next_batch=n),this.http.authedRequest(P.IT.Post,"/search",i,r,{abortSignal:t})}uploadKeysRequest(e,t){return this.http.authedRequest(P.IT.Post,"/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(P.IT.Post,"/keys/signatures/upload",void 0,e)}downloadKeysForUsers(e){var{token:t}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r={device_keys:{}};return void 0!==t&&(r.token=t),e.forEach((e=>{r.device_keys[e]=[]})),this.http.authedRequest(P.IT.Post,"/keys/query",void 0,r)}claimOneTimeKeys(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"signed_curve25519",r=arguments.length>2?arguments[2]:void 0,n={};for(var[i,o]of(void 0===t&&(t="signed_curve25519"),e)){var s=n[i]||{};(0,p.C6)(n,i,s),(0,p.C6)(s,o,t)}var a={one_time_keys:n};r&&(a.timeout=r);var c="/keys/claim";return this.http.authedRequest(P.IT.Post,c,void 0,a)}getKeyChanges(e,t){var r={from:e,to:t};return this.http.authedRequest(P.IT.Get,"/keys/changes",r)}uploadDeviceSigningKeys(e,t){var r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(P.IT.Post,"/keys/device_signing/upload",void 0,r,{prefix:P.iD.Unstable})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No identity server base URL set");var t=this.http.getUrl("/account/register",void 0,P.Pw.V2,this.idBaseUrl);return this.http.requestOtherUrl(P.IT.Post,t,e)}requestEmailToken(e,t,r,n,i){var o={client_secret:t,email:e,send_attempt:null===r||void 0===r?void 0:r.toString()};return n&&(o.next_link=n),this.http.idServerRequest(P.IT.Post,"/validate/email/requestToken",o,P.Pw.V2,i)}requestMsisdnToken(e,t,r,n,i,o){var s={client_secret:r,country:e,phone_number:t,send_attempt:null===n||void 0===n?void 0:n.toString()};return i&&(s.next_link=i),this.http.idServerRequest(P.IT.Post,"/validate/msisdn/requestToken",s,P.Pw.V2,o)}submitMsisdnToken(e,t,r,n){var i={sid:e,client_secret:t,token:r};return this.http.idServerRequest(P.IT.Post,"/validate/msisdn/submitToken",i,P.Pw.V2,null!==n&&void 0!==n?n:void 0)}submitMsisdnTokenOtherUrl(e,t,r,n){var i={sid:t,client_secret:r,token:n};return this.http.requestOtherUrl(P.IT.Post,e,i)}getIdentityHashDetails(e){return this.http.idServerRequest(P.IT.Get,"/hash_details",void 0,P.Pw.V2,e)}identityHashedLookup(e,t){var r=this;return(0,o.A)((function*(){var n={},i=yield r.getIdentityHashDetails(t);if(!i||!i["lookup_pepper"]||!i["algorithms"])throw new Error("Unsupported identity server: bad response");n["pepper"]=i["lookup_pepper"];var s={};if(i["algorithms"].includes("sha256"))n["addresses"]=yield Promise.all(e.map(function(){var e=(0,o.A)((function*(e){var t=e[0].toLowerCase(),r=e[1].toLowerCase(),i=yield(0,$e.s)("".concat(t," ").concat(r," ").concat(n["pepper"])),o=(0,O.A4)(i);return s[o]=e[0],o}));return function(t){return e.apply(this,arguments)}}())),n["algorithm"]="sha256";else{if(!i["algorithms"].includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");n["addresses"]=e.map((e=>{var t=e[0].toLowerCase(),r=e[1].toLowerCase(),n="".concat(t," ").concat(r);return s[n]=e[0],n})),n["algorithm"]="none"}var a=yield r.http.idServerRequest(P.IT.Post,"/lookup",n,P.Pw.V2,t);if(null===a||void 0===a||!a["mappings"])return[];var c=[];for(var l of Object.keys(a["mappings"])){var d=a["mappings"][l],u=s[l];if(!u)throw new Error("Identity server returned more results than expected");c.push({address:u,mxid:d})}return c}))()}lookupThreePid(e,t,r){var n=this;return(0,o.A)((function*(){var i=yield n.identityHashedLookup([[t,e]],r),o=i.find((e=>e.address===t));if(!o)return{};var s={address:t,medium:e,mxid:o.mxid};return s}))()}bulkLookupThreePids(e,t){var r=this;return(0,o.A)((function*(){var n=yield r.identityHashedLookup(e.map((e=>[e[1],e[0]])),t),i=[],o=function*(t){var r=e.find((e=>e[1]===t.address));if(!r)throw new Error("Identity sever returned unexpected results");i.push([r[0],t.address,t.mxid])};for(var s of n)yield*o(s);return{threepids:i}}))()}getIdentityAccount(e){return this.http.idServerRequest(P.IT.Get,"/account",void 0,P.Pw.V2,e)}sendToDevice(e,t,r){var n=p.RR("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),i={messages:p.HF(t)},o=new Map;for(var[s,a]of t)o.set(s,Array.from(a.keys()));return this.logger.debug("PUT ".concat(n),o),this.http.authedRequest(P.IT.Put,n,void 0,i)}queueToDevice(e){return this.toDeviceMessageQueue.queueBatch(e)}getThirdpartyProtocols(){return this.http.authedRequest(P.IT.Get,"/thirdparty/protocols").then((e=>{if(!e||"object"!==typeof e)throw new Error("/thirdparty/protocols did not return an object: ".concat(e));return e}))}getThirdpartyLocation(e,t){var r=p.RR("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(P.IT.Get,r,t)}getThirdpartyUser(e,t){var r=p.RR("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(P.IT.Get,r,t)}getTerms(e,t){var r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(P.IT.Get,r)}agreeToTerms(e,t,r,n){var i=this.termsUrlForService(e,t),o={Authorization:"Bearer "+r};return this.http.requestOtherUrl(P.IT.Post,i,{user_accepts:n},{headers:o})}reportEvent(e,t,r,n){var i=p.RR("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(P.IT.Post,i,void 0,{score:r,reason:n})}getRoomHierarchy(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4?arguments[4]:void 0,o=p.RR("/rooms/$roomId/hierarchy",{$roomId:e}),s={suggested_only:String(n),max_depth:null===r||void 0===r?void 0:r.toString(),from:i,limit:null===t||void 0===t?void 0:t.toString()};return this.http.authedRequest(P.IT.Get,o,s,void 0,{prefix:P.iD.V1}).catch((e=>{if("M_UNRECOGNIZED"===e.errcode)return this.http.authedRequest(P.IT.Get,o,s,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2946"});throw e}))}unstableCreateFileTree(e){var t=this;return(0,o.A)((function*(){var{room_id:r}=yield t.createRoom({name:e,preset:V.k.PrivateChat,power_level_content_override:Xe(Xe({},re),{},{users:{[t.getUserId()]:100}}),creation_content:{[y.Ct]:y.CJ.Space},initial_state:[{type:y.D7.name,state_key:y.nN.name,content:{[y.ud.name]:!0}},{type:y.Bx.RoomEncryption,state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}]});return new ie(t,r)}))()}unstableGetFileTreeSpace(e){var t,r,n=this.getRoom(e);if((null===n||void 0===n?void 0:n.getMyMembership())!==Z.O.Join)return null;var i=n.currentState.getStateEvents(y.Bx.RoomCreate,""),o=n.currentState.getStateEvents(y.D7.name,y.nN.name);if(!i)throw new Error("Expected single room create event");return null!==o&&void 0!==o&&null!==(t=o.getContent())&&void 0!==t&&t[y.ud.name]?(null===(r=i.getContent())||void 0===r?void 0:r[y.Ct])!==y.CJ.Space?null:new ie(this,e):null}slidingSync(e,t,r){var n={};e.pos&&(n.pos=e.pos,delete e.pos),e.timeout&&(n.timeout=e.timeout,delete e.timeout);var i=e.clientTimeout;return delete e.clientTimeout,this.http.authedRequest(P.IT.Post,"/sync",n,e,{prefix:"/_matrix/client/unstable/org.matrix.msc3575",baseUrl:t,localTimeoutMs:i,abortSignal:r})}supportsThreads(){var e;return(null===(e=this.clientOpts)||void 0===e?void 0:e.threadSupport)||!1}supportsIntentionalMentions(){return this.canSupport.get(be.Xj.IntentionalMentions)!==be.Tj.Unsupported}getRoomSummary(e,t){var r=this;return(0,o.A)((function*(){var n={prefix:"/_matrix/client/unstable/im.nheko.summary"};try{var i=p.RR("/summary/$roomid",{$roomid:e});return yield r.http.authedRequest(P.IT.Get,i,{via:t},void 0,n)}catch(s){if(s instanceof P.up&&"M_UNRECOGNIZED"===s.errcode){var o=p.RR("/rooms/$roomid/summary",{$roomid:e});return yield r.http.authedRequest(P.IT.Get,o,{via:t},void 0,n)}throw s}}))()}processThreadEvents(e,t,r){e.processThreadedEvents(t,r)}processThreadRoots(e,t,r){this.supportsThreads()&&e.processThreadRoots(t,r)}processBeaconEvents(e,t){this.processAggregatedTimelineEvents(e,t)}processAggregatedTimelineEvents(e,t){null!==t&&void 0!==t&&t.length&&e&&(e.currentState.processBeaconEvents(t,this),e.processPollEvents(t))}whoami(){var e=this;return(0,o.A)((function*(){return e.http.authedRequest(P.IT.Get,"/account/whoami")}))()}timestampToEvent(e,t,r){var n=this;return(0,o.A)((function*(){var i=p.RR("/rooms/$roomId/timestamp_to_event",{$roomId:e}),o={ts:t.toString(),dir:r};try{return yield n.http.authedRequest(P.IT.Get,i,o,void 0,{prefix:P.iD.V1})}catch(s){if("M_UNRECOGNIZED"===s.errcode&&(400===s.httpStatus||404===s.httpStatus||405===s.httpStatus))return yield n.http.authedRequest(P.IT.Get,i,o,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc3030"});throw s}}))()}getAuthIssuer(){var e=this;return(0,o.A)((function*(){return e.http.request(P.IT.Get,"/auth_issuer",void 0,void 0,{prefix:P.iD.Unstable+"/org.matrix.msc2965"})}))()}getAuthMetadata(){var e=this;return(0,o.A)((function*(){var t;try{t=yield e.http.request(P.IT.Get,"/auth_metadata",void 0,void 0,{prefix:P.iD.Unstable+"/org.matrix.msc2965"})}catch(n){if(n instanceof P.up&&"M_UNRECOGNIZED"===n.errcode){var{issuer:r}=yield e.getAuthIssuer();return(0,ze.k8)(r)}throw n}return(0,ze.Pl)(t)}))()}}function pt(e){return Object.fromEntries(Object.entries(e).map((e=>{var[t,r]=e;return["".concat(ct,".").concat(t),r]})))}function ft(e,t){var r,n=e.getUserId(),i=t.getId(),o=e.getRoom(t.getRoomId());if(o&&n&&i)if(o.findEventById(i)){var s,a=!!t.threadRootId&&!t.isThreadRoot;if(a){var c=o.getThread(t.threadRootId);s=!c||c.hasUserReadEvent(n,i)}else s=o.hasUserReadEvent(n,i);if(!s){var l=e.getPushActionsForEvent(t,!0),d=!(null===l||void 0===l||null===(r=l.tweaks)||void 0===r||!r.highlight);if(d){var u=o.getUnreadCountForEventContext(j.X5.Highlight,t)+1;a?o.setThreadUnreadNotificationCount(t.threadRootId,j.X5.Highlight,u):o.setUnreadNotificationCount(j.X5.Highlight,u)}var h=!(null===l||void 0===l||!l.notify);if(h){var v=o.getUnreadCountForEventContext(j.X5.Total,t)+1;a?o.setThreadUnreadNotificationCount(t.threadRootId,j.X5.Total,v):o.setUnreadNotificationCount(j.X5.Total,v)}}}else g.v.info("Decrypted event ".concat(t.getId()," is not in room ").concat(o.roomId,": ignoring"))}function gt(e){return mt(e)?le.S:e.threadRootId}function mt(e){if(!e.threadRootId)return!0;if(e.isThreadRoot)return!0;if(!e.isRelation())return g.v.warn("Event is not a relation or a thread root, but still has a threadRootId! id=".concat(e.getId())),!0;if(e.isRelation(ue.RN.name))return!1;var t=e.relationEventId===e.threadRootId;return t}(0,s.A)(vt,"RESTORE_BACKUP_ERROR_BAD_KEY","RESTORE_BACKUP_ERROR_BAD_KEY")},4114:function(e,t,r){"use strict";var n=r(6518),i=r(8981),o=r(6198),s=r(4527),a=r(6837),c=r(9039),l=c((function(){return 4294967297!==[].push.call({length:4294967296},1)})),d=function(){try{Object.defineProperty([],"length",{writable:!1}).push()}catch(e){return e instanceof TypeError}},u=l||!d();n({target:"Array",proto:!0,arity:1,forced:u},{push:function(e){var t=i(this),r=o(t),n=arguments.length;a(r+n);for(var c=0;c<n;c++)t[r]=arguments[c],r++;return s(t,r),r}})},4117:function(e){"use strict";e.exports=function(e){return null===e||void 0===e}},4123:function(e,t,r){"use strict";r.d(t,{H:function(){return y},f:function(){return m}});r(4114),r(8111),r(2489),r(7588),r(1701),r(8237);var n=r(698),i=r(4761),o=r(8058),s=r(3271),a=r(6170),c=r(5629),l=r(3178),d=r(3232),u=r(2668),h=r(972),v=r(5462),p=r(7621),f=r(3877),g=function(e){return e[e["NotStarted"]=0]="NotStarted",e[e["InProgress"]=1]="InProgress",e[e["Finished"]=2]="Finished",e}(g||{}),m=function(e){return e["Events"]="RoomState.events",e["Members"]="RoomState.members",e["NewMember"]="RoomState.newMember",e["Update"]="RoomState.update",e["BeaconLiveness"]="RoomState.BeaconLiveness",e["Marker"]="RoomState.Marker",e}({});class y extends u.X{constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{status:g.NotStarted};super(),this.roomId=e,this.oobMemberFlags=t,(0,i.A)(this,"reEmitter",new v.Q(this)),(0,i.A)(this,"sentinels",{}),(0,i.A)(this,"displayNameToUserIds",new Map),(0,i.A)(this,"userIdsToDisplayNames",{}),(0,i.A)(this,"tokenToInvite",{}),(0,i.A)(this,"joinedMemberCount",null),(0,i.A)(this,"summaryJoinedMemberCount",null),(0,i.A)(this,"invitedMemberCount",null),(0,i.A)(this,"summaryInvitedMemberCount",null),(0,i.A)(this,"modified",-1),(0,i.A)(this,"members",{}),(0,i.A)(this,"events",new Map),(0,i.A)(this,"paginationToken",null),(0,i.A)(this,"beacons",new Map),(0,i.A)(this,"_liveBeaconIds",[]),this.updateModifiedTime()}getJoinedMemberCount(){return null!==this.summaryJoinedMemberCount?this.summaryJoinedMemberCount:(null===this.joinedMemberCount&&(this.joinedMemberCount=this.getMembers().reduce(((e,t)=>t.membership===f.O.Join?e+1:e),0)),this.joinedMemberCount)}setJoinedMemberCount(e){this.summaryJoinedMemberCount=e}getInvitedMemberCount(){return null!==this.summaryInvitedMemberCount?this.summaryInvitedMemberCount:(null===this.invitedMemberCount&&(this.invitedMemberCount=this.getMembers().reduce(((e,t)=>t.membership===f.O.Invite?e+1:e),0)),this.invitedMemberCount)}setInvitedMemberCount(e){this.summaryInvitedMemberCount=e}getMembers(){return Object.values(this.members)}getMembersExcept(e){return this.getMembers().filter((t=>!e.includes(t.userId)))}getMember(e){return this.members[e]||null}getSentinelMember(e){if(!e)return null;var t=this.sentinels[e];if(void 0===t){t=new o.Y(this.roomId,e);var r=this.members[e];null!==r&&void 0!==r&&r.events.member&&t.setMembershipEvent(r.events.member,this),this.sentinels[e]=t}return t}getStateEvents(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());var r=this.events.get(e).get(t);return r||null}get hasLiveBeacons(){var e;return!(null===(e=this.liveBeaconIds)||void 0===e||!e.length)}get liveBeaconIds(){return this._liveBeaconIds}clone(){var e=new y(this.roomId,this.oobMemberFlags),t=this.oobMemberFlags.status;return this.oobMemberFlags.status=g.NotStarted,Array.from(this.events.values()).forEach((t=>{e.setStateEvents(Array.from(t.values()))})),this.oobMemberFlags.status=t,null!==this.summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this.summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),this.oobMemberFlags.status==g.Finished&&this.getMembers().forEach((t=>{var r;t.isOutOfBand()&&(null===(r=e.getMember(t.userId))||void 0===r||r.markOutOfBand())})),e}setUnknownStateEvents(e){var t=e.filter((e=>!this.events.has(e.getType())||!this.events.get(e.getType()).has(e.getStateKey())));this.setStateEvents(t)}setStateEvents(e,t){this.updateModifiedTime(),e.forEach((e=>{if(e.getRoomId()===this.roomId&&e.isState()){p.E.matches(e.getType())&&this.setBeacon(e);var t,r=this.getStateEventMatching(e);if(this.setStateEvent(e),e.getType()===c.Bx.RoomMember)this.updateDisplayNameCache(e.getStateKey(),null!==(t=e.getContent().displayname)&&void 0!==t?t:""),this.updateThirdPartyTokenCache(e);this.emit(m.Events,e,this,r)}})),this.onBeaconLivenessChange(),e.forEach((e=>{if(e.getRoomId()===this.roomId&&e.isState())if(e.getType()===c.Bx.RoomMember){var r=e.getStateKey();e.getContent().membership!==f.O.Leave&&e.getContent().membership!==f.O.Ban||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);var n=this.getOrCreateMember(r,e);n.setMembershipEvent(e,this),this.updateMember(n),this.emit(m.Members,e,this,n)}else if(e.getType()===c.Bx.RoomPowerLevels){if(""!==e.getStateKey())return;var i=Object.values(this.members);i.forEach((t=>{var r=t.getLastModifiedTime();t.setPowerLevelEvent(e),r!==t.getLastModifiedTime()&&this.emit(m.Members,e,this,t)})),this.sentinels={}}else c.ge.matches(e.getType())&&this.emit(m.Marker,e,t)})),this.emit(m.Update,this)}processBeaconEvents(e,t){var r=this;return(0,n.A)((function*(){if(e.length&&r.beacons.size){var i,o=[...r.beacons.values()].reduce(((e,t)=>(e[t.beaconInfoId]=t,e)),{}),s=(e,t)=>{if(p.z.matches(t.getType())){var r=o[e];r&&r.addLocations([t])}},a=function*(e){var r,i=null===(r=e.getRelation())||void 0===r?void 0:r.event_id;if(!i||!o[i])return{v:void 0};if(!p.z.matches(e.getType())&&!e.isEncrypted())return{v:void 0};try{yield t.decryptEventIfNeeded(e),s(i,e)}catch(a){e.isDecryptionFailure()&&e.once(l.OQ.Decrypted,(0,n.A)((function*(){s(i,e)})))}};for(var c of e)if(i=yield*a(c),i)return i.v}}))()}getOrCreateMember(e,t){var r=this.members[e];return r||(r=new o.Y(this.roomId,e),this.members[e]=r,this.emit(m.NewMember,t,this,r)),r}setStateEvent(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)}setBeacon(e){var t=(0,h.M9)(e);if(this.beacons.has(t)){var r,n=this.beacons.get(t);return e.isRedacted()?void(n.beaconInfoId===(null===(r=e.getRedactionEvent())||void 0===r?void 0:r.redacts)&&(n.destroy(),this.beacons.delete(t))):n.update(e)}if(!e.isRedacted()){var i=new h.HF(e);this.reEmitter.reEmit(i,[h.JH.New,h.JH.Update,h.JH.Destroy,h.JH.LivenessChange]),this.emit(h.JH.New,e,i),i.on(h.JH.LivenessChange,this.onBeaconLivenessChange.bind(this)),i.on(h.JH.Destroy,this.onBeaconLivenessChange.bind(this)),this.beacons.set(i.identifier,i)}}onBeaconLivenessChange(){this._liveBeaconIds=Array.from(this.beacons.values()).filter((e=>e.isLive)).map((e=>e.identifier)),this.emit(m.BeaconLiveness,this,this.hasLiveBeacons)}getStateEventMatching(e){var t,r;return null!==(t=null===(r=this.events.get(e.getType()))||void 0===r?void 0:r.get(e.getStateKey()))&&void 0!==t?t:null}updateMember(e){var t=this.getStateEvents(c.Bx.RoomPowerLevels,"");t&&e.setPowerLevelEvent(t),delete this.sentinels[e.userId],this.members[e.userId]=e,this.joinedMemberCount=null,this.invitedMemberCount=null}needsOutOfBandMembers(){return this.oobMemberFlags.status===g.NotStarted}outOfBandMembersReady(){return this.oobMemberFlags.status===g.Finished}markOutOfBandMembersStarted(){this.oobMemberFlags.status===g.NotStarted&&(this.oobMemberFlags.status=g.InProgress)}markOutOfBandMembersFailed(){this.oobMemberFlags.status===g.InProgress&&(this.oobMemberFlags.status=g.NotStarted)}clearOutOfBandMembers(){var e=0;Object.keys(this.members).forEach((t=>{var r=this.members[t];r.isOutOfBand()&&(++e,delete this.members[t])})),s.v.log("LL: RoomState removed ".concat(e," members...")),this.oobMemberFlags.status=g.NotStarted}setOutOfBandMembers(e){s.v.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),this.oobMemberFlags.status===g.InProgress&&(s.v.log("LL: RoomState put in finished state ..."),this.oobMemberFlags.status=g.Finished,e.forEach((e=>this.setOutOfBandMember(e))),this.emit(m.Update,this))}setOutOfBandMember(e){if(e.getType()===c.Bx.RoomMember){var t=e.getStateKey(),r=this.getMember(t);if(!r||r.isOutOfBand()){var n=this.getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),this.updateDisplayNameCache(n.userId,n.name),this.setStateEvent(e),this.updateMember(n),this.emit(m.Members,e,this,n)}}}setTypingEvent(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))}getInviteForThreePidToken(e){return this.tokenToInvite[e]||null}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}getUserIdsWithDisplayName(e){var t;return null!==(t=this.displayNameToUserIds.get((0,a.Gp)(e)))&&void 0!==t?t:[]}maySendRedactionForEvent(e,t){var r=this.getMember(t);if(!r||r.membership===f.O.Leave)return!1;if(e.status||e.isRedacted())return!1;var n=this.maySendEvent(c.Bx.RoomRedaction,t);return!!n&&(e.getSender()===t||this.hasSufficientPowerLevelFor("redact",r.powerLevel))}hasSufficientPowerLevelFor(e,t){var r=this.getStateEvents(c.Bx.RoomPowerLevels,""),n={};r&&(n=r.getContent());var i=50;return(0,a.Et)(n[e])&&(i=n[e]),t>=i}maySendMessage(e){return this.maySendEventOfType(c.Bx.RoomMessage,e,!1)}maySendEvent(e,t){return this.maySendEventOfType(e,t,!1)}mayClientSendStateEvent(e,t){return!(t.isGuest()||!t.credentials.userId)&&this.maySendStateEvent(e,t.credentials.userId)}maySendStateEvent(e,t){return this.maySendEventOfType(e,t,!0)}maySendEventOfType(e,t,r){var n,i=this.getStateEvents(c.Bx.RoomPowerLevels,""),o={},s=0,a=0,l=0;if(i){n=i.getContent(),o=n.events||{},s=Number.isSafeInteger(n.state_default)?n.state_default:50;var d=n.users&&n.users[t];Number.isSafeInteger(d)?l=d:Number.isSafeInteger(n.users_default)&&(l=n.users_default),Number.isSafeInteger(n.events_default)&&(a=n.events_default)}var u=r?s:a;return Number.isSafeInteger(o[e])&&(u=o[e]),l>=u}mayTriggerNotifOfType(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents(c.Bx.RoomPowerLevels,""),i=50;return n&&n.getContent()&&n.getContent().notifications&&(0,a.Et)(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),r.powerLevel>=i}getJoinRule(){var e,t=this.getStateEvents(c.Bx.RoomJoinRules,""),r=null!==(e=null===t||void 0===t?void 0:t.getContent())&&void 0!==e?e:{};return r["join_rule"]||d.dx.Invite}getHistoryVisibility(){var e,t=this.getStateEvents(c.Bx.RoomHistoryVisibility,""),r=null!==(e=null===t||void 0===t?void 0:t.getContent())&&void 0!==e?e:{};return r["history_visibility"]||d.Jv.Shared}getGuestAccess(){var e,t=this.getStateEvents(c.Bx.RoomGuestAccess,""),r=null!==(e=null===t||void 0===t?void 0:t.getContent())&&void 0!==e?e:{};return r["guest_access"]||d.rF.Forbidden}findPredecessor(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(e){var t=this.getStateEvents(c.Bx.RoomPredecessor,"");if(t){var r=t.getContent(),n=r.predecessor_room_id,i=r.last_known_event_id;"string"!==typeof i&&(i=void 0);var o=r.via_servers;if(Array.isArray(o)||(o=void 0),"string"===typeof n)return{roomId:n,eventId:i,viaServers:o}}}var s=this.getStateEvents(c.Bx.RoomCreate,"");if(s){var a=s.getContent()["predecessor"];if(a){var l=a["room_id"];if("string"===typeof l){var d=a["event_id"];return"string"===typeof d&&""!==d||(d=void 0),{roomId:l,eventId:d}}}}return null}updateThirdPartyTokenCache(e){if(e.getContent().third_party_invite){var t=(e.getContent().third_party_invite.signed||{}).token;if(t){var r=this.getStateEvents(c.Bx.RoomThirdPartyInvite,t);r&&(this.tokenToInvite[t]=e)}}}updateDisplayNameCache(e,t){var r=this.userIdsToDisplayNames[e];if(delete this.userIdsToDisplayNames[e],r){var n=(0,a.Gp)(r),i=this.displayNameToUserIds.get(n);if(i){var o=i.filter((t=>t!==e));this.displayNameToUserIds.set(n,o)}}this.userIdsToDisplayNames[e]=t;var s=t&&(0,a.Gp)(t);if(s){var c,l=null!==(c=this.displayNameToUserIds.get(s))&&void 0!==c?c:[];l.push(e),this.displayNameToUserIds.set(s,l)}}}},4124:function(e,t,r){"use strict";var n=r(4576);e.exports=function(e,t){var r=n[e],i=r&&r.prototype;return i&&i[t]}},4178:function(e,t,r){"use strict";r.d(t,{p:function(){return o},u:function(){return i}});var n=r(4761),i=function(e){return e[e["Blocked"]=-1]="Blocked",e[e["Unverified"]=0]="Unverified",e[e["Verified"]=1]="Verified",e}({});class o{constructor(e){(0,n.A)(this,"deviceId",void 0),(0,n.A)(this,"userId",void 0),(0,n.A)(this,"algorithms",void 0),(0,n.A)(this,"keys",void 0),(0,n.A)(this,"verified",void 0),(0,n.A)(this,"signatures",void 0),(0,n.A)(this,"displayName",void 0),(0,n.A)(this,"dehydrated",!1),this.deviceId=e.deviceId,this.userId=e.userId,this.algorithms=e.algorithms,this.keys=e.keys,this.verified=e.verified||i.Unverified,this.signatures=e.signatures||new Map,this.displayName=e.displayName,this.dehydrated=!!e.dehydrated}getFingerprint(){return this.keys.get("ed25519:".concat(this.deviceId))}getIdentityKey(){return this.keys.get("curve25519:".concat(this.deviceId))}}},4192:function(e,t,r){"use strict";r.d(t,{m:function(){return w}});r(4114),r(8111),r(7588),r(1701),r(8237),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(4761),i=r(698),o=r(8965),s=r(3271),a=r(6170),c=r(2292),l=r(4108),d=r(1212),u=r(9683),h=r(6317),v=r(5629),p=r(4123),f=r(8058),g=r(3877),m=3;class y{constructor(e){this.crypto=e}name(){return"e2ee"}when(){return h.HY.PreProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return(0,i.A)((function*(){e.device_lists&&(yield t.crypto.processDeviceLists(e.device_lists)),yield t.crypto.processKeyCounts(e.device_one_time_keys_count,e["device_unused_fallback_key_types"]||e["org.matrix.msc2732.device_unused_fallback_key_types"]),t.crypto.onSyncCompleted({})}))()}}class S{constructor(e,t){this.client=e,this.cryptoCallbacks=t,(0,n.A)(this,"nextBatch",null)}name(){return"to_device"}when(){return h.HY.PreProcess}onRequest(e){var t={since:null!==this.nextBatch?this.nextBatch:void 0};return e&&(t["limit"]=100,t["enabled"]=!0),t}onResponse(e){var t=this;return(0,i.A)((function*(){var r=[],n=e["events"]||[];n.length>0&&t.cryptoCallbacks&&(n=yield t.cryptoCallbacks.preprocessToDeviceMessages(n)),n.map(t.client.getEventMapper()).map((e=>{if("m.key.verification.cancel"===e.getType()){var t=e.getContent()["transaction_id"];t&&r.push(t)}return e})).forEach((e=>{var n=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=n.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){var i=n["transaction_id"];r.includes(i)&&e.flagCancelled()}t.client.emit(l.AU.ToDeviceEvent,e)}else s.v.log("Ignoring undecryptable to-device event from "+e.getSender())})),t.nextBatch=e.next_batch}))()}}class b{constructor(e){this.client=e}name(){return"account_data"}when(){return h.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return(0,i.A)((function*(){for(var r in e.global&&e.global.length>0&&t.processGlobalAccountData(e.global),e.rooms){var n=T(t.client,r,e.rooms[r]),i=t.client.getRoom(r);i?(i.addAccountData(n),n.forEach((e=>{t.client.emit(l.AU.Event,e)}))):s.v.warn("got account data for room but room doesn't exist on client:",r)}}))()}processGlobalAccountData(e){var t=T(this.client,void 0,e),r=t.reduce(((e,t)=>(e[t.getType()]=this.client.store.getAccountData(t.getType()),e)),{});this.client.store.storeAccountDataEvents(t),t.forEach((e=>{if(e.getType()===v.Bx.PushRules){var t=e.getContent();this.client.setPushRules(t)}var n=r[e.getType()];return this.client.emit(l.AU.AccountData,e,n),e}))}}class E{constructor(e){this.client=e}name(){return"typing"}when(){return h.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return(0,i.A)((function*(){if(null!==e&&void 0!==e&&e.rooms)for(var r in e.rooms)R(t.client,r,[e.rooms[r]])}))()}}class _{constructor(e){this.client=e}name(){return"receipts"}when(){return h.HY.PostProcess}onRequest(e){if(e)return{enabled:!0}}onResponse(e){var t=this;return(0,i.A)((function*(){if(null!==e&&void 0!==e&&e.rooms)for(var r in e.rooms)R(t.client,r,[e.rooms[r]])}))()}}class w{constructor(e,t,r,i){this.slidingSync=e,this.client=t,(0,n.A)(this,"opts",void 0),(0,n.A)(this,"syncOpts",void 0),(0,n.A)(this,"syncState",null),(0,n.A)(this,"syncStateData",void 0),(0,n.A)(this,"lastPos",null),(0,n.A)(this,"failCount",0),(0,n.A)(this,"notifEvents",[]),this.opts=(0,d.Bn)(r),this.syncOpts=(0,d.Fe)(i),t.getNotifTimelineSet()&&t.reEmitter.reEmit(t.getNotifTimelineSet(),[o.u9.Timeline,o.u9.TimelineReset]),this.slidingSync.on(h.cQ.Lifecycle,this.onLifecycle.bind(this)),this.slidingSync.on(h.cQ.RoomData,this.onRoomData.bind(this));var s=[new S(this.client,this.syncOpts.cryptoCallbacks),new b(this.client),new E(this.client),new _(this.client)];this.syncOpts.cryptoCallbacks&&s.push(new y(this.syncOpts.cryptoCallbacks)),s.forEach((e=>{this.slidingSync.registerExtension(e)}))}onRoomData(e,t){var r=this;return(0,i.A)((function*(){var n=r.client.store.getRoom(e);if(!n){if(!t.initial)return void s.v.debug("initial flag not set but no stored room exists for room ",e,t);n=(0,d.M)(r.client,e,r.opts)}yield r.processRoomData(r.client,n,t)}))()}onLifecycle(e,t,r){switch(r&&s.v.debug("onLifecycle",e,r),e){case h.ns.Complete:if(this.purgeNotifications(),!t)break;this.lastPos||this.updateSyncState(d.Lm.Prepared,{oldSyncToken:void 0,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.updateSyncState(d.Lm.Syncing,{oldSyncToken:this.lastPos,nextSyncToken:t.pos,catchingUp:!1,fromCache:!1}),this.lastPos=t.pos;break;case h.ns.RequestFinished:if(r){if(this.failCount+=1,this.updateSyncState(this.failCount>m?d.Lm.Error:d.Lm.Reconnecting,{error:new u.up(r)}),this.shouldAbortSync(new u.up(r)))return}else this.failCount=0;break}}syncLeftRooms(){return(0,i.A)((function*(){return[]}))()}peek(e){return(0,i.A)((function*(){return null}))()}stopPeeking(){}setPresence(e){}getSyncState(){return this.syncState}getSyncStateData(){var e;return null!==(e=this.syncStateData)&&void 0!==e?e:null}createRoom(e){var{timelineSupport:t}=this.client,r=new o.Wv(e,this.client,this.client.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:t});return this.client.reEmitter.reEmit(r,[o.u9.Name,o.u9.Redaction,o.u9.RedactionCancelled,o.u9.Receipt,o.u9.Tags,o.u9.LocalEchoUpdated,o.u9.AccountData,o.u9.MyMembership,o.u9.Timeline,o.u9.TimelineReset]),this.registerStateListeners(r),r}registerStateListeners(e){this.client.reEmitter.reEmit(e.currentState,[p.f.Events,p.f.Members,p.f.NewMember,p.f.Update]),e.currentState.on(p.f.NewMember,((e,t,r)=>{var n;r.user=null!==(n=this.client.getUser(r.userId))&&void 0!==n?n:void 0,this.client.reEmitter.reEmit(r,[f.o.Name,f.o.Typing,f.o.PowerLevel,f.o.Membership])}))}shouldAbortSync(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(s.v.warn("Token no longer valid - assuming logout"),this.stop(),this.updateSyncState(d.Lm.Error,{error:e}),!0)}processRoomData(e,t,r){var n=this;return(0,i.A)((function*(){r=I(e,t.roomId,r);var s=T(n.client,t.roomId,r.required_state),d=T(n.client,t.roomId,r.timeline,!1),u=[];if(r.initial){var h=new Set;t.getLiveTimeline().getEvents().forEach((e=>{h.add(e.getId())}));for(var p=[],f=[],m=!1,y=d.length-1;y>=0;y--){var S=d[y];h.has(S.getId())?m=!0:m?p.push(S):f.unshift(S)}d=f,p.length>0&&t.addEventsToTimeline(p,!0,!1,t.getLiveTimeline(),r.prev_batch)}var b,E=t.hasEncryptionStateEvent();if(null!=r.notification_count&&t.setUnreadNotificationCount(o.X5.Total,r.notification_count),null!=r.highlight_count&&(!E||E&&t.getUnreadNotificationCount(o.X5.Highlight)<=0)&&t.setUnreadNotificationCount(o.X5.Highlight,r.highlight_count),Number.isInteger(r.invited_count)&&t.currentState.setInvitedMemberCount(r.invited_count),Number.isInteger(r.joined_count)&&t.currentState.setJoinedMemberCount(r.joined_count),r.invite_state){var _=T(n.client,t.roomId,r.invite_state);return yield n.injectRoomEvents(t,_),r.initial&&(t.recalculate(),n.client.store.storeRoom(t),n.client.emit(l.AU.Room,t)),_.forEach((e=>{n.client.emit(l.AU.Event,e)})),void t.updateMyMembership(g.O.Invite)}r.initial&&t.getLiveTimeline().setPaginationToken(null!==(b=r.prev_batch)&&void 0!==b?b:null,c.q.BACKWARDS);yield n.injectRoomEvents(t,s,d,r.num_live),t.addEphemeralEvents(u),t.updateMyMembership(g.O.Join),t.recalculate(),r.initial&&(e.store.storeRoom(t),e.emit(l.AU.Room,t)),n.addNotifications(d);var w=function(){var r=(0,i.A)((function*(r){e.emit(l.AU.Event,r),r.isState()&&r.getType()==v.Bx.RoomEncryption&&n.syncOpts.cryptoCallbacks&&(yield n.syncOpts.cryptoCallbacks.onCryptoEvent(t,r))}));return function(e){return r.apply(this,arguments)}}();yield(0,a.d8)(s,w),yield(0,a.d8)(d,w),u.forEach((function(t){e.emit(l.AU.Event,t)})),t.decryptCriticalEvents()}))()}injectRoomEvents(e,t){var r=arguments,n=this;return(0,i.A)((function*(){var i=r.length>2&&void 0!==r[2]?r[2]:[],o=r.length>3&&void 0!==r[3]?r[3]:0,s=e.getLiveTimeline(),a=0==s.getEvents().length;if(a){for(var c of t)n.client.getPushActionsForEvent(c);s.initialiseState(t)}a||(e.oldState.setStateEvents(t),e.currentState.setStateEvents(t));var l=[];o>0&&(l=i.slice(-1*o),i=i.slice(0,-1*l.length)),yield e.addLiveEvents(i,{fromCache:!0,addToState:!1}),l.length>0&&(yield e.addLiveEvents(l,{fromCache:!1,addToState:!1})),e.recalculate(),n.resolveInvites(e)}))()}resolveInvites(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership(g.O.Invite).forEach((function(r){if(!r.requestedProfileInfo){r.requestedProfileInfo=!0;var n,i=t.getUser(r.userId);n=i?Promise.resolve({avatar_url:i.avatarUrl,displayname:i.displayName}):t.getProfileInfo(r.userId),n.then((function(t){var n=r.events.member;n.getContent().membership===g.O.Invite&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))}),(function(e){}))}}))}}retryImmediately(){return!0}sync(){var e=this;return(0,i.A)((function*(){s.v.debug("Sliding sync init loop");while(!e.client.isGuest())try{s.v.debug("Getting push rules...");var t=yield e.client.getPushRules();s.v.debug("Got push rules"),e.client.pushRules=t;break}catch(r){if(s.v.error("Getting push rules failed",r),e.shouldAbortSync(r))return}yield e.slidingSync.start()}))()}stop(){s.v.debug("SyncApi.stop"),this.slidingSync.stop()}updateSyncState(e,t){var r=this.syncState;this.syncState=e,this.syncStateData=t,this.client.emit(l.AU.Sync,this.syncState,r,t)}addNotifications(e){if(this.client.getNotifTimelineSet())for(var t of e){var r=this.client.getPushActionsForEvent(t);r&&r.notify&&r.tweaks&&r.tweaks.highlight&&this.notifEvents.push(t)}}purgeNotifications(){this.notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this.notifEvents.forEach((e=>{var t;null===(t=this.client.getNotifTimelineSet())||void 0===t||t.addLiveEvent(e,{addToState:!1})})),this.notifEvents=[]}}function I(e,t,r){if(!r.name)return r;for(var n of r.required_state)if(n.type===v.Bx.RoomName&&""===n.state_key)return n.content={name:r.name},r;return r.required_state.push({event_id:"$fake-sliding-sync-name-event-"+t,state_key:"",type:v.Bx.RoomName,content:{name:r.name},sender:e.getUserId(),origin_server_ts:(new Date).getTime()}),r}function T(e,t,r){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=e.getEventMapper({decrypt:n});return r.map((function(e){return e.room_id=t,i(e)}))}function R(e,t,r){var n=T(e,t,r),i=e.getRoom(t);i?(i.addEphemeralEvents(n),n.forEach((t=>{e.emit(l.AU.Event,t)}))):s.v.warn("got ephemeral events for room but room doesn't exist on client:",t)}},4204:function(e,t,r){"use strict";var n=r(7080),i=r(4402).add,o=r(9286),s=r(3789),a=r(507);e.exports=function(e){var t=n(this),r=s(e).getIterator(),c=o(t);return a(r,(function(e){i(c,e)})),c}},4209:function(e,t,r){"use strict";var n=r(8227),i=r(6269),o=n("iterator"),s=Array.prototype;e.exports=function(e){return void 0!==e&&(i.Array===e||s[o]===e)}},4215:function(e,t,r){"use strict";var n=r(4576),i=r(2839),o=r(2195),s=function(e){return i.slice(0,e.length)===e};e.exports=function(){return s("Bun/")?"BUN":s("Cloudflare-Workers")?"CLOUDFLARE":s("Deno/")?"DENO":s("Node.js/")?"NODE":n.Bun&&"string"==typeof Bun.version?"BUN":n.Deno&&"object"==typeof Deno.version?"DENO":"process"===o(n.process)?"NODE":n.window&&n.document?"BROWSER":"REST"}()},4229:function(e,t,r){"use strict";r.d(t,{M6:function(){return o},qr:function(){return s},xu:function(){return i}});r(4114);var n=r(4761);class i{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}get names(){var e=[this.name],t=this.altName;return t&&e.push(t),e}matches(e){return this.name===e||this.altName===e}findIn(e){var t=void 0;return this.name&&(t=null===e||void 0===e?void 0:e[this.name]),!t&&this.altName&&(t=null===e||void 0===e?void 0:e[this.altName]),t}includedIn(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}class o extends i{constructor(){super(...arguments),(0,n.A)(this,"preferUnstable",!1)}setPreferUnstable(e){this.preferUnstable=e}get name(){return this.stable&&!this.preferUnstable?this.stable:this.unstable}}class s extends i{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}},4270:function(e,t,r){"use strict";var n=r(9565),i=r(4901),o=r(34),s=TypeError;e.exports=function(e,t){var r,a;if("string"===t&&i(r=e.toString)&&!o(a=n(r,e)))return a;if(i(r=e.valueOf)&&!o(a=n(r,e)))return a;if("string"!==t&&i(r=e.toString)&&!o(a=n(r,e)))return a;throw new s("Can't convert object to primitive value")}},4279:function(e,t,r){"use strict";r.d(t,{y:function(){return a}});r(4603),r(7566),r(8721);var n=/^(?:(?:\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})|(?:\[[\dA-Fa-f:.]{2,45}])|(?:[A-Za-z\d\-.]{1,255}))(?::\d{1,5})?$/;function i(e){var t=n.exec(e);return(null===t||void 0===t?void 0:t[0])===e}var o=/^[\w-]+$/;function s(e){var t=o.exec(e);return(null===t||void 0===t?void 0:t[0])===e}function a(e,t,r,n,o){var a=arguments.length>5&&void 0!==arguments[5]&&arguments[5],c=arguments.length>6?arguments[6]:void 0,l=arguments.length>7?arguments[7]:void 0;if("string"!==typeof t||!t)return"";if(!t.startsWith("mxc://"))return a?t:"";var d,[u,h,...v]=t.slice(6).split("/");if(v.length>0||!i(u)||!s(h))return"";l&&(c=!0);var p=!!r||!!n||!!o,f=p?"thumbnail":"download";d=l?"/_matrix/client/v1/media/".concat(f):"/_matrix/media/v3/".concat(f);var g=new URL("".concat(d,"/").concat(u,"/").concat(h),e);return r&&g.searchParams.set("width",Math.round(r).toString()),n&&g.searchParams.set("height",Math.round(n).toString()),o&&g.searchParams.set("method",o),"boolean"===typeof c&&g.searchParams.set("allow_redirect",JSON.stringify(c)),g.href}},4376:function(e,t,r){"use strict";var n=r(2195);e.exports=Array.isArray||function(e){return"Array"===n(e)}},4402:function(e,t,r){"use strict";var n=r(9504),i=Set.prototype;e.exports={Set:Set,add:n(i.add),has:n(i.has),remove:n(i["delete"]),proto:i}},4449:function(e,t,r){"use strict";var n=r(7080),i=r(4402).has,o=r(5170),s=r(3789),a=r(8469),c=r(507),l=r(9539);e.exports=function(e){var t=n(this),r=s(e);if(o(t)<=r.size)return!1!==a(t,(function(e){if(r.includes(e))return!1}),!0);var d=r.getIterator();return!1!==c(d,(function(e){if(i(t,e))return l(d,"normal",!1)}))}},4477:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}r(4114),r(8111),r(2489),r(116),r(7588),Object.defineProperty(t,"__esModule",{value:!0}),t.MessageEvent=void 0;var i=r(6977),o=r(5499),s=r(3339),a=r(1711),c=r(1880);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){E(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function v(e,t,r){return t&&h(e.prototype,t),r&&h(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function p(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function g(e){var t=S();return function(){var r,n=b(e);if(t){var i=b(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return m(this,r)}}function m(e,t){if(t&&("object"===n(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return y(e)}function y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function S(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function b(e){return b=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},b(e)}function E(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var _=function(e){p(r,e);var t=g(r);function r(e){var n;u(this,r),n=t.call(this,e),E(y(n),"text",void 0),E(y(n),"html",void 0),E(y(n),"renderings",void 0);var i=a.M_MESSAGE.findIn(n.wireContent),c=a.M_TEXT.findIn(n.wireContent),l=a.M_HTML.findIn(n.wireContent);if((0,o.isProvided)(i)){if(!Array.isArray(i))throw new s.InvalidEventError("m.message contents must be an array");var d=i.find((function(e){return!(0,o.isProvided)(e.mimetype)||"text/plain"===e.mimetype})),h=i.find((function(e){return"text/html"===e.mimetype}));if(!d)throw new s.InvalidEventError("m.message is missing a plain text representation");n.text=d.body,n.html=null===h||void 0===h?void 0:h.body,n.renderings=i}else{if(!(0,o.isOptionalAString)(c))throw new s.InvalidEventError("Missing textual representation for event");n.text=c,n.html=l,n.renderings=[{body:c,mimetype:"text/plain"}],n.html&&n.renderings.push({body:n.html,mimetype:"text/html"})}return n}return v(r,[{key:"isEmote",get:function(){return a.M_EMOTE.matches(this.wireFormat.type)||(0,o.isProvided)(a.M_EMOTE.findIn(this.wireFormat.content))}},{key:"isNotice",get:function(){return a.M_NOTICE.matches(this.wireFormat.type)||(0,o.isProvided)(a.M_NOTICE.findIn(this.wireFormat.content))}},{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,a.M_MESSAGE)}},{key:"serializeMMessageOnly",value:function(){var e=E({},a.M_MESSAGE.name,this.renderings);if(1===this.renderings.length){var t=this.renderings[0].mimetype;void 0!==t&&"text/plain"!==t||(e=E({},a.M_TEXT.name,this.renderings[0].body))}return e}},{key:"serialize",value:function(){var e;return{type:"m.room.message",content:d(d({},this.serializeMMessageOnly()),{},{body:this.text,msgtype:"m.text",format:this.html?"org.matrix.custom.html":void 0,formatted_body:null!==(e=this.html)&&void 0!==e?e:void 0})}}}],[{key:"from",value:function(e,t){var n;return new r({type:a.M_MESSAGE.name,content:(n={},E(n,a.M_TEXT.name,e),E(n,a.M_HTML.name,t),n)})}}]),r}(i.ExtensibleEvent);t.MessageEvent=_},4483:function(e,t,r){"use strict";var n,i,o,s,a=r(4576),c=r(9429),l=r(1548),d=a.structuredClone,u=a.ArrayBuffer,h=a.MessageChannel,v=!1;if(l)v=function(e){d(e,{transfer:[e]})};else if(u)try{h||(n=c("worker_threads"),n&&(h=n.MessageChannel)),h&&(i=new h,o=new u(2),s=function(e){i.port1.postMessage(null,[e])},2===o.byteLength&&(s(o),0===o.byteLength&&(v=s)))}catch(p){}e.exports=v},4495:function(e,t,r){"use strict";var n=r(9519),i=r(9039),o=r(4576),s=o.String;e.exports=!!Object.getOwnPropertySymbols&&!i((function(){var e=Symbol("symbol detection");return!s(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&n&&n<41}))},4501:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=o(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==r["return"]||r["return"]()}finally{if(c)throw s}}}}function o(e,t){if(e){if("string"===typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(e,t):void 0}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,u(n.key),n)}}function l(e,t,r){return t&&c(e.prototype,t),r&&c(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(e,t,r){return t=u(t),t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function u(e){var t=h(e,"string");return"symbol"===n(t)?t:String(t)}function h(e,t){if("object"!==n(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}r(4114),Object.defineProperty(t,"__esModule",{value:!0}),t.SimpleObservable=void 0;var v=function(){function e(t){a(this,e),d(this,"listeners",[]),t&&this.listeners.push(t)}return l(e,[{key:"onUpdate",value:function(e){this.listeners.push(e)}},{key:"update",value:function(e){var t,r=i(this.listeners);try{for(r.s();!(t=r.n()).done;){var n=t.value;n(e)}}catch(o){r.e(o)}finally{r.f()}}},{key:"close",value:function(){this.listeners=[]}}]),e}();t.SimpleObservable=v},4519:function(e,t,r){"use strict";r.d(t,{A:function(){return s}});r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);var n=r(698),i=r(944),o=r(8772);function s(e,t,r){return a.apply(this,arguments)}function a(){return a=(0,n.A)((function*(e,t,r){var[n,s]=yield(0,o.C)(t,r),a=(0,i.y4)(e.ciphertext);if(!(yield globalThis.crypto.subtle.verify({name:"HMAC"},s,(0,i.y4)(e.mac),a)))throw new Error("Error decrypting secret ".concat(r,": bad MAC"));var c=yield globalThis.crypto.subtle.decrypt({name:"AES-CTR",counter:(0,i.y4)(e.iv),length:64},n,a);return(new TextDecoder).decode(new Uint8Array(c))})),a.apply(this,arguments)}},4520:function(e,t,r){"use strict";r.d(t,{I:function(){return n}});var n=function(e){return e["CONNECTION_STATS"]="StatsReport.connection_stats",e["CALL_FEED_REPORT"]="StatsReport.call_feed_report",e["BYTE_SENT_STATS"]="StatsReport.byte_sent_stats",e["SUMMARY_STATS"]="StatsReport.summary_stats",e}({})},4527:function(e,t,r){"use strict";var n=r(3724),i=r(4376),o=TypeError,s=Object.getOwnPropertyDescriptor,a=n&&!function(){if(void 0!==this)return!0;try{Object.defineProperty([],"length",{writable:!1}).length=1}catch(e){return e instanceof TypeError}}();e.exports=a?function(e,t){if(i(e)&&!s(e,"length").writable)throw new o("Cannot set read only .length");return e.length=t}:function(e,t){return e.length=t}},4576:function(e,t,r){"use strict";var n=function(e){return e&&e.Math===Math&&e};e.exports=n("object"==typeof globalThis&&globalThis)||n("object"==typeof window&&window)||n("object"==typeof self&&self)||n("object"==typeof r.g&&r.g)||n("object"==typeof this&&this)||function(){return this}()||Function("return this")()},4579:function(e,t,r){"use strict";r(4114),Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetParser=void 0;var n=r(5728),i=r(650);function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function s(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=a(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){c=!0,o=e},f:function(){try{s||null==r["return"]||r["return"]()}finally{if(c)throw o}}}}function a(e,t){if(e){if("string"===typeof e)return c(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?c(e,t):void 0}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,h(n.key),n)}}function u(e,t,r){return t&&d(e.prototype,t),r&&d(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function h(e){var t=v(e,"string");return"symbol"===o(t)?t:String(t)}function v(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==o(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var p=function(){function e(){l(this,e)}return u(e,null,[{key:"parseAccountData",value:function(t){if(!t)return[];for(var r=[],n=0,i=Object.keys(t);n<i.length;n++){var o=i[n],s=t[o];if(s&&(("m.widget"===s.type||"im.vector.modular.widgets"===s.type)&&s.sender)){var a=s.state_key||s.id;if(a===o){var c={content:s.content,sender:s.sender,type:"m.widget",state_key:o,event_id:"$example",room_id:"!example",origin_server_ts:1},l=e.parseRoomWidget(c);l&&r.push(l)}}}return r}},{key:"parseWidgetsFromRoomState",value:function(t){if(!t)return[];var r,n=[],i=s(t);try{for(i.s();!(r=i.n()).done;){var o=r.value,a=e.parseRoomWidget(o);a&&n.push(a)}}catch(c){i.e(c)}finally{i.f()}return n}},{key:"parseRoomWidget",value:function(t){if(!t)return null;if("m.widget"!==t.type&&"im.vector.modular.widgets"!==t.type)return null;var r=t.content||{},n={id:t.state_key,creatorUserId:r["creatorUserId"]||t.sender,name:r["name"],type:r["type"],url:r["url"],waitForIframeLoad:r["waitForIframeLoad"],data:r["data"]};return e.processEstimatedWidget(n)}},{key:"processEstimatedWidget",value:function(e){return e.id&&e.creatorUserId&&e.type&&(0,i.isValidUrl)(e.url)?new n.Widget(e):null}}]),e}();t.WidgetParser=p},4603:function(e,t,r){"use strict";var n=r(6840),i=r(9504),o=r(655),s=r(2812),a=URLSearchParams,c=a.prototype,l=i(c.append),d=i(c["delete"]),u=i(c.forEach),h=i([].push),v=new a("a=1&a=2&b=3");v["delete"]("a",1),v["delete"]("b",void 0),v+""!=="a=2"&&n(c,"delete",(function(e){var t=arguments.length,r=t<2?void 0:arguments[1];if(t&&void 0===r)return d(this,e);var n=[];u(this,(function(e,t){h(n,{key:t,value:e})})),s(t,1);var i,a=o(e),c=o(r),v=0,p=0,f=!1,g=n.length;while(v<g)i=n[v++],f||i.key===a?(f=!0,d(this,i.key)):p++;while(p<g)i=n[p++],i.key===a&&i.value===c||l(this,i.key,i.value)}),{enumerable:!0,unsafe:!0})},4644:function(e,t,r){"use strict";var n,i,o,s=r(7811),a=r(3724),c=r(4576),l=r(4901),d=r(34),u=r(9297),h=r(6955),v=r(6823),p=r(6699),f=r(6840),g=r(2106),m=r(1625),y=r(2787),S=r(2967),b=r(8227),E=r(3392),_=r(1181),w=_.enforce,I=_.get,T=c.Int8Array,R=T&&T.prototype,k=c.Uint8ClampedArray,A=k&&k.prototype,C=T&&y(T),O=R&&y(R),D=Object.prototype,M=c.TypeError,P=b("toStringTag"),x=E("TYPED_ARRAY_TAG"),U="TypedArrayConstructor",L=s&&!!S&&"Opera"!==h(c.opera),N=!1,B={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},K={BigInt64Array:8,BigUint64Array:8},F=function(e){if(!d(e))return!1;var t=h(e);return"DataView"===t||u(B,t)||u(K,t)},j=function(e){var t=y(e);if(d(t)){var r=I(t);return r&&u(r,U)?r[U]:j(t)}},q=function(e){if(!d(e))return!1;var t=h(e);return u(B,t)||u(K,t)},V=function(e){if(q(e))return e;throw new M("Target is not a typed array")},G=function(e){if(l(e)&&(!S||m(C,e)))return e;throw new M(v(e)+" is not a typed array constructor")},W=function(e,t,r,n){if(a){if(r)for(var i in B){var o=c[i];if(o&&u(o.prototype,e))try{delete o.prototype[e]}catch(s){try{o.prototype[e]=t}catch(l){}}}O[e]&&!r||f(O,e,r?t:L&&R[e]||t,n)}},H=function(e,t,r){var n,i;if(a){if(S){if(r)for(n in B)if(i=c[n],i&&u(i,e))try{delete i[e]}catch(o){}if(C[e]&&!r)return;try{return f(C,e,r?t:L&&C[e]||t)}catch(o){}}for(n in B)i=c[n],!i||i[e]&&!r||f(i,e,t)}};for(n in B)i=c[n],o=i&&i.prototype,o?w(o)[U]=i:L=!1;for(n in K)i=c[n],o=i&&i.prototype,o&&(w(o)[U]=i);if((!L||!l(C)||C===Function.prototype)&&(C=function(){throw new M("Incorrect invocation")},L))for(n in B)c[n]&&S(c[n],C);if((!L||!O||O===D)&&(O=C.prototype,L))for(n in B)c[n]&&S(c[n].prototype,O);if(L&&y(A)!==O&&S(A,O),a&&!u(O,P))for(n in N=!0,g(O,P,{configurable:!0,get:function(){return d(this)?this[x]:void 0}}),B)c[n]&&p(c[n],x,n);e.exports={NATIVE_ARRAY_BUFFER_VIEWS:L,TYPED_ARRAY_TAG:N&&x,aTypedArray:V,aTypedArrayConstructor:G,exportTypedArrayMethod:W,exportTypedArrayStaticMethod:H,getTypedArrayConstructor:j,isView:F,isTypedArray:q,TypedArray:C,TypedArrayPrototype:O}},4653:function(e,t,r){"use strict";r.d(t,{t:function(){return s}});r(4114);var n=r(4761),i=r(9927),o=r(3178);class s{constructor(e,t){this.client=e,this.room=t,(0,n.A)(this,"relations",new Map)}getChildEventsForEvent(e,t,r){var n;return null===(n=this.relations.get(e))||void 0===n||null===(n=n.get(t))||void 0===n?void 0:n.get(r)}getAllChildEventsForEvent(e){var t,r=null!==(t=this.relations.get(e))&&void 0!==t?t:new Map,n=[];for(var i of r.values())for(var o of i.values())n.push(...o.getRelations());return n}aggregateParentEvent(e){var t=this.relations.get(e.getId());if(t)for(var r of t.values())for(var n of r.values())n.setTargetEvent(e)}aggregateChildEvent(e,t){if(!e.isRedacted()&&e.status!==o.fb.CANCELLED){var r=e.getRelation();if(r){var n=()=>{e.isDecryptionFailure()?e.once(o.OQ.Decrypted,n):this.aggregateChildEvent(e,t)};if(e.isBeingDecrypted()||e.shouldAttemptDecryption())e.once(o.OQ.Decrypted,n);else{var{event_id:s,rel_type:a}=r,c=e.getType(),l=this.relations.get(s);l||(l=new Map,this.relations.set(s,l));var d=l.get(a);d||(d=new Map,l.set(a,d));var u=d.get(c);if(!u){var h,v,p;u=new i.s(a,c,this.client),d.set(c,u);var f=null!==(h=this.room)&&void 0!==h?h:null===t||void 0===t?void 0:t.room,g=null!==(v=null!==(p=null===t||void 0===t?void 0:t.findEventById(s))&&void 0!==p?p:null===f||void 0===f?void 0:f.findEventById(s))&&void 0!==v?v:null===f||void 0===f?void 0:f.getPendingEvent(s);g&&u.setTargetEvent(g)}u.addEvent(e)}}}}}},4659:function(e,t,r){"use strict";var n=r(3724),i=r(4913),o=r(6980);e.exports=function(e,t,r){n?i.f(e,t,o(0,r)):e[t]=r}},4732:function(e,t,r){"use strict";var n=r(4644),i=r(9504),o=r(9306),s=r(5370),a=n.aTypedArray,c=n.getTypedArrayConstructor,l=n.exportTypedArrayMethod,d=i(n.TypedArrayPrototype.sort);l("toSorted",(function(e){void 0!==e&&o(e);var t=a(this),r=s(c(t),t);return d(r,e)}))},4761:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e,t){if("object"!=n(e)||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!=n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function o(e){var t=i(e,"string");return"symbol"==n(t)?t:t+""}function s(e,t,r){return(t=o(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}r.d(t,{A:function(){return s}})},4768:function(e,t,r){"use strict";r.d(t,{eO:function(){return z},BF:function(){return V},AZ:function(){return j},MC:function(){return B},F_:function(){return H},xt:function(){return q},Ad:function(){return K},Iy:function(){return W}});r(4114),r(8111),r(2489),r(116),r(7588),r(1701),r(8237),r(3579);var n=r(698),i=r(4761),o=r(2668),s=r(1240),a=r(3061),c=r(4123),l=r(3271),d=r(5462),u=r(3036),h=r(5629),v=r(9377),p=r(6330),f=r(6170);class g{constructor(){(0,i.A)(this,"bandwidth",{}),(0,i.A)(this,"bitrate",{}),(0,i.A)(this,"packetLoss",{}),(0,i.A)(this,"transport",[])}}class m{static buildBandwidthReport(e){var t=e.availableIncomingBitrate,r=e.availableOutgoingBitrate;return{download:t?Math.round(t/1e3):0,upload:r?Math.round(r/1e3):0}}}class y{static buildReport(e,t,r,n){var i=null===e||void 0===e?void 0:e.get(t.localCandidateId),o=null===e||void 0===e?void 0:e.get(t.remoteCandidateId);if(o&&i){var s=void 0!==o.ip?o.ip:o.address,a=o.port,c="".concat(s,":").concat(a),l=void 0!==i.ip?i.ip:i.address,d=i.port,u="".concat(l,":").concat(d),h=o.protocol;r.some((e=>e.ip===c&&e.type===h&&e.localIp===u))||r.push({ip:c,type:h,localIp:u,isFocus:n,localCandidateType:i.candidateType,remoteCandidateType:o.candidateType,networkType:i.networkType,rtt:t.currentRoundTripTime?1e3*t.currentRoundTripTime:NaN})}return r}}var S=r(9594);class b{constructor(){(0,i.A)(this,"ssrcToMid",{local:new Map,remote:new Map})}findMidBySsrc(e,t){var r;return this.ssrcToMid[t].forEach(((t,n)=>{t.find((t=>t==e))&&(r=n)})),r}parse(e,t){var r=(0,S.qg)(e),n=new Map;r.media.forEach((e=>{if(e.mid&&"video"===e.type||"audio"===e.type){var t,r=[];null===(t=e.ssrcs)||void 0===t||t.forEach((e=>{"cname"===e.attribute&&r.push("".concat(e.id))})),n.set("".concat(e.mid),r)}})),this.ssrcToMid[t]=n}getSsrcToMidMap(e){return this.ssrcToMid[e]}}class E{constructor(e){this.pc=e}getLocalTracks(e){var t=t=>null!==t&&t.kind===e;return this.pc.getTransceivers().filter((e=>"sendonly"===e.currentDirection||"sendrecv"===e.currentDirection)).filter((e=>null!==e.sender)).map((e=>e.sender)).map((e=>e.track)).filter(t)}getTackById(e){return this.pc.getTransceivers().map((t=>null!==(null===t||void 0===t?void 0:t.sender.track)&&t.sender.track.id===e?t.sender.track:null!==(null===t||void 0===t?void 0:t.receiver.track)&&t.receiver.track.id===e?t.receiver.track:void 0)).find((e=>void 0!==e))}getLocalTrackIdByMid(e){var t,r=this.pc.getTransceivers().find((t=>t.mid===e));return null===r||void 0===r||null===(t=r.sender)||void 0===t||null===(t=t.track)||void 0===t?void 0:t.id}getRemoteTrackIdByMid(e){var t,r=this.pc.getTransceivers().find((t=>t.mid===e));return null===r||void 0===r||null===(t=r.receiver)||void 0===t||null===(t=t.track)||void 0===t?void 0:t.id}getActiveSimulcastStreams(){return 3}getTransceiverByTrackId(e){return this.pc.getTransceivers().find((t=>t.receiver.track.id===e||null!==t.sender.track&&t.sender.track.id===e))}}class _{constructor(e,t,r){this.trackId=e,this.type=t,this.kind=r,(0,i.A)(this,"loss",{packetsTotal:0,packetsLost:0,isDownloadStream:!1}),(0,i.A)(this,"bitrate",{download:0,upload:0}),(0,i.A)(this,"resolution",{width:-1,height:-1}),(0,i.A)(this,"audioConcealment",{concealedAudio:0,totalAudioDuration:0}),(0,i.A)(this,"framerate",0),(0,i.A)(this,"jitter",0),(0,i.A)(this,"codec",""),(0,i.A)(this,"isAlive",!0),(0,i.A)(this,"isMuted",!1),(0,i.A)(this,"isEnabled",!0)}getType(){return this.type}setLoss(e){this.loss=e}getLoss(){return this.loss}setResolution(e){this.resolution=e}getResolution(){return this.resolution}setFramerate(e){this.framerate=e}getFramerate(){return this.framerate}setBitrate(e){this.bitrate=e}getBitrate(){return this.bitrate}setCodec(e){return this.codec=e,!0}getCodec(){return this.codec}resetBitrate(){this.bitrate={download:0,upload:0}}set alive(e){this.isAlive=e}get alive(){return this.isAlive}set muted(e){this.isMuted=e}get muted(){return this.isMuted}set enabled(e){this.isEnabled=e}get enabled(){return this.isEnabled}setJitter(e){this.jitter=e}getJitter(){return this.jitter}setAudioConcealment(e,t){this.audioConcealment.concealedAudio=e,this.audioConcealment.totalAudioDuration=t}getAudioConcealment(){return this.audioConcealment}}class w{constructor(e,t){this.mediaSsrcHandler=e,this.mediaTrackHandler=t,(0,i.A)(this,"track2stats",new Map)}findTrack2Stats(e,t){var r;if(e.trackIdentifier)r=e.trackIdentifier;else if(e.mid)r="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid);else if(e.ssrc){var n=this.mediaSsrcHandler.findMidBySsrc(e.ssrc,t);if(!n)return;r="remote"===t?this.mediaTrackHandler.getRemoteTrackIdByMid(e.mid):this.mediaTrackHandler.getLocalTrackIdByMid(e.mid)}if(r){var i=this.track2stats.get(r);if(!i){var o=this.mediaTrackHandler.getTackById(r);if(void 0===o)return;var s="audio"===o.kind?o.kind:"video";i=new _(r,t,s),this.track2stats.set(r,i)}return i}}findLocalVideoTrackStats(e){var t=this.mediaTrackHandler.getLocalTracks("video");if(0!==t.length)return this.findTrack2Stats(e,"local")}getTrack2stats(){return this.track2stats}findTransceiverByTrackId(e){return this.mediaTrackHandler.getTransceiverByTrackId(e)}}class I{static getNonNegativeValue(e){var t=e;return"number"!==typeof t&&(t=Number(t)),isNaN(t)?0:Math.max(0,t)}}class T{static buildFramerateResolution(e,t){var r={height:t.frameHeight,width:t.frameWidth},n=t.framesPerSecond;r.height&&r.width&&e.setResolution(r),e.setFramerate(Math.round(n||0))}static calculateSimulcastFramerate(e,t,r,n){var i=e.getFramerate();if(!i){if(r){var o=t.timestamp-r.timestamp;if(o>0&&t.framesSent){var s=t.framesSent-r.framesSent;i=s/o*1e3}}if(!i)return}i=n?Math.round(i/n):0,e.setFramerate(i)}static buildCodec(e,t,r){var n=null===e||void 0===e?void 0:e.get(r.codecId);if(n){var i=n.mimeType.split("/")[1];i&&t.setCodec(i)}}static buildBitrateReceived(e,t,r){e.setBitrate({download:T.calculateBitrate(t.bytesReceived,r.bytesReceived,t.timestamp,r.timestamp),upload:0})}static buildBitrateSend(e,t,r){e.setBitrate({download:0,upload:this.calculateBitrate(t.bytesSent,r.bytesSent,t.timestamp,r.timestamp)})}static buildPacketsLost(e,t,r){var n="outbound-rtp"===t.type?"packetsSent":"packetsReceived",i=t[n];(!i||i<0)&&(i=0);var o=I.getNonNegativeValue(r[n]),s=Math.max(0,i-o),a=I.getNonNegativeValue(t.packetsLost),c=I.getNonNegativeValue(r.packetsLost),l=Math.max(0,a-c);e.setLoss({packetsTotal:s+l,packetsLost:l,isDownloadStream:"outbound-rtp"!==t.type})}static calculateBitrate(e,t,r,n){var i=I.getNonNegativeValue(e),o=I.getNonNegativeValue(t),s=Math.max(0,i-o),a=r-n,c=0;return a>0&&(c=Math.round(8*s/a)),c}static setTrackStatsState(e,t){var r;if(void 0!==t){var n="remote"===e.getType()?t.receiver.track:null===t||void 0===t||null===(r=t.sender)||void 0===r?void 0:r.track;void 0!==n&&null!==n&&"ended"!==n.readyState?(e.muted=n.muted,e.enabled=n.enabled,e.alive=!0):e.alive=!1}else e.alive=!1}static buildTrackSummary(e){var t={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},r={count:0,muted:0,maxJitter:0,maxPacketLoss:0,concealedAudio:0,totalAudio:0},n=e.filter((e=>"remote"===e.getType())),i=n.filter((e=>"audio"===e.kind));return n.forEach((e=>{var n,o,s="video"===e.kind?t:r;(s.count++,e.alive&&e.muted&&s.muted++,s.maxJitter<e.getJitter()&&(s.maxJitter=e.getJitter()),s.maxPacketLoss<e.getLoss().packetsLost&&(s.maxPacketLoss=e.getLoss().packetsLost),i.length>0)&&(s.concealedAudio+=null===(n=e.getAudioConcealment())||void 0===n?void 0:n.concealedAudio,s.totalAudio+=null===(o=e.getAudioConcealment())||void 0===o?void 0:o.totalAudioDuration)})),{audioTrackSummary:r,videoTrackSummary:t}}static buildJitter(e,t){if("inbound-rtp"===t.type){var r=null===t||void 0===t?void 0:t.jitter;if(void 0!==r){var n=I.getNonNegativeValue(r);e.setJitter(Math.round(1e3*n))}else e.setJitter(-1)}}static buildAudioConcealment(e,t){if("inbound-rtp"===t.type){var r=1e3*(null===t||void 0===t?void 0:t.totalSamplesDuration)/(null===t||void 0===t?void 0:t.totalSamplesReceived),n=r*(null===t||void 0===t?void 0:t.concealedSamples),i=1e3*(null===t||void 0===t?void 0:t.totalSamplesDuration);e.setAudioConcealment(n,i)}}}class R{static build(e){var t={},r={download:0,upload:0},n={download:0,upload:0},i=0,o=0,s={local:new Map,remote:new Map},a={local:new Map,remote:new Map},c={local:new Map,remote:new Map},l=new Map,d=new Map,u=0,h=0,v=0,p=0,f=0,g=0;for(var[m,y]of e){var S=y.getLoss(),b=S.isDownloadStream?"download":"upload";if(r[b]+=S.packetsTotal,n[b]+=S.packetsLost,i+=y.getBitrate().download,o+=y.getBitrate().upload,"audio"===y.kind){var E=y.getAudioConcealment();f+=E.concealedAudio,g+=E.totalAudioDuration,u+=y.getBitrate().download,h+=y.getBitrate().upload}else v+=y.getBitrate().download,p+=y.getBitrate().upload;s[y.getType()].set(m,y.getResolution()),a[y.getType()].set(m,y.getFramerate()),c[y.getType()].set(m,y.getCodec()),"remote"===y.getType()&&(l.set(m,y.getJitter()),"audio"===y.kind&&d.set(m,y.getAudioConcealment())),y.resetBitrate()}return t.bitrate={upload:o,download:i},t.bitrate.audio={upload:h,download:u},t.bitrate.video={upload:p,download:v},t.packetLoss={total:R.calculatePacketLoss(n.download+n.upload,r.download+r.upload),download:R.calculatePacketLoss(n.download,r.download),upload:R.calculatePacketLoss(n.upload,r.upload)},t.audioConcealment=d,t.totalAudioConcealment={concealedAudio:f,totalAudioDuration:g},t.framerate=a,t.resolution=s,t.codec=c,t.jitter=l,t}static calculatePacketLoss(e,t){return!t||t<=0||!e||e<=0?0:Math.round(e/t*100)}}class k{static buildCallFeedReport(e,t,r){var n=r.getTransceivers(),i=[],o=[];return n.forEach((e=>{var t,r=null!==(t=e.sender)&&void 0!==t&&t.track?k.buildTrackStats(e.sender.track,"sender"):null,n=k.buildTrackStats(e.receiver.track,"receiver");i.push({mid:null==e.mid?"null":e.mid,direction:e.direction,currentDirection:null==e.currentDirection?"null":e.currentDirection,sender:r,receiver:n})})),{callId:e,opponentMemberId:t,transceiver:i,callFeeds:o}}static buildTrackStats(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"--",i=null===(t=e.getSettings())||void 0===t?void 0:t.deviceId,o=null===(r=e.getConstraints())||void 0===r?void 0:r.deviceId;return{id:e.id,kind:e.kind,settingDeviceId:null!==i&&void 0!==i?i:"unknown",constrainDeviceId:null!==o&&void 0!==o?o:"unknown",muted:e.muted,enabled:e.enabled,readyState:e.readyState,label:n}}static expandCallFeedReport(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"unknown";return t.forEach((t=>{var n=t.stream.getAudioTracks(),i=t.stream.getVideoTracks(),o=n.length>0?k.buildTrackStats(t.stream.getAudioTracks()[0],t.purpose):null,s=i.length>0?k.buildTrackStats(t.stream.getVideoTracks()[0],t.purpose):null,a={stream:t.stream.id,type:t.isLocal()?"local":"remote",audio:o,video:s,purpose:t.purpose,prefix:r,isVideoMuted:t.isVideoMuted(),isAudioMuted:t.isAudioMuted()};e.callFeeds.push(a)})),e}}function A(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function C(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?A(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):A(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class O{constructor(e,t,r,n){var o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];this.callId=e,this.opponentMemberId=t,this.pc=r,this.emitter=n,this.isFocus=o,(0,i.A)(this,"isActive",!0),(0,i.A)(this,"previousStatsReport",void 0),(0,i.A)(this,"currentStatsReport",void 0),(0,i.A)(this,"connectionStats",new g),(0,i.A)(this,"trackStats",void 0),r.addEventListener("signalingstatechange",this.onSignalStateChange.bind(this)),this.trackStats=new w(new b,new E(r))}processStats(e,t){var r=this;return(0,n.A)((function*(){var n={isFirstCollection:void 0===r.previousStatsReport,receivedMedia:0,receivedAudioMedia:0,receivedVideoMedia:0,audioTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0},videoTrackSummary:{count:0,muted:0,maxPacketLoss:0,maxJitter:0,concealedAudio:0,totalAudio:0}};if(r.isActive){var i=r.pc.getStats();if("function"===typeof(null===i||void 0===i?void 0:i.then))return i.then((i=>{var o,s;r.currentStatsReport="function"===typeof(null===i||void 0===i?void 0:i.result)?i.result():i;try{r.processStatsReport(e,t)}catch(c){return r.handleError(c),n}r.previousStatsReport=r.currentStatsReport,n.receivedMedia=r.connectionStats.bitrate.download,n.receivedAudioMedia=(null===(o=r.connectionStats.bitrate.audio)||void 0===o?void 0:o.download)||0,n.receivedVideoMedia=(null===(s=r.connectionStats.bitrate.video)||void 0===s?void 0:s.download)||0;var a=T.buildTrackSummary(Array.from(r.trackStats.getTrack2stats().values()));return C(C({},n),{},{audioTrackSummary:a.audioTrackSummary,videoTrackSummary:a.videoTrackSummary})})).catch((e=>(r.handleError(e),n)));r.isActive=!1}return Promise.resolve(n)}))()}processStatsReport(e,t){var r,n=new Map;n.callId=this.callId,n.opponentMemberId=this.opponentMemberId,null===(r=this.currentStatsReport)||void 0===r||r.forEach((e=>{var t=this.previousStatsReport?this.previousStatsReport.get(e.id):null;if("candidate-pair"===e.type&&e.nominated&&"succeeded"===e.state)this.connectionStats.bandwidth=m.buildBandwidthReport(e),this.connectionStats.transport=y.buildReport(this.currentStatsReport,e,this.connectionStats.transport,this.isFocus);else if("inbound-rtp"===e.type||"outbound-rtp"===e.type){var r=this.trackStats.findTrack2Stats(e,"inbound-rtp"===e.type?"remote":"local");if(!r)return;if(t&&T.buildPacketsLost(r,e,t),"inbound-rtp"===e.type){T.buildFramerateResolution(r,e),t&&T.buildBitrateReceived(r,e,t);var i=this.trackStats.findTransceiverByTrackId(r.trackId);T.setTrackStatsState(r,i),T.buildJitter(r,e),T.buildAudioConcealment(r,e)}else t&&(n.set(r.trackId,I.getNonNegativeValue(e.bytesSent)),T.buildBitrateSend(r,e,t));T.buildCodec(this.currentStatsReport,r,e)}else if("track"===e.type&&"video"===e.kind&&!e.remoteSource){var o=this.trackStats.findLocalVideoTrackStats(e);if(!o)return;T.buildFramerateResolution(o,e),T.calculateSimulcastFramerate(o,e,t,this.trackStats.mediaTrackHandler.getActiveSimulcastStreams())}})),this.emitter.emitByteSendReport(n),this.emitter.emitCallFeedReport(k.buildCallFeedReport(this.callId,this.opponentMemberId,this.pc)),this.processAndEmitConnectionStatsReport()}setActive(e){this.isActive=e}getActive(){return this.isActive}handleError(e){this.isActive=!1,l.v.warn("CallStatsReportGatherer ".concat(this.callId," processStatsReport fails and set to inactive ").concat(e))}processAndEmitConnectionStatsReport(){var e=R.build(this.trackStats.getTrack2stats());e.callId=this.callId,e.opponentMemberId=this.opponentMemberId,this.connectionStats.bandwidth=e.bandwidth,this.connectionStats.bitrate=e.bitrate,this.connectionStats.packetLoss=e.packetLoss,this.emitter.emitConnectionStatsReport(C(C({},e),{},{transport:this.connectionStats.transport})),this.connectionStats.transport=[]}stopProcessingStats(){}onSignalStateChange(){"stable"===this.pc.signalingState&&(this.pc.currentRemoteDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentRemoteDescription.sdp,"remote"),this.pc.currentLocalDescription&&this.trackStats.mediaSsrcHandler.parse(this.pc.currentLocalDescription.sdp,"local"))}setOpponentMemberId(e){this.opponentMemberId=e}}var D=r(4520);class M extends o.X{emitByteSendReport(e){this.emit(D.I.BYTE_SENT_STATS,e)}emitConnectionStatsReport(e){this.emit(D.I.CONNECTION_STATS,e)}emitCallFeedReport(e){this.emit(D.I.CALL_FEED_REPORT,e)}emitSummaryStatsReport(e){this.emit(D.I.SUMMARY_STATS,e)}}class P{constructor(e){this.emitter=e}build(e){var t=e.filter((e=>!e.isFirstCollection)),r=t.length,n=e.length;if(0!==r){var i={receivedAudio:0,receivedVideo:0,receivedMedia:0,concealedAudio:0,totalAudio:0},o=0,s=0;t.forEach((e=>{this.countTrackListReceivedMedia(i,e),this.countConcealedAudio(i,e),o=this.buildMaxJitter(o,e),s=this.buildMaxPacketLoss(s,e)}));var a=5,c={percentageReceivedMedia:Number((i.receivedMedia/r).toFixed(a)),percentageReceivedVideoMedia:Number((i.receivedVideo/r).toFixed(a)),percentageReceivedAudioMedia:Number((i.receivedAudio/r).toFixed(a)),maxJitter:o,maxPacketLoss:s,percentageConcealedAudio:Number(i.totalAudio>0?(i.concealedAudio/i.totalAudio).toFixed(a):0),peerConnections:n};this.emitter.emitSummaryStatsReport(c)}}static extendSummaryReport(e,t){var r=[],n=[];for(var i of t)for(var o of(n.push(i),i[1]))r.push(o);e.opponentDevicesInCall=Math.max(0,r.length-1),e.opponentUsersInCall=Math.max(0,n.length-1),e.diffDevicesToPeerConnections=Math.max(0,r.length-1)-e.peerConnections,e.ratioPeerConnectionToDevices=0==Math.max(0,r.length-1)?0:e.peerConnections/(r.length-1)}countTrackListReceivedMedia(e,t){var r=!1,n=!1;(t.receivedAudioMedia>0||0===t.audioTrackSummary.count)&&(e.receivedAudio++,r=!0),(t.receivedVideoMedia>0||0===t.videoTrackSummary.count||t.videoTrackSummary.muted>0&&t.videoTrackSummary.muted===t.videoTrackSummary.count)&&(e.receivedVideo++,n=!0),n&&r&&e.receivedMedia++}buildMaxJitter(e,t){return e<t.videoTrackSummary.maxJitter&&(e=t.videoTrackSummary.maxJitter),e<t.audioTrackSummary.maxJitter&&(e=t.audioTrackSummary.maxJitter),e}buildMaxPacketLoss(e,t){return e<t.videoTrackSummary.maxPacketLoss&&(e=t.videoTrackSummary.maxPacketLoss),e<t.audioTrackSummary.maxPacketLoss&&(e=t.audioTrackSummary.maxPacketLoss),e}countConcealedAudio(e,t){e.concealedAudio+=t.audioTrackSummary.concealedAudio,e.totalAudio+=t.audioTrackSummary.totalAudio}}class x{constructor(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e4;this.groupCallId=e,this.userId=t,this.interval=r,(0,i.A)(this,"timer",void 0),(0,i.A)(this,"gatherers",new Map),(0,i.A)(this,"reports",new M),(0,i.A)(this,"summaryStatsReportGatherer",new P(this.reports))}start(){void 0===this.timer&&this.interval>0&&(this.timer=setInterval((()=>{this.processStats()}),this.interval))}stop(){void 0!==this.timer&&(clearInterval(this.timer),this.gatherers.forEach((e=>e.stopProcessingStats())))}hasStatsReportGatherer(e){return this.gatherers.has(e)}addStatsReportGatherer(e,t,r){return!this.hasStatsReportGatherer(e)&&(this.gatherers.set(e,new O(e,t,r,this.reports)),!0)}removeStatsReportGatherer(e){return this.gatherers.delete(e)}getStatsReportGatherer(e){return this.hasStatsReportGatherer(e)?this.gatherers.get(e):void 0}updateOpponentMember(e,t){var r;null===(r=this.getStatsReportGatherer(e))||void 0===r||r.setOpponentMemberId(t)}processStats(){var e=[];this.gatherers.forEach((t=>{e.push(t.processStats(this.groupCallId,this.userId))})),Promise.all(e).then((e=>this.summaryStatsReportGatherer.build(e))).catch((e=>{l.v.error("Could not build summary stats report",e)}))}setInterval(e){this.interval=e}}var U=r(3877);function L(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function N(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?L(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):L(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var B=function(e){return e["Ring"]="m.ring",e["Prompt"]="m.prompt",e["Room"]="m.room",e}({}),K=function(e){return e["Video"]="m.video",e["Voice"]="m.voice",e}({}),F=function(e){return e["CallEnded"]="call_ended",e}({}),j=function(e){return e["GroupCallStateChanged"]="group_call_state_changed",e["ActiveSpeakerChanged"]="active_speaker_changed",e["CallsChanged"]="calls_changed",e["UserMediaFeedsChanged"]="user_media_feeds_changed",e["ScreenshareFeedsChanged"]="screenshare_feeds_changed",e["LocalScreenshareStateChanged"]="local_screenshare_state_changed",e["LocalMuteStateChanged"]="local_mute_state_changed",e["ParticipantsChanged"]="participants_changed",e["Error"]="group_call_error",e}({}),q=function(e){return e["ConnectionStats"]="GroupCall.connection_stats",e["ByteSentStats"]="GroupCall.byte_sent_stats",e["SummaryStats"]="GroupCall.summary_stats",e["CallFeedStats"]="GroupCall.call_feed_stats",e}({}),V=function(e){return e["NoUserMedia"]="no_user_media",e["UnknownDevice"]="unknown_device",e["PlaceCallFailed"]="place_call_failed",e}({});class G extends Error{constructor(e,t,r){r?(super(t+": "+r),(0,i.A)(this,"code",void 0)):(super(t),(0,i.A)(this,"code",void 0)),this.code=e}}class W extends G{constructor(e){super(V.UnknownDevice,"No device found for "+e),this.userId=e}}Error;var H=function(e){return e["LocalCallFeedUninitialized"]="local_call_feed_uninitialized",e["InitializingLocalCallFeed"]="initializing_local_call_feed",e["LocalCallFeedInitialized"]="local_call_feed_initialized",e["Entered"]="entered",e["Ended"]="ended",e}({}),$=36e5;function J(e){var t;return(null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId)||e.invitee||null}class z extends o.X{constructor(e,t,r,n,o,u,v,p,f){var g,m,y=arguments.length>9&&void 0!==arguments[9]&&arguments[9],S=arguments.length>10?arguments[10]:void 0;super(),this.client=e,this.room=t,this.type=r,this.isPtt=n,this.intent=o,this.dataChannelsEnabled=v,this.dataChannelOptions=p,this.useLivekit=y,(0,i.A)(this,"activeSpeakerInterval",1e3),(0,i.A)(this,"retryCallInterval",5e3),(0,i.A)(this,"participantTimeout",15e3),(0,i.A)(this,"pttMaxTransmitTime",2e4),(0,i.A)(this,"activeSpeaker",void 0),(0,i.A)(this,"localCallFeed",void 0),(0,i.A)(this,"localScreenshareFeed",void 0),(0,i.A)(this,"localDesktopCapturerSourceId",void 0),(0,i.A)(this,"userMediaFeeds",[]),(0,i.A)(this,"screenshareFeeds",[]),(0,i.A)(this,"groupCallId",void 0),(0,i.A)(this,"allowCallWithoutVideoAndAudio",void 0),(0,i.A)(this,"calls",new Map),(0,i.A)(this,"callHandlers",new Map),(0,i.A)(this,"activeSpeakerLoopInterval",void 0),(0,i.A)(this,"retryCallLoopInterval",void 0),(0,i.A)(this,"retryCallCounts",new Map),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"transmitTimer",null),(0,i.A)(this,"participantsExpirationTimer",null),(0,i.A)(this,"resendMemberStateTimer",null),(0,i.A)(this,"initWithAudioMuted",!1),(0,i.A)(this,"initWithVideoMuted",!1),(0,i.A)(this,"initCallFeedPromise",void 0),(0,i.A)(this,"_livekitServiceURL",void 0),(0,i.A)(this,"stats",void 0),(0,i.A)(this,"statsCollectIntervalTime",0),(0,i.A)(this,"onConnectionStats",(e=>{this.emit(q.ConnectionStats,{report:e})})),(0,i.A)(this,"onByteSentStats",(e=>{this.emit(q.ByteSentStats,{report:e})})),(0,i.A)(this,"onSummaryStats",(e=>{P.extendSummaryReport(e,this.participants),this.emit(q.SummaryStats,{report:e})})),(0,i.A)(this,"onCallFeedReport",(e=>{this.localCallFeed&&(e=k.expandCallFeedReport(e,[this.localCallFeed],"from-local-feed"));var t=[];this.forEachCall((r=>{r.callId===e.callId&&r.getFeeds().forEach((e=>t.push(e)))})),e=k.expandCallFeedReport(e,t,"from-call-feed"),this.emit(q.CallFeedStats,{report:e})})),(0,i.A)(this,"_state",H.LocalCallFeedUninitialized),(0,i.A)(this,"_participants",new Map),(0,i.A)(this,"_creationTs",null),(0,i.A)(this,"_enteredViaAnotherSession",!1),(0,i.A)(this,"onIncomingCall",(e=>{var t,r;if(e.roomId===this.room.roomId)if(e.state===a.iP.Ringing){if(!e.groupCallId||e.groupCallId!==this.groupCallId)return l.v.log("GroupCall ".concat(this.groupCallId," onIncomingCall() ignored because it doesn't match the current group call")),void e.reject();var n=null===(t=e.getOpponentMember())||void 0===t?void 0:t.userId;if(void 0!==n)if(this.useLivekit)l.v.info("Received incoming call whilst in signaling-only mode! Ignoring.");else{var i=null!==(r=this.calls.get(n))&&void 0!==r?r:new Map,o=i.get(e.getOpponentDeviceId());if((null===o||void 0===o?void 0:o.callId)!==e.callId){l.v.log("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call (userId=").concat(n,", callId=").concat(e.callId,")")),o&&o.hangup(a.Il.Replaced,!1),i.set(e.getOpponentDeviceId(),e),this.calls.set(n,i),this.initCall(e);var s=this.getLocalFeeds().map((e=>e.clone()));if(!this.callExpected(e))for(var c of s)(0,a.ms)(c.stream.getAudioTracks(),!1),(0,a.ms)(c.stream.getVideoTracks(),!1);e.answerWithCallFeeds(s),this.emit(j.CallsChanged,this.calls)}}else l.v.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call with no member - ignoring"))}else l.v.warn("GroupCall ".concat(this.groupCallId," onIncomingCall() incoming call no longer in ringing state - ignoring"))})),(0,i.A)(this,"onRetryCallLoop",(()=>{var e=!1;for(var[{userId:t},r]of this.participants){var n=this.calls.get(t),i=this.retryCallCounts.get(t);for(var[o,s]of r){var a,c,l=null===n||void 0===n?void 0:n.get(o),d=null!==(a=null===(c=i)||void 0===c?void 0:c.get(o))&&void 0!==a?a:0;(null===l||void 0===l?void 0:l.getOpponentSessionId())!==s.sessionId&&this.wantsOutgoingCall(t,o)&&d<3&&(void 0===i&&(i=new Map,this.retryCallCounts.set(t,i)),i.set(o,d+1),e=!0)}}e&&this.placeOutgoingCalls()})),(0,i.A)(this,"onCallFeedsChanged",(e=>{var t=J(e),r=e.getOpponentDeviceId();if(!t)throw new Error("Cannot change call feeds without user id");var n=this.getUserMediaFeed(t,r),i=e.remoteUsermediaFeed,o=i!==n,s=this.calls.get(t),a=null===s||void 0===s?void 0:s.get(r);if((null===a||void 0===a?void 0:a.callId)===e.callId){o&&(!n&&i?this.addUserMediaFeed(i):n&&i?this.replaceUserMediaFeed(n,i):n&&!i&&this.removeUserMediaFeed(n));var c=this.getScreenshareFeed(t,r),l=e.remoteScreensharingFeed,d=l!==c;d&&(!c&&l?this.addScreenshareFeed(l):c&&l?this.replaceScreenshareFeed(c,l):c&&!l&&this.removeScreenshareFeed(c))}})),(0,i.A)(this,"onCallStateChanged",((e,t,r)=>{var n;if(t!==a.iP.Ended){var i=this.localCallFeed.isAudioMuted();e.localUsermediaStream&&e.isMicrophoneMuted()!==i&&e.setMicrophoneMuted(i);var o=this.localCallFeed.isVideoMuted();e.localUsermediaStream&&e.isLocalVideoMuted()!==o&&e.setLocalVideoMuted(o);var s=null===(n=e.getOpponentMember())||void 0===n?void 0:n.userId;if(t===a.iP.Connected&&s){var c=this.retryCallCounts.get(s);null===c||void 0===c||c.delete(e.getOpponentDeviceId()),0===(null===c||void 0===c?void 0:c.size)&&this.retryCallCounts.delete(s)}}})),(0,i.A)(this,"onCallHangup",(e=>{var t,r;if(e.hangupReason!==a.Il.Replaced){var n=null!==(t=null===(r=e.getOpponentMember())||void 0===r?void 0:r.userId)&&void 0!==t?t:this.room.getMember(e.invitee).userId,i=this.calls.get(n);(null===i||void 0===i?void 0:i.get(e.getOpponentDeviceId()))===e&&(this.disposeCall(e,e.hangupReason),i.delete(e.getOpponentDeviceId()),0===i.size&&this.calls.delete(n),this.emit(j.CallsChanged,this.calls))}})),(0,i.A)(this,"onCallReplaced",((e,t)=>{var r=e.getOpponentMember().userId,n=this.calls.get(r);void 0===n&&(n=new Map,this.calls.set(r,n)),e.hangup(a.Il.Replaced,!1),this.initCall(t),n.set(e.getOpponentDeviceId(),t),this.emit(j.CallsChanged,this.calls)})),(0,i.A)(this,"onActiveSpeakerLoop",(()=>{var e=void 0,t=void 0;for(var r of this.userMediaFeeds)if(!(r.isLocal()&&this.userMediaFeeds.length>1)){var n=r.speakingVolumeSamples.reduce(((e,t)=>e+Math.max(t,s.Tw))),i=n/r.speakingVolumeSamples.length;(!e||i>e)&&(e=i,t=r)}t&&this.activeSpeaker!==t&&e&&e>s.Tw&&(this.activeSpeaker=t,this.emit(j.ActiveSpeakerChanged,this.activeSpeaker))})),(0,i.A)(this,"onRoomState",(()=>this.updateParticipants())),(0,i.A)(this,"onParticipantsChanged",(()=>{this.forEachCall((e=>{var t=this.callExpected(e);for(var r of e.getLocalFeeds())(0,a.ms)(r.stream.getAudioTracks(),!r.isAudioMuted()&&t),(0,a.ms)(r.stream.getVideoTracks(),!r.isVideoMuted()&&t)})),this.state!==H.Entered||this.useLivekit||this.placeOutgoingCalls()})),(0,i.A)(this,"onStateChanged",((e,t)=>{e!==H.Entered&&t!==H.Entered&&e!==H.Ended||(this.updateParticipants(),this.updateMemberState().catch((e=>l.v.error("GroupCall ".concat(this.groupCallId,' onStateChanged() failed to update member state devices"'),e))))})),(0,i.A)(this,"onLocalFeedsChanged",(()=>{this.state===H.Entered&&this.updateMemberState().catch((e=>l.v.error("GroupCall ".concat(this.groupCallId," onLocalFeedsChanged() failed to update member state feeds"),e)))})),this.reEmitter=new d.K(this),this.groupCallId=null!==u&&void 0!==u?u:(0,a.WE)(),this._livekitServiceURL=S,this.creationTs=null!==(g=null===(m=t.currentState.getStateEvents(h.Bx.GroupCallPrefix,this.groupCallId))||void 0===m?void 0:m.getTs())&&void 0!==g?g:null,this.updateParticipants(),t.on(c.f.Update,this.onRoomState),this.on(j.ParticipantsChanged,this.onParticipantsChanged),this.on(j.GroupCallStateChanged,this.onStateChanged),this.on(j.LocalScreenshareStateChanged,this.onLocalFeedsChanged),this.allowCallWithoutVideoAndAudio=!!f}create(){var e=this;return(0,n.A)((function*(){return e.creationTs=Date.now(),e.client.groupCallEventHandler.groupCalls.set(e.room.roomId,e),e.client.emit(p.o.Outgoing,e),yield e.sendCallStateEvent(),e}))()}sendCallStateEvent(){var e=this;return(0,n.A)((function*(){var t={"m.intent":e.intent,"m.type":e.type,"io.element.ptt":e.isPtt,dataChannelsEnabled:e.dataChannelsEnabled,dataChannelOptions:e.dataChannelsEnabled?e.dataChannelOptions:void 0};e.livekitServiceURL&&(t["io.element.livekit_service_url"]=e.livekitServiceURL),yield e.client.sendStateEvent(e.room.roomId,h.Bx.GroupCallPrefix,t,e.groupCallId)}))()}get livekitServiceURL(){return this._livekitServiceURL}updateLivekitServiceURL(e){return this._livekitServiceURL=e,this.sendCallStateEvent()}get state(){return this._state}set state(e){var t=this._state;e!==t&&(this._state=e,this.emit(j.GroupCallStateChanged,e,t))}get participants(){return this._participants}set participants(e){var t=this._participants,r=(e,t)=>e.sessionId===t.sessionId&&e.screensharing===t.screensharing,n=(e,t)=>(0,f.kg)(e,t,r);(0,f.kg)(e,t,n)||(this._participants=e,this.emit(j.ParticipantsChanged,e))}get creationTs(){return this._creationTs}set creationTs(e){this._creationTs=e}get enteredViaAnotherSession(){return this._enteredViaAnotherSession}set enteredViaAnotherSession(e){this._enteredViaAnotherSession=e,this.updateParticipants()}forEachCall(e){for(var t of this.calls.values())for(var r of t.values())e(r)}getLocalFeeds(){var e=[];return this.localCallFeed&&e.push(this.localCallFeed),this.localScreenshareFeed&&e.push(this.localScreenshareFeed),e}hasLocalParticipant(){var e,t;return null!==(e=null===(t=this.participants.get(this.room.getMember(this.client.getUserId())))||void 0===t?void 0:t.has(this.client.getDeviceId()))&&void 0!==e&&e}callExpected(e){var t,r=J(e),n=null===r?null:this.room.getMember(r),i=e.getOpponentDeviceId();return null!==n&&void 0!==i&&void 0!==(null===(t=this.participants.get(n))||void 0===t?void 0:t.get(i))}initLocalCallFeed(){var e=this;return(0,n.A)((function*(){if(e.useLivekit)l.v.info("Livekit group call: not starting local call feed.");else{if(e.state!==H.LocalCallFeedUninitialized)throw new Error('Cannot initialize local call feed in the "'.concat(e.state,'" state.'));if(e.state=H.InitializingLocalCallFeed,e.initCallFeedPromise)return e.initCallFeedPromise;try{e.initCallFeedPromise=e.initLocalCallFeedInternal(),yield e.initCallFeedPromise}finally{e.initCallFeedPromise=void 0}}}))()}initLocalCallFeedInternal(){var e=this;return(0,n.A)((function*(){var t;l.v.log("GroupCall ".concat(e.groupCallId," initLocalCallFeedInternal() running"));try{t=yield e.client.getMediaHandler().getUserMediaStream(!0,e.type===K.Video)}catch(n){if(!e.allowCallWithoutVideoAndAudio)throw e.state=H.LocalCallFeedUninitialized,n;t=new MediaStream}if(e._state!==H.InitializingLocalCallFeed)throw e.client.getMediaHandler().stopUserMediaStream(t),new Error("Group call disposed while gathering media stream");var r=new s.Hh({client:e.client,roomId:e.room.roomId,userId:e.client.getUserId(),deviceId:e.client.getDeviceId(),stream:t,purpose:u.h.Usermedia,audioMuted:e.initWithAudioMuted||0===t.getAudioTracks().length||e.isPtt,videoMuted:e.initWithVideoMuted||0===t.getVideoTracks().length});(0,a.ms)(t.getAudioTracks(),!r.isAudioMuted()),(0,a.ms)(t.getVideoTracks(),!r.isVideoMuted()),e.localCallFeed=r,e.addUserMediaFeed(r),e.state=H.LocalCallFeedInitialized}))()}updateLocalUsermediaStream(e){var t=this;return(0,n.A)((function*(){if(t.localCallFeed){var r=t.localCallFeed.stream;t.localCallFeed.setNewStream(e);var n=t.localCallFeed.isAudioMuted(),i=t.localCallFeed.isVideoMuted();l.v.log("GroupCall ".concat(t.groupCallId," updateLocalUsermediaStream() (oldStreamId=").concat(r.id,", newStreamId=").concat(e.id,", micShouldBeMuted=").concat(n,", vidShouldBeMuted=").concat(i,")")),(0,a.ms)(e.getAudioTracks(),!n),(0,a.ms)(e.getVideoTracks(),!i),t.client.getMediaHandler().stopUserMediaStream(r)}}))()}enter(){var e=this;return(0,n.A)((function*(){if(e.state===H.LocalCallFeedUninitialized)yield e.initLocalCallFeed();else if(e.state!==H.LocalCallFeedInitialized)throw new Error('Cannot enter call in the "'.concat(e.state,'" state'));for(var t of(l.v.log("GroupCall ".concat(e.groupCallId," enter() running")),e.state=H.Entered,e.client.on(v.B.Incoming,e.onIncomingCall),e.client.callEventHandler.calls.values()))e.onIncomingCall(t);e.useLivekit||(e.retryCallLoopInterval=setInterval(e.onRetryCallLoop,e.retryCallInterval),e.activeSpeaker=void 0,e.onActiveSpeakerLoop(),e.activeSpeakerLoopInterval=setInterval(e.onActiveSpeakerLoop,e.activeSpeakerInterval))}))()}dispose(){var e;this.localCallFeed&&(this.removeUserMediaFeed(this.localCallFeed),this.localCallFeed=void 0),this.localScreenshareFeed&&(this.client.getMediaHandler().stopScreensharingStream(this.localScreenshareFeed.stream),this.removeScreenshareFeed(this.localScreenshareFeed),this.localScreenshareFeed=void 0,this.localDesktopCapturerSourceId=void 0),this.client.getMediaHandler().stopAllStreams(),null!==this.transmitTimer&&(clearTimeout(this.transmitTimer),this.transmitTimer=null),void 0!==this.retryCallLoopInterval&&(clearInterval(this.retryCallLoopInterval),this.retryCallLoopInterval=void 0),null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state===H.Entered&&(this.forEachCall((e=>e.hangup(a.Il.UserHangup,!1))),this.activeSpeaker=void 0,clearInterval(this.activeSpeakerLoopInterval),this.retryCallCounts.clear(),clearInterval(this.retryCallLoopInterval),this.client.removeListener(v.B.Incoming,this.onIncomingCall),null===(e=this.stats)||void 0===e||e.stop())}leave(){this.dispose(),this.state=H.LocalCallFeedUninitialized}terminate(){var e=arguments,t=this;return(0,n.A)((function*(){var r=!(e.length>0&&void 0!==e[0])||e[0];if(t.dispose(),t.room.off(c.f.Update,t.onRoomState),t.client.groupCallEventHandler.groupCalls.delete(t.room.roomId),t.client.emit(p.o.Ended,t),t.state=H.Ended,r){var n=t.room.currentState.getStateEvents(h.Bx.GroupCallPrefix,t.groupCallId);yield t.client.sendStateEvent(t.room.roomId,h.Bx.GroupCallPrefix,N(N({},n.getContent()),{},{"m.terminated":F.CallEnded}),t.groupCallId)}}))()}isLocalVideoMuted(){return!this.localCallFeed||this.localCallFeed.isVideoMuted()}isMicrophoneMuted(){return!this.localCallFeed||this.localCallFeed.isAudioMuted()}setMicrophoneMuted(e){var t=this;return(0,n.A)((function*(){if(!e&&!(yield t.client.getMediaHandler().hasAudioDevice()))return!1;var r=!e&&t.isPtt;t.isPtt&&(!e&&t.isMicrophoneMuted()?t.transmitTimer=setTimeout((()=>{t.setMicrophoneMuted(!0)}),t.pttMaxTransmitTime):e&&!t.isMicrophoneMuted()&&(null!==t.transmitTimer&&clearTimeout(t.transmitTimer),t.transmitTimer=null)),t.forEachCall((t=>{var r;return null===(r=t.localUsermediaFeed)||void 0===r?void 0:r.setAudioVideoMuted(e,null)}));var i=function(){var e=(0,n.A)((function*(){var e=[];t.forEachCall((t=>e.push(t.sendMetadataUpdate()))),yield Promise.all(e).catch((e=>l.v.info("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() failed to send some metadata updates"),e)))}));return function(){return e.apply(this,arguments)}}();if(r&&(yield i()),t.localCallFeed){l.v.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() (streamId=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));var o=yield t.checkAudioPermissionIfNecessary(e);if(!o)return!1;t.localCallFeed.setAudioVideoMuted(e,null),(0,a.ms)(t.localCallFeed.stream.getAudioTracks(),!e)}else l.v.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no stream muted (muted=").concat(e,")")),t.initWithAudioMuted=e;return t.forEachCall((r=>(0,a.ms)(r.localUsermediaFeed.stream.getAudioTracks(),!e&&t.callExpected(r)))),t.emit(j.LocalMuteStateChanged,e,t.isLocalVideoMuted()),r||(yield i()),!0}))()}checkAudioPermissionIfNecessary(e){var t=this;return(0,n.A)((function*(){try{if(!e&&t.localCallFeed&&!t.localCallFeed.hasAudioTrack){var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!t.localCallFeed.isVideoMuted());if(0===(null===r||void 0===r?void 0:r.getTracks().length))return l.v.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device to receive local stream, muted=").concat(e)),!1}}catch(n){return l.v.log("GroupCall ".concat(t.groupCallId," setMicrophoneMuted() no device or permission to receive local stream, muted=").concat(e)),!1}return!0}))()}setLocalVideoMuted(e){var t=this;return(0,n.A)((function*(){if(!e&&!(yield t.client.getMediaHandler().hasVideoDevice()))return!1;if(t.localCallFeed){l.v.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() (stream=").concat(t.localCallFeed.stream.id,", muted=").concat(e,")"));try{var r=yield t.client.getMediaHandler().getUserMediaStream(!0,!e);yield t.updateLocalUsermediaStream(r),t.localCallFeed.setAudioVideoMuted(null,e),(0,a.ms)(t.localCallFeed.stream.getVideoTracks(),!e)}catch(i){return l.v.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no device or permission to receive local stream, muted=").concat(e)),!1}}else l.v.log("GroupCall ".concat(t.groupCallId," setLocalVideoMuted() no stream muted (muted=").concat(e,")")),t.initWithVideoMuted=e;var n=[];return t.forEachCall((t=>n.push(t.setLocalVideoMuted(e)))),yield Promise.all(n),t.forEachCall((r=>(0,a.ms)(r.localUsermediaFeed.stream.getVideoTracks(),!e&&t.callExpected(r)))),t.emit(j.LocalMuteStateChanged,t.isMicrophoneMuted(),e),!0}))()}setScreensharingEnabled(e){var t=arguments,r=this;return(0,n.A)((function*(){var n=t.length>1&&void 0!==t[1]?t[1]:{};if(e===r.isScreensharing())return e;if(!e)return r.forEachCall((e=>{e.localScreensharingFeed&&e.removeLocalFeed(e.localScreensharingFeed)})),r.client.getMediaHandler().stopScreensharingStream(r.localScreenshareFeed.stream),r.removeScreenshareFeed(r.localScreenshareFeed),r.localScreenshareFeed=void 0,r.localDesktopCapturerSourceId=void 0,r.emit(j.LocalScreenshareStateChanged,!1,void 0,void 0),!1;try{l.v.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() is asking for screensharing permissions"));var i=yield r.client.getMediaHandler().getScreensharingStream(n),o=function*(e){var t=()=>{r.setScreensharingEnabled(!1),e.removeEventListener("ended",t)};e.addEventListener("ended",t)};for(var a of i.getTracks())yield*o(a);return l.v.log("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() granted screensharing permissions. Setting screensharing enabled on all calls")),r.localDesktopCapturerSourceId=n.desktopCapturerSourceId,r.localScreenshareFeed=new s.Hh({client:r.client,roomId:r.room.roomId,userId:r.client.getUserId(),deviceId:r.client.getDeviceId(),stream:i,purpose:u.h.Screenshare,audioMuted:!1,videoMuted:!1}),r.addScreenshareFeed(r.localScreenshareFeed),r.emit(j.LocalScreenshareStateChanged,!0,r.localScreenshareFeed,r.localDesktopCapturerSourceId),r.forEachCall((e=>e.pushLocalFeed(r.localScreenshareFeed.clone()))),!0}catch(c){if(n.throwOnFail)throw c;return l.v.error("GroupCall ".concat(r.groupCallId," setScreensharingEnabled() enabling screensharing error"),c),r.emit(j.Error,new G(V.NoUserMedia,"Failed to get screen-sharing stream: ",c)),!1}}))()}isScreensharing(){return!!this.localScreenshareFeed}wantsOutgoingCall(e,t){var r=this.client.getUserId(),n=this.client.getDeviceId();return e>=r&&(e!==r||t>n)}placeOutgoingCalls(){var e=this,t=!1,r=function(r){var n,o=null!==(n=e.calls.get(r))&&void 0!==n?n:new Map,s=function(n){var i=o.get(n);if((null===i||void 0===i?void 0:i.getOpponentSessionId())!==d.sessionId&&e.wantsOutgoingCall(r,n)){t=!0,void 0!==i&&(l.v.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() replacing call (userId=").concat(r,", deviceId=").concat(n,", callId=").concat(i.callId,")")),i.hangup(a.Il.NewSession,!1));var s=(0,a.sv)(e.client,e.room.roomId,{invitee:r,opponentDeviceId:n,opponentSessionId:d.sessionId,groupCallId:e.groupCallId});null===s?(l.v.error("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to create call (userId=").concat(r,", device=").concat(n,")")),o.delete(n)):(e.initCall(s),o.set(n,s),l.v.debug("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() placing call (userId=").concat(r,", deviceId=").concat(n,", sessionId=").concat(d.sessionId,")")),s.placeCallWithCallFeeds(e.getLocalFeeds().map((e=>e.clone())),d.screensharing).then((()=>{e.dataChannelsEnabled&&s.createDataChannel("datachannel",e.dataChannelOptions)})).catch((t=>{l.v.warn("GroupCall ".concat(e.groupCallId," placeOutgoingCalls() failed to place call (userId=").concat(r,")"),t),t instanceof a.RA&&t.code===V.UnknownDevice?e.emit(j.Error,t):e.emit(j.Error,new G(V.PlaceCallFailed,"Failed to place call to ".concat(r))),s.hangup(a.Il.SignallingFailed,!1),o.get(n)===s&&o.delete(n)})))}};for(var[c,d]of i)s(c);o.size>0?e.calls.set(r,o):e.calls.delete(r)};for(var[{userId:n},i]of this.participants)r(n);t&&this.emit(j.CallsChanged,this.calls)}getMemberStateEvents(e){return void 0===e?this.room.currentState.getStateEvents(h.Bx.GroupCallMemberPrefix):this.room.currentState.getStateEvents(h.Bx.GroupCallMemberPrefix,e)}initCall(e){var t=J(e);if(!t)throw new Error("Cannot init call without user id");var r=()=>this.onCallFeedsChanged(e),n=(t,r)=>this.onCallStateChanged(e,t,r),i=this.onCallHangup,o=t=>this.onCallReplaced(e,t),s=this.callHandlers.get(t);void 0===s&&(s=new Map,this.callHandlers.set(t,s)),s.set(e.getOpponentDeviceId(),{onCallFeedsChanged:r,onCallStateChanged:n,onCallHangup:i,onCallReplaced:o}),e.on(a.$E.FeedsChanged,r),e.on(a.$E.State,n),e.on(a.$E.Hangup,i),e.on(a.$E.Replaced,o),e.isPtt=this.isPtt,this.reEmitter.reEmit(e,Object.values(a.$E)),e.initStats(this.getGroupCallStats()),r()}disposeCall(e,t){var r=J(e),n=e.getOpponentDeviceId();if(!r)throw new Error("Cannot dispose call without user id");var i=this.callHandlers.get(r),{onCallFeedsChanged:o,onCallStateChanged:s,onCallHangup:c,onCallReplaced:l}=i.get(n);if(e.removeListener(a.$E.FeedsChanged,o),e.removeListener(a.$E.State,s),e.removeListener(a.$E.Hangup,c),e.removeListener(a.$E.Replaced,l),i.delete(r),0===i.size&&this.callHandlers.delete(r),e.hangupReason!==a.Il.Replaced){var d=this.getUserMediaFeed(r,n);d&&this.removeUserMediaFeed(d);var u=this.getScreenshareFeed(r,n);u&&this.removeScreenshareFeed(u)}}getUserMediaFeed(e,t){return this.userMediaFeeds.find((r=>r.userId===e&&r.deviceId===t))}addUserMediaFeed(e){this.userMediaFeeds.push(e),e.measureVolumeActivity(!0),this.emit(j.UserMediaFeedsChanged,this.userMediaFeeds)}replaceUserMediaFeed(e,t){var r=this.userMediaFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===r)throw new Error("Couldn't find user media feed to replace");this.userMediaFeeds.splice(r,1,t),e.dispose(),t.measureVolumeActivity(!0),this.emit(j.UserMediaFeedsChanged,this.userMediaFeeds)}removeUserMediaFeed(e){var t=this.userMediaFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===t)throw new Error("Couldn't find user media feed to remove");this.userMediaFeeds.splice(t,1),e.dispose(),this.emit(j.UserMediaFeedsChanged,this.userMediaFeeds),this.activeSpeaker===e&&(this.activeSpeaker=this.userMediaFeeds[0],this.emit(j.ActiveSpeakerChanged,this.activeSpeaker))}getScreenshareFeed(e,t){return this.screenshareFeeds.find((r=>r.userId===e&&r.deviceId===t))}addScreenshareFeed(e){this.screenshareFeeds.push(e),this.emit(j.ScreenshareFeedsChanged,this.screenshareFeeds)}replaceScreenshareFeed(e,t){var r=this.screenshareFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===r)throw new Error("Couldn't find screenshare feed to replace");this.screenshareFeeds.splice(r,1,t),e.dispose(),this.emit(j.ScreenshareFeedsChanged,this.screenshareFeeds)}removeScreenshareFeed(e){var t=this.screenshareFeeds.findIndex((t=>t.userId===e.userId&&t.deviceId===e.deviceId));if(-1===t)throw new Error("Couldn't find screenshare feed to remove");this.screenshareFeeds.splice(t,1),e.dispose(),this.emit(j.ScreenshareFeedsChanged,this.screenshareFeeds)}updateParticipants(){var e=this.room.getMember(this.client.getSafeUserId());if(e)if(null!==this.participantsExpirationTimer&&(clearTimeout(this.participantsExpirationTimer),this.participantsExpirationTimer=null),this.state!==H.Ended){var t=new Map,r=Date.now(),n=this.state===H.Entered||this.enteredViaAnotherSession,i=1/0;for(var o of this.getMemberStateEvents()){var s=this.room.getMember(o.getStateKey()),a=o.getContent(),c=Array.isArray(a["m.calls"])?a["m.calls"]:[],d=c.find((e=>e["m.call_id"]===this.groupCallId)),h=Array.isArray(null===d||void 0===d?void 0:d["m.devices"])?d["m.devices"]:[],v=h.filter((e=>"string"===typeof e.device_id&&"string"===typeof e.session_id&&"number"===typeof e.expires_ts&&e.expires_ts>r&&Array.isArray(e.feeds)));if(n||(null===s||void 0===s?void 0:s.userId)!==this.client.getUserId()||(v=v.filter((e=>e.device_id!==this.client.getDeviceId()))),v.length>0&&(null===s||void 0===s?void 0:s.membership)===U.O.Join){var p=new Map;for(var f of(t.set(s,p),v))p.set(f.device_id,{sessionId:f.session_id,screensharing:f.feeds.some((e=>e.purpose===u.h.Screenshare))}),f.expires_ts<i&&(i=f.expires_ts)}}if(n){var g=t.get(e);void 0===g&&(g=new Map,t.set(e,g)),g.has(this.client.getDeviceId())||g.set(this.client.getDeviceId(),{sessionId:this.client.getSessionId(),screensharing:this.getLocalFeeds().some((e=>e.purpose===u.h.Screenshare))})}this.participants=t,i<1/0&&(this.participantsExpirationTimer=setTimeout((()=>this.updateParticipants()),i-r))}else this.participants=new Map;else l.v.warn("GroupCall ".concat(this.groupCallId," updateParticipants() tried to update participants before local room member is available"))}updateDevices(e){var t=arguments,r=this;return(0,n.A)((function*(){var n,i=t.length>1&&void 0!==t[1]&&t[1],o=Date.now(),s=r.client.getUserId(),a=r.getMemberStateEvents(s),c=null!==(n=null===a||void 0===a?void 0:a.getContent())&&void 0!==n?n:{},l=Array.isArray(c["m.calls"])?c["m.calls"]:[],d=null,u=[];for(var v of l)v["m.call_id"]===r.groupCallId?d=v:u.push(v);null===d&&(d={});var p=Array.isArray(d["m.devices"])?d["m.devices"]:[],f=p.filter((e=>"string"===typeof e.device_id&&"string"===typeof e.session_id&&"number"===typeof e.expires_ts&&e.expires_ts>o&&Array.isArray(e.feeds))),g=e(f);if(null!==g){var m=[...u];g.length>0&&m.push(N(N({},d),{},{"m.call_id":r.groupCallId,"m.devices":g}));var y={"m.calls":m};yield r.client.sendStateEvent(r.room.roomId,h.Bx.GroupCallMemberPrefix,y,s,{keepAlive:i})}}))()}addDeviceToMemberState(){var e=this;return(0,n.A)((function*(){yield e.updateDevices((t=>[...t.filter((t=>t.device_id!==e.client.getDeviceId())),{device_id:e.client.getDeviceId(),session_id:e.client.getSessionId(),expires_ts:Date.now()+$,feeds:e.getLocalFeeds().map((e=>({purpose:e.purpose})))}]))}))()}updateMemberState(){var e=this;return(0,n.A)((function*(){null!==e.resendMemberStateTimer&&(clearInterval(e.resendMemberStateTimer),e.resendMemberStateTimer=null),e.state===H.Entered?(yield e.addDeviceToMemberState(),e.resendMemberStateTimer=setInterval((0,n.A)((function*(){l.v.log("GroupCall ".concat(e.groupCallId,' updateMemberState() resending call member state"'));try{yield e.addDeviceToMemberState()}catch(t){l.v.error("GroupCall ".concat(e.groupCallId," updateMemberState() failed to resend call member state"),t)}})),3*$/4)):yield e.updateDevices((t=>t.filter((t=>t.device_id!==e.client.getDeviceId()))),!0)}))()}cleanMemberState(){var e=this;return(0,n.A)((function*(){var{devices:t}=yield e.client.getDevices(),r=new Map(t.map((e=>[e.device_id,e])));yield e.updateDevices((t=>{var n=t.filter((t=>{var n=r.get(t.device_id);return void 0!==(null===n||void 0===n?void 0:n.last_seen_ts)&&!(t.device_id===e.client.getDeviceId()&&e.state!==H.Entered&&!e.enteredViaAnotherSession)}));return n.length===t.length?null:n}))}))()}getGroupCallStats(){if(void 0===this.stats){var e=this.client.getUserId()||"unknown";this.stats=new x(this.groupCallId,e,this.statsCollectIntervalTime),this.stats.reports.on(D.I.CONNECTION_STATS,this.onConnectionStats),this.stats.reports.on(D.I.BYTE_SENT_STATS,this.onByteSentStats),this.stats.reports.on(D.I.SUMMARY_STATS,this.onSummaryStats),this.stats.reports.on(D.I.CALL_FEED_REPORT,this.onCallFeedReport)}return this.stats}setGroupCallStatsInterval(e){this.statsCollectIntervalTime=e,void 0!==this.stats&&(this.stats.stop(),this.stats.setInterval(e),e>0&&this.stats.start())}}},4861:function(e,t,r){"use strict";r.d(t,{Wi:function(){return h},sP:function(){return u},sn:function(){return l}});r(8111),r(2489),r(116),r(7588),r(1701),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(698),i=r(4761),o=r(7046),s=r(7419),a=r(9927),c=r(2668),l=function(e){return e["New"]="Poll.new",e["End"]="Poll.end",e["Update"]="Poll.update",e["Responses"]="Poll.Responses",e["Destroy"]="Poll.Destroy",e["UndecryptableRelations"]="Poll.UndecryptableRelations",e}({}),d=(e,t)=>{var r=e.filter((e=>{if(!e.isDecryptionFailure())return s.qN.matches(e.getType())&&e.getTs()<=t}));return{responseEvents:r}};class u extends c.X{constructor(e,t,r){if(super(),this.rootEvent=e,this.matrixClient=t,this.room=r,(0,i.A)(this,"roomId",void 0),(0,i.A)(this,"pollEvent",void 0),(0,i.A)(this,"_isFetchingResponses",!1),(0,i.A)(this,"relationsNextBatch",void 0),(0,i.A)(this,"responses",null),(0,i.A)(this,"endEvent",void 0),(0,i.A)(this,"undecryptableRelationEventIds",new Set),(0,i.A)(this,"countUndecryptableEvents",(e=>{var t=e.filter((e=>e.isDecryptionFailure())).map((e=>e.getId())),r=this.undecryptableRelationsCount;this.undecryptableRelationEventIds=new Set([...this.undecryptableRelationEventIds,...t]),this.undecryptableRelationsCount!==r&&this.emit(l.UndecryptableRelations,this.undecryptableRelationsCount)})),!this.rootEvent.getRoomId()||!this.rootEvent.getId())throw new Error("Invalid poll start event.");this.roomId=this.rootEvent.getRoomId(),this.pollEvent=this.rootEvent.unstableExtensibleEvent}get pollId(){return this.rootEvent.getId()}get endEventId(){var e;return null===(e=this.endEvent)||void 0===e?void 0:e.getId()}get isEnded(){return!!this.endEvent}get isFetchingResponses(){return this._isFetchingResponses}get undecryptableRelationsCount(){return this.undecryptableRelationEventIds.size}getResponses(){var e=this;return(0,n.A)((function*(){return e.responses||e.isFetchingResponses||(yield e.fetchResponses()),e.responses}))()}onNewRelation(e){var t;if(s.cI.matches(e.getType())&&this.validateEndEvent(e)&&(this.endEvent=e,this.refilterResponsesOnEnd(),this.emit(l.End)),this.responses){var r=(null===(t=this.endEvent)||void 0===t?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:n}=d([e],r);this.countUndecryptableEvents([e]),n.length&&(n.forEach((e=>{this.responses.addEvent(e)})),this.emit(l.Responses,this.responses))}}fetchResponses(){var e=this;return(0,n.A)((function*(){var t,r;e._isFetchingResponses=!0;var n=yield e.matrixClient.relations(e.roomId,e.rootEvent.getId(),"m.reference",void 0,{from:e.relationsNextBatch||void 0});yield Promise.all(n.events.map((t=>e.matrixClient.decryptEventIfNeeded(t))));var i=e.responses||new a.s("m.reference",s.qN.name,e.matrixClient,[s.qN.altName]),o=n.events.find((e=>s.cI.matches(e.getType())));e.validateEndEvent(o)&&(e.endEvent=o,e.refilterResponsesOnEnd(),e.emit(l.End));var c=(null===(t=e.endEvent)||void 0===t?void 0:t.getTs())||Number.MAX_SAFE_INTEGER,{responseEvents:u}=d(n.events,c);u.forEach((e=>{i.addEvent(e)})),e.relationsNextBatch=null!==(r=n.nextBatch)&&void 0!==r?r:void 0,e.responses=i,e.countUndecryptableEvents(n.events),e.relationsNextBatch?e.fetchResponses():e._isFetchingResponses=!1,e.emit(l.Responses,e.responses)}))()}refilterResponsesOnEnd(){var e;if(this.responses){var t=(null===(e=this.endEvent)||void 0===e?void 0:e.getTs())||Number.MAX_SAFE_INTEGER;this.responses.getRelations().forEach((e=>{var r;e.getTs()>t&&(null===(r=this.responses)||void 0===r||r.removeEvent(e))})),this.emit(l.Responses,this.responses)}}validateEndEvent(e){if(!e)return!1;if(this.endEvent&&this.endEvent.getTs()<e.getTs())return!1;var t=this.room.currentState,r=e.getSender();return!!r&&(r===this.rootEvent.getSender()||t.maySendRedactionForEvent(this.rootEvent,r))}}var h=e=>{var t=e.getType();return o.M_POLL_START.matches(t)||s.qN.matches(t)||s.cI.matches(t)}},4864:function(e,t,r){"use strict";r.r(t),r.d(t,{AllDevicesIsolationMode:function(){return b},CrossSigningKey:function(){return I},CryptoEvent:function(){return m},DecryptionFailureCode:function(){return y},DeviceIsolationModeKind:function(){return S},DeviceVerificationStatus:function(){return w},EventShieldColour:function(){return T},EventShieldReason:function(){return R},OnlySignedDevicesIsolationMode:function(){return E},UserVerificationStatus:function(){return _},VerificationPhase:function(){return i.X9},VerificationRequestEvent:function(){return i.FM},VerifierEvent:function(){return i.Ji},canAcceptVerificationRequest:function(){return i.Dy},decodeRecoveryKey:function(){return h},deriveRecoveryKeyFromPassphrase:function(){return f},encodeRecoveryKey:function(){return u}});var n=r(4761),i=r(7841);r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);function o(e){if(e.length>=255)throw new TypeError("Alphabet too long");const t=new Uint8Array(256);for(let l=0;l<t.length;l++)t[l]=255;for(let l=0;l<e.length;l++){const r=e.charAt(l),n=r.charCodeAt(0);if(255!==t[n])throw new TypeError(r+" is ambiguous");t[n]=l}const r=e.length,n=e.charAt(0),i=Math.log(r)/Math.log(256),o=Math.log(256)/Math.log(r);function s(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";let i=0,s=0,a=0;const c=t.length;while(a!==c&&0===t[a])a++,i++;const l=(c-a)*o+1>>>0,d=new Uint8Array(l);while(a!==c){let e=t[a],n=0;for(let t=l-1;(0!==e||n<s)&&-1!==t;t--,n++)e+=256*d[t]>>>0,d[t]=e%r>>>0,e=e/r>>>0;if(0!==e)throw new Error("Non-zero carry");s=n,a++}let u=l-s;while(u!==l&&0===d[u])u++;let h=n.repeat(i);for(;u<l;++u)h+=e.charAt(d[u]);return h}function a(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;let o=0,s=0,a=0;while(e[o]===n)s++,o++;const c=(e.length-o)*i+1>>>0,l=new Uint8Array(c);while(e[o]){let n=t[e.charCodeAt(o)];if(255===n)return;let i=0;for(let e=c-1;(0!==n||i<a)&&-1!==e;e--,i++)n+=r*l[e]>>>0,l[e]=n%256>>>0,n=n/256>>>0;if(0!==n)throw new Error("Non-zero carry");a=i,o++}let d=c-a;while(d!==c&&0===l[d])d++;const u=new Uint8Array(s+(c-d));let h=s;while(d!==c)u[h++]=l[d++];return u}function c(e){const t=a(e);if(t)return t;throw new Error("Non-base"+r+" character")}return{encode:s,decodeUnsafe:a,decode:c}}var s=o,a="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",c=s(a),l=[139,1],d=32;function u(e){var t,r=new Uint8Array(l.length+e.length+1);r.set(l,0),r.set(e,l.length);for(var n=0,i=0;i<r.length-1;++i)n^=r[i];r[r.length-1]=n;var o=c.encode(r);return null===(t=o.match(/.{1,4}/g))||void 0===t?void 0:t.join(" ")}function h(e){var t=c.decode(e.replace(/ /g,"")),r=0;for(var n of t)r^=n;if(0!==r)throw new Error("Incorrect parity");for(var i=0;i<l.length;++i)if(t[i]!==l[i])throw new Error("Incorrect prefix");if(t.length!==l.length+d+1)throw new Error("Incorrect length");return Uint8Array.from(t.slice(l.length,l.length+d))}var v=r(698),p=256;function f(e,t,r){return g.apply(this,arguments)}function g(){return g=(0,v.A)((function*(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:p;if(!globalThis.crypto.subtle||!TextEncoder)throw new Error("Password-based backup is not available on this platform");var i=yield globalThis.crypto.subtle.importKey("raw",(new TextEncoder).encode(e),{name:"PBKDF2"},!1,["deriveBits"]),o=yield globalThis.crypto.subtle.deriveBits({name:"PBKDF2",salt:(new TextEncoder).encode(t),iterations:r,hash:"SHA-512"},i,n);return new Uint8Array(o)})),g.apply(this,arguments)}var m=function(e){return e["UserTrustStatusChanged"]="userTrustStatusChanged",e["KeyBackupStatus"]="crypto.keyBackupStatus",e["KeyBackupFailed"]="crypto.keyBackupFailed",e["KeyBackupSessionsRemaining"]="crypto.keyBackupSessionsRemaining",e["KeyBackupDecryptionKeyCached"]="crypto.keyBackupDecryptionKeyCached",e["VerificationRequestReceived"]="crypto.verificationRequestReceived",e["WillUpdateDevices"]="crypto.willUpdateDevices",e["DevicesUpdated"]="crypto.devicesUpdated",e["KeysChanged"]="crossSigning.keysChanged",e["LegacyCryptoStoreMigrationProgress"]="crypto.legacyCryptoStoreMigrationProgress",e["DehydratedDeviceCreated"]="dehydration.DehydratedDeviceCreated",e["DehydratedDeviceUploaded"]="dehydration.DehydratedDeviceUploaded",e["RehydrationStarted"]="dehydration.RehydrationStarted",e["RehydrationProgress"]="dehydration.RehydrationProgress",e["RehydrationCompleted"]="dehydration.RehydrationCompleted",e["RehydrationError"]="dehydration.RehydrationError",e["DehydrationKeyCached"]="dehydration.DehydrationKeyCached",e["DehydratedDeviceRotationError"]="dehydration.DehydratedDeviceRotationError",e}({}),y=function(e){return e["MEGOLM_UNKNOWN_INBOUND_SESSION_ID"]="MEGOLM_UNKNOWN_INBOUND_SESSION_ID",e["MEGOLM_KEY_WITHHELD"]="MEGOLM_KEY_WITHHELD",e["MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE"]="MEGOLM_KEY_WITHHELD_FOR_UNVERIFIED_DEVICE",e["OLM_UNKNOWN_MESSAGE_INDEX"]="OLM_UNKNOWN_MESSAGE_INDEX",e["HISTORICAL_MESSAGE_NO_KEY_BACKUP"]="HISTORICAL_MESSAGE_NO_KEY_BACKUP",e["HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED"]="HISTORICAL_MESSAGE_BACKUP_UNCONFIGURED",e["HISTORICAL_MESSAGE_WORKING_BACKUP"]="HISTORICAL_MESSAGE_WORKING_BACKUP",e["HISTORICAL_MESSAGE_USER_NOT_JOINED"]="HISTORICAL_MESSAGE_USER_NOT_JOINED",e["SENDER_IDENTITY_PREVIOUSLY_VERIFIED"]="SENDER_IDENTITY_PREVIOUSLY_VERIFIED",e["UNSIGNED_SENDER_DEVICE"]="UNSIGNED_SENDER_DEVICE",e["UNKNOWN_SENDER_DEVICE"]="UNKNOWN_SENDER_DEVICE",e["UNKNOWN_ERROR"]="UNKNOWN_ERROR",e["MEGOLM_BAD_ROOM"]="MEGOLM_BAD_ROOM",e["MEGOLM_MISSING_FIELDS"]="MEGOLM_MISSING_FIELDS",e["OLM_DECRYPT_GROUP_MESSAGE_ERROR"]="OLM_DECRYPT_GROUP_MESSAGE_ERROR",e["OLM_BAD_ENCRYPTED_MESSAGE"]="OLM_BAD_ENCRYPTED_MESSAGE",e["OLM_BAD_RECIPIENT"]="OLM_BAD_RECIPIENT",e["OLM_BAD_RECIPIENT_KEY"]="OLM_BAD_RECIPIENT_KEY",e["OLM_BAD_ROOM"]="OLM_BAD_ROOM",e["OLM_BAD_SENDER_CHECK_FAILED"]="OLM_BAD_SENDER_CHECK_FAILED",e["OLM_BAD_SENDER"]="OLM_BAD_SENDER",e["OLM_FORWARDED_MESSAGE"]="OLM_FORWARDED_MESSAGE",e["OLM_MISSING_CIPHERTEXT"]="OLM_MISSING_CIPHERTEXT",e["OLM_NOT_INCLUDED_IN_RECIPIENTS"]="OLM_NOT_INCLUDED_IN_RECIPIENTS",e["UNKNOWN_ENCRYPTION_ALGORITHM"]="UNKNOWN_ENCRYPTION_ALGORITHM",e}({}),S=function(e){return e[e["AllDevicesIsolationMode"]=0]="AllDevicesIsolationMode",e[e["OnlySignedDevicesIsolationMode"]=1]="OnlySignedDevicesIsolationMode",e}({});class b{constructor(e){this.errorOnVerifiedUserProblems=e,(0,n.A)(this,"kind",S.AllDevicesIsolationMode)}}class E{constructor(){(0,n.A)(this,"kind",S.OnlySignedDevicesIsolationMode)}}class _{constructor(e,t,r){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.crossSigningVerified=e,this.crossSigningVerifiedBefore=t,this.tofu=r,(0,n.A)(this,"needsUserApproval",void 0),this.needsUserApproval=i}isVerified(){return this.isCrossSigningVerified()}isCrossSigningVerified(){return this.crossSigningVerified}wasCrossSigningVerified(){return this.crossSigningVerifiedBefore}isTofu(){return this.tofu}}class w{constructor(e){var t,r,i,o,s;(0,n.A)(this,"signedByOwner",void 0),(0,n.A)(this,"crossSigningVerified",void 0),(0,n.A)(this,"tofu",void 0),(0,n.A)(this,"localVerified",void 0),(0,n.A)(this,"trustCrossSignedDevices",void 0),this.signedByOwner=null!==(t=e.signedByOwner)&&void 0!==t&&t,this.crossSigningVerified=null!==(r=e.crossSigningVerified)&&void 0!==r&&r,this.tofu=null!==(i=e.tofu)&&void 0!==i&&i,this.localVerified=null!==(o=e.localVerified)&&void 0!==o&&o,this.trustCrossSignedDevices=null!==(s=e.trustCrossSignedDevices)&&void 0!==s&&s}isVerified(){return this.localVerified||this.trustCrossSignedDevices&&this.crossSigningVerified}}var I=function(e){return e["Master"]="master",e["SelfSigning"]="self_signing",e["UserSigning"]="user_signing",e}({}),T=function(e){return e[e["NONE"]=0]="NONE",e[e["GREY"]=1]="GREY",e[e["RED"]=2]="RED",e}({}),R=function(e){return e[e["UNKNOWN"]=0]="UNKNOWN",e[e["UNVERIFIED_IDENTITY"]=1]="UNVERIFIED_IDENTITY",e[e["UNSIGNED_DEVICE"]=2]="UNSIGNED_DEVICE",e[e["UNKNOWN_DEVICE"]=3]="UNKNOWN_DEVICE",e[e["AUTHENTICITY_NOT_GUARANTEED"]=4]="AUTHENTICITY_NOT_GUARANTEED",e[e["MISMATCHED_SENDER_KEY"]=5]="MISMATCHED_SENDER_KEY",e[e["SENT_IN_CLEAR"]=6]="SENT_IN_CLEAR",e[e["VERIFICATION_VIOLATION"]=7]="VERIFICATION_VIOLATION",e}({})},4901:function(e){"use strict";var t="object"==typeof document&&document.all;e.exports="undefined"==typeof t&&void 0!==t?function(e){return"function"==typeof e||e===t}:function(e){return"function"==typeof e}},4904:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}r(8111),r(3579),Object.defineProperty(t,"__esModule",{value:!0}),t.PollResponseEvent=void 0;var i=r(6977),o=r(5063),s=r(3339),a=r(6012),c=r(1880);function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function u(e,t,r){return t&&d(e.prototype,t),r&&d(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function h(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&v(e,t)}function v(e,t){return v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},v(e,t)}function p(e){var t=m();return function(){var r,n=y(e);if(t){var i=y(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return f(this,r)}}function f(e,t){if(t&&("object"===n(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return g(e)}function g(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function m(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function y(e){return y=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},y(e)}function S(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var b=function(e){h(r,e);var t=p(r);function r(e){var n;l(this,r),n=t.call(this,e),S(g(n),"internalAnswerIds",void 0),S(g(n),"internalSpoiled",void 0),S(g(n),"pollEventId",void 0);var i=n.wireContent["m.relates_to"];if(!a.REFERENCE_RELATION.matches(null===i||void 0===i?void 0:i.rel_type)||"string"!==typeof(null===i||void 0===i?void 0:i.event_id))throw new s.InvalidEventError("Relationship must be a reference to an event");return n.pollEventId=i.event_id,n.validateAgainst(null),n}return u(r,[{key:"answerIds",get:function(){return this.internalAnswerIds}},{key:"spoiled",get:function(){return this.internalSpoiled}},{key:"validateAgainst",value:function(e){var t=o.M_POLL_RESPONSE.findIn(this.wireContent);if(!Array.isArray(null===t||void 0===t?void 0:t.answers))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);var r=t.answers;if(r.some((function(e){return"string"!==typeof e}))||0===r.length)return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);if(e){if(r.some((function(t){return!e.answers.some((function(e){return e.id===t}))})))return this.internalSpoiled=!0,void(this.internalAnswerIds=[]);r=r.slice(0,e.maxSelections)}this.internalAnswerIds=r,this.internalSpoiled=!1}},{key:"isEquivalentTo",value:function(e){return(0,c.isEventTypeSame)(e,o.M_POLL_RESPONSE)}},{key:"serialize",value:function(){return{type:o.M_POLL_RESPONSE.name,content:S({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:this.pollEventId}},o.M_POLL_RESPONSE.name,{answers:this.spoiled?void 0:this.answerIds})}}}],[{key:"from",value:function(e,t){return new r({type:o.M_POLL_RESPONSE.name,content:S({"m.relates_to":{rel_type:a.REFERENCE_RELATION.name,event_id:t}},o.M_POLL_RESPONSE.name,{answers:e})})}}]),r}(i.ExtensibleEvent);t.PollResponseEvent=b},4913:function(e,t,r){"use strict";var n=r(3724),i=r(5917),o=r(8686),s=r(8551),a=r(6969),c=TypeError,l=Object.defineProperty,d=Object.getOwnPropertyDescriptor,u="enumerable",h="configurable",v="writable";t.f=n?o?function(e,t,r){if(s(e),t=a(t),s(r),"function"===typeof e&&"prototype"===t&&"value"in r&&v in r&&!r[v]){var n=d(e,t);n&&n[v]&&(e[t]=r.value,r={configurable:h in r?r[h]:n[h],enumerable:u in r?r[u]:n[u],writable:!1})}return l(e,t,r)}:l:function(e,t,r){if(s(e),t=a(t),s(r),i)try{return l(e,t,r)}catch(n){}if("get"in r||"set"in r)throw new c("Accessors not supported");return"value"in r&&(e[t]=r.value),e}},4916:function(e,t,r){"use strict";var n=r(7751),i=function(e){return{size:e,has:function(){return!1},keys:function(){return{next:function(){return{done:!0}}}}}},o=function(e){return{size:e,has:function(){return!0},keys:function(){throw new Error("e")}}};e.exports=function(e,t){var r=n("Set");try{(new r)[e](i(0));try{return(new r)[e](i(-1)),!1}catch(a){if(!t)return!0;try{return(new r)[e](o(-1/0)),!1}catch(c){var s=new r;return s.add(1),s.add(2),t(s[e](o(1/0)))}}}catch(c){return!1}}},4977:function(e,t,r){"use strict";r.d(t,{f:function(){return n}});var n=function(e){return e["NOT_SENT"]="not_sent",e["ENCRYPTING"]="encrypting",e["SENDING"]="sending",e["QUEUED"]="queued",e["SENT"]="sent",e["CANCELLED"]="cancelled",e}({})},4979:function(e,t,r){"use strict";var n=r(6518),i=r(4576),o=r(7751),s=r(6980),a=r(4913).f,c=r(9297),l=r(679),d=r(3167),u=r(2603),h=r(5002),v=r(8574),p=r(3724),f=r(6395),g="DOMException",m=o("Error"),y=o(g),S=function(){l(this,b);var e=arguments.length,t=u(e<1?void 0:arguments[0]),r=u(e<2?void 0:arguments[1],"Error"),n=new y(t,r),i=new m(t);return i.name=g,a(n,"stack",s(1,v(i.stack,1))),d(n,this,S),n},b=S.prototype=y.prototype,E="stack"in new m(g),_="stack"in new y(1,2),w=y&&p&&Object.getOwnPropertyDescriptor(i,g),I=!!w&&!(w.writable&&w.configurable),T=E&&!I&&!_;n({global:!0,constructor:!0,forced:f||T},{DOMException:T?S:y});var R=o(g),k=R.prototype;if(k.constructor!==R)for(var A in f||a(k,"constructor",s(1,R)),h)if(c(h,A)){var C=h[A],O=C.s;c(R,O)||a(R,O,s(6,C.c))}},5002:function(e){"use strict";e.exports={IndexSizeError:{s:"INDEX_SIZE_ERR",c:1,m:1},DOMStringSizeError:{s:"DOMSTRING_SIZE_ERR",c:2,m:0},HierarchyRequestError:{s:"HIERARCHY_REQUEST_ERR",c:3,m:1},WrongDocumentError:{s:"WRONG_DOCUMENT_ERR",c:4,m:1},InvalidCharacterError:{s:"INVALID_CHARACTER_ERR",c:5,m:1},NoDataAllowedError:{s:"NO_DATA_ALLOWED_ERR",c:6,m:0},NoModificationAllowedError:{s:"NO_MODIFICATION_ALLOWED_ERR",c:7,m:1},NotFoundError:{s:"NOT_FOUND_ERR",c:8,m:1},NotSupportedError:{s:"NOT_SUPPORTED_ERR",c:9,m:1},InUseAttributeError:{s:"INUSE_ATTRIBUTE_ERR",c:10,m:1},InvalidStateError:{s:"INVALID_STATE_ERR",c:11,m:1},SyntaxError:{s:"SYNTAX_ERR",c:12,m:1},InvalidModificationError:{s:"INVALID_MODIFICATION_ERR",c:13,m:1},NamespaceError:{s:"NAMESPACE_ERR",c:14,m:1},InvalidAccessError:{s:"INVALID_ACCESS_ERR",c:15,m:1},ValidationError:{s:"VALIDATION_ERR",c:16,m:0},TypeMismatchError:{s:"TYPE_MISMATCH_ERR",c:17,m:1},SecurityError:{s:"SECURITY_ERR",c:18,m:1},NetworkError:{s:"NETWORK_ERR",c:19,m:1},AbortError:{s:"ABORT_ERR",c:20,m:1},URLMismatchError:{s:"URL_MISMATCH_ERR",c:21,m:1},QuotaExceededError:{s:"QUOTA_EXCEEDED_ERR",c:22,m:1},TimeoutError:{s:"TIMEOUT_ERR",c:23,m:1},InvalidNodeTypeError:{s:"INVALID_NODE_TYPE_ERR",c:24,m:1},DataCloneError:{s:"DATA_CLONE_ERR",c:25,m:1}}},5024:function(e,t,r){"use strict";var n=r(6518),i=r(3650),o=r(4916);n({target:"Set",proto:!0,real:!0,forced:!o("symmetricDifference")},{symmetricDifference:i})},5030:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BuiltInModalButtonID=void 0;var r=function(e){return e["Close"]="m.close",e}({});t.BuiltInModalButtonID=r},5031:function(e,t,r){"use strict";var n=r(7751),i=r(9504),o=r(8480),s=r(3717),a=r(8551),c=i([].concat);e.exports=n("Reflect","ownKeys")||function(e){var t=o.f(a(e)),r=s.f;return r?c(t,r(e)):t}},5063:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.M_POLL_START=t.M_POLL_RESPONSE=t.M_POLL_KIND_UNDISCLOSED=t.M_POLL_KIND_DISCLOSED=t.M_POLL_END=void 0;var n=r(6288),i=new n.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed");t.M_POLL_KIND_DISCLOSED=i;var o=new n.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed");t.M_POLL_KIND_UNDISCLOSED=o;var s=new n.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start");t.M_POLL_START=s;var a=new n.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response");t.M_POLL_RESPONSE=a;var c=new n.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end");t.M_POLL_END=c},5092:function(e,t,r){"use strict";r.d(t,{AO:function(){return ke},uv:function(){return Z},db:function(){return Ce},SU:function(){return Ee},Rh:function(){return se},k8:function(){return Te},P3:function(){return me},cJ:function(){return ye},R2:function(){return Se},oE:function(){return fe},aT:function(){return Ae},EZ:function(){return oe},Pl:function(){return Re},eC:function(){return de},rm:function(){return ae},K8:function(){return ce}});r(4114),r(8111),r(2489),r(7588),r(4603),r(7566),r(8721);var n=r(4761),i=r(698);r(6573),r(8100),r(7936),r(116),r(1701),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698),r(7467),r(4732),r(9577),r(4979);class o extends Error{}function s(e){return decodeURIComponent(atob(e).replace(/(.)/g,((e,t)=>{let r=t.charCodeAt(0).toString(16).toUpperCase();return r.length<2&&(r="0"+r),"%"+r})))}function a(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return s(t)}catch(r){return atob(t)}}function c(e,t){if("string"!==typeof e)throw new o("Invalid token specified: must be a string");t||(t={});const r=!0===t.header?0:1,n=e.split(".")[r];if("string"!==typeof n)throw new o(`Invalid token specified: missing part #${r+1}`);let i;try{i=a(n)}catch(s){throw new o(`Invalid token specified: invalid base64 for part #${r+1} (${s.message})`)}try{return JSON.parse(i)}catch(s){throw new o(`Invalid token specified: invalid json for part #${r+1} (${s.message})`)}}o.prototype.name="InvalidTokenError";var l,d,u={debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},h=(e=>(e[e["NONE"]=0]="NONE",e[e["ERROR"]=1]="ERROR",e[e["WARN"]=2]="WARN",e[e["INFO"]=3]="INFO",e[e["DEBUG"]=4]="DEBUG",e))(h||{});(e=>{function t(){l=3,d=u}function r(e){if(!(0<=e&&e<=4))throw new Error("Invalid log level");l=e}function n(e){d=e}e.reset=t,e.setLevel=r,e.setLogger=n})(h||(h={}));var v=class e{constructor(e){this._name=e}debug(...t){l>=4&&d.debug(e._format(this._name,this._method),...t)}info(...t){l>=3&&d.info(e._format(this._name,this._method),...t)}warn(...t){l>=2&&d.warn(e._format(this._name,this._method),...t)}error(...t){l>=1&&d.error(e._format(this._name,this._method),...t)}throw(e){throw this.error(e),e}create(e){const t=Object.create(this);return t._method=e,t.debug("begin"),t}static createStatic(t,r){const n=new e(`${t}.${r}`);return n.debug("begin"),n}static _format(e,t){const r=`[${e}]`;return t?`${r} ${t}:`:r}static debug(t,...r){l>=4&&d.debug(e._format(t),...r)}static info(t,...r){l>=3&&d.info(e._format(t),...r)}static warn(t,...r){l>=2&&d.warn(e._format(t),...r)}static error(t,...r){l>=1&&d.error(e._format(t),...r)}};h.reset();var p=class{static decode(e){try{return c(e)}catch(t){throw v.error("JwtUtils.decode",t),t}}static async generateSignedJwt(e,t,r){const n=y.encodeBase64Url((new TextEncoder).encode(JSON.stringify(e))),i=y.encodeBase64Url((new TextEncoder).encode(JSON.stringify(t))),o=`${n}.${i}`,s=await window.crypto.subtle.sign({name:"ECDSA",hash:{name:"SHA-256"}},r,(new TextEncoder).encode(o)),a=y.encodeBase64Url(new Uint8Array(s));return`${o}.${a}`}},f="10000000-1000-4000-8000-100000000000",g=e=>btoa([...new Uint8Array(e)].map((e=>String.fromCharCode(e))).join("")),m=class e{static _randomWord(){const e=new Uint32Array(1);return crypto.getRandomValues(e),e[0]}static generateUUIDv4(){const t=f.replace(/[018]/g,(t=>(+t^e._randomWord()&15>>+t/4).toString(16)));return t.replace(/-/g,"")}static generateCodeVerifier(){return e.generateUUIDv4()+e.generateUUIDv4()+e.generateUUIDv4()}static async generateCodeChallenge(e){if(!crypto.subtle)throw new Error("Crypto.subtle is available only in secure contexts (HTTPS).");try{const t=new TextEncoder,r=t.encode(e),n=await crypto.subtle.digest("SHA-256",r);return g(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}catch(t){throw v.error("CryptoUtils.generateCodeChallenge",t),t}}static generateBasicAuth(e,t){const r=new TextEncoder,n=r.encode([e,t].join(":"));return g(n)}static async hash(e,t){const r=(new TextEncoder).encode(t),n=await crypto.subtle.digest(e,r);return new Uint8Array(n)}static async customCalculateJwkThumbprint(t){let r;switch(t.kty){case"RSA":r={e:t.e,kty:t.kty,n:t.n};break;case"EC":r={crv:t.crv,kty:t.kty,x:t.x,y:t.y};break;case"OKP":r={crv:t.crv,kty:t.kty,x:t.x};break;case"oct":r={crv:t.k,kty:t.kty};break;default:throw new Error("Unknown jwk type")}const n=await e.hash("SHA-256",JSON.stringify(r));return e.encodeBase64Url(n)}static async generateDPoPProof({url:t,accessToken:r,httpMethod:n,keyPair:i,nonce:o}){let s,a;const c={jti:window.crypto.randomUUID(),htm:null!=n?n:"GET",htu:t,iat:Math.floor(Date.now()/1e3)};r&&(s=await e.hash("SHA-256",r),a=e.encodeBase64Url(s),c.ath=a),o&&(c.nonce=o);try{const e=await crypto.subtle.exportKey("jwk",i.publicKey),t={alg:"ES256",typ:"dpop+jwt",jwk:{crv:e.crv,kty:e.kty,x:e.x,y:e.y}};return await p.generateSignedJwt(t,c,i.privateKey)}catch(l){throw l instanceof TypeError?new Error(`Error exporting dpop public key: ${l.message}`):l}}static async generateDPoPJkt(t){try{const r=await crypto.subtle.exportKey("jwk",t.publicKey);return await e.customCalculateJwkThumbprint(r)}catch(r){throw r instanceof TypeError?new Error(`Could not retrieve dpop keys from storage: ${r.message}`):r}}static async generateDPoPKeys(){return await window.crypto.subtle.generateKey({name:"ECDSA",namedCurve:"P-256"},!1,["sign","verify"])}};m.encodeBase64Url=e=>g(e).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_");var y=m,S=class{constructor(e){this._name=e,this._callbacks=[],this._logger=new v(`Event('${this._name}')`)}addHandler(e){return this._callbacks.push(e),()=>this.removeHandler(e)}removeHandler(e){const t=this._callbacks.lastIndexOf(e);t>=0&&this._callbacks.splice(t,1)}async raise(...e){this._logger.debug("raise:",...e);for(const t of this._callbacks)await t(...e)}},b=class e extends S{constructor(){super(...arguments),this._logger=new v(`Timer('${this._name}')`),this._timerHandle=null,this._expiration=0,this._callback=()=>{const t=this._expiration-e.getEpochTime();this._logger.debug("timer completes in",t),this._expiration<=e.getEpochTime()&&(this.cancel(),super.raise())}}static getEpochTime(){return Math.floor(Date.now()/1e3)}init(t){const r=this._logger.create("init");t=Math.max(Math.floor(t),1);const n=e.getEpochTime()+t;if(this.expiration===n&&this._timerHandle)return void r.debug("skipping since already initialized for expiration at",this.expiration);this.cancel(),r.debug("using duration",t),this._expiration=n;const i=Math.min(t,5);this._timerHandle=setInterval(this._callback,1e3*i)}get expiration(){return this._expiration}cancel(){this._logger.create("cancel"),this._timerHandle&&(clearInterval(this._timerHandle),this._timerHandle=null)}},E=class{static readParams(e,t="query"){if(!e)throw new TypeError("Invalid URL");const r=new URL(e,"http://127.0.0.1"),n=r["fragment"===t?"hash":"search"];return new URLSearchParams(n.slice(1))}},_=";",w=class extends Error{constructor(e,t){var r,n,i;if(super(e.error_description||e.error||""),this.form=t,this.name="ErrorResponse",!e.error)throw v.error("ErrorResponse","No error passed"),new Error("No error passed");this.error=e.error,this.error_description=null!=(r=e.error_description)?r:null,this.error_uri=null!=(n=e.error_uri)?n:null,this.state=e.userState,this.session_state=null!=(i=e.session_state)?i:null,this.url_state=e.url_state}},I=class extends Error{constructor(e){super(e),this.name="ErrorTimeout"}},T=class{constructor(){this._logger=new v("InMemoryWebStorage"),this._data={}}clear(){this._logger.create("clear"),this._data={}}getItem(e){return this._logger.create(`getItem('${e}')`),this._data[e]}setItem(e,t){this._logger.create(`setItem('${e}')`),this._data[e]=t}removeItem(e){this._logger.create(`removeItem('${e}')`),delete this._data[e]}get length(){return Object.getOwnPropertyNames(this._data).length}key(e){return Object.getOwnPropertyNames(this._data)[e]}},R=class extends Error{constructor(e,t){super(t),this.name="ErrorDPoPNonce",this.nonce=e}},k=class{constructor(e=[],t=null,r={}){this._jwtHandler=t,this._extraHeaders=r,this._logger=new v("JsonService"),this._contentTypes=[],this._contentTypes.push(...e,"application/json"),t&&this._contentTypes.push("application/jwt")}async fetchWithTimeout(e,t={}){const{timeoutInSeconds:r,...n}=t;if(!r)return await fetch(e,n);const i=new AbortController,o=setTimeout((()=>i.abort()),1e3*r);try{const r=await fetch(e,{...t,signal:i.signal});return r}catch(s){if(s instanceof DOMException&&"AbortError"===s.name)throw new I("Network timed out");throw s}finally{clearTimeout(o)}}async getJson(e,{token:t,credentials:r,timeoutInSeconds:n}={}){const i=this._logger.create("getJson"),o={Accept:this._contentTypes.join(", ")};let s;t&&(i.debug("token passed, setting Authorization header"),o["Authorization"]="Bearer "+t),this.appendExtraHeaders(o);try{i.debug("url:",e),s=await this.fetchWithTimeout(e,{method:"GET",headers:o,timeoutInSeconds:n,credentials:r})}catch(l){throw i.error("Network Error"),l}i.debug("HTTP response received, status",s.status);const a=s.headers.get("Content-Type");if(a&&!this._contentTypes.find((e=>a.startsWith(e)))&&i.throw(new Error(`Invalid response Content-Type: ${null!=a?a:"undefined"}, from URL: ${e}`)),s.ok&&this._jwtHandler&&(null==a?void 0:a.startsWith("application/jwt")))return await this._jwtHandler(await s.text());let c;try{c=await s.json()}catch(l){if(i.error("Error parsing JSON response",l),s.ok)throw l;throw new Error(`${s.statusText} (${s.status})`)}if(!s.ok){if(i.error("Error from server:",c),c.error)throw new w(c);throw new Error(`${s.statusText} (${s.status}): ${JSON.stringify(c)}`)}return c}async postForm(e,{body:t,basicAuth:r,timeoutInSeconds:n,initCredentials:i,extraHeaders:o}){const s=this._logger.create("postForm"),a={Accept:this._contentTypes.join(", "),"Content-Type":"application/x-www-form-urlencoded",...o};let c;void 0!==r&&(a["Authorization"]="Basic "+r),this.appendExtraHeaders(a);try{s.debug("url:",e),c=await this.fetchWithTimeout(e,{method:"POST",headers:a,body:t,timeoutInSeconds:n,credentials:i})}catch(h){throw s.error("Network error"),h}s.debug("HTTP response received, status",c.status);const l=c.headers.get("Content-Type");if(l&&!this._contentTypes.find((e=>l.startsWith(e))))throw new Error(`Invalid response Content-Type: ${null!=l?l:"undefined"}, from URL: ${e}`);const d=await c.text();let u={};if(d)try{u=JSON.parse(d)}catch(h){if(s.error("Error parsing JSON response",h),c.ok)throw h;throw new Error(`${c.statusText} (${c.status})`)}if(!c.ok){if(s.error("Error from server:",u),c.headers.has("dpop-nonce")){const e=c.headers.get("dpop-nonce");throw new R(e,`${JSON.stringify(u)}`)}if(u.error)throw new w(u,t);throw new Error(`${c.statusText} (${c.status}): ${JSON.stringify(u)}`)}return u}appendExtraHeaders(e){const t=this._logger.create("appendExtraHeaders"),r=Object.keys(this._extraHeaders),n=["authorization","accept","content-type"];0!==r.length&&r.forEach((r=>{if(n.includes(r.toLocaleLowerCase()))return void t.warn("Protected header could not be overridden",r,n);const i="function"===typeof this._extraHeaders[r]?this._extraHeaders[r]():this._extraHeaders[r];i&&""!==i&&(e[r]=i)}))}},A=class{constructor(e){this._settings=e,this._logger=new v("MetadataService"),this._signingKeys=null,this._metadata=null,this._metadataUrl=this._settings.metadataUrl,this._jsonService=new k(["application/jwk-set+json"],null,this._settings.extraHeaders),this._settings.signingKeys&&(this._logger.debug("using signingKeys from settings"),this._signingKeys=this._settings.signingKeys),this._settings.metadata&&(this._logger.debug("using metadata from settings"),this._metadata=this._settings.metadata),this._settings.fetchRequestCredentials&&(this._logger.debug("using fetchRequestCredentials from settings"),this._fetchRequestCredentials=this._settings.fetchRequestCredentials)}resetSigningKeys(){this._signingKeys=null}async getMetadata(){const e=this._logger.create("getMetadata");if(this._metadata)return e.debug("using cached values"),this._metadata;if(!this._metadataUrl)throw e.throw(new Error("No authority or metadataUrl configured on settings")),null;e.debug("getting metadata from",this._metadataUrl);const t=await this._jsonService.getJson(this._metadataUrl,{credentials:this._fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return e.debug("merging remote JSON with seed metadata"),this._metadata=Object.assign({},this._settings.metadataSeed,t),this._metadata}getIssuer(){return this._getMetadataProperty("issuer")}getAuthorizationEndpoint(){return this._getMetadataProperty("authorization_endpoint")}getUserInfoEndpoint(){return this._getMetadataProperty("userinfo_endpoint")}getTokenEndpoint(e=!0){return this._getMetadataProperty("token_endpoint",e)}getCheckSessionIframe(){return this._getMetadataProperty("check_session_iframe",!0)}getEndSessionEndpoint(){return this._getMetadataProperty("end_session_endpoint",!0)}getRevocationEndpoint(e=!0){return this._getMetadataProperty("revocation_endpoint",e)}getKeysEndpoint(e=!0){return this._getMetadataProperty("jwks_uri",e)}async _getMetadataProperty(e,t=!1){const r=this._logger.create(`_getMetadataProperty('${e}')`),n=await this.getMetadata();if(r.debug("resolved"),void 0===n[e]){if(!0===t)return void r.warn("Metadata does not contain optional property");r.throw(new Error("Metadata does not contain property "+e))}return n[e]}async getSigningKeys(){const e=this._logger.create("getSigningKeys");if(this._signingKeys)return e.debug("returning signingKeys from cache"),this._signingKeys;const t=await this.getKeysEndpoint(!1);e.debug("got jwks_uri",t);const r=await this._jsonService.getJson(t,{timeoutInSeconds:this._settings.requestTimeoutInSeconds});if(e.debug("got key set",r),!Array.isArray(r.keys))throw e.throw(new Error("Missing keys on keyset")),null;return this._signingKeys=r.keys,this._signingKeys}},C=class{constructor({prefix:e="oidc.",store:t=localStorage}={}){this._logger=new v("WebStorageStateStore"),this._store=t,this._prefix=e}async set(e,t){this._logger.create(`set('${e}')`),e=this._prefix+e,await this._store.setItem(e,t)}async get(e){this._logger.create(`get('${e}')`),e=this._prefix+e;const t=await this._store.getItem(e);return t}async remove(e){this._logger.create(`remove('${e}')`),e=this._prefix+e;const t=await this._store.getItem(e);return await this._store.removeItem(e),t}async getAllKeys(){this._logger.create("getAllKeys");const e=await this._store.length,t=[];for(let r=0;r<e;r++){const e=await this._store.key(r);e&&0===e.indexOf(this._prefix)&&t.push(e.substr(this._prefix.length))}return t}},O="code",D="openid",M="client_secret_post",P=900,x=class{constructor({authority:e,metadataUrl:t,metadata:r,signingKeys:n,metadataSeed:i,client_id:o,client_secret:s,response_type:a=O,scope:c=D,redirect_uri:l,post_logout_redirect_uri:d,client_authentication:u=M,prompt:h,display:v,max_age:p,ui_locales:f,acr_values:g,resource:m,response_mode:y,filterProtocolClaims:S=!0,loadUserInfo:b=!1,requestTimeoutInSeconds:E,staleStateAgeInSeconds:_=P,mergeClaimsStrategy:w={array:"replace"},disablePKCE:I=!1,stateStore:R,revokeTokenAdditionalContentTypes:k,fetchRequestCredentials:A,refreshTokenAllowedScope:x,extraQueryParams:U={},extraTokenParams:L={},extraHeaders:N={},dpop:B,omitScopeWhenRequesting:K=!1}){var F;if(this.authority=e,t?this.metadataUrl=t:(this.metadataUrl=e,e&&(this.metadataUrl.endsWith("/")||(this.metadataUrl+="/"),this.metadataUrl+=".well-known/openid-configuration")),this.metadata=r,this.metadataSeed=i,this.signingKeys=n,this.client_id=o,this.client_secret=s,this.response_type=a,this.scope=c,this.redirect_uri=l,this.post_logout_redirect_uri=d,this.client_authentication=u,this.prompt=h,this.display=v,this.max_age=p,this.ui_locales=f,this.acr_values=g,this.resource=m,this.response_mode=y,this.filterProtocolClaims=null==S||S,this.loadUserInfo=!!b,this.staleStateAgeInSeconds=_,this.mergeClaimsStrategy=w,this.omitScopeWhenRequesting=K,this.disablePKCE=!!I,this.revokeTokenAdditionalContentTypes=k,this.fetchRequestCredentials=A||"same-origin",this.requestTimeoutInSeconds=E,R)this.stateStore=R;else{const e="undefined"!==typeof window?window.localStorage:new T;this.stateStore=new C({store:e})}if(this.refreshTokenAllowedScope=x,this.extraQueryParams=U,this.extraTokenParams=L,this.extraHeaders=N,this.dpop=B,this.dpop&&!(null==(F=this.dpop)?void 0:F.store))throw new Error("A DPoPStore is required when dpop is enabled")}},U=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new v("UserInfoService"),this._getClaimsFromJwt=async e=>{const t=this._logger.create("_getClaimsFromJwt");try{const r=p.decode(e);return t.debug("JWT decoding successful"),r}catch(r){throw t.error("Error parsing JWT response"),r}},this._jsonService=new k(void 0,this._getClaimsFromJwt,this._settings.extraHeaders)}async getClaims(e){const t=this._logger.create("getClaims");e||this._logger.throw(new Error("No token passed"));const r=await this._metadataService.getUserInfoEndpoint();t.debug("got userinfo url",r);const n=await this._jsonService.getJson(r,{token:e,credentials:this._settings.fetchRequestCredentials,timeoutInSeconds:this._settings.requestTimeoutInSeconds});return t.debug("got claims",n),n}},L=class{constructor(e,t){this._settings=e,this._metadataService=t,this._logger=new v("TokenClient"),this._jsonService=new k(this._settings.revokeTokenAdditionalContentTypes,null,this._settings.extraHeaders)}async exchangeCode({grant_type:e="authorization_code",redirect_uri:t=this._settings.redirect_uri,client_id:r=this._settings.client_id,client_secret:n=this._settings.client_secret,extraHeaders:i,...o}){const s=this._logger.create("exchangeCode");r||s.throw(new Error("A client_id is required")),t||s.throw(new Error("A redirect_uri is required")),o.code||s.throw(new Error("A code is required"));const a=new URLSearchParams({grant_type:e,redirect_uri:t});for(const[u,h]of Object.entries(o))null!=h&&a.set(u,h);let c;switch(this._settings.client_authentication){case"client_secret_basic":if(!n)throw s.throw(new Error("A client_secret is required")),null;c=y.generateBasicAuth(r,n);break;case"client_secret_post":a.append("client_id",r),n&&a.append("client_secret",n);break}const l=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const d=await this._jsonService.postForm(l,{body:a,basicAuth:c,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return s.debug("got response"),d}async exchangeCredentials({grant_type:e="password",client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,scope:n=this._settings.scope,...i}){const o=this._logger.create("exchangeCredentials");t||o.throw(new Error("A client_id is required"));const s=new URLSearchParams({grant_type:e});this._settings.omitScopeWhenRequesting||s.set("scope",n);for(const[d,u]of Object.entries(i))null!=u&&s.set(d,u);let a;switch(this._settings.client_authentication){case"client_secret_basic":if(!r)throw o.throw(new Error("A client_secret is required")),null;a=y.generateBasicAuth(t,r);break;case"client_secret_post":s.append("client_id",t),r&&s.append("client_secret",r);break}const c=await this._metadataService.getTokenEndpoint(!1);o.debug("got token endpoint");const l=await this._jsonService.postForm(c,{body:s,basicAuth:a,timeoutInSeconds:this._settings.requestTimeoutInSeconds,initCredentials:this._settings.fetchRequestCredentials});return o.debug("got response"),l}async exchangeRefreshToken({grant_type:e="refresh_token",client_id:t=this._settings.client_id,client_secret:r=this._settings.client_secret,timeoutInSeconds:n,extraHeaders:i,...o}){const s=this._logger.create("exchangeRefreshToken");t||s.throw(new Error("A client_id is required")),o.refresh_token||s.throw(new Error("A refresh_token is required"));const a=new URLSearchParams({grant_type:e});for(const[u,h]of Object.entries(o))Array.isArray(h)?h.forEach((e=>a.append(u,e))):null!=h&&a.set(u,h);let c;switch(this._settings.client_authentication){case"client_secret_basic":if(!r)throw s.throw(new Error("A client_secret is required")),null;c=y.generateBasicAuth(t,r);break;case"client_secret_post":a.append("client_id",t),r&&a.append("client_secret",r);break}const l=await this._metadataService.getTokenEndpoint(!1);s.debug("got token endpoint");const d=await this._jsonService.postForm(l,{body:a,basicAuth:c,timeoutInSeconds:n,initCredentials:this._settings.fetchRequestCredentials,extraHeaders:i});return s.debug("got response"),d}async revoke(e){var t;const r=this._logger.create("revoke");e.token||r.throw(new Error("A token is required"));const n=await this._metadataService.getRevocationEndpoint(!1);r.debug(`got revocation endpoint, revoking ${null!=(t=e.token_type_hint)?t:"default token type"}`);const i=new URLSearchParams;for(const[o,s]of Object.entries(e))null!=s&&i.set(o,s);i.set("client_id",this._settings.client_id),this._settings.client_secret&&i.set("client_secret",this._settings.client_secret),await this._jsonService.postForm(n,{body:i,timeoutInSeconds:this._settings.requestTimeoutInSeconds}),r.debug("got response")}},N=class{constructor(e,t,r){this._settings=e,this._metadataService=t,this._claimsService=r,this._logger=new v("ResponseValidator"),this._userInfoService=new U(this._settings,this._metadataService),this._tokenClient=new L(this._settings,this._metadataService)}async validateSigninResponse(e,t,r){const n=this._logger.create("validateSigninResponse");this._processSigninState(e,t),n.debug("state processed"),await this._processCode(e,t,r),n.debug("code processed"),e.isOpenId&&this._validateIdTokenAttributes(e),n.debug("tokens validated"),await this._processClaims(e,null==t?void 0:t.skipUserInfo,e.isOpenId),n.debug("claims processed")}async validateCredentialsResponse(e,t){const r=this._logger.create("validateCredentialsResponse");e.isOpenId&&e.id_token&&this._validateIdTokenAttributes(e),r.debug("tokens validated"),await this._processClaims(e,t,e.isOpenId),r.debug("claims processed")}async validateRefreshResponse(e,t){const r=this._logger.create("validateRefreshResponse");e.userState=t.data,null!=e.session_state||(e.session_state=t.session_state),null!=e.scope||(e.scope=t.scope),e.isOpenId&&e.id_token&&(this._validateIdTokenAttributes(e,t.id_token),r.debug("ID Token validated")),e.id_token||(e.id_token=t.id_token,e.profile=t.profile);const n=e.isOpenId&&!!e.id_token;await this._processClaims(e,!1,n),r.debug("claims processed")}validateSignoutResponse(e,t){const r=this._logger.create("validateSignoutResponse");if(t.id!==e.state&&r.throw(new Error("State does not match")),r.debug("state validated"),e.userState=t.data,e.error)throw r.warn("Response was error",e.error),new w(e)}_processSigninState(e,t){const r=this._logger.create("_processSigninState");if(t.id!==e.state&&r.throw(new Error("State does not match")),t.client_id||r.throw(new Error("No client_id on state")),t.authority||r.throw(new Error("No authority on state")),this._settings.authority!==t.authority&&r.throw(new Error("authority mismatch on settings vs. signin state")),this._settings.client_id&&this._settings.client_id!==t.client_id&&r.throw(new Error("client_id mismatch on settings vs. signin state")),r.debug("state validated"),e.userState=t.data,e.url_state=t.url_state,null!=e.scope||(e.scope=t.scope),e.error)throw r.warn("Response was error",e.error),new w(e);t.code_verifier&&!e.code&&r.throw(new Error("Expected code in response"))}async _processClaims(e,t=!1,r=!0){const n=this._logger.create("_processClaims");if(e.profile=this._claimsService.filterProtocolClaims(e.profile),t||!this._settings.loadUserInfo||!e.access_token)return void n.debug("not loading user info");n.debug("loading user info");const i=await this._userInfoService.getClaims(e.access_token);n.debug("user info claims received from user info endpoint"),r&&i.sub!==e.profile.sub&&n.throw(new Error("subject from UserInfo response does not match subject in ID Token")),e.profile=this._claimsService.mergeClaims(e.profile,this._claimsService.filterProtocolClaims(i)),n.debug("user info claims received, updated profile:",e.profile)}async _processCode(e,t,r){const n=this._logger.create("_processCode");if(e.code){n.debug("Validating code");const i=await this._tokenClient.exchangeCode({client_id:t.client_id,client_secret:t.client_secret,code:e.code,redirect_uri:t.redirect_uri,code_verifier:t.code_verifier,extraHeaders:r,...t.extraTokenParams});Object.assign(e,i)}else n.debug("No code to process")}_validateIdTokenAttributes(e,t){var r;const n=this._logger.create("_validateIdTokenAttributes");n.debug("decoding ID Token JWT");const i=p.decode(null!=(r=e.id_token)?r:"");if(i.sub||n.throw(new Error("ID Token is missing a subject claim")),t){const e=p.decode(t);i.sub!==e.sub&&n.throw(new Error("sub in id_token does not match current sub")),i.auth_time&&i.auth_time!==e.auth_time&&n.throw(new Error("auth_time in id_token does not match original auth_time")),i.azp&&i.azp!==e.azp&&n.throw(new Error("azp in id_token does not match original azp")),!i.azp&&e.azp&&n.throw(new Error("azp not in id_token, but present in original id_token"))}e.profile=i}},B=class e{constructor(e){this.id=e.id||y.generateUUIDv4(),this.data=e.data,e.created&&e.created>0?this.created=e.created:this.created=b.getEpochTime(),this.request_type=e.request_type,this.url_state=e.url_state}toStorageString(){return new v("State").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state})}static fromStorageString(t){return v.createStatic("State","fromStorageString"),Promise.resolve(new e(JSON.parse(t)))}static async clearStaleState(t,r){const n=v.createStatic("State","clearStaleState"),i=b.getEpochTime()-r,o=await t.getAllKeys();n.debug("got keys",o);for(let a=0;a<o.length;a++){const r=o[a],c=await t.get(r);let l=!1;if(c)try{const t=await e.fromStorageString(c);n.debug("got item from key:",r,t.created),t.created<=i&&(l=!0)}catch(s){n.error("Error parsing state for key:",r,s),l=!0}else n.debug("no item in storage for key:",r),l=!0;l&&(n.debug("removed item for key:",r),t.remove(r))}}},K=class e extends B{constructor(e){super(e),this.code_verifier=e.code_verifier,this.code_challenge=e.code_challenge,this.authority=e.authority,this.client_id=e.client_id,this.redirect_uri=e.redirect_uri,this.scope=e.scope,this.client_secret=e.client_secret,this.extraTokenParams=e.extraTokenParams,this.response_mode=e.response_mode,this.skipUserInfo=e.skipUserInfo}static async create(t){const r=!0===t.code_verifier?y.generateCodeVerifier():t.code_verifier||void 0,n=r?await y.generateCodeChallenge(r):void 0;return new e({...t,code_verifier:r,code_challenge:n})}toStorageString(){return new v("SigninState").create("toStorageString"),JSON.stringify({id:this.id,data:this.data,created:this.created,request_type:this.request_type,url_state:this.url_state,code_verifier:this.code_verifier,authority:this.authority,client_id:this.client_id,redirect_uri:this.redirect_uri,scope:this.scope,client_secret:this.client_secret,extraTokenParams:this.extraTokenParams,response_mode:this.response_mode,skipUserInfo:this.skipUserInfo})}static fromStorageString(t){v.createStatic("SigninState","fromStorageString");const r=JSON.parse(t);return e.create(r)}},F=class e{constructor(e){this.url=e.url,this.state=e.state}static async create({url:t,authority:r,client_id:n,redirect_uri:i,response_type:o,scope:s,state_data:a,response_mode:c,request_type:l,client_secret:d,nonce:u,url_state:h,resource:v,skipUserInfo:p,extraQueryParams:f,extraTokenParams:g,disablePKCE:m,dpopJkt:y,omitScopeWhenRequesting:S,...b}){if(!t)throw this._logger.error("create: No url passed"),new Error("url");if(!n)throw this._logger.error("create: No client_id passed"),new Error("client_id");if(!i)throw this._logger.error("create: No redirect_uri passed"),new Error("redirect_uri");if(!o)throw this._logger.error("create: No response_type passed"),new Error("response_type");if(!s)throw this._logger.error("create: No scope passed"),new Error("scope");if(!r)throw this._logger.error("create: No authority passed"),new Error("authority");const E=await K.create({data:a,request_type:l,url_state:h,code_verifier:!m,client_id:n,authority:r,redirect_uri:i,response_mode:c,client_secret:d,scope:s,extraTokenParams:g,skipUserInfo:p}),w=new URL(t);w.searchParams.append("client_id",n),w.searchParams.append("redirect_uri",i),w.searchParams.append("response_type",o),S||w.searchParams.append("scope",s),u&&w.searchParams.append("nonce",u),y&&w.searchParams.append("dpop_jkt",y);let I=E.id;if(h&&(I=`${I}${_}${h}`),w.searchParams.append("state",I),E.code_challenge&&(w.searchParams.append("code_challenge",E.code_challenge),w.searchParams.append("code_challenge_method","S256")),v){const e=Array.isArray(v)?v:[v];e.forEach((e=>w.searchParams.append("resource",e)))}for(const[e,_]of Object.entries({response_mode:c,...b,...f}))null!=_&&w.searchParams.append(e,_.toString());return new e({url:w.href,state:E})}};F._logger=new v("SigninRequest");var j=F,q="openid",V=class{constructor(e){if(this.access_token="",this.token_type="",this.profile={},this.state=e.get("state"),this.session_state=e.get("session_state"),this.state){const e=decodeURIComponent(this.state).split(_);this.state=e[0],e.length>1&&(this.url_state=e.slice(1).join(_))}this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri"),this.code=e.get("code")}get expires_in(){if(void 0!==this.expires_at)return this.expires_at-b.getEpochTime()}set expires_in(e){"string"===typeof e&&(e=Number(e)),void 0!==e&&e>=0&&(this.expires_at=Math.floor(e)+b.getEpochTime())}get isOpenId(){var e;return(null==(e=this.scope)?void 0:e.split(" ").includes(q))||!!this.id_token}},G=class{constructor({url:e,state_data:t,id_token_hint:r,post_logout_redirect_uri:n,extraQueryParams:i,request_type:o,client_id:s}){if(this._logger=new v("SignoutRequest"),!e)throw this._logger.error("ctor: No url passed"),new Error("url");const a=new URL(e);r&&a.searchParams.append("id_token_hint",r),s&&a.searchParams.append("client_id",s),n&&(a.searchParams.append("post_logout_redirect_uri",n),t&&(this.state=new B({data:t,request_type:o}),a.searchParams.append("state",this.state.id)));for(const[c,l]of Object.entries({...i}))null!=l&&a.searchParams.append(c,l.toString());this.url=a.href}},W=class{constructor(e){this.state=e.get("state"),this.error=e.get("error"),this.error_description=e.get("error_description"),this.error_uri=e.get("error_uri")}},H=["nbf","jti","auth_time","nonce","acr","amr","azp","at_hash"],$=["sub","iss","aud","exp","iat"],J=class{constructor(e){this._settings=e,this._logger=new v("ClaimsService")}filterProtocolClaims(e){const t={...e};if(this._settings.filterProtocolClaims){let e;e=Array.isArray(this._settings.filterProtocolClaims)?this._settings.filterProtocolClaims:H;for(const r of e)$.includes(r)||delete t[r]}return t}mergeClaims(e,t){const r={...e};for(const[n,i]of Object.entries(t))if(r[n]!==i)if(Array.isArray(r[n])||Array.isArray(i))if("replace"==this._settings.mergeClaimsStrategy.array)r[n]=i;else{const e=Array.isArray(r[n])?r[n]:[r[n]];for(const t of Array.isArray(i)?i:[i])e.includes(t)||e.push(t);r[n]=e}else"object"===typeof r[n]&&"object"===typeof i?r[n]=this.mergeClaims(r[n],i):r[n]=i;return r}},z=class{constructor(e,t){this.keys=e,this.nonce=t}},Y=class{constructor(e,t){this._logger=new v("OidcClient"),this.settings=e instanceof x?e:new x(e),this.metadataService=null!=t?t:new A(this.settings),this._claimsService=new J(this.settings),this._validator=new N(this.settings,this.metadataService,this._claimsService),this._tokenClient=new L(this.settings,this.metadataService)}async createSigninRequest({state:e,request:t,request_uri:r,request_type:n,id_token_hint:i,login_hint:o,skipUserInfo:s,nonce:a,url_state:c,response_type:l=this.settings.response_type,scope:d=this.settings.scope,redirect_uri:u=this.settings.redirect_uri,prompt:h=this.settings.prompt,display:v=this.settings.display,max_age:p=this.settings.max_age,ui_locales:f=this.settings.ui_locales,acr_values:g=this.settings.acr_values,resource:m=this.settings.resource,response_mode:y=this.settings.response_mode,extraQueryParams:S=this.settings.extraQueryParams,extraTokenParams:b=this.settings.extraTokenParams,dpopJkt:E,omitScopeWhenRequesting:_=this.settings.omitScopeWhenRequesting}){const w=this._logger.create("createSigninRequest");if("code"!==l)throw new Error("Only the Authorization Code flow (with PKCE) is supported");const I=await this.metadataService.getAuthorizationEndpoint();w.debug("Received authorization endpoint",I);const T=await j.create({url:I,authority:this.settings.authority,client_id:this.settings.client_id,redirect_uri:u,response_type:l,scope:d,state_data:e,url_state:c,prompt:h,display:v,max_age:p,ui_locales:f,id_token_hint:i,login_hint:o,acr_values:g,dpopJkt:E,resource:m,request:t,request_uri:r,extraQueryParams:S,extraTokenParams:b,request_type:n,response_mode:y,client_secret:this.settings.client_secret,skipUserInfo:s,nonce:a,disablePKCE:this.settings.disablePKCE,omitScopeWhenRequesting:_});await this.clearStaleState();const R=T.state;return await this.settings.stateStore.set(R.id,R.toStorageString()),T}async readSigninResponseState(e,t=!1){const r=this._logger.create("readSigninResponseState"),n=new V(E.readParams(e,this.settings.response_mode));if(!n.state)throw r.throw(new Error("No state in response")),null;const i=await this.settings.stateStore[t?"remove":"get"](n.state);if(!i)throw r.throw(new Error("No matching state found in storage")),null;const o=await K.fromStorageString(i);return{state:o,response:n}}async processSigninResponse(e,t){const r=this._logger.create("processSigninResponse"),{state:n,response:i}=await this.readSigninResponseState(e,!0);if(r.debug("received state from storage; validating response"),this.settings.dpop&&this.settings.dpop.store){const e=await this.getDpopProof(this.settings.dpop.store);t={...t,DPoP:e}}try{await this._validator.validateSigninResponse(i,n,t)}catch(o){if(!(o instanceof R&&this.settings.dpop))throw o;{const e=await this.getDpopProof(this.settings.dpop.store,o.nonce);t["DPoP"]=e,await this._validator.validateSigninResponse(i,n,t)}}return i}async getDpopProof(e,t){let r,n;return(await e.getAllKeys()).includes(this.settings.client_id)?(n=await e.get(this.settings.client_id),n.nonce!==t&&t&&(n.nonce=t,await e.set(this.settings.client_id,n))):(r=await y.generateDPoPKeys(),n=new z(r,t),await e.set(this.settings.client_id,n)),await y.generateDPoPProof({url:await this.metadataService.getTokenEndpoint(!1),httpMethod:"POST",keyPair:n.keys,nonce:n.nonce})}async processResourceOwnerPasswordCredentials({username:e,password:t,skipUserInfo:r=!1,extraTokenParams:n={}}){const i=await this._tokenClient.exchangeCredentials({username:e,password:t,...n}),o=new V(new URLSearchParams);return Object.assign(o,i),await this._validator.validateCredentialsResponse(o,r),o}async useRefreshToken({state:e,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,extraTokenParams:o}){var s;const a=this._logger.create("useRefreshToken");let c,l;if(void 0===this.settings.refreshTokenAllowedScope)c=e.scope;else{const t=this.settings.refreshTokenAllowedScope.split(" "),r=(null==(s=e.scope)?void 0:s.split(" "))||[];c=r.filter((e=>t.includes(e))).join(" ")}if(this.settings.dpop&&this.settings.dpop.store){const e=await this.getDpopProof(this.settings.dpop.store);i={...i,DPoP:e}}try{l=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:c,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,...o})}catch(u){if(!(u instanceof R&&this.settings.dpop))throw u;i["DPoP"]=await this.getDpopProof(this.settings.dpop.store,u.nonce),l=await this._tokenClient.exchangeRefreshToken({refresh_token:e.refresh_token,scope:c,redirect_uri:t,resource:r,timeoutInSeconds:n,extraHeaders:i,...o})}const d=new V(new URLSearchParams);return Object.assign(d,l),a.debug("validating response",d),await this._validator.validateRefreshResponse(d,{...e,scope:c}),d}async createSignoutRequest({state:e,id_token_hint:t,client_id:r,request_type:n,post_logout_redirect_uri:i=this.settings.post_logout_redirect_uri,extraQueryParams:o=this.settings.extraQueryParams}={}){const s=this._logger.create("createSignoutRequest"),a=await this.metadataService.getEndSessionEndpoint();if(!a)throw s.throw(new Error("No end session endpoint")),null;s.debug("Received end session endpoint",a),r||!i||t||(r=this.settings.client_id);const c=new G({url:a,id_token_hint:t,client_id:r,post_logout_redirect_uri:i,state_data:e,extraQueryParams:o,request_type:n});await this.clearStaleState();const l=c.state;return l&&(s.debug("Signout request has state to persist"),await this.settings.stateStore.set(l.id,l.toStorageString())),c}async readSignoutResponseState(e,t=!1){const r=this._logger.create("readSignoutResponseState"),n=new W(E.readParams(e,this.settings.response_mode));if(!n.state){if(r.debug("No state in response"),n.error)throw r.warn("Response was error:",n.error),new w(n);return{state:void 0,response:n}}const i=await this.settings.stateStore[t?"remove":"get"](n.state);if(!i)throw r.throw(new Error("No matching state found in storage")),null;const o=await B.fromStorageString(i);return{state:o,response:n}}async processSignoutResponse(e){const t=this._logger.create("processSignoutResponse"),{state:r,response:n}=await this.readSignoutResponseState(e,!0);return r?(t.debug("Received state from storage; validating response"),this._validator.validateSignoutResponse(n,r)):t.debug("No state from storage; skipping response validation"),n}clearStaleState(){return this._logger.create("clearStaleState"),B.clearStaleState(this.settings.stateStore,this.settings.staleStateAgeInSeconds)}async revokeToken(e,t){return this._logger.create("revokeToken"),await this._tokenClient.revoke({token:e,token_type_hint:t})}},Q=r(3271),X=r(9553),Z=function(e){return e["NotSupported"]="OIDC authentication not supported",e["Misconfigured"]="OIDC is misconfigured",e["General"]="Something went wrong with OIDC discovery",e["OpSupport"]="Configured OIDC OP does not support required functions",e["DynamicRegistrationNotSupported"]="Dynamic registration not supported",e["DynamicRegistrationFailed"]="Dynamic registration failed",e["DynamicRegistrationInvalid"]="Dynamic registration invalid response",e["CodeExchangeFailed"]="Failed to exchange code for token",e["InvalidBearerTokenResponse"]="Invalid bearer token response",e["InvalidIdToken"]="Invalid ID token",e["MissingOrInvalidStoredState"]="State required to finish logging in is not found in storage.",e}({}),ee=(r(1148),r(3579),e=>!!e&&"object"===typeof e&&!Array.isArray(e)),te=(e,t)=>!(!e[t]||!re(e,t))||(Q.v.error("Missing or invalid property: ".concat(t)),!1),re=(e,t)=>!e[t]||"string"===typeof e[t]||(Q.v.error("Invalid property: ".concat(t)),!1),ne=(e,t)=>!!(!e[t]||Array.isArray(e[t])&&e[t].every((e=>"string"===typeof e)))||(Q.v.error("Invalid property: ".concat(t)),!1),ie=(e,t,r)=>{var n=e[t];return!!(n&&Array.isArray(n)&&n.includes(r))||(Q.v.error("Invalid property: ".concat(t,". ").concat(r," is required.")),!1)},oe=e=>{if(!ee(e))throw Q.v.error("Issuer configuration not found or malformed"),new Error(Z.OpSupport);var t=[te(e,"issuer"),te(e,"authorization_endpoint"),te(e,"token_endpoint"),te(e,"revocation_endpoint"),re(e,"registration_endpoint"),re(e,"account_management_uri"),re(e,"device_authorization_endpoint"),ne(e,"account_management_actions_supported"),ie(e,"response_types_supported","code"),ie(e,"grant_types_supported","authorization_code"),ie(e,"code_challenge_methods_supported","S256"),ne(e,"prompt_values_supported")].some((e=>!e));if(!t)return e;throw Q.v.error("Issuer configuration not valid"),new Error(Z.OpSupport)},se=e=>{try{return c(e)}catch(t){throw Q.v.error("Could not decode id_token",t),t}},ae=(e,t,r,n)=>{try{if(!e)throw new Error("No ID token");var i=se(e);if(i.iss!==t)throw new Error("Invalid issuer");var o="string"===typeof i.aud?[i.aud]:i.aud;if(!o.includes(r))throw new Error("Invalid audience");if(void 0!==n&&i.nonce!==n)throw new Error("Invalid nonce");if(!i.exp||Date.now()>1e3*i.exp)throw new Error("Invalid expiry")}catch(s){throw Q.v.error("Invalid ID token",s),new Error(Z.InvalidIdToken)}};function ce(e){if(!ee(e))throw Q.v.error("Stored user state not found"),new Error(Z.MissingOrInvalidStoredState);var t=[te(e,"homeserverUrl"),te(e,"nonce"),re(e,"identityServerUrl")].some((e=>!e));if(t)throw new Error(Z.MissingOrInvalidStoredState)}var le=e=>ee(e)&&te(e,"token_type")&&"bearer"===e["token_type"].toLowerCase()&&te(e,"access_token")&&te(e,"refresh_token")&&(!("expires_in"in e)||"number"===typeof e["expires_in"]);function de(e){if(!le(e))throw new Error(Z.InvalidBearerTokenResponse)}var ue=r(7363),he=r(944);function ve(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function pe(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?ve(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):ve(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var fe=e=>{var t=null!==e&&void 0!==e?e:(0,X.US)(10);return"openid urn:matrix:org.matrix.msc2967.client:api:* urn:matrix:org.matrix.msc2967.client:device:".concat(t)},ge=function(){var e=(0,i.A)((function*(e){if(!globalThis.crypto.subtle)return Q.v.warn("A secure context is required to generate code challenge. Using plain text code challenge"),e;var t=yield(0,ue.s)(e);return(0,he.A4)(t)}));return function(t){return e.apply(this,arguments)}}(),me=e=>{var{redirectUri:t}=e;return{scope:fe(),redirectUri:t,state:(0,X.US)(8),nonce:(0,X.US)(8),codeVerifier:(0,X.US)(64)}},ye=function(){var e=(0,i.A)((function*(e,t,r){var{scope:n,redirectUri:i,state:o,nonce:s,codeVerifier:a}=r,c=new URL(e);return c.searchParams.append("response_mode","query"),c.searchParams.append("response_type","code"),c.searchParams.append("redirect_uri",i),c.searchParams.append("client_id",t),c.searchParams.append("state",o),c.searchParams.append("scope",n),c.searchParams.append("nonce",s),c.searchParams.append("code_challenge_method","S256"),c.searchParams.append("code_challenge",yield ge(a)),c.toString()}));return function(t,r,n){return e.apply(this,arguments)}}(),Se=function(){var e=(0,i.A)((function*(e){var{metadata:t,redirectUri:r,clientId:n,homeserverUrl:i,identityServerUrl:o,nonce:s,prompt:a,urlState:c}=e,l=fe(),d=new Y(pe(pe({},t),{},{client_id:n,redirect_uri:r,authority:t.issuer,response_mode:"query",response_type:"code",scope:l,stateStore:new C({prefix:"mx_oidc_",store:window.sessionStorage})})),u={homeserverUrl:i,nonce:s,identityServerUrl:o},h=yield d.createSigninRequest({state:u,nonce:s,prompt:a,url_state:c});return h.url}));return function(t){return e.apply(this,arguments)}}(),be=e=>({id_token:e.id_token,scope:e.scope,expires_at:e.expires_at,refresh_token:e.refresh_token,access_token:e.access_token,token_type:"Bearer"}),Ee=function(){var e=(0,i.A)((function*(e,t){var r=new URL(window.location.origin);r.searchParams.append("code",e),r.searchParams.append("state",t),h.setLogger(Q.v);try{var n=new V(r.searchParams),i=new C({prefix:"mx_oidc_",store:window.sessionStorage}),o=yield i.get(n.state);if(!o)throw new Error(Z.MissingOrInvalidStoredState);var s=yield K.fromStorageString(o),a=new Y(pe(pe({},s),{},{stateStore:i})),c=yield a.processSigninResponse(r.href),l=c.userState;ce(l),de(c),ae(c.id_token,a.settings.authority,a.settings.client_id,l.nonce);var d=be(c);return{oidcClientSettings:{clientId:a.settings.client_id,issuer:a.settings.authority},tokenResponse:d,homeserverUrl:l.homeserverUrl,identityServerUrl:l.identityServerUrl,idTokenClaims:c.profile}}catch(v){Q.v.error("Oidc login failed",v);var u=v.message;if(Object.values(Z).includes(u))throw v;throw new Error(Z.CodeExchangeFailed)}}));return function(t,r){return e.apply(this,arguments)}}(),_e=r(9683);function we(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Ie(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?we(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):we(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Te=function(){var e=(0,i.A)((function*(e){var t=new URL(".well-known/openid-configuration",e),r=yield fetch(t,{method:_e.IT.Get,signal:(0,_e._)(5e3)}),n=yield r.json();return Re(n)}));return function(t){return e.apply(this,arguments)}}(),Re=function(){var e=(0,i.A)((function*(e){var t=oe(e),r=new x({authority:t.issuer,metadata:t,redirect_uri:"",client_id:""}),n=new A(r);return Ie(Ie({},t),{},{signingKeys:yield n.getSigningKeys()})}));return function(t){return e.apply(this,arguments)}}(),ke="urn:ietf:params:oauth:grant-type:device_code",Ae=function(){var e=(0,i.A)((function*(e,t){if(!e.registration_endpoint)throw new Error(Z.DynamicRegistrationNotSupported);var r=["authorization_code","refresh_token"];if(r.some((t=>!e.grant_types_supported.includes(t))))throw new Error(Z.DynamicRegistrationNotSupported);var n={client_name:t.clientName,client_uri:t.clientUri,response_types:["code"],grant_types:r,redirect_uris:t.redirectUris,id_token_signed_response_alg:"RS256",token_endpoint_auth_method:"none",application_type:t.applicationType,logo_uri:t.logoUri,contacts:t.contacts,policy_uri:t.policyUri,tos_uri:t.tosUri},i={Accept:"application/json","Content-Type":"application/json"};try{var o=yield fetch(e.registration_endpoint,{method:_e.IT.Post,headers:i,body:JSON.stringify(n)});if(o.status>=400)throw new Error(Z.DynamicRegistrationFailed);var s=yield o.json(),a=s["client_id"];if(!a||"string"!==typeof a)throw new Error(Z.DynamicRegistrationInvalid);return a}catch(c){throw Object.values(Z).includes(c.message)?c:(Q.v.error("Dynamic registration request failed",c),new Error(Z.DynamicRegistrationFailed))}}));return function(t,r){return e.apply(this,arguments)}}();class Ce{constructor(e,t,r,i,o){this.idTokenClaims=o,(0,n.A)(this,"oidcClientReady",void 0),(0,n.A)(this,"oidcClient",void 0),(0,n.A)(this,"inflightRefreshRequest",void 0),this.oidcClientReady=this.initialiseOidcClient(e,t,i,r)}initialiseOidcClient(e,t,r,n){var o=this;return(0,i.A)((function*(){try{var i,s=yield Te(e),a=fe(r);o.oidcClient=new Y({metadata:s,signingKeys:null!==(i=s.signingKeys)&&void 0!==i?i:void 0,client_id:t,scope:a,redirect_uri:n,authority:s.issuer,stateStore:new C({prefix:"mx_oidc_",store:window.sessionStorage})})}catch(c){throw Q.v.error("Failed to initialise OIDC client.",c),new Error("Failed to initialise OIDC client.")}}))()}doRefreshAccessToken(e){var t=this;return(0,i.A)((function*(){t.inflightRefreshRequest||(t.inflightRefreshRequest=t.getNewTokens(e));try{var r=yield t.inflightRefreshRequest;return r}finally{t.inflightRefreshRequest=void 0}}))()}persistTokens(e){return(0,i.A)((function*(){}))()}getNewTokens(e){var t=this;return(0,i.A)((function*(){if(!t.oidcClient)throw new Error("Cannot get new token before OIDC client is initialised.");var r={refresh_token:e,session_state:"test",data:void 0,profile:t.idTokenClaims},n=yield t.oidcClient.useRefreshToken({state:r,timeoutInSeconds:300}),i={accessToken:n.access_token,refreshToken:n.refresh_token};return yield t.persistTokens(i),i}))()}}},5169:function(e,t,r){"use strict";var n=r(3238),i=TypeError;e.exports=function(e){if(n(e))throw new i("ArrayBuffer is detached");return e}},5170:function(e,t,r){"use strict";var n=r(6706),i=r(4402);e.exports=n(i.proto,"size","get")||function(e){return e.size}},5187:function(e,t,r){"use strict";r.d(t,{A:function(){return u}});const n="undefined"!==typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var i={randomUUID:n};r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);let o;const s=new Uint8Array(16);function a(){if(!o){if("undefined"===typeof crypto||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");o=crypto.getRandomValues.bind(crypto)}return o(s)}r(4114);const c=[];for(let h=0;h<256;++h)c.push((h+256).toString(16).slice(1));function l(e,t=0){return(c[e[t+0]]+c[e[t+1]]+c[e[t+2]]+c[e[t+3]]+"-"+c[e[t+4]]+c[e[t+5]]+"-"+c[e[t+6]]+c[e[t+7]]+"-"+c[e[t+8]]+c[e[t+9]]+"-"+c[e[t+10]]+c[e[t+11]]+c[e[t+12]]+c[e[t+13]]+c[e[t+14]]+c[e[t+15]]).toLowerCase()}function d(e,t,r){if(i.randomUUID&&!t&&!e)return i.randomUUID();e=e||{};const n=e.random??e.rng?.()??a();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){if(r=r||0,r<0||r+16>t.length)throw new RangeError(`UUID byte range ${r}:${r+15} is out of buffer bounds`);for(let e=0;e<16;++e)t[r+e]=n[e];return t}return l(n)}var u=d},5315:function(e,t,r){"use strict";r.d(t,{MN:function(){return d},gc:function(){return l},iz:function(){return c}});r(8111),r(7588),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698),r(4603),r(7566),r(8721);var n=r(698),i=r(4761),o=r(3271),s=r(9683),a=r(9061),c=function(e){return e["SUCCESS"]="SUCCESS",e["IGNORE"]="IGNORE",e["PROMPT"]="PROMPT",e["FAIL_PROMPT"]="FAIL_PROMPT",e["FAIL_ERROR"]="FAIL_ERROR",e}({}),l=function(e){return e["Invalid"]="Invalid homeserver discovery response",e["GenericFailure"]="Failed to get autodiscovery configuration from server",e["InvalidHsBaseUrl"]="Invalid base_url for m.homeserver",e["InvalidHomeserver"]="Homeserver URL does not appear to be a valid Matrix homeserver",e["InvalidIsBaseUrl"]="Invalid base_url for m.identity_server",e["InvalidIdentityServer"]="Identity server URL does not appear to be a valid identity server",e["InvalidIs"]="Invalid identity server discovery response",e["MissingWellknown"]="No .well-known JSON file found",e["InvalidJson"]="Invalid JSON",e["UnsupportedHomeserverSpecVersion"]="The homeserver does not meet the version requirements",e}({});class d{static fromDiscoveryConfig(e){var t=this;return(0,n.A)((function*(){var r,n={"m.homeserver":{state:d.FAIL_ERROR,error:d.ERROR_INVALID,base_url:null},"m.identity_server":{state:d.PROMPT,error:null,base_url:null}};if(null===e||void 0===e||!e["m.homeserver"])return o.v.error("No m.homeserver key in config"),n["m.homeserver"].state=d.FAIL_PROMPT,n["m.homeserver"].error=d.ERROR_INVALID,Promise.resolve(n);if(!e["m.homeserver"]["base_url"])return o.v.error("No m.homeserver base_url in config"),n["m.homeserver"].state=d.FAIL_PROMPT,n["m.homeserver"].error=d.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var i=t.sanitizeWellKnownUrl(e["m.homeserver"]["base_url"]);if(!i)return o.v.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=d.ERROR_INVALID_HS_BASE_URL,Promise.resolve(n);var s=yield t.fetchWellKnownObject("".concat(i,"/_matrix/client/versions"));if(!s||!Array.isArray(null===(r=s.raw)||void 0===r?void 0:r["versions"]))return o.v.error("Invalid /versions response"),n["m.homeserver"].error=d.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=i,Promise.resolve(n);var l=new Set(s.raw["versions"]),u=!1;for(var h of a.Hr)if(l.has(h)){u=!0;break}if(!u)return o.v.error("Homeserver does not meet version requirements"),n["m.homeserver"].error=d.ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION,n["m.homeserver"].base_url=i,Promise.resolve(n);n["m.homeserver"]={state:d.SUCCESS,error:null,base_url:i};var v="";if(e["m.identity_server"]){var p={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:d.FAIL_PROMPT,error:d.ERROR_INVALID_IS,base_url:null}};if(v=t.sanitizeWellKnownUrl(e["m.identity_server"]["base_url"]),!v)return o.v.error("Invalid base_url for m.identity_server"),p["m.identity_server"].error=d.ERROR_INVALID_IS_BASE_URL,Promise.resolve(p);var f=yield t.fetchWellKnownObject("".concat(v,"/_matrix/identity/v2"));if(null===f||void 0===f||!f.raw||f.action!==c.SUCCESS)return o.v.error("Invalid /v2 response"),p["m.identity_server"].error=d.ERROR_INVALID_IDENTITY_SERVER,p["m.identity_server"].base_url=v,Promise.resolve(p)}return v&&v.toString().length>0&&(n["m.identity_server"]={state:d.SUCCESS,error:null,base_url:v}),Object.keys(e).forEach((t=>{if("m.homeserver"===t||"m.identity_server"===t){var r=["error","state","base_url"];for(var i of Object.keys(e[t]))r.includes(i)||(n[t][i]=e[t][i])}else n[t]=e[t]})),Promise.resolve(n)}))()}static findClientConfig(e){var t=this;return(0,n.A)((function*(){if(!e||"string"!==typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");var r={"m.homeserver":{state:d.FAIL_ERROR,error:d.ERROR_INVALID,base_url:null},"m.identity_server":{state:d.PROMPT,error:null,base_url:null}},n=e.includes("://")?e:"https://".concat(e),i=yield t.fetchWellKnownObject("".concat(n,"/.well-known/matrix/client"));return i&&i.action===c.SUCCESS?d.fromDiscoveryConfig(i.raw):(o.v.error("No response or error when parsing .well-known"),i.reason&&o.v.error(i.reason),i.action===c.IGNORE?r["m.homeserver"]={state:d.PROMPT,error:null,base_url:null}:(r["m.homeserver"].state=d.FAIL_PROMPT,r["m.homeserver"].error=d.ERROR_INVALID),Promise.resolve(r))}))()}static getRawClientConfig(e){var t=this;return(0,n.A)((function*(){var r;if(!e||"string"!==typeof e||0===e.length)throw new Error("'domain' must be a string of non-zero length");var n=yield t.fetchWellKnownObject("https://".concat(e,"/.well-known/matrix/client"));return n&&null!==(r=n.raw)&&void 0!==r?r:{}}))()}static sanitizeWellKnownUrl(e){if(!e)return!1;try{var t,r;try{r=new URL(e)}catch(a){o.v.error("Could not parse url",a)}if(null===(t=r)||void 0===t||!t.hostname)return!1;if("http:"!==r.protocol&&"https:"!==r.protocol)return!1;var n=r.port?":".concat(r.port):"",i=r.pathname?r.pathname:"",s="".concat(r.protocol,"//").concat(r.hostname).concat(n).concat(i);return s.endsWith("/")&&(s=s.substring(0,s.length-1)),s}catch(a){return o.v.error(a),!1}}static fetch(e,t){return this.fetchFn?this.fetchFn(e,t):globalThis.fetch(e,t)}static setFetchFn(e){d.fetchFn=e}static fetchWellKnownObject(e){return(0,n.A)((function*(){var t;try{if(t=yield d.fetch(e,{method:s.IT.Get,signal:(0,s._)(5e3)}),404===t.status)return{raw:{},action:c.IGNORE,reason:d.ERROR_MISSING_WELLKNOWN};if(!t.ok)return{raw:{},action:c.FAIL_PROMPT,reason:"General failure"}}catch(o){var r=o,n="";return"object"===typeof r&&(n=null===r||void 0===r?void 0:r.message),{error:r,raw:{},action:c.FAIL_PROMPT,reason:n||"General failure"}}try{return{raw:yield t.json(),action:c.SUCCESS}}catch(o){var i=o;return{error:i,raw:{},action:c.FAIL_PROMPT,reason:"SyntaxError"===(null===i||void 0===i?void 0:i.name)?d.ERROR_INVALID_JSON:d.ERROR_INVALID}}}))()}}(0,i.A)(d,"ERROR_INVALID",l.Invalid),(0,i.A)(d,"ERROR_GENERIC_FAILURE",l.GenericFailure),(0,i.A)(d,"ERROR_INVALID_HS_BASE_URL",l.InvalidHsBaseUrl),(0,i.A)(d,"ERROR_INVALID_HOMESERVER",l.InvalidHomeserver),(0,i.A)(d,"ERROR_INVALID_IS_BASE_URL",l.InvalidIsBaseUrl),(0,i.A)(d,"ERROR_INVALID_IDENTITY_SERVER",l.InvalidIdentityServer),(0,i.A)(d,"ERROR_INVALID_IS",l.InvalidIs),(0,i.A)(d,"ERROR_MISSING_WELLKNOWN",l.MissingWellknown),(0,i.A)(d,"ERROR_INVALID_JSON",l.InvalidJson),(0,i.A)(d,"ERROR_UNSUPPORTED_HOMESERVER_SPEC_VERSION",l.UnsupportedHomeserverSpecVersion),(0,i.A)(d,"ALL_ERRORS",Object.keys(l)),(0,i.A)(d,"FAIL_ERROR",c.FAIL_ERROR),(0,i.A)(d,"FAIL_PROMPT",c.FAIL_PROMPT),(0,i.A)(d,"PROMPT",c.PROMPT),(0,i.A)(d,"SUCCESS",c.SUCCESS),(0,i.A)(d,"fetchFn",void 0)},5370:function(e,t,r){"use strict";var n=r(6198);e.exports=function(e,t,r){var i=0,o=arguments.length>2?r:n(t),s=new e(o);while(o>i)s[i]=t[i++];return s}},5397:function(e,t,r){"use strict";var n=r(7055),i=r(7750);e.exports=function(e){return n(i(e))}},5462:function(e,t,r){"use strict";r.d(t,{K:function(){return i},Q:function(){return o}});var n=r(4761);class i{constructor(e){this.target=e,(0,n.A)(this,"reEmitters",new WeakMap)}reEmit(e,t){var r=this,n=this.reEmitters.get(e);n||(n=new Map,this.reEmitters.set(e,n));var i=function(t){if(n.has(t))return 1;var i=function(){if("error"!==t||0!==r.target.listenerCount("error")){for(var n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];r.target.emit(t,...i,e)}};e.on(t,i),n.set(t,i)};for(var o of t)i(o)}stopReEmitting(e,t){var r=this.reEmitters.get(e);if(r){for(var n of t)e.off(n,r.get(n)),r.delete(n);0===r.size&&this.reEmitters.delete(e)}}}class o extends i{constructor(e){super(e)}reEmit(e,t){super.reEmit(e,t)}stopReEmitting(e,t){super.stopReEmitting(e,t)}}},5471:function(e,t,r){"use strict";r(8111),r(7588),Object.defineProperty(t,"__esModule",{value:!0});var n=r(1575);Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))}));var i=r(6218);Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}));var o=r(3378);Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var s=r(7223);Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=r(1954);Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=r(7326);Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var l=r(8098);Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var d=r(6819);Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var u=r(8614);Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var h=r(6960);Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var v=r(6327);Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var p=r(5564);Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var f=r(9523);Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var g=r(5030);Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var m=r(8687);Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var y=r(8848);Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var S=r(650);Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var b=r(8010);Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var E=r(5728);Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var _=r(4579);Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var w=r(6331);Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}));var I=r(4501);Object.keys(I).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===I[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return I[e]}}))}));var T=r(6694);Object.keys(T).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===T[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return T[e]}}))}))},5499:function(e,t){"use strict";function r(e){return n(e)&&"string"===typeof e}function n(e){return null!==e&&void 0!==e}Object.defineProperty(t,"__esModule",{value:!0}),t.isOptionalAString=r,t.isProvided=n},5555:function(e,t,r){r(8111),r(7588);var n=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),t+=null!=e["network-id"]?" network-id %d":"%v",t+=null!=e["network-cost"]?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",t+=null!=e.rateNumerator?" rate=%s":"",t+=null!=e.rateDenominator?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(n).forEach((function(e){var t=n[e];t.forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))},5564:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetKind=void 0;var r=function(e){return e["Room"]="room",e["Account"]="account",e["Modal"]="modal",e}({});t.WidgetKind=r},5610:function(e,t,r){"use strict";var n=r(1291),i=Math.max,o=Math.min;e.exports=function(e,t){var r=n(e);return r<0?i(r+t,0):o(r,t)}},5629:function(e,t,r){"use strict";r.d(t,{Bx:function(){return i},CJ:function(){return c},Ct:function(){return a},D7:function(){return d},ID:function(){return v},Ng:function(){return m},SY:function(){return w},Sr:function(){return _},VT:function(){return b},Wr:function(){return s},Xs:function(){return E},Yg:function(){return y},Z3:function(){return g},cr:function(){return S},ge:function(){return f},iK:function(){return p},nN:function(){return h},ud:function(){return u},wt:function(){return l},zZ:function(){return o}});var n=r(4229),i=(r(7621),r(7419),r(6337),function(e){return e["RoomCanonicalAlias"]="m.room.canonical_alias",e["RoomCreate"]="m.room.create",e["RoomJoinRules"]="m.room.join_rules",e["RoomMember"]="m.room.member",e["RoomThirdPartyInvite"]="m.room.third_party_invite",e["RoomPowerLevels"]="m.room.power_levels",e["RoomName"]="m.room.name",e["RoomTopic"]="m.room.topic",e["RoomAvatar"]="m.room.avatar",e["RoomPinnedEvents"]="m.room.pinned_events",e["RoomEncryption"]="m.room.encryption",e["RoomHistoryVisibility"]="m.room.history_visibility",e["RoomGuestAccess"]="m.room.guest_access",e["RoomServerAcl"]="m.room.server_acl",e["RoomTombstone"]="m.room.tombstone",e["RoomPredecessor"]="org.matrix.msc3946.room_predecessor",e["PolicyRuleUser"]="m.policy.rule.user",e["PolicyRuleRoom"]="m.policy.rule.room",e["PolicyRuleServer"]="m.policy.rule.server",e["SpaceChild"]="m.space.child",e["SpaceParent"]="m.space.parent",e["RoomRedaction"]="m.room.redaction",e["RoomMessage"]="m.room.message",e["RoomMessageEncrypted"]="m.room.encrypted",e["Sticker"]="m.sticker",e["CallInvite"]="m.call.invite",e["CallCandidates"]="m.call.candidates",e["CallAnswer"]="m.call.answer",e["CallHangup"]="m.call.hangup",e["CallReject"]="m.call.reject",e["CallSelectAnswer"]="m.call.select_answer",e["CallNegotiate"]="m.call.negotiate",e["CallSDPStreamMetadataChanged"]="m.call.sdp_stream_metadata_changed",e["CallSDPStreamMetadataChangedPrefix"]="org.matrix.call.sdp_stream_metadata_changed",e["CallReplaces"]="m.call.replaces",e["CallAssertedIdentity"]="m.call.asserted_identity",e["CallAssertedIdentityPrefix"]="org.matrix.call.asserted_identity",e["CallEncryptionKeysPrefix"]="io.element.call.encryption_keys",e["KeyVerificationRequest"]="m.key.verification.request",e["KeyVerificationStart"]="m.key.verification.start",e["KeyVerificationCancel"]="m.key.verification.cancel",e["KeyVerificationMac"]="m.key.verification.mac",e["KeyVerificationDone"]="m.key.verification.done",e["KeyVerificationKey"]="m.key.verification.key",e["KeyVerificationAccept"]="m.key.verification.accept",e["KeyVerificationReady"]="m.key.verification.ready",e["RoomMessageFeedback"]="m.room.message.feedback",e["Reaction"]="m.reaction",e["PollStart"]="org.matrix.msc3381.poll.start",e["Typing"]="m.typing",e["Receipt"]="m.receipt",e["Presence"]="m.presence",e["FullyRead"]="m.fully_read",e["Tag"]="m.tag",e["SpaceOrder"]="org.matrix.msc3230.space_order",e["PushRules"]="m.push_rules",e["Direct"]="m.direct",e["IgnoredUserList"]="m.ignored_user_list",e["RoomKey"]="m.room_key",e["RoomKeyRequest"]="m.room_key_request",e["ForwardedRoomKey"]="m.forwarded_room_key",e["Dummy"]="m.dummy",e["GroupCallPrefix"]="org.matrix.msc3401.call",e["GroupCallMemberPrefix"]="org.matrix.msc3401.call.member",e["CallNotify"]="org.matrix.msc4075.call.notify",e}({})),o=function(e){return e["Annotation"]="m.annotation",e["Replace"]="m.replace",e["Reference"]="m.reference",e["Thread"]="m.thread",e}({}),s=function(e){return e["Text"]="m.text",e["Emote"]="m.emote",e["Notice"]="m.notice",e["Image"]="m.image",e["File"]="m.file",e["Audio"]="m.audio",e["Location"]="m.location",e["Video"]="m.video",e["KeyVerificationRequest"]="m.key.verification.request",e}({}),a="type",c=function(e){return e["Space"]="m.space",e["UnstableCall"]="org.matrix.msc3417.call",e["ElementVideo"]="io.element.video",e}({}),l="org.matrix.msgid",d=new n.qr("m.room.purpose","org.matrix.msc3088.purpose"),u=new n.qr("m.enabled","org.matrix.msc3088.enabled"),h=new n.qr("m.data_tree","org.matrix.msc3089.data_tree"),v=new n.qr("m.leaf","org.matrix.msc3089.leaf"),p=new n.qr("m.branch","org.matrix.msc3089.branch"),f=new n.qr("m.room.marker","org.matrix.msc2716.marker"),g=new n.qr("with_rel_types","org.matrix.msc3912.with_relations"),m=new n.qr("io.element.functional_members","io.element.functional_members"),y=new n.qr("m.visibility","org.matrix.msc3531.visibility"),S=new n.qr("enabled","org.matrix.msc3881.enabled"),b=new n.qr("device_id","org.matrix.msc3881.device_id"),E=new n.qr("m.local_notification_settings","org.matrix.msc3890.local_notification_settings"),_=new n.qr("thread_id","org.matrix.msc4023.thread_id"),w=new n.xu("membership","io.element.msc4115.membership")},5636:function(e,t,r){"use strict";var n=r(4576),i=r(9504),o=r(6706),s=r(7696),a=r(5169),c=r(7394),l=r(4483),d=r(1548),u=n.structuredClone,h=n.ArrayBuffer,v=n.DataView,p=Math.min,f=h.prototype,g=v.prototype,m=i(f.slice),y=o(f,"resizable","get"),S=o(f,"maxByteLength","get"),b=i(g.getInt8),E=i(g.setInt8);e.exports=(d||l)&&function(e,t,r){var n,i=c(e),o=void 0===t?i:s(t),f=!y||!y(e);if(a(e),d&&(e=u(e,{transfer:[e]}),i===o&&(r||f)))return e;if(i>=o&&(!r||f))n=m(e,0,o);else{var g=r&&!f&&S?{maxByteLength:S(e)}:void 0;n=new h(o,g);for(var _=new v(e),w=new v(n),I=p(o,i),T=0;T<I;T++)E(w,T,b(_,T))}return d||l(e),n}},5670:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMMessage=a;var n=r(4477),i=r(1711),o=r(1396),s=r(1550);function a(e){return i.M_EMOTE.matches(e.type)?new o.EmoteEvent(e):i.M_NOTICE.matches(e.type)?new s.NoticeEvent(e):new n.MessageEvent(e)}},5677:function(e,t,r){"use strict";r.d(t,{s:function(){return i}});var n=r(4229),i=new n.qr("m.topic","org.matrix.msc3765.topic")},5728:function(e,t,r){"use strict";r(4603),r(7566),r(8721),Object.defineProperty(t,"__esModule",{value:!0}),t.Widget=void 0;var n=r(8010),i=r(5471);function o(e){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o(e)}function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,l(n.key),n)}}function c(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e){var t=d(e,"string");return"symbol"===o(t)?t:String(t)}function d(e,t){if("object"!==o(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==o(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var u=function(){function e(t){if(s(this,e),this.definition=t,!this.definition)throw new Error("Definition is required");(0,n.assertPresent)(t,"id"),(0,n.assertPresent)(t,"creatorUserId"),(0,n.assertPresent)(t,"type"),(0,n.assertPresent)(t,"url")}return c(e,[{key:"creatorUserId",get:function(){return this.definition.creatorUserId}},{key:"type",get:function(){return this.definition.type}},{key:"id",get:function(){return this.definition.id}},{key:"name",get:function(){return this.definition.name||null}},{key:"title",get:function(){return this.rawData.title||null}},{key:"templateUrl",get:function(){return this.definition.url}},{key:"origin",get:function(){return new URL(this.templateUrl).origin}},{key:"waitForIframeLoad",get:function(){return!1!==this.definition.waitForIframeLoad&&(this.definition.waitForIframeLoad,!0)}},{key:"rawData",get:function(){return this.definition.data||{}}},{key:"getCompleteUrl",value:function(e){return(0,i.runTemplate)(this.templateUrl,this.definition,e)}}]),e}();t.Widget=u},5745:function(e,t,r){"use strict";var n=r(7629);e.exports=function(e,t){return n[e]||(n[e]=t||{})}},5854:function(e,t,r){"use strict";var n=r(2777),i=TypeError;e.exports=function(e){var t=n(e,"number");if("number"==typeof t)throw new i("Can't convert number to bigint");return BigInt(t)}},5876:function(e,t,r){"use strict";var n=r(6518),i=r(3838),o=r(4916),s=!o("isSubsetOf",(function(e){return e}));n({target:"Set",proto:!0,real:!0,forced:s},{isSubsetOf:i})},5917:function(e,t,r){"use strict";var n=r(3724),i=r(9039),o=r(4055);e.exports=!n&&!i((function(){return 7!==Object.defineProperty(o("div"),"a",{get:function(){return 7}}).a}))},5942:function(e,t,r){"use strict";r.d(t,{V:function(){return n}});r(3877);var n=function(e){return e["Sas"]="m.sas.v1",e["ShowQrCode"]="m.qr_code.show.v1",e["ScanQrCode"]="m.qr_code.scan.v1",e["Reciprocate"]="m.reciprocate.v1",e}({})},5966:function(e,t,r){"use strict";var n=r(9306),i=r(4117);e.exports=function(e,t){var r=e[t];return i(r)?void 0:n(r)}},5976:function(e,t,r){"use strict";r.d(t,{$u:function(){return oe},CE:function(){return Jt},Df:function(){return j},EW:function(){return xr},FK:function(){return Nt},Gt:function(){return qe},Gy:function(){return U},K9:function(){return dt},Lk:function(){return er},MZ:function(){return F},OW:function(){return K},Q3:function(){return sr},QP:function(){return N},WQ:function(){return Ve},Wv:function(){return zt},bF:function(){return tr},bo:function(){return C},dY:function(){return g},eW:function(){return or},g2:function(){return ve},h:function(){return Ur},nI:function(){return gr},pI:function(){return me},pM:function(){return q},qL:function(){return s},sV:function(){return ne},uX:function(){return Vt},wB:function(){return Et}});r(4114),r(8111),r(1148),r(2489),r(7588),r(1701),r(8237),r(3579),r(9479),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(2040),i=r(160);function o(e,t,r,n){try{return n?e(...n):e()}catch(i){a(i,t,r)}}function s(e,t,r,n){if((0,i.Tn)(e)){const s=o(e,t,r,n);return s&&(0,i.yL)(s)&&s.catch((e=>{a(e,t,r)})),s}if((0,i.cy)(e)){const i=[];for(let o=0;o<e.length;o++)i.push(s(e[o],t,r,n));return i}}function a(e,t,r,s=!0){const a=t?t.vnode:null,{errorHandler:l,throwUnhandledErrorInProduction:d}=t&&t.appContext.config||i.MZ;if(t){let i=t.parent;const s=t.proxy,a=`https://vuejs.org/error-reference/#runtime-${r}`;while(i){const t=i.ec;if(t)for(let r=0;r<t.length;r++)if(!1===t[r](e,s,a))return;i=i.parent}if(l)return(0,n.C4)(),o(l,null,10,[e,s,a]),void(0,n.bl)()}c(e,r,a,s,d)}function c(e,t,r,n=!0,i=!1){if(i)throw e;console.error(e)}const l=[];let d=-1;const u=[];let h=null,v=0;const p=Promise.resolve();let f=null;function g(e){const t=f||p;return e?t.then(this?e.bind(this):e):t}function m(e){let t=d+1,r=l.length;while(t<r){const n=t+r>>>1,i=l[n],o=w(i);o<e||o===e&&2&i.flags?t=n+1:r=n}return t}function y(e){if(!(1&e.flags)){const t=w(e),r=l[l.length-1];!r||!(2&e.flags)&&t>=w(r)?l.push(e):l.splice(m(t),0,e),e.flags|=1,S()}}function S(){f||(f=p.then(I))}function b(e){(0,i.cy)(e)?u.push(...e):h&&-1===e.id?h.splice(v+1,0,e):1&e.flags||(u.push(e),e.flags|=1),S()}function E(e,t,r=d+1){for(0;r<l.length;r++){const t=l[r];if(t&&2&t.flags){if(e&&t.id!==e.uid)continue;0,l.splice(r,1),r--,4&t.flags&&(t.flags&=-2),t(),4&t.flags||(t.flags&=-2)}}}function _(e){if(u.length){const e=[...new Set(u)].sort(((e,t)=>w(e)-w(t)));if(u.length=0,h)return void h.push(...e);for(h=e,v=0;v<h.length;v++){const e=h[v];0,4&e.flags&&(e.flags&=-2),8&e.flags||e(),e.flags&=-2}h=null,v=0}}const w=e=>null==e.id?2&e.flags?-1:1/0:e.id;function I(e){i.tE;try{for(d=0;d<l.length;d++){const e=l[d];!e||8&e.flags||(4&e.flags&&(e.flags&=-2),o(e,e.i,e.i?15:14),4&e.flags||(e.flags&=-2))}}finally{for(;d<l.length;d++){const e=l[d];e&&(e.flags&=-2)}d=-1,l.length=0,_(e),f=null,(l.length||u.length)&&I(e)}}let T=null,R=null;function k(e){const t=T;return T=e,R=e&&e.type.__scopeId||null,t}function A(e,t=T,r){if(!t)return e;if(e._n)return e;const n=(...r)=>{n._d&&Ht(-1);const i=k(t);let o;try{o=e(...r)}finally{k(i),n._d&&Ht(1)}return o};return n._n=!0,n._c=!0,n._d=!0,n}function C(e,t){if(null===T)return e;const r=Dr(T),o=e.dirs||(e.dirs=[]);for(let s=0;s<t.length;s++){let[e,a,c,l=i.MZ]=t[s];e&&((0,i.Tn)(e)&&(e={mounted:e,updated:e}),e.deep&&(0,n.hV)(a),o.push({dir:e,instance:r,value:a,oldValue:void 0,arg:c,modifiers:l}))}return e}function O(e,t,r,i){const o=e.dirs,a=t&&t.dirs;for(let c=0;c<o.length;c++){const l=o[c];a&&(l.oldValue=a[c].value);let d=l.dir[i];d&&((0,n.C4)(),s(d,r,8,[e.el,l,e,t]),(0,n.bl)())}}const D=Symbol("_vte"),M=e=>e.__isTeleport;const P=Symbol("_leaveCb"),x=Symbol("_enterCb");function U(){const e={isMounted:!1,isLeaving:!1,isUnmounting:!1,leavingVNodes:new Map};return ne((()=>{e.isMounted=!0})),se((()=>{e.isUnmounting=!0})),e}const L=[Function,Array],N={mode:String,appear:Boolean,persisted:Boolean,onBeforeEnter:L,onEnter:L,onAfterEnter:L,onEnterCancelled:L,onBeforeLeave:L,onLeave:L,onAfterLeave:L,onLeaveCancelled:L,onBeforeAppear:L,onAppear:L,onAfterAppear:L,onAppearCancelled:L};function B(e,t){const{leavingVNodes:r}=e;let n=r.get(t.type);return n||(n=Object.create(null),r.set(t.type,n)),n}function K(e,t,r,n,o){const{appear:a,mode:c,persisted:l=!1,onBeforeEnter:d,onEnter:u,onAfterEnter:h,onEnterCancelled:v,onBeforeLeave:p,onLeave:f,onAfterLeave:g,onLeaveCancelled:m,onBeforeAppear:y,onAppear:S,onAfterAppear:b,onAppearCancelled:E}=t,_=String(e.key),w=B(r,e),I=(e,t)=>{e&&s(e,n,9,t)},T=(e,t)=>{const r=t[1];I(e,t),(0,i.cy)(e)?e.every((e=>e.length<=1))&&r():e.length<=1&&r()},R={mode:c,persisted:l,beforeEnter(t){let n=d;if(!r.isMounted){if(!a)return;n=y||d}t[P]&&t[P](!0);const i=w[_];i&&Qt(e,i)&&i.el[P]&&i.el[P](),I(n,[t])},enter(e){let t=u,n=h,i=v;if(!r.isMounted){if(!a)return;t=S||u,n=b||h,i=E||v}let o=!1;const s=e[x]=t=>{o||(o=!0,I(t?i:n,[e]),R.delayedLeave&&R.delayedLeave(),e[x]=void 0)};t?T(t,[e,s]):s()},leave(t,n){const i=String(e.key);if(t[x]&&t[x](!0),r.isUnmounting)return n();I(p,[t]);let o=!1;const s=t[P]=r=>{o||(o=!0,n(),I(r?m:g,[t]),t[P]=void 0,w[i]===e&&delete w[i])};w[i]=e,f?T(f,[t,s]):s()},clone(e){const i=K(e,t,r,n,o);return o&&o(i),i}};return R}function F(e,t){6&e.shapeFlag&&e.component?(e.transition=t,F(e.component.subTree,t)):128&e.shapeFlag?(e.ssContent.transition=t.clone(e.ssContent),e.ssFallback.transition=t.clone(e.ssFallback)):e.transition=t}function j(e,t=!1,r){let n=[],i=0;for(let o=0;o<e.length;o++){let s=e[o];const a=null==r?s.key:String(r)+String(null!=s.key?s.key:o);s.type===Nt?(128&s.patchFlag&&i++,n=n.concat(j(s.children,t,a))):(t||s.type!==Kt)&&n.push(null!=a?ir(s,{key:a}):s)}if(i>1)for(let o=0;o<n.length;o++)n[o].patchFlag=-2;return n}
/*! #__NO_SIDE_EFFECTS__ */function q(e,t){return(0,i.Tn)(e)?(()=>(0,i.X$)({name:e.name},t,{setup:e}))():e}function V(e){e.ids=[e.ids[0]+e.ids[2]+++"-",0,0]}function G(e,t,r,s,a=!1){if((0,i.cy)(e))return void e.forEach(((e,n)=>G(e,t&&((0,i.cy)(t)?t[n]:t),r,s,a)));if(W(s)&&!a)return void(512&s.shapeFlag&&s.type.__asyncResolved&&s.component.subTree.component&&G(e,t,r,s.component.subTree));const c=4&s.shapeFlag?Dr(s.component):s.el,l=a?null:c,{i:d,r:u}=e;const h=t&&t.r,v=d.refs===i.MZ?d.refs={}:d.refs,p=d.setupState,f=(0,n.ux)(p),g=p===i.MZ?()=>!1:e=>(0,i.$3)(f,e);if(null!=h&&h!==u&&((0,i.Kg)(h)?(v[h]=null,g(h)&&(p[h]=null)):(0,n.i9)(h)&&(h.value=null)),(0,i.Tn)(u))o(u,d,12,[l,v]);else{const t=(0,i.Kg)(u),o=(0,n.i9)(u);if(t||o){const n=()=>{if(e.f){const r=t?g(u)?p[u]:v[u]:u.value;a?(0,i.cy)(r)&&(0,i.TF)(r,c):(0,i.cy)(r)?r.includes(c)||r.push(c):t?(v[u]=[c],g(u)&&(p[u]=v[u])):(u.value=[c],e.k&&(v[e.k]=u.value))}else t?(v[u]=l,g(u)&&(p[u]=l)):o&&(u.value=l,e.k&&(v[e.k]=l))};l?(n.id=-1,lt(n,r)):n()}else 0}}(0,i.We)().requestIdleCallback,(0,i.We)().cancelIdleCallback;const W=e=>!!e.type.__asyncLoader
/*! #__NO_SIDE_EFFECTS__ */;const H=e=>e.type.__isKeepAlive;RegExp,RegExp;function $(e,t){return(0,i.cy)(e)?e.some((e=>$(e,t))):(0,i.Kg)(e)?e.split(",").includes(t):!!(0,i.gd)(e)&&(e.lastIndex=0,e.test(t))}function J(e,t){Y(e,"a",t)}function z(e,t){Y(e,"da",t)}function Y(e,t,r=fr){const n=e.__wdc||(e.__wdc=()=>{let t=r;while(t){if(t.isDeactivated)return;t=t.parent}return e()});if(ee(t,n,r),r){let e=r.parent;while(e&&e.parent)H(e.parent.vnode)&&Q(n,t,r,e),e=e.parent}}function Q(e,t,r,n){const o=ee(t,e,n,!0);ae((()=>{(0,i.TF)(n[t],o)}),r)}function X(e){e.shapeFlag&=-257,e.shapeFlag&=-513}function Z(e){return 128&e.shapeFlag?e.ssContent:e}function ee(e,t,r=fr,i=!1){if(r){const o=r[e]||(r[e]=[]),a=t.__weh||(t.__weh=(...i)=>{(0,n.C4)();const o=Sr(r),a=s(t,r,e,i);return o(),(0,n.bl)(),a});return i?o.unshift(a):o.push(a),a}}const te=e=>(t,r=fr)=>{Ir&&"sp"!==e||ee(e,((...e)=>t(...e)),r)},re=te("bm"),ne=te("m"),ie=te("bu"),oe=te("u"),se=te("bum"),ae=te("um"),ce=te("sp"),le=te("rtg"),de=te("rtc");function ue(e,t=fr){ee("ec",e,t)}const he="components";function ve(e,t){return fe(he,e,!0,t)||e}const pe=Symbol.for("v-ndc");function fe(e,t,r=!0,n=!1){const o=T||fr;if(o){const r=o.type;if(e===he){const e=Mr(r,!1);if(e&&(e===t||e===(0,i.PT)(t)||e===(0,i.ZH)((0,i.PT)(t))))return r}const s=ge(o[e]||r[e],t)||ge(o.appContext[e],t);return!s&&n?r:s}}function ge(e,t){return e&&(e[t]||e[(0,i.PT)(t)]||e[(0,i.ZH)((0,i.PT)(t))])}function me(e,t,r,o){let s;const a=r&&r[o],c=(0,i.cy)(e);if(c||(0,i.Kg)(e)){const r=c&&(0,n.g8)(e);let i=!1;r&&(i=!(0,n.fE)(e),e=(0,n.qA)(e)),s=new Array(e.length);for(let o=0,c=e.length;o<c;o++)s[o]=t(i?(0,n.lJ)(e[o]):e[o],o,void 0,a&&a[o])}else if("number"===typeof e){0,s=new Array(e);for(let r=0;r<e;r++)s[r]=t(r+1,r,void 0,a&&a[r])}else if((0,i.Gv)(e))if(e[Symbol.iterator])s=Array.from(e,((e,r)=>t(e,r,void 0,a&&a[r])));else{const r=Object.keys(e);s=new Array(r.length);for(let n=0,i=r.length;n<i;n++){const i=r[n];s[n]=t(e[i],i,n,a&&a[n])}}else s=[];return r&&(r[o]=s),s}const ye=e=>e?Er(e)?Dr(e):ye(e.parent):null,Se=(0,i.X$)(Object.create(null),{$:e=>e,$el:e=>e.vnode.el,$data:e=>e.data,$props:e=>e.props,$attrs:e=>e.attrs,$slots:e=>e.slots,$refs:e=>e.refs,$parent:e=>ye(e.parent),$root:e=>ye(e.root),$host:e=>e.ce,$emit:e=>e.emit,$options:e=>Ae(e),$forceUpdate:e=>e.f||(e.f=()=>{y(e.update)}),$nextTick:e=>e.n||(e.n=g.bind(e.proxy)),$watch:e=>wt.bind(e)}),be=(e,t)=>e!==i.MZ&&!e.__isScriptSetup&&(0,i.$3)(e,t),Ee={get({_:e},t){if("__v_skip"===t)return!0;const{ctx:r,setupState:o,data:s,props:a,accessCache:c,type:l,appContext:d}=e;let u;if("$"!==t[0]){const n=c[t];if(void 0!==n)switch(n){case 1:return o[t];case 2:return s[t];case 4:return r[t];case 3:return a[t]}else{if(be(o,t))return c[t]=1,o[t];if(s!==i.MZ&&(0,i.$3)(s,t))return c[t]=2,s[t];if((u=e.propsOptions[0])&&(0,i.$3)(u,t))return c[t]=3,a[t];if(r!==i.MZ&&(0,i.$3)(r,t))return c[t]=4,r[t];we&&(c[t]=0)}}const h=Se[t];let v,p;return h?("$attrs"===t&&(0,n.u4)(e.attrs,"get",""),h(e)):(v=l.__cssModules)&&(v=v[t])?v:r!==i.MZ&&(0,i.$3)(r,t)?(c[t]=4,r[t]):(p=d.config.globalProperties,(0,i.$3)(p,t)?p[t]:void 0)},set({_:e},t,r){const{data:n,setupState:o,ctx:s}=e;return be(o,t)?(o[t]=r,!0):n!==i.MZ&&(0,i.$3)(n,t)?(n[t]=r,!0):!(0,i.$3)(e.props,t)&&(("$"!==t[0]||!(t.slice(1)in e))&&(s[t]=r,!0))},has({_:{data:e,setupState:t,accessCache:r,ctx:n,appContext:o,propsOptions:s}},a){let c;return!!r[a]||e!==i.MZ&&(0,i.$3)(e,a)||be(t,a)||(c=s[0])&&(0,i.$3)(c,a)||(0,i.$3)(n,a)||(0,i.$3)(Se,a)||(0,i.$3)(o.config.globalProperties,a)},defineProperty(e,t,r){return null!=r.get?e._.accessCache[t]=0:(0,i.$3)(r,"value")&&this.set(e,t,r.value,null),Reflect.defineProperty(e,t,r)}};function _e(e){return(0,i.cy)(e)?e.reduce(((e,t)=>(e[t]=null,e)),{}):e}let we=!0;function Ie(e){const t=Ae(e),r=e.proxy,o=e.ctx;we=!1,t.beforeCreate&&Re(t.beforeCreate,e,"bc");const{data:s,computed:a,methods:c,watch:l,provide:d,inject:u,created:h,beforeMount:v,mounted:p,beforeUpdate:f,updated:g,activated:m,deactivated:y,beforeDestroy:S,beforeUnmount:b,destroyed:E,unmounted:_,render:w,renderTracked:I,renderTriggered:T,errorCaptured:R,serverPrefetch:k,expose:A,inheritAttrs:C,components:O,directives:D,filters:M}=t,P=null;if(u&&Te(u,o,P),c)for(const n in c){const e=c[n];(0,i.Tn)(e)&&(o[n]=e.bind(r))}if(s){0;const t=s.call(r,r);0,(0,i.Gv)(t)&&(e.data=(0,n.Kh)(t))}if(we=!0,a)for(const n in a){const e=a[n],t=(0,i.Tn)(e)?e.bind(r,r):(0,i.Tn)(e.get)?e.get.bind(r,r):i.tE;0;const s=!(0,i.Tn)(e)&&(0,i.Tn)(e.set)?e.set.bind(r):i.tE,c=xr({get:t,set:s});Object.defineProperty(o,n,{enumerable:!0,configurable:!0,get:()=>c.value,set:e=>c.value=e})}if(l)for(const n in l)ke(l[n],o,r,n);if(d){const e=(0,i.Tn)(d)?d.call(r):d;Reflect.ownKeys(e).forEach((t=>{qe(t,e[t])}))}function x(e,t){(0,i.cy)(t)?t.forEach((t=>e(t.bind(r)))):t&&e(t.bind(r))}if(h&&Re(h,e,"c"),x(re,v),x(ne,p),x(ie,f),x(oe,g),x(J,m),x(z,y),x(ue,R),x(de,I),x(le,T),x(se,b),x(ae,_),x(ce,k),(0,i.cy)(A))if(A.length){const t=e.exposed||(e.exposed={});A.forEach((e=>{Object.defineProperty(t,e,{get:()=>r[e],set:t=>r[e]=t})}))}else e.exposed||(e.exposed={});w&&e.render===i.tE&&(e.render=w),null!=C&&(e.inheritAttrs=C),O&&(e.components=O),D&&(e.directives=D),k&&V(e)}function Te(e,t,r=i.tE){(0,i.cy)(e)&&(e=Pe(e));for(const o in e){const r=e[o];let s;s=(0,i.Gv)(r)?"default"in r?Ve(r.from||o,r.default,!0):Ve(r.from||o):Ve(r),(0,n.i9)(s)?Object.defineProperty(t,o,{enumerable:!0,configurable:!0,get:()=>s.value,set:e=>s.value=e}):t[o]=s}}function Re(e,t,r){s((0,i.cy)(e)?e.map((e=>e.bind(t.proxy))):e.bind(t.proxy),t,r)}function ke(e,t,r,n){let o=n.includes(".")?It(r,n):()=>r[n];if((0,i.Kg)(e)){const r=t[e];(0,i.Tn)(r)&&Et(o,r)}else if((0,i.Tn)(e))Et(o,e.bind(r));else if((0,i.Gv)(e))if((0,i.cy)(e))e.forEach((e=>ke(e,t,r,n)));else{const n=(0,i.Tn)(e.handler)?e.handler.bind(r):t[e.handler];(0,i.Tn)(n)&&Et(o,n,e)}else 0}function Ae(e){const t=e.type,{mixins:r,extends:n}=t,{mixins:o,optionsCache:s,config:{optionMergeStrategies:a}}=e.appContext,c=s.get(t);let l;return c?l=c:o.length||r||n?(l={},o.length&&o.forEach((e=>Ce(l,e,a,!0))),Ce(l,t,a)):l=t,(0,i.Gv)(t)&&s.set(t,l),l}function Ce(e,t,r,n=!1){const{mixins:i,extends:o}=t;o&&Ce(e,o,r,!0),i&&i.forEach((t=>Ce(e,t,r,!0)));for(const s in t)if(n&&"expose"===s);else{const n=Oe[s]||r&&r[s];e[s]=n?n(e[s],t[s]):t[s]}return e}const Oe={data:De,props:Le,emits:Le,methods:Ue,computed:Ue,beforeCreate:xe,created:xe,beforeMount:xe,mounted:xe,beforeUpdate:xe,updated:xe,beforeDestroy:xe,beforeUnmount:xe,destroyed:xe,unmounted:xe,activated:xe,deactivated:xe,errorCaptured:xe,serverPrefetch:xe,components:Ue,directives:Ue,watch:Ne,provide:De,inject:Me};function De(e,t){return t?e?function(){return(0,i.X$)((0,i.Tn)(e)?e.call(this,this):e,(0,i.Tn)(t)?t.call(this,this):t)}:t:e}function Me(e,t){return Ue(Pe(e),Pe(t))}function Pe(e){if((0,i.cy)(e)){const t={};for(let r=0;r<e.length;r++)t[e[r]]=e[r];return t}return e}function xe(e,t){return e?[...new Set([].concat(e,t))]:t}function Ue(e,t){return e?(0,i.X$)(Object.create(null),e,t):t}function Le(e,t){return e?(0,i.cy)(e)&&(0,i.cy)(t)?[...new Set([...e,...t])]:(0,i.X$)(Object.create(null),_e(e),_e(null!=t?t:{})):t}function Ne(e,t){if(!e)return t;if(!t)return e;const r=(0,i.X$)(Object.create(null),e);for(const n in t)r[n]=xe(e[n],t[n]);return r}function Be(){return{app:null,config:{isNativeTag:i.NO,performance:!1,globalProperties:{},optionMergeStrategies:{},errorHandler:void 0,warnHandler:void 0,compilerOptions:{}},mixins:[],components:{},directives:{},provides:Object.create(null),optionsCache:new WeakMap,propsCache:new WeakMap,emitsCache:new WeakMap}}let Ke=0;function Fe(e,t){return function(r,n=null){(0,i.Tn)(r)||(r=(0,i.X$)({},r)),null==n||(0,i.Gv)(n)||(n=null);const o=Be(),a=new WeakSet,c=[];let l=!1;const d=o.app={_uid:Ke++,_component:r,_props:n,_container:null,_context:o,_instance:null,version:Lr,get config(){return o.config},set config(e){0},use(e,...t){return a.has(e)||(e&&(0,i.Tn)(e.install)?(a.add(e),e.install(d,...t)):(0,i.Tn)(e)&&(a.add(e),e(d,...t))),d},mixin(e){return o.mixins.includes(e)||o.mixins.push(e),d},component(e,t){return t?(o.components[e]=t,d):o.components[e]},directive(e,t){return t?(o.directives[e]=t,d):o.directives[e]},mount(i,s,a){if(!l){0;const c=d._ceVNode||tr(r,n);return c.appContext=o,!0===a?a="svg":!1===a&&(a=void 0),s&&t?t(c,i):e(c,i,a),l=!0,d._container=i,i.__vue_app__=d,Dr(c.component)}},onUnmount(e){c.push(e)},unmount(){l&&(s(c,d._instance,16),e(null,d._container),delete d._container.__vue_app__)},provide(e,t){return o.provides[e]=t,d},runWithContext(e){const t=je;je=d;try{return e()}finally{je=t}}};return d}}let je=null;function qe(e,t){if(fr){let r=fr.provides;const n=fr.parent&&fr.parent.provides;n===r&&(r=fr.provides=Object.create(n)),r[e]=t}else 0}function Ve(e,t,r=!1){const n=fr||T;if(n||je){const o=je?je._context.provides:n?null==n.parent?n.vnode.appContext&&n.vnode.appContext.provides:n.parent.provides:void 0;if(o&&e in o)return o[e];if(arguments.length>1)return r&&(0,i.Tn)(t)?t.call(n&&n.proxy):t}else 0}const Ge={},We=()=>Object.create(Ge),He=e=>Object.getPrototypeOf(e)===Ge;function $e(e,t,r,i=!1){const o={},s=We();e.propsDefaults=Object.create(null),ze(e,t,o,s);for(const n in e.propsOptions[0])n in o||(o[n]=void 0);r?e.props=i?o:(0,n.Gc)(o):e.type.props?e.props=o:e.props=s,e.attrs=s}function Je(e,t,r,o){const{props:s,attrs:a,vnode:{patchFlag:c}}=e,l=(0,n.ux)(s),[d]=e.propsOptions;let u=!1;if(!(o||c>0)||16&c){let n;ze(e,t,s,a)&&(u=!0);for(const o in l)t&&((0,i.$3)(t,o)||(n=(0,i.Tg)(o))!==o&&(0,i.$3)(t,n))||(d?!r||void 0===r[o]&&void 0===r[n]||(s[o]=Ye(d,l,o,void 0,e,!0)):delete s[o]);if(a!==l)for(const e in a)t&&(0,i.$3)(t,e)||(delete a[e],u=!0)}else if(8&c){const r=e.vnode.dynamicProps;for(let n=0;n<r.length;n++){let o=r[n];if(At(e.emitsOptions,o))continue;const c=t[o];if(d)if((0,i.$3)(a,o))c!==a[o]&&(a[o]=c,u=!0);else{const t=(0,i.PT)(o);s[t]=Ye(d,l,t,c,e,!1)}else c!==a[o]&&(a[o]=c,u=!0)}}u&&(0,n.hZ)(e.attrs,"set","")}function ze(e,t,r,o){const[s,a]=e.propsOptions;let c,l=!1;if(t)for(let n in t){if((0,i.SU)(n))continue;const d=t[n];let u;s&&(0,i.$3)(s,u=(0,i.PT)(n))?a&&a.includes(u)?(c||(c={}))[u]=d:r[u]=d:At(e.emitsOptions,n)||n in o&&d===o[n]||(o[n]=d,l=!0)}if(a){const t=(0,n.ux)(r),o=c||i.MZ;for(let n=0;n<a.length;n++){const c=a[n];r[c]=Ye(s,t,c,o[c],e,!(0,i.$3)(o,c))}}return l}function Ye(e,t,r,n,o,s){const a=e[r];if(null!=a){const e=(0,i.$3)(a,"default");if(e&&void 0===n){const e=a.default;if(a.type!==Function&&!a.skipFactory&&(0,i.Tn)(e)){const{propsDefaults:i}=o;if(r in i)n=i[r];else{const s=Sr(o);n=i[r]=e.call(null,t),s()}}else n=e;o.ce&&o.ce._setProp(r,n)}a[0]&&(s&&!e?n=!1:!a[1]||""!==n&&n!==(0,i.Tg)(r)||(n=!0))}return n}const Qe=new WeakMap;function Xe(e,t,r=!1){const n=r?Qe:t.propsCache,o=n.get(e);if(o)return o;const s=e.props,a={},c=[];let l=!1;if(!(0,i.Tn)(e)){const n=e=>{l=!0;const[r,n]=Xe(e,t,!0);(0,i.X$)(a,r),n&&c.push(...n)};!r&&t.mixins.length&&t.mixins.forEach(n),e.extends&&n(e.extends),e.mixins&&e.mixins.forEach(n)}if(!s&&!l)return(0,i.Gv)(e)&&n.set(e,i.Oj),i.Oj;if((0,i.cy)(s))for(let u=0;u<s.length;u++){0;const e=(0,i.PT)(s[u]);Ze(e)&&(a[e]=i.MZ)}else if(s){0;for(const e in s){const t=(0,i.PT)(e);if(Ze(t)){const r=s[e],n=a[t]=(0,i.cy)(r)||(0,i.Tn)(r)?{type:r}:(0,i.X$)({},r),o=n.type;let l=!1,d=!0;if((0,i.cy)(o))for(let e=0;e<o.length;++e){const t=o[e],r=(0,i.Tn)(t)&&t.name;if("Boolean"===r){l=!0;break}"String"===r&&(d=!1)}else l=(0,i.Tn)(o)&&"Boolean"===o.name;n[0]=l,n[1]=d,(l||(0,i.$3)(n,"default"))&&c.push(t)}}}const d=[a,c];return(0,i.Gv)(e)&&n.set(e,d),d}function Ze(e){return"$"!==e[0]&&!(0,i.SU)(e)}const et=e=>"_"===e[0]||"$stable"===e,tt=e=>(0,i.cy)(e)?e.map(ar):[ar(e)],rt=(e,t,r)=>{if(t._n)return t;const n=A(((...e)=>tt(t(...e))),r);return n._c=!1,n},nt=(e,t,r)=>{const n=e._ctx;for(const o in e){if(et(o))continue;const r=e[o];if((0,i.Tn)(r))t[o]=rt(o,r,n);else if(null!=r){0;const e=tt(r);t[o]=()=>e}}},it=(e,t)=>{const r=tt(t);e.slots.default=()=>r},ot=(e,t,r)=>{for(const n in t)(r||"_"!==n)&&(e[n]=t[n])},st=(e,t,r)=>{const n=e.slots=We();if(32&e.vnode.shapeFlag){const e=t._;e?(ot(n,t,r),r&&(0,i.yQ)(n,"_",e,!0)):nt(t,n)}else t&&it(e,t)},at=(e,t,r)=>{const{vnode:n,slots:o}=e;let s=!0,a=i.MZ;if(32&n.shapeFlag){const e=t._;e?r&&1===e?s=!1:ot(o,t,r):(s=!t.$stable,nt(t,o)),a=t}else t&&(it(e,t),a={default:1});if(s)for(const i in o)et(i)||null!=a[i]||delete o[i]};function ct(){"boolean"!==typeof __VUE_PROD_HYDRATION_MISMATCH_DETAILS__&&((0,i.We)().__VUE_PROD_HYDRATION_MISMATCH_DETAILS__=!1)}const lt=Lt;function dt(e){return ut(e)}function ut(e,t){ct();const r=(0,i.We)();r.__VUE__=!0;const{insert:o,remove:s,patchProp:a,createElement:c,createText:l,createComment:d,setText:u,setElementText:h,parentNode:v,nextSibling:p,setScopeId:f=i.tE,insertStaticContent:g}=e,m=(e,t,r,n=null,i=null,o=null,s=void 0,a=null,c=!!t.dynamicChildren)=>{if(e===t)return;e&&!Qt(e,t)&&(n=Z(e),J(e,i,o,!0),e=null),-2===t.patchFlag&&(c=!1,t.dynamicChildren=null);const{type:l,ref:d,shapeFlag:u}=t;switch(l){case Bt:S(e,t,r,n);break;case Kt:b(e,t,r,n);break;case Ft:null==e&&w(t,r,n,s);break;case Nt:U(e,t,r,n,i,o,s,a,c);break;default:1&u?R(e,t,r,n,i,o,s,a,c):6&u?L(e,t,r,n,i,o,s,a,c):(64&u||128&u)&&l.process(e,t,r,n,i,o,s,a,c,re)}null!=d&&i&&G(d,e&&e.ref,o,t||e,!t)},S=(e,t,r,n)=>{if(null==e)o(t.el=l(t.children),r,n);else{const r=t.el=e.el;t.children!==e.children&&u(r,t.children)}},b=(e,t,r,n)=>{null==e?o(t.el=d(t.children||""),r,n):t.el=e.el},w=(e,t,r,n)=>{[e.el,e.anchor]=g(e.children,t,r,n,e.el,e.anchor)},I=({el:e,anchor:t},r,n)=>{let i;while(e&&e!==t)i=p(e),o(e,r,n),e=i;o(t,r,n)},T=({el:e,anchor:t})=>{let r;while(e&&e!==t)r=p(e),s(e),e=r;s(t)},R=(e,t,r,n,i,o,s,a,c)=>{"svg"===t.type?s="svg":"math"===t.type&&(s="mathml"),null==e?k(t,r,n,i,o,s,a,c):M(e,t,i,o,s,a,c)},k=(e,t,r,n,s,l,d,u)=>{let v,p;const{props:f,shapeFlag:g,transition:m,dirs:y}=e;if(v=e.el=c(e.type,l,f&&f.is,f),8&g?h(v,e.children):16&g&&C(e.children,v,null,n,s,ht(e,l),d,u),y&&O(e,null,n,"created"),A(v,e,e.scopeId,d,n),f){for(const e in f)"value"===e||(0,i.SU)(e)||a(v,e,null,f[e],l,n);"value"in f&&a(v,"value",null,f.value,l),(p=f.onVnodeBeforeMount)&&ur(p,n,e)}y&&O(e,null,n,"beforeMount");const S=pt(s,m);S&&m.beforeEnter(v),o(v,t,r),((p=f&&f.onVnodeMounted)||S||y)&&lt((()=>{p&&ur(p,n,e),S&&m.enter(v),y&&O(e,null,n,"mounted")}),s)},A=(e,t,r,n,i)=>{if(r&&f(e,r),n)for(let o=0;o<n.length;o++)f(e,n[o]);if(i){let r=i.subTree;if(t===r||Ut(r.type)&&(r.ssContent===t||r.ssFallback===t)){const t=i.vnode;A(e,t,t.scopeId,t.slotScopeIds,i.parent)}}},C=(e,t,r,n,i,o,s,a,c=0)=>{for(let l=c;l<e.length;l++){const c=e[l]=a?cr(e[l]):ar(e[l]);m(null,c,t,r,n,i,o,s,a)}},M=(e,t,r,n,o,s,c)=>{const l=t.el=e.el;let{patchFlag:d,dynamicChildren:u,dirs:v}=t;d|=16&e.patchFlag;const p=e.props||i.MZ,f=t.props||i.MZ;let g;if(r&&vt(r,!1),(g=f.onVnodeBeforeUpdate)&&ur(g,r,t,e),v&&O(t,e,r,"beforeUpdate"),r&&vt(r,!0),(p.innerHTML&&null==f.innerHTML||p.textContent&&null==f.textContent)&&h(l,""),u?P(e.dynamicChildren,u,l,r,n,ht(t,o),s):c||j(e,t,l,null,r,n,ht(t,o),s,!1),d>0){if(16&d)x(l,p,f,r,o);else if(2&d&&p.class!==f.class&&a(l,"class",null,f.class,o),4&d&&a(l,"style",p.style,f.style,o),8&d){const e=t.dynamicProps;for(let t=0;t<e.length;t++){const n=e[t],i=p[n],s=f[n];s===i&&"value"!==n||a(l,n,i,s,o,r)}}1&d&&e.children!==t.children&&h(l,t.children)}else c||null!=u||x(l,p,f,r,o);((g=f.onVnodeUpdated)||v)&&lt((()=>{g&&ur(g,r,t,e),v&&O(t,e,r,"updated")}),n)},P=(e,t,r,n,i,o,s)=>{for(let a=0;a<t.length;a++){const c=e[a],l=t[a],d=c.el&&(c.type===Nt||!Qt(c,l)||70&c.shapeFlag)?v(c.el):r;m(c,l,d,null,n,i,o,s,!0)}},x=(e,t,r,n,o)=>{if(t!==r){if(t!==i.MZ)for(const s in t)(0,i.SU)(s)||s in r||a(e,s,t[s],null,o,n);for(const s in r){if((0,i.SU)(s))continue;const c=r[s],l=t[s];c!==l&&"value"!==s&&a(e,s,l,c,o,n)}"value"in r&&a(e,"value",t.value,r.value,o)}},U=(e,t,r,n,i,s,a,c,d)=>{const u=t.el=e?e.el:l(""),h=t.anchor=e?e.anchor:l("");let{patchFlag:v,dynamicChildren:p,slotScopeIds:f}=t;f&&(c=c?c.concat(f):f),null==e?(o(u,r,n),o(h,r,n),C(t.children||[],r,h,i,s,a,c,d)):v>0&&64&v&&p&&e.dynamicChildren?(P(e.dynamicChildren,p,r,i,s,a,c),(null!=t.key||i&&t===i.subTree)&&ft(e,t,!0)):j(e,t,r,h,i,s,a,c,d)},L=(e,t,r,n,i,o,s,a,c)=>{t.slotScopeIds=a,null==e?512&t.shapeFlag?i.ctx.activate(t,r,n,s,c):N(t,r,n,i,o,s,c):B(e,t,c)},N=(e,t,r,n,i,o,s)=>{const a=e.component=pr(e,n,i);if(H(e)&&(a.ctx.renderer=re),Tr(a,!1,s),a.asyncDep){if(i&&i.registerDep(a,K,s),!e.el){const e=a.subTree=tr(Kt);b(null,e,t,r)}}else K(a,e,t,r,i,o,s)},B=(e,t,r)=>{const n=t.component=e.component;if(Mt(e,t,r)){if(n.asyncDep&&!n.asyncResolved)return void F(n,t,r);n.next=t,n.update()}else t.el=e.el,n.vnode=t},K=(e,t,r,o,s,a,c)=>{const l=()=>{if(e.isMounted){let{next:t,bu:r,u:n,parent:o,vnode:d}=e;{const r=mt(e);if(r)return t&&(t.el=d.el,F(e,t,c)),void r.asyncDep.then((()=>{e.isUnmounted||l()}))}let u,h=t;0,vt(e,!1),t?(t.el=d.el,F(e,t,c)):t=d,r&&(0,i.DY)(r),(u=t.props&&t.props.onVnodeBeforeUpdate)&&ur(u,o,t,d),vt(e,!0);const p=Ct(e);0;const f=e.subTree;e.subTree=p,m(f,p,v(f.el),Z(f),e,s,a),t.el=p.el,null===h&&xt(e,p.el),n&&lt(n,s),(u=t.props&&t.props.onVnodeUpdated)&&lt((()=>ur(u,o,t,d)),s)}else{let n;const{el:c,props:l}=t,{bm:d,m:u,parent:h,root:v,type:p}=e,f=W(t);if(vt(e,!1),d&&(0,i.DY)(d),!f&&(n=l&&l.onVnodeBeforeMount)&&ur(n,h,t),vt(e,!0),c&&ie){const t=()=>{e.subTree=Ct(e),ie(c,e.subTree,e,s,null)};f&&p.__asyncHydrate?p.__asyncHydrate(c,e,t):t()}else{v.ce&&v.ce._injectChildStyle(p);const n=e.subTree=Ct(e);0,m(null,n,r,o,e,s,a),t.el=n.el}if(u&&lt(u,s),!f&&(n=l&&l.onVnodeMounted)){const e=t;lt((()=>ur(n,h,e)),s)}(256&t.shapeFlag||h&&W(h.vnode)&&256&h.vnode.shapeFlag)&&e.a&&lt(e.a,s),e.isMounted=!0,t=r=o=null}};e.scope.on();const d=e.effect=new n.X2(l);e.scope.off();const u=e.update=d.run.bind(d),h=e.job=d.runIfDirty.bind(d);h.i=e,h.id=e.uid,d.scheduler=()=>y(h),vt(e,!0),u()},F=(e,t,r)=>{t.component=e;const i=e.vnode.props;e.vnode=t,e.next=null,Je(e,t.props,i,r),at(e,t.children,r),(0,n.C4)(),E(e),(0,n.bl)()},j=(e,t,r,n,i,o,s,a,c=!1)=>{const l=e&&e.children,d=e?e.shapeFlag:0,u=t.children,{patchFlag:v,shapeFlag:p}=t;if(v>0){if(128&v)return void V(l,u,r,n,i,o,s,a,c);if(256&v)return void q(l,u,r,n,i,o,s,a,c)}8&p?(16&d&&X(l,i,o),u!==l&&h(r,u)):16&d?16&p?V(l,u,r,n,i,o,s,a,c):X(l,i,o,!0):(8&d&&h(r,""),16&p&&C(u,r,n,i,o,s,a,c))},q=(e,t,r,n,o,s,a,c,l)=>{e=e||i.Oj,t=t||i.Oj;const d=e.length,u=t.length,h=Math.min(d,u);let v;for(v=0;v<h;v++){const n=t[v]=l?cr(t[v]):ar(t[v]);m(e[v],n,r,null,o,s,a,c,l)}d>u?X(e,o,s,!0,!1,h):C(t,r,n,o,s,a,c,l,h)},V=(e,t,r,n,o,s,a,c,l)=>{let d=0;const u=t.length;let h=e.length-1,v=u-1;while(d<=h&&d<=v){const n=e[d],i=t[d]=l?cr(t[d]):ar(t[d]);if(!Qt(n,i))break;m(n,i,r,null,o,s,a,c,l),d++}while(d<=h&&d<=v){const n=e[h],i=t[v]=l?cr(t[v]):ar(t[v]);if(!Qt(n,i))break;m(n,i,r,null,o,s,a,c,l),h--,v--}if(d>h){if(d<=v){const e=v+1,i=e<u?t[e].el:n;while(d<=v)m(null,t[d]=l?cr(t[d]):ar(t[d]),r,i,o,s,a,c,l),d++}}else if(d>v)while(d<=h)J(e[d],o,s,!0),d++;else{const p=d,f=d,g=new Map;for(d=f;d<=v;d++){const e=t[d]=l?cr(t[d]):ar(t[d]);null!=e.key&&g.set(e.key,d)}let y,S=0;const b=v-f+1;let E=!1,_=0;const w=new Array(b);for(d=0;d<b;d++)w[d]=0;for(d=p;d<=h;d++){const n=e[d];if(S>=b){J(n,o,s,!0);continue}let i;if(null!=n.key)i=g.get(n.key);else for(y=f;y<=v;y++)if(0===w[y-f]&&Qt(n,t[y])){i=y;break}void 0===i?J(n,o,s,!0):(w[i-f]=d+1,i>=_?_=i:E=!0,m(n,t[i],r,null,o,s,a,c,l),S++)}const I=E?gt(w):i.Oj;for(y=I.length-1,d=b-1;d>=0;d--){const e=f+d,i=t[e],h=e+1<u?t[e+1].el:n;0===w[d]?m(null,i,r,h,o,s,a,c,l):E&&(y<0||d!==I[y]?$(i,r,h,2):y--)}}},$=(e,t,r,n,i=null)=>{const{el:s,type:a,transition:c,children:l,shapeFlag:d}=e;if(6&d)return void $(e.component.subTree,t,r,n);if(128&d)return void e.suspense.move(t,r,n);if(64&d)return void a.move(e,t,r,re);if(a===Nt){o(s,t,r);for(let e=0;e<l.length;e++)$(l[e],t,r,n);return void o(e.anchor,t,r)}if(a===Ft)return void I(e,t,r);const u=2!==n&&1&d&&c;if(u)if(0===n)c.beforeEnter(s),o(s,t,r),lt((()=>c.enter(s)),i);else{const{leave:e,delayLeave:n,afterLeave:i}=c,a=()=>o(s,t,r),l=()=>{e(s,(()=>{a(),i&&i()}))};n?n(s,a,l):l()}else o(s,t,r)},J=(e,t,r,n=!1,i=!1)=>{const{type:o,props:s,ref:a,children:c,dynamicChildren:l,shapeFlag:d,patchFlag:u,dirs:h,cacheIndex:v}=e;if(-2===u&&(i=!1),null!=a&&G(a,null,r,e,!0),null!=v&&(t.renderCache[v]=void 0),256&d)return void t.ctx.deactivate(e);const p=1&d&&h,f=!W(e);let g;if(f&&(g=s&&s.onVnodeBeforeUnmount)&&ur(g,t,e),6&d)Q(e.component,r,n);else{if(128&d)return void e.suspense.unmount(r,n);p&&O(e,null,t,"beforeUnmount"),64&d?e.type.remove(e,t,r,re,n):l&&!l.hasOnce&&(o!==Nt||u>0&&64&u)?X(l,t,r,!1,!0):(o===Nt&&384&u||!i&&16&d)&&X(c,t,r),n&&z(e)}(f&&(g=s&&s.onVnodeUnmounted)||p)&&lt((()=>{g&&ur(g,t,e),p&&O(e,null,t,"unmounted")}),r)},z=e=>{const{type:t,el:r,anchor:n,transition:i}=e;if(t===Nt)return void Y(r,n);if(t===Ft)return void T(e);const o=()=>{s(r),i&&!i.persisted&&i.afterLeave&&i.afterLeave()};if(1&e.shapeFlag&&i&&!i.persisted){const{leave:t,delayLeave:n}=i,s=()=>t(r,o);n?n(e.el,o,s):s()}else o()},Y=(e,t)=>{let r;while(e!==t)r=p(e),s(e),e=r;s(t)},Q=(e,t,r)=>{const{bum:n,scope:o,job:s,subTree:a,um:c,m:l,a:d}=e;yt(l),yt(d),n&&(0,i.DY)(n),o.stop(),s&&(s.flags|=8,J(a,e,t,r)),c&&lt(c,t),lt((()=>{e.isUnmounted=!0}),t),t&&t.pendingBranch&&!t.isUnmounted&&e.asyncDep&&!e.asyncResolved&&e.suspenseId===t.pendingId&&(t.deps--,0===t.deps&&t.resolve())},X=(e,t,r,n=!1,i=!1,o=0)=>{for(let s=o;s<e.length;s++)J(e[s],t,r,n,i)},Z=e=>{if(6&e.shapeFlag)return Z(e.component.subTree);if(128&e.shapeFlag)return e.suspense.next();const t=p(e.anchor||e.el),r=t&&t[D];return r?p(r):t};let ee=!1;const te=(e,t,r)=>{null==e?t._vnode&&J(t._vnode,null,null,!0):m(t._vnode||null,e,t,null,null,null,r),t._vnode=e,ee||(ee=!0,E(),_(),ee=!1)},re={p:m,um:J,m:$,r:z,mt:N,mc:C,pc:j,pbc:P,n:Z,o:e};let ne,ie;return t&&([ne,ie]=t(re)),{render:te,hydrate:ne,createApp:Fe(te,ne)}}function ht({type:e,props:t},r){return"svg"===r&&"foreignObject"===e||"mathml"===r&&"annotation-xml"===e&&t&&t.encoding&&t.encoding.includes("html")?void 0:r}function vt({effect:e,job:t},r){r?(e.flags|=32,t.flags|=4):(e.flags&=-33,t.flags&=-5)}function pt(e,t){return(!e||e&&!e.pendingBranch)&&t&&!t.persisted}function ft(e,t,r=!1){const n=e.children,o=t.children;if((0,i.cy)(n)&&(0,i.cy)(o))for(let i=0;i<n.length;i++){const e=n[i];let t=o[i];1&t.shapeFlag&&!t.dynamicChildren&&((t.patchFlag<=0||32===t.patchFlag)&&(t=o[i]=cr(o[i]),t.el=e.el),r||-2===t.patchFlag||ft(e,t)),t.type===Bt&&(t.el=e.el)}}function gt(e){const t=e.slice(),r=[0];let n,i,o,s,a;const c=e.length;for(n=0;n<c;n++){const c=e[n];if(0!==c){if(i=r[r.length-1],e[i]<c){t[n]=i,r.push(n);continue}o=0,s=r.length-1;while(o<s)a=o+s>>1,e[r[a]]<c?o=a+1:s=a;c<e[r[o]]&&(o>0&&(t[n]=r[o-1]),r[o]=n)}}o=r.length,s=r[o-1];while(o-- >0)r[o]=s,s=t[s];return r}function mt(e){const t=e.subTree.component;if(t)return t.asyncDep&&!t.asyncResolved?t:mt(t)}function yt(e){if(e)for(let t=0;t<e.length;t++)e[t].flags|=8}const St=Symbol.for("v-scx"),bt=()=>{{const e=Ve(St);return e}};function Et(e,t,r){return _t(e,t,r)}function _t(e,t,r=i.MZ){const{immediate:o,deep:a,flush:c,once:l}=r;const d=(0,i.X$)({},r);const u=t&&o||!t&&"post"!==c;let h;if(Ir)if("sync"===c){const e=bt();h=e.__watcherHandles||(e.__watcherHandles=[])}else if(!u){const e=()=>{};return e.stop=i.tE,e.resume=i.tE,e.pause=i.tE,e}const v=fr;d.call=(e,t,r)=>s(e,v,t,r);let p=!1;"post"===c?d.scheduler=e=>{lt(e,v&&v.suspense)}:"sync"!==c&&(p=!0,d.scheduler=(e,t)=>{t?e():y(e)}),d.augmentJob=e=>{t&&(e.flags|=4),p&&(e.flags|=2,v&&(e.id=v.uid,e.i=v))};const f=(0,n.wB)(e,t,d);return Ir&&(h?h.push(f):u&&f()),f}function wt(e,t,r){const n=this.proxy,o=(0,i.Kg)(e)?e.includes(".")?It(n,e):()=>n[e]:e.bind(n,n);let s;(0,i.Tn)(t)?s=t:(s=t.handler,r=t);const a=Sr(this),c=_t(o,s.bind(n),r);return a(),c}function It(e,t){const r=t.split(".");return()=>{let t=e;for(let e=0;e<r.length&&t;e++)t=t[r[e]];return t}}const Tt=(e,t)=>"modelValue"===t||"model-value"===t?e.modelModifiers:e[`${t}Modifiers`]||e[`${(0,i.PT)(t)}Modifiers`]||e[`${(0,i.Tg)(t)}Modifiers`];function Rt(e,t,...r){if(e.isUnmounted)return;const n=e.vnode.props||i.MZ;let o=r;const a=t.startsWith("update:"),c=a&&Tt(n,t.slice(7));let l;c&&(c.trim&&(o=r.map((e=>(0,i.Kg)(e)?e.trim():e))),c.number&&(o=r.map(i.bB)));let d=n[l=(0,i.rU)(t)]||n[l=(0,i.rU)((0,i.PT)(t))];!d&&a&&(d=n[l=(0,i.rU)((0,i.Tg)(t))]),d&&s(d,e,6,o);const u=n[l+"Once"];if(u){if(e.emitted){if(e.emitted[l])return}else e.emitted={};e.emitted[l]=!0,s(u,e,6,o)}}function kt(e,t,r=!1){const n=t.emitsCache,o=n.get(e);if(void 0!==o)return o;const s=e.emits;let a={},c=!1;if(!(0,i.Tn)(e)){const n=e=>{const r=kt(e,t,!0);r&&(c=!0,(0,i.X$)(a,r))};!r&&t.mixins.length&&t.mixins.forEach(n),e.extends&&n(e.extends),e.mixins&&e.mixins.forEach(n)}return s||c?((0,i.cy)(s)?s.forEach((e=>a[e]=null)):(0,i.X$)(a,s),(0,i.Gv)(e)&&n.set(e,a),a):((0,i.Gv)(e)&&n.set(e,null),null)}function At(e,t){return!(!e||!(0,i.Mp)(t))&&(t=t.slice(2).replace(/Once$/,""),(0,i.$3)(e,t[0].toLowerCase()+t.slice(1))||(0,i.$3)(e,(0,i.Tg)(t))||(0,i.$3)(e,t))}function Ct(e){const{type:t,vnode:r,proxy:n,withProxy:o,propsOptions:[s],slots:c,attrs:l,emit:d,render:u,renderCache:h,props:v,data:p,setupState:f,ctx:g,inheritAttrs:m}=e,y=k(e);let S,b;try{if(4&r.shapeFlag){const e=o||n,t=e;S=ar(u.call(t,e,h,v,f,p,g)),b=l}else{const e=t;0,S=ar(e.length>1?e(v,{attrs:l,slots:c,emit:d}):e(v,null)),b=t.props?l:Ot(l)}}catch(_){jt.length=0,a(_,e,1),S=tr(Kt)}let E=S;if(b&&!1!==m){const e=Object.keys(b),{shapeFlag:t}=E;e.length&&7&t&&(s&&e.some(i.CP)&&(b=Dt(b,s)),E=ir(E,b,!1,!0))}return r.dirs&&(E=ir(E,null,!1,!0),E.dirs=E.dirs?E.dirs.concat(r.dirs):r.dirs),r.transition&&F(E,r.transition),S=E,k(y),S}const Ot=e=>{let t;for(const r in e)("class"===r||"style"===r||(0,i.Mp)(r))&&((t||(t={}))[r]=e[r]);return t},Dt=(e,t)=>{const r={};for(const n in e)(0,i.CP)(n)&&n.slice(9)in t||(r[n]=e[n]);return r};function Mt(e,t,r){const{props:n,children:i,component:o}=e,{props:s,children:a,patchFlag:c}=t,l=o.emitsOptions;if(t.dirs||t.transition)return!0;if(!(r&&c>=0))return!(!i&&!a||a&&a.$stable)||n!==s&&(n?!s||Pt(n,s,l):!!s);if(1024&c)return!0;if(16&c)return n?Pt(n,s,l):!!s;if(8&c){const e=t.dynamicProps;for(let t=0;t<e.length;t++){const r=e[t];if(s[r]!==n[r]&&!At(l,r))return!0}}return!1}function Pt(e,t,r){const n=Object.keys(t);if(n.length!==Object.keys(e).length)return!0;for(let i=0;i<n.length;i++){const o=n[i];if(t[o]!==e[o]&&!At(r,o))return!0}return!1}function xt({vnode:e,parent:t},r){while(t){const n=t.subTree;if(n.suspense&&n.suspense.activeBranch===e&&(n.el=e.el),n!==e)break;(e=t.vnode).el=r,t=t.parent}}const Ut=e=>e.__isSuspense;function Lt(e,t){t&&t.pendingBranch?(0,i.cy)(e)?t.effects.push(...e):t.effects.push(e):b(e)}const Nt=Symbol.for("v-fgt"),Bt=Symbol.for("v-txt"),Kt=Symbol.for("v-cmt"),Ft=Symbol.for("v-stc"),jt=[];let qt=null;function Vt(e=!1){jt.push(qt=e?null:[])}function Gt(){jt.pop(),qt=jt[jt.length-1]||null}let Wt=1;function Ht(e,t=!1){Wt+=e,e<0&&qt&&t&&(qt.hasOnce=!0)}function $t(e){return e.dynamicChildren=Wt>0?qt||i.Oj:null,Gt(),Wt>0&&qt&&qt.push(e),e}function Jt(e,t,r,n,i,o){return $t(er(e,t,r,n,i,o,!0))}function zt(e,t,r,n,i){return $t(tr(e,t,r,n,i,!0))}function Yt(e){return!!e&&!0===e.__v_isVNode}function Qt(e,t){return e.type===t.type&&e.key===t.key}const Xt=({key:e})=>null!=e?e:null,Zt=({ref:e,ref_key:t,ref_for:r})=>("number"===typeof e&&(e=""+e),null!=e?(0,i.Kg)(e)||(0,n.i9)(e)||(0,i.Tn)(e)?{i:T,r:e,k:t,f:!!r}:e:null);function er(e,t=null,r=null,n=0,o=null,s=(e===Nt?0:1),a=!1,c=!1){const l={__v_isVNode:!0,__v_skip:!0,type:e,props:t,key:t&&Xt(t),ref:t&&Zt(t),scopeId:R,slotScopeIds:null,children:r,component:null,suspense:null,ssContent:null,ssFallback:null,dirs:null,transition:null,el:null,anchor:null,target:null,targetStart:null,targetAnchor:null,staticCount:0,shapeFlag:s,patchFlag:n,dynamicProps:o,dynamicChildren:null,appContext:null,ctx:T};return c?(lr(l,r),128&s&&e.normalize(l)):r&&(l.shapeFlag|=(0,i.Kg)(r)?8:16),Wt>0&&!a&&qt&&(l.patchFlag>0||6&s)&&32!==l.patchFlag&&qt.push(l),l}const tr=rr;function rr(e,t=null,r=null,o=0,s=null,a=!1){if(e&&e!==pe||(e=Kt),Yt(e)){const n=ir(e,t,!0);return r&&lr(n,r),Wt>0&&!a&&qt&&(6&n.shapeFlag?qt[qt.indexOf(e)]=n:qt.push(n)),n.patchFlag=-2,n}if(Pr(e)&&(e=e.__vccOpts),t){t=nr(t);let{class:e,style:r}=t;e&&!(0,i.Kg)(e)&&(t.class=(0,i.C4)(e)),(0,i.Gv)(r)&&((0,n.ju)(r)&&!(0,i.cy)(r)&&(r=(0,i.X$)({},r)),t.style=(0,i.Tr)(r))}const c=(0,i.Kg)(e)?1:Ut(e)?128:M(e)?64:(0,i.Gv)(e)?4:(0,i.Tn)(e)?2:0;return er(e,t,r,o,s,c,a,!0)}function nr(e){return e?(0,n.ju)(e)||He(e)?(0,i.X$)({},e):e:null}function ir(e,t,r=!1,n=!1){const{props:o,ref:s,patchFlag:a,children:c,transition:l}=e,d=t?dr(o||{},t):o,u={__v_isVNode:!0,__v_skip:!0,type:e.type,props:d,key:d&&Xt(d),ref:t&&t.ref?r&&s?(0,i.cy)(s)?s.concat(Zt(t)):[s,Zt(t)]:Zt(t):s,scopeId:e.scopeId,slotScopeIds:e.slotScopeIds,children:c,target:e.target,targetStart:e.targetStart,targetAnchor:e.targetAnchor,staticCount:e.staticCount,shapeFlag:e.shapeFlag,patchFlag:t&&e.type!==Nt?-1===a?16:16|a:a,dynamicProps:e.dynamicProps,dynamicChildren:e.dynamicChildren,appContext:e.appContext,dirs:e.dirs,transition:l,component:e.component,suspense:e.suspense,ssContent:e.ssContent&&ir(e.ssContent),ssFallback:e.ssFallback&&ir(e.ssFallback),el:e.el,anchor:e.anchor,ctx:e.ctx,ce:e.ce};return l&&n&&F(u,l.clone(u)),u}function or(e=" ",t=0){return tr(Bt,null,e,t)}function sr(e="",t=!1){return t?(Vt(),zt(Kt,null,e)):tr(Kt,null,e)}function ar(e){return null==e||"boolean"===typeof e?tr(Kt):(0,i.cy)(e)?tr(Nt,null,e.slice()):Yt(e)?cr(e):tr(Bt,null,String(e))}function cr(e){return null===e.el&&-1!==e.patchFlag||e.memo?e:ir(e)}function lr(e,t){let r=0;const{shapeFlag:n}=e;if(null==t)t=null;else if((0,i.cy)(t))r=16;else if("object"===typeof t){if(65&n){const r=t.default;return void(r&&(r._c&&(r._d=!1),lr(e,r()),r._c&&(r._d=!0)))}{r=32;const n=t._;n||He(t)?3===n&&T&&(1===T.slots._?t._=1:(t._=2,e.patchFlag|=1024)):t._ctx=T}}else(0,i.Tn)(t)?(t={default:t,_ctx:T},r=32):(t=String(t),64&n?(r=16,t=[or(t)]):r=8);e.children=t,e.shapeFlag|=r}function dr(...e){const t={};for(let r=0;r<e.length;r++){const n=e[r];for(const e in n)if("class"===e)t.class!==n.class&&(t.class=(0,i.C4)([t.class,n.class]));else if("style"===e)t.style=(0,i.Tr)([t.style,n.style]);else if((0,i.Mp)(e)){const r=t[e],o=n[e];!o||r===o||(0,i.cy)(r)&&r.includes(o)||(t[e]=r?[].concat(r,o):o)}else""!==e&&(t[e]=n[e])}return t}function ur(e,t,r,n=null){s(e,t,7,[r,n])}const hr=Be();let vr=0;function pr(e,t,r){const o=e.type,s=(t?t.appContext:e.appContext)||hr,a={uid:vr++,vnode:e,type:o,parent:t,appContext:s,root:null,next:null,subTree:null,effect:null,update:null,job:null,scope:new n.yC(!0),render:null,proxy:null,exposed:null,exposeProxy:null,withProxy:null,provides:t?t.provides:Object.create(s.provides),ids:t?t.ids:["",0,0],accessCache:null,renderCache:[],components:null,directives:null,propsOptions:Xe(o,s),emitsOptions:kt(o,s),emit:null,emitted:null,propsDefaults:i.MZ,inheritAttrs:o.inheritAttrs,ctx:i.MZ,data:i.MZ,props:i.MZ,attrs:i.MZ,slots:i.MZ,refs:i.MZ,setupState:i.MZ,setupContext:null,suspense:r,suspenseId:r?r.pendingId:0,asyncDep:null,asyncResolved:!1,isMounted:!1,isUnmounted:!1,isDeactivated:!1,bc:null,c:null,bm:null,m:null,bu:null,u:null,um:null,bum:null,da:null,a:null,rtg:null,rtc:null,ec:null,sp:null};return a.ctx={_:a},a.root=t?t.root:a,a.emit=Rt.bind(null,a),e.ce&&e.ce(a),a}let fr=null;const gr=()=>fr||T;let mr,yr;{const e=(0,i.We)(),t=(t,r)=>{let n;return(n=e[t])||(n=e[t]=[]),n.push(r),e=>{n.length>1?n.forEach((t=>t(e))):n[0](e)}};mr=t("__VUE_INSTANCE_SETTERS__",(e=>fr=e)),yr=t("__VUE_SSR_SETTERS__",(e=>Ir=e))}const Sr=e=>{const t=fr;return mr(e),e.scope.on(),()=>{e.scope.off(),mr(t)}},br=()=>{fr&&fr.scope.off(),mr(null)};function Er(e){return 4&e.vnode.shapeFlag}let _r,wr,Ir=!1;function Tr(e,t=!1,r=!1){t&&yr(t);const{props:n,children:i}=e.vnode,o=Er(e);$e(e,n,o,t),st(e,i,r);const s=o?Rr(e,t):void 0;return t&&yr(!1),s}function Rr(e,t){const r=e.type;e.accessCache=Object.create(null),e.proxy=new Proxy(e.ctx,Ee);const{setup:s}=r;if(s){(0,n.C4)();const r=e.setupContext=s.length>1?Or(e):null,c=Sr(e),l=o(s,e,0,[e.props,r]),d=(0,i.yL)(l);if((0,n.bl)(),c(),!d&&!e.sp||W(e)||V(e),d){if(l.then(br,br),t)return l.then((r=>{kr(e,r,t)})).catch((t=>{a(t,e,0)}));e.asyncDep=l}else kr(e,l,t)}else Ar(e,t)}function kr(e,t,r){(0,i.Tn)(t)?e.type.__ssrInlineRender?e.ssrRender=t:e.render=t:(0,i.Gv)(t)&&(e.setupState=(0,n.Pr)(t)),Ar(e,r)}function Ar(e,t,r){const o=e.type;if(!e.render){if(!t&&_r&&!o.render){const t=o.template||Ae(e).template;if(t){0;const{isCustomElement:r,compilerOptions:n}=e.appContext.config,{delimiters:s,compilerOptions:a}=o,c=(0,i.X$)((0,i.X$)({isCustomElement:r,delimiters:s},n),a);o.render=_r(t,c)}}e.render=o.render||i.tE,wr&&wr(e)}{const t=Sr(e);(0,n.C4)();try{Ie(e)}finally{(0,n.bl)(),t()}}}const Cr={get(e,t){return(0,n.u4)(e,"get",""),e[t]}};function Or(e){const t=t=>{e.exposed=t||{}};return{attrs:new Proxy(e.attrs,Cr),slots:e.slots,emit:e.emit,expose:t}}function Dr(e){return e.exposed?e.exposeProxy||(e.exposeProxy=new Proxy((0,n.Pr)((0,n.IG)(e.exposed)),{get(t,r){return r in t?t[r]:r in Se?Se[r](e):void 0},has(e,t){return t in e||t in Se}})):e.proxy}function Mr(e,t=!0){return(0,i.Tn)(e)?e.displayName||e.name:e.name||t&&e.__name}function Pr(e){return(0,i.Tn)(e)&&"__vccOpts"in e}const xr=(e,t)=>{const r=(0,n.EW)(e,t,Ir);return r};function Ur(e,t,r){const n=arguments.length;return 2===n?(0,i.Gv)(t)&&!(0,i.cy)(t)?Yt(t)?tr(e,null,[t]):tr(e,t):tr(e,null,t):(n>3?r=Array.prototype.slice.call(arguments,2):3===n&&Yt(r)&&(r=[r]),tr(e,t,r))}const Lr="3.5.13"},5982:function(e,t,r){"use strict";r.d(t,{Il:function(){return i},Nv:function(){return n},oT:function(){return o}});var n="migrationState",i=function(e){return e[e["NOT_STARTED"]=0]="NOT_STARTED",e[e["INITIAL_DATA_MIGRATED"]=1]="INITIAL_DATA_MIGRATED",e[e["OLM_SESSIONS_MIGRATED"]=2]="OLM_SESSIONS_MIGRATED",e[e["MEGOLM_SESSIONS_MIGRATED"]=3]="MEGOLM_SESSIONS_MIGRATED",e[e["ROOM_SETTINGS_MIGRATED"]=4]="ROOM_SETTINGS_MIGRATED",e[e["INITIAL_OWN_KEY_QUERY_DONE"]=5]="INITIAL_OWN_KEY_QUERY_DONE",e}({}),o=50},6012:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.REFERENCE_RELATION=void 0;var n=r(6288),i=new n.NamespacedValue("m.reference");t.REFERENCE_RELATION=i},6080:function(e,t,r){"use strict";var n=r(7476),i=r(9306),o=r(616),s=n(n.bind);e.exports=function(e,t){return i(e),void 0===t?e:o?s(e,t):function(){return e.apply(t,arguments)}}},6119:function(e,t,r){"use strict";var n=r(5745),i=r(3392),o=n("keys");e.exports=function(e){return o[e]||(o[e]=i(e))}},6170:function(e,t,r){"use strict";r.d(t,{$9:function(){return H},A4:function(){return y},Ab:function(){return p},Bi:function(){return z},C6:function(){return ne},CC:function(){return F},Et:function(){return E},Fq:function(){return Q},Gp:function(){return _},HF:function(){return te},Mf:function(){return j},NQ:function(){return O},Nt:function(){return R},Nz:function(){return g},O5:function(){return ie},RR:function(){return f},S8:function(){return I},UB:function(){return m},YY:function(){return re},aw:function(){return J},d7:function(){return w},d8:function(){return U},dn:function(){return k},hX:function(){return P},hc:function(){return A},hl:function(){return b},hm:function(){return v},iH:function(){return M},iK:function(){return B},j0:function(){return N},kG:function(){return oe},kg:function(){return Z},ky:function(){return S},ll:function(){return X},sy:function(){return W},v6:function(){return x},yD:function(){return h},yy:function(){return C},zR:function(){return $}});r(4114),r(8111),r(2489),r(7588),r(1701),r(4603),r(7566),r(8721);var n=r(698),i=r(4761),o=r(7562),s=r(8289),a=r(9454),c=r(8645);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var u=new Map;function h(e){return e instanceof String&&(e=e.toString()),u.has(e)||u.set(e,e),u.get(e)}function v(e,t){var r=null!==t&&void 0!==t?t:new URLSearchParams,n=function(e){void 0!==o&&null!==o&&(Array.isArray(o)?o.forEach((t=>{r.append(e,String(t))})):r.append(e,String(o)))};for(var[i,o]of Object.entries(e))n(i);return r}function p(e,t,r){var n=d(d({},r),{},{[t]:r[e]});return delete n[e],n}function f(e,t){for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];void 0!==n&&null!==n&&(e=e.replace(r,encodeURIComponent(n)))}return e}function g(e,t,r){var n;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e.splice(n,1),!0}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e.splice(n,1),!0;return!1}function m(e,t){for(var r of t)if(!e.hasOwnProperty(r))throw new Error("Missing required key: "+r)}function y(e){return JSON.parse(JSON.stringify(e))}function S(e,t){if(e===t)return!0;if(typeof e!==typeof t)return!1;if("number"===typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(Array.isArray(e)){if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!S(e[r],t[r]))return!1}else{for(var n in t)if(t.hasOwnProperty(n)!==e.hasOwnProperty(n))return!1;for(var i in e)if(t.hasOwnProperty(i)!==e.hasOwnProperty(i)||!S(e[i],t[i]))return!1}return!0}function b(e){if("object"!==typeof e)return e;if(null===e||void 0===e||Array.isArray(e))return e;var t=[];for(var[r,n]of Object.entries(e))t.push([r,b(n)]);return t.sort(((e,t)=>J(e[0],t[0]))),t}function E(e){return"number"===typeof e&&isFinite(e)}function _(e){return"string"===typeof e?o(e.normalize("NFD").replace(T,"")):""}function w(e){return"string"===typeof e?e.replace(/[\u202d-\u202e]/g,""):""}function I(e){return _(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()}var T=/[\u2000-\u200F\u202A-\u202F\u0300-\u036F\uFEFF\u061C\u2800\u2062-\u2063\s]/g;function R(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function k(e){return R(e).replace(/\\\*/g,".*").replace(/\?/g,".")}function A(e){return null!==e&&void 0!==e&&e.endsWith("/")?e.slice(0,-1):e}function C(e,t){return new Promise((r=>{setTimeout(r,e,t)}))}function O(e,t,r){return D.apply(this,arguments)}function D(){return D=(0,n.A)((function*(e,t,r){var n=Date.now();try{return yield r()}finally{var i=Date.now();e.debug("[Perf]: ".concat(t," took ").concat(i-n,"ms"))}})),D.apply(this,arguments)}function M(){return new Promise((e=>setTimeout(e)))}function P(e){return null===e||void 0===e}function x(){var e,t,r=new Promise(((r,n)=>{e=r,t=n}));return{resolve:e,reject:t,promise:r}}function U(e,t){return L.apply(this,arguments)}function L(){return L=(0,n.A)((function*(e,t){for(var r of e)yield t(yield r)})),L.apply(this,arguments)}function N(e){return Promise.resolve(e())}function B(e,t){return K.apply(this,arguments)}function K(){return K=(0,n.A)((function*(e,t){for(var r=[],n=0;n<e.length;n+=t)r.push(...yield Promise.all(e.slice(n,n+t).map((e=>e()))));return r})),K.apply(this,arguments)}function F(e){return s((t=>e(t)),{forever:!0,factor:2,minTimeout:3e3,maxTimeout:15e3})}var j=(()=>{for(var e="",t=32;t<=126;t++)e+=String.fromCharCode(t);return e})();function q(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:j;return e.padEnd(t,r[0])}function V(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:j,n=BigInt(r.length);if(e<=n)return null!==(t=r[Number(e)-1])&&void 0!==t?t:"";var i=e/n,o=Number(e%n)-1;return o<0&&(i-=BigInt(Math.abs(o)),o=Number(n)-1),V(i,r)+r[o]}function G(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:j,r=BigInt(t.length),n=BigInt(0),i=e.length-1,o=BigInt(0);i>=0;i--,o++){var s=e.charCodeAt(i)-t.charCodeAt(0);n+=BigInt(1+s)*r**o}return n}function W(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:j,n=Math.max(e.length,t.length),i=G(q(e,n,r),r),o=G(q(t,n,r),r),s=(i+o)/BigInt(2);return s===i||s==o?V(s,r)+r[0]:V(s,r)}function H(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:j;return V(G(e,t)+BigInt(1),t)}function $(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:j;return V(G(e,t)-BigInt(1),t)}function J(e,t){return e<t?-1:e>t?1:0}function z(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];for(var[n,i]of Object.entries(t))e[n]instanceof Object&&i?z(e[n],i):(null!==i&&void 0!==i||!r)&&ne(e,n,i);return e}function Y(e){var t;return null!==(t=a.vo.findIn(e.getContent()))&&void 0!==t?t:-1}function Q(e,t){return Y(t)-Y(e)}function X(e){return[c.L.Read,c.L.ReadPrivate].includes(e)}function Z(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:(e,t)=>e===t;if(e.size!==t.size)return!1;for(var[n,i]of e){var o=t.get(n);if(void 0===o||!r(i,o))return!1}return!0}function ee(e){return e instanceof Map?te(e):Array.isArray(e)?e.map((e=>ee(e))):e}function te(e){var t=new Map;for(var[r,n]of e)t.set(r,ee(n));return Object.fromEntries(t.entries())}function re(e){return"__proto__"===e||"prototype"===e||"constructor"===e}function ne(e,t,r){if(re(t))throw new Error("Trying to modify prototype or constructor");e[t]=r}function ie(e){return!(re(e.room_id)||re(e.sender)||re(e.event_id))}class oe extends Map{constructor(e){super(),this.createDefault=e}getOrCreate(e){return this.has(e)||this.set(e,this.createDefault()),this.get(e)}}},6193:function(e,t,r){"use strict";var n=r(4215);e.exports="NODE"===n},6198:function(e,t,r){"use strict";var n=r(8014);e.exports=function(e){return n(e.length)}},6218:function(e,t,r){"use strict";r(4114),r(8111),r(2489),r(7588),r(1701),r(3579),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698),Object.defineProperty(t,"__esModule",{value:!0}),t.ClientWidgetApi=void 0;var n=r(9366),i=r(7223),o=r(6819),s=r(8098),a=r(6960),c=r(8614),l=r(8848),d=r(6327),u=r(4501),h=r(3378),v=r(8687);function p(e){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},p(e)}function f(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function g(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?f(Object(r),!0).forEach((function(t){N(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function m(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=b(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r["return"]||r["return"]()}finally{if(a)throw o}}}}function y(e){return _(e)||E(e)||b(e)||S()}function S(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function b(e,t){if(e){if("string"===typeof e)return w(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?w(e,t):void 0}}function E(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _(e){if(Array.isArray(e))return w(e)}function w(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function I(){
/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */
I=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n=Object.defineProperty||function(e,t,r){e[t]=r.value},i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",a=i.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(O){c=function(e,t,r){return e[t]=r}}function l(e,t,r,i){var o=t&&t.prototype instanceof h?t:h,s=Object.create(o.prototype),a=new k(i||[]);return n(s,"_invoke",{value:_(e,r,a)}),s}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(O){return{type:"throw",arg:O}}}e.wrap=l;var u={};function h(){}function v(){}function f(){}var g={};c(g,o,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(A([])));y&&y!==t&&r.call(y,o)&&(g=y);var S=f.prototype=h.prototype=Object.create(g);function b(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function E(e,t){function i(n,o,s,a){var c=d(e[n],e,o);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==p(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){i("next",e,s,a)}),(function(e){i("throw",e,s,a)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return i("throw",e,s,a)}))}a(c.arg)}var o;n(this,"_invoke",{value:function(e,r){function n(){return new t((function(t,n){i(e,r,t,n)}))}return o=o?o.then(n,n):n()}})}function _(e,t,r){var n="suspendedStart";return function(i,o){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw o;return C()}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=w(s,r);if(a){if(a===u)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var c=d(e,t,r);if("normal"===c.type){if(n=r.done?"completed":"suspendedYield",c.arg===u)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n="completed",r.method="throw",r.arg=c.arg)}}}function w(e,t){var r=t.method,n=e.iterator[r];if(void 0===n)return t.delegate=null,"throw"===r&&e.iterator["return"]&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),u;var i=d(n,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,u;var o=i.arg;return o?o.done?(t[e.resultName]=o.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,u):o:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,u)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function A(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return i.next=i}}return{next:C}}function C(){return{value:void 0,done:!0}}return v.prototype=f,n(S,"constructor",{value:f,configurable:!0}),n(f,"constructor",{value:v,configurable:!0}),v.displayName=c(f,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,f):(e.__proto__=f,c(e,a,"GeneratorFunction")),e.prototype=Object.create(S),e},e.awrap=function(e){return{__await:e}},b(E.prototype),c(E.prototype,s,(function(){return this})),e.AsyncIterator=E,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new E(l(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},b(S),c(S,a,"Generator"),c(S,o,(function(){return this})),c(S,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},e.values=A,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return s.type="throw",s.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var o=this.tryEntries[i],s=o.completion;if("root"===o.tryLoc)return n("end");if(o.tryLoc<=this.prev){var a=r.call(o,"catchLoc"),c=r.call(o,"finallyLoc");if(a&&c){if(this.prev<o.catchLoc)return n(o.catchLoc,!0);if(this.prev<o.finallyLoc)return n(o.finallyLoc)}else if(a){if(this.prev<o.catchLoc)return n(o.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return n(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,u):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),u},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),u}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;R(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:A(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),u}},e}function T(e,t,r,n,i,o,s){try{var a=e[o](s),c=a.value}catch(l){return void r(l)}a.done?t(c):Promise.resolve(c).then(n,i)}function R(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function s(e){T(o,n,i,s,a,"next",e)}function a(e){T(o,n,i,s,a,"throw",e)}s(void 0)}))}}function k(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function A(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,B(n.key),n)}}function C(e,t,r){return t&&A(e.prototype,t),r&&A(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function O(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&D(e,t)}function D(e,t){return D=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},D(e,t)}function M(e){var t=U();return function(){var r,n=L(e);if(t){var i=L(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return P(this,r)}}function P(e,t){if(t&&("object"===p(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return x(e)}function x(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function U(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function L(e){return L=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},L(e)}function N(e,t,r){return t=B(t),t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function B(e){var t=K(e,"string");return"symbol"===p(t)?t:String(t)}function K(e,t){if("object"!==p(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==p(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function F(e){var t,r,n,i=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new j(t.call(e));r="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function j(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return j=function(e){this.s=e,this.n=e.next},j.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s["return"];return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s["return"];return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new j(e)}var q=function(e){O(r,e);var t=M(r);function r(e,n,s){var a;if(k(this,r),a=t.call(this),a.widget=e,a.iframe=n,a.driver=s,N(x(a),"transport",void 0),N(x(a),"cachedWidgetVersions",null),N(x(a),"contentLoadedActionSent",!1),N(x(a),"allowedCapabilities",new Set),N(x(a),"allowedEvents",[]),N(x(a),"isStopped",!1),N(x(a),"turnServers",null),N(x(a),"contentLoadedWaitTimer",void 0),N(x(a),"pushRoomStateTasks",new Set),N(x(a),"pushRoomStateResult",new Map),N(x(a),"flushRoomStateTask",null),N(x(a),"viewedRoomId",null),null===n||void 0===n||!n.contentWindow)throw new Error("No iframe supplied");if(!e)throw new Error("Invalid widget");if(!s)throw new Error("Invalid driver");return a.transport=new i.PostmessageTransport(o.WidgetApiDirection.ToWidget,e.id,n.contentWindow,window),a.transport.targetOrigin=e.origin,a.transport.on("message",a.handleMessage.bind(x(a))),n.addEventListener("load",a.onIframeLoad.bind(x(a))),a.transport.start(),a}return C(r,[{key:"hasCapability",value:function(e){return this.allowedCapabilities.has(e)}},{key:"canUseRoomTimeline",value:function(e){return this.hasCapability("org.matrix.msc2762.timeline:".concat(h.Symbols.AnyRoom))||this.hasCapability("org.matrix.msc2762.timeline:".concat(e))}},{key:"canSendRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some((function(r){return r.matchesAsRoomEvent(l.EventDirection.Send,e,t)}))}},{key:"canSendStateEvent",value:function(e,t){return this.allowedEvents.some((function(r){return r.matchesAsStateEvent(l.EventDirection.Send,e,t)}))}},{key:"canSendToDeviceEvent",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsToDeviceEvent(l.EventDirection.Send,e)}))}},{key:"canReceiveRoomEvent",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this.allowedEvents.some((function(r){return r.matchesAsRoomEvent(l.EventDirection.Receive,e,t)}))}},{key:"canReceiveStateEvent",value:function(e,t){return this.allowedEvents.some((function(r){return r.matchesAsStateEvent(l.EventDirection.Receive,e,t)}))}},{key:"canReceiveToDeviceEvent",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsToDeviceEvent(l.EventDirection.Receive,e)}))}},{key:"canReceiveRoomAccountData",value:function(e){return this.allowedEvents.some((function(t){return t.matchesAsRoomAccountData(l.EventDirection.Receive,e)}))}},{key:"stop",value:function(){this.isStopped=!0,this.transport.stop()}},{key:"getWidgetVersions",value:function(){var e=R(I().mark((function e(){var t;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!Array.isArray(this.cachedWidgetVersions)){e.next=2;break}return e.abrupt("return",Promise.resolve(this.cachedWidgetVersions));case 2:return e.prev=2,e.next=5,this.transport.send(s.WidgetApiToWidgetAction.SupportedApiVersions,{});case 5:return t=e.sent,this.cachedWidgetVersions=t.supported_versions,e.abrupt("return",t.supported_versions);case 10:return e.prev=10,e.t0=e["catch"](2),console.warn("non-fatal error getting supported widget versions: ",e.t0),e.abrupt("return",[]);case 14:case"end":return e.stop()}}),e,this,[[2,10]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"beginCapabilities",value:function(){var e,t=this;this.emit("preparing"),this.transport.send(s.WidgetApiToWidgetAction.Capabilities,{}).then((function(r){return e=r.capabilities,t.driver.validateCapabilities(new Set(r.capabilities))})).then((function(r){t.allowCapabilities(y(r),e),t.emit("ready")}))["catch"]((function(e){t.emit("error:preparing",e)}))}},{key:"allowCapabilities",value:function(e,t){var r,n=this;console.log("Widget ".concat(this.widget.id," is allowed capabilities:"),e);var i,o=m(e);try{for(o.s();!(i=o.n()).done;){var c=i.value;this.allowedCapabilities.add(c)}}catch(E){o.e(E)}finally{o.f()}var d=l.WidgetEventCapability.findEventCapabilities(e);(r=this.allowedEvents).push.apply(r,y(d)),this.transport.send(s.WidgetApiToWidgetAction.NotifyCapabilities,{requested:t,approved:Array.from(this.allowedCapabilities)})["catch"]((function(e){console.warn("non-fatal error notifying widget of approved capabilities:",e)})).then((function(){n.emit("capabilitiesNotified")}));var u,v=m(e);try{for(v.s();!(u=v.n()).done;){var p=u.value;if((0,a.isTimelineCapability)(p)){var f=(0,a.getTimelineRoomIDFromCapability)(p);if(f===h.Symbols.AnyRoom){var g,S=m(this.driver.getKnownRooms());try{for(S.s();!(g=S.n()).done;){var b=g.value;this.pushRoomState(b)}}catch(E){S.e(E)}finally{S.f()}}else this.pushRoomState(f)}}}catch(E){v.e(E)}finally{v.f()}d.length>0&&null!==this.viewedRoomId&&!this.canUseRoomTimeline(this.viewedRoomId)&&this.pushRoomState(this.viewedRoomId)}},{key:"onIframeLoad",value:function(e){this.widget.waitForIframeLoad?this.beginCapabilities():(console.log("waitForIframeLoad is false: waiting for widget to send contentLoaded"),this.contentLoadedWaitTimer=setTimeout((function(){console.error("Widget specified waitForIframeLoad=false but timed out waiting for contentLoaded event!")}),1e4),this.contentLoadedActionSent=!1)}},{key:"handleContentLoadedAction",value:function(e){if(void 0!==this.contentLoadedWaitTimer&&(clearTimeout(this.contentLoadedWaitTimer),this.contentLoadedWaitTimer=void 0),this.contentLoadedActionSent)throw new Error("Improper sequence: ContentLoaded Action can only be sent once after the widget loaded and should only be used if waitForIframeLoad is false (default=true)");this.widget.waitForIframeLoad?this.transport.reply(e,{error:{message:"Improper sequence: not expecting ContentLoaded event if waitForIframeLoad is true (default=true)"}}):(this.transport.reply(e,{}),this.beginCapabilities()),this.contentLoadedActionSent=!0}},{key:"replyVersions",value:function(e){this.transport.reply(e,{supported_versions:c.CurrentApiVersions})}},{key:"supportsUpdateState",value:function(){var e=R(I().mark((function e(){return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,this.getWidgetVersions();case 2:return e.abrupt("return",e.sent.includes(c.UnstableApiVersion.MSC2762_UPDATE_STATE));case 3:case"end":return e.stop()}}),e,this)})));function t(){return e.apply(this,arguments)}return t}()},{key:"handleCapabilitiesRenegotiate",value:function(e){var t,r=this;this.transport.reply(e,{});var n=(null===(t=e.data)||void 0===t?void 0:t.capabilities)||[],i=new Set(n.filter((function(e){return!r.hasCapability(e)})));0===i.size&&this.allowCapabilities([],[]),this.driver.validateCapabilities(i).then((function(e){return r.allowCapabilities(y(e),y(i))}))}},{key:"handleNavigate",value:function(e){var t,r,n=this;if(!this.hasCapability(a.MatrixCapabilities.MSC2931Navigate))return this.transport.reply(e,{error:{message:"Missing capability"}});if(null===(t=e.data)||void 0===t||!t.uri||null===(r=e.data)||void 0===r||!r.uri.toString().startsWith("https://matrix.to/#"))return this.transport.reply(e,{error:{message:"Invalid matrix.to URI"}});var i=function(t){console.error("[ClientWidgetApi] Failed to handle navigation: ",t),n.handleDriverError(t,e,"Error handling navigation")};try{this.driver.navigate(e.data.uri.toString())["catch"]((function(e){return i(e)})).then((function(){return n.transport.reply(e,{})}))}catch(o){return i(o)}}},{key:"handleOIDC",value:function(e){var t=this,r=1,n=function(n,i){return i=i||{},r>1?t.transport.send(s.WidgetApiToWidgetAction.OpenIDCredentials,g({state:n,original_request_id:e.requestId},i)):t.transport.reply(e,g({state:n},i))},i=function(i){return console.error("[ClientWidgetApi] Failed to handle OIDC: ",i),r>1?n(d.OpenIDRequestState.Blocked):t.transport.reply(e,{error:{message:i}})},o=new u.SimpleObservable((function(e){return e.state===d.OpenIDRequestState.PendingUserConfirmation&&r>1?(o.close(),i("client provided out-of-phase response to OIDC flow")):e.state===d.OpenIDRequestState.PendingUserConfirmation?(n(e.state),void r++):e.state!==d.OpenIDRequestState.Allowed||e.token?(e.state===d.OpenIDRequestState.Blocked&&(e.token=void 0),o.close(),n(e.state,e.token)):i("client provided invalid OIDC token for an allowed request")}));this.driver.askOpenID(o)}},{key:"handleReadRoomAccountData",value:function(e){var t=this,r=Promise.resolve([]);return r=this.driver.readRoomAccountData(e.data.type),this.canReceiveRoomAccountData(e.data.type)?r.then((function(r){t.transport.reply(e,{events:r})})):this.transport.reply(e,{error:{message:"Cannot read room account data of this type"}})}},{key:"handleReadEvents",value:function(){var e=R(I().mark((function e(t){var r,n,i,o,s,a,c,l,d,u,v=this;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.data.type){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event type"}}));case 2:if(void 0===t.data.limit||t.data.limit&&!(t.data.limit<0)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(void 0!==t.data.room_ids){e.next=8;break}r=null===this.viewedRoomId?[]:[this.viewedRoomId],e.next=30;break;case 8:if(t.data.room_ids!==h.Symbols.AnyRoom){e.next=12;break}r=this.driver.getKnownRooms().filter((function(e){return v.canUseRoomTimeline(e)})),e.next=30;break;case 12:r=t.data.room_ids,n=m(r),e.prev=14,n.s();case 16:if((i=n.n()).done){e.next=22;break}if(o=i.value,this.canUseRoomTimeline(o)){e.next=20;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(o)}}));case 20:e.next=16;break;case 22:e.next=27;break;case 24:e.prev=24,e.t0=e["catch"](14),n.e(e.t0);case 27:return e.prev=27,n.f(),e.finish(27);case 30:if(s=t.data.limit||0,a=t.data.since,c=void 0,l=void 0,void 0===t.data.state_key){e.next=40;break}if(c=!0===t.data.state_key?void 0:t.data.state_key.toString(),this.canReceiveStateEvent(t.data.type,null!==(d=c)&&void 0!==d?d:null)){e.next=38;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Cannot read state events of this type"}}));case 38:e.next=43;break;case 40:if(l=t.data.msgtype,this.canReceiveRoomEvent(t.data.type,l)){e.next=43;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Cannot read room events of this type"}}));case 43:if(void 0!==t.data.room_ids||0!==r.length){e.next=50;break}return console.warn("The widgetDriver uses deprecated behaviour:\n It does not set the viewedRoomId using `setViewedRoomId`"),e.next=47,void 0===t.data.state_key?this.driver.readRoomEvents(t.data.type,l,s,null,a):this.driver.readStateEvents(t.data.type,c,s,null);case 47:u=e.sent,e.next=68;break;case 50:return e.next=52,this.supportsUpdateState();case 52:if(!e.sent){e.next=58;break}return e.next=55,Promise.all(r.map((function(e){return v.driver.readRoomTimeline(e,t.data.type,l,c,s,a)})));case 55:u=e.sent.flat(1),e.next=68;break;case 58:if(void 0!==t.data.state_key){e.next=64;break}return e.next=61,Promise.all(r.map((function(e){return v.driver.readRoomTimeline(e,t.data.type,l,c,s,a)})));case 61:e.t1=e.sent,e.next=67;break;case 64:return e.next=66,Promise.all(r.map((function(e){return v.driver.readRoomState(e,t.data.type,c)})));case 66:e.t1=e.sent;case 67:u=e.t1.flat(1);case 68:this.transport.reply(t,{events:u});case 69:case"end":return e.stop()}}),e,this,[[14,24,27,30]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleSendEvent",value:function(e){var t=this;if(!e.data.type)return this.transport.reply(e,{error:{message:"Invalid request - missing event type"}});if(e.data.room_id&&!this.canUseRoomTimeline(e.data.room_id))return this.transport.reply(e,{error:{message:"Unable to access room timeline: ".concat(e.data.room_id)}});var r,n=void 0!==e.data.delay||void 0!==e.data.parent_delay_id;if(n&&!this.hasCapability(a.MatrixCapabilities.MSC4157SendDelayedEvent))return this.transport.reply(e,{error:{message:"Missing capability"}});if(void 0!==e.data.state_key){if(!this.canSendStateEvent(e.data.type,e.data.state_key))return this.transport.reply(e,{error:{message:"Cannot send state events of this type"}});var i,o;if(n)r=this.driver.sendDelayedEvent(null!==(i=e.data.delay)&&void 0!==i?i:null,null!==(o=e.data.parent_delay_id)&&void 0!==o?o:null,e.data.type,e.data.content||{},e.data.state_key,e.data.room_id);else r=this.driver.sendEvent(e.data.type,e.data.content||{},e.data.state_key,e.data.room_id)}else{var s,c,l=e.data.content||{},d=l["msgtype"];if(!this.canSendRoomEvent(e.data.type,d))return this.transport.reply(e,{error:{message:"Cannot send room events of this type"}});if(n)r=this.driver.sendDelayedEvent(null!==(s=e.data.delay)&&void 0!==s?s:null,null!==(c=e.data.parent_delay_id)&&void 0!==c?c:null,e.data.type,l,null,e.data.room_id);else r=this.driver.sendEvent(e.data.type,l,null,e.data.room_id)}r.then((function(r){return t.transport.reply(e,g({room_id:r.roomId},"eventId"in r?{event_id:r.eventId}:{delay_id:r.delayId}))}))["catch"]((function(r){console.error("error sending event: ",r),t.handleDriverError(r,e,"Error sending event")}))}},{key:"handleUpdateDelayedEvent",value:function(e){var t=this;if(!e.data.delay_id)return this.transport.reply(e,{error:{message:"Invalid request - missing delay_id"}});if(!this.hasCapability(a.MatrixCapabilities.MSC4157UpdateDelayedEvent))return this.transport.reply(e,{error:{message:"Missing capability"}});switch(e.data.action){case v.UpdateDelayedEventAction.Cancel:case v.UpdateDelayedEventAction.Restart:case v.UpdateDelayedEventAction.Send:this.driver.updateDelayedEvent(e.data.delay_id,e.data.action).then((function(){return t.transport.reply(e,{})}))["catch"]((function(r){console.error("error updating delayed event: ",r),t.handleDriverError(r,e,"Error updating delayed event")}));break;default:return this.transport.reply(e,{error:{message:"Invalid request - unsupported action"}})}}},{key:"handleSendToDevice",value:function(){var e=R(I().mark((function e(t){return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.data.type){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Invalid request - missing event type"}});case 3:e.next=31;break;case 5:if(t.data.messages){e.next=10;break}return e.next=8,this.transport.reply(t,{error:{message:"Invalid request - missing event contents"}});case 8:e.next=31;break;case 10:if("boolean"===typeof t.data.encrypted){e.next=15;break}return e.next=13,this.transport.reply(t,{error:{message:"Invalid request - missing encryption flag"}});case 13:e.next=31;break;case 15:if(this.canSendToDeviceEvent(t.data.type)){e.next=20;break}return e.next=18,this.transport.reply(t,{error:{message:"Cannot send to-device events of this type"}});case 18:e.next=31;break;case 20:return e.prev=20,e.next=23,this.driver.sendToDevice(t.data.type,t.data.encrypted,t.data.messages);case 23:return e.next=25,this.transport.reply(t,{});case 25:e.next=31;break;case 27:e.prev=27,e.t0=e["catch"](20),console.error("error sending to-device event",e.t0),this.handleDriverError(e.t0,t,"Error sending event");case 31:case"end":return e.stop()}}),e,this,[[20,27]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"pollTurnServers",value:function(){var e=R(I().mark((function e(t,r){var n,i,o,a,c,l;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.transport.send(s.WidgetApiToWidgetAction.UpdateTurnServers,r);case 3:n=!1,i=!1,e.prev=5,a=F(t);case 7:return e.next=9,a.next();case 9:if(!(n=!(c=e.sent).done)){e.next=16;break}return l=c.value,e.next=13,this.transport.send(s.WidgetApiToWidgetAction.UpdateTurnServers,l);case 13:n=!1,e.next=7;break;case 16:e.next=22;break;case 18:e.prev=18,e.t0=e["catch"](5),i=!0,o=e.t0;case 22:if(e.prev=22,e.prev=23,!n||null==a["return"]){e.next=27;break}return e.next=27,a["return"]();case 27:if(e.prev=27,!i){e.next=30;break}throw o;case 30:return e.finish(27);case 31:return e.finish(22);case 32:e.next=37;break;case 34:e.prev=34,e.t1=e["catch"](0),console.error("error polling for TURN servers",e.t1);case 37:case"end":return e.stop()}}),e,this,[[0,34],[5,18,22,32],[23,,27,31]])})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"handleWatchTurnServers",value:function(){var e=R(I().mark((function e(t){var r,n,i,o;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:e.next=30;break;case 5:if(!this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 8:e.next=30;break;case 10:return e.prev=10,r=this.driver.getTurnServers(),e.next=14,r.next();case 14:if(n=e.sent,i=n.done,o=n.value,!i){e.next=19;break}throw new Error("Client refuses to provide any TURN servers");case 19:return e.next=21,this.transport.reply(t,{});case 21:this.pollTurnServers(r,o),this.turnServers=r,e.next=30;break;case 25:return e.prev=25,e.t0=e["catch"](10),console.error("error getting first TURN server results",e.t0),e.next=30,this.transport.reply(t,{error:{message:"TURN servers not available"}});case 30:case"end":return e.stop()}}),e,this,[[10,25]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleUnwatchTurnServers",value:function(){var e=R(I().mark((function e(t){return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3846TurnServers)){e.next=5;break}return e.next=3,this.transport.reply(t,{error:{message:"Missing capability"}});case 3:e.next=15;break;case 5:if(this.turnServers){e.next=10;break}return e.next=8,this.transport.reply(t,{});case 8:e.next=15;break;case 10:return e.next=12,this.turnServers["return"](void 0);case 12:return this.turnServers=null,e.next=15,this.transport.reply(t,{});case 15:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleReadRelations",value:function(){var e=R(I().mark((function e(t){var r,n,i=this;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.data.event_id){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing event ID"}}));case 2:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 4:if(void 0===t.data.room_id||this.canUseRoomTimeline(t.data.room_id)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Unable to access room timeline: ".concat(t.data.room_id)}}));case 6:return e.prev=6,e.next=9,this.driver.readEventRelations(t.data.event_id,t.data.room_id,t.data.rel_type,t.data.event_type,t.data.from,t.data.to,t.data.limit,t.data.direction);case 9:return r=e.sent,n=r.chunk.filter((function(e){return void 0!==e.state_key?i.canReceiveStateEvent(e.type,e.state_key):i.canReceiveRoomEvent(e.type,e.content["msgtype"])})),e.abrupt("return",this.transport.reply(t,{chunk:n,prev_batch:r.prevBatch,next_batch:r.nextBatch}));case 14:e.prev=14,e.t0=e["catch"](6),console.error("error getting the relations",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while reading relations");case 18:case"end":return e.stop()}}),e,this,[[6,14]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleUserDirectorySearch",value:function(){var e=R(I().mark((function e(t){var r;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC3973UserDirectorySearch)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:if("string"===typeof t.data.search_term){e.next=4;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - missing search term"}}));case 4:if(!(void 0!==t.data.limit&&t.data.limit<0)){e.next=6;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Invalid request - limit out of range"}}));case 6:return e.prev=6,e.next=9,this.driver.searchUserDirectory(t.data.search_term,t.data.limit);case 9:return r=e.sent,e.abrupt("return",this.transport.reply(t,{limited:r.limited,results:r.results.map((function(e){return{user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl}}))}));case 13:e.prev=13,e.t0=e["catch"](6),console.error("error searching in the user directory",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while searching in the user directory");case 17:case"end":return e.stop()}}),e,this,[[6,13]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleGetMediaConfig",value:function(){var e=R(I().mark((function e(t){var r;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.getMediaConfig();case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,r));case 9:e.prev=9,e.t0=e["catch"](2),console.error("error while getting the media configuration",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while getting the media configuration");case 13:case"end":return e.stop()}}),e,this,[[2,9]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleUploadFile",value:function(){var e=R(I().mark((function e(t){var r;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039UploadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.uploadFile(t.data.file);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{content_uri:r.contentUri}));case 9:e.prev=9,e.t0=e["catch"](2),console.error("error while uploading a file",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while uploading a file");case 13:case"end":return e.stop()}}),e,this,[[2,9]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleDownloadFile",value:function(){var e=R(I().mark((function e(t){var r;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(this.hasCapability(a.MatrixCapabilities.MSC4039DownloadFile)){e.next=2;break}return e.abrupt("return",this.transport.reply(t,{error:{message:"Missing capability"}}));case 2:return e.prev=2,e.next=5,this.driver.downloadFile(t.data.content_uri);case 5:return r=e.sent,e.abrupt("return",this.transport.reply(t,{file:r.file}));case 9:e.prev=9,e.t0=e["catch"](2),console.error("error while downloading a file",e.t0),this.handleDriverError(e.t0,t,"Unexpected error while downloading a file");case 13:case"end":return e.stop()}}),e,this,[[2,9]])})));function t(t){return e.apply(this,arguments)}return t}()},{key:"handleDriverError",value:function(e,t,r){var n=this.driver.processError(e);this.transport.reply(t,{error:g({message:r},n)})}},{key:"handleMessage",value:function(e){if(!this.isStopped){var t=new CustomEvent("action:".concat(e.detail.action),{detail:e.detail,cancelable:!0});if(this.emit("action:".concat(e.detail.action),t),!t.defaultPrevented)switch(e.detail.action){case s.WidgetApiFromWidgetAction.ContentLoaded:return this.handleContentLoadedAction(e.detail);case s.WidgetApiFromWidgetAction.SupportedApiVersions:return this.replyVersions(e.detail);case s.WidgetApiFromWidgetAction.SendEvent:return this.handleSendEvent(e.detail);case s.WidgetApiFromWidgetAction.SendToDevice:return this.handleSendToDevice(e.detail);case s.WidgetApiFromWidgetAction.GetOpenIDCredentials:return this.handleOIDC(e.detail);case s.WidgetApiFromWidgetAction.MSC2931Navigate:return this.handleNavigate(e.detail);case s.WidgetApiFromWidgetAction.MSC2974RenegotiateCapabilities:return this.handleCapabilitiesRenegotiate(e.detail);case s.WidgetApiFromWidgetAction.MSC2876ReadEvents:return this.handleReadEvents(e.detail);case s.WidgetApiFromWidgetAction.WatchTurnServers:return this.handleWatchTurnServers(e.detail);case s.WidgetApiFromWidgetAction.UnwatchTurnServers:return this.handleUnwatchTurnServers(e.detail);case s.WidgetApiFromWidgetAction.MSC3869ReadRelations:return this.handleReadRelations(e.detail);case s.WidgetApiFromWidgetAction.MSC3973UserDirectorySearch:return this.handleUserDirectorySearch(e.detail);case s.WidgetApiFromWidgetAction.BeeperReadRoomAccountData:return this.handleReadRoomAccountData(e.detail);case s.WidgetApiFromWidgetAction.MSC4039GetMediaConfigAction:return this.handleGetMediaConfig(e.detail);case s.WidgetApiFromWidgetAction.MSC4039UploadFileAction:return this.handleUploadFile(e.detail);case s.WidgetApiFromWidgetAction.MSC4039DownloadFileAction:return this.handleDownloadFile(e.detail);case s.WidgetApiFromWidgetAction.MSC4157UpdateDelayedEvent:return this.handleUpdateDelayedEvent(e.detail);default:return this.transport.reply(e.detail,{error:{message:"Unknown or unsupported action: "+e.detail.action}})}}}},{key:"updateTheme",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.ThemeChange,e)}},{key:"updateLanguage",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.LanguageChange,{lang:e})}},{key:"takeScreenshot",value:function(){return this.transport.send(s.WidgetApiToWidgetAction.TakeScreenshot,{})}},{key:"updateVisibility",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.UpdateVisibility,{visible:e})}},{key:"sendWidgetConfig",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.WidgetConfig,e).then()}},{key:"notifyModalWidgetButtonClicked",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.ButtonClicked,{id:e}).then()}},{key:"notifyModalWidgetClose",value:function(e){return this.transport.send(s.WidgetApiToWidgetAction.CloseModalWidget,e).then()}},{key:"feedEvent",value:function(){var e=R(I().mark((function e(t,r){var n;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(void 0!==r&&this.setViewedRoomId(r),t.room_id===this.viewedRoomId||this.canUseRoomTimeline(t.room_id)){e.next=3;break}return e.abrupt("return");case 3:if(void 0===t.state_key||null===t.state_key){e.next=8;break}if(this.canReceiveStateEvent(t.type,t.state_key)){e.next=6;break}return e.abrupt("return");case 6:e.next=10;break;case 8:if(this.canReceiveRoomEvent(t.type,null===(n=t.content)||void 0===n?void 0:n["msgtype"])){e.next=10;break}return e.abrupt("return");case 10:return e.next=12,this.transport.send(s.WidgetApiToWidgetAction.SendEvent,t);case 12:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"feedToDevice",value:function(){var e=R(I().mark((function e(t,r){return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!this.canReceiveToDeviceEvent(t.type)){e.next=3;break}return e.next=3,this.transport.send(s.WidgetApiToWidgetAction.SendToDevice,g(g({},t),{},{encrypted:r}));case 3:case"end":return e.stop()}}),e,this)})));function t(t,r){return e.apply(this,arguments)}return t}()},{key:"setViewedRoomId",value:function(e){this.viewedRoomId=e,null===e||this.canUseRoomTimeline(e)||this.pushRoomState(e)}},{key:"flushRoomState",value:function(){var e=R(I().mark((function e(){var t,r,n,i,o,a,l;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:e.prev=0;case 1:return e.next=3,Promise.all(y(this.pushRoomStateTasks));case 3:if(this.pushRoomStateTasks.size>0){e.next=1;break}case 4:t=[],r=m(this.pushRoomStateResult.values());try{for(r.s();!(n=r.n()).done;){i=n.value,o=m(i.values());try{for(o.s();!(a=o.n()).done;)l=a.value,t.push.apply(t,y(l.values()))}catch(d){o.e(d)}finally{o.f()}}}catch(d){r.e(d)}finally{r.f()}return e.next=9,this.getWidgetVersions();case 9:if(!e.sent.includes(c.UnstableApiVersion.MSC2762_UPDATE_STATE)){e.next=12;break}return e.next=12,this.transport.send(s.WidgetApiToWidgetAction.UpdateState,{state:t});case 12:return e.prev=12,this.flushRoomStateTask=null,e.finish(12);case 15:case"end":return e.stop()}}),e,this,[[0,,12,15]])})));function t(){return e.apply(this,arguments)}return t}()},{key:"pushRoomState",value:function(e){var t,r=this,n=m(this.allowedEvents);try{var i=function(){var n=t.value;if(n.kind===l.EventKind.State&&n.direction===l.EventDirection.Receive){var i,o,s=r.driver.readRoomState(e,n.eventType,null!==(i=n.keyStr)&&void 0!==i?i:void 0),a=s.then((function(t){var i,o=m(t);try{for(o.s();!(i=o.n()).done;){var s=i.value,a=r.pushRoomStateResult.get(e);void 0===a&&(a=new Map,r.pushRoomStateResult.set(e,a));var c=a.get(n.eventType);void 0===c&&(c=new Map,a.set(n.eventType,c)),c.has(s.state_key)||c.set(s.state_key,s)}}catch(l){o.e(l)}finally{o.f()}}),(function(t){return console.error("Failed to read room state for ".concat(e," (").concat(n.eventType,", ").concat(n.keyStr,")"),t)})).then((function(){r.pushRoomStateTasks["delete"](a)}));r.pushRoomStateTasks.add(a),null!==(o=r.flushRoomStateTask)&&void 0!==o||(r.flushRoomStateTask=r.flushRoomState()),r.flushRoomStateTask["catch"]((function(e){return console.error("Failed to push room state",e)}))}};for(n.s();!(t=n.n()).done;)i()}catch(o){n.e(o)}finally{n.f()}}},{key:"feedStateUpdate",value:function(){var e=R(I().mark((function e(t){var r,n;return I().wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(void 0!==t.state_key){e.next=2;break}throw new Error("Not a state event");case 2:if(t.room_id!==this.viewedRoomId&&!this.canUseRoomTimeline(t.room_id)||!this.canReceiveStateEvent(t.type,t.state_key)){e.next=21;break}if(0!==this.pushRoomStateTasks.size){e.next=11;break}return e.next=6,this.getWidgetVersions();case 6:if(!e.sent.includes(c.UnstableApiVersion.MSC2762_UPDATE_STATE)){e.next=9;break}return e.next=9,this.transport.send(s.WidgetApiToWidgetAction.UpdateState,{state:[t]});case 9:e.next=21;break;case 11:r=this.pushRoomStateResult.get(t.room_id),void 0===r&&(r=new Map,this.pushRoomStateResult.set(t.room_id,r)),n=r.get(t.type),void 0===n&&(n=new Map,r.set(t.type,n)),n.has(t.type)||n.set(t.state_key,t);case 16:return e.next=18,Promise.all(y(this.pushRoomStateTasks));case 18:if(this.pushRoomStateTasks.size>0){e.next=16;break}case 19:return e.next=21,this.flushRoomStateTask;case 21:case"end":return e.stop()}}),e,this)})));function t(t){return e.apply(this,arguments)}return t}()}]),r}(n.EventEmitter);t.ClientWidgetApi=q},6255:function(e,t,r){"use strict";r.d(t,{e:function(){return n}});var n=function(e){return e["Cancel"]="cancel",e["Restart"]="restart",e["Send"]="send",e}({})},6269:function(e){"use strict";e.exports={}},6279:function(e,t,r){"use strict";var n=r(6840);e.exports=function(e,t,r){for(var i in t)n(e,i,t[i],r);return e}},6288:function(e,t){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function n(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&i(e,t)}function i(e,t){return i=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},i(e,t)}function o(e){var t=c();return function(){var r,n=l(e);if(t){var i=l(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return s(this,r)}}function s(e,t){if(t&&("object"===r(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return a(e)}function a(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function d(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function h(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableValue=t.NamespacedValue=void 0;var v=function(){function e(t,r){if(d(this,e),this.stable=t,this.unstable=r,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}return h(e,[{key:"name",get:function(){return this.stable?this.stable:this.unstable}},{key:"altName",get:function(){return this.stable?this.unstable:null}},{key:"matches",value:function(e){return!!this.name&&this.name===e||!!this.altName&&this.altName===e}},{key:"findIn",value:function(e){var t;return this.name&&(t=null===e||void 0===e?void 0:e[this.name]),!t&&this.altName&&(t=null===e||void 0===e?void 0:e[this.altName]),t}},{key:"includedIn",value:function(e){var t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}]),e}();t.NamespacedValue=v;var p=function(e){n(r,e);var t=o(r);function r(e,n){var i;if(d(this,r),i=t.call(this,e,n),!i.unstable)throw new Error("Unstable value must be supplied");return i}return h(r,[{key:"name",get:function(){return this.unstable}},{key:"altName",get:function(){return this.stable}}]),r}(v);t.UnstableValue=p},6317:function(e,t,r){"use strict";r.d(t,{HY:function(){return o},cQ:function(){return s},ns:function(){return i}});r(4114),r(8111),r(2489),r(7588),r(1701),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698),r(698),r(4761),r(3271);var n=r(2668);r(6170);var i=function(e){return e["RequestFinished"]="FINISHED",e["Complete"]="COMPLETE",e}({});var o=function(e){return e["PreProcess"]="ExtState.PreProcess",e["PostProcess"]="ExtState.PostProcess",e}({}),s=function(e){return e["RoomData"]="SlidingSync.RoomData",e["Lifecycle"]="SlidingSync.Lifecycle",e["List"]="SlidingSync.List",e}({});n.X},6319:function(e,t,r){"use strict";var n=r(8551),i=r(9539);e.exports=function(e,t,r,o){try{return o?t(n(r)[0],r[1]):t(r)}catch(s){i(e,"throw",s)}}},6327:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OpenIDRequestState=void 0;var r=function(e){return e["Allowed"]="allowed",e["Blocked"]="blocked",e["PendingUserConfirmation"]="request",e}({});t.OpenIDRequestState=r},6330:function(e,t,r){"use strict";r.d(t,{e:function(){return h},o:function(){return u}});r(8111),r(116);var n=r(698),i=r(4761),o=r(4108),s=r(4768),a=r(4123),c=r(3271),l=r(5629),d=r(1212),u=function(e){return e["Incoming"]="GroupCall.incoming",e["Outgoing"]="GroupCall.outgoing",e["Ended"]="GroupCall.ended",e["Participants"]="GroupCall.participants",e}({});class h{constructor(e){this.client=e,(0,i.A)(this,"groupCalls",new Map),(0,i.A)(this,"roomDeferreds",new Map),(0,i.A)(this,"onRoomsChanged",(e=>{this.createGroupCallForRoom(e)})),(0,i.A)(this,"onRoomStateChanged",((e,t)=>{var r=e.getType();if(r===l.Bx.GroupCallPrefix){var n=e.getStateKey(),i=e.getContent(),o=this.groupCalls.get(t.roomId);o||i["m.terminated"]||e.isRedacted()?o&&o.groupCallId===n?i["m.terminated"]||e.isRedacted()?o.terminate(!1):i["m.type"]!==o.type&&c.v.warn("GroupCallEventHandler onRoomStateChanged() currently does not support changing type (roomId=".concat(t.roomId,")")):o&&o.groupCallId!==n&&c.v.warn("GroupCallEventHandler onRoomStateChanged() currently does not support multiple calls (roomId=".concat(t.roomId,")")):this.createGroupCallFromRoomStateEvent(e)}}))}start(){var e=this;return(0,n.A)((function*(){e.client.getSyncState()!==d.Lm.Syncing&&(c.v.debug("GroupCallEventHandler start() waiting for client to start syncing"),yield new Promise((t=>{var r=()=>{if(e.client.getSyncState()===d.Lm.Syncing)return e.client.off(o.AU.Sync,r),t()};e.client.on(o.AU.Sync,r)})));var t=e.client.getRooms();for(var r of t)e.createGroupCallForRoom(r);e.client.on(o.AU.Room,e.onRoomsChanged),e.client.on(a.f.Events,e.onRoomStateChanged)}))()}stop(){this.client.removeListener(o.AU.Room,this.onRoomsChanged),this.client.removeListener(a.f.Events,this.onRoomStateChanged)}getRoomDeferred(e){var t,r=this.roomDeferreds.get(e);void 0===r&&(r={prom:new Promise((e=>{t=e}))},r.resolve=t,this.roomDeferreds.set(e,r));return r}waitUntilRoomReadyForGroupCalls(e){return this.getRoomDeferred(e).prom}getGroupCallById(e){return[...this.groupCalls.values()].find((t=>t.groupCallId===e))}createGroupCallForRoom(e){var t=e.currentState.getStateEvents(l.Bx.GroupCallPrefix),r=t.sort(((e,t)=>t.getTs()-e.getTs()));for(var n of r){var i=n.getContent();if(!i["m.terminated"]&&!n.isRedacted()){c.v.debug("GroupCallEventHandler createGroupCallForRoom() choosing group call from possible calls (stateKey=".concat(n.getStateKey(),", ts=").concat(n.getTs(),", roomId=").concat(e.roomId,", numOfPossibleCalls=").concat(t.length,")")),this.createGroupCallFromRoomStateEvent(n);break}}this.getRoomDeferred(e.roomId).resolve()}createGroupCallFromRoomStateEvent(e){var t=e.getRoomId(),r=e.getContent(),n=this.client.getRoom(t);if(n){var i=e.getStateKey(),o=r["m.type"];if(Object.values(s.Ad).includes(o)){var a=r["m.intent"];if(Object.values(s.MC).includes(a)){var l,d=Boolean(r["io.element.ptt"]);if(null!==r&&void 0!==r&&r.dataChannelsEnabled&&null!==r&&void 0!==r&&r.dataChannelOptions){var{ordered:h,maxPacketLifeTime:v,maxRetransmits:p,protocol:f}=r.dataChannelOptions;l={ordered:h,maxPacketLifeTime:v,maxRetransmits:p,protocol:f}}var g=new s.eO(this.client,n,o,d,a,i,(null===r||void 0===r?void 0:r.dataChannelsEnabled)||this.client.isVoipWithNoMediaAllowed,l,this.client.isVoipWithNoMediaAllowed,this.client.useLivekitForGroupCalls,r["io.element.livekit_service_url"]);return this.groupCalls.set(n.roomId,g),this.client.emit(u.Incoming,g),g}c.v.warn("Received invalid group call intent (type=".concat(o,", roomId=").concat(t,")"))}else c.v.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() received invalid call type (type=".concat(o,", roomId=").concat(t,")"))}else c.v.warn("GroupCallEventHandler createGroupCallFromRoomStateEvent() couldn't find room for call (roomId=".concat(t,")"))}}},6331:function(e,t){"use strict";function r(e,t,r){for(var i=Object.assign({},t.data,{matrix_room_id:r.widgetRoomId||"",matrix_user_id:r.currentUserId,matrix_display_name:r.userDisplayName||r.currentUserId,matrix_avatar_url:r.userHttpAvatarUrl||"",matrix_widget_id:t.id,"org.matrix.msc2873.client_id":r.clientId||"","org.matrix.msc2873.client_theme":r.clientTheme||"","org.matrix.msc2873.client_language":r.clientLanguage||"","org.matrix.msc3819.matrix_device_id":r.deviceId||"","org.matrix.msc4039.matrix_base_url":r.baseUrl||""}),o=e,s=0,a=Object.keys(i);s<a.length;s++){var c=a[s],l="$".concat(c).replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=new RegExp(l,"g");o=o.replace(d,encodeURIComponent(n(i[c])))}return o}function n(e){return null===e||void 0===e?"".concat(e):String(e)}Object.defineProperty(t,"__esModule",{value:!0}),t.runTemplate=r,t.toString=n},6337:function(e,t,r){"use strict";r.d(t,{Jo:function(){return a},NG:function(){return o},Q5:function(){return s},fx:function(){return i}});var n=r(7046),i=new n.UnstableValue("m.policies","org.matrix.msc3847.policies"),o=new n.UnstableValue("m.ignore.invites","org.matrix.msc3847.ignore.invites"),s=function(e){return e["Ban"]="m.ban",e}({}),a=function(e){return e["User"]="m.policy.user",e["Room"]="m.policy.room",e["Server"]="m.policy.server",e}({})},6395:function(e){"use strict";e.exports=!1},6469:function(e,t,r){"use strict";var n=r(8227),i=r(2360),o=r(4913).f,s=n("unscopables"),a=Array.prototype;void 0===a[s]&&o(a,s,{configurable:!0,value:i(null)}),e.exports=function(e){a[s][e]=!0}},6483:function(e,t,r){"use strict";r.d(t,{d:function(){return u}});r(4114),r(8111),r(2489),r(7588);var n=r(4761),i=r(7430),o=(r(1148),r(3579),r(7528));function s(e,t){if(t.endsWith("*")){var r=t.slice(0,-1);return e.slice(0,r.length)===r}return e===t}class a{constructor(e,t){this.filterJson=e,this.userId=t}check(e){var t,r,n=(null===(t=e.getUnsigned())||void 0===t?void 0:t["m.relations"])||{},i=Object.keys(n),s=[];return this.userId&&null!==n&&void 0!==n&&null!==(r=n[o.RN.name])&&void 0!==r&&r.current_user_participated&&s.push(this.userId),this.checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url,i,s)}toJSON(){return{types:this.filterJson.types||null,not_types:this.filterJson.not_types||[],rooms:this.filterJson.rooms||null,not_rooms:this.filterJson.not_rooms||[],senders:this.filterJson.senders||null,not_senders:this.filterJson.not_senders||[],contains_url:this.filterJson.contains_url||null,[o.o1.name]:this.filterJson[o.o1.name]||[],[o.H.name]:this.filterJson[o.H.name]||[]}}checkFields(e,t,r,n,i,a){var c={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return s(r,e)}};for(var l in c){var d=c[l],u="not_"+l,h=this.filterJson[u];if(null!==h&&void 0!==h&&h.some(d))return!1;var v=this.filterJson[l];if(v&&!v.some(d))return!1}var p=this.filterJson.contains_url;if(void 0!==p&&p!==n)return!1;var f=this.filterJson[o.H.name];if(void 0!==f&&!this.arrayMatchesFilter(f,i))return!1;var g=this.filterJson[o.o1.name];return!(void 0!==g&&!this.arrayMatchesFilter(g,a))}arrayMatchesFilter(e,t){return t.length>0&&e.every((e=>t.includes(e)))}filter(e){return e.filter(this.check,this)}limit(){return void 0!==this.filterJson.limit?this.filterJson.limit:10}}function c(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function l(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?c(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):c(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function d(e,t,r){for(var n=t.split("."),i=e,o=0;o<n.length-1;o++)i[n[o]]||(i[n[o]]={}),i=i[n[o]];i[n[n.length-1]]=r}class u{static fromJson(e,t,r){var n=new u(e,t);return n.setDefinition(r),n}constructor(e,t){this.userId=e,this.filterId=t,(0,n.A)(this,"definition",{}),(0,n.A)(this,"roomFilter",void 0),(0,n.A)(this,"roomTimelineFilter",void 0)}getFilterId(){return this.filterId}getDefinition(){return this.definition}setDefinition(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms)),this.roomFilter=new a(r,this.userId),this.roomTimelineFilter=new a((null===t||void 0===t?void 0:t.timeline)||{},this.userId)}getRoomTimelineFilterComponent(){return this.roomTimelineFilter}filterRoomTimeline(e){return this.roomFilter&&(e=this.roomFilter.filter(e)),this.roomTimelineFilter&&(e=this.roomTimelineFilter.filter(e)),e}setTimelineLimit(e){d(this.definition,"room.timeline.limit",e)}setUnreadThreadNotifications(e){var t,r;this.definition=l(l({},this.definition),{},{room:l(l({},null===(t=this.definition)||void 0===t?void 0:t.room),{},{timeline:l(l({},null===(r=this.definition)||void 0===r||null===(r=r.room)||void 0===r?void 0:r.timeline),{},{[i.a.name]:e})})})}setLazyLoadMembers(e){d(this.definition,"room.state.lazy_load_members",e)}setIncludeLeaveRooms(e){d(this.definition,"room.include_leave",e)}}(0,n.A)(u,"LAZY_LOADING_MESSAGES_FILTER",{lazy_load_members:!0})},6508:function(e,t,r){"use strict";r.d(t,{S:function(){return n}});var n=function(e){return e["IS"]="SERVICE_TYPE_IS",e["IM"]="SERVICE_TYPE_IM",e}({})},6518:function(e,t,r){"use strict";var n=r(4576),i=r(7347).f,o=r(6699),s=r(6840),a=r(9433),c=r(7740),l=r(2796);e.exports=function(e,t){var r,d,u,h,v,p,f=e.target,g=e.global,m=e.stat;if(d=g?n:m?n[f]||a(f,{}):n[f]&&n[f].prototype,d)for(u in t){if(v=t[u],e.dontCallGetSet?(p=i(d,u),h=p&&p.value):h=d[u],r=l(g?u:f+(m?".":"#")+u,e.forced),!r&&void 0!==h){if(typeof v==typeof h)continue;c(v,h)}(e.sham||h&&h.sham)&&o(v,"sham",!0),s(d,u,v,e)}}},6536:function(e,t,r){"use strict";r.d(t,{E5:function(){return o},LA:function(){return a},b0:function(){return s},hP:function(){return i}});var n=r(4761),i=function(e){return e["TooNew"]="TOO_NEW",e}({});class o extends Error{constructor(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again";super(t),this.reason=e,this.name="InvalidCryptoStoreError"}}(0,n.A)(o,"TOO_NEW",i.TooNew);class s extends Error{constructor(e,t){super(e),this.value=t}}class a extends Error{constructor(){super("MatrixClient has been stopped")}}},6573:function(e,t,r){"use strict";var n=r(3724),i=r(2106),o=r(3238),s=ArrayBuffer.prototype;n&&!("detached"in s)&&i(s,"detached",{configurable:!0,get:function(){return o(this)}})},6694:function(e,t,r){"use strict";r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698),Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetDriver=void 0;var n=r(5471);function i(e){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},i(e)}function o(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function s(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,c(n.key),n)}}function a(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function c(e){var t=l(e,"string");return"symbol"===i(t)?t:String(t)}function l(e,t){if("object"!==i(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var d=function(){function e(){o(this,e)}return a(e,[{key:"validateCapabilities",value:function(e){return Promise.resolve(new Set)}},{key:"sendEvent",value:function(e,t){return Promise.reject(new Error("Failed to override function"))}},{key:"sendDelayedEvent",value:function(e,t,r,n){return Promise.reject(new Error("Failed to override function"))}},{key:"updateDelayedEvent",value:function(e,t){return Promise.reject(new Error("Failed to override function"))}},{key:"sendToDevice",value:function(e,t,r){return Promise.reject(new Error("Failed to override function"))}},{key:"readRoomAccountData",value:function(e){return Promise.resolve([])}},{key:"readRoomEvents",value:function(e,t,r){return Promise.resolve([])}},{key:"readStateEvents",value:function(e,t,r){return Promise.resolve([])}},{key:"readRoomTimeline",value:function(e,t,r,n,i,o){return void 0===n?this.readRoomEvents(t,r,i,[e],o):this.readStateEvents(t,n,i,[e])}},{key:"readRoomState",value:function(e,t,r){return this.readStateEvents(t,r,Number.MAX_SAFE_INTEGER,[e])}},{key:"readEventRelations",value:function(e,t,r,n,i,o,s,a){return Promise.resolve({chunk:[]})}},{key:"askOpenID",value:function(e){e.update({state:n.OpenIDRequestState.Blocked})}},{key:"navigate",value:function(e){throw new Error("Navigation is not implemented")}},{key:"getTurnServers",value:function(){throw new Error("TURN server support is not implemented")}},{key:"searchUserDirectory",value:function(e,t){return Promise.resolve({limited:!1,results:[]})}},{key:"getMediaConfig",value:function(){throw new Error("Get media config is not implemented")}},{key:"uploadFile",value:function(e){throw new Error("Upload file is not implemented")}},{key:"downloadFile",value:function(e){throw new Error("Download file is not implemented")}},{key:"getKnownRooms",value:function(){throw new Error("Querying known rooms is not implemented")}},{key:"processError",value:function(e){}}]),e}();t.WidgetDriver=d},6699:function(e,t,r){"use strict";var n=r(3724),i=r(4913),o=r(6980);e.exports=n?function(e,t,r){return i.f(e,t,o(1,r))}:function(e,t,r){return e[t]=r,e}},6706:function(e,t,r){"use strict";var n=r(9504),i=r(9306);e.exports=function(e,t,r){try{return n(i(Object.getOwnPropertyDescriptor(e,t)[r]))}catch(o){}}},6718:function(e,t,r){"use strict";r.d(t,{K:function(){return d},L:function(){return l}});var n=r(698),i=r(4761),o=r(9683),s=r(3271),a=216e5,c=3e4,l=function(e){return e["Stable"]="stable",e["Unstable"]="unstable",e}({});class d{constructor(e){var t=this;this.http=e,(0,i.A)(this,"capabilities",void 0),(0,i.A)(this,"retryTimeout",void 0),(0,i.A)(this,"refreshTimeout",void 0),(0,i.A)(this,"fetchCapabilities",(0,n.A)((function*(){var e=yield t.http.authedRequest(o.IT.Get,"/capabilities");return t.capabilities=e["capabilities"],t.capabilities}))),(0,i.A)(this,"poll",(0,n.A)((function*(){try{yield t.fetchCapabilities(),t.clearTimeouts(),t.refreshTimeout=setTimeout(t.poll,a),s.v.debug("Fetched new server capabilities")}catch(r){t.clearTimeouts();var e=Math.floor(c+5e3*Math.random());t.retryTimeout=setTimeout(t.poll,e),s.v.warn("Failed to refresh capabilities: retrying in ".concat(e,"ms"),r)}})))}start(){this.poll().then()}stop(){this.clearTimeouts()}getCachedCapabilities(){return this.capabilities}clearTimeouts(){this.refreshTimeout&&(clearInterval(this.refreshTimeout),this.refreshTimeout=void 0),this.retryTimeout&&(clearTimeout(this.retryTimeout),this.retryTimeout=void 0)}}},6801:function(e,t,r){"use strict";var n=r(3724),i=r(8686),o=r(4913),s=r(8551),a=r(5397),c=r(1072);t.f=n&&!i?Object.defineProperties:function(e,t){s(e);var r,n=a(t),i=c(t),l=i.length,d=0;while(l>d)o.f(e,r=i[d++],n[r]);return e}},6819:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiDirection=void 0,t.invertedDirection=n;var r=function(e){return e["ToWidget"]="toWidget",e["FromWidget"]="fromWidget",e}({});function n(e){if(e===r.ToWidget)return r.FromWidget;if(e===r.FromWidget)return r.ToWidget;throw new Error("Invalid direction")}t.WidgetApiDirection=r},6823:function(e){"use strict";var t=String;e.exports=function(e){try{return t(e)}catch(r){return"Object"}}},6837:function(e){"use strict";var t=TypeError,r=9007199254740991;e.exports=function(e){if(e>r)throw t("Maximum allowed index exceeded");return e}},6840:function(e,t,r){"use strict";var n=r(4901),i=r(4913),o=r(283),s=r(9433);e.exports=function(e,t,r,a){a||(a={});var c=a.enumerable,l=void 0!==a.name?a.name:t;if(n(r)&&o(r,l,a),a.global)c?e[t]=r:s(t,r);else{try{a.unsafe?e[t]&&(c=!0):delete e[t]}catch(d){}c?e[t]=r:i.f(e,t,{value:r,enumerable:!1,configurable:!a.nonConfigurable,writable:!a.nonWritable})}return e}},6856:function(e,t,r){"use strict";function n(e,t){return new Promise(((r,n)=>{var i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{var n=o.result;n.close(),i||e.deleteDatabase(t),r(i)},o.onerror=()=>n(o.error)}))}r.d(t,{t:function(){return n}})},6955:function(e,t,r){"use strict";var n=r(2140),i=r(4901),o=r(2195),s=r(8227),a=s("toStringTag"),c=Object,l="Arguments"===o(function(){return arguments}()),d=function(e,t){try{return e[t]}catch(r){}};e.exports=n?o:function(e){var t,r,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=d(t=c(e),a))?r:l?o(t):"Object"===(n=o(t))&&i(t.callee)?"Arguments":n}},6960:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoConferenceCapabilities=t.StickerpickerCapabilities=t.MatrixCapabilities=void 0,t.getTimelineRoomIDFromCapability=a,t.isTimelineCapability=o,t.isTimelineCapabilityFor=s;var r=function(e){return e["Screenshots"]="m.capability.screenshot",e["StickerSending"]="m.sticker",e["AlwaysOnScreen"]="m.always_on_screen",e["RequiresClient"]="io.element.requires_client",e["MSC2931Navigate"]="org.matrix.msc2931.navigate",e["MSC3846TurnServers"]="town.robin.msc3846.turn_servers",e["MSC3973UserDirectorySearch"]="org.matrix.msc3973.user_directory_search",e["MSC4039UploadFile"]="org.matrix.msc4039.upload_file",e["MSC4039DownloadFile"]="org.matrix.msc4039.download_file",e["MSC4157SendDelayedEvent"]="org.matrix.msc4157.send.delayed_event",e["MSC4157UpdateDelayedEvent"]="org.matrix.msc4157.update_delayed_event",e}({});t.MatrixCapabilities=r;var n=[r.StickerSending];t.StickerpickerCapabilities=n;var i=[r.AlwaysOnScreen];function o(e){return null===e||void 0===e?void 0:e.startsWith("org.matrix.msc2762.timeline:")}function s(e,t){return e==="org.matrix.msc2762.timeline:".concat(t)}function a(e){return e.substring(e.indexOf(":")+1)}t.VideoConferenceCapabilities=i},6969:function(e,t,r){"use strict";var n=r(2777),i=r(757);e.exports=function(e){var t=n(e,"string");return i(t)?t:t+""}},6977:function(e,t){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvent=void 0;var o=function(){function e(t){r(this,e),this.wireFormat=t}return i(e,[{key:"wireContent",get:function(){return this.wireFormat.content}}]),e}();t.ExtensibleEvent=o},6980:function(e){"use strict";e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},7040:function(e,t,r){"use strict";var n=r(4495);e.exports=n&&!Symbol.sham&&"symbol"==typeof Symbol.iterator},7046:function(e,t,r){"use strict";r(8111),r(7588),Object.defineProperty(t,"__esModule",{value:!0});var n=r(8428);Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===n[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return n[e]}}))}));var i=r(8346);Object.keys(i).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===i[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}}))}));var o=r(3339);Object.keys(o).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===o[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}}))}));var s=r(6288);Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===s[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return s[e]}}))}));var a=r(2555);Object.keys(a).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===a[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}}))}));var c=r(5499);Object.keys(c).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===c[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return c[e]}}))}));var l=r(8633);Object.keys(l).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===l[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return l[e]}}))}));var d=r(1880);Object.keys(d).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===d[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return d[e]}}))}));var u=r(3751);Object.keys(u).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===u[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return u[e]}}))}));var h=r(5670);Object.keys(h).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===h[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return h[e]}}))}));var v=r(8212);Object.keys(v).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===v[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return v[e]}}))}));var p=r(6012);Object.keys(p).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===p[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return p[e]}}))}));var f=r(6977);Object.keys(f).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===f[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return f[e]}}))}));var g=r(1711);Object.keys(g).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===g[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return g[e]}}))}));var m=r(4477);Object.keys(m).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===m[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return m[e]}}))}));var y=r(1396);Object.keys(y).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===y[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return y[e]}}))}));var S=r(1550);Object.keys(S).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===S[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return S[e]}}))}));var b=r(5063);Object.keys(b).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===b[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return b[e]}}))}));var E=r(8957);Object.keys(E).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===E[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return E[e]}}))}));var _=r(4904);Object.keys(_).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===_[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return _[e]}}))}));var w=r(7978);Object.keys(w).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in t&&t[e]===w[e]||Object.defineProperty(t,e,{enumerable:!0,get:function(){return w[e]}}))}))},7055:function(e,t,r){"use strict";var n=r(9504),i=r(9039),o=r(2195),s=Object,a=n("".split);e.exports=i((function(){return!s("z").propertyIsEnumerable(0)}))?function(e){return"String"===o(e)?a(e,""):s(e)}:s},7080:function(e,t,r){"use strict";var n=r(4402).has;e.exports=function(e){return n(e),e}},7145:function(e,t,r){"use strict";var n=r(6518),i=r(9504),o=r(9306),s=r(5397),a=r(5370),c=r(4124),l=r(6469),d=Array,u=i(c("Array","sort"));n({target:"Array",proto:!0},{toSorted:function(e){void 0!==e&&o(e);var t=s(this),r=a(d,t);return u(r,e)}}),l("toSorted")},7222:function(e,t,r){"use strict";r.d(t,{UU6:function(){return ct}});var n={};r.r(n),r.d(n,{AuthType:function(){return oe},AutoDiscovery:function(){return D.MN},AutoDiscoveryAction:function(){return D.iz},AutoDiscoveryError:function(){return D.gc},Beacon:function(){return F.HF},BeaconEvent:function(){return F.JH},CRYPTO_ENABLED:function(){return v.Kn},CallEvent:function(){return He.$E},CallFeedEvent:function(){return Qe.BL},Category:function(){return x},ClientEvent:function(){return v.AU},ClientPrefix:function(){return O.iD},ClientStoppedError:function(){return B.LA},ConditionKind:function(){return Re.wp},ConditionOperator:function(){return Re.CD},ConnectionError:function(){return O.Rc},ContentHelpers:function(){return Ge},Crypto:function(){return it},CryptoEvent:function(){return Je.cr},DELEGATED_OIDC_COMPATIBILITY:function(){return Ue},DEVICE_CODE_SCOPE:function(){return Y.AO},DMMemberCountCondition:function(){return Re.IJ},Device:function(){return J.p},DeviceVerification:function(){return J.u},Direction:function(){return q.O},DuplicateStrategy:function(){return V.x},EVENT_VISIBILITY_CHANGE_TYPE:function(){return g.Yg},EventEmitterEvents:function(){return $.u},EventStatus:function(){return f.fb},EventTimeline:function(){return q.q},EventTimelineSet:function(){return V.m},EventType:function(){return g.Bx},FILTER_RELATED_BY_REL_TYPES:function(){return H.H},FILTER_RELATED_BY_SENDERS:function(){return H.o1},FeatureSupport:function(){return H.c1},Filter:function(){return Q.d},GET_LOGIN_TOKEN_CAPABILITY:function(){return v.hx},GroupCall:function(){return $e.eO},GroupCallEvent:function(){return $e.AZ},GroupCallIntent:function(){return $e.MC},GroupCallState:function(){return $e.F_},GroupCallStatsReportEvent:function(){return $e.xt},GroupCallType:function(){return $e.Ad},GuestAccess:function(){return ke.rF},HTTPError:function(){return O.Hl},HistoryVisibility:function(){return ke.Jv},HttpApiEvent:function(){return O.XD},IdentityPrefix:function(){return O.Pw},IdentityProviderBrand:function(){return Le},IndexedDBCryptoStore:function(){return Ie.y},IndexedDBStore:function(){return Ee},InteractiveAuth:function(){return ae},InvalidCryptoStoreError:function(){return B.E5},InvalidCryptoStoreState:function(){return B.hP},JoinRule:function(){return ke.dx},KNOWN_SAFE_ROOM_VERSION:function(){return j.vx},KeySignatureUploadError:function(){return B.b0},KnownMembership:function(){return l.O},LOCAL_NOTIFICATION_SETTINGS_PREFIX:function(){return g.Xs},LocalStorageCryptoStore:function(){return we.F},LocalStorageErrors:function(){return et},LocationAssetType:function(){return Me.Yg},MAIN_ROOM_TIMELINE:function(){return Ke.S},MAXIMUM_MATRIX_VERSION:function(){return ce.Uv},MINIMUM_MATRIX_VERSION:function(){return ce.eD},MSC3912_RELATION_BASED_REDACTIONS_PROP:function(){return g.Z3},M_ASSET:function(){return Me.J1},M_BEACON:function(){return Oe.z},M_BEACON_INFO:function(){return Oe.E},M_HTML:function(){return Fe.Et},M_LOCATION:function(){return Me.M6},M_MESSAGE:function(){return Fe.K0},M_POLL_END:function(){return Be.cI},M_POLL_KIND_DISCLOSED:function(){return Be.ms},M_POLL_KIND_UNDISCLOSED:function(){return Be.li},M_POLL_RESPONSE:function(){return Be.qN},M_POLL_START:function(){return Be.$S},M_TEXT:function(){return Fe.yB},M_TIMESTAMP:function(){return Me.vo},M_TOPIC:function(){return De.s},MatrixClient:function(){return v.pB},MatrixError:function(){return O.up},MatrixEvent:function(){return f.kl},MatrixEventEvent:function(){return f.OQ},MatrixHttpApi:function(){return O.ED},MatrixScheduler:function(){return h.b},MediaHandlerEvent:function(){return Ye.d},MediaPrefix:function(){return O.zs},MemoryCryptoStore:function(){return i._},MemoryStore:function(){return u},Method:function(){return O.IT},MsgType:function(){return g.Wr},NoAuthFlowFoundError:function(){return se},NotificationCountType:function(){return j.X5},OidcError:function(){return Y.uv},OidcTokenRefresher:function(){return Y.db},PUSHER_DEVICE_ID:function(){return g.VT},PUSHER_ENABLED:function(){return g.cr},PendingEventOrdering:function(){return v.eO},Poll:function(){return G.sP},PollEvent:function(){return G.sn},Preset:function(){return ke.k},ProfileKeyMSC4175Timezone:function(){return qe},PushRuleActionName:function(){return Re.YU},PushRuleKind:function(){return Re.Ji},REFERENCE_RELATION:function(){return Fe.BJ},ReceiptType:function(){return Ke.L},RelatedRelations:function(){return Ve},RelationType:function(){return g.zZ},Relations:function(){return Ze.s},RelationsEvent:function(){return Ze.S},RestrictedAllowType:function(){return ke.D7},Room:function(){return j.Wv},RoomCreateTypeField:function(){return g.Ct},RoomEvent:function(){return j.u9},RoomMember:function(){return W.Y},RoomMemberEvent:function(){return W.o},RoomNameType:function(){return j.bx},RoomState:function(){return a.H},RoomStateEvent:function(){return a.f},RoomSummary:function(){return je.c},RoomType:function(){return g.CJ},RoomVersionStability:function(){return C.L},RoomWidgetClient:function(){return k},RoomWidgetClientEvent:function(){return R},RuleId:function(){return Re.kq},SERVICE_TYPES:function(){return le.S},SSOAction:function(){return Ne},SUPPORTED_MATRIX_VERSIONS:function(){return ce.Hr},SearchOrderBy:function(){return Ce.g},SearchResult:function(){return z.q},SecretStorage:function(){return We},ServerCapabilities:function(){return C.K},SetPresence:function(){return y.IU},SlidingSyncEvent:function(){return ze.cQ},StatsReport:function(){return Xe.I},SyncAccumulator:function(){return L},SyncState:function(){return y.Lm},THREAD_RELATION_TYPE:function(){return H.RN},Thread:function(){return H.jV},ThreadEvent:function(){return H.ju},ThreadFilterType:function(){return H.x3},ThreepidMedium:function(){return Pe},TimelineIndex:function(){return re},TimelineWindow:function(){return te},ToDeviceMessageId:function(){return g.wt},TweakName:function(){return Re.QN},TypedEventEmitter:function(){return $.X},UNSIGNED_MEMBERSHIP_FIELD:function(){return g.SY},UNSIGNED_THREAD_ID_FIELD:function(){return g.Sr},UNSTABLE_ELEMENT_FUNCTIONAL_USERS:function(){return g.Ng},UNSTABLE_MSC2666_MUTUAL_ROOMS:function(){return v.NB},UNSTABLE_MSC2666_QUERY_MUTUAL_ROOMS:function(){return v.A0},UNSTABLE_MSC2666_SHARED_ROOMS:function(){return v.uD},UNSTABLE_MSC2716_MARKER:function(){return g.ge},UNSTABLE_MSC3088_ENABLED:function(){return g.ud},UNSTABLE_MSC3088_PURPOSE:function(){return g.D7},UNSTABLE_MSC3089_BRANCH:function(){return g.iK},UNSTABLE_MSC3089_LEAF:function(){return g.ID},UNSTABLE_MSC3089_TREE_SUBTYPE:function(){return g.nN},UNSTABLE_MSC3852_LAST_SEEN_UA:function(){return v.HF},UNSTABLE_MSC4133_EXTENDED_PROFILES:function(){return v.jB},UNSTABLE_MSC4140_DELAYED_EVENTS:function(){return v.rG},UpdateDelayedEventAction:function(){return Ae.e},User:function(){return E.K},UserEvent:function(){return E.U},Visibility:function(){return ke.bv},anySignal:function(){return O.JG},calculateRetryBackoff:function(){return O.fZ},completeAuthorizationCodeGrant:function(){return Y.SU},createClient:function(){return ct},createNewMatrixCall:function(){return He.sv},createRoomWidgetClient:function(){return lt},decodeBase64:function(){return K.y4},decodeIdToken:function(){return Y.Rh},determineFeatureSupport:function(){return H.FD},discoverAndValidateOIDCIssuerWellKnown:function(){return Y.k8},encodeBase64:function(){return K.WG},encodeUnpaddedBase64:function(){return K.PP},encodeUnpaddedBase64Url:function(){return K.A4},fixNotificationCountOnDecryption:function(){return v.mD},generateAuthorizationParams:function(){return Y.P3},generateAuthorizationUrl:function(){return Y.cJ},generateOidcAuthorizationUrl:function(){return Y.R2},generateScope:function(){return Y.oE},getBeaconInfoIdentifier:function(){return F.M9},getHttpUriForMxc:function(){return Te.y},inMainTimelineForReceipt:function(){return v.fN},isDmMemberCountCondition:function(){return Re.WM},isEventTypeSame:function(){return Fe.NY},isPollEvent:function(){return G.Wi},isTimestampInDuration:function(){return F.ai},localStorageErrorsEventsEmitter:function(){return nt},parseErrorResponse:function(){return O.xy},registerOidcClient:function(){return Y.aT},retryNetworkOperation:function(){return O.Y6},safeGetRetryAfterMs:function(){return O.eM},setCryptoStoreFactory:function(){return st},threadFilterTypeToFilter:function(){return H.UR},threadIdForReceipt:function(){return v.Xb},timeoutSignal:function(){return O._},validateAuthMetadata:function(){return Y.EZ},validateAuthMetadataAndKeys:function(){return Y.Pl},validateBearerTokenResponse:function(){return Y.eC},validateIdToken:function(){return Y.rm},validateStoredUserState:function(){return Y.K8}});var i=r(812),o=(r(4114),r(8111),r(2489),r(7588),r(1701),r(698)),s=r(4761),a=r(4123),c=r(6170),l=r(3877);function d(e){var t="string"===typeof e&&!!e&&"undefined"!==e&&"null"!==e;return t||"number"===typeof e}class u{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,s.A)(this,"rooms",{}),(0,s.A)(this,"users",{}),(0,s.A)(this,"syncToken",null),(0,s.A)(this,"filters",new c.kG((()=>new Map))),(0,s.A)(this,"accountData",new Map),(0,s.A)(this,"localStorage",void 0),(0,s.A)(this,"oobMembers",new Map),(0,s.A)(this,"pendingEvents",{}),(0,s.A)(this,"clientOptions",void 0),(0,s.A)(this,"pendingToDeviceBatches",[]),(0,s.A)(this,"nextToDeviceBatchId",0),(0,s.A)(this,"createUser",void 0),(0,s.A)(this,"onRoomMember",((e,t,r)=>{var n;if(r.membership!==l.O.Invite){var i=this.users[r.userId]||(null===(n=this.createUser)||void 0===n?void 0:n.call(this,r.userId));r.name&&(i.setDisplayName(r.name),r.events.member&&i.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&i.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[i.userId]=i}})),this.localStorage=e.localStorage}getSyncToken(){return this.syncToken}isNewlyCreated(){return Promise.resolve(!0)}setSyncToken(e){this.syncToken=e}storeRoom(e){this.rooms[e.roomId]=e,e.currentState.on(a.f.Members,this.onRoomMember),e.currentState.getMembers().forEach((t=>{this.onRoomMember(null,e.currentState,t)}))}setUserCreator(e){this.createUser=e}getRoom(e){return this.rooms[e]||null}getRooms(){return Object.values(this.rooms)}removeRoom(e){this.rooms[e]&&this.rooms[e].currentState.removeListener(a.f.Members,this.onRoomMember),delete this.rooms[e]}getRoomSummaries(){return Object.values(this.rooms).map((function(e){return e.summary}))}storeUser(e){this.users[e.userId]=e}getUser(e){return this.users[e]||null}getUsers(){return Object.values(this.users)}scrollback(e,t){return[]}storeEvents(e,t,r,n){}storeFilter(e){null!==e&&void 0!==e&&e.userId&&null!==e&&void 0!==e&&e.filterId&&this.filters.getOrCreate(e.userId).set(e.filterId,e)}getFilter(e,t){var r;return(null===(r=this.filters.get(e))||void 0===r?void 0:r.get(t))||null}getFilterIdByName(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var r=this.localStorage.getItem(t);if(d(r))return r}catch(n){}return null}setFilterIdByName(e,t){if(this.localStorage){var r="mxjssdk_memory_filter_"+e;try{d(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch(n){}}}storeAccountDataEvents(e){e.forEach((e=>{var t=!Object.keys(e.getContent()).length;t?this.accountData.delete(e.getType()):this.accountData.set(e.getType(),e)}))}getAccountData(e){return this.accountData.get(e)}setSyncData(e){return Promise.resolve()}wantsSave(){return!1}save(e){return Promise.resolve()}startup(){return Promise.resolve()}getSavedSync(){return Promise.resolve(null)}getSavedSyncToken(){return Promise.resolve(null)}deleteAllData(){return this.rooms={},this.users={},this.syncToken=null,this.filters=new c.kG((()=>new Map)),this.accountData=new Map,Promise.resolve()}getOutOfBandMembers(e){return Promise.resolve(this.oobMembers.get(e)||null)}setOutOfBandMembers(e,t){return this.oobMembers.set(e,t),Promise.resolve()}clearOutOfBandMembers(e){return this.oobMembers.delete(e),Promise.resolve()}getClientOptions(){return Promise.resolve(this.clientOptions)}storeClientOptions(e){return this.clientOptions=Object.assign({},e),Promise.resolve()}getPendingEvents(e){var t=this;return(0,o.A)((function*(){var r;return null!==(r=t.pendingEvents[e])&&void 0!==r?r:[]}))()}setPendingEvents(e,t){var r=this;return(0,o.A)((function*(){r.pendingEvents[e]=t}))()}saveToDeviceBatches(e){for(var t of e)this.pendingToDeviceBatches.push({id:this.nextToDeviceBatchId++,eventType:t.eventType,txnId:t.txnId,batch:t.batch});return Promise.resolve()}getOldestToDeviceBatch(){var e=this;return(0,o.A)((function*(){return 0===e.pendingToDeviceBatches.length?null:e.pendingToDeviceBatches[0]}))()}removeToDeviceBatch(e){return this.pendingToDeviceBatches=this.pendingToDeviceBatches.filter((t=>t.id!==e)),Promise.resolve()}destroy(){return(0,o.A)((function*(){}))()}}var h=r(7738),v=r(4108),p=(r(116),r(3579),r(5471)),f=r(3178),g=r(5629),m=r(3271),y=r(1212),S=r(4192),b=r(9310),E=r(1423);function _(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function w(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?_(Object(r),!0).forEach((function(t){(0,s.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):_(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function I(e){var t,r,n,i=2;for("undefined"!=typeof Symbol&&(r=Symbol.asyncIterator,n=Symbol.iterator);i--;){if(r&&null!=(t=e[r]))return t.call(e);if(n&&null!=(t=e[n]))return new T(t.call(e));r="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function T(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return T=function(e){this.s=e,this.n=e.next},T.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var r=this.s.return;return void 0===r?Promise.resolve({value:e,done:!0}):t(r.apply(this.s,arguments))},throw:function(e){var r=this.s.return;return void 0===r?Promise.reject(e):t(r.apply(this.s,arguments))}},new T(e)}var R=function(e){return e["PendingEventsChanged"]="PendingEvent.pendingEventsChanged",e}({});class k extends v.pB{constructor(e,t,r,n,i){var a,c,l,d,u,h,S,b,E,_,I,T,k;super(n),a=this,this.widgetApi=e,this.capabilities=t,this.roomId=r,(0,s.A)(this,"room",void 0),(0,s.A)(this,"widgetApiReady",void 0),(0,s.A)(this,"lifecycle",void 0),(0,s.A)(this,"syncState",null),(0,s.A)(this,"pendingSendingEventsTxId",[]),(0,s.A)(this,"eventEmitter",new $.X),(0,s.A)(this,"updateTxId",function(){var e=(0,o.A)((function*(e){if(e.getSender()===a.getUserId()&&a.pendingSendingEventsTxId.some((t=>e.getType()===t.type))){var t,r=null===(t=a.pendingSendingEventsTxId.find((t=>t.id===e.getId())))||void 0===t?void 0:t.txId;while(!r&&a.pendingSendingEventsTxId.length>0){var n;yield new Promise((e=>a.eventEmitter.once(R.PendingEventsChanged,(()=>e())))),r=null===(n=a.pendingSendingEventsTxId.find((t=>t.id===e.getId())))||void 0===n?void 0:n.txId}r&&(e.setTxnId(r),e.setUnsigned(w(w({},e.getUnsigned()),{},{transaction_id:r}))),a.pendingSendingEventsTxId=a.pendingSendingEventsTxId.filter((t=>t.id!==e.getId())),0===a.pendingSendingEventsTxId.length&&a.eventEmitter.emit(R.PendingEventsChanged)}}));return function(t){return e.apply(this,arguments)}}()),(0,s.A)(this,"onEvent",function(){var e=(0,o.A)((function*(e){if(e.preventDefault(),e.detail.data.room_id===a.roomId){var t=new f.kl(e.detail.data);yield a.updateTxId(t),a.syncApi instanceof y.w_?yield a.syncApi.injectRoomEvents(a.room,[],void 0,[t]):yield a.syncApi.injectRoomEvents(a.room,[],[t]),a.emit(v.AU.Event,t),a.setSyncState(y.Lm.Syncing),m.v.info("Received event ".concat(t.getId()," ").concat(t.getType()," ").concat(t.getStateKey()))}else{var{event_id:r,room_id:n}=e.detail.data;m.v.info("Received event ".concat(r," for a different room ").concat(n,"; discarding"))}yield a.ack(e)}));return function(t){return e.apply(this,arguments)}}()),(0,s.A)(this,"onToDevice",function(){var e=(0,o.A)((function*(e){e.preventDefault();var t=new f.kl({type:e.detail.data.type,sender:e.detail.data.sender,content:e.detail.data.content});e.detail.data.encrypted&&t.makeEncrypted(g.Bx.RoomMessageEncrypted,{},"",""),a.emit(v.AU.ToDeviceEvent,t),a.setSyncState(y.Lm.Syncing),yield a.ack(e)}));return function(t){return e.apply(this,arguments)}}());var C=this.widgetApi.transport.send.bind(this.widgetApi.transport);this.widgetApi.transport.send=function(){var e=(0,o.A)((function*(e,t){try{return yield C(e,t)}catch(r){A(r)}}));return function(t,r){return e.apply(this,arguments)}}();var O=this.widgetApi.transport.sendComplete.bind(this.widgetApi.transport);this.widgetApi.transport.sendComplete=function(){var e=(0,o.A)((function*(e,t){try{return yield O(e,t)}catch(r){A(r)}}));return function(t,r){return e.apply(this,arguments)}}(),this.widgetApiReady=new Promise((e=>this.widgetApi.once("ready",e))),(null!==(c=t.sendEvent)&&void 0!==c&&c.length||null!==(l=t.receiveEvent)&&void 0!==l&&l.length||!0===t.sendMessage||Array.isArray(t.sendMessage)&&t.sendMessage.length||!0===t.receiveMessage||Array.isArray(t.receiveMessage)&&t.receiveMessage.length||null!==(d=t.sendState)&&void 0!==d&&d.length||null!==(u=t.receiveState)&&void 0!==u&&u.length)&&e.requestCapabilityForRoomTimeline(r),null===(h=t.sendEvent)||void 0===h||h.forEach((t=>e.requestCapabilityToSendEvent(t))),null===(S=t.receiveEvent)||void 0===S||S.forEach((t=>e.requestCapabilityToReceiveEvent(t))),!0===t.sendMessage?e.requestCapabilityToSendMessage():Array.isArray(t.sendMessage)&&t.sendMessage.forEach((t=>e.requestCapabilityToSendMessage(t))),!0===t.receiveMessage?e.requestCapabilityToReceiveMessage():Array.isArray(t.receiveMessage)&&t.receiveMessage.forEach((t=>e.requestCapabilityToReceiveMessage(t))),null===(b=t.sendState)||void 0===b||b.forEach((t=>{var{eventType:r,stateKey:n}=t;return e.requestCapabilityToSendState(r,n)})),null===(E=t.receiveState)||void 0===E||E.forEach((t=>{var{eventType:r,stateKey:n}=t;return e.requestCapabilityToReceiveState(r,n)})),null===(_=t.sendToDevice)||void 0===_||_.forEach((t=>e.requestCapabilityToSendToDevice(t))),null===(I=t.receiveToDevice)||void 0===I||I.forEach((t=>e.requestCapabilityToReceiveToDevice(t))),t.sendDelayedEvents&&(null!==(T=t.sendEvent)&&void 0!==T&&T.length||!0===t.sendMessage||Array.isArray(t.sendMessage)&&t.sendMessage.length||null!==(k=t.sendState)&&void 0!==k&&k.length)&&e.requestCapability(p.MatrixCapabilities.MSC4157SendDelayedEvent),t.updateDelayedEvents&&e.requestCapability(p.MatrixCapabilities.MSC4157UpdateDelayedEvent),t.turnServers&&e.requestCapability(p.MatrixCapabilities.MSC3846TurnServers),e.on("action:".concat(p.WidgetApiToWidgetAction.SendEvent),this.onEvent),e.on("action:".concat(p.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),e.start(),i&&e.sendContentLoaded()}startClient(){var e=arguments,t=this;return(0,o.A)((function*(){var r,n,i=e.length>0&&void 0!==e[0]?e[0]:{};t.lifecycle=new AbortController;var s=t.getUserId();s&&t.store.storeUser(new E.K(s)),i.slidingSync?t.syncApi=new S.m(i.slidingSync,t,i,t.buildSyncApiOptions()):t.syncApi=new y.w_(t,i,t.buildSyncApiOptions()),t.room=t.syncApi.createRoom(t.roomId),t.store.storeRoom(t.room),yield t.widgetApiReady,yield Promise.all(null!==(r=null===(n=t.capabilities.receiveState)||void 0===n?void 0:n.map(function(){var e=(0,o.A)((function*(e){var{eventType:r,stateKey:n}=e,i=yield t.widgetApi.readStateEvents(r,void 0,n,[t.roomId]),o=i.map((e=>new f.kl(e)));t.syncApi instanceof y.w_?yield t.syncApi.injectRoomEvents(t.room,void 0,o):yield t.syncApi.injectRoomEvents(t.room,o),o.forEach((e=>{t.emit(v.AU.Event,e),m.v.info("Backfilled event ".concat(e.getId()," ").concat(e.getType()," ").concat(e.getStateKey()))}))}));return function(t){return e.apply(this,arguments)}}()))&&void 0!==r?r:[]),void 0!==i.clientWellKnownPollPeriod&&(t.clientWellKnownIntervalID=setInterval((()=>{t.fetchClientWellKnown()}),1e3*i.clientWellKnownPollPeriod),t.fetchClientWellKnown()),t.setSyncState(y.Lm.Syncing),m.v.info("Finished backfilling events"),t.matrixRTC.start(),t.capabilities.turnServers&&t.watchTurnServers()}))()}stopClient(){this.widgetApi.off("action:".concat(p.WidgetApiToWidgetAction.SendEvent),this.onEvent),this.widgetApi.off("action:".concat(p.WidgetApiToWidgetAction.SendToDevice),this.onToDevice),super.stopClient(),this.lifecycle.abort()}joinRoom(e){var t=this;return(0,o.A)((function*(){if(e===t.roomId)return t.room;throw new Error("Unknown room: ".concat(e))}))()}encryptAndSendEvent(e,t,r){var n=this;return(0,o.A)((function*(){var i=t.event.redacts?w(w({},t.getContent()),{},{redacts:t.event.redacts}):t.getContent();if(r){var o=yield n.widgetApi.sendRoomEvent(t.getType(),i,e.roomId,"delay"in r?r.delay:void 0,"parent_delay_id"in r?r.parent_delay_id:void 0);return n.validateSendDelayedEventResponse(o)}var s,a=t.getTxnId();a&&n.pendingSendingEventsTxId.push({type:t.getType(),id:void 0,txId:a});try{s=yield n.widgetApi.sendRoomEvent(t.getType(),i,e.roomId)}catch(c){throw n.updatePendingEventStatus(e,t,f.fb.NOT_SENT),c}return e.updatePendingEvent(t,f.fb.SENT,s.event_id),n.pendingSendingEventsTxId.forEach((e=>{e.txId===a&&(e.id=s.event_id)})),n.eventEmitter.emit(R.PendingEventsChanged),{event_id:s.event_id}}))()}sendStateEvent(e,t,r){var n=arguments,i=this;return(0,o.A)((function*(){var o=n.length>3&&void 0!==n[3]?n[3]:"",s=yield i.widgetApi.sendStateEvent(t,o,r,e);if(void 0===s.event_id)throw new Error("'event_id' absent from response to an event request");return{event_id:s.event_id}}))()}_unstable_sendDelayedStateEvent(e,t,r,n){var i=arguments,s=this;return(0,o.A)((function*(){var o=i.length>4&&void 0!==i[4]?i[4]:"";if(!(yield s.doesServerSupportUnstableFeature(v.rG)))throw Error("Server does not support the delayed events API");var a=yield s.widgetApi.sendStateEvent(r,o,n,e,"delay"in t?t.delay:void 0,"parent_delay_id"in t?t.parent_delay_id:void 0);return s.validateSendDelayedEventResponse(a)}))()}validateSendDelayedEventResponse(e){if(void 0===e.delay_id)throw new Error("'delay_id' absent from response to a delayed event request");return{delay_id:e.delay_id}}_unstable_updateDelayedEvent(e,t){var r=this;return(0,o.A)((function*(){if(!(yield r.doesServerSupportUnstableFeature(v.rG)))throw Error("Server does not support the delayed events API");return yield r.widgetApi.updateDelayedEvent(e,t)}))()}sendToDevice(e,t){var r=this;return(0,o.A)((function*(){return yield r.widgetApi.sendToDevice(e,!1,(0,c.HF)(t)),{}}))()}getOpenIdToken(){var e=this;return(0,o.A)((function*(){var t=yield e.widgetApi.requestOpenIDConnectToken();return{access_token:t.access_token,expires_in:t.expires_in,matrix_server_name:t.matrix_server_name,token_type:t.token_type}}))()}queueToDevice(e){var t=this;return(0,o.A)((function*(){var{eventType:r,batch:n}=e,i=new c.kG((()=>new Map));for(var{userId:o,deviceId:s,payload:a}of n)i.getOrCreate(o).set(s,a);yield t.widgetApi.sendToDevice(r,!1,(0,c.HF)(i))}))()}encryptAndSendToDevices(e,t){var r=this;return(0,o.A)((function*(){var n=new c.kG((()=>new Map));for(var{userId:i,deviceInfo:{deviceId:o}}of e)n.getOrCreate(i).set(o,t);yield r.widgetApi.sendToDevice(t.type,!0,(0,c.HF)(n))}))()}sendToDeviceViaWidgetApi(e,t,r){var n=this;return(0,o.A)((function*(){yield n.widgetApi.sendToDevice(e,t,(0,c.HF)(r))}))()}checkTurnServers(){var e=this;return(0,o.A)((function*(){return e.turnServers.length>0}))()}getSyncState(){return this.syncState}setSyncState(e){var t=this.syncState;this.syncState=e,this.emit(v.AU.Sync,e,t)}ack(e){var t=this;return(0,o.A)((function*(){yield t.widgetApi.transport.reply(e.detail,{})}))()}watchTurnServers(){var e=this;return(0,o.A)((function*(){var t=e.widgetApi.getTurnServers(),r=()=>{t.return(void 0)};e.lifecycle.signal.addEventListener("abort",r);try{var n,i=!1,o=!1;try{for(var s,a=I(t);i=!(s=yield a.next()).done;i=!1){var c=s.value;e.turnServers=[{urls:c.uris,username:c.username,credential:c.password}],e.emit(v.AU.TurnServers,e.turnServers),m.v.log("Received TURN server: ".concat(c.uris))}}catch(l){o=!0,n=l}finally{try{i&&null!=a.return&&(yield a.return())}finally{if(o)throw n}}}catch(d){m.v.warn("Error watching TURN servers",d)}finally{e.lifecycle.signal.removeEventListener("abort",r)}}))()}}function A(e){throw e instanceof p.WidgetApiResponseError&&e.data.matrix_api_error?b.up.fromWidgetApiErrorData(e.data.matrix_api_error):e}var C=r(6718),O=r(9683),D=r(5315),M=r(7430);class P{constructor(){(0,s.A)(this,"unthreadedReadReceipts",new Map),(0,s.A)(this,"threadedReadReceipts",new c.kG((()=>new Map)))}setUnthreaded(e,t){this.unthreadedReadReceipts.set(e,t)}setThreaded(e,t,r){this.threadedReadReceipts.getOrCreate(e).set(t,r)}allUnthreaded(){return this.unthreadedReadReceipts.entries()}*allThreaded(){for(var e of this.threadedReadReceipts.values())for(var t of e.entries())yield t}consumeEphemeralEvents(e){null===e||void 0===e||e.forEach((e=>{e.type===g.Bx.Receipt&&e.content&&Object.keys(e.content).forEach((t=>{Object.entries(e.content[t]).forEach((r=>{var[n,i]=r;if((0,c.ll)(n))for(var o of Object.keys(i)){var s=e.content[t][n][o],a={data:e.content[t][n][o],type:n,eventId:t};s.thread_id?this.setThreaded(s.thread_id,o,a):this.setUnthreaded(o,a)}}))}))}))}buildAccumulatedReceiptEvent(e){var t={type:g.Bx.Receipt,room_id:e,content:{}},r=new c.kG((()=>new c.kG((()=>new Map))));for(var[n,i]of this.allUnthreaded())r.getOrCreate(i.eventId).getOrCreate(i.type).set(n,i.data);for(var[o,s]of this.allThreaded())r.getOrCreate(s.eventId).getOrCreate(s.type).set(o,s.data);return t.content=(0,c.HF)(r),r.size>0?t:null}}var x=function(e){return e["Invite"]="invite",e["Leave"]="leave",e["Join"]="join",e["Knock"]="knock",e}({});function U(e){return"_localTs"in e&&void 0!==e["_localTs"]}class L{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.opts=e,(0,s.A)(this,"accountData",{}),(0,s.A)(this,"inviteRooms",{}),(0,s.A)(this,"knockRooms",{}),(0,s.A)(this,"joinRooms",{}),(0,s.A)(this,"nextBatch",null),this.opts.maxTimelineEntries=this.opts.maxTimelineEntries||50}accumulate(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.accumulateRooms(e,t),this.accumulateAccountData(e),this.nextBatch=e.next_batch}accumulateAccountData(e){e.account_data&&e.account_data.events&&e.account_data.events.forEach((e=>{this.accountData[e.type]=e}))}accumulateRooms(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((r=>{this.accumulateRoom(r,x.Invite,e.rooms.invite[r],t)})),e.rooms.join&&Object.keys(e.rooms.join).forEach((r=>{this.accumulateRoom(r,x.Join,e.rooms.join[r],t)})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((r=>{this.accumulateRoom(r,x.Leave,e.rooms.leave[r],t)})),e.rooms.knock&&Object.keys(e.rooms.knock).forEach((r=>{this.accumulateRoom(r,x.Knock,e.rooms.knock[r],t)})))}accumulateRoom(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];switch(t){case x.Invite:this.knockRooms[e]&&delete this.knockRooms[e],this.accumulateInviteState(e,r);break;case x.Knock:this.accumulateKnockState(e,r);break;case x.Join:this.inviteRooms[e]&&delete this.inviteRooms[e],this.accumulateJoinState(e,r,n);break;case x.Leave:this.knockRooms[e]?delete this.knockRooms[e]:this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:m.v.error("Unknown cateogory: ",t)}}accumulateInviteState(e,t){if(t.invite_state&&t.invite_state.events)if(this.inviteRooms[e]){var r=this.inviteRooms[e];t.invite_state.events.forEach((e=>{for(var t=!1,n=0;n<r.invite_state.events.length;n++){var i=r.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.invite_state.events[n]=e,t=!0)}t||r.invite_state.events.push(e)}))}else this.inviteRooms[e]={invite_state:t.invite_state}}accumulateKnockState(e,t){if(t.knock_state&&t.knock_state.events)if(this.knockRooms[e]){var r=this.knockRooms[e];t.knock_state.events.forEach((e=>{for(var t=!1,n=0;n<r.knock_state.events.length;n++){var i=r.knock_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.knock_state.events[n]=e,t=!0)}t||r.knock_state.events.push(e)}))}else this.knockRooms[e]={knock_state:t.knock_state}}accumulateJoinState(e,t){var r,n,i,o,s,a,c=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_unreadThreadNotifications:{},_summary:{},_receipts:new P});var l=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((e=>{l._accountData[e.type]=e})),t.unread_notifications&&(l._unreadNotifications=t.unread_notifications),l._unreadThreadNotifications=null!==(r=null!==(n=t[M.a.stable])&&void 0!==n?n:t[M.a.unstable])&&void 0!==r?r:void 0,t.summary){var d,u,h,v="m.heroes",p="m.invited_member_count",f="m.joined_member_count",g=l._summary,m=t.summary;g[v]=null!==(d=m[v])&&void 0!==d?d:g[v],g[f]=null!==(u=m[f])&&void 0!==u?u:g[f],g[p]=null!==(h=m[p])&&void 0!==h?h:g[p]}if(l._receipts.consumeEphemeralEvents(null===(i=t.ephemeral)||void 0===i?void 0:i.events),t.timeline&&t.timeline.limited&&(l._timeline=[]),null===(o=t.state)||void 0===o||null===(o=o.events)||void 0===o||o.forEach((e=>{N(l._currentState,e)})),null===(s=t["org.matrix.msc4222.state_after"])||void 0===s||null===(s=s.events)||void 0===s||s.forEach((e=>{N(l._currentState,e)})),null===(a=t.timeline)||void 0===a||null===(a=a.events)||void 0===a||a.forEach(((e,r)=>{var n,i;if(t["org.matrix.msc4222.state_after"]||N(l._currentState,e),c)i=e;else{var o;i=Object.assign({},e),void 0!==i.unsigned&&(i.unsigned=Object.assign({},i.unsigned));var s=null===(o=e.unsigned)||void 0===o?void 0:o.age;void 0!==s&&(i._localTs=Date.now()-s)}l._timeline.push({event:i,token:0===r&&null!==(n=t.timeline.prev_batch)&&void 0!==n?n:null})})),l._timeline.length>this.opts.maxTimelineEntries)for(var y=l._timeline.length-this.opts.maxTimelineEntries,S=y;S<l._timeline.length;S++)if(l._timeline[S].token){l._timeline=l._timeline.slice(S,l._timeline.length);break}}getJSON(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t={join:{},invite:{},knock:{},leave:{}};Object.keys(this.inviteRooms).forEach((e=>{t.invite[e]=this.inviteRooms[e]})),Object.keys(this.knockRooms).forEach((e=>{t.knock[e]=this.knockRooms[e]})),Object.keys(this.joinRooms).forEach((r=>{var n=this.joinRooms[r],i={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},"org.matrix.msc4222.state_after":{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:n._unreadNotifications,unread_thread_notifications:n._unreadThreadNotifications,summary:n._summary};Object.keys(n._accountData).forEach((e=>{i.account_data.events.push(n._accountData[e])}));var o=n._receipts.buildAccumulatedReceiptEvent(r);o&&i.ephemeral.events.push(o),n._timeline.forEach((t=>{if(!i.timeline.prev_batch){if(!t.token)return;i.timeline.prev_batch=t.token}var r;!e&&U(t.event)?(r=Object.assign({},t.event),void 0!==r.unsigned&&(r.unsigned=Object.assign({},r.unsigned)),delete r._localTs,r.unsigned=r.unsigned||{},r.unsigned.age=Date.now()-t.event._localTs):r=t.event,i.timeline.events.push(r)}));for(var s=Object.create(null),a=i.timeline.events.length-1;a>=0;a--){var l=i.timeline.events[a];if(null!==l.state_key&&void 0!==l.state_key){var d=(0,c.A4)(l);d.unsigned&&(d.unsigned.prev_content&&(d.content=d.unsigned.prev_content),d.unsigned.prev_sender&&(d.sender=d.unsigned.prev_sender)),N(s,d)}}Object.keys(n._currentState).forEach((e=>{Object.keys(n._currentState[e]).forEach((t=>{var r=n._currentState[e][t];i["org.matrix.msc4222.state_after"].events.push(r),s[e]&&s[e][t]&&(r=s[e][t]),i.state.events.push(r)}))})),t.join[r]=i}));var r=[];return Object.keys(this.accountData).forEach((e=>{r.push(this.accountData[e])})),{nextBatch:this.nextBatch,roomsData:t,accountData:r}}getNextBatchToken(){return this.nextBatch}}function N(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}var B=r(6536),K=r(944),F=r(972),j=r(8965),q=r(2292),V=r(1337),G=r(4861),W=r(8058),H=r(7528),$=r(2668),J=r(4178),z=r(3124),Y=r(5092),Q=r(6483),X=!1,Z=X?m.v.log.bind(m.v):function(){},ee=10;class te{constructor(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};this.client=e,this.timelineSet=t,(0,s.A)(this,"windowLimit",void 0),(0,s.A)(this,"start",void 0),(0,s.A)(this,"end",void 0),(0,s.A)(this,"eventCount",0),this.windowLimit=n.windowLimit||1e3,null===(r=t.room)||void 0===r||r.on(j.u9.Timeline,this.onTimelineEvent.bind(this))}load(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:20,r=r=>{if(!r)throw new Error("No timeline given to initFields");var n,i=r.getEvents();if(e){if(n=i.findIndex((t=>t.getId()===e)),n<0)throw new Error("getEventTimeline result didn't include requested event")}else n=i.length;var o=Math.min(i.length,n+Math.ceil(t/2)),s=Math.max(0,o-t);this.start=new re(r,s-r.getBaseIndex()),this.end=new re(r,o-r.getBaseIndex()),this.eventCount=o-s};return this.timelineSet.getTimelineForEvent(e)?(r(this.timelineSet.getTimelineForEvent(e)),Promise.resolve()):e?this.client.getEventTimeline(this.timelineSet,e).then(r):(r(this.timelineSet.getLiveTimeline()),Promise.resolve())}getTimelineIndex(e){var t,r;if(e==q.q.BACKWARDS)return null!==(t=this.start)&&void 0!==t?t:null;if(e==q.q.FORWARDS)return null!==(r=this.end)&&void 0!==r?r:null;throw new Error("Invalid direction '"+e+"'")}extend(e,t){var r=this.getTimelineIndex(e);if(!r)return Z("TimelineWindow: no timeline yet"),!1;var n=e==q.q.BACKWARDS?r.retreat(t):r.advance(t);if(n){this.eventCount+=n,Z("TimelineWindow: increased cap by "+n+" (now "+this.eventCount+")");var i=this.eventCount-this.windowLimit;return i>0&&this.unpaginate(i,e!=q.q.BACKWARDS),!0}return!1}onTimelineEvent(e,t,r,n){n&&this.onEventRemoved()}onEventRemoved(){var e=this.getEvents();e.length>0&&void 0===e[e.length-1]&&this.end&&this.end.index--}canPaginate(e){var t=this.getTimelineIndex(e);if(!t)return Z("TimelineWindow: no timeline yet"),!1;if(e==q.q.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;var r=t.timeline.getNeighbouringTimeline(e),n=t.timeline.getPaginationToken(e);return Boolean(r)||Boolean(n)}paginate(e,t){var r=arguments,n=this;return(0,o.A)((function*(){var i=!(r.length>2&&void 0!==r[2])||r[2],o=r.length>3&&void 0!==r[3]?r[3]:ee,s=n.getTimelineIndex(e);if(!s)return Z("TimelineWindow: no timeline yet"),!1;if(s.pendingPaginate)return s.pendingPaginate;if(n.extend(e,t))return!0;if(!i||0===o)return!1;var a=s.timeline.getPaginationToken(e);if(!a)return Z("TimelineWindow: no token"),!1;Z("TimelineWindow: starting request");var c=n.client.paginateEventTimeline(s.timeline,{backwards:e==q.q.BACKWARDS,limit:t}).finally((function(){s.pendingPaginate=void 0})).then((r=>(Z("TimelineWindow: request completed with result "+r),r?n.paginate(e,t,!0,o-1):n.paginate(e,t,!1,0))));return s.pendingPaginate=c,c}))()}unpaginate(e,t){var r=t?this.start:this.end;if(!r)throw new Error("Attempting to unpaginate startOfTimeline=".concat(t," but don't have this direction"));if(e>this.eventCount||e<0)throw new Error("Attemting to unpaginate ".concat(e," events, but only have ").concat(this.eventCount," in the timeline"));while(e>0){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this.eventCount+" events");e-=n,this.eventCount-=n,Z("TimelineWindow.unpaginate: dropped "+n+" (now "+this.eventCount+")")}}getEvents(){if(!this.start)return[];var e=[],t=this.start.timeline;while(t){var r,n,i=t.getEvents(),o=0,s=i.length;t===this.start.timeline&&(o=this.start.index+t.getBaseIndex()),t===(null===(r=this.end)||void 0===r?void 0:r.timeline)&&(s=this.end.index+t.getBaseIndex());for(var a=o;a<s;a++)e.push(i[a]);if(t===(null===(n=this.end)||void 0===n?void 0:n.timeline))break;t=t.getNeighbouringTimeline(q.q.FORWARDS)}return e}}class re{constructor(e,t){this.timeline=e,this.index=t,(0,s.A)(this,"pendingPaginate",void 0)}minIndex(){return-1*this.timeline.getBaseIndex()}maxIndex(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()}advance(e){if(!e)return 0;var t;if(e<0){if(t=Math.max(e,this.minIndex()-this.index),t<0)return this.index+=t,t}else if(t=Math.min(e,this.maxIndex()-this.index),t>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?q.q.BACKWARDS:q.q.FORWARDS);return r?(this.timeline=r,this.index=e<0?this.maxIndex():this.minIndex(),Z("paginate: switched to new neighbour"),this.advance(e)):0}retreat(e){return-1*this.advance(-1*e)}}r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698),r(4603),r(7566),r(8721);var ne="m.login.email.identity",ie="m.login.msisdn",oe=function(e){return e["Password"]="m.login.password",e["Recaptcha"]="m.login.recaptcha",e["Terms"]="m.login.terms",e["Email"]="m.login.email.identity",e["Msisdn"]="m.login.msisdn",e["Sso"]="m.login.sso",e["SsoUnstable"]="org.matrix.login.sso",e["Dummy"]="m.login.dummy",e["RegistrationToken"]="m.login.registration_token",e["UnstableRegistrationToken"]="org.matrix.msc3231.login.registration_token",e}({});class se extends Error{constructor(e,t,r){super(e),this.required_stages=t,this.flows=r,(0,s.A)(this,"name","NoAuthFlowFoundError")}}class ae{constructor(e){var t=this;(0,s.A)(this,"matrixClient",void 0),(0,s.A)(this,"inputs",void 0),(0,s.A)(this,"clientSecret",void 0),(0,s.A)(this,"requestCallback",void 0),(0,s.A)(this,"busyChangedCallback",void 0),(0,s.A)(this,"stateUpdatedCallback",void 0),(0,s.A)(this,"requestEmailTokenCallback",void 0),(0,s.A)(this,"supportedStages",void 0),(0,s.A)(this,"data",void 0),(0,s.A)(this,"emailSid",void 0),(0,s.A)(this,"requestingEmailToken",!1),(0,s.A)(this,"attemptAuthDeferred",null),(0,s.A)(this,"chosenFlow",null),(0,s.A)(this,"currentStage",null),(0,s.A)(this,"emailAttempt",1),(0,s.A)(this,"submitPromise",null),(0,s.A)(this,"requestEmailToken",(0,o.A)((function*(){if(t.requestingEmailToken)m.v.warn("Could not request email token: Already requesting");else{m.v.trace("Requesting email token. Attempt: "+t.emailAttempt),t.requestingEmailToken=!0;try{var e=yield t.requestEmailTokenCallback(t.inputs.emailAddress,t.clientSecret,t.emailAttempt++,t.data.session);t.emailSid=e.sid,m.v.trace("Email token request succeeded")}finally{t.requestingEmailToken=!1}}}))),this.matrixClient=e.matrixClient,this.data=e.authData||{flows:[]},this.requestCallback=e.doRequest,this.busyChangedCallback=e.busyChanged,this.stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this.requestEmailTokenCallback=e.requestEmailToken,this.inputs=e.inputs||{},e.sessionId&&(this.data.session=e.sessionId),this.clientSecret=e.clientSecret||this.matrixClient.generateClientSecret(),this.emailSid=e.emailSid,void 0!==e.supportedStages&&(this.supportedStages=new Set(e.supportedStages))}attemptAuth(){var e=this;return(0,o.A)((function*(){var t;e.attemptAuthDeferred=(0,c.v6)();var r=e.attemptAuthDeferred.promise;if(null!==(t=e.data)&&void 0!==t&&null!==(t=t.flows)&&void 0!==t&&t.length)e.startNextAuthStage();else{var n;null===(n=e.busyChangedCallback)||void 0===n||n.call(e,!0);var i=e.data.session?{session:e.data.session}:null;e.doRequest(i).finally((()=>{var t;null===(t=e.busyChangedCallback)||void 0===t||t.call(e,!1)}))}return r}))()}poll(){var e=this;return(0,o.A)((function*(){if(e.data.session&&e.attemptAuthDeferred&&!e.submitPromise){var t={};if(e.currentStage==ne&&e.emailSid){var r={sid:e.emailSid,client_secret:e.clientSecret},n=e.matrixClient.getIdentityServerUrl();n&&(r.id_server=new URL(n).host),t={type:ne,threepid_creds:r}}e.submitAuthDict(t,!0)}}))()}getSessionId(){var e;return null===(e=this.data)||void 0===e?void 0:e.session}getClientSecret(){return this.clientSecret}getStageParams(e){var t;return null===(t=this.data)||void 0===t||null===(t=t.params)||void 0===t?void 0:t[e]}getChosenFlow(){return this.chosenFlow}submitAuthDict(e){var t=arguments,r=this;return(0,o.A)((function*(){var n,i,o,s=t.length>1&&void 0!==t[1]&&t[1];if(!r.attemptAuthDeferred)throw new Error("submitAuthDict() called before attemptAuth()");s||(null===(i=r.busyChangedCallback)||void 0===i||i.call(r,!0));while(r.submitPromise)try{yield r.submitPromise}catch(c){}null!==(n=r.data)&&void 0!==n&&n.session?(o={session:r.data.session},Object.assign(o,e)):o=e;try{r.submitPromise=r.doRequest(o,s),yield r.submitPromise}finally{var a;if(r.submitPromise=null,!s)null===(a=r.busyChangedCallback)||void 0===a||a.call(r,!1)}}))()}getEmailSid(){return this.emailSid}setEmailSid(e){this.emailSid=e}doRequest(e){var t=arguments,r=this;return(0,o.A)((function*(){var n=t.length>1&&void 0!==t[1]&&t[1];try{var i=yield r.requestCallback(e,n);r.attemptAuthDeferred.resolve(i),r.attemptAuthDeferred=null}catch(v){var o,s,a,c,l,d=v instanceof O.up?v:null,u=null!==(o=null===d||void 0===d||null===(s=d.data)||void 0===s?void 0:s.flows)&&void 0!==o?o:null,h=(null===(a=r.data)||void 0===a?void 0:a.flows)||Boolean(u);if(!d||401!==d.httpStatus||!d.data||!h)if(n)m.v.log("Background poll request failed doing UI auth: ignoring",v);else null===(l=r.attemptAuthDeferred)||void 0===l||l.reject(v);d&&!d.data&&(d.data={}),!d||d.data.flows||d.data.completed||d.data.session||(d.data.flows=r.data.flows,d.data.completed=r.data.completed,d.data.session=r.data.session),d&&(r.data=d.data);try{r.startNextAuthStage()}catch(p){return r.attemptAuthDeferred.reject(p),void(r.attemptAuthDeferred=null)}if(!r.emailSid&&null!==(c=r.chosenFlow)&&void 0!==c&&c.stages.includes(oe.Email))try{yield r.requestEmailToken()}catch(p){r.attemptAuthDeferred.reject(p),r.attemptAuthDeferred=null}}}))()}startNextAuthStage(){var e,t,r,n,i=this.chooseStage();if(!i)throw new Error("No incomplete flows from the server");(this.currentStage=i,i!==oe.Dummy)?null!==(e=this.data)&&void 0!==e&&e.errcode||null!==(t=this.data)&&void 0!==t&&t.error?this.stateUpdatedCallback(i,{errcode:(null===(r=this.data)||void 0===r?void 0:r.errcode)||"",error:(null===(n=this.data)||void 0===n?void 0:n.error)||""}):this.stateUpdatedCallback(i,i===ne?{emailSid:this.emailSid}:{}):this.submitAuthDict({type:"m.login.dummy"})}chooseStage(){null===this.chosenFlow&&(this.chosenFlow=this.chooseFlow()),m.v.log("Active flow => %s",JSON.stringify(this.chosenFlow));var e=this.firstUncompletedStage(this.chosenFlow);return m.v.log("Next stage: %s",e),e}scoreFlow(e){var t=e.stages.length;return void 0!==this.supportedStages&&(t+=10*e.stages.filter((e=>!this.supportedStages.has(e))).length),t}chooseFlow(){var e,t=(null===(e=this.data)||void 0===e?void 0:e.flows)||[],r=Boolean(this.inputs.emailAddress)||Boolean(this.emailSid),n=Boolean(this.inputs.phoneCountry)&&Boolean(this.inputs.phoneNumber);for(var i of(t.sort(((e,t)=>this.scoreFlow(e)-this.scoreFlow(t))),t)){var o=!1,s=!1;for(var a of i.stages)a===ne?o=!0:a==ie&&(s=!0);if(o==r&&s==n)return i}var c=[];throw r&&c.push(ne),n&&c.push(ie),new se("No appropriate authentication flow found",c,t)}firstUncompletedStage(e){var t,r=(null===(t=this.data)||void 0===t?void 0:t.completed)||[];return e.stages.find((e=>!r.includes(e)))}}var ce=r(9061),le=r(6508),de=r(6856),ue=[e=>{e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})},e=>{var t=e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]});t.createIndex("room","room_id")},e=>{e.createObjectStore("client_options",{keyPath:["clobber"]})},e=>{e.createObjectStore("to_device_queue",{autoIncrement:!0})}],he=ue.length;function ve(e,t,r){var n=e.openCursor(t);return new Promise(((e,t)=>{var i=[];n.onerror=()=>{var e;t(new Error("Query failed: "+(null===(e=n.error)||void 0===e?void 0:e.name)))},n.onsuccess=()=>{var t=n.result;t?(i.push(r(t)),t.continue()):e(i)}}))}function pe(e){return new Promise(((t,r)=>{e.oncomplete=function(e){t(e)},e.onerror=function(){r(e.error)}}))}function fe(e){return new Promise(((t,r)=>{e.onsuccess=function(e){t(e)},e.onerror=function(){r(e.error)}}))}function ge(e){return new Promise(((t,r)=>{e.onsuccess=()=>t(e),e.onerror=e=>r(e)}))}function me(e){return fe(e).then((t=>e.result))}class ye{static exists(e,t){return t="matrix-js-sdk:"+(t||"default"),(0,de.t)(e,t)}constructor(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default";this.indexedDB=e,(0,s.A)(this,"dbName",void 0),(0,s.A)(this,"syncAccumulator",void 0),(0,s.A)(this,"db",void 0),(0,s.A)(this,"disconnected",!0),(0,s.A)(this,"_isNewlyCreated",!1),(0,s.A)(this,"syncToDatabasePromise",void 0),(0,s.A)(this,"pendingUserPresenceData",[]),this.dbName="matrix-js-sdk:"+t,this.syncAccumulator=new L}connect(e){var t=this;if(!this.disconnected)return m.v.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this.disconnected=!1,m.v.log("LocalIndexedDBStoreBackend.connect: connecting...");var r=this.indexedDB.open(this.dbName,he);return r.onupgradeneeded=e=>{var t=r.result,n=e.oldVersion;m.v.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(n)),n<1&&(this._isNewlyCreated=!0),ue.forEach(((e,r)=>{n<=r&&e(t)}))},r.onblocked=()=>{m.v.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},m.v.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),fe(r).then((0,o.A)((function*(){m.v.log("LocalIndexedDBStoreBackend.connect: connected"),t.db=r.result,t.db.onversionchange=()=>{var e;null===(e=t.db)||void 0===e||e.close(),t.disconnected=!0,t.db=void 0},t.db.onclose=()=>{t.disconnected=!0,t.db=void 0,null===e||void 0===e||e()},yield t.init()})))}isNewlyCreated(){return Promise.resolve(this._isNewlyCreated)}init(){return Promise.all([this.loadAccountData(),this.loadSyncData()]).then((e=>{var[t,r]=e;m.v.log("LocalIndexedDBStoreBackend: loaded initial data"),this.syncAccumulator.accumulate({next_batch:r.nextBatch,rooms:r.roomsData,account_data:{events:t}},!0)}))}getOutOfBandMembers(e){return new Promise(((t,r)=>{var n=this.db.transaction(["oob_membership_events"],"readonly"),i=n.objectStore("oob_membership_events"),o=i.index("room"),s=IDBKeyRange.only(e),a=o.openCursor(s),c=[],l=!1;a.onsuccess=()=>{var e=a.result;if(!e)return c.length||l?t(c):t(null);var r=e.value;r.oob_written?l=!0:c.push(r),e.continue()},a.onerror=e=>{r(e)}})).then((t=>(m.v.log("LL: got ".concat(null===t||void 0===t?void 0:t.length," membershipEvents from storage for room ").concat(e," ...")),t)))}setOutOfBandMembers(e,t){var r=this;return(0,o.A)((function*(){m.v.log("LL: backend about to store ".concat(t.length)+" members for ".concat(e));var n=r.db.transaction(["oob_membership_events"],"readwrite"),i=n.objectStore("oob_membership_events");t.forEach((e=>{i.put(e)}));var o={room_id:e,oob_written:!0,state_key:0};i.put(o),yield pe(n),m.v.log("LL: backend done storing for ".concat(e,"!"))}))()}clearOutOfBandMembers(e){var t=this;return(0,o.A)((function*(){var r=t.db.transaction(["oob_membership_events"],"readonly"),n=r.objectStore("oob_membership_events"),i=n.index("room"),o=IDBKeyRange.only(e),s=me(i.openKeyCursor(o,"next")).then((e=>(null===e||void 0===e?void 0:e.primaryKey)[1])),a=me(i.openKeyCursor(o,"prev")).then((e=>(null===e||void 0===e?void 0:e.primaryKey)[1])),[c,l]=yield Promise.all([s,a]),d=t.db.transaction(["oob_membership_events"],"readwrite"),u=d.objectStore("oob_membership_events"),h=IDBKeyRange.bound([e,c],[e,l]);m.v.log("LL: Deleting all users + marker in storage for room ".concat(e,", with key range:"),[e,c],[e,l]),yield ge(u.delete(h))}))()}clearDatabase(){return new Promise((e=>{var t;m.v.log("Removing indexeddb instance: ".concat(this.dbName)),null===(t=this.db)||void 0===t||t.close();var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{m.v.log("can't yet delete indexeddb ".concat(this.dbName," because it is open elsewhere"))},r.onerror=()=>{var t;m.v.warn("unable to delete js-sdk store indexeddb: ".concat(null===(t=r.error)||void 0===t?void 0:t.name)),e()},r.onsuccess=()=>{m.v.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}))}getSavedSync(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve((0,c.A4)(t)):Promise.resolve(t):Promise.resolve(null)}getNextBatchToken(){return Promise.resolve(this.syncAccumulator.getNextBatchToken())}setSyncData(e){return Promise.resolve().then((()=>{this.syncAccumulator.accumulate(e)}))}syncToDatabase(e){var t=this;return(0,o.A)((function*(){return t.syncToDatabasePromise?(m.v.warn("Skipping syncToDatabase() as persist already in flight"),t.pendingUserPresenceData.push(...e),t.syncToDatabasePromise):(e.unshift(...t.pendingUserPresenceData),t.syncToDatabasePromise=t.doSyncToDatabase(e),t.syncToDatabasePromise)}))()}doSyncToDatabase(e){var t=this;return(0,o.A)((function*(){try{var r=t.syncAccumulator.getJSON(!0);yield Promise.all([t.persistUserPresenceEvents(e),t.persistAccountData(r.accountData),t.persistSyncData(r.nextBatch,r.roomsData)])}finally{t.syncToDatabasePromise=void 0}}))()}persistSyncData(e,t){return m.v.log("Persisting sync data up to",e),(0,c.j0)((()=>{var r=this.db.transaction(["sync"],"readwrite"),n=r.objectStore("sync");return n.put({clobber:"-",nextBatch:e,roomsData:t}),pe(r).then((()=>{m.v.log("Persisted sync data up to",e)}))}))}persistAccountData(e){return(0,c.j0)((()=>{var t=this.db.transaction(["accountData"],"readwrite"),r=t.objectStore("accountData");for(var n of e)r.put(n);return pe(t).then()}))}persistUserPresenceEvents(e){return(0,c.j0)((()=>{var t=this.db.transaction(["users"],"readwrite"),r=t.objectStore("users");for(var n of e)r.put({userId:n[0],event:n[1]});return pe(t).then()}))}getUserPresenceEvents(){return(0,c.j0)((()=>{var e=this.db.transaction(["users"],"readonly"),t=e.objectStore("users");return ve(t,void 0,(e=>[e.value.userId,e.value.event]))}))}loadAccountData(){return m.v.log("LocalIndexedDBStoreBackend: loading account data..."),(0,c.j0)((()=>{var e=this.db.transaction(["accountData"],"readonly"),t=e.objectStore("accountData");return ve(t,void 0,(e=>e.value)).then((e=>(m.v.log("LocalIndexedDBStoreBackend: loaded account data"),e)))}))}loadSyncData(){return m.v.log("LocalIndexedDBStoreBackend: loading sync data..."),(0,c.j0)((()=>{var e=this.db.transaction(["sync"],"readonly"),t=e.objectStore("sync");return ve(t,void 0,(e=>e.value)).then((e=>(m.v.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&m.v.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{})))}))}getClientOptions(){return Promise.resolve().then((()=>{var e=this.db.transaction(["client_options"],"readonly"),t=e.objectStore("client_options");return ve(t,void 0,(e=>{var t;return null===(t=e.value)||void 0===t?void 0:t.options})).then((e=>e[0]))}))}storeClientOptions(e){var t=this;return(0,o.A)((function*(){var r=t.db.transaction(["client_options"],"readwrite"),n=r.objectStore("client_options");n.put({clobber:"-",options:e}),yield pe(r)}))()}saveToDeviceBatches(e){var t=this;return(0,o.A)((function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");for(var i of e)n.add(i);yield pe(r)}))()}getOldestToDeviceBatch(){var e=this;return(0,o.A)((function*(){var t=e.db.transaction(["to_device_queue"],"readonly"),r=t.objectStore("to_device_queue"),n=yield me(r.openCursor());if(!n)return null;var i=n.value;return{id:n.key,txnId:i.txnId,eventType:i.eventType,batch:i.batch}}))()}removeToDeviceBatch(e){var t=this;return(0,o.A)((function*(){var r=t.db.transaction(["to_device_queue"],"readwrite"),n=r.objectStore("to_device_queue");n.delete(e),yield pe(r)}))()}destroy(){var e=this;return(0,o.A)((function*(){var t;null===(t=e.db)||void 0===t||t.close()}))()}}class Se{constructor(e,t){this.workerFactory=e,this.dbName=t,(0,s.A)(this,"worker",void 0),(0,s.A)(this,"nextSeq",0),(0,s.A)(this,"inFlight",{}),(0,s.A)(this,"startPromise",void 0),(0,s.A)(this,"onWorkerMessage",(e=>{var t,r=e.data;if("closed"==r.command)null===(t=this.onClose)||void 0===t||t.call(this);else if("cmd_success"==r.command||"cmd_fail"==r.command){if(void 0===r.seq)return void m.v.error("Got reply from worker with no seq");var n=this.inFlight[r.seq];if(void 0===n)return void m.v.error("Got reply for unknown seq "+r.seq);if(delete this.inFlight[r.seq],"cmd_success"==r.command)n.resolve(r.result);else{var i=new Error(r.error.message);i.name=r.error.name,n.reject(i)}}else m.v.warn("Unrecognised message from worker: ",r)}))}connect(e){return this.onClose=e,this.ensureStarted().then((()=>this.doCmd("connect")))}clearDatabase(){return this.ensureStarted().then((()=>this.doCmd("clearDatabase")))}isNewlyCreated(){return this.doCmd("isNewlyCreated")}getSavedSync(){return this.doCmd("getSavedSync")}getNextBatchToken(){return this.doCmd("getNextBatchToken")}setSyncData(e){return this.doCmd("setSyncData",[e])}syncToDatabase(e){return this.doCmd("syncToDatabase",[e])}getOutOfBandMembers(e){return this.doCmd("getOutOfBandMembers",[e])}setOutOfBandMembers(e,t){return this.doCmd("setOutOfBandMembers",[e,t])}clearOutOfBandMembers(e){return this.doCmd("clearOutOfBandMembers",[e])}getClientOptions(){return this.doCmd("getClientOptions")}storeClientOptions(e){return this.doCmd("storeClientOptions",[e])}getUserPresenceEvents(){return this.doCmd("getUserPresenceEvents")}saveToDeviceBatches(e){var t=this;return(0,o.A)((function*(){return t.doCmd("saveToDeviceBatches",[e])}))()}getOldestToDeviceBatch(){var e=this;return(0,o.A)((function*(){return e.doCmd("getOldestToDeviceBatch")}))()}removeToDeviceBatch(e){var t=this;return(0,o.A)((function*(){return t.doCmd("removeToDeviceBatch",[e])}))()}ensureStarted(){return this.startPromise||(this.worker=this.workerFactory(),this.worker.onmessage=this.onWorkerMessage,this.startPromise=this.doCmd("setupWorker",[this.dbName]).then((()=>{m.v.log("IndexedDB worker is ready")}))),this.startPromise}doCmd(e,t){return Promise.resolve().then((()=>{var r,n=this.nextSeq++,i=(0,c.v6)();return this.inFlight[n]=i,null===(r=this.worker)||void 0===r||r.postMessage({command:e,seq:n,args:t}),i.promise}))}destroy(){var e=this;return(0,o.A)((function*(){var t;null===(t=e.worker)||void 0===t||t.terminate()}))()}}var be=3e5;class Ee extends u{static exists(e,t){return ye.exists(e,t)}constructor(e){if(super(e),(0,s.A)(this,"backend",void 0),(0,s.A)(this,"startedUp",!1),(0,s.A)(this,"syncTs",0),(0,s.A)(this,"userModifiedMap",{}),(0,s.A)(this,"emitter",new $.X),(0,s.A)(this,"onClose",(()=>{this.emitter.emit("closed")})),(0,s.A)(this,"getSavedSync",this.degradable((()=>this.backend.getSavedSync()),"getSavedSync")),(0,s.A)(this,"isNewlyCreated",this.degradable((()=>this.backend.isNewlyCreated()),"isNewlyCreated")),(0,s.A)(this,"getSavedSyncToken",this.degradable((()=>this.backend.getNextBatchToken()),"getSavedSyncToken")),(0,s.A)(this,"deleteAllData",this.degradable((()=>(super.deleteAllData(),this.backend.clearDatabase().then((()=>{m.v.log("Deleted indexeddb data.")}),(e=>{throw m.v.error("Failed to delete indexeddb data: ".concat(e)),e})))),null)),(0,s.A)(this,"reallySave",this.degradable((()=>{this.syncTs=Date.now();var e=[];for(var t of this.getUsers())this.userModifiedMap[t.userId]!==t.getLastModifiedTime()&&t.events.presence&&(e.push([t.userId,t.events.presence.event]),this.userModifiedMap[t.userId]=t.getLastModifiedTime());return this.backend.syncToDatabase(e)}),null)),(0,s.A)(this,"setSyncData",this.degradable((e=>this.backend.setSyncData(e)),"setSyncData")),(0,s.A)(this,"getOutOfBandMembers",this.degradable((e=>this.backend.getOutOfBandMembers(e)),"getOutOfBandMembers")),(0,s.A)(this,"setOutOfBandMembers",this.degradable(((e,t)=>(super.setOutOfBandMembers(e,t),this.backend.setOutOfBandMembers(e,t))),"setOutOfBandMembers")),(0,s.A)(this,"clearOutOfBandMembers",this.degradable((e=>(super.clearOutOfBandMembers(e),this.backend.clearOutOfBandMembers(e))),"clearOutOfBandMembers")),(0,s.A)(this,"getClientOptions",this.degradable((()=>this.backend.getClientOptions()),"getClientOptions")),(0,s.A)(this,"storeClientOptions",this.degradable((e=>(super.storeClientOptions(e),this.backend.storeClientOptions(e))),"storeClientOptions")),!e.indexedDB)throw new Error("Missing required option: indexedDB");e.workerFactory?this.backend=new Se(e.workerFactory,e.dbName):this.backend=new ye(e.indexedDB,e.dbName)}on(e,t){this.emitter.on(e,t)}startup(){return this.startedUp?(m.v.log("IndexedDBStore.startup: already started"),Promise.resolve()):(m.v.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect(this.onClose).then((()=>(m.v.log("IndexedDBStore.startup: loading presence events"),this.backend.getUserPresenceEvents()))).then((e=>{m.v.log("IndexedDBStore.startup: processing presence events"),e.forEach((e=>{var[t,r]=e;if(!this.createUser)throw new Error("`IndexedDBStore.startup` must be called after assigning it to the client, not before!");var n=this.createUser(t);r&&n.setPresenceEvent(new f.kl(r)),this.userModifiedMap[n.userId]=n.getLastModifiedTime(),this.storeUser(n)})),this.startedUp=!0})))}destroy(){return this.backend.destroy()}wantsSave(){var e=Date.now();return e-this.syncTs>be}save(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e||this.wantsSave()?this.reallySave():Promise.resolve()}degradable(e,t){var r=this,n=t?super[t]:null;return(0,o.A)((function*(){for(var t=arguments.length,i=new Array(t),o=0;o<t;o++)i[o]=arguments[o];try{return yield e.call(r,...i)}catch(s){m.v.error("IndexedDBStore failure, degrading to MemoryStore",s),r.emitter.emit("degraded",s);try{m.v.log("IndexedDBStore trying to delete degraded data"),yield r.backend.clearDatabase(),m.v.log("IndexedDBStore delete after degrading succeeded")}catch(s){m.v.warn("IndexedDBStore delete after degrading failed",s)}if(n)return n.call(r,...i)}}))}getPendingEvents(e){var t=()=>super.getPendingEvents,r=this;return(0,o.A)((function*(){if(!r.localStorage)return t().call(r,e);var n=r.localStorage.getItem(_e(e));if(n)try{return JSON.parse(n)}catch(i){m.v.error("Could not parse persisted pending events",i)}return[]}))()}setPendingEvents(e,t){var r=()=>super.setPendingEvents,n=this;return(0,o.A)((function*(){if(!n.localStorage)return r().call(n,e,t);t.length>0?n.localStorage.setItem(_e(e),JSON.stringify(t)):n.localStorage.removeItem(_e(e))}))()}saveToDeviceBatches(e){return this.backend.saveToDeviceBatches(e)}getOldestToDeviceBatch(){return this.backend.getOldestToDeviceBatch()}removeToDeviceBatch(e){return this.backend.removeToDeviceBatch(e)}}function _e(e){return"mx_pending_events_".concat(e)}var we=r(1949),Ie=r(8968),Te=r(4279),Re=r(9898),ke=r(3232),Ae=r(6255),Ce=r(8161),Oe=r(7621),De=r(5677),Me=r(9454),Pe=function(e){return e["Email"]="email",e["Phone"]="msisdn",e}({}),xe=r(4229),Ue=new xe.qr("delegated_oidc_compatibility","org.matrix.msc3824.delegated_oidc_compatibility"),Le=function(e){return e["Gitlab"]="gitlab",e["Github"]="github",e["Apple"]="apple",e["Google"]="google",e["Facebook"]="facebook",e["Twitter"]="twitter",e}({}),Ne=function(e){return e["LOGIN"]="login",e["REGISTER"]="register",e}({}),Be=r(7419),Ke=r(8645),Fe=r(7898),je=r(9838),qe=(r(4977),"us.cloke.msc4175.tz");r(8237);class Ve{constructor(e){(0,s.A)(this,"relations",void 0),this.relations=e.filter((e=>!!e))}getRelations(){return this.relations.reduce(((e,t)=>[...e,...t.getRelations()]),[])}on(e,t){this.relations.forEach((r=>r.on(e,t)))}off(e,t){this.relations.forEach((r=>r.off(e,t)))}}var Ge=r(806),We=r(1915),He=r(3061),$e=r(4768),Je=r(3562),ze=r(6317),Ye=r(1009),Qe=r(1240),Xe=r(4520),Ze=r(9927),et=function(e){return e["Global"]="Global",e["SetItemError"]="setItem",e["GetItemError"]="getItem",e["RemoveItemError"]="removeItem",e["ClearError"]="clear",e["QuotaExceededError"]="QuotaExceededError",e}({});class tt extends $.X{}var rt,nt=new tt,it=r(4864),ot=()=>new i._;function st(e){ot=e}function at(e){var t,r,n;return e.store=null!==(t=e.store)&&void 0!==t?t:new u({localStorage:globalThis.localStorage}),e.scheduler=null!==(r=e.scheduler)&&void 0!==r?r:new h.b,e.cryptoStore=null!==(n=e.cryptoStore)&&void 0!==n?n:ot(),e}function ct(e){return new v.pB(at(e))}function lt(e,t,r,n){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];return new k(e,t,r,at(n),i)}if(globalThis.__js_sdk_entrypoint)throw new Error("Multiple matrix-js-sdk entrypoints detected!");globalThis.__js_sdk_entrypoint=!0;try{rt=globalThis.indexedDB}catch(dt){}rt&&st((()=>new Ie.y(rt,"matrix-js-sdk:crypto"))),globalThis.matrixcs=n},7223:function(e,t,r){"use strict";r(4114),r(8111),r(2489),r(7588),Object.defineProperty(t,"__esModule",{value:!0}),t.PostmessageTransport=void 0;var n=r(9366),i=r(5471),o=["message"];function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function a(e,t){if(null==e)return{};var r,n,i=c(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||Object.prototype.propertyIsEnumerable.call(e,r)&&(i[r]=e[r])}return i}function c(e,t){if(null==e)return{};var r,n,i={},o=Object.keys(e);for(n=0;n<o.length;n++)r=o[n],t.indexOf(r)>=0||(i[r]=e[r]);return i}function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){E(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,_(n.key),n)}}function v(e,t,r){return t&&h(e.prototype,t),r&&h(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function p(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&f(e,t)}function f(e,t){return f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},f(e,t)}function g(e){var t=S();return function(){var r,n=b(e);if(t){var i=b(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return m(this,r)}}function m(e,t){if(t&&("object"===s(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return y(e)}function y(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function S(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function b(e){return b=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},b(e)}function E(e,t,r){return t=_(t),t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _(e){var t=w(e,"string");return"symbol"===s(t)?t:String(t)}function w(e,t){if("object"!==s(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!==s(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var I=function(e){p(r,e);var t=g(r);function r(e,n,i,o){var s;return u(this,r),s=t.call(this),s.sendDirection=e,s.initialWidgetId=n,s.transportWindow=i,s.inboundWindow=o,E(y(s),"strictOriginCheck",!1),E(y(s),"targetOrigin","*"),E(y(s),"timeoutSeconds",10),E(y(s),"_ready",!1),E(y(s),"_widgetId",null),E(y(s),"outboundRequests",new Map),E(y(s),"stopController",new AbortController),s._widgetId=n,s}return v(r,[{key:"ready",get:function(){return this._ready}},{key:"widgetId",get:function(){return this._widgetId||null}},{key:"nextRequestId",get:function(){var e="widgetapi-".concat(Date.now()),t=0,r=e;while(this.outboundRequests.has(r))r="".concat(e,"-").concat(t++);return this.outboundRequests.set(r,null),r}},{key:"sendInternal",value:function(e){console.log("[PostmessageTransport] Sending object to ".concat(this.targetOrigin,": "),e),this.transportWindow.postMessage(e,this.targetOrigin)}},{key:"reply",value:function(e,t){return this.sendInternal(d(d({},e),{},{response:t}))}},{key:"send",value:function(e,t){return this.sendComplete(e,t).then((function(e){return e.response}))}},{key:"sendComplete",value:function(e,t){var r=this;if(!this.ready||!this.widgetId)return Promise.reject(new Error("Not ready or unknown widget ID"));var n={api:this.sendDirection,widgetId:this.widgetId,requestId:this.nextRequestId,action:e,data:t};return e===i.WidgetApiToWidgetAction.UpdateVisibility&&(n["visible"]=t["visible"]),new Promise((function(e,t){var i=function(t){c(),e(t)},o=function(e){c(),t(e)},s=setTimeout((function(){return o(new Error("Request timed out"))}),1e3*(r.timeoutSeconds||1)),a=function(){return o(new Error("Transport stopped"))};r.stopController.signal.addEventListener("abort",a);var c=function(){r.outboundRequests["delete"](n.requestId),clearTimeout(s),r.stopController.signal.removeEventListener("abort",a)};r.outboundRequests.set(n.requestId,{request:n,resolve:i,reject:o}),r.sendInternal(n)}))}},{key:"start",value:function(){var e=this;this.inboundWindow.addEventListener("message",(function(t){e.handleMessage(t)})),this._ready=!0}},{key:"stop",value:function(){this._ready=!1,this.stopController.abort()}},{key:"handleMessage",value:function(e){if(!this.stopController.signal.aborted&&e.data&&(!this.strictOriginCheck||e.origin===window.origin)){var t=e.data;if(t.action&&t.requestId&&t.widgetId)if(t.response){if(t.api!==this.sendDirection)return;this.handleResponse(t)}else{var r=t;if(r.api!==(0,i.invertedDirection)(this.sendDirection))return;this.handleRequest(r)}}}},{key:"handleRequest",value:function(e){if(this.widgetId){if(this.widgetId!==e.widgetId)return}else this._widgetId=e.widgetId;this.emit("message",new CustomEvent("message",{detail:e}))}},{key:"handleResponse",value:function(e){if(e.widgetId===this.widgetId){var t=this.outboundRequests.get(e.requestId);if(t)if((0,i.isErrorResponse)(e.response)){var r=e.response.error,n=r.message,s=a(r,o);t.reject(new i.WidgetApiResponseError(n,s))}else t.resolve(e)}}}]),r}(n.EventEmitter);t.PostmessageTransport=I},7326:function(e,t){"use strict";function r(e){return r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r(e)}function n(e){var t=e.error;return"object"===r(t)&&null!==t&&"message"in t&&"string"===typeof t.message}Object.defineProperty(t,"__esModule",{value:!0}),t.isErrorResponse=n},7347:function(e,t,r){"use strict";var n=r(3724),i=r(9565),o=r(8773),s=r(6980),a=r(5397),c=r(6969),l=r(9297),d=r(5917),u=Object.getOwnPropertyDescriptor;t.f=n?u:function(e,t){if(e=a(e),t=c(t),d)try{return u(e,t)}catch(r){}if(l(e,t))return s(!i(o.f,e,t),e[t])}},7363:function(e,t,r){"use strict";r.d(t,{s:function(){return i}});r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);var n=r(698);function i(e){return o.apply(this,arguments)}function o(){return o=(0,n.A)((function*(e){if(!globalThis.crypto.subtle)throw new Error("Crypto.subtle is not available: insecure context?");var t=(new TextEncoder).encode(e),r=yield globalThis.crypto.subtle.digest("SHA-256",t);return new Uint8Array(r)})),o.apply(this,arguments)}},7394:function(e,t,r){"use strict";var n=r(4576),i=r(6706),o=r(2195),s=n.ArrayBuffer,a=n.TypeError;e.exports=s&&i(s.prototype,"byteLength","get")||function(e){if("ArrayBuffer"!==o(e))throw new a("ArrayBuffer expected");return e.byteLength}},7419:function(e,t,r){"use strict";r.d(t,{$S:function(){return s},cI:function(){return c},li:function(){return o},ms:function(){return i},qN:function(){return a}});var n=r(7046),i=new n.UnstableValue("m.poll.disclosed","org.matrix.msc3381.poll.disclosed"),o=new n.UnstableValue("m.poll.undisclosed","org.matrix.msc3381.poll.undisclosed"),s=new n.UnstableValue("m.poll.start","org.matrix.msc3381.poll.start"),a=new n.UnstableValue("m.poll.response","org.matrix.msc3381.poll.response"),c=new n.UnstableValue("m.poll.end","org.matrix.msc3381.poll.end")},7430:function(e,t,r){"use strict";r.d(t,{a:function(){return i}});var n=r(4229),i=new n.M6("unread_thread_notifications","org.matrix.msc3773.unread_thread_notifications")},7467:function(e,t,r){"use strict";var n=r(7628),i=r(4644),o=i.aTypedArray,s=i.exportTypedArrayMethod,a=i.getTypedArrayConstructor;s("toReversed",(function(){return n(o(this),a(this))}))},7476:function(e,t,r){"use strict";var n=r(2195),i=r(9504);e.exports=function(e){if("Function"===n(e))return i(e)}},7528:function(e,t,r){"use strict";r.d(t,{FD:function(){return E},H:function(){return T},RN:function(){return R},UR:function(){return A},c1:function(){return b},jV:function(){return _},ju:function(){return S},o1:function(){return I},x3:function(){return k}});r(4114),r(8111),r(2489),r(7588),r(1701);var n=r(698),i=r(4761),o=r(4108),s=r(5462),a=r(5629),c=r(3178),l=r(2292),d=r(1337),u=r(8965),h=r(4229),v=r(3271),p=r(7825),f=r(8645),g=r(9381);function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var S=function(e){return e["New"]="Thread.new",e["Update"]="Thread.update",e["NewReply"]="Thread.newReply",e["ViewThread"]="Thread.viewThread",e["Delete"]="Thread.delete",e}({}),b=function(e){return e[e["None"]=0]="None",e[e["Experimental"]=1]="Experimental",e[e["Stable"]=2]="Stable",e}({});function E(e,t){return e?b.Stable:t?b.Experimental:b.None}class _ extends p.h{constructor(e,t,r){var a,l;if(super(),a=this,this.id=e,this.rootEvent=t,(0,i.A)(this,"timelineSet",void 0),(0,i.A)(this,"_currentUserParticipated",!1),(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"lastEvent",void 0),(0,i.A)(this,"replyCount",0),(0,i.A)(this,"lastPendingEvent",void 0),(0,i.A)(this,"pendingReplyCount",0),(0,i.A)(this,"room",void 0),(0,i.A)(this,"client",void 0),(0,i.A)(this,"pendingEventOrdering",void 0),(0,i.A)(this,"processRootEventPromise",void 0),(0,i.A)(this,"initialEventsFetched",!_.hasServerSideSupport),(0,i.A)(this,"initalEventFetchProm",void 0),(0,i.A)(this,"replayEvents",[]),(0,i.A)(this,"onTimelineReset",(0,n.A)((function*(){yield a.processRootEventPromise,a.processRootEventPromise=void 0}))),(0,i.A)(this,"onBeforeRedaction",((e,t)=>{null!==e&&void 0!==e&&e.isRelation(R.name)&&this.room.eventShouldLiveIn(e).threadId===this.id&&e.getId()!==this.id&&!t.status&&(this.replyCount--,this.updatePendingReplyCount(),this.emit(S.Update,this))})),(0,i.A)(this,"onRedaction",function(){var e=(0,n.A)((function*(e,t,r){if(r===a.id)if(a.replyCount<=0){for(var n of a.timeline)a.clearEventMetadata(n);a.lastEvent=a.rootEvent,a._currentUserParticipated=!1,a.emit(S.Delete,a)}else{var i;(null===(i=a.lastEvent)||void 0===i?void 0:i.getId())===e.getAssociatedId()&&(yield a.processRootEventPromise,a.processRootEventPromise=void 0),yield a.updateThreadMetadata()}}));return function(t,r,n){return e.apply(this,arguments)}}()),(0,i.A)(this,"onTimelineEvent",((e,t,r)=>{if(!r){var n=e.getSender();n&&t&&this.shouldSendLocalEchoReceipt(n,e)&&t.addLocalEchoReceipt(n,e,f.L.Read),e.getId()!==this.id&&e.isRelation(R.name)&&this.replyCount++}this.onEcho(e,null!==r&&void 0!==r&&r)})),(0,i.A)(this,"onLocalEcho",(e=>{this.onEcho(e,!1)})),(0,i.A)(this,"onEcho",function(){var e=(0,n.A)((function*(e,t){e.threadRootId===a.id&&a.lastEvent!==e&&(yield a.updateThreadMetadata(),e.isRelation(R.name)&&(t||(a.lastEvent=void 0,a.emit(S.NewReply,a,e))))}));return function(t,r){return e.apply(this,arguments)}}()),this.setMaxListeners(1e3),null===r||void 0===r||!r.room)throw new Error("element-web#22141: A thread requires a room in order to function");this.room=r.room,this.client=r.client,this.pendingEventOrdering=null!==(l=r.pendingEventOrdering)&&void 0!==l?l:o.eO.Chronological,this.timelineSet=new d.m(this.room,{timelineSupport:!0,pendingEvents:!0},this.client,this),this.reEmitter=new s.Q(this),this.reEmitter.reEmit(this.timelineSet,[u.u9.Timeline,u.u9.TimelineReset]),this.room.on(c.OQ.BeforeRedaction,this.onBeforeRedaction),this.room.on(u.u9.Redaction,this.onRedaction),this.room.on(u.u9.LocalEchoUpdated,this.onLocalEcho),this.room.on(u.u9.TimelineReset,this.onTimelineReset),this.timelineSet.on(u.u9.Timeline,this.onTimelineEvent),this.processReceipts(r.receipts),this.updateThreadMetadata(),this.setEventMetadata(this.rootEvent)}fetchRootEvent(){var e=this;return(0,n.A)((function*(){try{var t=yield e.client.fetchRoomEvent(e.roomId,e.id),r=e.client.getEventMapper();e.rootEvent=r(t)}catch(n){v.v.error("Failed to fetch thread root to construct thread with",n)}yield e.processEvent(e.rootEvent)}))()}static setServerSideSupport(e){_.hasServerSideSupport=e,e!==b.Stable&&(I.setPreferUnstable(!0),T.setPreferUnstable(!0),R.setPreferUnstable(!0))}static setServerSideListSupport(e){_.hasServerSideListSupport=e}static setServerSideFwdPaginationSupport(e){_.hasServerSideFwdPaginationSupport=e}shouldSendLocalEchoReceipt(e,t){var r,n=null!==(r=this.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==r?r:g.Tj.Unsupported;if(n===g.Tj.Unsupported){var i,o=null===(i=this.getReadReceiptForUserId(e))||void 0===i?void 0:i.eventId;if(o){var s=this.findEventById(o);if(s&&s.getTs()>t.getTs())return!1}}return!0}get roomState(){return this.room.getLiveTimeline().getState(l.q.FORWARDS)}addEventToTimeline(e,t){this.findEventById(e.getId())||this.timelineSet.addEventToTimeline(e,this.liveTimeline,{toStartOfTimeline:t,fromCache:!1,roomState:this.roomState,addToState:!1})}insertEventIntoTimeline(e){var t=e.getId();t&&(this.findEventById(t)||this.timelineSet.insertEventIntoTimeline(e,this.liveTimeline,this.roomState,!1))}addEvents(e,t){e.forEach((e=>this.addEvent(e,t,!1))),this.updateThreadMetadata()}addEvent(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];this.setEventMetadata(e);var n=this.lastReply(),i=!n||e.localTimestamp>=n.localTimestamp;if(_.hasServerSideSupport){if(e.isRelation(a.zZ.Annotation)||e.isRelation(a.zZ.Replace))return void this.addRelatedThreadEvent(e,t);!t&&i?(this.addEventToTimeline(e,!1),this.fetchEditsWhereNeeded(e)):t?this.addEventToTimeline(e,t):this.insertEventIntoTimeline(e)}else this.addEventToTimeline(e,t),this.client.decryptEventIfNeeded(e);e.getId()!==this.id&&e.isRelation(R.name)&&!t&&i&&(this.lastEvent=void 0),r&&(this.emit(S.NewReply,this,e),this.updateThreadMetadata())}addRelatedThreadEvent(e,t){var r,n;if(this.initialEventsFetched){var i,o=null!==(i=this.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==i?i:g.Tj.Unsupported;o===g.Tj.Unsupported?this.insertEventIntoTimeline(e):this.addEventToTimeline(e,t)}else{var s;null===(s=this.replayEvents)||void 0===s||s.push(e)}null===(r=this.timelineSet.relations)||void 0===r||r.aggregateParentEvent(e),null===(n=this.timelineSet.relations)||void 0===n||n.aggregateChildEvent(e,this.timelineSet)}processEvent(e){var t=this;return(0,n.A)((function*(){e&&(t.setEventMetadata(e),yield t.fetchEditsWhereNeeded(e))}))()}processReceipts(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];for(var{eventId:t,receiptType:r,userId:n,receipt:i,synthetic:o}of e)this.addReceiptToStructure(t,r,n,i,o)}getRootEventBundledRelationship(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.rootEvent;return null===e||void 0===e?void 0:e.getServerAggregatedRelation(R.name)}processRootEvent(){var e=this;return(0,n.A)((function*(){var t=e.getRootEventBundledRelationship();if(_.hasServerSideSupport&&t){e.replyCount=t.count,e._currentUserParticipated=!!t.current_user_participated;var r=e.client.getEventMapper();e.lastEvent=r(y(y({},t.latest_event),{},{room_id:e.roomId})),e.updatePendingReplyCount(),yield e.processEvent(e.lastEvent)}}))()}updatePendingReplyCount(){var e=this.pendingEventOrdering===o.eO.Detached?this.room.getPendingEvents():this.events,t=e.filter((e=>{var t;return e.threadRootId===this.id&&e.isRelation(R.name)&&null!==e.status&&e.getId()!==(null===(t=this.lastEvent)||void 0===t?void 0:t.getId())}));this.lastPendingEvent=t.length?t[t.length-1]:void 0,this.pendingReplyCount=t.length}resetLiveTimeline(e,t){var r=this;return(0,n.A)((function*(){var n=r.liveTimeline;r.timelineSet.resetLiveTimeline(null!==e&&void 0!==e?e:void 0,null!==t&&void 0!==t?t:void 0);var i,o,s,a,c=r.liveTimeline;if(e){var d=yield r.client.createMessagesRequest(r.roomId,e,1,l.O.Forward);i=d.end}if(t){var u=yield r.client.createMessagesRequest(r.roomId,t,1,l.O.Backward);o=u.start}t&&n.getPaginationToken(l.O.Forward)===t&&n.setPaginationToken(null!==(s=o)&&void 0!==s?s:null,l.O.Forward);e&&c.getPaginationToken(l.O.Backward)===e&&c.setPaginationToken(null!==(a=i)&&void 0!==a?a:null,l.O.Backward)}))()}updateThreadFromRootEvent(){var e=this;return(0,n.A)((function*(){_.hasServerSideSupport&&(e.initialEventsFetched||e.lastEvent||(yield e.processRootEvent()),yield e.fetchRootEvent()),yield e.processRootEvent()}))()}updateThreadMetadata(){var e=this;return(0,n.A)((function*(){if(e.updatePendingReplyCount(),e.processRootEventPromise||(e.processRootEventPromise=e.updateThreadFromRootEvent()),yield e.processRootEventPromise,!e.initialEventsFetched)if(e.initalEventFetchProm)yield e.initalEventFetchProm;else try{for(var t of(e.timelineSet.resetLiveTimeline(),0===e.replyCount&&e.rootEvent?(e.timelineSet.addEventsToTimeline([e.rootEvent],!0,!1,e.liveTimeline,null),e.liveTimeline.setPaginationToken(null,l.O.Backward)):(e.initalEventFetchProm=e.client.paginateEventTimeline(e.liveTimeline,{backwards:!0}),yield e.initalEventFetchProm),e.initialEventsFetched=!0,e.replayEvents))e.addEvent(t,!1);e.replayEvents=null,e.emit(u.u9.TimelineReset,e.room,e.timelineSet,!0)}catch(r){v.v.error("Failed to load start of newly created thread: ",r),e.initialEventsFetched=!1}e.emit(S.Update,e)}))()}fetchEditsWhereNeeded(){var e=arguments,t=this;return(0,n.A)((function*(){var r,i=null!==(r=t.client.canSupport.get(g.Xj.RelationsRecursion))&&void 0!==r?r:g.Tj.Unsupported;if(i===g.Tj.Unsupported){for(var o=e.length,s=new Array(o),c=0;c<o;c++)s[c]=e[c];return Promise.all(s.filter(w).map(function(){var e=(0,n.A)((function*(e){try{var r=yield t.client.relations(t.roomId,e.getId(),a.zZ.Replace,e.getType(),{limit:1});if(r.events.length){var n=r.events[0];e.makeReplaced(n),t.insertEventIntoTimeline(n)}}catch(i){v.v.error("Failed to load edits for encrypted thread event",i)}}));return function(t){return e.apply(this,arguments)}}()))}}))()}setEventMetadata(e){e&&(l.q.setEventMetadata(e,this.roomState,!1),e.setThread(this))}clearEventMetadata(e){var t;e&&(e.setThread(void 0),null===(t=e.event)||void 0===t||null===(t=t.unsigned)||void 0===t||null===(t=t["m.relations"])||void 0===t||delete t[R.name])}findEventById(e){return this.timelineSet.findEventById(e)}lastReply(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:e=>e.isRelation(R.name),t=this.timeline.length-1;t>=0;t--){var r=this.timeline[t];if(e(r))return r}return null}get roomId(){return this.room.roomId}get length(){return this.replyCount+this.pendingReplyCount}get replyToEvent(){var e,t;return null!==(e=null!==(t=this.lastPendingEvent)&&void 0!==t?t:this.lastEvent)&&void 0!==e?e:this.lastReply()}get timeline(){return this.events}get events(){return this.liveTimeline.getEvents()}has(e){return this.timelineSet.findEventById(e)instanceof c.kl}get hasCurrentUserParticipated(){return this._currentUserParticipated}get liveTimeline(){return this.timelineSet.getLiveTimeline()}getUnfilteredTimelineSet(){return this.timelineSet}addReceipt(e,t){throw new Error("Unsupported function on the thread model")}getEventReadUpTo(e,t){var r=e===this.client.getUserId(),n=this.timeline[this.timeline.length-1];if(r&&n){var i=n.getTs()<this.room.getOldestThreadedReceiptTs(),o=n.getId();if(i&&o)return o}var s=super.getEventReadUpTo(e,t);if(n){var a=this.room.getLastUnthreadedReceiptFor(e);if(!a)return s;for(var c=(null===(l=this.timeline)||void 0===l?void 0:l.length)-1;c>=0;--c){var l,d,u=this.timeline[c];if(u.getId()===s)return s;if(u.getTs()<a.ts)return null!==(d=u.getId())&&void 0!==d?d:s}}return s}hasUserReadEvent(e,t){if(e===this.client.getUserId()){var r,n,i,o,s,a,c=(null!==(r=null===(n=this.lastReply())||void 0===n?void 0:n.getTs())&&void 0!==r?r:0)<this.room.getOldestThreadedReceiptTs(),l=null!==(i=null===(o=this.room.getLastUnthreadedReceiptFor(e))||void 0===o?void 0:o.ts)&&void 0!==i?i:0,d=(null!==(s=null===this||void 0===this||null===(a=this.lastReply())||void 0===a?void 0:a.getTs())&&void 0!==s?s:0)<l;if(c||d)return!0}return this.room.hasUserReadEvent(e,t)}setUnread(e,t){return this.room.setThreadUnreadNotificationCount(this.id,e,t)}getLastUnthreadedReceiptFor(e){return this.room.getLastUnthreadedReceiptFor(e)}}function w(e){return e.isEncrypted()&&(e.isRelation(R.name)||e.isThreadRoot)}(0,i.A)(_,"hasServerSideSupport",b.None),(0,i.A)(_,"hasServerSideListSupport",b.None),(0,i.A)(_,"hasServerSideFwdPaginationSupport",b.None);var I=new h.M6("related_by_senders","io.element.relation_senders"),T=new h.M6("related_by_rel_types","io.element.relation_types"),R=new h.M6("m.thread","io.element.thread"),k=function(e){return e[e["My"]=0]="My",e[e["All"]=1]="All",e}({});function A(e){switch(e){case k.My:return"participated";default:return"all"}}},7562:function(e,t,r){"use strict";r(8111),r(1701);var n=r(144);function i(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")}var o=RegExp(Object.keys(n).map(i).join("|"),"g");function s(e){return n[e]}function a(e){return e.replace(o,s)}e.exports=a},7566:function(e,t,r){"use strict";var n=r(6840),i=r(9504),o=r(655),s=r(2812),a=URLSearchParams,c=a.prototype,l=i(c.getAll),d=i(c.has),u=new a("a=1");!u.has("a",2)&&u.has("a",void 0)||n(c,"has",(function(e){var t=arguments.length,r=t<2?void 0:arguments[1];if(t&&void 0===r)return d(this,e);var n=l(this,e);s(t,1);var i=o(r),a=0;while(a<n.length)if(n[a++]===i)return!0;return!1}),{enumerable:!0,unsafe:!0})},7568:function(e,t,r){var n,i;(function(o,s){"use strict";n=s,i="function"===typeof n?n.call(t,r,t,e):n,void 0===i||(e.exports=i)})(0,(function(){"use strict";var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"],i={},o=null;function s(e,t){var r=e[t];if("function"===typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(n){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function a(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function c(n){return"debug"===n&&(n="log"),typeof console!==t&&("trace"===n&&r?a:void 0!==console[n]?s(console,n):void 0!==console.log?s(console,"log"):e)}function l(){for(var r=this.getLevel(),i=0;i<n.length;i++){var o=n[i];this[o]=i<r?e:this.methodFactory(o,r,this.name)}if(this.log=this.debug,typeof console===t&&r<this.levels.SILENT)return"No console available for logging"}function d(e){return function(){typeof console!==t&&(l.call(this),this[e].apply(this,arguments))}}function u(e,t,r){return c(e)||d.apply(this,arguments)}function h(e,r){var s,a,c,d=this,h="loglevel";function v(e){var r=(n[e]||"silent").toUpperCase();if(typeof window!==t&&h){try{return void(window.localStorage[h]=r)}catch(i){}try{window.document.cookie=encodeURIComponent(h)+"="+r+";"}catch(i){}}}function p(){var e;if(typeof window!==t&&h){try{e=window.localStorage[h]}catch(o){}if(typeof e===t)try{var r=window.document.cookie,n=encodeURIComponent(h),i=r.indexOf(n+"=");-1!==i&&(e=/^([^;]+)/.exec(r.slice(i+n.length+1))[1])}catch(o){}return void 0===d.levels[e]&&(e=void 0),e}}function f(){if(typeof window!==t&&h){try{window.localStorage.removeItem(h)}catch(e){}try{window.document.cookie=encodeURIComponent(h)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch(e){}}}function g(e){var t=e;if("string"===typeof t&&void 0!==d.levels[t.toUpperCase()]&&(t=d.levels[t.toUpperCase()]),"number"===typeof t&&t>=0&&t<=d.levels.SILENT)return t;throw new TypeError("log.setLevel() called with invalid level: "+e)}"string"===typeof e?h+=":"+e:"symbol"===typeof e&&(h=void 0),d.name=e,d.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},d.methodFactory=r||u,d.getLevel=function(){return null!=c?c:null!=a?a:s},d.setLevel=function(e,t){return c=g(e),!1!==t&&v(c),l.call(d)},d.setDefaultLevel=function(e){a=g(e),p()||d.setLevel(e,!1)},d.resetLevel=function(){c=null,f(),l.call(d)},d.enableAll=function(e){d.setLevel(d.levels.TRACE,e)},d.disableAll=function(e){d.setLevel(d.levels.SILENT,e)},d.rebuild=function(){if(o!==d&&(s=g(o.getLevel())),l.call(d),o===d)for(var e in i)i[e].rebuild()},s=g(o?o.getLevel():"WARN");var m=p();null!=m&&(c=g(m)),l.call(d)}o=new h,o.getLogger=function(e){if("symbol"!==typeof e&&"string"!==typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=i[e];return t||(t=i[e]=new h(e,o.methodFactory)),t};var v=typeof window!==t?window.log:void 0;return o.noConflict=function(){return typeof window!==t&&window.log===o&&(window.log=v),o},o.getLoggers=function(){return i},o["default"]=o,o}))},7588:function(e,t,r){"use strict";var n=r(6518),i=r(2652),o=r(9306),s=r(8551),a=r(1767);n({target:"Iterator",proto:!0,real:!0},{forEach:function(e){s(this),o(e);var t=a(this),r=0;i(t,(function(t){e(t,r++)}),{IS_RECORD:!0})}})},7621:function(e,t,r){"use strict";r.d(t,{E:function(){return i},z:function(){return o}});var n=r(4229),i=new n.qr("m.beacon_info","org.matrix.msc3672.beacon_info"),o=new n.qr("m.beacon","org.matrix.msc3672.beacon")},7628:function(e,t,r){"use strict";var n=r(6198);e.exports=function(e,t){for(var r=n(e),i=new t(r),o=0;o<r;o++)i[o]=e[r-o-1];return i}},7629:function(e,t,r){"use strict";var n=r(6395),i=r(4576),o=r(9433),s="__core-js_shared__",a=e.exports=i[s]||o(s,{});(a.versions||(a.versions=[])).push({version:"3.40.0",mode:n?"pure":"global",copyright:"© 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.40.0/LICENSE",source:"https://github.com/zloirock/core-js"})},7642:function(e,t,r){"use strict";var n=r(6518),i=r(3440),o=r(4916),s=!o("difference",(function(e){return 0===e.size}));n({target:"Set",proto:!0,real:!0,forced:s},{difference:i})},7657:function(e,t,r){"use strict";var n,i,o,s=r(9039),a=r(4901),c=r(34),l=r(2360),d=r(2787),u=r(6840),h=r(8227),v=r(6395),p=h("iterator"),f=!1;[].keys&&(o=[].keys(),"next"in o?(i=d(d(o)),i!==Object.prototype&&(n=i)):f=!0);var g=!c(n)||s((function(){var e={};return n[p].call(e)!==e}));g?n={}:v&&(n=l(n)),a(n[p])||u(n,p,(function(){return this})),e.exports={IteratorPrototype:n,BUGGY_SAFARI_ITERATORS:f}},7696:function(e,t,r){"use strict";var n=r(1291),i=r(8014),o=RangeError;e.exports=function(e){if(void 0===e)return 0;var t=n(e),r=i(t);if(t!==r)throw new o("Wrong length or index");return r}},7738:function(e,t,r){"use strict";r.d(t,{b:function(){return l}});r(4114),r(8111),r(2489),r(7588),r(1701);var n=r(4761),i=r(3271),o=r(5629),s=r(6170),a=r(9683),c=!1;class l{static RETRY_BACKOFF_RATELIMIT(e,t,r){return(0,a.fZ)(r,t,!1)}static QUEUE_MESSAGES(e){return e.getType()===o.Bx.RoomMessage||e.hasAssociation()?"message":null}constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:l.RETRY_BACKOFF_RATELIMIT,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:l.QUEUE_MESSAGES;this.retryAlgorithm=e,this.queueAlgorithm=t,(0,n.A)(this,"queues",{}),(0,n.A)(this,"activeQueues",[]),(0,n.A)(this,"procFn",null),(0,n.A)(this,"processQueue",(e=>{var t=this.peekNextEvent(e);t?(d("Queue '%s' has %s pending events",e,this.queues[e].length),Promise.resolve().then((()=>this.procFn(t.event))).then((r=>{this.removeNextEvent(e),d("Queue '%s' sent event %s",e,t.event.getId()),t.defer.resolve(r),this.processQueue(e)}),(r=>{t.attempts+=1;var n=this.retryAlgorithm(t.event,t.attempts,r);d("retry(%s) err=%s event_id=%s waitTime=%s",t.attempts,r,t.event.getId(),n),-1===n?(i.v.info("Queue '%s' giving up on event %s",e,t.event.getId()),this.clearQueue(e,r)):setTimeout(this.processQueue,n,e)}))):this.disableQueue(e)}))}getQueueForEvent(e){var t=this.queueAlgorithm(e);return t&&this.queues[t]?this.queues[t].map((function(e){return e.event})):null}removeEventFromQueue(e){var t=this.queueAlgorithm(e);if(!t||!this.queues[t])return!1;var r=!1;return(0,s.Nz)(this.queues[t],(t=>t.event.getId()===e.getId()&&(r=!0,!0))),r}setProcessFunction(e){this.procFn=e,this.startProcessingQueues()}queueEvent(e){var t=this.queueAlgorithm(e);if(!t)return null;this.queues[t]||(this.queues[t]=[]);var r=(0,s.v6)();return this.queues[t].push({event:e,defer:r,attempts:0}),d("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),this.startProcessingQueues(),r.promise}startProcessingQueues(){this.procFn&&Object.keys(this.queues).filter((e=>-1===this.activeQueues.indexOf(e)&&this.queues[e].length>0)).forEach((e=>{this.activeQueues.push(e),d("Spinning up queue: '%s'",e),this.processQueue(e)}))}disableQueue(e){var t=this.activeQueues.indexOf(e);t>=0&&this.activeQueues.splice(t,1),i.v.info("Stopping queue '%s' as it is now empty",e)}clearQueue(e,t){var r;i.v.info("clearing queue '%s'",e);while(r=this.removeNextEvent(e))r.defer.reject(t);this.disableQueue(e)}peekNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t[0]}removeNextEvent(e){var t=this.queues[e];if(Array.isArray(t))return t.shift()}}function d(){c&&i.v.log(...arguments)}},7740:function(e,t,r){"use strict";var n=r(9297),i=r(5031),o=r(7347),s=r(4913);e.exports=function(e,t,r){for(var a=i(t),c=s.f,l=o.f,d=0;d<a.length;d++){var u=a[d];n(e,u)||r&&n(r,u)||c(e,u,l(t,u))}}},7750:function(e,t,r){"use strict";var n=r(4117),i=TypeError;e.exports=function(e){if(n(e))throw new i("Can't call method on "+e);return e}},7751:function(e,t,r){"use strict";var n=r(4576),i=r(4901),o=function(e){return i(e)?e:void 0};e.exports=function(e,t){return arguments.length<2?o(n[e]):n[e]&&n[e][t]}},7811:function(e){"use strict";e.exports="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView},7825:function(e,t,r){"use strict";r.d(t,{D:function(){return p},h:function(){return m}});r(4114),r(8111),r(2489),r(7588),r(1701);var n=r(4761),i=r(8645),o=r(2668),s=r(6170),a=r(3178),c=r(5629),l=r(8965),d=r(3271),u=r(4108);function h(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function v(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?h(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):h(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function p(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];return new a.kl({content:{[t.getId()]:{[r]:{[e]:v({ts:t.getTs()},!n&&{thread_id:(0,u.Xb)(t)})}}},type:c.Bx.Receipt,room_id:t.getRoomId()})}var f=0,g=1;class m extends o.X{constructor(){super(...arguments),(0,n.A)(this,"receipts",new s.kG((()=>new Map))),(0,n.A)(this,"receiptCacheByEventId",new Map)}getReadReceiptForUserId(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.L.Read,[s,a]=null!==(t=null===(r=this.receipts.get(o))||void 0===r?void 0:r.get(e))&&void 0!==t?t:[null,null];return n?s:null!==a&&void 0!==a?a:s}compareReceipts(e,t){var r;return null!==(r=this.getUnfilteredTimelineSet().compareEventOrdering(e.eventId,t.eventId))&&void 0!==r?r:e.data.ts-t.data.ts}getEventReadUpTo(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.getLatestReceipt(e,t);return r&&this.receiptPointsAtConsistentEvent(r)?r.eventId:null}receiptPointsAtConsistentEvent(e){var t,r=this.findEventById(e.eventId);if(!r)return!1;if(null===(t=e.data)||void 0===t||!t.thread_id)return!0;if(e.data.thread_id===i.S){var n=(0,u.fN)(r);if(n)return!0}else if(r.threadRootId===e.data.thread_id)return!0;return d.v.warn("Ignoring receipt because its thread_id (".concat(e.data.thread_id,") disagrees ")+"with the thread root (".concat(r.threadRootId,") of the referenced event ")+"(event ID = ".concat(e.eventId,")")),!1}getLatestReceipt(e,t){var r,n,o,s=this.getReadReceiptForUserId(e,t,i.L.Read),a=this.getReadReceiptForUserId(e,t,i.L.ReadPrivate);return null!==s&&void 0!==s&&s.eventId&&null!==a&&void 0!==a&&a.eventId&&(o=this.compareReceipts(s,a)),o?null!==(n=o<0?a:s)&&void 0!==n?n:null:null!==(r=null!==a&&void 0!==a?a:s)&&void 0!==r?r:null}addReceiptToStructure(e,t,r,n,i){var o,s,a=this.receipts.getOrCreate(t),c=a.get(r);c||(c=[null,null],a.set(r,c));var l,d=c[f];i&&(d=null!==(l=c[g])&&void 0!==l?l:c[f]);var u={eventId:e,data:n};if(d){var h=this.compareReceipts(d,u);if(h>=0)return}var v=i?c[f]:u,p=i?u:c[g],m=null;v&&p&&(m=this.getUnfilteredTimelineSet().compareEventOrdering(v.eventId,p.eventId));var y=null===m||m<0,S=null!==(o=c[g])&&void 0!==o?o:c[f];i&&y?c[g]=u:i||(c[f]=u,y||(c[g]=null));var b=null!==(s=c[g])&&void 0!==s?s:c[f];if(S!==b){if(S&&this.receiptCacheByEventId.get(S.eventId)){var E=S.eventId;this.receiptCacheByEventId.set(E,this.receiptCacheByEventId.get(E).filter((e=>e.type!==t||e.userId!==r))),this.receiptCacheByEventId.get(E).length<1&&this.receiptCacheByEventId.delete(E)}this.receiptCacheByEventId.get(e)||this.receiptCacheByEventId.set(e,[]),this.receiptCacheByEventId.get(e).push({userId:r,type:t,data:n})}}getReceiptsForEvent(e){return this.receiptCacheByEventId.get(e.getId())||[]}fixupNotifications(e){var t=this.getReadReceiptForUserId(e,!1),r=this.timeline[this.timeline.length-1];r&&(null===t||void 0===t?void 0:t.eventId)===r.getId()&&e===r.getSender()&&(this.setUnread(l.X5.Total,0),this.setUnread(l.X5.Highlight,0))}addLocalEchoReceipt(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];this.addReceipt(p(e,t,r,n),!0)}getUsersReadUpTo(e){return this.getReceiptsForEvent(e).filter((function(e){return(0,s.ll)(e.type)})).map((function(e){return e.userId}))}}},7841:function(e,t,r){"use strict";r.d(t,{Dy:function(){return s},FM:function(){return n},Ji:function(){return o},X9:function(){return i}});var n=function(e){return e["Change"]="change",e}({}),i=function(e){return e[e["Unsent"]=1]="Unsent",e[e["Requested"]=2]="Requested",e[e["Ready"]=3]="Ready",e[e["Started"]=4]="Started",e[e["Cancelled"]=5]="Cancelled",e[e["Done"]=6]="Done",e}({}),o=function(e){return e["Cancel"]="cancel",e["ShowSas"]="show_sas",e["ShowReciprocateQr"]="show_reciprocate_qr",e}({});function s(e){return e.phase<i.Ready&&!e.accepting&&!e.declining}},7898:function(e,t,r){"use strict";r.d(t,{BJ:function(){return c},Et:function(){return a},K0:function(){return o},NY:function(){return l},yB:function(){return s}});var n=r(7046),i=r(8105),o=new n.UnstableValue("m.message","org.matrix.msc1767.message"),s=new n.UnstableValue("m.text","org.matrix.msc1767.text"),a=new n.UnstableValue("m.html","org.matrix.msc1767.html"),c=new n.NamespacedValue("m.reference");function l(e,t){if("string"===typeof e)return"string"===typeof t?t===e:t.matches(e);if("string"===typeof t)return e.matches(t);var r=t,n=e;return r.matches(n.name)||(0,i.c)(n.altName)&&r.matches(n.altName)}},7936:function(e,t,r){"use strict";var n=r(6518),i=r(5636);i&&n({target:"ArrayBuffer",proto:!0},{transferToFixedLength:function(){return i(this,arguments.length?arguments[0]:void 0,!1)}})},7978:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}r(4114),r(8111),r(2489),r(7588),Object.defineProperty(t,"__esModule",{value:!0}),t.PollEndEvent=void 0;var i=r(5063),o=r(3339),s=r(6012),a=r(4477),c=r(1711),l=r(1880),d=r(6977);function u(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?u(Object(r),!0).forEach((function(t){w(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):u(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function v(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(e,t,r){return t&&p(e.prototype,t),r&&p(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function g(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&m(e,t)}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function y(e){var t=E();return function(){var r,n=_(e);if(t){var i=_(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return S(this,r)}}function S(e,t){if(t&&("object"===n(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return b(e)}function b(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function E(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function _(e){return _=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_(e)}function w(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var I=function(e){g(r,e);var t=y(r);function r(e){var n;v(this,r),n=t.call(this,e),w(b(n),"pollEventId",void 0),w(b(n),"closingMessage",void 0);var i=n.wireContent["m.relates_to"];if(!s.REFERENCE_RELATION.matches(null===i||void 0===i?void 0:i.rel_type)||"string"!==typeof(null===i||void 0===i?void 0:i.event_id))throw new o.InvalidEventError("Relationship must be a reference to an event");return n.pollEventId=i.event_id,n.closingMessage=new a.MessageEvent(n.wireFormat),n}return f(r,[{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,i.M_POLL_END)}},{key:"serialize",value:function(){return{type:i.M_POLL_END.name,content:h(w({"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:this.pollEventId}},i.M_POLL_END.name,{}),this.closingMessage.serialize().content)}}}],[{key:"from",value:function(e,t){var n;return new r({type:i.M_POLL_END.name,content:(n={"m.relates_to":{rel_type:s.REFERENCE_RELATION.name,event_id:e}},w(n,i.M_POLL_END.name,{}),w(n,c.M_TEXT.name,t),n)})}}]),r}(d.ExtensibleEvent);t.PollEndEvent=I},7979:function(e,t,r){"use strict";var n=r(8551);e.exports=function(){var e=n(this),t="";return e.hasIndices&&(t+="d"),e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.unicodeSets&&(t+="v"),e.sticky&&(t+="y"),t}},8004:function(e,t,r){"use strict";var n=r(6518),i=r(9039),o=r(8750),s=r(4916),a=!s("intersection",(function(e){return 2===e.size&&e.has(1)&&e.has(2)}))||i((function(){return"3,2"!==String(Array.from(new Set([1,2,3]).intersection(new Set([3,2]))))}));n({target:"Set",proto:!0,real:!0,forced:a},{intersection:o})},8010:function(e,t){"use strict";function r(e,t){if(!e[t])throw new Error("".concat(String(t)," is required"))}Object.defineProperty(t,"__esModule",{value:!0}),t.assertPresent=r},8014:function(e,t,r){"use strict";var n=r(1291),i=Math.min;e.exports=function(e){var t=n(e);return t>0?i(t,9007199254740991):0}},8058:function(e,t,r){"use strict";r.d(t,{Y:function(){return u},o:function(){return d}});r(8111),r(7588),r(3579);var n=r(4761),i=r(4279),o=r(6170),s=r(3271),a=r(2668),c=r(5629),l=r(3877),d=function(e){return e["Membership"]="RoomMember.membership",e["Name"]="RoomMember.name",e["PowerLevel"]="RoomMember.powerLevel",e["Typing"]="RoomMember.typing",e}({});class u extends a.X{constructor(e,t){super(),this.roomId=e,this.userId=t,(0,n.A)(this,"_isOutOfBand",!1),(0,n.A)(this,"modified",-1),(0,n.A)(this,"requestedProfileInfo",!1),(0,n.A)(this,"typing",!1),(0,n.A)(this,"name",void 0),(0,n.A)(this,"rawDisplayName",void 0),(0,n.A)(this,"powerLevel",0),(0,n.A)(this,"powerLevelNorm",0),(0,n.A)(this,"user",void 0),(0,n.A)(this,"membership",void 0),(0,n.A)(this,"disambiguate",!1),(0,n.A)(this,"events",{}),this.name=t,this.rawDisplayName=t,this.updateModifiedTime()}markOutOfBand(){this._isOutOfBand=!0}isOutOfBand(){return this._isOutOfBand}setMembershipEvent(e,t){var r,n,i=null!==(r=e.getDirectionalContent().displayname)&&void 0!==r?r:"";if(e.getType()===c.Bx.RoomMember){this._isOutOfBand=!1,this.events.member=e;var a=this.membership;this.membership=e.getDirectionalContent().membership,void 0===this.membership&&s.v.trace("membership event with membership undefined (forwardLooking: ".concat(e.forwardLooking,")!"),e.getContent(),"prevcontent is ",e.getPrevContent()),this.disambiguate=p(this.userId,i,t);var l=this.name;this.name=f(this.userId,i,this.disambiguate),this.rawDisplayName=(0,o.d7)(null!==(n=e.getDirectionalContent().displayname)&&void 0!==n?n:""),this.rawDisplayName&&(0,o.Gp)(this.rawDisplayName)||(this.rawDisplayName=this.userId),a!==this.membership&&(this.updateModifiedTime(),this.emit(d.Membership,e,this,a)),l!==this.name&&(this.updateModifiedTime(),this.emit(d.Name,e,this,l))}}setPowerLevelEvent(e){if(e.getType()===c.Bx.RoomPowerLevels&&""===e.getStateKey()){var t=e.getDirectionalContent(),r=t.users_default||0,n=t.users||{};Object.values(n).forEach((e=>{r=Math.max(r,e)}));var i=this.powerLevel,o=this.powerLevelNorm;void 0!==n[this.userId]&&Number.isInteger(n[this.userId])?this.powerLevel=n[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=100*this.powerLevel/r),i===this.powerLevel&&o===this.powerLevelNorm||(this.updateModifiedTime(),this.emit(d.PowerLevel,e,this))}}setTypingEvent(e){if("m.typing"===e.getType()){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;Array.isArray(r)&&(-1!==r.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this.updateModifiedTime(),this.emit(d.Typing,e,this)))}}updateModifiedTime(){this.modified=Date.now()}getLastModifiedTime(){return this.modified}isKicked(){return this.membership===l.O.Leave&&void 0!==this.events.member&&this.events.member.getSender()!==this.events.member.getStateKey()}getDMInviter(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if(t.membership===l.O.Join&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),t.membership===l.O.Invite&&t.is_direct)return r}}getAvatarUrl(e,t,r,n){var o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5?arguments[5]:void 0,a=arguments.length>6&&void 0!==arguments[6]&&arguments[6],c=this.getMxcAvatarUrl();if(!c&&!o)return null;var l=(0,i.y)(e,c,t,r,n,s,void 0,a);return l||null}getMxcAvatarUrl(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:void 0}}var h=/@.+:.+/,v=/[\u200E\u200F\u202A-\u202F]/;function p(e,t,r){if(!t||t===e)return!1;if(!r)return!1;var n=(0,o.Gp)(t);if(!n)return!1;if(h.test(n))return!0;if(v.test(t))return!0;var i=r.getUserIdsWithDisplayName(t);return!!i.some((t=>t!==e))}function f(e,t,r){return t&&t!==e?r?(0,o.d7)(t)+" ("+e+")":(0,o.Gp)(t)?(0,o.d7)(t):e:e}},8098:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetApiToWidgetAction=t.WidgetApiFromWidgetAction=void 0;var r=function(e){return e["SupportedApiVersions"]="supported_api_versions",e["Capabilities"]="capabilities",e["NotifyCapabilities"]="notify_capabilities",e["ThemeChange"]="theme_change",e["LanguageChange"]="language_change",e["TakeScreenshot"]="screenshot",e["UpdateVisibility"]="visibility",e["OpenIDCredentials"]="openid_credentials",e["WidgetConfig"]="widget_config",e["CloseModalWidget"]="close_modal",e["ButtonClicked"]="button_clicked",e["SendEvent"]="send_event",e["SendToDevice"]="send_to_device",e["UpdateState"]="update_state",e["UpdateTurnServers"]="update_turn_servers",e}({});t.WidgetApiToWidgetAction=r;var n=function(e){return e["SupportedApiVersions"]="supported_api_versions",e["ContentLoaded"]="content_loaded",e["SendSticker"]="m.sticker",e["UpdateAlwaysOnScreen"]="set_always_on_screen",e["GetOpenIDCredentials"]="get_openid",e["CloseModalWidget"]="close_modal",e["OpenModalWidget"]="open_modal",e["SetModalButtonEnabled"]="set_button_enabled",e["SendEvent"]="send_event",e["SendToDevice"]="send_to_device",e["WatchTurnServers"]="watch_turn_servers",e["UnwatchTurnServers"]="unwatch_turn_servers",e["BeeperReadRoomAccountData"]="com.beeper.read_room_account_data",e["MSC2876ReadEvents"]="org.matrix.msc2876.read_events",e["MSC2931Navigate"]="org.matrix.msc2931.navigate",e["MSC2974RenegotiateCapabilities"]="org.matrix.msc2974.request_capabilities",e["MSC3869ReadRelations"]="org.matrix.msc3869.read_relations",e["MSC3973UserDirectorySearch"]="org.matrix.msc3973.user_directory_search",e["MSC4039GetMediaConfigAction"]="org.matrix.msc4039.get_media_config",e["MSC4039UploadFileAction"]="org.matrix.msc4039.upload_file",e["MSC4039DownloadFileAction"]="org.matrix.msc4039.download_file",e["MSC4157UpdateDelayedEvent"]="org.matrix.msc4157.update_delayed_event",e}({});t.WidgetApiFromWidgetAction=n},8100:function(e,t,r){"use strict";var n=r(6518),i=r(5636);i&&n({target:"ArrayBuffer",proto:!0},{transfer:function(){return i(this,arguments.length?arguments[0]:void 0,!0)}})},8105:function(e,t,r){"use strict";function n(e){return null!==e&&void 0!==e}r.d(t,{c:function(){return n}})},8111:function(e,t,r){"use strict";var n=r(6518),i=r(4576),o=r(679),s=r(8551),a=r(4901),c=r(2787),l=r(2106),d=r(4659),u=r(9039),h=r(9297),v=r(8227),p=r(7657).IteratorPrototype,f=r(3724),g=r(6395),m="constructor",y="Iterator",S=v("toStringTag"),b=TypeError,E=i[y],_=g||!a(E)||E.prototype!==p||!u((function(){E({})})),w=function(){if(o(this,p),c(this)===p)throw new b("Abstract class Iterator not directly constructable")},I=function(e,t){f?l(p,e,{configurable:!0,get:function(){return t},set:function(t){if(s(this),this===p)throw new b("You can't redefine this property");h(this,e)?this[e]=t:d(this,e,t)}}):p[e]=t};h(p,S)||I(S,y),!_&&h(p,m)&&p[m]!==Object||I(m,w),w.prototype=p,n({global:!0,constructor:!0,forced:_},{Iterator:w})},8161:function(e,t,r){"use strict";r.d(t,{g:function(){return n}});var n=function(e){return e["Recent"]="recent",e["Rank"]="rank",e}({})},8212:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseMPoll=a;var n=r(5063),i=r(8957),o=r(4904),s=r(7978);function a(e){return n.M_POLL_START.matches(e.type)?new i.PollStartEvent(e):n.M_POLL_RESPONSE.matches(e.type)?new o.PollResponseEvent(e):n.M_POLL_END.matches(e.type)?new s.PollEndEvent(e):null}},8227:function(e,t,r){"use strict";var n=r(4576),i=r(5745),o=r(9297),s=r(3392),a=r(4495),c=r(7040),l=n.Symbol,d=i("wks"),u=c?l["for"]||l:l&&l.withoutSetter||s;e.exports=function(e){return o(d,e)||(d[e]=a&&o(l,e)?l[e]:u("Symbol."+e)),d[e]}},8237:function(e,t,r){"use strict";var n=r(6518),i=r(2652),o=r(9306),s=r(8551),a=r(1767),c=TypeError;n({target:"Iterator",proto:!0,real:!0},{reduce:function(e){s(this),o(e);var t=a(this),r=arguments.length<2,n=r?void 0:arguments[1],l=0;if(i(t,(function(t){r?(r=!1,n=t):n=e(n,t,l),l++}),{IS_RECORD:!0}),r)throw new c("Reduce of empty iterator with no initial value");return n}})},8269:function(e,t,r){"use strict";r.d(t,{SM:function(){return a}});var n=r(698),i=r(9553),o=r(4864),s=(r(8695),5e5);function a(e){return c.apply(this,arguments)}function c(){return c=(0,n.A)((function*(e){var t=(0,i.US)(32),r=yield(0,o.deriveRecoveryKeyFromPassphrase)(e,t,s);return{key:r,salt:t,iterations:s}})),c.apply(this,arguments)}},8289:function(e,t,r){"use strict";const n=r(1996),i=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class o extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,({message:e}=e)):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const s=(e,t,r)=>{const n=r.retries-(t-1);return e.attemptNumber=t,e.retriesLeft=n,e},a=e=>i.includes(e),c=(e,t)=>new Promise(((r,i)=>{t={onFailedAttempt:()=>{},retries:10,...t};const c=n.operation(t);c.attempt((async n=>{try{r(await e(n))}catch(l){if(!(l instanceof Error))return void i(new TypeError(`Non-error was thrown: "${l}". You should only throw errors.`));if(l instanceof o)c.stop(),i(l.originalError);else if(l instanceof TypeError&&!a(l.message))c.stop(),i(l);else{s(l,n,t);try{await t.onFailedAttempt(l)}catch(l){return void i(l)}c.retry(l)||i(c.mainError())}}}))}));e.exports=c,e.exports["default"]=c,e.exports.AbortError=o},8346:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},8428:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensibleEvents=void 0;var n=r(2555),i=r(3339),o=r(3751),s=r(5670),a=r(1711),c=r(5063),l=r(8212);function d(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=u(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r["return"]||r["return"]()}finally{if(a)throw o}}}}function u(e,t){if(e){if("string"===typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?h(e,t):void 0}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function v(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(e,t,r){return t&&p(e.prototype,t),r&&p(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function g(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var m=function(){function e(){v(this,e),g(this,"interpreters",new n.NamespacedMap([[o.LEGACY_M_ROOM_MESSAGE,o.parseMRoomMessage],[a.M_MESSAGE,s.parseMMessage],[a.M_EMOTE,s.parseMMessage],[a.M_NOTICE,s.parseMMessage],[c.M_POLL_START,l.parseMPoll],[c.M_POLL_RESPONSE,l.parseMPoll],[c.M_POLL_END,l.parseMPoll]])),g(this,"_unknownInterpretOrder",[a.M_MESSAGE])}return f(e,[{key:"unknownInterpretOrder",get:function(){var e;return null!==(e=this._unknownInterpretOrder)&&void 0!==e?e:[]},set:function(e){this._unknownInterpretOrder=e}},{key:"registerInterpreter",value:function(e,t){this.interpreters.set(e,t)}},{key:"parse",value:function(e){try{if(this.interpreters.hasNamespaced(e.type))return this.interpreters.getNamespaced(e.type)(e);var t,r=d(this.unknownInterpretOrder);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(this.interpreters.has(n)){var o=this.interpreters.get(n)(e);if(o)return o}}}catch(s){r.e(s)}finally{r.f()}return null}catch(a){if(a instanceof i.InvalidEventError)return null;throw a}}}],[{key:"defaultInstance",get:function(){return e._defaultInstance}},{key:"unknownInterpretOrder",get:function(){return e.defaultInstance.unknownInterpretOrder},set:function(t){e.defaultInstance.unknownInterpretOrder=t}},{key:"registerInterpreter",value:function(t,r){e.defaultInstance.registerInterpreter(t,r)}},{key:"parse",value:function(t){return e.defaultInstance.parse(t)}}]),e}();t.ExtensibleEvents=m,g(m,"_defaultInstance",new m)},8469:function(e,t,r){"use strict";var n=r(9504),i=r(507),o=r(4402),s=o.Set,a=o.proto,c=n(a.forEach),l=n(a.keys),d=l(new s).next;e.exports=function(e,t,r){return r?i({iterator:l(e),next:d},t):c(e,t)}},8480:function(e,t,r){"use strict";var n=r(1828),i=r(8727),o=i.concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return n(e,o)}},8527:function(e,t,r){"use strict";var n=r(7080),i=r(4402).has,o=r(5170),s=r(3789),a=r(507),c=r(9539);e.exports=function(e){var t=n(this),r=s(e);if(o(t)<r.size)return!1;var l=r.getIterator();return!1!==a(l,(function(e){if(!i(t,e))return c(l,"normal",!1)}))}},8551:function(e,t,r){"use strict";var n=r(34),i=String,o=TypeError;e.exports=function(e){if(n(e))return e;throw new o(i(e)+" is not an object")}},8574:function(e,t,r){"use strict";var n=r(9504),i=Error,o=n("".replace),s=function(e){return String(new i(e).stack)}("zxcasd"),a=/\n\s*at [^:]*:[^\n]*/,c=a.test(s);e.exports=function(e,t){if(c&&"string"==typeof e&&!i.prepareStackTrace)while(t--)e=o(e,a,"");return e}},8614:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UnstableApiVersion=t.MatrixApiVersion=t.CurrentApiVersions=void 0;var r=function(e){return e["Prerelease1"]="0.0.1",e["Prerelease2"]="0.0.2",e}({});t.MatrixApiVersion=r;var n=function(e){return e["MSC2762"]="org.matrix.msc2762",e["MSC2762_UPDATE_STATE"]="org.matrix.msc2762_update_state",e["MSC2871"]="org.matrix.msc2871",e["MSC2873"]="org.matrix.msc2873",e["MSC2931"]="org.matrix.msc2931",e["MSC2974"]="org.matrix.msc2974",e["MSC2876"]="org.matrix.msc2876",e["MSC3819"]="org.matrix.msc3819",e["MSC3846"]="town.robin.msc3846",e["MSC3869"]="org.matrix.msc3869",e["MSC3973"]="org.matrix.msc3973",e["MSC4039"]="org.matrix.msc4039",e}({});t.UnstableApiVersion=n;var i=[r.Prerelease1,r.Prerelease2,n.MSC2762,n.MSC2762_UPDATE_STATE,n.MSC2871,n.MSC2873,n.MSC2931,n.MSC2974,n.MSC2876,n.MSC3819,n.MSC3846,n.MSC3869,n.MSC3973,n.MSC4039];t.CurrentApiVersions=i},8620:function(e,t,r){"use strict";r.r(t),r.d(t,{MEGOLM_ALGORITHM:function(){return v},MEGOLM_BACKUP_ALGORITHM:function(){return p},OLM_ALGORITHM:function(){return h},encryptMessageForDevice:function(){return f},ensureOlmSessionsForDevices:function(){return S},getExistingOlmSessions:function(){return m},isOlmEncrypted:function(){return k},pkSign:function(){return T},pkVerify:function(){return R},verifySignature:function(){return w}});r(4114),r(6573),r(8100),r(7936),r(8111),r(2489),r(7588),r(7467),r(4732),r(9577);var n=r(4761),i=r(698),o=r(2696),s=r(3271),a=r(5629),c=r(6170);function l(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function d(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?l(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var u=function(e){return e["Olm"]="m.olm.v1.curve25519-aes-sha2",e["Megolm"]="m.megolm.v1.aes-sha2",e["MegolmBackup"]="m.megolm_backup.v1.curve25519-aes-sha2",e}(u||{}),h=u.Olm,v=u.Megolm,p=u.MegolmBackup;function f(e,t,r,n,i,o,s){return g.apply(this,arguments)}function g(){return g=(0,i.A)((function*(e,t,r,n,i,o,a){var c=o.getIdentityKey(),l=yield n.getSessionIdForDevice(c);if(null!==l){s.v.log("[olmlib.encryptMessageForDevice] Using Olm session ".concat(l," for device ")+"".concat(i,":").concat(o.deviceId));var u=d({sender:t,sender_device:r,keys:{ed25519:n.deviceEd25519Key},recipient:i,recipient_keys:{ed25519:o.getFingerprint()}},a);e[c]=yield n.encryptMessage(c,l,JSON.stringify(u))}else s.v.log("[olmlib.encryptMessageForDevice] Unable to find Olm session for device "+"".concat(i,":").concat(o.deviceId))})),g.apply(this,arguments)}function m(e,t,r){return y.apply(this,arguments)}function y(){return y=(0,i.A)((function*(e,t,r){var n=new c.kG((()=>[])),o=new c.kG((()=>new Map)),s=[],a=function*(t){var r=function*(r){var a=r.deviceId,c=r.getIdentityKey();s.push((0,i.A)((function*(){var i=yield e.getSessionIdForDevice(c,!0);null===i?n.getOrCreate(t).push(r):o.getOrCreate(t).set(a,{device:r,sessionId:i})}))())};for(var a of d)yield*r(a)};for(var[l,d]of Object.entries(r))yield*a(l);return yield Promise.all(s),[n,o]})),y.apply(this,arguments)}function S(e,t,r){return b.apply(this,arguments)}function b(){return b=(0,i.A)((function*(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],i=arguments.length>4?arguments[4]:void 0,o=arguments.length>5?arguments[5]:void 0,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:s.v,c=[],l=new Map,d=new Map;for(var u of r.values()){var h=function*(){var t=v.getIdentityKey();if(t===e.deviceCurve25519Key)return 1;e.sessionsInProgress[t]||(e.sessionsInProgress[t]=new Promise((r=>{d.set(t,(n=>{delete e.sessionsInProgress[t],r(n)}))})))};for(var v of u)yield*h()}for(var[p,f]of r){var g=new Map;for(var m of(l.set(p,g),f)){var y=m.deviceId,S=m.getIdentityKey();if(S!==e.deviceCurve25519Key){var b="for ".concat(S," (").concat(p,":").concat(y,")"),_=yield e.getSessionIdForDevice(S,!!d.get(S),a),w=d.get(S);null!==_&&w&&w(),(null===_||n)&&(n?a.info("Forcing new Olm session ".concat(b)):a.info("Making new Olm session ".concat(b)),c.push([p,y])),g.set(y,{device:m,sessionId:_})}else a.info("Attempted to start session with ourself! Ignoring"),g.set(y,{device:m,sessionId:null})}}if(0===c.length)return l;var I,T="signed_curve25519",R="one-time keys for ".concat(c.length," devices");try{a.debug("Claiming ".concat(R)),I=yield t.claimOneTimeKeys(c,T,i),a.debug("Claimed ".concat(R))}catch(P){for(var k of d.values())k();throw a.debug("Failed to claim ".concat(R),P,c),P}o&&"failures"in I&&o.push(...Object.keys(I.failures));var A=I.one_time_keys||{},C=[],O=function*(t){var r=A[t]||{},i=function*(){var i,s=o.deviceId,c=o.getIdentityKey();if(c===e.deviceCurve25519Key)return 0;if(null!==(i=l.get(t))&&void 0!==i&&null!==(i=i.get(s))&&void 0!==i&&i.sessionId&&!n)return 0;var u,h=r[s]||{},v=null;for(var p in h)0===p.indexOf(T+":")&&(v=h[p]);if(!v)return a.warn("No one-time keys (alg=".concat(T,") ")+"for device ".concat(t,":").concat(s)),null===(u=d.get(c))||void 0===u||u(),0;C.push(E(e,v,t,o).then((e=>{var r,n;null===(r=d.get(c))||void 0===r||r(null!==e&&void 0!==e?e:void 0);var i=null===(n=l.get(t))||void 0===n?void 0:n.get(s);i&&(i.sessionId=e)}),(e=>{var t;throw null===(t=d.get(c))||void 0===t||t(),e})))};for(var o of M)yield*i()};for(var[D,M]of r)yield*O(D);return R="Olm sessions for ".concat(C.length," devices"),a.debug("Starting ".concat(R)),yield Promise.all(C),a.debug("Started ".concat(R)),l})),b.apply(this,arguments)}function E(e,t,r,n){return _.apply(this,arguments)}function _(){return _=(0,i.A)((function*(e,t,r,n){var i,o=n.deviceId;try{yield w(e,t,r,o,n.getFingerprint())}catch(a){return s.v.error("Unable to verify signature on one-time key for device "+r+":"+o+":",a),null}try{i=yield e.createOutboundSession(n.getIdentityKey(),t.key)}catch(a){return s.v.error("Error starting olm session with device "+r+":"+o+": "+a),null}return s.v.log("Started new olm sessionid "+i+" for device "+r+":"+o),i})),_.apply(this,arguments)}function w(e,t,r,n,i){return I.apply(this,arguments)}function I(){return I=(0,i.A)((function*(e,t,r,n,i){var s="ed25519:"+n,a=t.signatures||{},c=a[r]||{},l=c[s];if(!l)throw Error("No signature");var d=Object.assign({},t);"unsigned"in d&&delete d.unsigned,delete d.signatures;var u=o.stringify(d);e.verifySignature(i,u,l)})),I.apply(this,arguments)}function T(e,t,r,n){var i=!1;if(t instanceof Uint8Array){var s=new globalThis.Olm.PkSigning;n=s.init_with_seed(t),t=s,i=!0}var a=e.signatures||{};delete e.signatures;var c=e.unsigned;e.unsigned&&delete e.unsigned;try{var l=a[r]||{};return a[r]=l,l["ed25519:"+n]=t.sign(o.stringify(e))}finally{e.signatures=a,c&&(e.unsigned=c),i&&t.free()}}function R(e,t,r){var n="ed25519:"+t;if(!(e.signatures&&e.signatures[r]&&e.signatures[r][n]))throw new Error("No signature");var i=e.signatures[r][n],s=new globalThis.Olm.Utility,a=e.signatures;delete e.signatures;var c=e.unsigned;e.unsigned&&delete e.unsigned;try{s.ed25519_verify(t,o.stringify(e),i)}finally{e.signatures=a,c&&(e.unsigned=c),s.free()}}function k(e){return e.getSenderKey()?!(e.getWireType()!==a.Bx.RoomMessageEncrypted||!["m.olm.v1.curve25519-aes-sha2"].includes(e.getWireContent().algorithm))||(s.v.error("Event was not encrypted using an appropriate algorithm"),!1):(s.v.error("Event has no sender key (not encrypted?)"),!1)}},8622:function(e,t,r){"use strict";var n=r(4576),i=r(4901),o=n.WeakMap;e.exports=i(o)&&/native code/.test(String(o))},8633:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.LegacyMsgType=void 0,t.isEventLike=o;var n,i=r(1711);function o(e,t){var r=e.content;return t===n.Text?i.M_MESSAGE.matches(e.type)||"m.room.message"===e.type&&"m.text"===(null===r||void 0===r?void 0:r["msgtype"]):t===n.Emote?i.M_EMOTE.matches(e.type)||"m.room.message"===e.type&&"m.emote"===(null===r||void 0===r?void 0:r["msgtype"]):t===n.Notice&&(i.M_NOTICE.matches(e.type)||"m.room.message"===e.type&&"m.notice"===(null===r||void 0===r?void 0:r["msgtype"]))}t.LegacyMsgType=n,function(e){e["Text"]="m.text",e["Notice"]="m.notice",e["Emote"]="m.emote"}(n||(t.LegacyMsgType=n={}))},8645:function(e,t,r){"use strict";r.d(t,{L:function(){return n},S:function(){return i}});var n=function(e){return e["Read"]="m.read",e["FullyRead"]="m.fully_read",e["ReadPrivate"]="m.read.private",e}({}),i="main"},8686:function(e,t,r){"use strict";var n=r(3724),i=r(9039);e.exports=n&&i((function(){return 42!==Object.defineProperty((function(){}),"prototype",{value:42,writable:!1}).prototype}))},8687:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UpdateDelayedEventAction=void 0;var r=function(e){return e["Cancel"]="cancel",e["Restart"]="restart",e["Send"]="send",e}({});t.UpdateDelayedEventAction=r},8695:function(e,t,r){"use strict";r.d(t,{c:function(){return i}});var n=r(4864);function i(e,t){if(!e.private_key_salt||!e.private_key_iterations)throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");return(0,n.deriveRecoveryKeyFromPassphrase)(t,e.private_key_salt,e.private_key_iterations,e.private_key_bits)}},8721:function(e,t,r){"use strict";var n=r(3724),i=r(9504),o=r(2106),s=URLSearchParams.prototype,a=i(s.forEach);n&&!("size"in s)&&o(s,"size",{get:function(){var e=0;return a(this,(function(){e++})),e},configurable:!0,enumerable:!0})},8727:function(e){"use strict";e.exports=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"]},8750:function(e,t,r){"use strict";var n=r(7080),i=r(4402),o=r(5170),s=r(3789),a=r(8469),c=r(507),l=i.Set,d=i.add,u=i.has;e.exports=function(e){var t=n(this),r=s(e),i=new l;return o(t)>r.size?c(r.getIterator(),(function(e){u(t,e)&&d(i,e)})):a(t,(function(e){r.includes(e)&&d(i,e)})),i}},8772:function(e,t,r){"use strict";r.d(t,{C:function(){return o}});r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);var n=r(698),i=new Uint8Array(8);function o(e,t){return s.apply(this,arguments)}function s(){return s=(0,n.A)((function*(e,t){var r=yield globalThis.crypto.subtle.importKey("raw",e,{name:"HKDF"},!1,["deriveBits"]),n=yield globalThis.crypto.subtle.deriveBits({name:"HKDF",salt:i,info:(new TextEncoder).encode(t),hash:"SHA-256"},r,512),o=n.slice(0,32),s=n.slice(32),a=globalThis.crypto.subtle.importKey("raw",o,{name:"AES-CTR"},!1,["encrypt","decrypt"]),c=globalThis.crypto.subtle.importKey("raw",s,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]);return Promise.all([a,c])})),s.apply(this,arguments)}},8773:function(e,t){"use strict";var r={}.propertyIsEnumerable,n=Object.getOwnPropertyDescriptor,i=n&&!r.call({1:2},1);t.f=i?function(e){var t=n(this,e);return!!t&&t.enumerable}:r},8848:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}function i(e,t){var r="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=o(e))||t&&e&&"number"===typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,c=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return a=e.done,e},e:function(e){c=!0,s=e},f:function(){try{a||null==r["return"]||r["return"]()}finally{if(c)throw s}}}}function o(e,t){if(e){if("string"===typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?s(e,t):void 0}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function c(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,d(n.key),n)}}function l(e,t,r){return t&&c(e.prototype,t),r&&c(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function d(e){var t=u(e,"string");return"symbol"===n(t)?t:String(t)}function u(e,t){if("object"!==n(e)||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var i=r.call(e,t||"default");if("object"!==n(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}r(4114),r(8111),r(1701),Object.defineProperty(t,"__esModule",{value:!0}),t.WidgetEventCapability=t.EventKind=t.EventDirection=void 0;var h=function(e){return e["Event"]="event",e["State"]="state_event",e["ToDevice"]="to_device",e["RoomAccount"]="room_account",e}({});t.EventKind=h;var v=function(e){return e["Send"]="send",e["Receive"]="receive",e}({});t.EventDirection=v;var p=function(){function e(t,r,n,i,o){a(this,e),this.direction=t,this.eventType=r,this.kind=n,this.keyStr=i,this.raw=o}return l(e,[{key:"matchesAsStateEvent",value:function(e,t,r){return this.kind===h.State&&(this.direction===e&&(this.eventType===t&&(null===this.keyStr||this.keyStr===r)))}},{key:"matchesAsToDeviceEvent",value:function(e,t){return this.kind===h.ToDevice&&(this.direction===e&&this.eventType===t)}},{key:"matchesAsRoomEvent",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.kind===h.Event&&(this.direction===e&&(this.eventType===t&&("m.room.message"!==this.eventType||(null===this.keyStr||this.keyStr===r))))}},{key:"matchesAsRoomAccountData",value:function(e,t){return this.kind===h.RoomAccount&&(this.direction===e&&this.eventType===t)}}],[{key:"forStateEvent",value:function(t,r,n){r=r.replace(/#/g,"\\#"),n=null!==n&&void 0!==n?"#".concat(n):"";var i="org.matrix.msc2762.".concat(t,".state_event:").concat(r).concat(n);return e.findEventCapabilities([i])[0]}},{key:"forToDeviceEvent",value:function(t,r){var n="org.matrix.msc3819.".concat(t,".to_device:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomEvent",value:function(t,r){var n="org.matrix.msc2762.".concat(t,".event:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomMessageEvent",value:function(t,r){r=null===r||void 0===r?"":r;var n="org.matrix.msc2762.".concat(t,".event:m.room.message#").concat(r);return e.findEventCapabilities([n])[0]}},{key:"forRoomAccountData",value:function(t,r){var n="com.beeper.capabilities.".concat(t,".room_account_data:").concat(r);return e.findEventCapabilities([n])[0]}},{key:"findEventCapabilities",value:function(t){var r,n=[],o=i(t);try{for(o.s();!(r=o.n()).done;){var s=r.value,a=null,c=void 0,l=null;if(s.startsWith("org.matrix.msc2762.send.event:")?(a=v.Send,l=h.Event,c=s.substring(30)):s.startsWith("org.matrix.msc2762.send.state_event:")?(a=v.Send,l=h.State,c=s.substring(36)):s.startsWith("org.matrix.msc3819.send.to_device:")?(a=v.Send,l=h.ToDevice,c=s.substring(34)):s.startsWith("org.matrix.msc2762.receive.event:")?(a=v.Receive,l=h.Event,c=s.substring(33)):s.startsWith("org.matrix.msc2762.receive.state_event:")?(a=v.Receive,l=h.State,c=s.substring(39)):s.startsWith("org.matrix.msc3819.receive.to_device:")?(a=v.Receive,l=h.ToDevice,c=s.substring(37)):s.startsWith("com.beeper.capabilities.receive.room_account_data:")&&(a=v.Receive,l=h.RoomAccount,c=s.substring(50)),null!==a&&null!==l&&void 0!==c){var d=c.startsWith("m.room.message#")||l===h.State,u=null;if(c.includes("#")&&d){var p=c.split("#"),f=p.findIndex((function(e){return!e.endsWith("\\")}));c=p.slice(0,f+1).map((function(e){return e.endsWith("\\")?e.substring(0,e.length-1):e})).join("#"),u=p.slice(f+1).join("#")}n.push(new e(a,c,l,u,s))}}}catch(g){o.e(g)}finally{o.f()}return n}}]),e}();t.WidgetEventCapability=p},8957:function(e,t,r){"use strict";function n(e){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}r(4114),r(8111),r(2489),r(7588),r(1701),Object.defineProperty(t,"__esModule",{value:!0}),t.PollStartEvent=t.PollAnswerSubevent=void 0;var i=r(5063),o=r(4477),s=r(1711),a=r(3339),c=r(6288),l=r(1880),d=r(6977);function u(e){return f(e)||p(e)||v(e)||h()}function h(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function v(e,t){if(e){if("string"===typeof e)return g(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?g(e,t):void 0}}function p(e){if("undefined"!==typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function f(e){if(Array.isArray(e))return g(e)}function g(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function m(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function y(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?m(Object(r),!0).forEach((function(t){C(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):m(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function E(e,t,r){return t&&b(e.prototype,t),r&&b(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function _(e,t){if("function"!==typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&w(e,t)}function w(e,t){return w=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},w(e,t)}function I(e){var t=k();return function(){var r,n=A(e);if(t){var i=A(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return T(this,r)}}function T(e,t){if(t&&("object"===n(t)||"function"===typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return R(e)}function R(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function k(){if("undefined"===typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"===typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function A(e){return A=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},A(e)}function C(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var O=function(e){_(r,e);var t=I(r);function r(e){var n;S(this,r),n=t.call(this,e),C(R(n),"id",void 0);var i=e.content.id;if(!i||"string"!==typeof i)throw new a.InvalidEventError("Answer ID must be a non-empty string");return n.id=i,n}return E(r,[{key:"serialize",value:function(){return{type:"org.matrix.sdk.poll.answer",content:y({id:this.id},this.serializeMMessageOnly())}}}],[{key:"from",value:function(e,t){return new r({type:"org.matrix.sdk.poll.answer",content:C({id:e},s.M_TEXT.name,t)})}}]),r}(o.MessageEvent);t.PollAnswerSubevent=O;var D=function(e){_(r,e);var t=I(r);function r(e){var n;S(this,r),n=t.call(this,e),C(R(n),"question",void 0),C(R(n),"kind",void 0),C(R(n),"rawKind",void 0),C(R(n),"maxSelections",void 0),C(R(n),"answers",void 0);var s=i.M_POLL_START.findIn(n.wireContent);if(!s.question)throw new a.InvalidEventError("A question is required");if(n.question=new o.MessageEvent({type:"org.matrix.sdk.poll.question",content:s.question}),n.rawKind=s.kind,i.M_POLL_KIND_DISCLOSED.matches(n.rawKind)?n.kind=i.M_POLL_KIND_DISCLOSED:n.kind=i.M_POLL_KIND_UNDISCLOSED,n.maxSelections=Number.isFinite(s.max_selections)&&s.max_selections>0?s.max_selections:1,!Array.isArray(s.answers))throw new a.InvalidEventError("Poll answers must be an array");var c=s.answers.slice(0,20).map((function(e){return new O({type:"org.matrix.sdk.poll.answer",content:e})}));if(c.length<=0)throw new a.InvalidEventError("No answers available");return n.answers=c,n}return E(r,[{key:"isEquivalentTo",value:function(e){return(0,l.isEventTypeSame)(e,i.M_POLL_START)}},{key:"serialize",value:function(){var e;return{type:i.M_POLL_START.name,content:(e={},C(e,i.M_POLL_START.name,{question:this.question.serialize().content,kind:this.rawKind,max_selections:this.maxSelections,answers:this.answers.map((function(e){return e.serialize().content}))}),C(e,s.M_TEXT.name,"".concat(this.question.text,"\n").concat(this.answers.map((function(e,t){return"".concat(t+1,". ").concat(e.text)})).join("\n"))),e)}}}],[{key:"from",value:function(e,t,n){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;return new r({type:i.M_POLL_START.name,content:(o={},C(o,s.M_TEXT.name,e),C(o,i.M_POLL_START.name,{question:C({},s.M_TEXT.name,e),kind:n instanceof c.NamespacedValue?n.name:n,max_selections:a,answers:t.map((function(e){return C({id:P()},s.M_TEXT.name,e)}))}),o)})}}]),r}(d.ExtensibleEvent);t.PollStartEvent=D;var M="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function P(){return u(Array(16)).map((function(){return M.charAt(Math.floor(Math.random()*M.length))})).join("")}},8965:function(e,t,r){"use strict";r.d(t,{vx:function(){return G},X5:function(){return $},Wv:function(){return z},u9:function(){return J},bx:function(){return Q}});r(4114),r(8111),r(2489),r(116),r(7588),r(1701),r(8237),r(3579),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(698),i=r(4761),o=r(7046),s=r(1337),a=r(2292),c=r(4279),l=r(6170),d=r(3178),u=r(4977),h=r(8058),v=r(9838),p=r(3271),f=r(5462),g=r(5629),m=r(4108),y=r(6483),S=r(4123),b=r(972),E=r(7528),_=r(8645),w=r(4653),I=r(7825),T=r(4861);class R{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"threadedReceipts",void 0),(0,i.A)(this,"unthreadedReceipts",void 0),(0,i.A)(this,"danglingReceipts",void 0),(0,i.A)(this,"onTimelineEvent",(e=>{var t=e.getId();if(t){var r=this.danglingReceipts.remove(t);null===r||void 0===r||r.forEach((e=>{e.receipt.thread_id?this.threadedReceipts.set(e.receipt.thread_id,e.eventId,e.receiptType,e.userId,e.receipt.ts,e.synthetic):this.unthreadedReceipts.set(t,e.receiptType,e.userId,e.receipt.ts,e.synthetic)}))}})),this.room=e,this.threadedReceipts=new D(e),this.unthreadedReceipts=new O(e),this.danglingReceipts=new M,e.on(J.Timeline,this.onTimelineEvent)}add(e,t){for(var[r,n]of Object.entries(e))for(var[i,o]of Object.entries(n))for(var[s,a]of Object.entries(o)){var c=this.room.findEventById(r);c?a.thread_id?this.threadedReceipts.set(a.thread_id,r,i,s,a.ts,t):this.unthreadedReceipts.set(r,i,s,a.ts,t):this.danglingReceipts.add(new A(r,i,s,a,t))}}hasUserReadEvent(e,t){var r=this.unthreadedReceipts.get(e);if(r&&x(r.eventId,t,this.room))return!0;var n=this.room.findEventById(t);if(!n)return p.v.warn("hasUserReadEvent event ID ".concat(t," not found in room ").concat(this.room.roomId,": this shouldn't happen!")),!1;var i=(0,m.Xb)(n),o=this.threadedReceipts.get(i,e);return!(!o||!x(o.eventId,t,this.room))||!!this.userSentLatestEventInThread(i,e)}userSentLatestEventInThread(e,t){var r,n=e===_.S?this.room.getLiveTimeline().getEvents():null===(r=this.room.getThread(e))||void 0===r?void 0:r.timeline;return!!(n&&n.length>0&&n[n.length-1].getSender()===t)}}class k{constructor(e,t,r){this.eventId=e,this.receiptType=t,this.ts=r}}class A{constructor(e,t,r,n,i){this.eventId=e,this.receiptType=t,this.userId=r,this.receipt=n,this.synthetic=i}}class C{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"real",void 0),(0,i.A)(this,"synthetic",void 0),this.room=e,this.real=void 0,this.synthetic=void 0}set(e,t){e?this.synthetic=t:this.real=t,this.synthetic&&this.real&&x(this.real.eventId,this.synthetic.eventId,this.room)&&(this.synthetic=void 0)}get(){var e;return null!==(e=this.synthetic)&&void 0!==e?e:this.real}getByType(e){return e?this.synthetic:this.real}}class O{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,i){var o=P(this.data,r,(()=>new C(this.room))),s=o.getByType(i);s&&U(s.eventId,e,this.room)||o.set(i,new k(e,t,n))}get(e){var t;return null===(t=this.data.get(e))||void 0===t?void 0:t.get()}}class D{constructor(e){(0,i.A)(this,"room",void 0),(0,i.A)(this,"data",void 0),this.room=e,this.data=new Map}set(e,t,r,n,i,o){var s=P(this.data,e,(()=>new O(this.room)));s.set(t,r,n,i,o)}get(e,t){var r;return null===(r=this.data.get(e))||void 0===r?void 0:r.get(t)}}class M{constructor(){(0,i.A)(this,"data",new Map)}add(e){var t=P(this.data,e.eventId,(()=>[]));t.push(e)}remove(e){var t=this.data.get(e);return this.data.delete(e),t}}function P(e,t,r){var n=e.get(t);if(n)return n;var i=r();return e.set(t,i),i}function x(e,t,r){var n=r.compareEventOrdering(e,t);return null!==n&&n>=0}function U(e,t,r){var n=r.compareEventOrdering(e,t);return null!==n&&n>0}function L(e,t,r){var n=e.findEventById(t),i=e.findEventById(r);if(!n||!i)return null;var o=(0,m.fN)(n),s=(0,m.fN)(i);return o&&s?N(e,t,r,n,i):B(t,r,n,i)}function N(e,t,r,n,i){var o=e.getUnfilteredTimelineSet(),s=o.compareEventOrdering(t,r);if(null!==s)return s;var a=o.getTimelineForEvent(t);if(a===o.getLiveTimeline())return 1;var c=o.getTimelineForEvent(r);return c===o.getLiveTimeline()?-1:K(n,i)}function B(e,t,r,n){var i=(0,m.Xb)(r),o=(0,m.Xb)(n),s=r.getThread();return s&&i===o?s.timelineSet.compareEventOrdering(e,t):K(r,n)}function K(e,t){var r=e.getTs(),n=t.getTs();return r<n?-1:r>n?1:0}var F=r(3877),j=r(6718);function q(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function V(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?q(Object(r),!0).forEach((function(t){(0,i.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):q(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var G="10",W=["1","2","3","4","5","6","7","8","9","10"],H=30,$=function(e){return e["Highlight"]="highlight",e["Total"]="total",e}({}),J=function(e){return e["MyMembership"]="Room.myMembership",e["Tags"]="Room.tags",e["AccountData"]="Room.accountData",e["Receipt"]="Room.receipt",e["Name"]="Room.name",e["Redaction"]="Room.redaction",e["RedactionCancelled"]="Room.redactionCancelled",e["LocalEchoUpdated"]="Room.localEchoUpdated",e["Timeline"]="Room.timeline",e["TimelineReset"]="Room.timelineReset",e["TimelineRefresh"]="Room.TimelineRefresh",e["OldStateUpdated"]="Room.OldStateUpdated",e["CurrentStateUpdated"]="Room.CurrentStateUpdated",e["HistoryImportedWithinTimeline"]="Room.historyImportedWithinTimeline",e["UnreadNotifications"]="Room.UnreadNotifications",e["Summary"]="Room.Summary",e}({});class z extends I.h{constructor(e,t,r){var o,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};super(),o=this,this.roomId=e,this.client=t,this.myUserId=r,this.opts=a,(0,i.A)(this,"reEmitter",void 0),(0,i.A)(this,"txnToEvent",new Map),(0,i.A)(this,"notificationCounts",{}),(0,i.A)(this,"threadNotifications",new Map),(0,i.A)(this,"cachedThreadReadReceipts",new Map),(0,i.A)(this,"oldestThreadedReceiptTs",1/0),(0,i.A)(this,"unthreadedReceipts",new Map),(0,i.A)(this,"timelineSets",void 0),(0,i.A)(this,"polls",new Map),(0,i.A)(this,"threadsTimelineSets",[]),(0,i.A)(this,"filteredTimelineSets",{}),(0,i.A)(this,"timelineNeedsRefresh",!1),(0,i.A)(this,"pendingEventList",void 0),(0,i.A)(this,"blacklistUnverifiedDevices",void 0),(0,i.A)(this,"selfMembership",void 0),(0,i.A)(this,"summaryHeroes",null),(0,i.A)(this,"getTypeWarning",!1),(0,i.A)(this,"getVersionWarning",!1),(0,i.A)(this,"membersPromise",void 0),(0,i.A)(this,"name",void 0),(0,i.A)(this,"normalizedName",void 0),(0,i.A)(this,"tags",{}),(0,i.A)(this,"accountData",new Map),(0,i.A)(this,"summary",null),(0,i.A)(this,"oldState",void 0),(0,i.A)(this,"currentState",void 0),(0,i.A)(this,"relations",void 0),(0,i.A)(this,"threads",new Map),(0,i.A)(this,"visibilityEvents",new Map),(0,i.A)(this,"roomReceipts",new R(this)),(0,i.A)(this,"threadTimelineSetsPromise",null),(0,i.A)(this,"threadsReady",!1),(0,i.A)(this,"updateThreadRootEvents",((e,t,r)=>{var n,i;e.length&&(this.updateThreadRootEvent(null===(n=this.threadsTimelineSets)||void 0===n?void 0:n[0],e,t,r),e.hasCurrentUserParticipated&&this.updateThreadRootEvent(null===(i=this.threadsTimelineSets)||void 0===i?void 0:i[1],e,t,r))})),(0,i.A)(this,"updateThreadRootEvent",((e,t,r,n)=>{e&&t.rootEvent&&(n&&e.removeEvent(t.id),E.jV.hasServerSideSupport?e.addLiveEvent(t.rootEvent,{duplicateStrategy:s.x.Replace,fromCache:!1,roomState:this.currentState,addToState:!1}):e.addEventToTimeline(t.rootEvent,e.getLiveTimeline(),{toStartOfTimeline:r,addToState:!1}))})),(0,i.A)(this,"applyRedaction",(e=>{if(e.isRedaction()){var t=e.event.redacts,r=t?this.findEventById(t):void 0;if(r){var n=r.threadRootId;if(r.makeRedacted(e,this),r.isState()){var i=this.currentState.getStateEvents(r.getType(),r.getStateKey());(null===i||void 0===i?void 0:i.getId())===r.getId()&&this.currentState.setStateEvents([r])}this.emit(J.Redaction,e,this,n),this.visibilityEvents.delete(t),r.isVisibilityEvent()&&this.redactVisibilityChangeEvent(e)}}})),this.setMaxListeners(100),this.reEmitter=new f.Q(this),a.pendingEventOrdering=a.pendingEventOrdering||m.eO.Chronological,this.name=e,this.normalizedName=e,this.relations=new w.t(this.client,this),this.on(J.Receipt,this.onReceipt),this.timelineSets=[new s.m(this,a)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),[J.Timeline,J.TimelineReset]),this.fixUpLegacyTimelineFields(),this.opts.pendingEventOrdering===m.eO.Detached&&(this.pendingEventList=[],this.client.store.getPendingEvents(this.roomId).then((e=>{var r=this.client.getEventMapper({toDevice:!1,decrypt:!1});e.forEach(function(){var e=(0,n.A)((function*(e){var n=r(e);yield t.decryptEventIfNeeded(n),n.setStatus(u.f.NOT_SENT),o.addPendingEvent(n,n.getTxnId())}));return function(t){return e.apply(this,arguments)}}())}))),this.opts.lazyLoadMembers?this.membersPromise=void 0:this.membersPromise=Promise.resolve(!1)}createThreadsTimelineSets(){var e=this;return(0,n.A)((function*(){var t;if(e.threadTimelineSetsPromise)return e.threadTimelineSetsPromise;if(null!==(t=e.client)&&void 0!==t&&t.supportsThreads())try{e.threadTimelineSetsPromise=Promise.all([e.createThreadTimelineSet(),e.createThreadTimelineSet(E.x3.My)]);var r=yield e.threadTimelineSetsPromise;return e.threadsTimelineSets[0]=r[0],e.threadsTimelineSets[1]=r[1],r}catch(n){return e.threadTimelineSetsPromise=null,null}return null}))()}decryptCriticalEvents(){var e=this;return(0,n.A)((function*(){if(e.client.getCrypto()){var t=e.getEventReadUpTo(e.client.getUserId(),!0),r=e.getLiveTimeline().getEvents(),n=r.findIndex((e=>e.event.event_id===t)),i=r.slice(n).reverse().map((t=>e.client.decryptEventIfNeeded(t)));yield Promise.allSettled(i)}}))()}decryptAllEvents(){var e=this;return(0,n.A)((function*(){if(e.client.getCrypto()){var t=e.getUnfilteredTimelineSet().getLiveTimeline().getEvents().slice(0).reverse().map((t=>e.client.decryptEventIfNeeded(t)));yield Promise.allSettled(t)}}))()}getCreator(){var e,t=this.currentState.getStateEvents(g.Bx.RoomCreate,"");return null!==(e=null===t||void 0===t?void 0:t.getSender())&&void 0!==e?e:null}getVersion(){var e,t=this.currentState.getStateEvents(g.Bx.RoomCreate,"");return t?null!==(e=t.getContent()["room_version"])&&void 0!==e?e:"1":(this.getVersionWarning||(p.v.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1")}getRecommendedVersion(){var e=this;return(0,n.A)((function*(){var t={};try{t=yield e.client.getCapabilities()}catch(o){}var r=t["m.room_versions"];if(!r)for(var n of(r={default:G,available:{}},W))r.available[n]=j.L.Stable;var i=e.checkVersionAgainstCapability(r);if(i.urgent&&i.needsUpgrade){p.v.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about.");try{t=yield e.client.fetchCapabilities()}catch(s){p.v.warn("Failed to refresh room version capabilities",s)}if(r=t["m.room_versions"],!r)return p.v.warn("No room version capability - assuming upgrade required."),i;i=e.checkVersionAgainstCapability(r)}return i}))()}checkVersionAgainstCapability(e){var t=this.getVersion();p.v.log("[".concat(this.roomId,"] Current version: ").concat(t)),p.v.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};if(t===e.default)return r;var n=Object.keys(e.available).filter((t=>"stable"===e.available[t]));return n.includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?p.v.warn("URGENT upgrade required on ".concat(this.roomId)):p.v.warn("Non-urgent upgrade required on ".concat(this.roomId))),r}userMayUpgradeRoom(e){return this.currentState.maySendStateEvent(g.Bx.RoomTombstone,e)}getPendingEvents(){if(!this.pendingEventList)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this.opts.pendingEventOrdering);return this.pendingEventList}removePendingEvent(e){if(!this.pendingEventList)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this.opts.pendingEventOrdering);var t=(0,l.Nz)(this.pendingEventList,(function(t){return t.getId()==e}),!1);return this.savePendingEvents(),t}hasPendingEvent(e){var t,r;return null!==(t=null===(r=this.pendingEventList)||void 0===r?void 0:r.some((t=>t.getId()===e)))&&void 0!==t&&t}getPendingEvent(e){var t,r;return null!==(t=null===(r=this.pendingEventList)||void 0===r?void 0:r.find((t=>t.getId()===e)))&&void 0!==t?t:null}getLiveTimeline(){return this.getUnfilteredTimelineSet().getLiveTimeline()}get timeline(){return this.getLiveTimeline().getEvents()}getLastActiveTimestamp(){var e=this.getLiveTimeline(),t=e.getEvents();if(t.length){var r=t[t.length-1];return r.getTs()}return Number.MIN_SAFE_INTEGER}getLastLiveEvent(){var e,t,r=this.getLiveTimeline().getEvents(),n=r[r.length-1],i=this.getLastThread();if(!i)return n;var o=i.events[i.events.length-1];return(null!==(e=null===n||void 0===n?void 0:n.getTs())&&void 0!==e?e:0)>(null!==(t=null===o||void 0===o?void 0:o.getTs())&&void 0!==t?t:0)?n:o}getLastThread(){return this.getThreads().reduce(((e,t)=>{var r,n;if(!e)return t;var i=t.events[t.events.length-1],o=e.events[e.events.length-1];return(null!==(r=null===i||void 0===i?void 0:i.getTs())&&void 0!==r?r:0)>=(null!==(n=null===o||void 0===o?void 0:o.getTs())&&void 0!==n?n:0)?t:e}),void 0)}getMyMembership(){var e;return null!==(e=this.selfMembership)&&void 0!==e?e:F.O.Leave}getDMInviter(){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter();if(this.selfMembership===F.O.Invite){var t,r=this.getInvitedAndJoinedMemberCount();if(2===r)return null===(t=this.summaryHeroes)||void 0===t?void 0:t[0]}}guessDMUserId(){var e=this.getMember(this.myUserId);if(e){var t=e.getDMInviter();if(t)return t}if(Array.isArray(this.summaryHeroes)&&this.summaryHeroes.length)return this.summaryHeroes[0];var r=this.currentState.getMembers(),n=r.find((e=>e.userId!==this.myUserId));return n?n.userId:this.myUserId}getFunctionalMembers(){var e=this.currentState.getStateEvents(g.Ng.name,"");return Array.isArray(null===e||void 0===e?void 0:e.getContent().service_members)?e.getContent().service_members:[]}getAvatarFallbackMember(){var e,t=this.getFunctionalMembers(),r=0;if(this.getMembers().forEach((e=>{"join"!==e.membership&&"invite"!==e.membership||t.includes(e.userId)||r++})),!(r>2)){var n=null===(e=this.summaryHeroes)||void 0===e?void 0:e.filter((e=>!t.includes(e))),i=Array.isArray(n)&&n.length;if(i){var o=n.map((e=>this.getMember(e))).find((e=>!!e));if(o)return o}var s=this.getMembers(),a=null===s||void 0===s?void 0:s.filter((e=>!t.includes(e.userId)));if(a.length<=2){var c=a.find((e=>e.userId!==this.myUserId));if(c)return c}if(i){var l=n.map((e=>this.client.getUser(e))).find((e=>!!e));if(l){var d=new h.Y(this.roomId,l.userId);return d.user=l,d}}}}updateMyMembership(e){var t=this.selfMembership;this.selfMembership=e,t!==e&&(e===F.O.Leave&&this.cleanupAfterLeaving(),this.emit(J.MyMembership,this,e,t))}loadMembersFromServer(){var e=this;return(0,n.A)((function*(){var t=e.client.store.getSyncToken(),r=yield e.client.members(e.roomId,void 0,F.O.Leave,null!==t&&void 0!==t?t:void 0);return r.chunk}))()}loadMembers(){var e=this;return(0,n.A)((function*(){var t=!1,r=yield e.client.store.getOutOfBandMembers(e.roomId);(null===r||e.hasEncryptionStateEvent())&&(t=!0,r=yield e.loadMembersFromServer(),p.v.log("LL: got ".concat(r.length," ")+"members from server for room ".concat(e.roomId)));var n=r.filter(l.O5).map(e.client.getEventMapper());return{memberEvents:n,fromServer:t}}))()}membersLoaded(){return!this.opts.lazyLoadMembers||this.currentState.outOfBandMembersReady()}loadMembersIfNeeded(){if(this.membersPromise)return this.membersPromise;this.currentState.markOutOfBandMembersStarted();var e=this.loadMembers().then((e=>(this.currentState.setOutOfBandMembers(e.memberEvents),e.fromServer))).catch((e=>{throw this.membersPromise=void 0,this.currentState.markOutOfBandMembersFailed(),e}));return e.then((e=>{if(e){var t=this.currentState.getMembers().filter((e=>e.isOutOfBand())).map((e=>{var t;return null===(t=e.events.member)||void 0===t?void 0:t.event}));p.v.log("LL: telling store to write ".concat(t.length)+" members for room ".concat(this.roomId));var r=this.client.store;return r.setOutOfBandMembers(this.roomId,t).catch((e=>{p.v.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((e=>{p.v.error(e)})),this.membersPromise=e,this.membersPromise}clearLoadedMembersIfNeeded(){var e=this;return(0,n.A)((function*(){e.opts.lazyLoadMembers&&e.membersPromise&&(yield e.loadMembersIfNeeded(),yield e.client.store.clearOutOfBandMembers(e.roomId),e.currentState.clearOutOfBandMembers(),e.membersPromise=void 0)}))()}cleanupAfterLeaving(){this.clearLoadedMembersIfNeeded().catch((e=>{p.v.error("error after clearing loaded members from "+"room ".concat(this.roomId," after leaving")),p.v.log(e)}))}refreshLiveTimeline(){var e=this;return(0,n.A)((function*(){var t=e.getLiveTimeline(),r=t.getPaginationToken(a.q.FORWARDS),n=t.getPaginationToken(a.q.BACKWARDS),i=t.getEvents(),o=i[i.length-1];p.v.log("[refreshLiveTimeline for ".concat(e.roomId,"] at ")+"mostRecentEventInTimeline=".concat(o&&o.getId()," ")+"liveTimelineBefore=".concat(t.toString()," ")+"forwardPaginationToken=".concat(r," ")+"backwardPaginationToken=".concat(n));var s,c=e.getUnfilteredTimelineSet();o?(e.resetLiveTimeline(null,null),e.emit(J.TimelineRefresh,e,c),s=yield e.client.getEventTimeline(c,o.getId())):s=yield e.client.getLatestTimeline(c);var l=c.getLiveTimeline();!l||null===l.getPaginationToken(a.O.Forward)&&null===l.getPaginationToken(a.O.Backward)&&0===l.getEvents().length?(p.v.log("[refreshLiveTimeline for ".concat(e.roomId,"] using our new live timeline")),s.setPaginationToken(r,a.q.FORWARDS),c.setLiveTimeline(s),e.fixUpLegacyTimelineFields()):p.v.log("[refreshLiveTimeline for ".concat(e.roomId,"] `/sync` or some other request beat us to creating a new ")+"live timeline after we reset it. We'll use that instead since any events in the scrollback from this timeline will include the history."),e.setTimelineNeedsRefresh(!1),e.emit(J.TimelineRefresh,e,c)}))()}resetLiveTimeline(e,t){for(var r of this.timelineSets)r.resetLiveTimeline(null!==e&&void 0!==e?e:void 0,null!==t&&void 0!==t?t:void 0);for(var n of this.threads.values())n.resetLiveTimeline(e,t);this.fixUpLegacyTimelineFields()}fixUpLegacyTimelineFields(){var e=this.oldState,t=this.currentState;this.oldState=this.getLiveTimeline().getState(a.q.BACKWARDS),this.currentState=this.getLiveTimeline().getState(a.q.FORWARDS),e!==this.oldState&&this.emit(J.OldStateUpdated,this,e,this.oldState),t!==this.currentState&&(this.emit(J.CurrentStateUpdated,this,t,this.currentState),this.reEmitter.stopReEmitting(t,[S.f.Events,S.f.Members,S.f.NewMember,S.f.Update,S.f.Marker,b.JH.New,b.JH.Update,b.JH.Destroy,b.JH.LivenessChange]),this.reEmitter.reEmit(this.currentState,[S.f.Events,S.f.Members,S.f.NewMember,S.f.Update,S.f.Marker,b.JH.New,b.JH.Update,b.JH.Destroy,b.JH.LivenessChange]))}onReceipt(e){this.hasEncryptionStateEvent()&&this.clearNotificationsOnReceipt(e)}clearNotificationsOnReceipt(e){var t=[],r=!1,n=e.getContent();for(var i of Object.values(n))for(var[o,s]of Object.entries(i))if(l.ll(o)&&s)for(var[a,c]of Object.entries(s))if(c&&"object"===typeof c){var d=c;a===this.client.getUserId()&&(void 0===d.thread_id?r=!0:"string"===typeof d.thread_id&&t.push(d.thread_id))}for(var u of(r&&(t=this.getThreads().filter((e=>this.getThreadUnreadNotificationCount(e.id,$.Total)>0||this.getThreadUnreadNotificationCount(e.id,$.Highlight)>0)).map((e=>e.id)),t.push("main")),t)){var h,v=20,f="main"===u?this.getLiveTimeline():null===(h=this.getThread(u))||void 0===h?void 0:h.liveTimeline;if(f){for(var g=f.getEvents(),m=0,y=g.length-1;y>=0;y--){var S;if(y===g.length-v)return;var b=g[y];if(this.hasUserReadEvent(this.client.getUserId(),b.getId()))break;var E=this.client.getPushActionsForEvent(b);m+=null!==E&&void 0!==E&&null!==(S=E.tweaks)&&void 0!==S&&S.highlight?1:0}"main"===u?this.setUnreadNotificationCount($.Highlight,m):this.setThreadUnreadNotificationCount(u,$.Highlight,m)}else p.v.warn("Couldn't find timeline for thread ID ".concat(u," in room ").concat(this.roomId))}}getTimelineSets(){return this.timelineSets}getUnfilteredTimelineSet(){return this.timelineSets[0]}getTimelineForEvent(e){var t=this.findEventById(e),r=this.findThreadForEvent(t);return r?r.timelineSet.getTimelineForEvent(e):this.getUnfilteredTimelineSet().getTimelineForEvent(e)}addTimeline(){return this.getUnfilteredTimelineSet().addTimeline()}setTimelineNeedsRefresh(e){this.timelineNeedsRefresh=e}getTimelineNeedsRefresh(){return this.timelineNeedsRefresh}findEventById(e){var t=this.getUnfilteredTimelineSet().findEventById(e);if(!t)for(var r=this.getThreads(),n=0;n<r.length;n++){var i=r[n];if(t=i.findEventById(e),t)return t}return t}getUnreadNotificationCount(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$.Total,t=this.getRoomUnreadNotificationCount(e);for(var r of this.threadNotifications.values()){var n;t+=null!==(n=r[e])&&void 0!==n?n:0}return t}getUnreadCountForEventContext(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$.Total,r=arguments.length>1?arguments[1]:void 0,n=!!r.threadRootId&&!r.isThreadRoot;return null!==(e=n?this.getThreadUnreadNotificationCount(r.threadRootId,t):this.getRoomUnreadNotificationCount(t))&&void 0!==e?e:0}getRoomUnreadNotificationCount(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:$.Total;return null!==(e=this.notificationCounts[t])&&void 0!==e?e:0}getThreadUnreadNotificationCount(e){var t,r,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:$.Total;return null!==(t=null===(r=this.threadNotifications.get(e))||void 0===r?void 0:r[n])&&void 0!==t?t:0}hasThreadUnreadNotification(){for(var e of this.threadNotifications.values()){var t,r;if((null!==(t=e.highlight)&&void 0!==t?t:0)>0||(null!==(r=e.total)&&void 0!==r?r:0)>0)return!0}return!1}setThreadUnreadNotificationCount(e,t,r){var n,i,o=V({highlight:null===(n=this.threadNotifications.get(e))||void 0===n?void 0:n.highlight,total:null===(i=this.threadNotifications.get(e))||void 0===i?void 0:i.total},{[t]:r});this.threadNotifications.set(e,o),this.emit(J.UnreadNotifications,o,e)}get threadsAggregateNotificationType(){var e=null;for(var t of this.threadNotifications.values()){var r,n;if((null!==(r=t.highlight)&&void 0!==r?r:0)>0)return $.Highlight;(null!==(n=t.total)&&void 0!==n?n:0)>0&&!e&&(e=$.Total)}return e}resetThreadUnreadNotificationCountFromSync(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=this.hasEncryptionStateEvent();for(var[r,n]of this.threadNotifications)e.includes(r)||(n.total=0,t||(n.highlight=0));this.emit(J.UnreadNotifications)}setUnreadNotificationCount(e,t){this.notificationCounts[e]=t,this.emit(J.UnreadNotifications,this.notificationCounts)}setUnread(e,t){return this.setUnreadNotificationCount(e,t)}setSummary(e){var t=e["m.heroes"],r=e["m.joined_member_count"],n=e["m.invited_member_count"];Number.isInteger(r)&&this.currentState.setJoinedMemberCount(r),Number.isInteger(n)&&this.currentState.setInvitedMemberCount(n),Array.isArray(t)&&(this.summaryHeroes=t.filter((e=>e!==this.myUserId))),this.emit(J.Summary,e)}setBlacklistUnverifiedDevices(e){this.blacklistUnverifiedDevices=e}getBlacklistUnverifiedDevices(){return void 0===this.blacklistUnverifiedDevices?null:this.blacklistUnverifiedDevices}getAvatarUrl(e,t,r,n){var i=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],o=arguments.length>5&&void 0!==arguments[5]&&arguments[5],s=this.currentState.getStateEvents(g.Bx.RoomAvatar,"");if(!s&&!i)return null;var a=s?s.getContent().url:null;return a?(0,c.y)(e,a,t,r,n,void 0,void 0,o):null}getMxcAvatarUrl(){var e;return(null===(e=this.currentState.getStateEvents(g.Bx.RoomAvatar,""))||void 0===e||null===(e=e.getContent())||void 0===e?void 0:e.url)||null}getCanonicalAlias(){var e=this.currentState.getStateEvents(g.Bx.RoomCanonicalAlias,"");return e&&e.getContent().alias||null}getAltAliases(){var e=this.currentState.getStateEvents(g.Bx.RoomCanonicalAlias,"");return e&&e.getContent().alt_aliases||[]}addEventsToTimeline(e,t,r,n,i){n.getTimelineSet().addEventsToTimeline(e,t,r,n,i)}getThread(e){var t;return null!==(t=this.threads.get(e))&&void 0!==t?t:null}getThreads(){return Array.from(this.threads.values())}getMember(e){return this.currentState.getMember(e)}getMembers(){return this.currentState.getMembers()}getJoinedMembers(){return this.getMembersWithMembership(F.O.Join)}getJoinedMemberCount(){return this.currentState.getJoinedMemberCount()}getInvitedMemberCount(){return this.currentState.getInvitedMemberCount()}getInvitedAndJoinedMemberCount(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()}getMembersWithMembership(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))}getEncryptionTargetMembers(){var e=this;return(0,n.A)((function*(){yield e.loadMembersIfNeeded();var t=e.getMembersWithMembership(F.O.Join);return e.shouldEncryptForInvitedMembers()&&(t=t.concat(e.getMembersWithMembership(F.O.Invite))),t}))()}shouldEncryptForInvitedMembers(){var e,t=this.currentState.getStateEvents(g.Bx.RoomHistoryVisibility,"");return"joined"!==(null===t||void 0===t||null===(e=t.getContent())||void 0===e?void 0:e.history_visibility)}getDefaultRoomName(e){return this.calculateRoomName(e,!0)}hasMembershipState(e,t){var r=this.getMember(e);return!!r&&r.membership===t}getOrCreateFilteredTimelineSet(e){var{prepopulateTimeline:t=!0,useSyncEvents:r=!0,pendingEvents:n=!0}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.filteredTimelineSets[e.filterId])return this.filteredTimelineSets[e.filterId];var i=Object.assign({filter:e,pendingEvents:n},this.opts),o=new s.m(this,i);this.reEmitter.reEmit(o,[J.Timeline,J.TimelineReset]),r&&(this.filteredTimelineSets[e.filterId]=o,this.timelineSets.push(o));var c=this.getLiveTimeline();if(t){c.getEvents().forEach((function(e){o.addLiveEvent(e,{addToState:!1})}));var l=c;while(l.getNeighbouringTimeline(a.q.BACKWARDS))l=l.getNeighbouringTimeline(a.q.BACKWARDS);o.getLiveTimeline().setPaginationToken(l.getPaginationToken(a.q.BACKWARDS),a.q.BACKWARDS)}else if(r){var d=c.getPaginationToken(a.O.Forward);o.getLiveTimeline().setPaginationToken(d,a.O.Backward)}return o}getThreadListFilter(){var e=arguments,t=this;return(0,n.A)((function*(){var r=e.length>0&&void 0!==e[0]?e[0]:E.x3.All,n=t.client.getUserId(),i=new y.d(n),o={room:{timeline:{[E.H.name]:[E.RN.name]}}};r===E.x3.My&&(o.room.timeline[E.o1.name]=[n]),i.setDefinition(o);var s=yield t.client.getOrCreateFilter("THREAD_PANEL_".concat(t.roomId,"_").concat(r),i);return i.filterId=s,i}))()}createThreadTimelineSet(e){var t=this;return(0,n.A)((function*(){var r;if(E.jV.hasServerSideListSupport)r=new s.m(t,V(V({},t.opts),{},{pendingEvents:!1}),void 0,void 0,null!==e&&void 0!==e?e:E.x3.All),t.reEmitter.reEmit(r,[J.Timeline,J.TimelineReset]);else if(E.jV.hasServerSideSupport){var n=yield t.getThreadListFilter(e);r=t.getOrCreateFilteredTimelineSet(n,{prepopulateTimeline:!1,useSyncEvents:!1,pendingEvents:!1})}else r=new s.m(t,{pendingEvents:!1}),Array.from(t.threads).forEach((n=>{var[,i]=n;if(0!==i.length){var o=i.timeline.some((e=>e.getSender()===t.client.getUserId()));(e!==E.x3.My||o)&&r.getLiveTimeline().addEvent(i.rootEvent,{toStartOfTimeline:!1,addToState:!1})}}));return r}))()}processThreadRoots(e,t){if(this.client.supportsThreads())for(var r of e)a.q.setEventMetadata(r,this.currentState,t),this.getThread(r.getId())||this.createThread(r.getId(),r,[],t)}fetchRoomThreads(){var e=this;return(0,n.A)((function*(){if(!e.threadsReady&&e.client.supportsThreads()){if(E.jV.hasServerSideListSupport)yield Promise.all([e.fetchRoomThreadList(E.x3.All),e.fetchRoomThreadList(E.x3.My)]);else{var t=yield e.getThreadListFilter(),{chunk:r}=yield e.client.createMessagesRequest(e.roomId,"",Number.MAX_SAFE_INTEGER,a.O.Backward,t);if(!r.length)return;var n,i=r.map(e.client.getEventMapper()).sort(((e,t)=>{var r=e.getServerAggregatedRelation(E.RN.name),n=t.getServerAggregatedRelation(E.RN.name);return r.latest_event.origin_server_ts-n.latest_event.origin_server_ts})),o=e.getLiveTimeline().getState(a.q.FORWARDS);for(var c of i){var l,d={duplicateStrategy:s.x.Ignore,fromCache:!1,addToState:!1,roomState:o};null===(l=e.threadsTimelineSets[0])||void 0===l||l.addLiveEvent(c,d);var u,h=c.getServerAggregatedRelation(E.RN.name);if(null!==h&&void 0!==h&&h.current_user_participated)null===(u=e.threadsTimelineSets[1])||void 0===u||u.addLiveEvent(c,d),n=c}e.processThreadRoots(i,!0),e.client.decryptEventIfNeeded(i[i.length-1]),n&&e.client.decryptEventIfNeeded(n)}e.on(E.ju.NewReply,e.onThreadReply),e.on(E.ju.Update,e.onThreadUpdate),e.on(E.ju.Delete,e.onThreadDelete),e.threadsReady=!0}}))()}processPollEvents(e){var t=this;return(0,n.A)((function*(){for(var r of e)try{if(!r.isEncrypted()&&!(0,T.Wi)(r))continue;yield t.client.decryptEventIfNeeded(r),t.processPollEvent(r)}catch(n){p.v.warn("Error processing poll event",r.getId(),n)}}))()}processPollEvent(e){var t=this;return(0,n.A)((function*(){if(e.isDecryptionFailure())e.once(d.OQ.Decrypted,(e=>{t.processPollEvent(e)}));else if(o.M_POLL_START.matches(e.getType()))try{var r=new T.sP(e,t.client,t);t.polls.set(e.getId(),r),t.emit(T.sn.New,r),e.once(d.OQ.BeforeRedaction,(e=>{t.polls.delete(e.getId())}))}catch(s){}else{var n=e.relationEventId;if(n&&t.polls.has(n)){var i=t.polls.get(n);null===i||void 0===i||i.onNewRelation(e)}}}))()}fetchRoomThreadList(e){var t=this;return(0,n.A)((function*(){if(t.client.supportsThreads()&&0!==t.threadsTimelineSets.length){var r=e===E.x3.My?t.threadsTimelineSets[1]:t.threadsTimelineSets[0],{chunk:n,end:i}=yield t.client.createThreadListMessagesRequest(t.roomId,null,void 0,a.O.Backward,r.threadListType,r.getFilter());if(r.getLiveTimeline().setPaginationToken(null!==i&&void 0!==i?i:null,a.O.Backward),n.length){var o=n.map(t.client.getEventMapper());t.processThreadRoots(o,!0);var c=t.getLiveTimeline().getState(a.q.FORWARDS);for(var l of o)r.addLiveEvent(l,{duplicateStrategy:s.x.Replace,fromCache:!1,roomState:c,addToState:!1})}}}))()}onThreadUpdate(e){this.updateThreadRootEvents(e,!1,!1)}onThreadReply(e){this.updateThreadRootEvents(e,!1,!0)}onThreadDelete(e){var t;this.threads.delete(e.id);var r=this.getTimelineForEvent(e.id),n=null===r||void 0===r||null===(t=r.getEvents())||void 0===t?void 0:t.find((t=>t.getId()===e.id));for(var i of(n?e.clearEventMetadata(n):p.v.debug("onThreadDelete: Could not find root event in room timeline"),this.threadsTimelineSets))i.removeEvent(e.id)}removeFilteredTimelineSet(e){var t=this.filteredTimelineSets[e.filterId];delete this.filteredTimelineSets[e.filterId];var r=this.timelineSets.indexOf(t);r>-1&&this.timelineSets.splice(r,1)}eventShouldLiveIn(e,t,r){var n;if(null===(n=this.client)||void 0===n||!n.supportsThreads())return{shouldLiveInRoom:!0,shouldLiveInThread:!1};if(e.isThreadRoot||null!==r&&void 0!==r&&r.has(e.getId()))return{shouldLiveInRoom:!0,shouldLiveInThread:!0,threadId:e.getId()};var i,o,s=e.isRelation(E.RN.name),a=e.getAssociatedId(),c=e.threadRootId;if(a&&!s&&(c===a||null!==r&&void 0!==r&&r.has(a)))return{shouldLiveInRoom:!0,shouldLiveInThread:!1};a&&(i=null!==(o=this.findEventById(a))&&void 0!==o?o:null===t||void 0===t?void 0:t.find((e=>e.getId()===a)));return i&&!s?this.eventShouldLiveIn(i,t,r):void 0!=c?{shouldLiveInRoom:!1,shouldLiveInThread:!0,threadId:c}:!a||e.replyEventId?{shouldLiveInRoom:!0,shouldLiveInThread:!1}:{shouldLiveInRoom:!1,shouldLiveInThread:!1}}findThreadForEvent(e){if(!e)return null;var{threadId:t}=this.eventShouldLiveIn(e);return t?this.getThread(t):null}addThreadedEvents(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.getThread(e);if(n)n.addEvents(t,r);else{var i,o=null!==(i=this.findEventById(e))&&void 0!==i?i:t.find((t=>t.getId()===e));this.createThread(e,o,t,r)}}processThreadedEvents(e,t){e.forEach(this.applyRedaction);var r={};for(var n of e){var i,{threadId:o,shouldLiveInThread:s}=this.eventShouldLiveIn(n);s&&!r[o]&&(r[o]=[]),null===(i=r[o])||void 0===i||i.push(n)}Object.entries(r).map((e=>{var[r,n]=e;return this.addThreadedEvents(r,n,t)}))}createThread(e,t){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],i=arguments.length>3?arguments[3]:void 0;if(this.threads.has(e))return this.threads.get(e);if(t){var o=this.relations.getAllChildEventsForEvent(t.getId());null!==o&&void 0!==o&&o.length&&(n=n.concat(o.filter((e=>!e.isRelation(g.zZ.Replace)))))}var s=new E.jV(e,t,{room:this,client:this.client,pendingEventOrdering:this.opts.pendingEventOrdering,receipts:null!==(r=this.cachedThreadReadReceipts.get(e))&&void 0!==r?r:[]});return this.reEmitter.reEmit(s,[E.ju.Delete,E.ju.Update,E.ju.NewReply,J.Timeline,J.TimelineReset]),this.cachedThreadReadReceipts.delete(e),this.threads.set(s.id,s),s.addEvents(n,!1),this.threadsReady&&s.initialEventsFetched&&this.updateThreadRootEvents(s,i,!1),this.emit(E.ju.New,s,i),s}processLiveEvent(e){this.applyRedaction(e),e.isVisibilityEvent()&&this.applyNewVisibilityEvent(e),this.applyPendingVisibilityEvents(e);var t=e.getUnsigned().transaction_id;if(!t&&e.getSender()===this.myUserId)for(var[r,n]of this.txnToEvent)if(n.getId()===e.getId()){p.v.debug("processLiveEvent: found sent event without txn ID: ",r,e.getId());var i=e.getUnsigned();i.transaction_id=r,e.setUnsigned(i);break}}addLiveEvent(e,t){var{duplicateStrategy:r,timelineWasEmpty:n,fromCache:i,addToState:o}=t;for(var s of this.timelineSets)s.addLiveEvent(e,{duplicateStrategy:r,fromCache:i,timelineWasEmpty:n,addToState:o});e.sender&&e.getType()!==g.Bx.RoomRedaction&&this.addReceipt((0,I.D)(e.sender.userId,e,_.L.Read),!0)}addPendingEvent(e,t){if(e.status!==u.f.SENDING&&e.status!==u.f.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this.txnToEvent.get(t))throw new Error("addPendingEvent called on an event with known txnId "+t);if(a.q.setEventMetadata(e,this.getLiveTimeline().getState(a.q.FORWARDS),!1),this.txnToEvent.set(t,e),this.pendingEventList){if(this.pendingEventList.some((e=>e.status===u.f.NOT_SENT))&&(p.v.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(u.f.NOT_SENT)),this.pendingEventList.push(e),this.savePendingEvents(),e.isRelation()&&this.aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this.pendingEventList.find((e=>e.getId()===r));!n&&r&&(n=this.findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit(J.Redaction,e,this,n.threadRootId))}}else for(var i of this.timelineSets)i.getFilter()?i.getFilter().filterRoomTimeline([e]).length&&i.addEventToTimeline(e,i.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1}):i.addEventToTimeline(e,i.getLiveTimeline(),{toStartOfTimeline:!1,addToState:!1});this.emit(J.LocalEchoUpdated,e,this)}savePendingEvents(){if(this.pendingEventList){var e=this.pendingEventList.map((e=>V(V({},e.event),{},{txn_id:e.getTxnId()}))).filter((e=>{var t=e.type===g.Bx.RoomMessageEncrypted,r=this.hasEncryptionStateEvent();return t||!r}));this.client.store.setPendingEvents(this.roomId,e)}}aggregateNonLiveRelation(e){this.relations.aggregateChildEvent(e)}getEventForTxnId(e){return this.txnToEvent.get(e)}handleRemoteEcho(e,t){var r=t.getId(),n=e.getId(),i=t.status;p.v.debug("Got remote echo for event ".concat(r," -> ").concat(n," old status ").concat(i)),this.txnToEvent.delete(e.getUnsigned().transaction_id),this.pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);var{shouldLiveInRoom:o,threadId:s}=this.eventShouldLiveIn(e),a=s?this.getThread(s):null;if(null===a||void 0===a||a.setEventMetadata(t),null===a||void 0===a||a.timelineSet.handleRemoteEcho(t,r,n),o)for(var c of this.timelineSets)c.handleRemoteEcho(t,r,n);this.emit(J.LocalEchoUpdated,t,this,r,i)}updatePendingEvent(e,t,r){if(p.v.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==u.f.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==u.f.SENT){var n=this.getTimelineForEvent(r);if(n){var i=this.findEventById(r),o=null===i||void 0===i?void 0:i.getUnsigned().transaction_id;if(!o&&i){var s=i.getUnsigned();s.transaction_id=e.getTxnId(),i.setUnsigned(s),this.removeEvent(i.getId()),this.handleRemoteEcho(i,e)}return}}var a=e.status,c=e.getId();if(!a)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var l=Y[a];if(null===l||void 0===l||!l.includes(t))throw new Error("Invalid EventStatus transition ".concat(a,"->").concat(t));if(e.setStatus(t),t==u.f.SENT){e.replaceLocalEventId(r);var{shouldLiveInRoom:d,threadId:h}=this.eventShouldLiveIn(e),v=h?this.getThread(h):void 0;if(null===v||void 0===v||v.setEventMetadata(e),null===v||void 0===v||v.timelineSet.replaceEventId(c,r),d)for(var f of this.timelineSets)f.replaceEventId(c,r)}else if(t==u.f.CANCELLED){if(this.pendingEventList){var g=this.getPendingEvent(c);this.removePendingEvent(c),null!==g&&void 0!==g&&g.isRedaction()&&this.revertRedactionLocalEcho(g)}this.removeEvent(c)}this.savePendingEvents(),this.emit(J.LocalEchoUpdated,e,this,c,a)}revertRedactionLocalEcho(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit(J.RedactionCancelled,e,this),r.isRelation()&&this.aggregateNonLiveRelation(r))}}assertTimelineSetsAreLive(){for(var e=0;e<this.timelineSets.length;e++){var t=this.timelineSets[e].getLiveTimeline();if(t.getPaginationToken(a.q.FORWARDS))throw new Error("live timeline "+e+" is no longer live - it has a pagination token ("+t.getPaginationToken(a.q.FORWARDS)+")");if(t.getNeighbouringTimeline(a.q.FORWARDS))throw new Error("live timeline ".concat(e," is no longer live - it has a neighbouring timeline"))}}addLiveEvents(e,t){var r=this;return(0,n.A)((function*(){var{duplicateStrategy:n,fromCache:i,timelineWasEmpty:o=!1,addToState:s}=t;if(n&&-1===["replace","ignore"].indexOf(n))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");r.assertTimelineSetsAreLive();var a=r.findThreadRoots(e),c={},l={duplicateStrategy:n,fromCache:i,timelineWasEmpty:o,addToState:s},u=[...e];for(var h of e){var v;if(r.processLiveEvent(h),h.getUnsigned().transaction_id){var f=r.txnToEvent.get(h.getUnsigned().transaction_id);if(f){r.handleRemoteEcho(h,f);continue}}var{shouldLiveInRoom:m,shouldLiveInThread:y,threadId:S=""}=r.eventShouldLiveIn(h,u,a);if(!y&&!m&&h.isRelation())try{var b=new d.kl(yield r.client.fetchRoomEvent(r.roomId,h.relationEventId));if(u.push(b),b.threadRootId){a.add(b.threadRootId);var E=h.getUnsigned();E[g.Sr.name]=b.threadRootId,h.setUnsigned(E)}({shouldLiveInRoom:m,shouldLiveInThread:y,threadId:S=""}=r.eventShouldLiveIn(h,u,a))}catch(_){p.v.error("Failed to load parent event of unhandled relation",_)}y&&!c[S]&&(c[S]=[]),null===(v=c[S])||void 0===v||v.push(h),m?r.addLiveEvent(h,l):!y&&h.isRelation()&&r.relations.aggregateChildEvent(h)}Object.entries(c).forEach((e=>{var[t,n]=e;r.addThreadedEvents(t,n,!1)}))}))()}partitionThreadedEvents(e){var t=0,r=1,n=2;if(this.client.supportsThreads()){var i=this.findThreadRoots(e);return e.reduce(((o,s)=>{var{shouldLiveInRoom:a,shouldLiveInThread:c,threadId:l}=this.eventShouldLiveIn(s,e,i);return a&&o[t].push(s),c&&(s.setThreadId(null!==l&&void 0!==l?l:""),o[r].push(s)),c||a||o[n].push(s),o}),[[],[],[]])}return[e,[],[]]}findThreadRoots(e){var t=new Set;for(var r of e){var n=r.threadRootId;void 0!=n&&t.add(n)}return t}addReceipt(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e.getContent();this.roomReceipts.add(r,t),Object.keys(r).forEach((e=>{Object.keys(r[e]).forEach((n=>{Object.keys(r[e][n]).forEach((i=>{var o,s,a,c,l=r[e][n][i],d=!l.thread_id||l.thread_id===_.S,u=d?this:this.threads.get(null!==(o=l.thread_id)&&void 0!==o?o:"");if(u){if(u.addReceiptToStructure(e,n,i,l,t),!t&&this.client.isInitialSyncComplete()&&i===this.client.getUserId()){var h=u.timeline[u.timeline.length-1];h&&e===h.getId()&&i===h.getSender()&&(u.setUnread($.Total,0),u.setUnread($.Highlight,0))}}else this.cachedThreadReadReceipts.set(l.thread_id,[...null!==(c=this.cachedThreadReadReceipts.get(l.thread_id))&&void 0!==c?c:[],{eventId:e,receiptType:n,userId:i,receipt:l,synthetic:t}]);var v=this.client.getUserId();i===v&&!d&&l.ts<this.oldestThreadedReceiptTs&&(this.oldestThreadedReceiptTs=l.ts),!l.thread_id&&l.ts>(null!==(s=null===(a=this.unthreadedReceipts.get(i))||void 0===a?void 0:a.ts)&&void 0!==s?s:0)&&this.unthreadedReceipts.set(i,l)}))}))})),this.emit(J.Receipt,e,this)}addEphemeralEvents(e){for(var t of e)t.getType()===g.Bx.Typing?this.currentState.setTypingEvent(t):t.getType()===g.Bx.Receipt&&this.addReceipt(t)}removeEvents(e){for(var t of e)this.removeEvent(t)}removeEvent(e){var t=!1;for(var r of this.timelineSets){var n=r.removeEvent(e);n&&(n.isRedaction()&&this.revertRedactionLocalEcho(n),t=!0)}return t}recalculate(){var e=this.currentState.getStateEvents(g.Bx.RoomMember,this.myUserId);if(e){var t=e.getContent().membership;if(this.updateMyMembership(t),t===F.O.Invite){var r=e.getUnsigned().invite_room_state||[];r.forEach((e=>{var t=this.currentState.getStateEvents(e.type,e.state_key);t||this.currentState.setStateEvents([new d.kl({type:e.type,state_key:e.state_key,content:e.content,event_id:"$fake"+Date.now(),room_id:this.roomId,sender:this.myUserId})])}))}}var n=this.name;this.name=this.calculateRoomName(this.myUserId),this.normalizedName=(0,l.S8)(this.name),this.summary=new v.c(this.roomId,{title:this.name}),n!==this.name&&this.emit(J.Name,this)}addTags(e){this.tags=e.getContent().tags||{},this.emit(J.Tags,e,this)}addAccountData(e){for(var t of e){"m.tag"===t.getType()&&this.addTags(t);var r=t.getType(),n=this.accountData.get(r);this.accountData.set(r,t),this.emit(J.AccountData,t,this,n)}}getAccountData(e){return this.accountData.get(e)}maySendMessage(){return this.getMyMembership()===F.O.Join&&(this.hasEncryptionStateEvent()?this.currentState.maySendEvent(g.Bx.RoomMessageEncrypted,this.myUserId):this.currentState.maySendEvent(g.Bx.RoomMessage,this.myUserId))}canInvite(e){var t=this.getMyMembership()===F.O.Join,r=this.currentState.getStateEvents(g.Bx.RoomPowerLevels,""),n=r&&r.getContent(),i=this.getMember(e);return n&&i&&n.invite>i.powerLevel&&(t=!1),t}getJoinRule(){return this.currentState.getJoinRule()}getHistoryVisibility(){return this.currentState.getHistoryVisibility()}getGuestAccess(){return this.currentState.getGuestAccess()}getType(){var e=this.currentState.getStateEvents(g.Bx.RoomCreate,"");if(e)return e.getContent()[g.Ct];this.getTypeWarning||(p.v.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)}isSpaceRoom(){return this.getType()===g.CJ.Space}isCallRoom(){return this.getType()===g.CJ.UnstableCall}isElementVideoRoom(){return this.getType()===g.CJ.ElementVideo}findPredecessor(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.getLiveTimeline().getState(a.q.FORWARDS);return t?t.findPredecessor(e):null}roomNameGenerator(e){if(this.client.roomNameGenerator){var t=this.client.roomNameGenerator(this.roomId,e);if(null!==t)return t}switch(e.type){case Q.Actual:return e.name;case Q.Generated:switch(e.subtype){case"Inviting":return"Inviting ".concat(X(e.names,e.count));default:return X(e.names,e.count)}case Q.EmptyRoom:return e.oldName?"Empty room (was ".concat(e.oldName,")"):"Empty room"}}calculateRoomName(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t){var r=this.currentState.getStateEvents(g.Bx.RoomName,"");if(null!==r&&void 0!==r&&r.getContent().name)return this.roomNameGenerator({type:Q.Actual,name:r.getContent().name})}var n=this.getCanonicalAlias();if(n)return this.roomNameGenerator({type:Q.Actual,name:n});var i=this.currentState.getJoinedMemberCount(),o=this.currentState.getInvitedMemberCount(),s=i+o-1,a=this.getFunctionalMembers(),c=[];if(this.summaryHeroes)this.summaryHeroes.forEach((e=>{if(a.includes(e))s--;else{var t=this.getMember(e);c.push(t?t.name:e)}}));else{var l=this.currentState.getMembers().filter((t=>t.userId!==e&&(t.membership===F.O.Invite||t.membership===F.O.Join)));l=l.filter((e=>{var{userId:t}=e;return!a.includes(t)||(s--,!1)}));var d=new Intl.Collator;l.sort(((e,t)=>d.compare(e.userId,t.userId))),l=l.slice(0,5),c=l.map((e=>e.name))}if(s)return this.roomNameGenerator({type:Q.Generated,names:c,count:s});var u=this.getMyMembership();if(u==F.O.Join){var h=this.currentState.getStateEvents(g.Bx.RoomThirdPartyInvite);if(null!==h&&void 0!==h&&h.length){var v=h.map((e=>e.getContent().display_name));return this.roomNameGenerator({type:Q.Generated,subtype:"Inviting",names:v,count:v.length+1})}}var p,f=c;return f.length||(f=this.currentState.getMembers().filter((t=>t.userId!==e&&t.membership!==F.O.Invite&&t.membership!==F.O.Join)).map((e=>e.name))),f.length&&(p=this.roomNameGenerator({type:Q.Generated,names:f,count:f.length+1})),this.roomNameGenerator({type:Q.EmptyRoom,oldName:p})}applyNewVisibilityEvent(e){var t=e.asVisibilityChange();if(t){var r=e.getSender();if(r){var n=g.Yg.name&&this.currentState.maySendStateEvent(g.Yg.name,r)||g.Yg.altName&&this.currentState.maySendStateEvent(g.Yg.altName,r);if(n){var i=this.visibilityEvents.get(t.eventId);if(i){for(var o=i.length-1,s=Math.max(0,i.length-H);o>=s;--o){var a=i[o];if(a.getTs()<e.getTs())break}-1===o?i.unshift(e):i.splice(o+1,0,e)}else this.visibilityEvents.set(t.eventId,[e]);var c=this.findEventById(t.eventId);c&&c.applyVisibilityEvent(t)}}}}redactVisibilityChangeEvent(e){if(!e.isVisibilityEvent)throw new Error("expected a visibility change event");var t=e.getRelation(),r=null===t||void 0===t?void 0:t.event_id,n=this.visibilityEvents.get(r);if(n){var i=n.findIndex((t=>t.getId()===e.getId()));if(-1!==i&&(n.splice(i,1),i===n.length)){var o=this.findEventById(r);if(!o)return;if(0===i)this.visibilityEvents.delete(r),o.applyVisibilityEvent();else{var s=n[n.length-1],a=s.asVisibilityChange();if(!a)throw new Error("at this stage, visibility changes should be well-formed");o.applyVisibilityEvent(a)}}}}applyPendingVisibilityEvents(e){var t=this.visibilityEvents.get(e.getId());if(t&&0!=t.length){var r=t[t.length-1],n=r.asVisibilityChange();n&&(n.visible,r.getTs()<e.getTs()||e.applyVisibilityEvent(n))}}getOldestThreadedReceiptTs(){return this.oldestThreadedReceiptTs}hasUserReadEvent(e,t){return this.roomReceipts.hasUserReadEvent(e,t)}getLastUnthreadedReceiptFor(e){return this.unthreadedReceipts.get(e)}fixupNotifications(e){super.fixupNotifications(e);var t=this.getThreads().filter((e=>this.getThreadUnreadNotificationCount(e.id,$.Total)>0));for(var r of t)r.fixupNotifications(e)}compareEventOrdering(e,t){return L(this,e,t)}hasEncryptionStateEvent(){var e;return Boolean(null===(e=this.getLiveTimeline().getState(a.q.FORWARDS))||void 0===e?void 0:e.getStateEvents(g.Bx.RoomEncryption,""))}}var Y={[u.f.ENCRYPTING]:[u.f.SENDING,u.f.NOT_SENT,u.f.CANCELLED],[u.f.SENDING]:[u.f.ENCRYPTING,u.f.QUEUED,u.f.NOT_SENT,u.f.SENT],[u.f.QUEUED]:[u.f.SENDING,u.f.NOT_SENT,u.f.CANCELLED],[u.f.SENT]:[],[u.f.NOT_SENT]:[u.f.SENDING,u.f.QUEUED,u.f.CANCELLED],[u.f.CANCELLED]:[]},Q=function(e){return e[e["EmptyRoom"]=0]="EmptyRoom",e[e["Generated"]=1]="Generated",e[e["Actual"]=2]="Actual",e}({});function X(e,t){var r=t-1;if(e.length){if(1===e.length&&r<=1)return e[0];if(2===e.length&&r<=2)return"".concat(e[0]," and ").concat(e[1]);var n=r>1;return n?"".concat(e[0]," and ").concat(r," others"):"".concat(e[0]," and 1 other")}return"Empty room"}},8968:function(e,t,r){"use strict";r.d(t,{y:function(){return b}});var n=r(698),i=r(4761),o=r(3271),s=r(1949),a=r(812),c=(r(4114),r(8111),r(7588),r(1701),r(3579),r(6170)),l=r(5982),d=!1;class u{constructor(e){this.db=e,(0,i.A)(this,"nextTxnId",0),e.onversionchange=()=>{o.v.log("versionchange for indexeddb ".concat(this.db.name,": closing")),e.close()}}containsData(){return(0,n.A)((function*(){throw Error("Not implemented for Backend")}))()}startup(){var e=this;return(0,n.A)((function*(){return e}))()}deleteAllData(){return(0,n.A)((function*(){throw Error("This is not implemented, call IDBFactory::deleteDatabase(dbName) instead.")}))()}getMigrationState(){var e=this;return(0,n.A)((function*(){var t=l.Il.NOT_STARTED;return yield e.doTxn("readonly",[b.STORE_ACCOUNT],(e=>{var r=e.objectStore(b.STORE_ACCOUNT),n=r.get(l.Nv);n.onsuccess=()=>{var e;t=null!==(e=n.result)&&void 0!==e?e:l.Il.NOT_STARTED}})),t}))()}setMigrationState(e){var t=this;return(0,n.A)((function*(){yield t.doTxn("readwrite",[b.STORE_ACCOUNT],(t=>{var r=t.objectStore(b.STORE_ACCOUNT);r.put(e,l.Nv)}))}))()}getOrAddOutgoingRoomKeyRequest(e){var t=e.requestBody;return new Promise(((r,n)=>{var i=this.db.transaction("outgoingRoomKeyRequests","readwrite");i.onerror=n,this._getOutgoingRoomKeyRequest(i,t,(n=>{if(n)return o.v.log("already have key request outstanding for "+"".concat(t.room_id," / ").concat(t.session_id,": ")+"not sending another"),void r(n);o.v.log("enqueueing key request for ".concat(t.room_id," / ")+t.session_id),i.oncomplete=()=>{r(e)};var s=i.objectStore("outgoingRoomKeyRequests");s.add(e)}))}))}getOutgoingRoomKeyRequest(e){return new Promise(((t,r)=>{var n=this.db.transaction("outgoingRoomKeyRequests","readonly");n.onerror=r,this._getOutgoingRoomKeyRequest(n,e,(e=>{t(e)}))}))}_getOutgoingRoomKeyRequest(e,t,r){var n=e.objectStore("outgoingRoomKeyRequests"),i=n.index("session"),o=i.openCursor([t.room_id,t.session_id]);o.onsuccess=()=>{var e=o.result;if(e){var n=e.value;(0,c.ky)(n.requestBody,t)?r(n):e.continue()}else r(null)}}getOutgoingRoomKeyRequestByState(e){if(0===e.length)return Promise.resolve(null);var t,r=0;function n(){var i=this.result;if(i)t=i.value;else if(r++,!(r>=e.length)){var o=e[r],s=this.source.openCursor(o);s.onsuccess=n}}var i=this.db.transaction("outgoingRoomKeyRequests","readonly"),o=i.objectStore("outgoingRoomKeyRequests"),s=e[r],a=o.index("state").openCursor(s);return a.onsuccess=n,m(i).then((()=>t))}getAllOutgoingRoomKeyRequestsByState(e){return new Promise(((t,r)=>{var n=this.db.transaction("outgoingRoomKeyRequests","readonly"),i=n.objectStore("outgoingRoomKeyRequests"),o=i.index("state"),s=o.getAll(e);s.onsuccess=()=>t(s.result),s.onerror=()=>r(s.error)}))}getOutgoingRoomKeyRequestsByTarget(e,t,r){var n=0,i=[];function o(){var s=this.result;if(s){var a=s.value;a.recipients.some((r=>r.userId===e&&r.deviceId===t))&&i.push(a),s.continue()}else{if(n++,n>=r.length)return;var c=r[n],l=this.source.openCursor(c);l.onsuccess=o}}var s=this.db.transaction("outgoingRoomKeyRequests","readonly"),a=s.objectStore("outgoingRoomKeyRequests"),c=r[n],l=a.index("state").openCursor(c);return l.onsuccess=o,m(s).then((()=>i))}updateOutgoingRoomKeyRequest(e,t,r){var n=null;function i(){var e=this.result;if(e){var i=e.value;i.state==t?(Object.assign(i,r),e.update(i),n=i):o.v.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(i.state))}}var s=this.db.transaction("outgoingRoomKeyRequests","readwrite"),a=s.objectStore("outgoingRoomKeyRequests").openCursor(e);return a.onsuccess=i,m(s).then((()=>n))}deleteOutgoingRoomKeyRequest(e,t){var r=this.db.transaction("outgoingRoomKeyRequests","readwrite"),n=r.objectStore("outgoingRoomKeyRequests").openCursor(e);return n.onsuccess=()=>{var e=n.result;if(e){var r=e.value;r.state==t?e.delete():o.v.warn("Cannot delete room key request in state ".concat(r.state," ")+"(expected ".concat(t,")"))}},m(r)}getAccount(e,t){var r=e.objectStore("account"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(r){g(e,r)}}}storeAccount(e,t){var r=e.objectStore("account");r.put(t,"-")}getCrossSigningKeys(e,t){var r=e.objectStore("account"),n=r.get("crossSigningKeys");n.onsuccess=function(){try{t(n.result||null)}catch(r){g(e,r)}}}getSecretStorePrivateKey(e,t,r){var n=e.objectStore("account"),i=n.get("ssss_cache:".concat(r));i.onsuccess=function(){try{t(i.result||null)}catch(r){g(e,r)}}}storeCrossSigningKeys(e,t){var r=e.objectStore("account");r.put(t,"crossSigningKeys")}storeSecretStorePrivateKey(e,t,r){var n=e.objectStore("account");n.put(r,"ssss_cache:".concat(t))}countEndToEndSessions(e,t){var r=e.objectStore("sessions"),n=r.count();n.onsuccess=function(){try{t(n.result)}catch(r){g(e,r)}}}getEndToEndSessions(e,t,r){var n=t.objectStore("sessions"),i=n.index("deviceKey"),o=i.openCursor(e),s={};o.onsuccess=function(){var e=o.result;if(e)s[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{r(s)}catch(n){g(t,n)}}}getEndToEndSession(e,t,r,n){var i=r.objectStore("sessions"),o=i.get([e,t]);o.onsuccess=function(){try{o.result?n({session:o.result.session,lastReceivedMessageTs:o.result.lastReceivedMessageTs}):n(null)}catch(e){g(r,e)}}}getAllEndToEndSessions(e,t){var r=e.objectStore("sessions"),n=r.openCursor();n.onsuccess=function(){try{var r=n.result;r?(t(r.value),r.continue()):t(null)}catch(i){g(e,i)}}}storeEndToEndSession(e,t,r,n){var i=n.objectStore("sessions");i.put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}storeEndToEndSessionProblem(e,t,r){var i=this;return(0,n.A)((function*(){var n=i.db.transaction("session_problems","readwrite"),o=n.objectStore("session_problems");o.put({deviceKey:e,type:t,fixed:r,time:Date.now()}),yield m(n)}))()}getEndToEndSessionProblem(e,t){var r=this;return(0,n.A)((function*(){var n=null,i=r.db.transaction("session_problems","readwrite"),o=i.objectStore("session_problems"),s=o.index("deviceKey"),a=s.getAll(e);return a.onsuccess=()=>{var e=a.result;if(e.length){e.sort(((e,t)=>e.time-t.time));var r=e[e.length-1];for(var i of e)if(i.time>t)return void(n=Object.assign({},i,{fixed:r.fixed}));n=r.fixed?null:r}else n=null},yield m(i),n}))()}filterOutNotifiedErrorDevices(e){var t=this;return(0,n.A)((function*(){var r=t.db.transaction("notified_error_devices","readwrite"),n=r.objectStore("notified_error_devices"),i=[];return yield Promise.all(e.map((e=>new Promise((t=>{var{userId:r,deviceInfo:o}=e,s=n.get([r,o.deviceId]);s.onsuccess=function(){s.result||(n.put({userId:r,deviceId:o.deviceId}),i.push(e)),t()}}))))),i}))()}getEndToEndSessionsBatch(){var e=this;return(0,n.A)((function*(){var t=[];return yield e.doTxn("readonly",[b.STORE_SESSIONS],(e=>{var r=e.objectStore(b.STORE_SESSIONS),n=r.openCursor();n.onsuccess=function(){try{var r=n.result;r&&(t.push(r.value),t.length<l.oT&&r.continue())}catch(i){g(e,i)}}})),0===t.length?null:t}))()}deleteEndToEndSessionsBatch(e){var t=this;return(0,n.A)((function*(){yield t.doTxn("readwrite",[b.STORE_SESSIONS],function(){var t=(0,n.A)((function*(t){try{var r=t.objectStore(b.STORE_SESSIONS),n=function*(){var e=r.delete([i,o]);yield new Promise((t=>{e.onsuccess=t}))};for(var{deviceKey:i,sessionId:o}of e)yield*n()}catch(s){g(t,s)}}));return function(e){return t.apply(this,arguments)}}())}))()}getEndToEndInboundGroupSession(e,t,r,n){var i=!1,o=!1,s=r.objectStore("inbound_group_sessions"),a=s.get([e,t]);a.onsuccess=function(){try{i=a.result?a.result.session:null,!1!==o&&n(i,o)}catch(e){g(r,e)}};var c=r.objectStore("inbound_group_sessions_withheld"),l=c.get([e,t]);l.onsuccess=function(){try{o=l.result?l.result.session:null,!1!==i&&n(i,o)}catch(e){g(r,e)}}}getAllEndToEndInboundGroupSessions(e,t){var r=e.objectStore("inbound_group_sessions"),n=r.openCursor();n.onsuccess=function(){var r=n.result;if(r){try{t({senderKey:r.value.senderCurve25519Key,sessionId:r.value.sessionId,sessionData:r.value.session})}catch(i){g(e,i)}r.continue()}else try{t(null)}catch(i){g(e,i)}}}addEndToEndInboundGroupSession(e,t,r,n){var i=n.objectStore("inbound_group_sessions"),s=i.add({senderCurve25519Key:e,sessionId:t,session:r});s.onerror=r=>{var i,a;"ConstraintError"===(null===(i=s.error)||void 0===i?void 0:i.name)?(r.stopPropagation(),r.preventDefault(),o.v.log("Ignoring duplicate inbound group session: "+e+" / "+t)):g(n,new Error("Failed to add inbound group session: "+(null===(a=s.error)||void 0===a?void 0:a.name)))}}storeEndToEndInboundGroupSession(e,t,r,n){var i=n.objectStore("inbound_group_sessions");i.put({senderCurve25519Key:e,sessionId:t,session:r})}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){var i=n.objectStore("inbound_group_sessions_withheld");i.put({senderCurve25519Key:e,sessionId:t,session:r})}countEndToEndInboundGroupSessions(){var e=this;return(0,n.A)((function*(){var t=0;return yield e.doTxn("readonly",[b.STORE_INBOUND_GROUP_SESSIONS],(e=>{var r=e.objectStore(b.STORE_INBOUND_GROUP_SESSIONS),n=r.count();n.onsuccess=()=>{t=n.result}})),t}))()}getEndToEndInboundGroupSessionsBatch(){var e=this;return(0,n.A)((function*(){var t=[];return yield e.doTxn("readonly",[b.STORE_INBOUND_GROUP_SESSIONS,b.STORE_BACKUP],(e=>{var r=e.objectStore(b.STORE_INBOUND_GROUP_SESSIONS),n=e.objectStore(b.STORE_BACKUP),i=r.openCursor();i.onsuccess=function(){try{var r=i.result;if(r){var o=n.get(r.key);o.onsuccess=()=>{t.push({senderKey:r.value.senderCurve25519Key,sessionId:r.value.sessionId,sessionData:r.value.session,needsBackup:void 0!==o.result}),t.length<l.oT&&r.continue()}}}catch(s){g(e,s)}}})),0===t.length?null:t}))()}deleteEndToEndInboundGroupSessionsBatch(e){var t=this;return(0,n.A)((function*(){yield t.doTxn("readwrite",[b.STORE_INBOUND_GROUP_SESSIONS],function(){var t=(0,n.A)((function*(t){try{var r=t.objectStore(b.STORE_INBOUND_GROUP_SESSIONS),n=function*(){var e=r.delete([i,o]);yield new Promise((t=>{e.onsuccess=t}))};for(var{senderKey:i,sessionId:o}of e)yield*n()}catch(s){g(t,s)}}));return function(e){return t.apply(this,arguments)}}())}))()}getEndToEndDeviceData(e,t){var r=e.objectStore("device_data"),n=r.get("-");n.onsuccess=function(){try{t(n.result||null)}catch(r){g(e,r)}}}storeEndToEndDeviceData(e,t){var r=t.objectStore("device_data");r.put(e,"-")}storeEndToEndRoom(e,t,r){var n=r.objectStore("rooms");n.put(t,e)}getEndToEndRooms(e,t){var r={},n=e.objectStore("rooms"),i=n.openCursor();i.onsuccess=function(){var n=i.result;if(n)r[n.key]=n.value,n.continue();else try{t(r)}catch(o){g(e,o)}}}getSessionsNeedingBackup(e){return new Promise(((t,r)=>{var n=[],i=this.db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");i.onerror=r,i.oncomplete=function(){t(n)};var o=i.objectStore("sessions_needing_backup"),s=i.objectStore("inbound_group_sessions"),a=o.openCursor();a.onsuccess=function(){var t=a.result;if(t){var r=s.get(t.key);r.onsuccess=function(){n.push({senderKey:r.result.senderCurve25519Key,sessionId:r.result.sessionId,sessionData:r.result.session})},(!e||n.length<e)&&t.continue()}}}))}countSessionsNeedingBackup(e){e||(e=this.db.transaction("sessions_needing_backup","readonly"));var t=e.objectStore("sessions_needing_backup");return new Promise(((e,r)=>{var n=t.count();n.onerror=r,n.onsuccess=()=>e(n.result)}))}unmarkSessionsNeedingBackup(e,t){var r=this;return(0,n.A)((function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map((e=>new Promise(((t,r)=>{var i=n.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=r})))))}))()}markSessionsNeedingBackup(e,t){var r=this;return(0,n.A)((function*(){t||(t=r.db.transaction("sessions_needing_backup","readwrite"));var n=t.objectStore("sessions_needing_backup");yield Promise.all(e.map((e=>new Promise(((t,r)=>{var i=n.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=r})))))}))()}addSharedHistoryInboundGroupSession(e,t,r,n){n||(n=this.db.transaction("shared_history_inbound_group_sessions","readwrite"));var i=n.objectStore("shared_history_inbound_group_sessions"),o=i.get([e]);o.onsuccess=()=>{var{sessions:n}=o.result||{sessions:[]};n.push([t,r]),i.put({roomId:e,sessions:n})}}getSharedHistoryInboundGroupSessions(e,t){t||(t=this.db.transaction("shared_history_inbound_group_sessions","readonly"));var r=t.objectStore("shared_history_inbound_group_sessions"),n=r.get([e]);return new Promise(((e,t)=>{n.onsuccess=()=>{var{sessions:t}=n.result||{sessions:[]};e(t)},n.onerror=t}))}addParkedSharedHistory(e,t,r){r||(r=this.db.transaction("parked_shared_history","readwrite"));var n=r.objectStore("parked_shared_history"),i=n.get([e]);i.onsuccess=()=>{var{parked:r}=i.result||{parked:[]};r.push(t),n.put({roomId:e,parked:r})}}takeParkedSharedHistory(e,t){t||(t=this.db.transaction("parked_shared_history","readwrite"));var r=t.objectStore("parked_shared_history").openCursor(e);return new Promise(((e,t)=>{r.onsuccess=()=>{var t=r.result;if(t){var n=t.value;t.delete(),e(n)}else e([])},r.onerror=t}))}doTxn(e,t,r){var n,i,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:o.v;if(d){var a=this.nextTxnId++;n=Date.now(),i="".concat(e," crypto store transaction ").concat(a," in ").concat(t),s.debug("Starting ".concat(i))}var c=this.db.transaction(t,e),l=m(c),u=r(c);return d&&l.then((()=>{var e=Date.now()-n;s.debug("Finished ".concat(i,", took ").concat(e," ms"))}),(()=>{var e=Date.now()-n;s.error("Failed ".concat(i,", took ").concat(e," ms"))})),l.then((()=>u))}}var h=[e=>{f(e)},e=>{e.createObjectStore("account")},e=>{var t=e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]});t.createIndex("deviceKey","deviceKey")},e=>{e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("device_data")},e=>{e.createObjectStore("rooms")},e=>{e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]})},e=>{var t=e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]});t.createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})},e=>{e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},e=>{e.createObjectStore("parked_shared_history",{keyPath:["roomId"]})}],v=h.length;function p(e,t){o.v.log("Upgrading IndexedDBCryptoStore from version ".concat(t)+" to ".concat(v)),h.forEach(((r,n)=>{t<=n&&r(e)}))}function f(e){var t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}function g(e,t){e._mx_abortexception=t;try{e.abort()}catch(r){}}function m(e){return new Promise(((t,r)=>{e.oncomplete=()=>{void 0!==e._mx_abortexception&&r(e._mx_abortexception),t(null)},e.onerror=t=>{void 0!==e._mx_abortexception?r(e._mx_abortexception):(o.v.log("Error performing indexeddb txn",t),r(e.error))},e.onabort=t=>{void 0!==e._mx_abortexception?r(e._mx_abortexception):(o.v.log("Error performing indexeddb txn",t),r(e.error))}}))}var y=r(6536),S=r(6856);class b{static exists(e,t){return S.t(e,t)}static existsAndIsNotMigrated(e,t){return new Promise(((r,n)=>{var i=!0,o=e.open(t);o.onupgradeneeded=()=>{i=!1},o.onblocked=()=>n(o.error),o.onsuccess=()=>{var s=o.result;if(i){var a=s.transaction([b.STORE_ACCOUNT],"readonly"),c=a.objectStore(b.STORE_ACCOUNT),d=c.get(l.Nv);d.onsuccess=()=>{var e,t=null!==(e=d.result)&&void 0!==e?e:l.Il.NOT_STARTED;r(t===l.Il.NOT_STARTED)},d.onerror=()=>{n(d.error)},s.close()}else s.close(),e.deleteDatabase(t),r(!1)},o.onerror=()=>n(o.error)}))}constructor(e,t){this.indexedDB=e,this.dbName=t,(0,i.A)(this,"backendPromise",void 0),(0,i.A)(this,"backend",void 0)}containsData(){var e=this;return(0,n.A)((function*(){return b.exists(e.indexedDB,e.dbName)}))()}startup(){return this.backendPromise||(this.backendPromise=new Promise(((e,t)=>{if(this.indexedDB){o.v.log("connecting to indexeddb ".concat(this.dbName));var r=this.indexedDB.open(this.dbName,v);r.onupgradeneeded=e=>{var t=r.result,n=e.oldVersion;p(t,n)},r.onblocked=()=>{o.v.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{o.v.log("Error connecting to indexeddb",e),t(r.error)},r.onsuccess=()=>{var t=r.result;o.v.log("connected to indexeddb ".concat(this.dbName)),e(new u(t))}}else t(new Error("no indexeddb support available"))})).then((e=>e.doTxn("readonly",[b.STORE_INBOUND_GROUP_SESSIONS,b.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(t=>{e.getEndToEndInboundGroupSession("","",t,(()=>{}))})).then((()=>e)))).catch((e=>{if("VersionError"===e.name)throw o.v.warn("Crypto DB is too new for us to use!",e),new y.E5(y.hP.TooNew);o.v.warn("unable to connect to indexeddb ".concat(this.dbName)+": falling back to localStorage store: ".concat(e));try{return new s.F(globalThis.localStorage)}catch(e){return o.v.warn("unable to open localStorage: falling back to in-memory store: ".concat(e)),new a._}})).then((e=>(this.backend=e,e)))),this.backendPromise}deleteAllData(){return new Promise(((e,t)=>{if(this.indexedDB){o.v.log("Removing indexeddb instance: ".concat(this.dbName));var r=this.indexedDB.deleteDatabase(this.dbName);r.onblocked=()=>{o.v.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},r.onerror=e=>{o.v.log("Error deleting data from indexeddb",e),t(r.error)},r.onsuccess=()=>{o.v.log("Removed indexeddb instance: ".concat(this.dbName)),e()}}else t(new Error("no indexeddb support available"))})).catch((e=>{o.v.warn("unable to delete IndexedDBCryptoStore: ".concat(e))}))}getMigrationState(){return this.backend.getMigrationState()}setMigrationState(e){return this.backend.setMigrationState(e)}getOrAddOutgoingRoomKeyRequest(e){return this.backend.getOrAddOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequest(e){return this.backend.getOutgoingRoomKeyRequest(e)}getOutgoingRoomKeyRequestByState(e){return this.backend.getOutgoingRoomKeyRequestByState(e)}getAllOutgoingRoomKeyRequestsByState(e){return this.backend.getAllOutgoingRoomKeyRequestsByState(e)}getOutgoingRoomKeyRequestsByTarget(e,t,r){return this.backend.getOutgoingRoomKeyRequestsByTarget(e,t,r)}updateOutgoingRoomKeyRequest(e,t,r){return this.backend.updateOutgoingRoomKeyRequest(e,t,r)}deleteOutgoingRoomKeyRequest(e,t){return this.backend.deleteOutgoingRoomKeyRequest(e,t)}getAccount(e,t){this.backend.getAccount(e,t)}storeAccount(e,t){this.backend.storeAccount(e,t)}getCrossSigningKeys(e,t){this.backend.getCrossSigningKeys(e,t)}getSecretStorePrivateKey(e,t,r){this.backend.getSecretStorePrivateKey(e,t,r)}storeCrossSigningKeys(e,t){this.backend.storeCrossSigningKeys(e,t)}storeSecretStorePrivateKey(e,t,r){this.backend.storeSecretStorePrivateKey(e,t,r)}countEndToEndSessions(e,t){this.backend.countEndToEndSessions(e,t)}getEndToEndSession(e,t,r,n){this.backend.getEndToEndSession(e,t,r,n)}getEndToEndSessions(e,t,r){this.backend.getEndToEndSessions(e,t,r)}getAllEndToEndSessions(e,t){this.backend.getAllEndToEndSessions(e,t)}storeEndToEndSession(e,t,r,n){this.backend.storeEndToEndSession(e,t,r,n)}storeEndToEndSessionProblem(e,t,r){return this.backend.storeEndToEndSessionProblem(e,t,r)}getEndToEndSessionProblem(e,t){return this.backend.getEndToEndSessionProblem(e,t)}filterOutNotifiedErrorDevices(e){return this.backend.filterOutNotifiedErrorDevices(e)}countEndToEndInboundGroupSessions(){return this.backend.countEndToEndInboundGroupSessions()}getEndToEndSessionsBatch(){return this.backend.getEndToEndSessionsBatch()}deleteEndToEndSessionsBatch(e){return this.backend.deleteEndToEndSessionsBatch(e)}getEndToEndInboundGroupSession(e,t,r,n){this.backend.getEndToEndInboundGroupSession(e,t,r,n)}getAllEndToEndInboundGroupSessions(e,t){this.backend.getAllEndToEndInboundGroupSessions(e,t)}addEndToEndInboundGroupSession(e,t,r,n){this.backend.addEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSession(e,t,r,n){this.backend.storeEndToEndInboundGroupSession(e,t,r,n)}storeEndToEndInboundGroupSessionWithheld(e,t,r,n){this.backend.storeEndToEndInboundGroupSessionWithheld(e,t,r,n)}getEndToEndInboundGroupSessionsBatch(){return this.backend.getEndToEndInboundGroupSessionsBatch()}deleteEndToEndInboundGroupSessionsBatch(e){return this.backend.deleteEndToEndInboundGroupSessionsBatch(e)}storeEndToEndDeviceData(e,t){this.backend.storeEndToEndDeviceData(e,t)}getEndToEndDeviceData(e,t){this.backend.getEndToEndDeviceData(e,t)}storeEndToEndRoom(e,t,r){this.backend.storeEndToEndRoom(e,t,r)}getEndToEndRooms(e,t){this.backend.getEndToEndRooms(e,t)}getSessionsNeedingBackup(e){return this.backend.getSessionsNeedingBackup(e)}countSessionsNeedingBackup(e){return this.backend.countSessionsNeedingBackup(e)}unmarkSessionsNeedingBackup(e,t){return this.backend.unmarkSessionsNeedingBackup(e,t)}markSessionsNeedingBackup(e,t){return this.backend.markSessionsNeedingBackup(e,t)}addSharedHistoryInboundGroupSession(e,t,r,n){this.backend.addSharedHistoryInboundGroupSession(e,t,r,n)}getSharedHistoryInboundGroupSessions(e,t){return this.backend.getSharedHistoryInboundGroupSessions(e,t)}addParkedSharedHistory(e,t,r){this.backend.addParkedSharedHistory(e,t,r)}takeParkedSharedHistory(e,t){return this.backend.takeParkedSharedHistory(e,t)}doTxn(e,t,r,n){return this.backend.doTxn(e,t,r,n)}}(0,i.A)(b,"STORE_ACCOUNT","account"),(0,i.A)(b,"STORE_SESSIONS","sessions"),(0,i.A)(b,"STORE_INBOUND_GROUP_SESSIONS","inbound_group_sessions"),(0,i.A)(b,"STORE_INBOUND_GROUP_SESSIONS_WITHHELD","inbound_group_sessions_withheld"),(0,i.A)(b,"STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS","shared_history_inbound_group_sessions"),(0,i.A)(b,"STORE_PARKED_SHARED_HISTORY","parked_shared_history"),(0,i.A)(b,"STORE_DEVICE_DATA","device_data"),(0,i.A)(b,"STORE_ROOMS","rooms"),(0,i.A)(b,"STORE_BACKUP","sessions_needing_backup")},8981:function(e,t,r){"use strict";var n=r(7750),i=Object;e.exports=function(e){return i(n(e))}},9039:function(e){"use strict";e.exports=function(e){try{return!!e()}catch(t){return!0}}},9053:function(e,t,r){"use strict";r.d(t,{LA:function(){return ce},aE:function(){return it}});r(4114),r(8111),r(1148),r(2489),r(116),r(7588),r(1701),r(8237),r(3579),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(5976),i=r(2040);
/*!
  * vue-router v4.5.0
  * (c) 2024 Eduardo San Martin Morote
  * @license MIT
  */
const o="undefined"!==typeof document;function s(e){return"object"===typeof e||"displayName"in e||"props"in e||"__vccOpts"in e}function a(e){return e.__esModule||"Module"===e[Symbol.toStringTag]||e.default&&s(e.default)}const c=Object.assign;function l(e,t){const r={};for(const n in t){const i=t[n];r[n]=u(i)?i.map(e):e(i)}return r}const d=()=>{},u=Array.isArray;const h=/#/g,v=/&/g,p=/\//g,f=/=/g,g=/\?/g,m=/\+/g,y=/%5B/g,S=/%5D/g,b=/%5E/g,E=/%60/g,_=/%7B/g,w=/%7C/g,I=/%7D/g,T=/%20/g;function R(e){return encodeURI(""+e).replace(w,"|").replace(y,"[").replace(S,"]")}function k(e){return R(e).replace(_,"{").replace(I,"}").replace(b,"^")}function A(e){return R(e).replace(m,"%2B").replace(T,"+").replace(h,"%23").replace(v,"%26").replace(E,"`").replace(_,"{").replace(I,"}").replace(b,"^")}function C(e){return A(e).replace(f,"%3D")}function O(e){return R(e).replace(h,"%23").replace(g,"%3F")}function D(e){return null==e?"":O(e).replace(p,"%2F")}function M(e){try{return decodeURIComponent(""+e)}catch(t){}return""+e}const P=/\/$/,x=e=>e.replace(P,"");function U(e,t,r="/"){let n,i={},o="",s="";const a=t.indexOf("#");let c=t.indexOf("?");return a<c&&a>=0&&(c=-1),c>-1&&(n=t.slice(0,c),o=t.slice(c+1,a>-1?a:t.length),i=e(o)),a>-1&&(n=n||t.slice(0,a),s=t.slice(a,t.length)),n=V(null!=n?n:t,r),{fullPath:n+(o&&"?")+o+s,path:n,query:i,hash:M(s)}}function L(e,t){const r=t.query?e(t.query):"";return t.path+(r&&"?")+r+(t.hash||"")}function N(e,t){return t&&e.toLowerCase().startsWith(t.toLowerCase())?e.slice(t.length)||"/":e}function B(e,t,r){const n=t.matched.length-1,i=r.matched.length-1;return n>-1&&n===i&&K(t.matched[n],r.matched[i])&&F(t.params,r.params)&&e(t.query)===e(r.query)&&t.hash===r.hash}function K(e,t){return(e.aliasOf||e)===(t.aliasOf||t)}function F(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(!j(e[r],t[r]))return!1;return!0}function j(e,t){return u(e)?q(e,t):u(t)?q(t,e):e===t}function q(e,t){return u(t)?e.length===t.length&&e.every(((e,r)=>e===t[r])):1===e.length&&e[0]===t}function V(e,t){if(e.startsWith("/"))return e;if(!e)return t;const r=t.split("/"),n=e.split("/"),i=n[n.length-1];".."!==i&&"."!==i||n.push("");let o,s,a=r.length-1;for(o=0;o<n.length;o++)if(s=n[o],"."!==s){if(".."!==s)break;a>1&&a--}return r.slice(0,a).join("/")+"/"+n.slice(o).join("/")}const G={path:"/",name:void 0,params:{},query:{},hash:"",fullPath:"/",matched:[],meta:{},redirectedFrom:void 0};var W,H;(function(e){e["pop"]="pop",e["push"]="push"})(W||(W={})),function(e){e["back"]="back",e["forward"]="forward",e["unknown"]=""}(H||(H={}));function $(e){if(!e)if(o){const t=document.querySelector("base");e=t&&t.getAttribute("href")||"/",e=e.replace(/^\w+:\/\/[^\/]+/,"")}else e="/";return"/"!==e[0]&&"#"!==e[0]&&(e="/"+e),x(e)}const J=/^[^#]+#/;function z(e,t){return e.replace(J,"#")+t}function Y(e,t){const r=document.documentElement.getBoundingClientRect(),n=e.getBoundingClientRect();return{behavior:t.behavior,left:n.left-r.left-(t.left||0),top:n.top-r.top-(t.top||0)}}const Q=()=>({left:window.scrollX,top:window.scrollY});function X(e){let t;if("el"in e){const r=e.el,n="string"===typeof r&&r.startsWith("#");0;const i="string"===typeof r?n?document.getElementById(r.slice(1)):document.querySelector(r):r;if(!i)return;t=Y(i,e)}else t=e;"scrollBehavior"in document.documentElement.style?window.scrollTo(t):window.scrollTo(null!=t.left?t.left:window.scrollX,null!=t.top?t.top:window.scrollY)}function Z(e,t){const r=history.state?history.state.position-t:-1;return r+e}const ee=new Map;function te(e,t){ee.set(e,t)}function re(e){const t=ee.get(e);return ee.delete(e),t}let ne=()=>location.protocol+"//"+location.host;function ie(e,t){const{pathname:r,search:n,hash:i}=t,o=e.indexOf("#");if(o>-1){let t=i.includes(e.slice(o))?e.slice(o).length:1,r=i.slice(t);return"/"!==r[0]&&(r="/"+r),N(r,"")}const s=N(r,e);return s+n+i}function oe(e,t,r,n){let i=[],o=[],s=null;const a=({state:o})=>{const a=ie(e,location),c=r.value,l=t.value;let d=0;if(o){if(r.value=a,t.value=o,s&&s===c)return void(s=null);d=l?o.position-l.position:0}else n(a);i.forEach((e=>{e(r.value,c,{delta:d,type:W.pop,direction:d?d>0?H.forward:H.back:H.unknown})}))};function l(){s=r.value}function d(e){i.push(e);const t=()=>{const t=i.indexOf(e);t>-1&&i.splice(t,1)};return o.push(t),t}function u(){const{history:e}=window;e.state&&e.replaceState(c({},e.state,{scroll:Q()}),"")}function h(){for(const e of o)e();o=[],window.removeEventListener("popstate",a),window.removeEventListener("beforeunload",u)}return window.addEventListener("popstate",a),window.addEventListener("beforeunload",u,{passive:!0}),{pauseListeners:l,listen:d,destroy:h}}function se(e,t,r,n=!1,i=!1){return{back:e,current:t,forward:r,replaced:n,position:window.history.length,scroll:i?Q():null}}function ae(e){const{history:t,location:r}=window,n={value:ie(e,r)},i={value:t.state};function o(n,o,s){const a=e.indexOf("#"),c=a>-1?(r.host&&document.querySelector("base")?e:e.slice(a))+n:ne()+e+n;try{t[s?"replaceState":"pushState"](o,"",c),i.value=o}catch(l){console.error(l),r[s?"replace":"assign"](c)}}function s(e,r){const s=c({},t.state,se(i.value.back,e,i.value.forward,!0),r,{position:i.value.position});o(e,s,!0),n.value=e}function a(e,r){const s=c({},i.value,t.state,{forward:e,scroll:Q()});o(s.current,s,!0);const a=c({},se(n.value,e,null),{position:s.position+1},r);o(e,a,!1),n.value=e}return i.value||o(n.value,{back:null,current:n.value,forward:null,position:t.length-1,replaced:!0,scroll:null},!0),{location:n,state:i,push:a,replace:s}}function ce(e){e=$(e);const t=ae(e),r=oe(e,t.state,t.location,t.replace);function n(e,t=!0){t||r.pauseListeners(),history.go(e)}const i=c({location:"",base:e,go:n,createHref:z.bind(null,e)},t,r);return Object.defineProperty(i,"location",{enumerable:!0,get:()=>t.location.value}),Object.defineProperty(i,"state",{enumerable:!0,get:()=>t.state.value}),i}function le(e){return"string"===typeof e||e&&"object"===typeof e}function de(e){return"string"===typeof e||"symbol"===typeof e}const ue=Symbol("");var he;(function(e){e[e["aborted"]=4]="aborted",e[e["cancelled"]=8]="cancelled",e[e["duplicated"]=16]="duplicated"})(he||(he={}));function ve(e,t){return c(new Error,{type:e,[ue]:!0},t)}function pe(e,t){return e instanceof Error&&ue in e&&(null==t||!!(e.type&t))}const fe="[^/]+?",ge={sensitive:!1,strict:!1,start:!0,end:!0},me=/[.+*?^${}()[\]/\\]/g;function ye(e,t){const r=c({},ge,t),n=[];let i=r.start?"^":"";const o=[];for(const c of e){const e=c.length?[]:[90];r.strict&&!c.length&&(i+="/");for(let t=0;t<c.length;t++){const n=c[t];let s=40+(r.sensitive?.25:0);if(0===n.type)t||(i+="/"),i+=n.value.replace(me,"\\$&"),s+=40;else if(1===n.type){const{value:e,repeatable:r,optional:a,regexp:l}=n;o.push({name:e,repeatable:r,optional:a});const u=l||fe;if(u!==fe){s+=10;try{new RegExp(`(${u})`)}catch(d){throw new Error(`Invalid custom RegExp for param "${e}" (${u}): `+d.message)}}let h=r?`((?:${u})(?:/(?:${u}))*)`:`(${u})`;t||(h=a&&c.length<2?`(?:/${h})`:"/"+h),a&&(h+="?"),i+=h,s+=20,a&&(s+=-8),r&&(s+=-20),".*"===u&&(s+=-50)}e.push(s)}n.push(e)}if(r.strict&&r.end){const e=n.length-1;n[e][n[e].length-1]+=.7000000000000001}r.strict||(i+="/?"),r.end?i+="$":r.strict&&!i.endsWith("/")&&(i+="(?:/|$)");const s=new RegExp(i,r.sensitive?"":"i");function a(e){const t=e.match(s),r={};if(!t)return null;for(let n=1;n<t.length;n++){const e=t[n]||"",i=o[n-1];r[i.name]=e&&i.repeatable?e.split("/"):e}return r}function l(t){let r="",n=!1;for(const i of e){n&&r.endsWith("/")||(r+="/"),n=!1;for(const e of i)if(0===e.type)r+=e.value;else if(1===e.type){const{value:o,repeatable:s,optional:a}=e,c=o in t?t[o]:"";if(u(c)&&!s)throw new Error(`Provided param "${o}" is an array but it is not repeatable (* or + modifiers)`);const l=u(c)?c.join("/"):c;if(!l){if(!a)throw new Error(`Missing required param "${o}"`);i.length<2&&(r.endsWith("/")?r=r.slice(0,-1):n=!0)}r+=l}}return r||"/"}return{re:s,score:n,keys:o,parse:a,stringify:l}}function Se(e,t){let r=0;while(r<e.length&&r<t.length){const n=t[r]-e[r];if(n)return n;r++}return e.length<t.length?1===e.length&&80===e[0]?-1:1:e.length>t.length?1===t.length&&80===t[0]?1:-1:0}function be(e,t){let r=0;const n=e.score,i=t.score;while(r<n.length&&r<i.length){const e=Se(n[r],i[r]);if(e)return e;r++}if(1===Math.abs(i.length-n.length)){if(Ee(n))return 1;if(Ee(i))return-1}return i.length-n.length}function Ee(e){const t=e[e.length-1];return e.length>0&&t[t.length-1]<0}const _e={type:0,value:""},we=/[a-zA-Z0-9_]/;function Ie(e){if(!e)return[[]];if("/"===e)return[[_e]];if(!e.startsWith("/"))throw new Error(`Invalid path "${e}"`);function t(e){throw new Error(`ERR (${r})/"${l}": ${e}`)}let r=0,n=r;const i=[];let o;function s(){o&&i.push(o),o=[]}let a,c=0,l="",d="";function u(){l&&(0===r?o.push({type:0,value:l}):1===r||2===r||3===r?(o.length>1&&("*"===a||"+"===a)&&t(`A repeatable param (${l}) must be alone in its segment. eg: '/:ids+.`),o.push({type:1,value:l,regexp:d,repeatable:"*"===a||"+"===a,optional:"*"===a||"?"===a})):t("Invalid state to consume buffer"),l="")}function h(){l+=a}while(c<e.length)if(a=e[c++],"\\"!==a||2===r)switch(r){case 0:"/"===a?(l&&u(),s()):":"===a?(u(),r=1):h();break;case 4:h(),r=n;break;case 1:"("===a?r=2:we.test(a)?h():(u(),r=0,"*"!==a&&"?"!==a&&"+"!==a&&c--);break;case 2:")"===a?"\\"==d[d.length-1]?d=d.slice(0,-1)+a:r=3:d+=a;break;case 3:u(),r=0,"*"!==a&&"?"!==a&&"+"!==a&&c--,d="";break;default:t("Unknown state");break}else n=r,r=4;return 2===r&&t(`Unfinished custom RegExp for param "${l}"`),u(),s(),i}function Te(e,t,r){const n=ye(Ie(e.path),r);const i=c(n,{record:e,parent:t,children:[],alias:[]});return t&&!i.record.aliasOf===!t.record.aliasOf&&t.children.push(i),i}function Re(e,t){const r=[],n=new Map;function i(e){return n.get(e)}function o(e,r,n){const i=!n,a=Ae(e);a.aliasOf=n&&n.record;const u=Me(t,e),h=[a];if("alias"in e){const t="string"===typeof e.alias?[e.alias]:e.alias;for(const e of t)h.push(Ae(c({},a,{components:n?n.record.components:a.components,path:e,aliasOf:n?n.record:a})))}let v,p;for(const t of h){const{path:c}=t;if(r&&"/"!==c[0]){const e=r.record.path,n="/"===e[e.length-1]?"":"/";t.path=r.record.path+(c&&n+c)}if(v=Te(t,r,u),n?n.alias.push(v):(p=p||v,p!==v&&p.alias.push(v),i&&e.name&&!Oe(v)&&s(e.name)),Ue(v)&&l(v),a.children){const e=a.children;for(let t=0;t<e.length;t++)o(e[t],v,n&&n.children[t])}n=n||v}return p?()=>{s(p)}:d}function s(e){if(de(e)){const t=n.get(e);t&&(n.delete(e),r.splice(r.indexOf(t),1),t.children.forEach(s),t.alias.forEach(s))}else{const t=r.indexOf(e);t>-1&&(r.splice(t,1),e.record.name&&n.delete(e.record.name),e.children.forEach(s),e.alias.forEach(s))}}function a(){return r}function l(e){const t=Pe(e,r);r.splice(t,0,e),e.record.name&&!Oe(e)&&n.set(e.record.name,e)}function u(e,t){let i,o,s,a={};if("name"in e&&e.name){if(i=n.get(e.name),!i)throw ve(1,{location:e});0,s=i.record.name,a=c(ke(t.params,i.keys.filter((e=>!e.optional)).concat(i.parent?i.parent.keys.filter((e=>e.optional)):[]).map((e=>e.name))),e.params&&ke(e.params,i.keys.map((e=>e.name)))),o=i.stringify(a)}else if(null!=e.path)o=e.path,i=r.find((e=>e.re.test(o))),i&&(a=i.parse(o),s=i.record.name);else{if(i=t.name?n.get(t.name):r.find((e=>e.re.test(t.path))),!i)throw ve(1,{location:e,currentLocation:t});s=i.record.name,a=c({},t.params,e.params),o=i.stringify(a)}const l=[];let d=i;while(d)l.unshift(d.record),d=d.parent;return{name:s,path:o,params:a,matched:l,meta:De(l)}}function h(){r.length=0,n.clear()}return t=Me({strict:!1,end:!0,sensitive:!1},t),e.forEach((e=>o(e))),{addRoute:o,resolve:u,removeRoute:s,clearRoutes:h,getRoutes:a,getRecordMatcher:i}}function ke(e,t){const r={};for(const n of t)n in e&&(r[n]=e[n]);return r}function Ae(e){const t={path:e.path,redirect:e.redirect,name:e.name,meta:e.meta||{},aliasOf:e.aliasOf,beforeEnter:e.beforeEnter,props:Ce(e),children:e.children||[],instances:{},leaveGuards:new Set,updateGuards:new Set,enterCallbacks:{},components:"components"in e?e.components||null:e.component&&{default:e.component}};return Object.defineProperty(t,"mods",{value:{}}),t}function Ce(e){const t={},r=e.props||!1;if("component"in e)t.default=r;else for(const n in e.components)t[n]="object"===typeof r?r[n]:r;return t}function Oe(e){while(e){if(e.record.aliasOf)return!0;e=e.parent}return!1}function De(e){return e.reduce(((e,t)=>c(e,t.meta)),{})}function Me(e,t){const r={};for(const n in e)r[n]=n in t?t[n]:e[n];return r}function Pe(e,t){let r=0,n=t.length;while(r!==n){const i=r+n>>1,o=be(e,t[i]);o<0?n=i:r=i+1}const i=xe(e);return i&&(n=t.lastIndexOf(i,n-1)),n}function xe(e){let t=e;while(t=t.parent)if(Ue(t)&&0===be(e,t))return t}function Ue({record:e}){return!!(e.name||e.components&&Object.keys(e.components).length||e.redirect)}function Le(e){const t={};if(""===e||"?"===e)return t;const r="?"===e[0],n=(r?e.slice(1):e).split("&");for(let i=0;i<n.length;++i){const e=n[i].replace(m," "),r=e.indexOf("="),o=M(r<0?e:e.slice(0,r)),s=r<0?null:M(e.slice(r+1));if(o in t){let e=t[o];u(e)||(e=t[o]=[e]),e.push(s)}else t[o]=s}return t}function Ne(e){let t="";for(let r in e){const n=e[r];if(r=C(r),null==n){void 0!==n&&(t+=(t.length?"&":"")+r);continue}const i=u(n)?n.map((e=>e&&A(e))):[n&&A(n)];i.forEach((e=>{void 0!==e&&(t+=(t.length?"&":"")+r,null!=e&&(t+="="+e))}))}return t}function Be(e){const t={};for(const r in e){const n=e[r];void 0!==n&&(t[r]=u(n)?n.map((e=>null==e?null:""+e)):null==n?n:""+n)}return t}const Ke=Symbol(""),Fe=Symbol(""),je=Symbol(""),qe=Symbol(""),Ve=Symbol("");function Ge(){let e=[];function t(t){return e.push(t),()=>{const r=e.indexOf(t);r>-1&&e.splice(r,1)}}function r(){e=[]}return{add:t,list:()=>e.slice(),reset:r}}function We(e,t,r,n,i,o=e=>e()){const s=n&&(n.enterCallbacks[i]=n.enterCallbacks[i]||[]);return()=>new Promise(((a,c)=>{const l=e=>{!1===e?c(ve(4,{from:r,to:t})):e instanceof Error?c(e):le(e)?c(ve(2,{from:t,to:e})):(s&&n.enterCallbacks[i]===s&&"function"===typeof e&&s.push(e),a())},d=o((()=>e.call(n&&n.instances[i],t,r,l)));let u=Promise.resolve(d);e.length<3&&(u=u.then(l)),u.catch((e=>c(e)))}))}function He(e,t,r,n,i=e=>e()){const o=[];for(const c of e){0;for(const e in c.components){let l=c.components[e];if("beforeRouteEnter"===t||c.instances[e])if(s(l)){const s=l.__vccOpts||l,a=s[t];a&&o.push(We(a,r,n,c,e,i))}else{let s=l();0,o.push((()=>s.then((o=>{if(!o)throw new Error(`Couldn't resolve component "${e}" at "${c.path}"`);const s=a(o)?o.default:o;c.mods[e]=o,c.components[e]=s;const l=s.__vccOpts||s,d=l[t];return d&&We(d,r,n,c,e,i)()}))))}}}return o}function $e(e){const t=(0,n.WQ)(je),r=(0,n.WQ)(qe);const o=(0,n.EW)((()=>{const r=(0,i.R1)(e.to);return t.resolve(r)})),s=(0,n.EW)((()=>{const{matched:e}=o.value,{length:t}=e,n=e[t-1],i=r.matched;if(!n||!i.length)return-1;const s=i.findIndex(K.bind(null,n));if(s>-1)return s;const a=Ze(e[t-2]);return t>1&&Ze(n)===a&&i[i.length-1].path!==a?i.findIndex(K.bind(null,e[t-2])):s})),a=(0,n.EW)((()=>s.value>-1&&Xe(r.params,o.value.params))),c=(0,n.EW)((()=>s.value>-1&&s.value===r.matched.length-1&&F(r.params,o.value.params)));function l(r={}){if(Qe(r)){const r=t[(0,i.R1)(e.replace)?"replace":"push"]((0,i.R1)(e.to)).catch(d);return e.viewTransition&&"undefined"!==typeof document&&"startViewTransition"in document&&document.startViewTransition((()=>r)),r}return Promise.resolve()}return{route:o,href:(0,n.EW)((()=>o.value.href)),isActive:a,isExactActive:c,navigate:l}}function Je(e){return 1===e.length?e[0]:e}const ze=(0,n.pM)({name:"RouterLink",compatConfig:{MODE:3},props:{to:{type:[String,Object],required:!0},replace:Boolean,activeClass:String,exactActiveClass:String,custom:Boolean,ariaCurrentValue:{type:String,default:"page"}},useLink:$e,setup(e,{slots:t}){const r=(0,i.Kh)($e(e)),{options:o}=(0,n.WQ)(je),s=(0,n.EW)((()=>({[et(e.activeClass,o.linkActiveClass,"router-link-active")]:r.isActive,[et(e.exactActiveClass,o.linkExactActiveClass,"router-link-exact-active")]:r.isExactActive})));return()=>{const i=t.default&&Je(t.default(r));return e.custom?i:(0,n.h)("a",{"aria-current":r.isExactActive?e.ariaCurrentValue:null,href:r.href,onClick:r.navigate,class:s.value},i)}}}),Ye=ze;function Qe(e){if(!(e.metaKey||e.altKey||e.ctrlKey||e.shiftKey)&&!e.defaultPrevented&&(void 0===e.button||0===e.button)){if(e.currentTarget&&e.currentTarget.getAttribute){const t=e.currentTarget.getAttribute("target");if(/\b_blank\b/i.test(t))return}return e.preventDefault&&e.preventDefault(),!0}}function Xe(e,t){for(const r in t){const n=t[r],i=e[r];if("string"===typeof n){if(n!==i)return!1}else if(!u(i)||i.length!==n.length||n.some(((e,t)=>e!==i[t])))return!1}return!0}function Ze(e){return e?e.aliasOf?e.aliasOf.path:e.path:""}const et=(e,t,r)=>null!=e?e:null!=t?t:r,tt=(0,n.pM)({name:"RouterView",inheritAttrs:!1,props:{name:{type:String,default:"default"},route:Object},compatConfig:{MODE:3},setup(e,{attrs:t,slots:r}){const o=(0,n.WQ)(Ve),s=(0,n.EW)((()=>e.route||o.value)),a=(0,n.WQ)(Fe,0),l=(0,n.EW)((()=>{let e=(0,i.R1)(a);const{matched:t}=s.value;let r;while((r=t[e])&&!r.components)e++;return e})),d=(0,n.EW)((()=>s.value.matched[l.value]));(0,n.Gt)(Fe,(0,n.EW)((()=>l.value+1))),(0,n.Gt)(Ke,d),(0,n.Gt)(Ve,s);const u=(0,i.KR)();return(0,n.wB)((()=>[u.value,d.value,e.name]),(([e,t,r],[n,i,o])=>{t&&(t.instances[r]=e,i&&i!==t&&e&&e===n&&(t.leaveGuards.size||(t.leaveGuards=i.leaveGuards),t.updateGuards.size||(t.updateGuards=i.updateGuards))),!e||!t||i&&K(t,i)&&n||(t.enterCallbacks[r]||[]).forEach((t=>t(e)))}),{flush:"post"}),()=>{const i=s.value,o=e.name,a=d.value,l=a&&a.components[o];if(!l)return rt(r.default,{Component:l,route:i});const h=a.props[o],v=h?!0===h?i.params:"function"===typeof h?h(i):h:null,p=e=>{e.component.isUnmounted&&(a.instances[o]=null)},f=(0,n.h)(l,c({},v,t,{onVnodeUnmounted:p,ref:u}));return rt(r.default,{Component:f,route:i})||f}}});function rt(e,t){if(!e)return null;const r=e(t);return 1===r.length?r[0]:r}const nt=tt;function it(e){const t=Re(e.routes,e),r=e.parseQuery||Le,s=e.stringifyQuery||Ne,a=e.history;const h=Ge(),v=Ge(),p=Ge(),f=(0,i.IJ)(G);let g=G;o&&e.scrollBehavior&&"scrollRestoration"in history&&(history.scrollRestoration="manual");const m=l.bind(null,(e=>""+e)),y=l.bind(null,D),S=l.bind(null,M);function b(e,r){let n,i;return de(e)?(n=t.getRecordMatcher(e),i=r):i=e,t.addRoute(i,n)}function E(e){const r=t.getRecordMatcher(e);r&&t.removeRoute(r)}function _(){return t.getRoutes().map((e=>e.record))}function w(e){return!!t.getRecordMatcher(e)}function I(e,n){if(n=c({},n||f.value),"string"===typeof e){const i=U(r,e,n.path),o=t.resolve({path:i.path},n),s=a.createHref(i.fullPath);return c(i,o,{params:S(o.params),hash:M(i.hash),redirectedFrom:void 0,href:s})}let i;if(null!=e.path)i=c({},e,{path:U(r,e.path,n.path).path});else{const t=c({},e.params);for(const e in t)null==t[e]&&delete t[e];i=c({},e,{params:y(t)}),n.params=y(n.params)}const o=t.resolve(i,n),l=e.hash||"";o.params=m(S(o.params));const d=L(s,c({},e,{hash:k(l),path:o.path})),u=a.createHref(d);return c({fullPath:d,hash:l,query:s===Ne?Be(e.query):e.query||{}},o,{redirectedFrom:void 0,href:u})}function T(e){return"string"===typeof e?U(r,e,f.value.path):c({},e)}function R(e,t){if(g!==e)return ve(8,{from:t,to:e})}function A(e){return P(e)}function C(e){return A(c(T(e),{replace:!0}))}function O(e){const t=e.matched[e.matched.length-1];if(t&&t.redirect){const{redirect:r}=t;let n="function"===typeof r?r(e):r;return"string"===typeof n&&(n=n.includes("?")||n.includes("#")?n=T(n):{path:n},n.params={}),c({query:e.query,hash:e.hash,params:null!=n.path?{}:e.params},n)}}function P(e,t){const r=g=I(e),n=f.value,i=e.state,o=e.force,a=!0===e.replace,l=O(r);if(l)return P(c(T(l),{state:"object"===typeof l?c({},i,l.state):i,force:o,replace:a}),t||r);const d=r;let u;return d.redirectedFrom=t,!o&&B(s,n,r)&&(u=ve(16,{to:d,from:n}),ne(n,n,!0,!1)),(u?Promise.resolve(u):K(d,n)).catch((e=>pe(e)?pe(e,2)?e:ee(e):z(e,d,n))).then((e=>{if(e){if(pe(e,2))return P(c({replace:a},T(e.to),{state:"object"===typeof e.to?c({},i,e.to.state):i,force:o}),t||d)}else e=j(d,n,!0,a,i);return F(d,n,e),e}))}function x(e,t){const r=R(e,t);return r?Promise.reject(r):Promise.resolve()}function N(e){const t=se.values().next().value;return t&&"function"===typeof t.runWithContext?t.runWithContext(e):e()}function K(e,t){let r;const[n,i,o]=ot(e,t);r=He(n.reverse(),"beforeRouteLeave",e,t);for(const a of n)a.leaveGuards.forEach((n=>{r.push(We(n,e,t))}));const s=x.bind(null,e,t);return r.push(s),ce(r).then((()=>{r=[];for(const n of h.list())r.push(We(n,e,t));return r.push(s),ce(r)})).then((()=>{r=He(i,"beforeRouteUpdate",e,t);for(const n of i)n.updateGuards.forEach((n=>{r.push(We(n,e,t))}));return r.push(s),ce(r)})).then((()=>{r=[];for(const n of o)if(n.beforeEnter)if(u(n.beforeEnter))for(const i of n.beforeEnter)r.push(We(i,e,t));else r.push(We(n.beforeEnter,e,t));return r.push(s),ce(r)})).then((()=>(e.matched.forEach((e=>e.enterCallbacks={})),r=He(o,"beforeRouteEnter",e,t,N),r.push(s),ce(r)))).then((()=>{r=[];for(const n of v.list())r.push(We(n,e,t));return r.push(s),ce(r)})).catch((e=>pe(e,8)?e:Promise.reject(e)))}function F(e,t,r){p.list().forEach((n=>N((()=>n(e,t,r)))))}function j(e,t,r,n,i){const s=R(e,t);if(s)return s;const l=t===G,d=o?history.state:{};r&&(n||l?a.replace(e.fullPath,c({scroll:l&&d&&d.scroll},i)):a.push(e.fullPath,i)),f.value=e,ne(e,t,r,l),ee()}let q;function V(){q||(q=a.listen(((e,t,r)=>{if(!ae.listening)return;const n=I(e),i=O(n);if(i)return void P(c(i,{replace:!0,force:!0}),n).catch(d);g=n;const s=f.value;o&&te(Z(s.fullPath,r.delta),Q()),K(n,s).catch((e=>pe(e,12)?e:pe(e,2)?(P(c(T(e.to),{force:!0}),n).then((e=>{pe(e,20)&&!r.delta&&r.type===W.pop&&a.go(-1,!1)})).catch(d),Promise.reject()):(r.delta&&a.go(-r.delta,!1),z(e,n,s)))).then((e=>{e=e||j(n,s,!1),e&&(r.delta&&!pe(e,8)?a.go(-r.delta,!1):r.type===W.pop&&pe(e,20)&&a.go(-1,!1)),F(n,s,e)})).catch(d)})))}let H,$=Ge(),J=Ge();function z(e,t,r){ee(e);const n=J.list();return n.length?n.forEach((n=>n(e,t,r))):console.error(e),Promise.reject(e)}function Y(){return H&&f.value!==G?Promise.resolve():new Promise(((e,t)=>{$.add([e,t])}))}function ee(e){return H||(H=!e,V(),$.list().forEach((([t,r])=>e?r(e):t())),$.reset()),e}function ne(t,r,i,s){const{scrollBehavior:a}=e;if(!o||!a)return Promise.resolve();const c=!i&&re(Z(t.fullPath,0))||(s||!i)&&history.state&&history.state.scroll||null;return(0,n.dY)().then((()=>a(t,r,c))).then((e=>e&&X(e))).catch((e=>z(e,t,r)))}const ie=e=>a.go(e);let oe;const se=new Set,ae={currentRoute:f,listening:!0,addRoute:b,removeRoute:E,clearRoutes:t.clearRoutes,hasRoute:w,getRoutes:_,resolve:I,options:e,push:A,replace:C,go:ie,back:()=>ie(-1),forward:()=>ie(1),beforeEach:h.add,beforeResolve:v.add,afterEach:p.add,onError:J.add,isReady:Y,install(e){const t=this;e.component("RouterLink",Ye),e.component("RouterView",nt),e.config.globalProperties.$router=t,Object.defineProperty(e.config.globalProperties,"$route",{enumerable:!0,get:()=>(0,i.R1)(f)}),o&&!oe&&f.value===G&&(oe=!0,A(a.location).catch((e=>{0})));const r={};for(const i in G)Object.defineProperty(r,i,{get:()=>f.value[i],enumerable:!0});e.provide(je,t),e.provide(qe,(0,i.Gc)(r)),e.provide(Ve,f);const n=e.unmount;se.add(e),e.unmount=function(){se.delete(e),se.size<1&&(g=G,q&&q(),q=null,f.value=G,oe=!1,H=!1),n()}}};function ce(e){return e.reduce(((e,t)=>e.then((()=>N(t)))),Promise.resolve())}return ae}function ot(e,t){const r=[],n=[],i=[],o=Math.max(t.matched.length,e.matched.length);for(let s=0;s<o;s++){const o=t.matched[s];o&&(e.matched.find((e=>K(e,o)))?n.push(o):r.push(o));const a=e.matched[s];a&&(t.matched.find((e=>K(e,a)))||i.push(a))}return[r,n,i]}},9061:function(e,t,r){"use strict";r.d(t,{Hr:function(){return n},Uv:function(){return o},eD:function(){return i}});var n=["v1.1","v1.2","v1.3","v1.4","v1.5","v1.6","v1.7","v1.8","v1.9"],i=n[0],o=n[n.length-1]},9286:function(e,t,r){"use strict";var n=r(4402),i=r(8469),o=n.Set,s=n.add;e.exports=function(e){var t=new o;return i(e,(function(e){s(t,e)})),t}},9297:function(e,t,r){"use strict";var n=r(9504),i=r(8981),o=n({}.hasOwnProperty);e.exports=Object.hasOwn||function(e,t){return o(i(e),t)}},9306:function(e,t,r){"use strict";var n=r(4901),i=r(6823),o=TypeError;e.exports=function(e){if(n(e))return e;throw new o(i(e)+" is not a function")}},9310:function(e,t,r){"use strict";r.d(t,{Hl:function(){return s},Rc:function(){return l},eM:function(){return c},up:function(){return a}});r(4114),r(8111),r(2489),r(7588);var n=r(4761);function i(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function o(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?i(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):i(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class s extends Error{constructor(e,t,r){super(e),this.httpStatus=t,this.httpHeaders=r}isRateLimitError(){return 429===this.httpStatus}getRetryAfterMs(){var e,t=null===(e=this.httpHeaders)||void 0===e?void 0:e.get("Retry-After");if(null!=t){if(/^\d+$/.test(t)){var r=1e3*Number.parseInt(t);if(!Number.isFinite(r))throw new Error("Retry-After header integer value is too large");return r}var n=new Date(t);if(n.toUTCString()!==t)throw new Error("Retry-After header value is not a valid HTTP-date or non-negative decimal integer");return n.getTime()-Date.now()}return null}}class a extends s{constructor(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,r=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,s=e.error||"Unknown message";t&&(s="[".concat(t,"] ").concat(s)),r&&(s="".concat(s," (").concat(r,")")),super("MatrixError: ".concat(s),t,o),this.url=r,this.event=i,(0,n.A)(this,"errcode",void 0),(0,n.A)(this,"data",void 0),this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.data=e}isRateLimitError(){return"M_LIMIT_EXCEEDED"===this.errcode||("M_UNKNOWN"===this.errcode||void 0===this.errcode)&&super.isRateLimitError()}getRetryAfterMs(){var e=super.getRetryAfterMs();if(null!==e)return e;if("M_LIMIT_EXCEEDED"===this.errcode&&"retry_after_ms"in this.data){if(!Number.isInteger(this.data.retry_after_ms))throw new Error("retry_after_ms is not an integer");return this.data.retry_after_ms}return null}asWidgetApiErrorData(){var e,t,r,n,i={};if(this.httpHeaders)for(var[s,a]of this.httpHeaders)i[s]=a;return{http_status:null!==(e=this.httpStatus)&&void 0!==e?e:400,http_headers:i,url:null!==(t=this.url)&&void 0!==t?t:"",response:o({errcode:null!==(r=this.errcode)&&void 0!==r?r:"M_UNKNOWN",error:null!==(n=this.data.error)&&void 0!==n?n:"Unknown message"},this.data)}}static fromWidgetApiErrorData(e){return new a(e.response,e.http_status,e.url,void 0,new Headers(e.http_headers))}}function c(e,t){if(!(e instanceof s)||!e.isRateLimitError())return t;try{var r;return null!==(r=e.getRetryAfterMs())&&void 0!==r?r:t}catch(n){return t}}class l extends Error{constructor(e,t){super(e+(t?": ".concat(t.message):""))}get name(){return"ConnectionError"}}},9366:function(e,t,r){"use strict";r(4114);var n,i="object"===typeof Reflect?Reflect:null,o=i&&"function"===typeof i.apply?i.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};function s(e){console&&console.warn&&console.warn(e)}n=i&&"function"===typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var a=Number.isNaN||function(e){return e!==e};function c(){c.init.call(this)}e.exports=c,e.exports.once=b,c.EventEmitter=c,c.prototype._events=void 0,c.prototype._eventsCount=0,c.prototype._maxListeners=void 0;var l=10;function d(e){if("function"!==typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?c.defaultMaxListeners:e._maxListeners}function h(e,t,r,n){var i,o,a;if(d(r),o=e._events,void 0===o?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),a=o[t]),void 0===a)a=o[t]=r,++e._eventsCount;else if("function"===typeof a?a=o[t]=n?[r,a]:[a,r]:n?a.unshift(r):a.push(r),i=u(e),i>0&&a.length>i&&!a.warned){a.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=a.length,s(c)}return e}function v(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function p(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=v.bind(n);return i.listener=r,n.wrapFn=i,i}function f(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"===typeof i?r?[i.listener||i]:[i]:r?S(i):m(i,i.length)}function g(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"===typeof r)return 1;if(void 0!==r)return r.length}return 0}function m(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}function y(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}function S(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}function b(e,t){return new Promise((function(r,n){function i(r){e.removeListener(t,o),n(r)}function o(){"function"===typeof e.removeListener&&e.removeListener("error",i),r([].slice.call(arguments))}_(e,t,o,{once:!0}),"error"!==t&&E(e,i,{once:!0})}))}function E(e,t,r){"function"===typeof e.on&&_(e,"error",t,r)}function _(e,t,r,n){if("function"===typeof e.on)n.once?e.once(t,r):e.on(t,r);else{if("function"!==typeof e.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof e);e.addEventListener(t,(function i(o){n.once&&e.removeEventListener(t,i),r(o)}))}}Object.defineProperty(c,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!==typeof e||e<0||a(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),c.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},c.prototype.setMaxListeners=function(e){if("number"!==typeof e||e<0||a(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},c.prototype.getMaxListeners=function(){return u(this)},c.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var c=i[e];if(void 0===c)return!1;if("function"===typeof c)o(c,this,t);else{var l=c.length,d=m(c,l);for(r=0;r<l;++r)o(d[r],this,t)}return!0},c.prototype.addListener=function(e,t){return h(this,e,t,!1)},c.prototype.on=c.prototype.addListener,c.prototype.prependListener=function(e,t){return h(this,e,t,!0)},c.prototype.once=function(e,t){return d(t),this.on(e,p(this,e,t)),this},c.prototype.prependOnceListener=function(e,t){return d(t),this.prependListener(e,p(this,e,t)),this},c.prototype.removeListener=function(e,t){var r,n,i,o,s;if(d(t),n=this._events,void 0===n)return this;if(r=n[e],void 0===r)return this;if(r===t||r.listener===t)0===--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!==typeof r){for(i=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){s=r[o].listener,i=o;break}if(i<0)return this;0===i?r.shift():y(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},c.prototype.off=c.prototype.removeListener,c.prototype.removeAllListeners=function(e){var t,r,n;if(r=this._events,void 0===r)return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0===--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,o=Object.keys(r);for(n=0;n<o.length;++n)i=o[n],"removeListener"!==i&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=r[e],"function"===typeof t)this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},c.prototype.listeners=function(e){return f(this,e,!0)},c.prototype.rawListeners=function(e){return f(this,e,!1)},c.listenerCount=function(e,t){return"function"===typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},c.prototype.listenerCount=g,c.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},9377:function(e,t,r){"use strict";r.d(t,{B:function(){return h},N:function(){return v}});r(4114),r(8111),r(2489),r(1701),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(698),i=r(4761),o=r(3271),s=r(3061),a=r(5629),c=r(4108),l=r(4768),d=r(8965),u=3e3,h=function(e){return e["Incoming"]="Call.incoming",e}({});class v{constructor(e){(0,i.A)(this,"calls",void 0),(0,i.A)(this,"callEventBuffer",void 0),(0,i.A)(this,"nextSeqByCall",new Map),(0,i.A)(this,"toDeviceEventBuffers",new Map),(0,i.A)(this,"client",void 0),(0,i.A)(this,"candidateEventsByCall",void 0),(0,i.A)(this,"eventBufferPromiseChain",void 0),(0,i.A)(this,"onSync",(()=>{var e=this.callEventBuffer;this.callEventBuffer=[],this.eventBufferPromiseChain?this.eventBufferPromiseChain=this.eventBufferPromiseChain.then((()=>this.evaluateEventBuffer(e))):this.eventBufferPromiseChain=this.evaluateEventBuffer(e)})),(0,i.A)(this,"onRoomTimeline",(e=>{this.callEventBuffer.push(e)})),(0,i.A)(this,"onToDeviceEvent",(e=>{var t=e.getContent();if(t.call_id)if(this.nextSeqByCall.has(t.call_id)||this.nextSeqByCall.set(t.call_id,0),void 0!==t.seq){var r=this.nextSeqByCall.get(t.call_id)||0;if(t.seq!==r){this.toDeviceEventBuffers.has(t.call_id)||this.toDeviceEventBuffers.set(t.call_id,[]);var n=this.toDeviceEventBuffers.get(t.call_id),i=n.findIndex((e=>e.getContent().seq>t.seq));-1===i?n.push(e):n.splice(i,0,e)}else{var o=t.call_id;this.callEventBuffer.push(e),this.nextSeqByCall.set(o,t.seq+1);var s=this.toDeviceEventBuffers.get(o),a=s&&s.shift();while(a&&a.getContent().seq===this.nextSeqByCall.get(o))this.callEventBuffer.push(a),this.nextSeqByCall.set(o,a.getContent().seq+1),a=s.shift()}}else this.callEventBuffer.push(e);else this.callEventBuffer.push(e)})),this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on(c.AU.Sync,this.onSync),this.client.on(d.u9.Timeline,this.onRoomTimeline),this.client.on(c.AU.ToDeviceEvent,this.onToDeviceEvent)}stop(){this.client.removeListener(c.AU.Sync,this.onSync),this.client.removeListener(d.u9.Timeline,this.onRoomTimeline),this.client.removeListener(c.AU.ToDeviceEvent,this.onToDeviceEvent)}evaluateEventBuffer(e){var t=this;return(0,n.A)((function*(){yield Promise.all(e.map((e=>t.client.decryptEventIfNeeded(e))));var r=e.filter((e=>{var t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")})),n=new Set;for(var i of r){var s=i.getType();s!==a.Bx.CallAnswer&&s!==a.Bx.CallHangup||n.add(i.getContent().call_id)}for(var c of r){var l=c.getType(),d=c.getContent().call_id;if(l!==a.Bx.CallInvite||!n.has(d))try{yield t.handleCallEvent(c)}catch(u){o.v.error("CallEventHandler evaluateEventBuffer() caught exception handling call event",u)}}}))()}handleCallEvent(e){var t=this;return(0,n.A)((function*(){var r;t.client.emit(c.AU.ReceivedVoipEvent,e);var n,i,d=e.getContent(),v=e.getRoomId()||(null===(r=t.client.groupCallEventHandler.getGroupCallById(d.conf_id))||void 0===r||null===(r=r.room)||void 0===r?void 0:r.roomId),p=d.conf_id,f=e.getType(),g=e.getSender(),m=d.call_id?t.calls.get(d.call_id):void 0;if(p){if(i=t.client.groupCallEventHandler.getGroupCallById(p),!i)return void o.v.warn("CallEventHandler handleCallEvent() could not find a group call - ignoring event (groupCallId=".concat(p,", type=").concat(f,")"));if(n=d.device_id,!n)return o.v.warn("CallEventHandler handleCallEvent() could not find a device id - ignoring event (senderId=".concat(g,")")),void i.emit(l.AZ.Error,new l.Iy(g));if(d.dest_session_id!==t.client.getSessionId())return void o.v.warn("CallEventHandler handleCallEvent() call event does not match current session id - ignoring")}var y=g===t.client.credentials.userId&&(void 0===n||n===t.client.getDeviceId());if(v)if(f!==a.Bx.CallInvite)if(f!==a.Bx.CallCandidates){var S;if([a.Bx.CallHangup,a.Bx.CallReject].includes(f))m?m.state!==s.iP.Ended&&(f===a.Bx.CallHangup?m.onHangupReceived(d):m.onRejectReceived(d),m.state===s.iP.Ended&&t.calls.delete(d.call_id)):(m=null!==(S=(0,s.sv)(t.client,v,{opponentDeviceId:n,opponentSessionId:d.sender_session_id}))&&void 0!==S?S:void 0,m&&(m.callId=d.call_id,m.initWithHangup(e),t.calls.set(d.call_id,m)));else if(m&&m.hasPeerConnection){if(e.getContent().party_id!==m.ourPartyId)switch(f){case a.Bx.CallAnswer:y?m.state===s.iP.Ringing&&m.onAnsweredElsewhere(d):m.onAnswerReceived(e);break;case a.Bx.CallSelectAnswer:m.onSelectAnswerReceived(e);break;case a.Bx.CallNegotiate:m.onNegotiateReceived(e);break;case a.Bx.CallAssertedIdentity:case a.Bx.CallAssertedIdentityPrefix:m.onAssertedIdentityReceived(e);break;case a.Bx.CallSDPStreamMetadataChanged:case a.Bx.CallSDPStreamMetadataChangedPrefix:m.onSDPStreamMetadataChangedReceived(e);break}}else o.v.info("CallEventHandler handleCallEvent() discarding possible call event as we don't have a call (type=".concat(f,")"))}else{if(y)return;m?m.onRemoteIceCandidatesReceived(e):(t.candidateEventsByCall.has(d.call_id)||t.candidateEventsByCall.set(d.call_id,[]),t.candidateEventsByCall.get(d.call_id).push(e))}else{var b,E,_;if(y)return;if(e.getLocalAge()>d.lifetime-u)return;if(m&&m.state===s.iP.Ended)return;if(m&&o.v.warn("CallEventHandler handleCallEvent() already has a call but got an invite - clobbering (callId=".concat(d.call_id,")")),d.invitee&&d.invitee!==t.client.getUserId())return;var w=(null!==(b=t.client.getTurnServersExpiry())&&void 0!==b?b:0)-Date.now();if(o.v.info("CallEventHandler handleCallEvent() current turn creds expire in "+w+" ms"),m=null!==(E=(0,s.sv)(t.client,v,{forceTURN:t.client.forceTURN,opponentDeviceId:n,groupCallId:p,opponentSessionId:d.sender_session_id}))&&void 0!==E?E:void 0,!m)return void o.v.log("CallEventHandler handleCallEvent() this client does not support WebRTC (callId=".concat(d.call_id,")"));m.callId=d.call_id;var I,T=null===(_=i)||void 0===_?void 0:_.getGroupCallStats();T&&m.initStats(T);try{yield m.initWithInvite(e)}catch(D){var R;if(D instanceof s.RA)if(D.code===l.BF.UnknownDevice)null===(R=i)||void 0===R||R.emit(l.AZ.Error,D);else o.v.error(D)}if(t.calls.set(m.callId,m),t.candidateEventsByCall.get(m.callId))for(var k of t.candidateEventsByCall.get(m.callId))m.onRemoteIceCandidatesReceived(k);for(var A of t.calls.values()){var C,O=[s.iP.WaitLocalMedia,s.iP.CreateOffer,s.iP.InviteSent].includes(A.state);if(m.roomId===A.roomId&&A.direction===s.QO.Outbound&&(null===(C=m.getOpponentMember())||void 0===C?void 0:C.userId)===A.invitee&&O){I=A;break}}I?I.callId>m.callId?(o.v.log("CallEventHandler handleCallEvent() detected glare - answering incoming call and canceling outgoing call (incomingId=".concat(m.callId,", outgoingId=").concat(I.callId,")")),I.replacedBy(m)):(o.v.log("CallEventHandler handleCallEvent() detected glare - hanging up incoming call (incomingId=".concat(m.callId,", outgoingId=").concat(I.callId,")")),m.hangup(s.Il.Replaced,!0)):t.client.emit(h.Incoming,m)}}))()}}},9381:function(e,t,r){"use strict";r.d(t,{Tj:function(){return i},Xj:function(){return o},yk:function(){return a}});r(8111),r(1148);var n=r(698),i=function(e){return e[e["Stable"]=0]="Stable",e[e["Unstable"]=1]="Unstable",e[e["Unsupported"]=2]="Unsupported",e}({}),o=function(e){return e["Thread"]="Thread",e["ThreadUnreadNotifications"]="ThreadUnreadNotifications",e["LoginTokenRequest"]="LoginTokenRequest",e["RelationBasedRedactions"]="RelationBasedRedactions",e["AccountDataDeletion"]="AccountDataDeletion",e["RelationsRecursion"]="RelationsRecursion",e["IntentionalMentions"]="IntentionalMentions",e}({}),s={[o.Thread]:{unstablePrefixes:["org.matrix.msc3440"],matrixVersion:"v1.3"},[o.ThreadUnreadNotifications]:{unstablePrefixes:["org.matrix.msc3771","org.matrix.msc3773"],matrixVersion:"v1.4"},[o.LoginTokenRequest]:{unstablePrefixes:["org.matrix.msc3882"]},[o.RelationBasedRedactions]:{unstablePrefixes:["org.matrix.msc3912"]},[o.AccountDataDeletion]:{unstablePrefixes:["org.matrix.msc3391"]},[o.RelationsRecursion]:{unstablePrefixes:["org.matrix.msc3981"],matrixVersion:"v1.10"},[o.IntentionalMentions]:{unstablePrefixes:["org.matrix.msc3952_intentional_mentions"],matrixVersion:"v1.7"}};function a(e){return c.apply(this,arguments)}function c(){return c=(0,n.A)((function*(e){var t=new Map;for(var[r,n]of Object.entries(s)){var o,a,c,l,d=null!==(o=null===(a=e.versions)||void 0===a?void 0:a.includes(n.matrixVersion||""))&&void 0!==o&&o,u=null!==(c=null===(l=n.unstablePrefixes)||void 0===l?void 0:l.every((t=>{var r;return!0===(null===(r=e.unstable_features)||void 0===r?void 0:r[t])})))&&void 0!==c&&c;d?t.set(r,i.Stable):u?t.set(r,i.Unstable):t.set(r,i.Unsupported)}return t})),c.apply(this,arguments)}},9429:function(e,t,r){"use strict";var n=r(4576),i=r(6193);e.exports=function(e){if(i){try{return n.process.getBuiltinModule(e)}catch(t){}try{return Function('return require("'+e+'")')()}catch(t){}}}},9433:function(e,t,r){"use strict";var n=r(4576),i=Object.defineProperty;e.exports=function(e,t){try{i(n,e,{value:t,configurable:!0,writable:!0})}catch(r){n[e]=t}return t}},9454:function(e,t,r){"use strict";r.d(t,{J1:function(){return o},M6:function(){return a},Yg:function(){return i},vo:function(){return s}});var n=r(4229),i=(r(7898),function(e){return e["Self"]="m.self",e["Pin"]="m.pin",e}({})),o=new n.qr("m.asset","org.matrix.msc3488.asset"),s=new n.qr("m.ts","org.matrix.msc3488.ts"),a=new n.qr("m.location","org.matrix.msc3488.location")},9462:function(e,t,r){"use strict";var n=r(9565),i=r(2360),o=r(6699),s=r(6279),a=r(8227),c=r(1181),l=r(5966),d=r(7657).IteratorPrototype,u=r(2529),h=r(9539),v=a("toStringTag"),p="IteratorHelper",f="WrapForValidIterator",g=c.set,m=function(e){var t=c.getterFor(e?f:p);return s(i(d),{next:function(){var r=t(this);if(e)return r.nextHandler();if(r.done)return u(void 0,!0);try{var n=r.nextHandler();return r.returnHandlerResult?n:u(n,r.done)}catch(i){throw r.done=!0,i}},return:function(){var r=t(this),i=r.iterator;if(r.done=!0,e){var o=l(i,"return");return o?n(o,i):u(void 0,!0)}if(r.inner)try{h(r.inner.iterator,"normal")}catch(s){return h(i,"throw",s)}return i&&h(i,"normal"),u(void 0,!0)}})},y=m(!0),S=m(!1);o(S,v,"Iterator Helper"),e.exports=function(e,t,r){var n=function(n,i){i?(i.iterator=n.iterator,i.next=n.next):i=n,i.type=t?f:p,i.returnHandlerResult=!!r,i.nextHandler=e,i.counter=0,i.done=!1,g(this,i)};return n.prototype=t?y:S,n}},9479:function(e,t,r){"use strict";var n=r(4576),i=r(3724),o=r(2106),s=r(7979),a=r(9039),c=n.RegExp,l=c.prototype,d=i&&a((function(){var e=!0;try{c(".","d")}catch(d){e=!1}var t={},r="",n=e?"dgimsy":"gimsy",i=function(e,n){Object.defineProperty(t,e,{get:function(){return r+=n,!0}})},o={dotAll:"s",global:"g",ignoreCase:"i",multiline:"m",sticky:"y"};for(var s in e&&(o.hasIndices="d"),o)i(s,o[s]);var a=Object.getOwnPropertyDescriptor(l,"flags").get.call(t);return a!==n||r!==n}));d&&o(l,"flags",{configurable:!0,get:s})},9504:function(e,t,r){"use strict";var n=r(616),i=Function.prototype,o=i.call,s=n&&i.bind.bind(o,o);e.exports=n?s:function(e){return function(){return o.apply(e,arguments)}}},9519:function(e,t,r){"use strict";var n,i,o=r(4576),s=r(2839),a=o.process,c=o.Deno,l=a&&a.versions||c&&c.version,d=l&&l.v8;d&&(n=d.split("."),i=n[0]>0&&n[0]<4?1:+(n[0]+n[1])),!i&&s&&(n=s.match(/Edge\/(\d+)/),(!n||n[1]>=74)&&(n=s.match(/Chrome\/(\d+)/),n&&(i=+n[1]))),e.exports=i},9523:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ModalButtonKind=void 0;var r=function(e){return e["Primary"]="m.primary",e["Secondary"]="m.secondary",e["Warning"]="m.warning",e["Danger"]="m.danger",e["Link"]="m.link",e}({});t.ModalButtonKind=r},9539:function(e,t,r){"use strict";var n=r(9565),i=r(8551),o=r(5966);e.exports=function(e,t,r){var s,a;i(e);try{if(s=o(e,"return"),!s){if("throw"===t)throw r;return r}s=n(s,e)}catch(c){a=!0,s=c}if("throw"===t)throw r;if(a)throw s;return i(s),r}},9553:function(e,t,r){"use strict";r.d(t,{US:function(){return c},rl:function(){return a}});r(4114),r(6573),r(8100),r(7936),r(7467),r(4732),r(9577);var n=r(944),i="abcdefghijklmnopqrstuvwxyz",o="ABCDEFGHIJKLMNOPQRSTUVWXYZ",s="0123456789";function a(e){var t=new Uint8Array(e);return globalThis.crypto.getRandomValues(t),(0,n.A4)(t)}function c(e){return l(e,o+i+s)}function l(e,t){if(t.length<2||t.length>256)throw new Error("Character set must be between 2 and 256 characters long");if(e<1||e>32768)throw new Error("Requested random string length must be between 1 and 32768");var r=256-256%t.length,n=new Uint8Array(Math.floor(1.3*e)),i=n.length,o=[];while(o.length<e){i===n.length&&(globalThis.crypto.getRandomValues(n),i=0);var s=n[i++];s<r&&o.push(t[s%t.length])}return o.join("")}},9565:function(e,t,r){"use strict";var n=r(616),i=Function.prototype.call;e.exports=n?i.bind(i):function(){return i.apply(i,arguments)}},9577:function(e,t,r){"use strict";var n=r(9928),i=r(4644),o=r(1108),s=r(1291),a=r(5854),c=i.aTypedArray,l=i.getTypedArrayConstructor,d=i.exportTypedArrayMethod,u=!!function(){try{new Int8Array(1)["with"](2,{valueOf:function(){throw 8}})}catch(e){return 8===e}}();d("with",{with:function(e,t){var r=c(this),i=s(e),d=o(r)?a(t):+t;return n(r,l(r),i,d)}}["with"],!u)},9594:function(e,t,r){var n=r(291),i=r(1459),o=r(5555);t.M9=i,t.qg=n.parse,n.parseParams,n.parseFmtpConfig,n.parsePayloads,n.parseRemoteCandidates,n.parseImageAttributes,n.parseSimulcastStreamList},9617:function(e,t,r){"use strict";var n=r(5397),i=r(5610),o=r(6198),s=function(e){return function(t,r,s){var a=n(t),c=o(a);if(0===c)return!e&&-1;var l,d=i(s,c);if(e&&r!==r){while(c>d)if(l=a[d++],l!==l)return!0}else for(;c>d;d++)if((e||d in a)&&a[d]===r)return e||d||0;return!e&&-1}};e.exports={includes:s(!0),indexOf:s(!1)}},9678:function(e,t,r){"use strict";var n=r(6518),i=r(7628),o=r(5397),s=r(6469),a=Array;n({target:"Array",proto:!0},{toReversed:function(){return i(o(this),a)}}),s("toReversed")},9683:function(e,t,r){"use strict";r.d(t,{iD:function(){return w},Rc:function(){return a.Rc},Hl:function(){return a.Hl},XD:function(){return c},Pw:function(){return I},up:function(){return a.up},ED:function(){return U},zs:function(){return T},IT:function(){return s},JG:function(){return h},fZ:function(){return y},xy:function(){return v},Y6:function(){return g},eM:function(){return a.eM},_:function(){return u}});r(4114),r(8111),r(116),r(4979);var n=r(4761),i=(r(2489),r(7588),r(4603),r(7566),r(8721),r(698)),o=r(6170),s=function(e){return e["Get"]="GET",e["Put"]="PUT",e["Post"]="POST",e["Delete"]="DELETE",e["Options"]="OPTIONS",e["Head"]="HEAD",e["Patch"]="PATCH",e}({}),a=r(9310),c=function(e){return e["SessionLoggedOut"]="Session.logged_out",e["NoConsent"]="no_consent",e}({}),l=(r(1701),r(3794)),d=r(3271);function u(e){var t=new AbortController;return setTimeout((()=>{t.abort()}),e),t.signal}function h(e){var t=new AbortController;function r(){for(var t of e)t.removeEventListener("abort",n)}function n(){t.abort(),r()}for(var i of e){if(i.aborted){n();break}i.addEventListener("abort",n)}return{signal:t.signal,cleanup:r}}function v(e,t){var r,n,i,o=p(e)?new Headers(e.getAllResponseHeaders().trim().split(/[\r\n]+/).map((e=>{var t=e.indexOf(":");return[e.substring(0,t),e.substring(t+1)]}))):e.headers;try{i=f(o)}catch(s){return s}return"application/json"===(null===(r=i)||void 0===r?void 0:r.type)&&t?new a.up(JSON.parse(t),e.status,p(e)?e.responseURL:e.url,void 0,o):"text/plain"===(null===(n=i)||void 0===n?void 0:n.type)?new a.Hl("Server returned ".concat(e.status," error: ").concat(t),e.status,o):new a.Hl("Server returned ".concat(e.status," error"),e.status,o)}function p(e){return"getResponseHeader"in e}function f(e){var t=e.get("Content-Type");if(null===t)return null;try{return(0,l.q)(t)}catch(r){throw new Error("Error parsing Content-Type '".concat(t,"': ").concat(r))}}function g(e,t){return m.apply(this,arguments)}function m(){return m=(0,i.A)((function*(e,t){var r=0,n=null;while(r<e)try{if(r>0){var i=1e3*Math.pow(2,r);d.v.log("network operation failed ".concat(r," times, retrying in ").concat(i,"ms...")),yield(0,o.yy)(i)}return yield t()}catch(s){if(!(s instanceof a.Rc))throw s;r+=1,n=s}throw n})),m.apply(this,arguments)}function y(e,t,r){return t>4||e instanceof a.Rc&&!r||e.httpStatus&&4===Math.floor(e.httpStatus/100)&&429!==e.httpStatus||"AbortError"===e.name||"M_TOO_LARGE"===e.name?-1:(0,a.eM)(e,1e3*Math.pow(2,t))}function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function b(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach((function(t){(0,n.A)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class E{constructor(e,t){var r;this.eventEmitter=e,this.opts=t,(0,n.A)(this,"abortController",new AbortController),(0,o.UB)(t,["baseUrl","prefix"]),t.onlyData=!!t.onlyData,t.useAuthorizationHeader=null===(r=t.useAuthorizationHeader)||void 0===r||r}abort(){this.abortController.abort(),this.abortController=new AbortController}fetch(e,t){return this.opts.fetchFn?this.opts.fetchFn(e,t):globalThis.fetch(e,t)}setIdBaseUrl(e){this.opts.idBaseUrl=e}idServerRequest(e,t,r,n,i){if(!this.opts.idBaseUrl)throw new Error("No identity server base URL set");var o=void 0,a=void 0;e===s.Get?o=r:a=r;var c=this.getUrl(t,o,n,this.opts.idBaseUrl),l={json:!0,headers:{}};return i&&(l.headers.Authorization="Bearer ".concat(i)),this.requestOtherUrl(e,c,a,l)}authedRequest(e,t,r,n){var o=arguments,s=this;return(0,i.A)((function*(){var i=o.length>4&&void 0!==o[4]?o[4]:{};r||(r={});var a=b({},i);s.opts.accessToken&&(s.opts.useAuthorizationHeader?(a.headers||(a.headers={}),a.headers.Authorization||(a.headers.Authorization="Bearer "+s.opts.accessToken),r.access_token&&delete r.access_token):r.access_token||(r.access_token=s.opts.accessToken));try{var l=yield s.request(e,t,r,n,a);return l}catch(h){var d=h;if("M_UNKNOWN_TOKEN"===d.errcode&&!a.doNotAttemptTokenRefresh){var u=yield s.tryRefreshToken();if(u)return s.authedRequest(e,t,r,n,b(b({},i),{},{doNotAttemptTokenRefresh:!0}))}throw"M_UNKNOWN_TOKEN"!=d.errcode||null!==a&&void 0!==a&&a.inhibitLogoutEmit?"M_CONSENT_NOT_GIVEN"==d.errcode&&s.eventEmitter.emit(c.NoConsent,d.message,d.data.consent_uri):s.eventEmitter.emit(c.SessionLoggedOut,d),d}}))()}tryRefreshToken(){var e=this;return(0,i.A)((function*(){if(!e.opts.refreshToken||!e.opts.tokenRefreshFunction)return!1;try{var{accessToken:t,refreshToken:r}=yield e.opts.tokenRefreshFunction(e.opts.refreshToken);return e.opts.accessToken=t,e.opts.refreshToken=r,!0}catch(i){var n;return null===(n=e.opts.logger)||void 0===n||n.warn("Failed to refresh token",i),!1}}))()}request(e,t,r,n,i){var o=this.getUrl(t,r,null===i||void 0===i?void 0:i.prefix,null===i||void 0===i?void 0:i.baseUrl);return this.requestOtherUrl(e,o,n,i)}requestOtherUrl(e,t,r){var n=arguments,o=this;return(0,i.A)((function*(){var i,s,c,l,d,p=n.length>3&&void 0!==n[3]?n[3]:{},f=o.sanitizeUrlForLogs(t);null===(i=o.opts.logger)||void 0===i||i.debug("FetchHttpApi: --\x3e ".concat(e," ").concat(f));var g=Object.assign({},p.headers||{}),m=null===(s=p.json)||void 0===s||s,y=m&&(null===r||void 0===r||null===(c=r.constructor)||void 0===c?void 0:c.name)===Object.name;m&&(y&&!g["Content-Type"]&&(g["Content-Type"]="application/json"),g["Accept"]||(g["Accept"]="application/json"));var S,b=null!==(l=p.localTimeoutMs)&&void 0!==l?l:o.opts.localTimeoutMs,E=null!==(d=p.keepAlive)&&void 0!==d&&d,_=[o.abortController.signal];void 0!==b&&_.push(u(b)),p.abortSignal&&_.push(p.abortSignal),S=y?JSON.stringify(r):r;var w,{signal:I,cleanup:T}=h(_),R=Date.now();try{var k;w=yield o.fetch(t,{signal:I,method:e,body:S,headers:g,mode:"cors",redirect:"follow",referrer:"",referrerPolicy:"no-referrer",cache:"no-cache",credentials:"omit",keepalive:E,priority:p.priority}),null===(k=o.opts.logger)||void 0===k||k.debug("FetchHttpApi: <-- ".concat(e," ").concat(f," [").concat(Date.now()-R,"ms ").concat(w.status,"]"))}catch(C){var A;if(null===(A=o.opts.logger)||void 0===A||A.debug("FetchHttpApi: <-- ".concat(e," ").concat(f," [").concat(Date.now()-R,"ms ").concat(C,"]")),"AbortError"===C.name)throw C;throw new a.Rc("fetch failed",C)}finally{T()}if(!w.ok)throw v(w,yield w.text());return o.opts.onlyData?m?w.json():w.text():w}))()}sanitizeUrlForLogs(e){try{var t;t="string"===typeof e?new URL(e):e;var r=new URLSearchParams;for(var n of t.searchParams.keys())r.append(n,"xxx");var i=r.toString(),o=i?"?".concat(i):"";return t.origin+t.pathname+o}catch(s){return"??"}}getUrl(e,t,r,n){var i=null!==n&&void 0!==n?n:this.opts.baseUrl,s=i.endsWith("/")?i.slice(0,-1):i,a=new URL(s+(null!==r&&void 0!==r?r:this.opts.prefix)+e);return t&&(0,o.hm)(t,a.searchParams),a}}var _,w=function(e){return e["V1"]="/_matrix/client/v1",e["V3"]="/_matrix/client/v3",e["Unstable"]="/_matrix/client/unstable",e}({}),I=function(e){return e["V2"]="/_matrix/identity/v2",e}({}),T=function(e){return e["V1"]="/_matrix/media/v1",e["V3"]="/_matrix/media/v3",e}({}),R=1e3,k=0,A=[],C=function(){};function O(e,t){for(var r=arguments.length,n=new Array(r>2?r-2:0),i=2;i<r;i++)n[i-2]=arguments[i];t=t||0,t<0&&(t=0);var o=Date.now()+t,s=k++;C("setTimeout: scheduling cb",s,"at",o,"(delay",t,")");var a={runAt:o,func:e,params:n,key:s},c=x(A,(function(e){return e.runAt-o}));return A.splice(c,0,a),M(),s}function D(e){if(0!==A.length){var t;for(t=0;t<A.length;t++){var r=A[t];if(r.key==e){A.splice(t,1);break}}0===t&&M()}}function M(){_&&globalThis.clearTimeout(_);var e=A[0];if(e){var t=Date.now(),r=Math.min(e.runAt-t,R);C("scheduleRealCallback: now:",t,"delay:",r),_=globalThis.setTimeout(P,r)}else C("scheduleRealCallback: no more callbacks, not rescheduling")}function P(){var e=Date.now();C("runCallbacks: now:",e);var t=[];while(1){var r=A[0];if(!r||r.runAt>e)break;var n=A.shift();C("runCallbacks: popping",n.key),t.push(n)}for(var i of(M(),t))try{i.func.apply(globalThis,i.params)}catch(o){d.v.error("Uncaught exception in callback function",o)}}function x(e,t){var r=0,n=e.length;while(r<n){var i=r+n>>1,o=t(e[i]);o>0?n=i:r=i+1}return r}class U extends E{constructor(){super(...arguments),(0,n.A)(this,"uploads",[])}uploadContent(e){var t,r,n,i,c=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=null===(t=c.includeFilename)||void 0===t||t,d=null!==(r=c.abortController)&&void 0!==r?r:new AbortController,u=(null!==(n=c.type)&&void 0!==n?n:e.type)||"application/octet-stream",h=null!==(i=c.name)&&void 0!==i?i:e.name,p={loaded:0,total:0,abortController:d},f=(0,o.v6)();if(globalThis.XMLHttpRequest){var g=new globalThis.XMLHttpRequest,m=function(){g.abort(),f.reject(new Error("Timeout"))},y=O(m,3e4);g.onreadystatechange=function(){switch(g.readyState){case globalThis.XMLHttpRequest.DONE:D(y);try{if(0===g.status)throw new DOMException(g.statusText,"AbortError");if(!g.responseText)throw new Error("No response body.");g.status>=400?f.reject(v(g,g.responseText)):f.resolve(JSON.parse(g.responseText))}catch(e){if("AbortError"===e.name)return void f.reject(e);f.reject(new a.Rc("request failed",e))}break}},g.upload.onprogress=e=>{var t;D(y),p.loaded=e.loaded,p.total=e.total,y=O(m,3e4),null===(t=c.progressHandler)||void 0===t||t.call(c,{loaded:e.loaded,total:e.total})};var S=this.getUrl("/upload",void 0,T.V3);l&&h&&S.searchParams.set("filename",encodeURIComponent(h)),!this.opts.useAuthorizationHeader&&this.opts.accessToken&&S.searchParams.set("access_token",encodeURIComponent(this.opts.accessToken)),g.open(s.Post,S.href),this.opts.useAuthorizationHeader&&this.opts.accessToken&&g.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),g.setRequestHeader("Content-Type",u),g.send(e),d.signal.addEventListener("abort",(()=>{g.abort()}))}else{var b={};l&&h&&(b.filename=h);var E={"Content-Type":u};this.authedRequest(s.Post,"/upload",b,e,{prefix:T.V3,headers:E,abortSignal:d.signal}).then((e=>this.opts.onlyData?e:e.json())).then(f.resolve,f.reject)}return p.promise=f.promise.finally((()=>{(0,o.Nz)(this.uploads,(e=>e===p))})),d.signal.addEventListener("abort",(()=>{(0,o.Nz)(this.uploads,(e=>e===p)),f.reject(new DOMException("Aborted","AbortError"))})),this.uploads.push(p),p.promise}cancelUpload(e){var t=this.uploads.find((t=>t.promise===e));return!!t&&(t.abortController.abort(),!0)}getCurrentUploads(){return this.uploads}getContentUri(){return{base:this.opts.baseUrl,path:T.V3+"/upload",params:{access_token:this.opts.accessToken}}}}},9746:function(e,t,r){"use strict";r.d(t,{D$:function(){return Z},Ef:function(){return ne},Jo:function(){return $},u1:function(){return J}});r(4114),r(8111),r(2489),r(7588),r(1701),r(3579),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(5976),i=r(160);r(2040);
/**
* @vue/runtime-dom v3.5.13
* (c) 2018-present Yuxi (Evan) You and Vue contributors
* @license MIT
**/
let o;const s="undefined"!==typeof window&&window.trustedTypes;if(s)try{o=s.createPolicy("vue",{createHTML:e=>e})}catch(se){}const a=o?e=>o.createHTML(e):e=>e,c="http://www.w3.org/2000/svg",l="http://www.w3.org/1998/Math/MathML",d="undefined"!==typeof document?document:null,u=d&&d.createElement("template"),h={insert:(e,t,r)=>{t.insertBefore(e,r||null)},remove:e=>{const t=e.parentNode;t&&t.removeChild(e)},createElement:(e,t,r,n)=>{const i="svg"===t?d.createElementNS(c,e):"mathml"===t?d.createElementNS(l,e):r?d.createElement(e,{is:r}):d.createElement(e);return"select"===e&&n&&null!=n.multiple&&i.setAttribute("multiple",n.multiple),i},createText:e=>d.createTextNode(e),createComment:e=>d.createComment(e),setText:(e,t)=>{e.nodeValue=t},setElementText:(e,t)=>{e.textContent=t},parentNode:e=>e.parentNode,nextSibling:e=>e.nextSibling,querySelector:e=>d.querySelector(e),setScopeId(e,t){e.setAttribute(t,"")},insertStaticContent(e,t,r,n,i,o){const s=r?r.previousSibling:t.lastChild;if(i&&(i===o||i.nextSibling)){while(1)if(t.insertBefore(i.cloneNode(!0),r),i===o||!(i=i.nextSibling))break}else{u.innerHTML=a("svg"===n?`<svg>${e}</svg>`:"mathml"===n?`<math>${e}</math>`:e);const i=u.content;if("svg"===n||"mathml"===n){const e=i.firstChild;while(e.firstChild)i.appendChild(e.firstChild);i.removeChild(e)}t.insertBefore(i,r)}return[s?s.nextSibling:t.firstChild,r?r.previousSibling:t.lastChild]}},v=Symbol("_vtc"),p={name:String,type:String,css:{type:Boolean,default:!0},duration:[String,Number,Object],enterFromClass:String,enterActiveClass:String,enterToClass:String,appearFromClass:String,appearActiveClass:String,appearToClass:String,leaveFromClass:String,leaveActiveClass:String,leaveToClass:String};n.QP;function f(e,t,r){const n=e[v];n&&(t=(t?[t,...n]:[...n]).join(" ")),null==t?e.removeAttribute("class"):r?e.setAttribute("class",t):e.className=t}const g=Symbol("_vod"),m=Symbol("_vsh");const y=Symbol("");const S=/(^|;)\s*display\s*:/;function b(e,t,r){const n=e.style,o=(0,i.Kg)(r);let s=!1;if(r&&!o){if(t)if((0,i.Kg)(t))for(const e of t.split(";")){const t=e.slice(0,e.indexOf(":")).trim();null==r[t]&&_(n,t,"")}else for(const e in t)null==r[e]&&_(n,e,"");for(const e in r)"display"===e&&(s=!0),_(n,e,r[e])}else if(o){if(t!==r){const e=n[y];e&&(r+=";"+e),n.cssText=r,s=S.test(r)}}else t&&e.removeAttribute("style");g in e&&(e[g]=s?n.display:"",e[m]&&(n.display="none"))}const E=/\s*!important$/;function _(e,t,r){if((0,i.cy)(r))r.forEach((r=>_(e,t,r)));else if(null==r&&(r=""),t.startsWith("--"))e.setProperty(t,r);else{const n=T(e,t);E.test(r)?e.setProperty((0,i.Tg)(n),r.replace(E,""),"important"):e[n]=r}}const w=["Webkit","Moz","ms"],I={};function T(e,t){const r=I[t];if(r)return r;let n=(0,i.PT)(t);if("filter"!==n&&n in e)return I[t]=n;n=(0,i.ZH)(n);for(let i=0;i<w.length;i++){const r=w[i]+n;if(r in e)return I[t]=r}return t}const R="http://www.w3.org/1999/xlink";function k(e,t,r,n,o,s=(0,i.J$)(t)){n&&t.startsWith("xlink:")?null==r?e.removeAttributeNS(R,t.slice(6,t.length)):e.setAttributeNS(R,t,r):null==r||s&&!(0,i.Y2)(r)?e.removeAttribute(t):e.setAttribute(t,s?"":(0,i.Bm)(r)?String(r):r)}function A(e,t,r,n,o){if("innerHTML"===t||"textContent"===t)return void(null!=r&&(e[t]="innerHTML"===t?a(r):r));const s=e.tagName;if("value"===t&&"PROGRESS"!==s&&!s.includes("-")){const n="OPTION"===s?e.getAttribute("value")||"":e.value,i=null==r?"checkbox"===e.type?"on":"":String(r);return n===i&&"_value"in e||(e.value=i),null==r&&e.removeAttribute(t),void(e._value=r)}let c=!1;if(""===r||null==r){const n=typeof e[t];"boolean"===n?r=(0,i.Y2)(r):null==r&&"string"===n?(r="",c=!0):"number"===n&&(r=0,c=!0)}try{e[t]=r}catch(se){0}c&&e.removeAttribute(o||t)}function C(e,t,r,n){e.addEventListener(t,r,n)}function O(e,t,r,n){e.removeEventListener(t,r,n)}const D=Symbol("_vei");function M(e,t,r,n,i=null){const o=e[D]||(e[D]={}),s=o[t];if(n&&s)s.value=n;else{const[r,a]=x(t);if(n){const s=o[t]=B(n,i);C(e,r,s,a)}else s&&(O(e,r,s,a),o[t]=void 0)}}const P=/(?:Once|Passive|Capture)$/;function x(e){let t;if(P.test(e)){let r;t={};while(r=e.match(P))e=e.slice(0,e.length-r[0].length),t[r[0].toLowerCase()]=!0}const r=":"===e[2]?e.slice(3):(0,i.Tg)(e.slice(2));return[r,t]}let U=0;const L=Promise.resolve(),N=()=>U||(L.then((()=>U=0)),U=Date.now());function B(e,t){const r=e=>{if(e._vts){if(e._vts<=r.attached)return}else e._vts=Date.now();(0,n.qL)(K(e,r.value),t,5,[e])};return r.value=e,r.attached=N(),r}function K(e,t){if((0,i.cy)(t)){const r=e.stopImmediatePropagation;return e.stopImmediatePropagation=()=>{r.call(e),e._stopped=!0},t.map((e=>t=>!t._stopped&&e&&e(t)))}return t}const F=e=>111===e.charCodeAt(0)&&110===e.charCodeAt(1)&&e.charCodeAt(2)>96&&e.charCodeAt(2)<123,j=(e,t,r,n,o,s)=>{const a="svg"===o;"class"===t?f(e,n,a):"style"===t?b(e,r,n):(0,i.Mp)(t)?(0,i.CP)(t)||M(e,t,r,n,s):("."===t[0]?(t=t.slice(1),1):"^"===t[0]?(t=t.slice(1),0):q(e,t,n,a))?(A(e,t,n),e.tagName.includes("-")||"value"!==t&&"checked"!==t&&"selected"!==t||k(e,t,n,a,s,"value"!==t)):!e._isVueCE||!/[A-Z]/.test(t)&&(0,i.Kg)(n)?("true-value"===t?e._trueValue=n:"false-value"===t&&(e._falseValue=n),k(e,t,n,a)):A(e,(0,i.PT)(t),n,s,t)};function q(e,t,r,n){if(n)return"innerHTML"===t||"textContent"===t||!!(t in e&&F(t)&&(0,i.Tn)(r));if("spellcheck"===t||"draggable"===t||"translate"===t)return!1;if("form"===t)return!1;if("list"===t&&"INPUT"===e.tagName)return!1;if("type"===t&&"TEXTAREA"===e.tagName)return!1;if("width"===t||"height"===t){const t=e.tagName;if("IMG"===t||"VIDEO"===t||"CANVAS"===t||"SOURCE"===t)return!1}return(!F(t)||!(0,i.Kg)(r))&&t in e}
/*! #__NO_SIDE_EFFECTS__ */
"undefined"!==typeof HTMLElement&&HTMLElement;Symbol("_moveCb"),Symbol("_enterCb");const V=e=>{const t=e.props["onUpdate:modelValue"]||!1;return(0,i.cy)(t)?e=>(0,i.DY)(t,e):t};function G(e){e.target.composing=!0}function W(e){const t=e.target;t.composing&&(t.composing=!1,t.dispatchEvent(new Event("input")))}const H=Symbol("_assign"),$={created(e,{modifiers:{lazy:t,trim:r,number:n}},o){e[H]=V(o);const s=n||o.props&&"number"===o.props.type;C(e,t?"change":"input",(t=>{if(t.target.composing)return;let n=e.value;r&&(n=n.trim()),s&&(n=(0,i.bB)(n)),e[H](n)})),r&&C(e,"change",(()=>{e.value=e.value.trim()})),t||(C(e,"compositionstart",G),C(e,"compositionend",W),C(e,"change",W))},mounted(e,{value:t}){e.value=null==t?"":t},beforeUpdate(e,{value:t,oldValue:r,modifiers:{lazy:n,trim:o,number:s}},a){if(e[H]=V(a),e.composing)return;const c=!s&&"number"!==e.type||/^0\d/.test(e.value)?e.value:(0,i.bB)(e.value),l=null==t?"":t;if(c!==l){if(document.activeElement===e&&"range"!==e.type){if(n&&t===r)return;if(o&&e.value.trim()===l)return}e.value=l}}};const J={deep:!0,created(e,{value:t,modifiers:{number:r}},o){const s=(0,i.vM)(t);C(e,"change",(()=>{const t=Array.prototype.filter.call(e.options,(e=>e.selected)).map((e=>r?(0,i.bB)(Y(e)):Y(e)));e[H](e.multiple?s?new Set(t):t:t[0]),e._assigning=!0,(0,n.dY)((()=>{e._assigning=!1}))})),e[H]=V(o)},mounted(e,{value:t}){z(e,t)},beforeUpdate(e,t,r){e[H]=V(r)},updated(e,{value:t}){e._assigning||z(e,t)}};function z(e,t){const r=e.multiple,n=(0,i.cy)(t);if(!r||n||(0,i.vM)(t)){for(let o=0,s=e.options.length;o<s;o++){const s=e.options[o],a=Y(s);if(r)if(n){const e=typeof a;s.selected="string"===e||"number"===e?t.some((e=>String(e)===String(a))):(0,i.u3)(t,a)>-1}else s.selected=t.has(a);else if((0,i.BX)(Y(s),t))return void(e.selectedIndex!==o&&(e.selectedIndex=o))}r||-1===e.selectedIndex||(e.selectedIndex=-1)}}function Y(e){return"_value"in e?e._value:e.value}const Q=["ctrl","shift","alt","meta"],X={stop:e=>e.stopPropagation(),prevent:e=>e.preventDefault(),self:e=>e.target!==e.currentTarget,ctrl:e=>!e.ctrlKey,shift:e=>!e.shiftKey,alt:e=>!e.altKey,meta:e=>!e.metaKey,left:e=>"button"in e&&0!==e.button,middle:e=>"button"in e&&1!==e.button,right:e=>"button"in e&&2!==e.button,exact:(e,t)=>Q.some((r=>e[`${r}Key`]&&!t.includes(r)))},Z=(e,t)=>{const r=e._withMods||(e._withMods={}),n=t.join(".");return r[n]||(r[n]=(r,...n)=>{for(let e=0;e<t.length;e++){const n=X[t[e]];if(n&&n(r,t))return}return e(r,...n)})},ee=(0,i.X$)({patchProp:j},h);let te;function re(){return te||(te=(0,n.K9)(ee))}const ne=(...e)=>{const t=re().createApp(...e);const{mount:r}=t;return t.mount=e=>{const n=oe(e);if(!n)return;const o=t._component;(0,i.Tn)(o)||o.render||o.template||(o.template=n.innerHTML),1===n.nodeType&&(n.textContent="");const s=r(n,!1,ie(n));return n instanceof Element&&(n.removeAttribute("v-cloak"),n.setAttribute("data-v-app","")),s},t};function ie(e){return e instanceof SVGElement?"svg":"function"===typeof MathMLElement&&e instanceof MathMLElement?"mathml":void 0}function oe(e){if((0,i.Kg)(e)){const t=document.querySelector(e);return t}return e}},9838:function(e,t,r){"use strict";r.d(t,{c:function(){return n}});class n{constructor(e,t){this.roomId=e}}},9898:function(e,t,r){"use strict";r.d(t,{CD:function(){return o},IJ:function(){return s},Ji:function(){return l},QN:function(){return i},WM:function(){return a},YU:function(){return n},kq:function(){return d},wp:function(){return c}});var n=function(e){return e["DontNotify"]="dont_notify",e["Notify"]="notify",e["Coalesce"]="coalesce",e}({}),i=function(e){return e["Highlight"]="highlight",e["Sound"]="sound",e}({}),o=function(e){return e["ExactEquals"]="==",e["LessThan"]="<",e["GreaterThan"]=">",e["GreaterThanOrEqual"]=">=",e["LessThanOrEqual"]="<=",e}({}),s="2";function a(e){return"==2"===e||"2"===e}var c=function(e){return e["EventMatch"]="event_match",e["EventPropertyIs"]="event_property_is",e["EventPropertyContains"]="event_property_contains",e["ContainsDisplayName"]="contains_display_name",e["RoomMemberCount"]="room_member_count",e["SenderNotificationPermission"]="sender_notification_permission",e["CallStarted"]="call_started",e["CallStartedPrefix"]="org.matrix.msc3914.call_started",e}({}),l=function(e){return e["Override"]="override",e["ContentSpecific"]="content",e["RoomSpecific"]="room",e["SenderSpecific"]="sender",e["Underride"]="underride",e}({}),d=function(e){return e["Master"]=".m.rule.master",e["IsUserMention"]=".m.rule.is_user_mention",e["IsRoomMention"]=".m.rule.is_room_mention",e["ContainsDisplayName"]=".m.rule.contains_display_name",e["ContainsUserName"]=".m.rule.contains_user_name",e["AtRoomNotification"]=".m.rule.roomnotif",e["DM"]=".m.rule.room_one_to_one",e["EncryptedDM"]=".m.rule.encrypted_room_one_to_one",e["Message"]=".m.rule.message",e["EncryptedMessage"]=".m.rule.encrypted",e["InviteToSelf"]=".m.rule.invite_for_me",e["MemberEvent"]=".m.rule.member_event",e["IncomingCall"]=".m.rule.call",e["SuppressNotices"]=".m.rule.suppress_notices",e["Tombstone"]=".m.rule.tombstone",e["PollStart"]=".m.rule.poll_start",e["PollStartUnstable"]=".org.matrix.msc3930.rule.poll_start",e["PollEnd"]=".m.rule.poll_end",e["PollEndUnstable"]=".org.matrix.msc3930.rule.poll_end",e["PollStartOneToOne"]=".m.rule.poll_start_one_to_one",e["PollStartOneToOneUnstable"]=".org.matrix.msc3930.rule.poll_start_one_to_one",e["PollEndOneToOne"]=".m.rule.poll_end_one_to_one",e["PollEndOneToOneUnstable"]=".org.matrix.msc3930.rule.poll_end_one_to_one",e}({})},9927:function(e,t,r){"use strict";r.d(t,{S:function(){return d},s:function(){return h}});r(4114),r(8111),r(8237),r(7642),r(8004),r(3853),r(5876),r(2475),r(5024),r(1698);var n=r(698),i=r(4761),o=r(3178),s=r(3271),a=r(5629),c=r(2668),l=r(8965),d=function(e){return e["Add"]="Relations.add",e["Remove"]="Relations.remove",e["Redaction"]="Relations.redaction",e}({}),u=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];return[t,...r].includes(e)};class h extends c.X{constructor(e,t,r,s){var c;super(),c=this,this.relationType=e,this.eventType=t,this.altEventTypes=s,(0,i.A)(this,"relationEventIds",new Set),(0,i.A)(this,"relations",new Set),(0,i.A)(this,"annotationsByKey",{}),(0,i.A)(this,"annotationsBySender",{}),(0,i.A)(this,"sortedAnnotationsByKey",[]),(0,i.A)(this,"targetEvent",null),(0,i.A)(this,"creationEmitted",!1),(0,i.A)(this,"client",void 0),(0,i.A)(this,"onEventStatus",((e,t)=>{e.isSending()?t===o.fb.CANCELLED&&(e.removeListener(o.OQ.Status,this.onEventStatus),this.removeEvent(e)):e.removeListener(o.OQ.Status,this.onEventStatus)})),(0,i.A)(this,"onBeforeRedaction",function(){var e=(0,n.A)((function*(e){if(c.relations.has(e)){if(c.relations.delete(e),c.relationType===a.zZ.Annotation)c.removeAnnotationFromAggregation(e);else if(c.relationType===a.zZ.Replace&&c.targetEvent&&!c.targetEvent.isState()){var t=yield c.getLastReplacement();c.targetEvent.makeReplaced(t)}e.removeListener(o.OQ.BeforeRedaction,c.onBeforeRedaction),c.emit(d.Redaction,e)}}));return function(t){return e.apply(this,arguments)}}()),this.client=r instanceof l.Wv?r.client:r}addEvent(e){var t=this;return(0,n.A)((function*(){if(!t.relationEventIds.has(e.getId())){var r=e.getRelation();if(r){var n=r.rel_type,i=e.getType();if(t.relationType===n&&u(i,t.eventType,t.altEventTypes)){if(e.isSending()&&e.on(o.OQ.Status,t.onEventStatus),t.relations.add(e),t.relationEventIds.add(e.getId()),t.relationType===a.zZ.Annotation)t.addAnnotationToAggregation(e);else if(t.relationType===a.zZ.Replace&&t.targetEvent&&!t.targetEvent.isState()){var c=yield t.getLastReplacement();t.targetEvent.makeReplaced(c)}e.on(o.OQ.BeforeRedaction,t.onBeforeRedaction),t.emit(d.Add,e),t.maybeEmitCreated()}else s.v.error("Event relation info doesn't match this container")}else s.v.error("Event must have relation info")}}))()}removeEvent(e){var t=this;return(0,n.A)((function*(){if(t.relations.has(e)){if(t.relations.delete(e),t.relationType===a.zZ.Annotation)t.removeAnnotationFromAggregation(e);else if(t.relationType===a.zZ.Replace&&t.targetEvent&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();t.targetEvent.makeReplaced(r)}t.emit(d.Remove,e)}}))()}getRelations(){return[...this.relations]}addAnnotationToAggregation(e){var t,{key:r}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(r){var n=this.annotationsByKey[r];n||(n=this.annotationsByKey[r]=new Set,this.sortedAnnotationsByKey.push([r,n])),n.add(e),this.sortedAnnotationsByKey.sort(((e,t)=>{var r=e[1],n=t[1];return n.size-r.size}));var i=e.getSender(),o=this.annotationsBySender[i];o||(o=this.annotationsBySender[i]=new Set),o.add(e)}}removeAnnotationFromAggregation(e){var t,{key:r}=null!==(t=e.getRelation())&&void 0!==t?t:{};if(r){var n=this.annotationsByKey[r];n&&(n.delete(e),this.sortedAnnotationsByKey.sort(((e,t)=>{var r=e[1],n=t[1];return n.size-r.size})));var i=e.getSender(),o=this.annotationsBySender[i];o&&o.delete(e)}}getSortedAnnotationsByKey(){return this.relationType!==a.zZ.Annotation?null:this.sortedAnnotationsByKey}getAnnotationsBySender(){return this.relationType!==a.zZ.Annotation?null:this.annotationsBySender}getLastReplacement(){var e=this;return(0,n.A)((function*(){if(e.relationType!==a.zZ.Replace)return null;if(!e.targetEvent)return null;var t=e.targetEvent.getServerAggregatedRelation(a.zZ.Replace),r=null===t||void 0===t?void 0:t.origin_server_ts,n=e.getRelations().reduce(((t,n)=>n.getSender()!==e.targetEvent.getSender()||r&&r>n.getTs()||t&&t.getTs()>n.getTs()?t:n),null);return null!==n&&void 0!==n&&n.shouldAttemptDecryption()&&e.client.getCrypto()?yield n.attemptDecryption(e.client.getCrypto()):null!==n&&void 0!==n&&n.isBeingDecrypted()&&(yield n.getDecryptionPromise()),n}))()}setTargetEvent(e){var t=this;return(0,n.A)((function*(){if(!t.targetEvent){if(t.targetEvent=e,t.relationType===a.zZ.Replace&&!t.targetEvent.isState()){var r=yield t.getLastReplacement();r&&t.targetEvent.makeReplaced(r)}t.maybeEmitCreated()}}))()}maybeEmitCreated(){this.creationEmitted||this.targetEvent&&this.relations.size&&(this.creationEmitted=!0,this.targetEvent.emit(o.OQ.RelationsCreated,this.relationType,this.eventType))}}},9928:function(e,t,r){"use strict";var n=r(6198),i=r(1291),o=RangeError;e.exports=function(e,t,r,s){var a=n(e),c=i(r),l=c<0?a+c:c;if(l>=a||l<0)throw new o("Incorrect index");for(var d=new t(a),u=0;u<a;u++)d[u]=u===l?s:e[u];return d}}}]);
//# sourceMappingURL=chunk-vendors.2a47edb2.js.map